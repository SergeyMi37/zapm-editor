<?xml version="1.0" encoding="UTF-8"?>
<Export generator="IRIS" version="26">
<Routine name="%ZAPM.bs.BS" type="MAC" languagemode="0"><![CDATA[
%BS ///9.1553 от 1993 - 2007-08-29
 new
 I $ZV["Cach"||($ZV["IRIS") G ^%ZAPM.bs.BSC ;;;;;Cache' from InterSystems
 I '$D(^%ZAPM.bs.BSinFL) W /BEL,!,"Комплекс установлен с ошибками ! Повторим инсталляцию ? <N> " R *Y S:Y=13 Y=78 S:"Yy"[$C(Y) ^%ZAPM.bs.BS=600 Q  ;D SELF^%ZAPM.bs.BSMENU
 I $ZV["MSM for Windows NT" q
AL L  S %zT=$ZT,$ZT="ALLERR^%ZAPM.bs.BS1" D  S $ZT=$G(%zT) L  Q
 .L +@("%BSj"_$J)
 .D Registr^%ZAPM.bs.BSX(1),Z,DelKills^%ZAPM.bs.BSX
SRV(I) N B ;
 S B="^["""_$P($ZU(1,I),",")_""","""_$P($ZU(1,I),",",2)_"""]BSdirddp"
 I $$Data^%ZAPM.bs.BSF12(B),$$RP^%ZAPM.bs.BSGCH(B)="" S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,j)="@@1@9@@@@@1@@@@@@ rem-"_$P($P($G(@B,"???"),"@",2),",",2)
 E  S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,j)="@@1@9@@@@@1@@@@@@ loc-"_$P($ZU(1,0),",",2)
 Q
Z I $G(%BSenter) W " НОВЫЙ ПРОЦЕСС %BS ЗАПРЕЩЕН ",$$bel^%ZAPM.bs.BS3 H 2 S $ZT=$G(%zT) Q
 N %BSenter K (%zT) ;# U 0:(0::::#10080)
VER I $ZV'["Windows",$P($ZV,"Version ",2)<+^%ZAPM.bs.BS("VER") S ls=" ДЛЯ %BS V "_^%ZAPM.bs.BS_" нужна версия MSM "_^%ZAPM.bs.BS("VER")_" и выше " D O^%ZAPM.bs.BSF7 Q
0 D CLr^%ZAPM.bs.BSF4,REC^%ZAPM.bs.BSF12,GLKL^%ZAPM.bs.BS1 F  R *R:0 E  Q
 I $G(^%ZAPM.bs.BSS("XECUTE","KEY"))'="" D XEC^%ZAPM.bs.BSF10($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""XECUTE"")"),0)
 D PPP^%ZAPM.bs.BS1 I 'YES D:$G(%BS(24,1))'="" REGB^%ZAPM.bs.BSMSMF G EXIT ;РЕГИСТРАЦИЯ
 D WORKGRP^%ZAPM.bs.BS1 ;РАБОЧАЯ ГРУППА И КОМЕНТАРИЙ
 S %BSenter=1 D:$G(%BS(24,1))'="" REGO^%ZAPM.bs.BSMSMF
 I $$VAR^%ZAPM.bs.BSH ;ПЕРЕМЕННЫЕ
 ;ВЫПОЛНЕНИЕ MSM
 I $G(^%ZAPM.bs.BSS("XECUTE","KEY"))'="" D XEC^%ZAPM.bs.BSF10($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""XECUTE"")"),1)
 ;ВКЛЮЧЕНИЕ АРМА
 I %BS(12)'="",$G(@%BS(18)@(%BS(37),0,"7,4"))'="" S i=@$ZR,ii=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""ARM"")") I $$Data^%ZAPM.bs.BSF12(ii) I $G(@ii@(i,"5,4"))'="" S i=@$ZR D ARM^%ZAPM.bs.BSTT(i),MGR G EXIT
 D WAIT^%ZAPM.bs.BSF2 G UCI:$$ZU^%ZAPM.bs.BS3(0)=$$ZU^%ZAPM.bs.BS3(1,0),RAZD
MGR I $ZV["Cach"||($ZV["IRIS") D  Q
 .I $$ZU^%ZAPM.bs.BSF4("%SYS")
 V 2:$J:1:2
 Q
UCI S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),""   <Enter>-ВЫБОР  <F6>-СЕРВИС  <F7>-ПОИСК  <F9>-СИСТЕМА-%BS  <Esc>-ОТМЕНА    """
 S %uCI=$V(2,$J,2) D MGR
 S BSR="^%ZAPM.bs.BSbufB",BST="fT"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G UCIE
 K ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S i=-1,YES=1
 F I=0:1:7 I $ZU(1,I)'="" S i=i+1,(%BS(8,i),^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),i))=$P($ZU(1,I),",",2) D VOL^%ZAPM.bs.BSH(@$ZR,i) G EXIT:'YES F J=1:1 Q:$ZU(J,I)=""  S ^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,J)=$P($ZU(J,I),",")
 S j=0,(se,ke)=0 F I=0:1 Q:'$D(^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I))  S %BS("Tmp",1)=^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I) D
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1))) Q
 .S j=j+1,^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,j)="@@1@9@@@@"_$S(I=0:0,1:"1,1")_"@1@"_$P(%BS,"!",4)_"@@@@@"_I
 .S i=2 F J=1:1 Q:'$D(^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I,J))  D  ;по кипам
 ..I J=1 D SRV(I)
 ..I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I,J))) Q
 ..S i=i+1,^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)="@@1@9@@@@"_$S(J=1&(I=0):0,1:"3,1")_"@1@"_$P(%BS,"!",5)_"@@@@@"_I_","_J
 ..S:se<i se=i S:ke<j ke=j
 I $G(%BS(23)),%BS(12)'="" D DDPVOL^%ZAPM.bs.BSD1
 I se=0 S ls=" НЕТ ДОСТУПНЫХ КИПов ! " D O^%ZAPM.bs.BSF7 G EXIT
 S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@TBD^%ZAPM.bs.BSF4@1@1@@3,1@@@@@@1"
 S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",1,1)="S d1=""·±­""_d_"" ""_^%ZAPM.bs.BSbufB(""uCI""_$G(%BS(3),$P)_$J_""u""_%BS(15),d)"
 S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",2,1)="S d1="" -=§ ""_d_"" """_$S(%BS(17)<0:"",1:" D Comnt^%ZAPM.bs.BS2(d)")
 S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",3,1)="S d1=""·±­· ""_^%ZAPM.bs.BSbufB(""uCI""_$G(%BS(3),$P)_$J_""u""_%BS(15),$P(d,"",""),$P(d,"","",2))"_$S(%BS(17)<0:"",1:" D Comnt^%ZAPM.bs.BS2(d)")
 S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),"AF2")="^%ZAPM.bs.BSS,ALTF2",$P(^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",39)="^%ZAPM.bs.BSHLP,MAIN",$P(@$ZR,"@",41)="AF10^%ZAPM.bs.BSF12"
 D RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
UCIE K %BS("Tmp",3),%BS("Tmp",4)
 I $D(TABLfind) G TAB
 I $D(NEWVOLUM) K NEWVOLUM,^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G UCI
 I R1=27!(ny<3)!(d="") G EXIT
 I $D(%BS(8,+d)) D UCI^%ZAPM.bs.BSH(%BS(8,+d),+d) G EXIT:'YES S %VGI=+d D CKD^%ZAPM.bs.BSF5(+d)
 I d?3A S %BS("Tmp",3)=d,%BS("Tmp",4)=$P(@BSR@(BST,1,nx),"@",15)
 I '$D(%BS("Tmp",4)) V 2:$J:+$P(d,",")*32+$P(d,",",2):2
 K ^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("BUF"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 S BSbufR="@@1@77@@@@@1@"_$P(%BS,"!",4)_"@@@@@·­±.. "_$S($D(%BS("Tmp",4)):%BS("Tmp",3)_","_%BS("Tmp",4),1:$$ZU^%ZAPM.bs.BS3(0))_"        ;   Комментарии к разделам"_$S($D(%BS("Tmp",4)):" DDP",1:"")
RAZD ;ВЫБОР РАЗДЕЛА
 I $G(^%ZAPM.bs.BSS("XECUTE","KEY"))'="" D XEC^%ZAPM.bs.BSF10($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""XECUTE"")"),2)
 I '$D(%BS("Tmp",4)) S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР <F4>-КОМЕНТАРИЙ <F5>-ПРИЛОЖ <F6>-СЕРВИС <F7>-ПОИСК <F8>-УДАЛИТЬ """,i=2
 E  S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР                   сетевые разделы                 <Esc>-ОТМЕНА  """,i=1,%BS("Tmp",6)=$$DDPGLO^%ZAPM.bs.BSD1(%BS("Tmp",3)_","_%BS("Tmp",4))
 S BSR="^%ZAPM.bs.BSbufB",BST="R"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G RAZDE
 S %NAM="^",^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)=$G(BSbufR,"@@1@77@@@@@1@1;6;80;45@@@@@·­±.. "_$S($D(%BS("Tmp",4)):%BS("Tmp",3)_","_%BS("Tmp",4),1:$$ZU^%ZAPM.bs.BS3(0))_"        ;   Комментарии к разделам")
 I i=2 S ^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)="@@1@77@@@@@1@"_$P(%BS,"!",5)_"@@@@@·­± ^новый Раздел ;"
 I %BS(23),'$D(%BS("Tmp",3)),'$D(^BSdirddp) D NEWDIR^%ZAPM.bs.BSD1
 S %BS("Tmp",1)=$S('$D(%BS("Tmp",3)):$P($$ZU^%ZAPM.bs.BS3(0),",",2),1:1),%BS("Tmp",2)=$S('$D(%BS("Tmp",3)):$P($$ZU^%ZAPM.bs.BS3(0),","),1:%BS("Tmp",3)_","_%BS("Tmp",4)),%BS("Tmp",5)=$S($$ver^%ZAPM.bs.BSF9(2)="]":2,1:3)_$$ver^%ZAPM.bs.BSF9(2)
RAZPR F  S %NAM=$$O^%ZAPM.bs.BSD1(%NAM) Q:%NAM=""  D
 .I $E(%NAM,1,4)="^%ZAPM.bs.BS",'$$ADMIN() Q
 .S i=i+1,^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@1@77@@@@@1@"_$P(%BS,"!",5)_"@@@@@·­± "_%NAM_$J("",$S($D(%BS("Tmp",3)):23,1:14)-1-$L(%NAM))_" ;"_$P($G(@%NAM),"@",2)
 S ^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@%FKR^%ZAPM.bs.BS2@1@1@@@@@@@@1",se=i,ke=1
 S ^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15),"AF2")="^%ZAPM.bs.BSS,ALTF2",$P(^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",39)="^%ZAPM.bs.BSHLP,MAIN1",$P(@$ZR,"@",41)="AF10^%ZAPM.bs.BSF12"
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
RAZDE I $D(%BS(8)),$D(%VGI),$D(%BS(8,%VGI)) D UCI^%ZAPM.bs.BSH(%BS(8,%VGI),%VGI) G EXIT:'YES
 I $D(TABLfind) G TAB
 I R1=27!(ny=1) K ^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S R1=27 G UCIE:$D(BSMGR) G UCI
 I ny=2,'$D(%BS("Tmp",3))  G:$D(IntBSD) RAZD S li="" D NEWRAZD^%ZAPM.bs.BS1 I '$D(HIDDR) K ^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G RAZD
 S %NAM=$P(d," ",2) K HIDDR
TAB ;ВЫБОР ТАБЛИЦЫ
 I $G(^%ZAPM.bs.BSS("XECUTE","KEY"))'="" D XEC^%ZAPM.bs.BSF10($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""XECUTE"")"),3)
 K %BS("Tmp","EXIToutBD"),%BS(9),Pddp
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР <F4>-КОМЕН <F5>-КОПИР <F7>-ПОИСК <F8>-УДАЛИТЬ <F9>-ИНФО """ K EXITout,TABLfind S Ii=$S($G(%NAM)["%BSbufS":79,1:77)
 S Pddp=$S($D(%BS("Tmp",3)):$P(%NAM,$E(%BS("Tmp",5),2),+%BS("Tmp",5)),1:$P(%NAM,"^",2))
 S BSR="^%ZAPM.bs.BSbufB",BST="T"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST,BS2 G TABE
 S %TAB="",i=1 K ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15)),SPSV S ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)="@@1@"_Ii_"@@@@@1@"_$P(%BS,"!",4)_"@@@@@·­±.. "_%NAM_$J("",9-$L(%NAM)+Ii-77)_"        ; ТИП  ;   Комментарии к таблицам"
 S:Ii'=79 ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)="@@1@"_Ii_"@@@@@1@"_$P(%BS,"!",5)_"@@@@@·­± ~новая Таблица    "_$J("",Ii-77)_" ;      ;",i=i+1
 S Iii=i,Tmp1=1,Tmp2=2 I $D(%BS("Tmp",4)) S Tmp1=4,Tmp2=3
 F  S %TAB=$O(@%NAM@(%TAB)) Q:%TAB=""  X $G(WA) I %TAB'["@"&(%TAB'[$G(HIDD,"&"))&('$P($G(@%NAM@(%TAB)),"@",42)) K Tmp3 D
 .I '$D(IntBS),%BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",Tmp1),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",Tmp1),%BS("Tmp",Tmp2),"*")) D  Q:$D(Tmp3)
 ..I '$D(@%BS(18)@(%BS(37),%BS("Tmp",Tmp1),%BS("Tmp",Tmp2),Pddp,"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",Tmp1),%BS("Tmp",Tmp2),Pddp,%TAB)) S Tmp3=1 Q
 .I Ii=79 D  S i=i+1,^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@1@"_Ii_"@@@@"_Iii_",1@1@"_$P(%BS,"!",5)_"@@@@@·­± ~"_IIi_" .......;"_%3_";"_$P($G(@%NAM@(%TAB)),"@") Q
 ..S IIi=%TAB I %TAB["^[" S IIi=$E(%TAB,4,6)_":"_$E(%TAB,10,12)_":"_$P(%TAB,"]",2,99)
 ..S %3=$S($P($G(@%NAM@(%TAB)),"@",24)="S":"СписоК",$P($G(@$ZR),"@")["ГОТОВ":"СводкА",1:"      ")
 .I $ZV'["Cach"&&($ZV'["IRIS") Q:%TAB["."
 .S %3=$$TIP($P($G(@%NAM@(%TAB)),"@",17)) S i=i+1,^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@1@"_Ii_"@@@@3,1@1@"_$P(%BS,"!",5)_"@@@@@·­± ~"_%TAB_$J("",18-$L(%TAB)-8+Ii-77)_" .......;"_%3_";"_$P($G(^(%TAB),"!???!"),"@")
 K HIDD,IIi,Ii,Iii
 S ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@%FKT^%ZAPM.bs.BS2@1@1@@@@@@@@1",$P(@$ZR,"@",41)="AF10^%ZAPM.bs.BSF12",se=i,ke=1
 S ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15),"AF2")="^%ZAPM.bs.BSS,ALTF2",$P(^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",39)="^%ZAPM.bs.BSHLP,MAIN2" D TAB^%ZAPM.bs.BSF1
 I $G(^%ZAPM.bs.BSS("XECUTE","KEY"))'="" D XEC^%ZAPM.bs.BSF10($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""XECUTE"")"),4)
 D ^%ZAPM.bs.BST
TABE I $D(%BS(8)),$D(%VGI),$D(%BS(8,%VGI)) D UCI^%ZAPM.bs.BSH(%BS(8,%VGI),%VGI) Q:$D(IntBS)  G EXIT:'YES
 I $D(TABLfind) G TAB
 I R1=27!(ny=1) K ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15)) Q:$D(IntBS)  G RAZD
 I ny=2,%NAM'["%BSbufS" G:$D(IntBSD) TAB  S li="" D NEWTAB^%ZAPM.bs.BS1 I $G(d)'["&" K ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G TAB
 S BSR=%NAM,BST=$P($P(d,"~",2)," ") I BST'[$C(68,69,77,79,78,83,84,82),($G(^%ZAPM.bs.BSR("KEY"))'=$$PW^%ZAPM.bs.BS1(3)) D DE^%ZAPM.bs.BS1 G TAB
 I BSR'[$C(68,69,77,79,78,83,84,82),($G(^%ZAPM.bs.BSR("KEY"))'=$$PW^%ZAPM.bs.BS1(5)) D DE^%ZAPM.bs.BS1 G TAB
 I %NAM["%BSbufS",BST[":" I $ZV'["Cach"&&($ZV'["IRIS") S BST="^["""_$P(BST,":")_""":"""_$P(BST,":",2)_"""]"_$P(BST,":",3,99)
 I $D(IntBSD) Q
 I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST,BS2 G TAB
 D ^%ZAPM.bs.BST,BS2 G TAB
BS2 S:'%BS(2) %BS(2)=99 Q
PRO I $ZE["<PROT" S $ZT="PRO^%ZAPM.bs.BS" G RAZPR
 S ls=$ZE D O^%ZAPM.bs.BSF7 G RAZPR
D G 0^%ZAPM.bs.BSTM
EXIT I $D(IntBSD) K BSR,BST Q
 D OP^%ZAPM.bs.BSF4
 D GLKL^%ZAPM.bs.BS1 K (%BS) W /CUP(1,1),/ED(2) D:$G(%BS(24,1))'="" REGE^%ZAPM.bs.BSMSMF
 W $J("Сегодня: ",55),$$WEEKEND^%ZAPM.bs.BSsFUNR(1,$$h^%ZAPM.bs.BS3()),"  ",$$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3()) I $G(%BS(43))="" D SAY^%ZAPM.bs.BS3(0)
 Q
COPY I %B=3 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSS1" D Buf^%ZAPM.bs.BSF12 S $ZT=$G(%zT) G D
 I %B=2 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSS1" D REST^%ZAPM.bs.BSS1 S $ZT=$G(%zT) G D:'$D(%FN) K %FN,%DEV S R1=27 Q
 I %B=1 K %FN,%DEV S PR1="",%zT=$ZT,$ZT="ER^%ZAPM.bs.BSS1" D  S $ZT=$G(%zT) G:'$D(%FN) D C %DEV K %DEV,%FN,%DIAP G 71^%ZAPM.bs.BSF5
 .I $D(%DIA) S do="I i>2 S %TAB=$P($P($P(^(j),""@"",15),""~"",2),"" "") D COPY^%ZAPM.bs.BSS1" D BLOK^%ZAPM.bs.BSF1 Q
 .D COPY^%ZAPM.bs.BSS1 Q
DEL(%NAM,%TAB) N i,j,ZR,G I $ZV'["Cach"&&($ZV'["IRIS"),%NAM["%BSbufS",%TAB[":" S %TAB="^["""_$P(%TAB,":")_""":"""_$P(%TAB,":",2)_"""]"_$P(%TAB,":",3,99)
 Q:$P($P($G(@%NAM@(%TAB)),"@",30),"i")'=""  D PASE^%ZAPM.bs.BS1 I '$D(%w(4)) Q
 D L^%ZAPM.bs.BS3($NA(@%NAM@(%TAB))) Q:'LOC  D  D U^%ZAPM.bs.BS3($NA(@%NAM@(%TAB))) Q
 .I %TAB'[("D"_"EM"_"O"_"N"_"STR")&($G(^%ZAPM.bs.BSR("KEY"))'=$$PW^%ZAPM.bs.BS1(2)) D DE^%ZAPM.bs.BS1 Q
 .Q:'YES  D YE Q:'YES  D:'$E(%BS(1),16) KillTab^%ZAPM.bs.BSF12 D DEL^%ZAPM.bs.BSF10($NA(@(%NAM_"(%TAB)")),1) S R1=27,ny=1,%TAB="@"_%TAB D DEL^%ZAPM.bs.BSF10($NA(@(%NAM_"(%TAB)")),1) S %TAB=$E(%TAB,2,99) Q
TIP(%3) Q " "_$S(%3=1:"TABL",%3=2:"BSDT",%3=3:"LIST",%3=4:"SUMM",%3=5:"TEXT",%3=6:"LINK",%3=7:"MENU",%3=8:"BUTT",%3=9:"FAST",%3=11:"DIAL",%3=10:"RPRT",1:"!!!!")_" "
TIPP(%3) Q $S(%3["BaSe MsW":"PART",%3["BSD - MSW":"BASE",%3["%BS-invert-":"KDFK",%3["%BS-dinamo-":"MKZP",%3["%BS-index-":"INDX",1:"????")
YE I '$D(%DIA) S ls=" УДАЛЯЕМ ТАБЛИЦУ "_%NAM_","_%TAB_" !!! ВЫ УВЕРЕНЫ ? ",%B=2 W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF Q
 ;I $D(%DIA),'$G(AllWAY) D Yes^%ZAPM.bs.BSXfun("УДАЛЯЕМ ТАБЛИЦУ "_%NAM_","_%TAB_". Удалять С ПОДТВЕРЖДЕНИЕМ !!!",1) Q:YES<0  I 'YES D Yes^%ZAPM.bs.BSXfun(" ВЫ УВЕРЕНЫ ? Удалять ВСЕ ПОМЕЧЕННЫЕ ТАБЛИЦЫ БЕЗ ПОДТВЕРЖДЕНИЯ !",1) Q:YES<1  S AllWAY=1
 I $D(%DIA),'$G(AllWAY) D MENU^%ZAPM.bs.BSF5(" УДАЛИТЬ НЕ_УДАЛЯТЬ УДАЛИТЬ_ВСЕ_СРАЗУ ВЫХОД ","  ТАБЛИЦУ "_%NAM_","_%TAB,1) D  Q:'YES  S:%B=3 AllWAY=1 I %B=4 S EndLoop=1,YES=0 Q
 .I (R1=27&(R2=-1))!(%B=2) S YES=0
 Q
ADMIN() ;ПОЛЬЗОВАТЕЛЬ - АДМИНИСТРАТОР ?
 I %BS(12)'="",$D(@%BS(18)@(%BS(37),"3")) Q 1
 Q 0
]]></Routine>


<Routine name="%ZAPM.bs.BS1" type="MAC" languagemode="0"><![CDATA[
%BS1 ;ВХОД II ; 11:05   31.08.2000
 Q
WORKGRP S %BS(37)=%BS(12) I %BS(12)'="",%BS(18)'="" D  ;РАБОЧАЯ ГРУППА И КОМЕНТАРИЙ
 .I $G(@%BS(18)@(%BS(12),0,"9,4"))'="" S %BS(37)=@$ZR
 .S %BS(38)=$G(@%BS(18)@(".@WHO",%BS(12)))
 .I $O(@%BS(18)@(%BS(37),4,0,""))'="" S %BS(1)=$O(@%BS(18)@(%BS(37),4,0,""))
 Q
ADM(V,T) I T'="ADM",T=V Q 1
 I T="ADM",$$LITL^%ZAPM.bs.BSsFUNM(V)=$$LITL^%ZAPM.bs.BSsFUNM($P($G(^%ZAPM.bs.BSETUP("SETUP",9,2),$G(^%ZAPM.bs.BSS("SETUP",9,2))),"@",15)) Q 1
 Q 0
W I I'=$$PW(1) S ls=" КЛЮЧ НЕ ПРАВИЛЬНЫЙ " D O^%ZAPM.bs.BSF7 H
 I I=$$PW(1) D NMA S ls=" ALL RIGHT !!! " D O^%ZAPM.bs.BSF7 H
 H
PASE S i1=1,YES=0 D PS^%ZAPM.bs.BSD1(%NAM) D  I uc="N" S ls=" Пользователю "_%BS(12)_" КОРРЕКТИРОВАТЬ ОП.ТАБ. НЕЛЬЗЯ ",YES=0 D O^%ZAPM.bs.BSF7 X "I 0" Q
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),"*")) D
 ..I '$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),Pddp,"*")),$G(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),Pddp,%TAB,"4,2"))="N" S uc="N"
 I $P($G(@%NAM@(%TAB),"@@@cthgfy"),"@",4)="" S %w(4)="",YES=1 Q
PS D RED W " Введите пароль коррекции Описания Таблицы:",%NAM,",",%TAB," ",$$bel^%ZAPM.bs.BS3 D CLE,CL R %w(4)#7 D CachOn I $$ADM(%w(4),$P($G(@%NAM@(%TAB),"@@@cthgfy"),"@",4)) S YES=1 Q
 S:%w(4)="" i1=4 D RED W " Пароль не верен ",$$bel^%ZAPM.bs.BS3 H 2 D CLE S i1=i1+1 G PS:i1<4 K %w(4) Q
PPP ;ПАРОЛЬ ВХОДА В %BS -------
 N IP,i1,%PPP,R,ls
 ;???I %BS(12)="" G PPA
 I '$D(@%BS(18)) G PPA
 I $ZO(@%BS(18))="" G PPA
 S IP="пользователя"
PPPP S i1=1,YES=0 D RED W " Введите имя ",IP,":",$$atr^%ZAPM.bs.BS3(0) R " ",R:20 Q:"^."[R  s R=$$BIGL^%ZAPM.bs.BSsFUNM(R)
PP W /CUP(25,1),/EL(0),$$clr^%ZAPM.bs.BS3(11)," А теперь пароль :",$$atr^%ZAPM.bs.BS3(0) D CL R %PPP#40 D CachOn I $$LITL^%ZAPM.bs.BSsFUNM(R)="adm",$$LITL^%ZAPM.bs.BSsFUNM(%PPP)=$$LITL^%ZAPM.bs.BSsFUNM($P($G(^%ZAPM.bs.BSETUP("SETUP",9,2),$G(^%ZAPM.bs.BSS("SETUP",9,2))),"@",15)) S YES=1,%BS(12)="" D REGSERV Q
 I $$LITL^%ZAPM.bs.BSsFUNM(%PPP)=$$LITL^%ZAPM.bs.BSsFUNM($G(@%BS(18)@(".@PASSWORD",R),"¤")) S YES=1,%BS(12)=R D REGSERV Q
 S ls=" Пароль не верен " D O^%ZAPM.bs.BSF7 Q
PPA S IP="Администратора",%BS(12)="" I $P($G(^%ZAPM.bs.BSETUP("SETUP",9,2),$G(^%ZAPM.bs.BSS("SETUP",9,2))),"@",15)="" Q
 G PPPP
RED W /CUP(24,1),/EL(0),$$clr^%ZAPM.bs.BS3(11) Q
CLE W $$atr^%ZAPM.bs.BS3(0) Q
CL I $ZV["MSM" D CL^%ZAPM.bs.BSF4 ;ВЫКЛ ЭХА
CachOff I $ZV["Cach"||($ZV["IRIS") O 0:(:"S") ;ВЫКЛ ПОБАЙТОВОГО ЧТЕНИЯ
 Q
CachOn I $ZV["Cach"||($ZV["IRIS") O 0:(:"IS") ;ВКЛ ПОБАЙТОВОГО ЧТЕНИЯ
 Q
REGSERV D Int^%ZAPM.bs.BSERV("S $P(@G@(""CMT"",S),""§"",2)="" %BS v.""_^%ZAPM.bs.BS,$P(@G@(""CMT"",S),""§"",3)="" User :""_%BS(12)")
 Q
PAROL D PASCHECK(%NAM,"",4," Введите пароль коррекции ХАРАКТЕРИСТИК РАЗДЕЛА:"_%NAM_" ","%PAROL") Q
 ;---
PASCHECK(MAS,TAB,PICE,SAY,VAR) N AAA S i1=1,YES=0 S MAS=MAS_$S(TAB="":"",1:"(TAB)")
 I $P($G(@MAS),"@",PICE)="ADM" S AAA="ADM:" I $$LITL^%ZAPM.bs.BSsFUNM($P($G(^%ZAPM.bs.BSETUP("SETUP",9,2),$G(^%ZAPM.bs.BSS("SETUP",9,2))),"@",15))="" S YES=1 Q
 D RED W $E($G(AAA)_$G(SAY),1,75),$$bel^%ZAPM.bs.BS3 D CLE,CL R @VAR#17 D CachOn I $$ADM(@VAR,$P($G(@MAS),"@",PICE)) S YES=1 Q
 S:@VAR="" i1=4 D RED W " Пароль не верен ",$$bel^%ZAPM.bs.BS3 H 2 D CLE S i1=i1+1 G PASCHECK+1:i1<4 K @VAR Q
 ;---
COM S ll="@",ls=" Вводите / Корректируйте коментарий (до 300 симв)" D LE^%ZAPM.bs.BSTT I 'YES S li="" Q
 S li=$E(li,1,300) Q
NEWTAB S ls="Имя новой таблицы(до 10 символов),Если начинается с &,то - Скрытая",ll="@ +;:#!$.,~^""()*'\/<>" D LE^%ZAPM.bs.BSTT I 'YES S li="" Q
 I li="" Q
 I li'["DEMONST"&($G(^%ZAPM.bs.BSR("KEY"))'=$$PW(1)) D DE G NEWTAB
 I $L(li)>10 S ls=" Длина больше 10 символов " D O^%ZAPM.bs.BSF7 G NEWTAB
 D PS^%ZAPM.bs.BSD1(%NAM) D  I uc="N" S ls=" Пользователю "_%BS(12)_" СОЗДАВАТЬ ТАБЛИЦУ "_li_" ЗАПРЕЩЕНО " D O^%ZAPM.bs.BSF7 G NEWTAB
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),Pddp,"*")) G NEU
 .Q
NEU .I '$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),Pddp,li)) S uc="N"
 I $D(@(%NAM_"(li)")),$E(li,1)="&"  G HIDDEN
 I li="&?MSW?&" S HIDD="@",d="" Q
 I $E(li,1)="&" S ls=" Таблица Будет СКРЫТАЯ . Вы Уверены ? " D YES^%ZAPM.bs.BSF I 'YES G NEWTAB
 I $D(@(%NAM_"(li)")) D OkMsg^%ZAPM.bs.BSXfun(" Уже существует ") S d="&~"_li Q
 K M S II=" СПИСОК СВОДКА ",TAB=li,(M(5,2),M(5,1))=" Создание списка или сводки на основе готовой БАЗЫ ДАННЫХ" D  S ls="ВЫБЕРИТЕ НОВУЮ ТАБЛИЦУ" D MEN^%ZAPM.bs.BSF5 K II,I1,M I 'YES S li="" G NEWTAB
 .F I=1:1:19 S li="N"_I I $D(@%BS(20)@(li)) S M(5,I+2)=$P(^(li),"@") S I1=li_" " Q:$L(II_I1)>78  S II=II_I1
 .S M(1,1)=II_"@6@ @0@5"
 G TIS^%ZAPM.bs.BSS2:%B=1!(%B=2) S BSr1=%BS(20),BSt1="N"_(%B-2),BSr2=%NAM,BSt2=TAB G COPY^%ZAPM.bs.BSTK
HIDDEN S d="~"_li Q
DE S ls=" В ДЕМОНСТРАЦИОННОЙ ВЕРСИИ ИСПОЛЬЗУЙТЕ ИМЕНА НАЧИНАЮЩИЕСЯ НА ""DEMONSTR"" " D O^%ZAPM.bs.BSF7 Q
NEWRAZD S ls=" Вводите имя нового раздела ",ll="@ &()^{}[]=+-/.,,$#*!;:""~`\" D LE^%ZAPM.bs.BSTT I 'YES S li="" Q
 I li'[("D"_"E"_"M"_"O"_"NSTR")&($G(^%ZAPM.bs.BSR("KEY"))'=$$PW(2)) D DE G ERR
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BS1" S:li'["^" li="^"_li I $D(@li) G:$P($G(@li),"@",3)'=""&($P($G(@li),"@")["BaSe MsW ") HH G:$P($G(@li),"@")'["BaSe MsW " NQM S ls=" Раздел "_li_" Уже существует " D O^%ZAPM.bs.BSF7 G NEWRAZD
NEWR S @li="",%NAM=li D PS^%ZAPM.bs.BSD1(%NAM) D  I uc="N" S ls=" Пользователю "_%BS(12)_" СОЗДАВАТЬ РАЗДЕЛ "_li_" НЕЛЬЗЯ " D O^%ZAPM.bs.BSF7 G NEWRAZD
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),Pddp)) S uc="N"
 D PAROL^%ZAPM.bs.BSF4 S ls=" СДЕЛАЕМ РАЗДЕЛ СКРЫТЫЙ ? ",HIHI="",%B=2 D YES^%ZAPM.bs.BSF I YES S HIHI="S"
 S $ZT=$G(%zT),@%NAM="BaSe MsW @@"_HIHI_"@"_$G(%PAROL) D CP^%ZAPM.bs.BSGCH(%NAM,$P(%BS(22),",")) K %PAROL,HIHI Q
25 W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),ls Q
HH S HIDDR=1,d=" "_li Q
NQM I $G(@li)="" D Yes^%ZAPM.bs.BSXfun("Массив "_li_" Чужой !!! Будем из него делать раздел ?",2) G NEWRAZD:'YES,NEWR
 D ErrMsg^%ZAPM.bs.BSXfun("Массив "_li_" Чужой !!!") G NEWRAZD
ERR S ls="Не корректное имя,(до 8 лат.букв и цифр)" D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) G NEWRAZD
 Q
PW(pi) Q $G(^%ZAPM.bs.BSR("KEY"))  ;~~~Q $$WP($E(^%ZAPM.bs.BSR(1,18),95)_$E(^(18),97)_$E(^(18),99)_$E(^(18),101)_$E(^(18),103)_$E(^(18),105),$ZV,$$ZU^%ZAPM.bs.BS3(1,0))
WRITE W ! F I=95:2:105 W $E(^%ZAPM.bs.BSR(1,18),I)
 W !,$ZV,!,$$ZU^%ZAPM.bs.BS3(1,0) Q
NMA S ^%ZAPM.bs.BSR("KEY")=$$PW(4) D  G CONF^%ZAPM.bs.BSH
 .;~~~S I=" WORK ",i=121 F ii=1:1:6 S $E(^%ZAPM.bs.BSR(1,18),i)=$E(I,ii),i=i+2
END D ENDS,ENDK Q
ENDS N ENDDN,I,BSI,es1 K es S I=0,es1=$P($G(%TIT,1),",") F BSI=se:-1:1 Q:BSI=""  I $D(@(BSR_"(BST,BSI,ke)")) D  I $D(ENDDN) S es=BSI+1 Q
 .I ($P(^(ke),"@",3)+I-1)>(BSY2(BS0)-BSY1(BS0)) S ENDDN=1
 .S I=I+$P(^(ke),"@",3)
 I $D(es),es<es1 S es=es1
 I '$D(es) S es=es1
 Q
ENDK N ENDRI,I,BSII,ek1 K ek S I=0,ek1=$P($G(%TIT,"1,1"),",",2) F BSII=ke:-1:1 Q:BSII=""  I $D(@(BSR_"(BST,se,BSII)")) D  I $D(ENDRI) S ek=BSII+1 Q
 .I ($P(^(BSII),"@",4)+I-1)>(BSX2(BS0)-BSX1(BS0)) S ENDRI=1
 .S I=I+$P(^(BSII),"@",4)
 I $D(ek),ek<ek1 S ek=ek1
 I '$D(ek) S ek=ek1
 Q
WP(pw,pv,pu) S pi=($E(pw,4)*$A($E(pv,$L(pv)-3))*$A($E(pu,2)))+($E(pw,5)*$A($E(pv,$L(pv)-5))*$A($E(pu,6)))
 Q ($E(pw,1)*$A($E(pv,$L(pv)))*$A($E(pu,3)))+($E(pw,2)*$A($E(pv,$L(pv)-2))*$A($E(pu,1)))+($E(pw,3)*$A($E(pv,$L(pv)-1))*$A($E(pu,5)))+($E(pw,6)*$A($E(pv,$L(pv)-4))*$A($E(pu,7)))+pi
ALLERR I $ZE["<ZFS" S ls="ОШИБКА РАБОТЫ С ФЛАГОМ ЗАПИСИ НА СЕТЕВОЙ МОНТИРУЕМЫЙ ТОМ" D ER^%ZAPM.bs.BSMSMF,WAITS^%ZAPM.bs.BSF2,END^%ZAPM.bs.BSF,GLKL,OP^%ZAPM.bs.BSF4
 I $ZE["<ZF10" S ls="ФОРСИРОВАННЫЙ ВЫХОД" D ER^%ZAPM.bs.BSMSMF,WAITS^%ZAPM.bs.BSF2,END^%ZAPM.bs.BSF,GLKL,OP^%ZAPM.bs.BSF4 G REC^%ZAPM.bs.BSF12
 I $ZE["<ZF11" S ls="СЕАНС ПРЕРВАН ДИСПЕТЧЕРОМ" D ER^%ZAPM.bs.BSMSMF,WAITS^%ZAPM.bs.BSF2,END^%ZAPM.bs.BSF,GLKL,REC^%ZAPM.bs.BSF12,MGR^%ZAPM.bs.BS
 I $ZE["<INRPT" S ls="ПРЕРВАНО" D ER^%ZAPM.bs.BSMSMF,WAITS^%ZAPM.bs.BSF2,GLKL,OP^%ZAPM.bs.BSF4 G REC^%ZAPM.bs.BSF12
 I $ZE["<DSTDB" S ls="ПРЕРВАНА СЕТЕВАЯ СВЯЗЬ" D ER^%ZAPM.bs.BSMSMF,WAITS^%ZAPM.bs.BSF2,GLKL,OP^%ZAPM.bs.BSF4 G REC^%ZAPM.bs.BSF12
 I $ZE["<DKFUL" S ls="НЕТ СВОБОДНОГО МЕСТА НА ДИСКЕ" D ER^%ZAPM.bs.BSMSMF,O^%ZAPM.bs.BSF7,GLKL,OP^%ZAPM.bs.BSF4 Q
 I $ZE["<PGMOV"!($ZE["<STKOV") W $$bel^%ZAPM.bs.BS3,$$clr^%ZAPM.bs.BS3(11),/ED(2),/CUP(1,1),"!!! НЕХВАТКА ОПЕРАТИВНОЙ ПАМЯТИ В РАЗДЕЛЕ !!!",!,$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE) W $$atr^%ZAPM.bs.BS3(0) D ER^%ZAPM.bs.BSMSMF,GLKL,OP^%ZAPM.bs.BSF4 Q
 E  D ER^%ZAPM.bs.BSMSMF
 S ls=$$ZE() D O^%ZAPM.bs.BSF7 W $$atr^%ZAPM.bs.BS3(0) Q
ZE() Q $ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)
ALLKILLB ;УДАЛИТЬ ВСЕ БУФЕРА ПЕРЕД ВЫХОДОМ В ДОС
 N II S II="" F  S II=$O(^%ZAPM.bs.BSbufB(II)) Q:II=""  I II["u" K ^%ZAPM.bs.BSbufB(II)
 Q
GLKL N II,ii,i S II="" F  S II=$O(^%ZAPM.bs.BSbufB(II)) Q:II=""  I II["u" S i=$P(II,"u",$S($E(II)'="u":1,1:2)) D  I ($G(%BS(3),$P)_$J)=$E(i,ii+1,99) K ^%ZAPM.bs.BSbufB(II)
 .F ii=$L(i):-1:1 Q:$E(i,ii)'?1N
 D ERASER^%ZAPM.bs.BSJPRN(0)
 Q
PROC N WIN S st=80,ks=25 D WIND^%ZAPM.bs.BSF3 Q:'YES  D ^%ZAPM.bs.BS,CW^%ZAPM.bs.BSF3 Q
]]></Routine>


<Routine name="%ZAPM.bs.BS2" type="MAC" languagemode="0"><![CDATA[
%BS2 ;Ф-КЛАВИШИ %BS & ETC.; 21:02 28-NOV-96 ; 14:07   02.06.2001
 Q
Hidden ;ОПРЕДЕЛЕНИЕ ПАРАМЕТРОВ РЕЖИМА HiddenLastKey
 S Hidd=$P(@BSR@(BST,"KEY",endkey),"@",15) I Hidd="" W $$bel^%ZAPM.bs.BS3 W $$bel^%ZAPM.bs.BS3 W $$bel^%ZAPM.bs.BS3 K Hidd Q
 S Hidd(1)=$P(@BSR@(BST,"KEY",endkey),"@",5)
 S endkey=endkey-1
 Q
Hidd ;ПРОГОН ТАБЛИЦЫ
 N D,Y1,Y2,X1,X2
 S Hid=$$TMPG^%ZAPM.bs.BSF11 I Hidd(1)="" S Hidd(1)="1,1,9999999,9999999"
 S Y1=$P(Hidd(1),",",1),Y2=$P(Hidd(1),",",3),X1=$P(Hidd(1),",",2),X2=$P(Hidd(1),",",4)
 F i=Y1:1:Y2 Q:'$D(@BSR@(BST,i))  F j=X1:1:X2 Q:'$D(@BSR@(BST,i,j))  I $P($P(^(j),"@",18),"#",2)=Hidd D
 .S D=$P(^(j),"@",15) I D'="",'$D(@Hid@(i)) S @Hid@(i)=D
 Q
FIND(G,S,U,D) ;БЛОК ПОИСКА
 N I,I1,I2,I3,I4,I5,I6,I7,I8,I9,J,JJ,JJJ
 ;;;S S=$S(S=+S:S,S[$C(34):S,1:$C(34)_S_$C(34))
 D Wait^%ZAPM.bs.BSXfun("Сканирую уровень "_U_" у "_G)
 K END S I1="" F  S I1=$O(@G@(I1)) Q:I1=""  I $D(@G@(I1)) D:U=1 FI(I1) Q:$D(END)  D  Q:$D(END)
 .S I2="" F  S I2=$O(@G@(I1,I2)) Q:I2=""  I $D(@G@(I1,I2)) D:U=2 FI(I2) Q:$D(END)  D  Q:$D(END)
 ..S I3="" F  S I3=$O(@G@(I1,I2,I3)) Q:I3=""  I $D(@G@(I1,I2,I3)) D:U=3 FI(I3) Q:$D(END)  D  Q:$D(END)
 ...S I4="" F  S I4=$O(@G@(I1,I2,I3,I4)) Q:I4=""  I $D(@G@(I1,I2,I3,I4)) D:U=4 FI(I4) Q:$D(END)  D  Q:$D(END)
 ....S I5="" F  S I5=$O(@G@(I1,I2,I3,I4,I5)) Q:I5=""  I $D(@G@(I1,I2,I3,I4,I5)) D:U=5 FI(I5) Q:$D(END)  D  Q:$D(END)
 .....S I6="" F  S I6=$O(@G@(I1,I2,I3,I4,I5,I6)) Q:I6=""  I $D(@G@(I1,I2,I3,I4,I5,I6)) D:U=6 FI(I6) Q:$D(END)  D  Q:$D(END)
 ......S I7="" F  S I7=$O(@G@(I1,I2,I3,I4,I5,I6,I7)) Q:I7=""  I $D(@G@(I1,I2,I3,I4,I5,I6,I7)) D:U=7 FI(I7) Q:$D(END)  D  Q:$D(END)
 .......S I8="" F  S I8=$O(@G@(I1,I2,I3,I4,I5,I6,I7,I8)) Q:I8=""  I $D(@G@(I1,I2,I3,I4,I5,I6,I7,I8)) D:U=8 FI(I8) Q:$D(END)  D  Q:$D(END)
 ........S I9="" F  S I9=$O(@G@(I1,I2,I3,I4,I5,I6,I7,I8,I9)) Q:I9=""  I $D(@G@(I1,I2,I3,I4,I5,I6,I7,I8,I9)) D:U=9 FI(I9) Q:$D(END)  D  Q:$D(END)
 Q
FI(O) I ("@"_O)[("@"_S) X D
 X WA Q
%FKR I R3=89 ZT "F10"
 I R3=86,'$D(%BS("Tmp",3)) D FIND^%ZAPM.bs.BSF5 G D
 S %NAM=$P(d," ",2) I R3=85,'$D(%BS("Tmp",3)) D SRV^%ZAPM.bs.BSF5 G D^%ZAPM.bs.BSF5
IntFKR ;%NAM=ИМЯ МАССИВА
 I R3=84,'$D(%BS("Tmp",3)) D APPLIC^%ZAPM.bs.BSZGAP Q:R1=27  G D^%ZAPM.bs.BSF5
 I R3=87 G D:ny<3!($D(%BS("Tmp",3))) D  Q:R1=27
 .D PAROL^%ZAPM.bs.BS1 I '$D(%PAROL) K %PAROL Q
 .S i="" I $O(@(%NAM_"(i)"))'="" D Yes^%ZAPM.bs.BSXfun("Раздел не пустой !!! Вы УВЕРЕНО ХОТИТЕ ЕГО УДАЛИТЬ ?",2) Q:YES<1
 .I %NAM'[("DE"_"M"_"O"_"NS"_"TR")&($G(^%ZAPM.bs.BSR("KEY"))'=$$PW^%ZAPM.bs.BS1(2)) D DE^%ZAPM.bs.BS1 Q
 .K @(%NAM) S R1=27,ny=1 D NEWDIR^%ZAPM.bs.BSD1
 I R3=83 I ny>$S($D(%BS("Tmp",3)):1,1:2) S li=$P(@%NAM,"@",2) D COM^%ZAPM.bs.BS1 D  G D
 .I YES S $P(@%NAM,"@",2)=li D
 ..I $D(IntFKR) S $P(@BSR@(BST,ny,nx),"@",15)=$E(d,1,6)_li Q
 ..S $P(d,";",2)=li,$P(^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,1),"@",15)=d
 G D
ERRRVG D ErrMsg^%ZAPM.bs.BSXfun("Редактирование харрактеристик возможно только в явно смонтрованном томе.  А мы сейчас находимся в томе смонтированном,  как RVG (Remote Volume Group)") q
%GBL I '$$RP^%ZAPM.bs.BSGCH("^BSdirddp") D ERRRVG Q
 D PAROL^%ZAPM.bs.BS1 I $D(%PAROL) S %GLB=%NAM K %PAROL D ^%ZAPM.bs.BSGCH,PROTALL^%ZAPM.bs.BSF9
 Q
%FKT I R3=89 ZT "F10"
 I R3=86 D FIND^%ZAPM.bs.BSF5 G D
 S %TAB=$P($P(d,"~",2)," "),ZZ=3 S:%NAM["%BSbufS" ZZ=2
 I R3=87 G D:ny<ZZ D  K AllWAY Q:R1=27
 .K AllWAY I $D(%DIA) S do="I i'<ZZ S %TAB=$P($P($P(^(j),""@"",15),""~"",2),"" "") I %TAB'="""" D DEL^%ZAPM.bs.BS(%NAM,%TAB)" D BLOK^%ZAPM.bs.BSF1 Q
 .D DEL^%ZAPM.bs.BS(%NAM,%TAB) Q
 I R3=85 D SRV^%ZAPM.bs.BSF5 K KILLER G D
 I R3=83,ny>2,$P(@(%NAM_"(%TAB)"),"@",30)="" S li=$P(@$ZR,"@") D COM^%ZAPM.bs.BS1 S:YES $P(@(%NAM_"(%TAB)"),"@")=li,$P(d,";",3)=li S $P(^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,1),"@",15)=d G D
 I R3=84 S OO=14,OOO="^%ZAPM.bs.BS" K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G D:R1=27 G COPY^%ZAPM.bs.BS
 I R3=88 D
 .D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,%NAM,%TAB) S BSR=%NAM,BST=%TAB D INFO^%ZAPM.bs.BSF6 Q
D W /CUP(24,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),/CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0)
 G D^%ZAPM.bs.BS
Comnt(d) Q:'$E(%BS(1),7) ;ВЫВОД КОМЕНТАРИЯ
 W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),$$ComUCI(d)
 Q
ComUCI(d) Q:d="" "" ;ВОЗВРАТ КОМЕНТАРИЯ
 Q:BSII=nx "" N u,s
 S %zT=$ZT,$ZT="ComErr^%ZAPM.bs.BS2"
 I d?.N1",".N S s=$P($$ZU^%ZAPM.bs.BS3($P(d,",",2),$P(d,",")),",",2),u=$P($$ZU^%ZAPM.bs.BS3($P(d,",",2),$P(d,",")),",") G Co
 E  S u=d,s=$P(^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,nx),"@",15)
Co Q $P($G(@("^["""_u_""","""_s_"""]BSdirddp"),"?"),"@")
ComErr S $ZT=$G(%zT) Q "@"
SetComU(d,li) ;ПРИВОЕНИЕ КОМЕНТАРИЯ
 S %zT=$ZT,$ZT="ComErrS^%ZAPM.bs.BS2" I $$ComUCI(d)
 I $ZR["BSdirddp" S $P(@$ZR,"@")=li,YES=1
 Q
ComErrS S $ZT=$G(%zT),YES=0 D ErrMsg^%ZAPM.bs.BSXfun(" Коррекция Комментария кипа недоступна") Q
COM ;ПРИCВОЕНИЕ КОМЕНТАРИЯ
 S li=$$ComUCI(d) D SetComU(d,li) Q:'YES
 I li="@" D ErrMsg^%ZAPM.bs.BSXfun(" Комментарий кипа недоступен") Q
 D COM^%ZAPM.bs.BS1 I YES D SetComU(d,li)
 Q
TESTC(KOLC) W #,"Идет тест",!
TEST ;ТЕСТ КОМБИНИРОВАННЫЙ
 N G,I,L1,L2,G1,G2,DE,AAA,TE,BY,S1,S2,S3,TmpTime
 S TE=$P($$h^%ZAPM.bs.BS3(),",",2),TmpTime=$P($H,",",2) ;НАЧАЛО
 F DE=1000:2000:$G(KOLC,10000) D ZF^%ZAPM.bs.BS3 D ZF^%ZAPM.bs.BS3 D ZF^%ZAPM.bs.BS3 S DE(DE)=$$T(DE)
 K ^BStest($P),@G S TE=$P($$h^%ZAPM.bs.BS3(),",",2)-TE
 S I="",G=0,L1=0,L2=0 F  S I=$O(DE(I)) Q:I=""  S G1=G1+$P(DE(I),"\"),L1=L1+$P(DE(I),"\",2),G2=G2+$P(DE(I),"\",3),L2=L2+$P(DE(I),"\",4),G=G+1
 S S1="Среднее Отношение байт/сек лок.к глоб.записи/лок.к глоб.чтению ("_((L1\G)/(G1\G))_"/"_((L2\G)/(G2\G))_")"
 S S2="Производительнось DDP Кб/сек Запись/Чтение ("_(G1\1024)_"/"_(G2\1024)_")"
 S TmpTime=$P($H,",",2)-TmpTime
 S S3="Всего работали "_(TmpTime/60)_" Мин."
 I $ZV["Windows" W !,S1,!,S2,!,S3,! Q
 D OkMsg^%ZAPM.bs.BSXfun(S1_" "_S2_" "_S3)
 Q
T(DE) S BY=DE*185
 K ^BStest($P) S G=$ZR,L1=$$TE(G,"ЛОК.ЗАПИСЬ "_G,DE) S L2=$$TES(G,"ЛОК.ЧТЕНИЕ "_G,DE)
 I $ZV['"Windows" S G=$P($P($G(^%ZAPM.bs.BSETUP("SERVER",4,4)),"@",15),"\",2),G=$NA(@G@("TEST",$P($$ZU^%ZAPM.bs.BS3(1,0),",",2),$G(%BS(3),$P)))
 I $ZV["Windows" S G="^BStest1",G=$NA(@G@("TEST",$G(%BS(3),$P)))
 K @G S G1=$$TE(G,"ГЛОБ.ЗАПИСЬ "_G,DE) S G2=$$TES(G,"ГЛОБ.ЧТЕНИЕ "_G,DE)
 Q (BY\$S(G1:G1,1:1))_"\"_$S((BY\$S(L1:L1,1:1)):(BY\$S(L1:L1,1:1)),1:1)_"\"_(BY\$S(G2:G2,1:1))_"\"_$S((BY\$S(L2:L2,1:1)):(BY\$S(L2:L2,1:1)),1:1)
TE(A,TT,KO) N T1,I
 D Wait^%ZAPM.bs.BSXfun(DE_":"_TT) S T1=$P($$h^%ZAPM.bs.BS3(),",",2)
 F I=1:1:KO S @A@(I)="1234567890-=\][POIUYTREWQASDFGHJKL;'/.,MNBVCXZzxcvbnm<>?:lkjhgfdsaqwertyuiop{}|+_)(*&^%$#@!~(1234567890-=\ЪХЗЩШГНЕКУЦЙФЫВАПРОЛДЖЭЁЮБЬТИМСЧЯячсмитьбюёэждлорпавыфйцукенгшщзхъ|+_%?;.,:$/!)" I '(I#100) X WA
 Q ($P($$h^%ZAPM.bs.BS3(),",",2)-T1)
TES(A,TT,KO) N T1,I
 I $ZV['"Windows" D Wait^%ZAPM.bs.BSXfun(DE_" Тест.Фаза:"_TT)
 S T1=$P($$h^%ZAPM.bs.BS3(),",",2)
 F I=1:1:KO S AAA($R(10))=@A@(I) I '(I#500) X $G(WA) I $G(WA)="" W "."
 Q ($P($$h^%ZAPM.bs.BS3(),",",2)-T1)
]]></Routine>


<Routine name="%ZAPM.bs.BS3" type="MAC" languagemode="0"><![CDATA[
%BS3 ;ЛОКИРОВКА ГЛОБАЛЕЙ ; 9:13   09.10.2001
BSR I $E(BSR,$L(BSR))="," S BSR=$E(BSR,1,$L(BSR)-1)_$S($E(BSR,$L(BSR))=",":")",1:"")
 Q
TRAP I k2=65 W #,!,k3 R R
 Q
FTRAP() D x("?") Q 1
L(BSR,L) ;ЛОКИРОВКА ССЫЛКИ
 D BSR I BSR="" D ERRBSR
 S LOC=1
 I $E(BSR,1,2)="^$" Q
 L +@BSR:0 E  D DDPLOCK
 Q
DDPLOCK ;ОЖИДАНИЕ ЛОКИРОВКА ССЫЛКИ
 S LOC=0 I $D(L) Q
 F  S ls="Узел "_BSR_" занят !!!,<Esc>-назад" D WAITS^%ZAPM.bs.BSF2 S gi=$G(gi,1)+1 W " ",gi H 1 W $$rt^%ZAPM.bs.BS3(0) D:R1=27  Q:R1=27  L +@BSR:0 I $T S LOC=1 Q
 .S ls="Узел "_BSR_" занят ,<Esc>-назад"
 Q
U(BSR) ;СНЯТИЕ ЛОКИРОВКИ
 D BSR I BSR="" D ERRBSR
 L -@BSR Q
ERRBSR Q:$D(L)  D ErrMsg^%ZAPM.bs.BSXfun("ЛОКИРУЕТСЯ ПУСТАЯ ССЫЛКА !!!") Q
R(BSR) D L(BSR) Q
D(BSR) D U(BSR) Q
  ;
  ;   АНАЛОГИ !!!
  ;
ZF I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 ZF  Q
ZU(K,T) ;АНАЛОГ $ZU
  I $ZV["Cach"||($ZV["IRIS") Q $ZU(5)
  I $D(T) Q $ZU(K,T)
  E  Q $ZU(K)
x(x) S %BS("Tmp","NameS")=x D x^%ZAPM.bs.BS7238(%BS("Tmp","NameS")) Q
l() D WRITE^%ZAPM.bs.BS7238 Q ""
pr() Q:$ZN=""  S %zN=$ZN D PRINT^%ZAPM.bs.BS7238 ;ZL @%zN X %z0 K %zN,%z0,%z1,%z2,%z3,%z4,%z5,%z6,%z7,%z8,%z9,%z10,%z11,%z12,%z13 Q
atr(A) Q $C(27)_"["_A_"m"
bel() Q "" /// $C(7)
clear() Q $C(27)_"[0;0;25;80w"
clr(C) Q $C(27)_"["_$P($G(%BS,"1;6;33;42!1;6;37;47!1;6;33;46!1;6;30;45!1;6;30;46!2;6;30;46!1;6;33;45!2;6;30;46!1;6;33;46!2;6;30;41!1;6;32;40"),"!",C)_"m"
ed() Q $C(27)_"[2J" ;| W /ED(2)
el() Q $C(27)_"[K"  ;| W /EL(0)
esc(E) Q $C(27)_E
setkod() Q ""
r() N R,RR R *R,*RR:0,*RR:0 Q ""
rt(R) I $ZV["Cach"||($ZV["IRIS") D  Q "" ;ANSI-TERMINAL
 .X $G(%BS(43)) 
 .O 0:(:"IS") R *R1:R,*R2:0 i R1>31,R2>31 s rr=$c(R1)_$c(R2) f  r *r:0 d:r'=-1  i r=-1,$l(rr)>1 d AddHist^%ZAPM.bs.BSXuse("^%ZAPM.bs.BSbufB(""HISCTL1"")",rr) q  ;,ReadToEL^%ZAPM.bs.BSXuse
 ..s rr=rr_$c(r)  ;строка из буфера обмена Windows
 .r *R3:0,*R4:0,*R5:0 
 .;w !,"==="_R1_" "_R2_" "_R3_" "_R4_" "_R5,!  ;нужно узнать альт коды
 .I R1=13 S R2=-1
 .I '$E($G(%BS(1)),15),R1=3,R2=-1,R3=-1 ZT "INRP"
 .i R1=5 s R1=0,R2=18,R3=-1,R4=-1,R5=-1 q  ;Ctr-E --> Alt-E
 .i R1=4 s R1=0,R2=31,R3=-1,R4=-1,R5=-1 q  ;Ctr-D --> Alt-S
 .if $g(%BS(2008))="1L" d  ;эмуляция ANSI-TERMINAL, если Linux
 ..i R1=27,R2=91,R3=51,R4=126 s R1=127,R2=-1,R3=-1,R4=-1,R5=-1 q  ;del
 ..i R1=27,R2=91,R3=50,R4=126 s R1=0,R2=82,R3=-1,R4=-1,R5=-1 q  ;ins
 ..i R1=27,R2=91,R3=49,R4=126 s R1=0,R2=71,R3=-1,R4=-1,R5=-1 q  ;home
 ..i R1=27,R2=91,R3=52,R4=126 s R1=0,R2=79,R3=-1,R4=-1,R5=-1 q  ;end
 ..i R1=27,R2=91,R3=53,R4=126 s R1=0,R2=73,R3=-1,R4=-1,R5=-1 q  ;pu
 ..i R1=27,R2=91,R3=54,R4=126 s R1=0,R2=81,R3=-1,R4=-1,R5=-1 q  ;pd 
 ..i R1=27,R2=91,R3=49 d  q
 ...i R4=53 s R1=27,R2=79,R3=84,R4=-1,R5=-1 q  ;f5
 ...i R4=52 s R1=27,R2=79,R3=83,R4=-1,R5=-1 q  ;f4
 ...i R4=51 s R1=27,R2=79,R3=82,R4=-1,R5=-1 q  ;f3
 ...i R4=50 s R1=27,R2=79,R3=81,R4=-1,R5=-1 q  ;f2
 ...i R4=49 s R1=27,R2=79,R3=80,R4=-1,R5=-1 q  ;f1
 ...i R4=57 s R1=27,R2=79,R3=87,R4=-1,R5=-1 q  ;f8
 ...i R4=56 s R1=27,R2=79,R3=86,R4=-1,R5=-1 q  ;f7
 ...i R4=55 s R1=27,R2=79,R3=85,R4=-1,R5=-1 q  ;f6
 .i $g(%BS(2008)) d  ;эмуляция ANSI-TERMINAL, если версия больше 2008.1.2
 ..i R1=27,R2=91,R3=51,R4=126 s R1=127,R2=-1,R3=-1,R4=-1,R5=-1 q  ;del
 ..i R1=27,R2=91,R3=50,R4=126 s R1=0,R2=82,R3=-1,R4=-1,R5=-1 q  ;ins
 ..i R1=27,R2=91,R3=49,R4=126 s R1=0,R2=71,R3=-1,R4=-1,R5=-1 q  ;home
 ..i R1=27,R2=91,R3=52,R4=126 s R1=0,R2=79,R3=-1,R4=-1,R5=-1 q  ;end
 ..i R1=27,R2=91,R3=53,R4=126 s R1=0,R2=73,R3=-1,R4=-1,R5=-1 q  ;pu
 ..i R1=27,R2=91,R3=54,R4=126 s R1=0,R2=81,R3=-1,R4=-1,R5=-1 q  ;pd 
 ..i R1=27,R2=91,R3=49 d  q
 ...i R4=57 s R1=27,R2=79,R3=87,R4=-1,R5=-1 q  ;f8
 ...i R4=56 s R1=27,R2=79,R3=86,R4=-1,R5=-1 q  ;f7
 ...i R4=55 s R1=27,R2=79,R3=85,R4=-1,R5=-1 q  ;f6
 I $ZV["MSM-Workstation" R *R1:R,*R2:0,*R3:0 R *R4:0,*R5:0 D  Q ""
 .I $D(%BS(35,$P(R1_","_R2_","_R3_","_R4_","_R5,",-1"))) S Tmp=%BS(35,$P(R1_","_R2_","_R3_","_R4_","_R5,",-1"))_"-1,-1,-1,-1",R1=$P(Tmp,","),R2=$P(Tmp,",",2),R3=$P(Tmp,",",3),R4=$P(Tmp,",",4),R5=$P(Tmp,",",5)
 ;MSM-PC\PLUS & TERMINALS
 R *R1:R s R2=R1 d  i R4 f  s R2=R2_","_R1 d  Q:R4=0
 .f R3=1:1:30 r *R1:0 s R4=$t q:R4
 S R5=$P(R2_",-1,-1,-1,-1",",",1,5) I $D(%BS(35)) D
 .I $D(%BS(35,R5)) S R5=%BS(35,R5)_"-1,-1,-1,-1"
 S R1=$P(R5,",",1),R2=$P(R5,",",2),R3=$P(R5,",",3),R4=$P(R5,",",4),R5=$P(R5,",",5)
 Q ""
 
yx(Y,X) I $ZV["MSM-Workstation",Y>22 S Y=Y-1 ;| W /CUP(Y,X)
 S $X=Y-1,$Y=X-1 Q $C(27)_"["_Y_";"_X_"H"
p() Q $p
RE D ^%ZAPM.bs.BSXprog() Q
GE D ^%ZAPM.bs.BSMSMG() Q
h() Q $G(%BS(36),$P($H,","))_","_$P($H,",",2)
SAY(Y,X) N q,QQ     ;ЧТО И КЕМ
 S QQ=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""OWNER"")")
 W:Y /CUP(Y,X) W:'Y ! W $G(@QQ@(1))_$$ver^%ZAPM.bs.BSC //," §",^%ZAPM.bs.BS
 F I=2:1:5 W:Y /CUP(Y-1+I,X) W:'Y ! W $G(@QQ@(I))
 S I=6 W:Y /CUP(Y-1+I,X) W:'Y ! W "Registred EndUser:  " //,$G(^%ZAPM.bs.BSinFL)
 S I=7 W:Y /CUP(Y-1+I,X) W:'Y ! S q=$$GETOPT^%ZAPM.bs.BSC4cfg($$MainOpt^%ZAPM.bs.BSC4,"ENDUSER") S:q="?" q="MSW" W q
 Q
REGISTR ;РЕГИСТРАЦИЯ
	///
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BS364" type="MAC" languagemode="0"><![CDATA[
%X364 ; BINDING FOR ANSI X3.64 NAMESPACE, NOV/92 ; RLL377 11/22/93  ; Compiled October 8, 2004 12:32:13
 ; +--------------------------------------------------------+
 ; | Copyright 1986-2003 by InterSystems Corporation,       |
 ; | Cambridge, Massachusetts, U.S.A.                       |
 ; | All rights reserved.                                   |
 ; |                                                        |
 ; | Confidential, unpublished property of InterSystems.    |
 ; |                                                        |
 ; | This media contains an authorized copy or copies       |
 ; | of material copyrighted by InterSystems and is the     |
 ; | confidential, unpublished property of InterSystems.    |
 ; | This copyright notice and any other copyright notices  |
 ; | included in machine readable copies must be reproduced |
 ; | on all authorized copies.                              |
 ; +--------------------------------------------------------+
 u 0 w !,"Illegal entry point: do not call ^",$ZN," directly."
 q:$zu(41)'>2  ZTRAP "EP"
APC ; Application program command
 w $c(27)_"_"
 q
BEL ; Ring the bell
  //w $c(7)
 q
CBT(%1) ; Cursor backward tabulation %1 tab stops
 s %1=+$g(%1,1) w $c(27,91)_%1_"Z" s $x=$x+7\8*8-(%1*8) s:$x<0 $x=0
 q
CCH ; Cancel character
 w $c(27)_"T"
 q
CHA(%1) ; Cursor horizontal absolute (move to column %1)
 s %1=+$g(%1,1) w $c(27,91)_%1_"G" s $x=%1-1
 q
CHT(%1) ; Cursor horizontal tabulation (forward %1 tab stops)
 s %1=+$g(%1,1) w $c(27,91)_%1_"I" s $x=$x\8*8+(%1*8) s:$x>255 $x=255
 q
CNL(%1) ; Cursor next line (cursor down %1 lines)
 s %1=+$g(%1,1) w $c(27,91)_%1_"E" s $y=$y+%1 s:$y>255 $y=255
 q
CPL(%1) ; Cursor preceding line (cursor up %1 lines)
 s %1=+$g(%1,1) w $c(27,91)_%1_"F" s $y=$y-%1 s:$y<0 $y=0
 q
CPR ; Cursor position report (return in $KEY)
 n %1 w $c(27,91)_"6n" r %1
 q
CTC(%1,%2,%3,%4,%5,%6,%7,%8,%9) ; Cursor tabulation control
 n %i,%p s %p=""
 f %i=1:1:9 i $d(@("%"_%i)) s %p=%p_$e(";",%p'="")_@("%"_%i)
 w $c(27,91)_%p_"W"
 q
CUB(%1) ; Cursor backward %1 columns
 s %1=+$g(%1,1) w $c(27,91)_%1_"D" s $x=$x-%1 s:$x<0 $x=0
 q
CUD(%1) ; Cursor down %1 lines
 s %1=+$g(%1,1) w $c(27,91)_%1_"B" s $y=$y+%1 s:$y>255 $y=255
 q
CUF(%1) ; Cursor forward %1 columns
 s %1=+$g(%1,1) w $c(27,91)_%1_"C" s $x=$x+%1 s:$x>255 $x=255
 q
CUP(%2,%1) ; Cursor position (column %1, line %2)
 I %2=0 S %2=1
 I %1=0 S %1=1
 s %1=+$g(%1,1),%2=+$g(%2,1) w $c(27,91)_%2_";"_%1_"H"
 //---MSW
 I %1>0 s $x=%1-1
 I %2>0 S $y=%2-1
 //---
 S $x=$s($x<0:0,$x>255:255,1:$x),$y=$s($y<0:0,$y>255:255,1:$y)
 q
CUU(%1) ; Cursor up %1 lines
 s %1=+$g(%1,1) w $c(27,91)_%1_"A" s $y=$y-%1 s:$y<0 $y=0
 q
CVT(%1) ; Cursor vertical tabulation
 w $c(27,91)_+$g(%1,1)_"Y"
 q
DA ; Device attributes - return in $KEY
 n %1,%2,%3 s %3="" u $i:("":"+S")
 w $c(27,91)_"c" r %1 s %2=$k f  r *%1 s %3=%3_$c(%1) q:%1=99
 s $k=%2_%3 u $i:("":"-S")
 q
DAQ(%1,%2,%3,%4,%5,%6,%7,%8,%9) ; Define area qualification
 n %i,%p s %p=""
 f %i=1:1:9 i $d(@("%"_%i)) s %p=%p_$e(";",%p'="")_@("%"_i)
 w $c(27,91)_%p_"o"
 q
DCH(%1) ; Delete %1 characters
 w $c(27,91)_+$g(%1,1)_"P"
 q
DCS ; Device control string
 w $c(27)_"P"
 q
DL(%1) ; Delete %1 lines
 w $c(27,91)_+$g(%1,1)_"M"
 q
DMI ; Disable manual input
 q
DSR(%1) ; Device status report - type %1 - return in $KEY
 n %2 w $c(27,91)_+$g(%1,5)_"n" r %2
 q
EA(%1) ; Erase in area
 w $c(27,91)_+$g(%1,1)_"O"
 q
ECH(%1) ; Erase %1 characters
 w $c(27,91)_+$g(%1,1)_"X"
 q
ED(%1) ; Erase in display (%1=0 cursor-to-end,1 begin-to-cursor,2 entire scr)
 w $c(27,91)_+$g(%1)_"J"
 q
EF(%1) ; Erase in field
 w $c(27,91)_+$g(%1,1)_"N"
 q
EL(%1) ; Erase in line (%1=0 cursor-to-end, 1 begin-to-cursor, 2 entire line)
 w $c(27,91)_+$g(%1)_"K"
 q
EMI ; Enable manual input
 q
EPA ; End of protected area
 w $c(27)_"W"
 q
ESA ; End of selected area
 w $c(27)_"G"
 q
FNT ; Font selection
 q
GSM ; Graphic size modification
 q
GSS ; Graphic size selection
 q
HPA(%1) ; Horizontal position attribute (cursor to column %1)
 s %1=+$g(%1,1) w $c(27,91)_%1_"`" s $x=%1-1 s:$x<0 $x=0
 q
HPR(%1) ; Horizontal position relative (cursor forward %1 columns)
 s %1=+$g(%1,1) w $c(27,91)_%1_"a" s $x=$x+%1 s:$x>255 $x=255
 q
HTJ ; Horizontal tab with justify
 w $c(27)_"I"
 q
HTS ; Horizontal tabulation set
 w $c(27)_"H"
 q
HVP(%1,%2) ; Horizontal and vertical position (column %1, line %2)
 s %1=+$g(%1,1),%2=+$g(%2,1) w $c(27,91)_%2_";"_%1_"f"
 s $x=%1-1,$y=%2-1,$x=$s($x<0:0,$x>255:255,1:$x),$y=$s($y<0:0,$y>255:255,1:$y)
 q
ICH(%1) ; Insert %1 characters
 w $c(27,91)_+$g(%1,1)_"@"
 q
IL(%1) ; Insert %1 lines
 w $c(27,91)_+$g(%1,1),"L"
 q
IND ; Index
 w $c(27)_"D" s $y=$y+1 s:$y>255 $y=255
 q
INT ; Interrupt
 w $c(27,91)_"a"
 q
JFY ; Justify
 q
MC ; Media copy
 w $c(27,91)_"i"
 q
MW ; Message waiting
 w $c(27)_"U"
 q
NEL ; Next line
 w $c(27)_"E" s $x=0,$y=$y+1 s:$y>255 $y=255
 q
NP(%1) ; Next page (advance %1 pages of terminal display memory)
 w $c(27,91)_+$g(%1,1)_"U"
 q
OSC ; Operating system command
 w $c(27)_"]"
 q
PLD ; Partial line down
 w $c(27)_"K"
 q
PLU ; Partial line up
 w $c(27)_"L"
 q
PM ; Privacy message
 w $c(27)_"^"
 q
PP(%1) ; Preceding page (backup %1 pages of terminal display memory)
 w $c(27,91)_+$g(%1,1)_"V"
 q
PU1 ; Private use one
 w $c(27)_"Q"
 q
PU2 ; Private use two
 w $c(27)_"R"
 q
QUAD ; QUAD
 q
REP ; Repeat
 w $c(27,91)_"b"
 q
RI ; Reverse index
 w $c(27)_"M" s $y=$y-1 s:$y<0 $y=0
 q
RIS ; Reset to initial state
 w $c(27)_"c" s $x=0,$y=0
 q
RM(%1,%2,%3,%4,%5,%6,%7,%8,%9) ; Reset mode
 n %i,%p s %p=""
 f %i=1:1:9 i $d(@("%"_%i)) s %p=%p_$e(";",%p'="")_@("%"_%i)
 w $c(27,91)_%p_"l"
 q
SEM ; Select editing extent mode
 w $c(27,91)_"Q"
 q
SGR(%1,%2,%3,%4,%5,%6,%7,%8,%9)  ; Select graphic rendition %1 thru %9
 n %i,%p s %p=""
 f %i=1:1:9 i $d(@("%"_%i)) s %p=%p_$e(";",%p'="")_@("%"_%i)
 w $c(27,91)_%p_"m"
 q
SL ; Scroll left
 q
SM(%1,%2,%3,%4,%5,%6,%7,%8,%9) ; Set mode
 n %i,%p s %p=""
 f %i=1:1:9 i $d(@("%"_%i)) s %p=%p_$e(";",%p'="")_@("%"_%i)
 w $c(27,91)_%p_"h"
 q
SPA ; Start of protected area
 w $c(27)_"V"
 q
SPI ; Spacing increment
 q
SR ; Scroll right
 q
SS2 ; Single shift two
 w $c(27)_"N"
 q
SS3 ; Single shift three
 w $c(27)_"O"
 q
SSA ; Start of selected area
 w $c(27)_"F"
 q
ST ; String terminator
 w $c(27)_"\"
 q
STS ; Set transmit state
 w $c(27)_"S"
 q
SU ; Scroll up
 w $c(27,91)_"S"
 q
TBC ; Tabulation clear
 w $c(27,91)_"g"
 q
TSS ; Thin space specification
 q
VPA(%1) ; Vertical position attribute (move to row %1 at same column)
 s %1=+$g(%1,1) w $c(27,91)_%1_"d" s $y=%1-1,$y=$s($y<0:0,$y>255:255,1:$y)
 q
VPR(%1) ; Vertical position relative (move down %1 lines at same column)
 s %1=+$g(%1,1) w $c(27,91)_%1_"e" s $y=$y+%1 s:$y>255 $y=255
 q
VTS ; Vertical tabulation sets
 w $c(27)_"J"
 q
 ;
]]></Routine>


<Routine name="%ZAPM.bs.BS7238" type="MAC" languagemode="0"><![CDATA[
%BS7238 ;СПЕЦИАЛЬНЫЕ NAMESPACE к ТЕРМИНАЛАМ и /l /p /x ; 17:43 27-FEB-99
SETCLR N n F n=1,2,9 S $P(%BS,"!",n)=7
 F n=3,4,10 S $P(%BS,"!",n)=1
 F n=5:1:8,11 S $P(%BS,"!",n)=0
 Q
PCPC N n I R1'=27 R *R2:0,*R3:0 Q
 I R1'=0 R *R2:0,*R3:0 Q
 F n=1:1:99 R *R2:0 Q:R2'=-1
 F n=1:1:99 R *R3:0 Q:R3'=-1
 Q
PCT N n I R1'=27 R *R2:0,*R3:0 Q
 F n=1:1:99 R *R2:0 Q:R2'=-1
 F n=1:1:99 R *R3:0 Q:R3'=-1
 Q
RT N R4,n,kO I R1'=27 R *R2:0,*R3:0 Q
 F n=1:1:99 R *R2:0 Q:R2'=-1
 F n=1:1:99 R *R3:0 Q:R3'=-1
 I R3>48&(R3<55) D
 .F n=1:1:99 R *R4:0 Q:R4'=-1
 .Q:R4=126
 .F n=1:1:99 R *R5:0 Q:R5'=-1
 .S R3=R3_R4 Q
 S kO=$P(%BS(11),"!",$L($P(%BS(10),(R1_","_R2_","_R3_"!")),"!")) I kO["," S R1=$P(kO,","),R2=$P(kO,",",2),R3=$P(kO,",",3)
 Q
%BPD N o,kO S R2=-1 F o=1:1:30 R *R3:0 Q:R3'=-1
 S kO=$P(%BS(11),"!",$L($P(%BS(10),(R1_","_R2_","_R3_"!")),"!")) I kO["," S R1=$P(kO,","),R2=$P(kO,",",2),R3=$P(kO,",",3)
 Q
%BCM7209 N o,kO S R2=-1 F o=1:1:30 R *R3:0 Q:R3'=-1
 S kO=$P(%BS(11),"!",$L($P(%BS(10),(R1_","_R2_","_R3_"!")),"!")) I kO["," S R1=$P(kO,","),R2=$P(kO,",",2),R3=$P(kO,",",3)
 Q
 ;W /x
CMD1 S $ZT="ERCMD^%ZAPM.bs.BS7238" N N
 F  D  Q:cmd="."!(cmd="ESC")!(YES=0)  G:cmd="DOS"!(cmd="dos") ^%SSD G:cmd="ALLWAY" ALLWAY D:cmd="WAYKILL" WAYKILL W $$atr^%ZAPM.bs.BS3(0),/CUP(1,1),/ED(2) X cmd
 .S %BSenter=1 W !!,/CUP(24,1),"<<<ЛОВУШКА>>> (",$G(x),") ",$$ZU^%ZAPM.bs.BS3(0),">" S cmd=$$Edit^%ZAPM.bs.BSXuse("",25,1,25,70,"","","^%ZAPM.bs.BSHLP(TRAP")
 .I cmd'="" D
 ..I cmd?.N S cmd=$G(%BS("Tmp","cmd",cmd)) Q
 ..S N=$O(%BS("Tmp","cmd",""),-1)+1,%BS("Tmp","cmd",N)=cmd
 .I cmd="LI"!(cmd="li") W /CUP(1,1),/ED(2) D
 ..F N=1:1 Q:'$D(%BS("Tmp","cmd",N))  W !,N,"=",%BS("Tmp","cmd",N)
 ..W $$r^%ZAPM.bs.BS3 S cmd=""
 .I cmd="/l"!(cmd="/L") W $$l^%ZAPM.bs.BS3,$$r^%ZAPM.bs.BS3 S cmd=""
 .I cmd="LT"!(cmd="lt") W /CUP(1,1),/ED(2) D LOCKTAB^%ZAPM.bs.BSF6 W $$r^%ZAPM.bs.BS3 S cmd=""
CMD2 S $ZT=$G(%zT) D CL^%ZAPM.bs.BSF4,RE^%ZAPM.bs.BSsBUF I $D(%ZREFERE),%ZREFERE'["""",$$Data^%ZAPM.bs.BSF12(%ZREFERE)
e Q
ALLWAY S %BS("Tmp","AllWay",$G(%BS(3),$P),x)="" G CMD2
WAYKILL K %BS("Tmp","AllWay",$G(%BS(3),$P)) S cmd="" Q
x(x) N %ZREFERE,cmd,%BSenter I x'="",$D(%BS("Tmp","AllWay",$G(%BS(3),$P),x)) Q
 S %zT=$ZT,%ZREFERE=$ZR D OP^%ZAPM.bs.BSF4,SA^%ZAPM.bs.BSsBUF W /ED(2),$$bel^%ZAPM.bs.BS3
ERCMD W /CUP(1,1),$$bel^%ZAPM.bs.BS3,!,$ZE,!!," - Возвpат  <Esc> или "".""",!," - Выход в MSM  ""H""",!," - Уйти в DOS  ""DOS""" W:x'="" !," - Игнорируем ",x," ловушку ""ALLWAY""" G CMD1
WRITE N %zz1,%zz0,%zz2,%zz3,%zz4,%zz5 ;ПОЭКРАННОЕ ЛИСТАНИЕ W /l
 W !,"------------- Локальные пеpеменные : ---------------"
 I $ZV["MSM" S %zz1=$O()
 I $ZV["Cach"||($ZV["IRIS") S %zz1="",%zz1=$O(@%zz1)
 S %zz0=0 F  Q:%zz1=""  D:%zz1'["%zz"  S %zz1=$O(@%zz1)
 .I "11"[$D(@%zz1) D W(%zz1)
 .I $D(@%zz1)>9 S %zz3=%zz1 F  S %zz3=$Q(@%zz3) Q:%zz3=""  D W(%zz3)
 W !,"-------- Конец списка локальных пеpеменных --------"
 Q
W(%z) S %zz5=$L(%z)+1,%zz4=79-%zz5 W !,%z,"=",$E(@%z,1,%zz4) S %zz4=%zz4+1
WW S %zz0=%zz0+1 I '(%zz0#22) W !,"--------- Press <Enter> >" R *%zz2,*%zz2:0,*%zz2:0
 Q:%zz4'<$L(@%z)  W $E(@%z,%zz4,%zz4+78) S %zz4=%zz4+79 G WW
PRINT ;ПОЭКРАННОЕ ЛИСТАНИЕ ПРОГРАММЫ W /p
 S %z0="S %z10=0 X %z1,%z3,%z2"
 S %z1="W !,""------------- Листинг пpогpаммы "",$ZN,"" ---------------"""
 S %z3="F %z3=1:1 Q:$T(+%z3)=""""  S %z4=$T(+%z3) X %z5"
 S %z2="W !,""------------- Конец листинга пpогpаммы -----------------"""
 S %z5="S %z6=$P(%z4,"" ""),%z4=%z6_$J("" "",9-$L(%z6))_$P(%z4,"" "",2,9999) X %z7"
 S %z7="S %z8=80,%z13=0 W !,$E(%z4,1,%z8-1) F  X %z9 Q:%z13"
 S %z9="S %z10=%z10+1 R:'(%z10#22) !,""--------- Press <Enter> >"",*%z11,*%z11:0,*%z11:0 X %z12"
 S %z12="S:%z8'<$L(%z4) %z13=1 I '%z13 W !,""........."",$E(%z4,%z8,%z8+69) S %z8=%z8+70" Q
 ;
]]></Routine>


<Routine name="%ZAPM.bs.BSA" type="MAC" languagemode="0"><![CDATA[
%BSA ;ПОЛНАЯ ССЫЛКА НА КЛЕТКУ ; 15:15   15.04.2003
 ;{i,j,"TAB","^PAR","UCI","SYS",k0,k1,...k9}
 ; 1 2   3      4     5     6    7  8 9 10...
A(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16) S pp=$P($G(BSR),"^",2),ps=$S(pp'[",":$P($$ZU^%ZAPM.bs.BS3(0),",",2),1:$P(pp,$C(34),4))
 S pu=$S(pp'["[":$P($$ZU^%ZAPM.bs.BS3(0),","),1:$P(pp,$C(34),2)),pt=$G(BST) I $E(pp,1)="[" S pp=$P(pp,"]",2)
 S %zT=$ZT,$ZT="TRAP^%ZAPM.bs.BSA"
 I $D(p4) S pp=p4 I pp["^" S pp=$P(pp,"^",2)
 I $G(p3)'="" S pt=p3
 I $G(p5)'="" S pu=$TR(p5,"[]|""","") I pu["," S ps=$P(pu,",",2),pu=$P(pu,",")
 I $G(p6)'="" S ps=$TR(p6,"[]|""","") I ps["," S pu=$P(ps,","),ps=$P(ps,",",2)
 ;I $E(pp,1)="%" S pp="^"_pp ;`BSA
 S pp="^["""_pu_""","""_ps_"""]"_pp
 I $D(@(pp_"(pt,p1,p2)"))
 S bS=$ZR I $P(@(pp_"(pt,p1,p2)"),"@",9)=1 Q $P($G(@$ZR),"@",15)
 I '$D(p8),BST=pt,$$BSR(BSR)=pp Q $G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),p1,p2))
 S pb=$$KBD^%ZAPM.bs.BSF12($NA(@pp@(pt))),pb=$$BSD(pb,$G(p7))
 I $ZV["Cach"||($ZV["IRIS") F pi=1:1:9  Q:'$D(@("p"_(pi+7)))  S pb=pb_$S(@("p"_(pi+7))=+@("p"_(pi+7)):@("p"_(pi+7)),1:$C(34)_@("p"_(pi+7))_$C(34))_","
 E  F pi=1:1:9  Q:'$D(@("p"_(pi+7)))  S pb=pb_$S(@("p"_(pi+7))=+@("p"_(pi+7)):@("p"_(pi+7)),1:$C(34)_@("p"_(pi+7))_$C(34))_","
 S pij=p1_","_p2 I $P($G(@pp@(pt,"KEY",pi-1)),"@",6)="HiddenLastKey",$P($P(@(pp_"(pt,p1,p2)"),"@",18),"#",2)'="" D  Q $G(@$ZR,"<NO_VALUE>")
 .S pij=$P($P(@$ZR,"@",18),"#",2) I $D(@(pb_$C(34)_pij_""")"))
 I $P($P(@(pp_"(pt,p1,p2)"),"@",18),"#")'="" S pij=$P($P(@$ZR,"@",18),"#")
 I $D(@(pb_$C(34)_pij_""")")) Q @$ZR
 Q "<NO_VAL>" ;_$ZR
BSD(BSD,%NAm) ;ССЫЛКА НА УЗЕЛ БАЗЫ ДАННЫХ
 S %NAm=BSD_$G(%NAm)_$S(BSD["(":"",1:"(") I $E(%NAm,$L(%NAm))=")" S %NAm=$E(%NAm,1,$L(%NAm)-1)_","
 Q %NAm
BSR(bsr) N bs,A ;ПОЛНАЯ ССЫЛКА
 I $E(bsr,1,2)="^%" Q $$%^%ZAPM.bs.BSF12(bsr)
 ;4.;I $P($ZV,"Version ",2)'<4,bsr'["|" Q "^|"""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""|"_$P(bsr,"^",2)
 ;4.;I $P($ZV,"Version ",2)'<4,$P(bsr,"|",2)'["," S bs=$P($P(bsr,"|",2),$C(34),2) Q "^|"""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""|"_$P(bsr,"|",2)
 /*I $ZV["Cach"||($ZV["IRIS") D  Q A
 .S A=bsr
 .I bsr'["]" S A="^["""_$$ZU^%ZAPM.bs.BS3(0)_""",""""]"_$P(bsr,"^",2)
 .I $P($P(bsr,"]"),"[",2)'["," S A="^["""_$$ZU^%ZAPM.bs.BS3(0)_""",""""]"_$P(bsr,"]",2)
 .*/
 I bsr'["]" Q "^["""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(bsr,"^",2)
 I $P($P(bsr,"]"),"[",2)'["," S bs=$P($P($P(bsr,"]"),"[",2),$C(34),2) Q "^["""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(bsr,"]",2)
 Q bsr
TRAP S $ZT=$G(%zT) Q $ZE_" "_$ZR
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSB" type="MAC" languagemode="0"><![CDATA[
%BSB ;ОРГАНИЗАЦИЯ БЛОЧНОГО МЕНЮ ; 21:25   07.03.99
 ;OOO=ИМЯ МАССИВА,OO=ИНДЕКС
 N O0,O1,O2,O3,O4,O5,O6,O7,O8,O9,O10,O11,O12,O13,ORU,%b,JB,OI,o,oo,o1,o3
 S Oy=$Y,Ox=$X I $D(MouseYes) S Mouse(1)=$G(Mouse),Mouse=2
 K %GO Q:'$D(OOO)!('$D(OO))  I '$D(OOOO) Q:'$D(@(OOO_"("_OO_",1)"))
 I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 S O3=@(OOO_"("_OO_$S($D(OOOO):")",1:",1)")),O1=1,O2=24,O0="("_OO,O4=$P(O3,"@",3) W /CUP(24,1) D O3
 D  K Dark S Mouse=$G(Mouse(1)) Q  ;O4=РАЗДЕЛИТЕЛЬ,O5=БЛОКИ--->O6=НОМЕР ВЫБРАННОГО БЛОКА
1 .K %JB,ORU S %JB=0,O0=OOO_"("_OO_$S($D(OOOO):"",1:",1"),ORU(1)=@(O0_")"),%JB(1)=$P(O0,OOO_"("_OO_",1,",2)
11 .S O3=ORU(1) D O3 D  W $$clr^%ZAPM.bs.BS3(8),$P(O3,"@") S O4=$P(O3,"@",3),O6=1,O5=$P(O3,"@") S:$D(%B) O6=%B+0 D USS S %B=O6,%b(1)=O6 I O3="^" D END Q
 ..Q:$P(O3,"@",4)=0  I O2'<0 S O6=$P(O3,"@",4),O4=$L($P(O3,"@"))-$L(O6)\2 W /CUP(O2-1,O1),$TR($J(0,O4)," 0","--")_O6_$TR($J(0,O4)," 0","--"),/CUP(O2,O1)
 ..I O2'>22 W /CUP(O2+1,O1),$TR($J(0,$L($P(O3,"@"))),"0 ","--"),/CUP(O2,O1)
 .I '$D(@(O0_","_O6_")")) D END Q
2 .S %B=1 W /CUP(O2,O1) D CLEA S O0=O0_","_O6,ORU(2)=@(O0_")"),%JB(2)=$P(O0,OOO_"("_OO_",1,",2)
22 .S O3=ORU(2) D O3 W $$clr^%ZAPM.bs.BS3(8),$P(O3,"@") D  S O4=$P(O3,"@",3),O5=$P(O3,"@"),O6=%B D USS S %B=O6,%b(2)=O6 I O3="^" S %B=%b(1) G 11
 ..Q:$P(O3,"@",4)=0  I O2'>22 W /CUP(O2+1,O1),$TR($J(0,$L($P(O3,"@"))),"0 ","--"),/CUP(O2,O1)
 .I '$D(@(O0_","_O6_")")) D END Q
3 .S %B=1 W /CUP(O2,O1) D CLEA S O0=O0_","_O6,ORU(3)=@(O0_")"),%JB(3)=$P(O0,OOO_"("_OO_",1,",2)
33 .S O3=ORU(3) D O3 W $$clr^%ZAPM.bs.BS3(8),$P(O3,"@") D  S O4=$P(O3,"@",3),O6=%B,O5=$P(O3,"@") D USS S %B=O6,%b(3)=O6 I O3="^" S %B=%b(2) G 22
 ..Q:$P(O3,"@",4)=0  I O2'>22 W /CUP(O2+1,O1),$TR($J(0,$L($P(O3,"@"))),"0 ","--"),/CUP(O2,O1)
 .I '$D(@(O0_","_O6_")")) D END Q
4 .S %B=1 W /CUP(O2,O1) D CLEA S O0=O0_","_O6,ORU(4)=@(O0_")"),%JB(4)=$P(O0,OOO_"("_OO_",1,",2)
44 .S O3=ORU(4) D O3 W $$clr^%ZAPM.bs.BS3(8),$P(O3,"@") D  S O4=$P(O3,"@",3),O6=%B,O5=$P(O3,"@") D USS S %B=O6,%b(4)=O6 I O3="^" S %B=%b(3) G 33
 ..Q:$P(O3,"@",4)=0  I O2'>22 W /CUP(O2+1,O1),$TR($J(0,$L($P(O3,"@"))),"0 ","--"),/CUP(O2,O1)
 .I '$D(@(O0_","_O6_")")) D END Q
5 .S %B=1 W /CUP(O2,O1) D CLEA S O0=O0_","_O6,ORU(5)=@(O0_")"),%JB(5)=$P(O0,OOO_"("_OO_",1,",2)
55 .S O3=ORU(5) D O3 W $$clr^%ZAPM.bs.BS3(8),$P(O3,"@") D  S O4=$P(O3,"@",3),O6=%B,O5=$P(O3,"@") D USS S %B=O6,%b(5)=O6 I O3="^" S %B=%b(4) G 44
 ..Q:$P(O3,"@",4)=0  I O2'>22 W /CUP(O2+1,O1),$TR($J(0,$L($P(O3,"@"))),"0 ","--"),/CUP(O2,O1)
 .I '$D(@(O0_","_O6_")")) D END Q
6 .S %B=1 W /CUP(O2,O1) D CLEA S O0=O0_","_O6,ORU(6)=@(O0_")"),%JB(6)=$P(O0,OOO_"("_OO_",1,",2)
66 .S O3=ORU(6) D O3 W $$clr^%ZAPM.bs.BS3(8),$P(O3,"@") D  S O4=$P(O3,"@",3),O6=%B,O5=$P(O3,"@") D USS S %B=O6,%b(6)=O6 I O3="^" S %B=%b(5) G 55
 ..Q:$P(O3,"@",4)=0  I O2'>22 W /CUP(O2+1,O1),$TR($J(0,$L($P(O3,"@"))),"0 ","--"),/CUP(O2,O1)
 .I '$D(@(O0_","_O6_")")) D END Q
e Q
O3 I $E($G(%BS(14)),2) S o3=$P($TR(O3,"йцукенгшщзхъэждлорpпавыфячсмитьбюё",""),"@")_"@"_$P(O3,"@",2,999)
 E  S o3=$P($TR(O3,"йцукенгшщзхъэждлоpрпавыфячсмитьбюё","ЙЦУКЕНГШЩЗХЪЭЖДЛОРРПАВЫФЯЧСМИТЬБЮЁ"),"@")
 I $D(@("Dark("_$P(O0,"(",2,999)_")"))'["0" S oo=("Dark("_$P(O0,"(",2,999)_")") D
 .F o=2:1 Q:$P(@oo,O4,o,999)=""  I $P(@oo,O4,o) S o1=$TR($P(o3,O4,o),"_",$C(254)),o1=$C(254)_$E(o1,2,$L(o1)-1)_$C(254),$P(o3,O4,o)=o1
 S O3=o3_"@"_$P(O3,"@",2,999) Q
CLEA W $$atr^%ZAPM.bs.BS3(0),/EL(0) Q
USS ;ВЫБОР БЛОКА O4=РАЗДЕЛИТЕЛЬ,O5=БЛОКИ--->O6=НОМЕР ВЫБРАННОГО БЛОКА
 D CL^%ZAPM.bs.BSF4 K %GO S %JB=%JB+1,O13="" S:$P(O5,O4,O6+1)="" O6=1 I $P(O3,"@",5)'="" S O13="W /CUP(O2+1,O1),$$atr^%ZAPM.bs.BS3(0),$G(@(OOO_""(""_$P(O3,""@"",5)_"","
R X:O13'="" O13_O6_")"")) W /EL(0)" S O7=$P(O5,O4,O6+1),O8=$F(O5,O7)-2,O9=O8-$L(O7)+O1 W /CUP(O2,O9),$$clr^%ZAPM.bs.BS3(9)," ",O7," ",$$clr^%ZAPM.bs.BS3(8),/CUP(O2,O9)
 S $Y=Oy,$X=Ox W $$rt^%ZAPM.bs.BS3(+%BS(2)) I R1=13!(R1=46) G SU
 I R1=27,R2=79,R3=80 G:$P($P(O3,"@",8),";",O6)="" R S IYI=$P(O3,"@",2)_","_$P($P(O3,"@",8),";",O6) D NE^%ZAPM.bs.BSN G R
 I R1=27,R2=79 G R
 I R1=27,R2=91!(R2=-1) D  G SU:O8="S",SUEN:O3="^",R
 .I R3=65!(R3<0) S O3="^" K ORU(%JB),%JB(%JB) W /CUP(O2,O1),$$atr^%ZAPM.bs.BS3(0),/EL(0) S O0=$P(O0,",",1,$L(O0,",")-1),%JB=%JB-2 Q  ;Л
 .I R3=66 S O8="S" Q  ;V
 .I R3=67 D SS S O6=O6+1 D  Q  ;-->
 ..I $P(O5,O4,O6+1)="" S O6=1 Q
 .I R3=68 D SS S O6=O6-1 D  Q  ;<--
 ..I $P(O5,O4,O6+1)="" S O6=$L(O5,O4)-2 Q
 I R1=27 G R
 I R1=0,R2=113,$E(%BS(1),3) D CM^%ZAPM.bs.BSF6 G R
 I R1=0,R2=33 G SUEN ;АТАВИЗМ !!! D AF^%ZAPM.bs.BSF6 G R ;!!!!
 I R1=0,(R2=139!(R2=140)!(R2=84)!(R2=88)) D AltKey^%ZAPM.bs.BSF8 G R
 I R1=0 G R
 G R ;!!!I R1<96 G SU
 D SS S O10=$C(R1),O11=O6 K O12
 F O6=1:1 S O7=$P(O5,O4,O6+1) Q:O7=""  I O7[O10 F OI=1:1:$L(O7) I $E(O7,OI)'=" " Q:$E(O7,OI)'=O10  S O12=O6 G RR
RR I $D(O12) S O6=O12 G SU
 S O6=O11 G R
SS ;СТИРАНИЕ ТЕКУЩЕГО БЛОКА
 S O7=$P(O5,O4,O6+1),O8=$F(O5,O7)-2,O9=O8-$L(O7)+O1 W /CUP(O2,O9),O4,O7,O4 Q
END K %b,OI,ORU,O0,O1,O2,O3,O4,O5,O6,O7,O8,O9,O10,O11,O12,O13 Q
SU ;ОКОНЧАНИЕ ВЫБОРА БЛОКА
 I $D(@("Dark("_$P(O0,"(",2,999)_")"))'["0",$P(@("Dark("_$P(O0,"(",2,999)_")"),O4,O6+1) W $$bel^%ZAPM.bs.BS3 G R
 I $P($P(O3,"@",6),";",O6)'="" X $P($P(O3,"@",6),";",O6) W /CUP(O2,O1),$$atr^%ZAPM.bs.BS3(0),/EL(0),$$clr^%ZAPM.bs.BS3(8),$P(O3,"@") G R
 I $P($P(O3,"@",7),";",O6)'="" S %GO=$P($P(O3,"@",7),";",O6)
SUEN W $$atr^%ZAPM.bs.BS3(0),/CUP(24,1),/EL(0)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSBD" type="MAC" languagemode="0"><![CDATA[
%BSBD ;СОХРАНЕНИЕ / ВОССТАНОВЛЕНИЕ УЗЛОВ БАЗ ДАННЫХ ; 10:13   06.11.2001
COPYD ;ДАТАМ
 S l1=$$h^%ZAPM.bs.BS3() D D1 Q:'$D(da)  D SAVE Q
COPYH ;ГОРЯЧИЕ
 D DATE S hot=1 D SAVE Q
COPYU ;ПОЛЬЗОВАТЕЛЬ
 D DATE,POL Q:'$D(pol)  D SAVE Q
ALL D SAVE Q  ;ВСЮ
POL S ls=" ВВЕДИТЕ ИМЯ ПОЛЬЗОВАТЕЛЯ ",li="" D LE^%ZAPM.bs.BSTT I 'YES Q
 S pol=li Q
DATE S ls=" Будем опpеделять диапазон дат ? " D YES^%ZAPM.bs.BSF I 'YES Q
 S l1=$$h^%ZAPM.bs.BS3() K da
D1 S ls=" ОТ КАКОЙ ДАТЫ",li=$$ESDAY^%ZAPM.bs.BSsFUNR(6,l1) D LE^%ZAPM.bs.BSTT Q:'YES  S da(1)=$$DAT^%ZAPM.bs.BSsFUNR(6,li) I 'YES S ls=" ОШИБКА ДАТЫ " D WAITS^%ZAPM.bs.BSF2 G D1
 S (l1,da(1))=$$DATHR^%ZAPM.bs.BSsFUNR(6,da(1))
D2 S ls=" ДО КАКОЙ ДАТЫ",li=$$ESDAY^%ZAPM.bs.BSsFUNR(6,l1) D LE^%ZAPM.bs.BSTT G:'YES D1 S da(2)=$$DAT^%ZAPM.bs.BSsFUNR(6,li) I 'YES S ls=" ОШИБКА ДАТЫ " D WAITS^%ZAPM.bs.BSF2 G D2
 S da(2)=$$DATHR^%ZAPM.bs.BSsFUNR(6,da(2)) Q
D I $G(EndINDi)=1 Q
 G D^%ZAPM.bs.BS
CopyTree() N %NAm,%iii,ii,i,OT,KU,U
 I $$ErrUz Q 0
 S %iii=d
 N d,dat,date,WA,BSR,BST,Qu,i,%0
 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSVOL(CopyTree)",2,2,"§","CopyTrP^%ZAPM.bs.BSBD") I R1=27 Q 0
 S j=0 F ii=1:2:15 S OT(j)=$P(i,"§",ii),KU(j)=$P(i,"§",ii+1),j=j+1 I $P(i,"§",ii+2)="" S U=j-1 Q
 F j=1:1:U I $G(OT(j))="" S i="ИСТОЧНИКА" Q
 F j=1:1:U I $G(KU(j))="" S i="ПОЛУЧАТЕЛЯ" Q
 I i'["§" D ErrMsg^%ZAPM.bs.BSXfun("У "_i_" введены ПУСТЫЕ КЛЮЧИ !") Q 0
 S OT=$$SSYL(U,.OT),KU=$$SSYL(U,.KU)
 I $L(OT,",")'=$L(KU,",") D ErrMsg^%ZAPM.bs.BSXfun("Количество уровней ИСТОЧНИКА и ПОЛУЧАТЕЛЯ не совпадает !") Q 0
 I '$$Data^%ZAPM.bs.BSF12(OT) D ErrMsg^%ZAPM.bs.BSXfun("В УЗЛЕ ИСТОЧНИКА данных НЕТ ! "_OT) Q 0
 I OT=KU D ErrMsg^%ZAPM.bs.BSXfun("ИСТОЧНИК и ПОЛУЧАТЕЛЬ совпадает !") Q 0
 I $$Data^%ZAPM.bs.BSF12(KU) D Yes^%ZAPM.bs.BSXfun("В УЗЛЕ ПОЛУЧАТЕЛЯ уже имеются данные ! Смешиваем ?") I YES<1 Q 0
 D Yes^%ZAPM.bs.BSXfun("Копируем "_OT_" в "_KU_" Вы УВЕРЕНЫ ?") I YES<1 Q 0
 I $D(@$QS(KU,0))["0",$D(@$QS(OT,0))'["0" S @$QS(KU,0)=@$QS(OT,0)
 D Copy^%ZAPM.bs.BSF8(OT,KU,1,1)
 Q 1
SSYL(key,%KEYS) N %NAm,ii S %NAm=BSD_$G(%KEYS(0))
 F ii=1:1:key Q:'$D(%KEYS(ii))  S %NAm=$NA(@%NAm@(%KEYS(ii)))
 Q %NAm
CopyTrP ;ПРЕДОБРАБОТКА ТАБЛИЦЫ
 N m,i,ii
 S $P(@BSR@(BST,2,2),"@",15)=$G(%KEYS(0)) I key=0 S $P(@BSR@(BST,2,2),"@",15)=%iii
 S $P(@BSR@(BST,2,4),"@",15)=$G(%KEYS(0)) I key=0 S $P(@BSR@(BST,2,4),"@",15)=%iii
 S i=2 F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S i=i+2 F m=2,4 S $P(@BSR@(BST,i,m),"@",15)=$G(%KEYS(ii))
 I key'=0 S i=i+2,$P(@BSR@(BST,i,2),"@",15)=%iii
 Q
 ;ЗАКАЧКА В ТОБД ИНДЕКСЫ 1 УРОВНЯ БАЗЫ DDR
ZAKDDR S BDDR=$$KBD^%ZAPM.bs.BSF12($$DDRTOBD) I '$$Data^%ZAPM.bs.BSF12(BDDR) S ls="НЕДОСТУПНА БД DDR="_BDDR Q
 S I="" F  S I=$O(@BDDR@(I)) Q:I=""  S BD=$G(@BDDR@(I,"^","S")) F II=1:1 Q:$P(BD,"#",II,II+1)=""  S BDD=$P(BD,"#",II) I $$Data^%ZAPM.bs.BSF12(BDD) D
 .I '$D(@BDD@("DDR")) W !,BDD S @BDD@("DDR")=I
 Q
DDRTOBD() N A S A="" I $ZU(5)="FON" S A="2005" //БД ОПИСАНИЯ ФОРМ ВВОДА
 Q $NA(^%ZAPM.bs.BSMDDR("DDR"_A))
SINDDR(d) N BDDR ;СИНТАКСИЧЕСКИЙ КОНТРОЛЬ ДЛЯ КЛЕТКИ {12,7} ТОК
 S BDDR=$$KBD^%ZAPM.bs.BSF12($$DDRTOBD^%ZAPM.bs.BSBD) 
 I '$$Data^%ZAPM.bs.BSF12(BDDR) S ls="НЕДОСТУПНА БД DDR="_BDDR X "I 0" Q 0
 I '$D(@BDDR@(d)) S ls="НА 1 УРОВНЕ БД DDR НЕТ КЛЮЧА="_d X "I 0" Q 0
 Q 1
PFL1(d) ;ПФЛ
 N ST I key=0 S A6=A1_d
 E  S A6=$NA(@A1@(d))
 I $QL(A6)=A5 D PFL3(A6) Q
 S U1="" F  S U1=$O(@A6@(U1)) Q:U1=""  D
 .I $QL($NA(@A6@(U1)))=A5 D PFL3($NA(@A6@(U1))) Q
 .S U2="" F  S U2=$O(@A6@(U1,U2)) Q:U2=""  D
 ..I $QL($NA(@A6@(U1,U2)))=A5 D PFL3($NA(@A6@(U1,U2))) Q
 ..S U3="" F  S U3=$O(@A6@(U1,U2,U3)) Q:U3=""  D
 ...I $QL($NA(@A6@(U1,U2,U3)))=A5 D PFL3($NA(@A6@(U1,U2,U3))) Q
 ...S U4="" F  S U4=$O(@A6@(U1,U2,U3,U4)) Q:U4=""  D
 ....I $QL($NA(@A6@(U1,U2,U3,U4)))=A5 D PFL3($NA(@A6@(U1,U2,U3,U4))) Q
 ....S U5="" F  S U5=$O(@A6@(U1,U2,U3,U4,U5)) Q:U5=""  D
 .....I $QL($NA(@A6@(U1,U2,U3,U4,U5)))=A5 D PFL3($NA(@A6@(U1,U2,U3,U4,U5))) Q
 .....S U6="" F  S U6=$O(@A6@(U1,U2,U3,U4,U5,U6)) Q:U6=""  D
 ......I $QL($NA(@A6@(U1,U2,U3,U4,U5,U6)))=A5 D PFL3($NA(@A6@(U1,U2,U3,U4,U5,U6))) Q
 ......S U7="" F  S U7=$O(@A6@(U1,U2,U3,U4,U5,U6,U7)) Q:U7=""  D
 .......I $QL($NA(@A6@(U1,U2,U3,U4,U5,U6,U7)))=A5 D PFL3($NA(@A6@(U1,U2,U3,U4,U5,U6,U7))) Q
 .......S U8="" F  S U8=$O(@A6@(U1,U2,U3,U4,U5,U6,U7,U8)) Q:U8=""  D
 ........I $QL($NA(@A6@(U1,U2,U3,U4,U5,U6,U7,U8)))=A5 D PFL3($NA(@A6@(U1,U2,U3,U4,U5,U6,U7,U8))) Q
 ........S U9="" F  S U9=$O(@A6@(U1,U2,U3,U4,U5,U6,U7,U8,U9)) Q:U9=""  D
 .........D PFL3($NA(@A6@(U1,U2,U3,U4,U5,U6,U7,U8,U9))) Q
 Q
PFL3(S) ;ПФЛ
 N ST,STT
 D ST("{") S STT="NODE_DDR="_A2
 I $D(%KEYS(0)) S STT=STT_" KEY0="_%KEYS(0)
 I key=0 S STT=STT_" KEY0="_d
 F U=1:1:$QL(S) S STT=STT_" KEY"_U_"="_$QS(S,U)
 D ST(STT)
 D LOOP(S),ST("}") I '$$KOR U 0 Q
 U %DEV S ST="" F  S ST=$O(ST(ST)) Q:ST=""  U %DEV W ST(ST),!
 S DOKS=DOKS+1 U 0 X WA Q
LOOP(U) N PO,Y,X,X1 ;ЦИКЛ ПО УРОВНЮ ДАННЫХ
 I YXX1 D  Q
 .S Y=$P(YXX1,","),Y1=0
 .F X=$P(YXX1,",",2):2:$P(YXX1,",",3) S Y1=Y1+1 I $G(@U@(Y_","_X))'="" D ST($$0(Y1)_"="_@U@(Y_","_X))
 S PO="" F  S PO=$O(@U@(PO)) Q:PO=""  D ST(PO_"="_@U@(PO))
 Q
KOR() ;ПРИЗНАК ВТОРИЧНСТИ ДОКУМЕНТА
 I $G(KOR)="" Q 1
 N KOR1
 I $G(KOR)'="" D  I $D(KOR1) Q 1
 .S ST="" F  S ST=$O(ST(ST)) Q:ST=""  X KOR I  S KOR1=1 Q
 Q 0
0(I) Q $S(I?1N:"00",I?2N:"0",1:"")_I
ST(S) S ST=$G(ST)+1,ST(ST)=S
 Q
PFL() ;ВЫВОД В ФОРМАТЕ ПЕРФОЛЕНТЫ
 I $$ErrUz Q 0
 N A1,A2,A3,A4,A5,i,j,%DEV,%FN,A6
 N U1,U2,U3,U4,U5,U6,U7,U8,U9,U,YXX1,DOKS,STOP,KOR,pO,cHOSe
 S A3=d N d
 S A2=$G(@Bsr@(Bst,"DDR")) I A2="" D ErrMsg^%ZAPM.bs.BSXfun("В ТАБЛИЦЕ ОПИСАНИЯ КЛЮЧЕЙ НЕТ ССЫЛКИ НА БАЗУ ДАННЫХ DDR !") Q 0
 S A1=$$SSYL(key-1,.%KEYS)
 S A4=$$KBD^%ZAPM.bs.BSF12($$DDRTOBD),A4=$NA(@A4@(A2)) I '$$Data^%ZAPM.bs.BSF12(A4) D ErrMsg^%ZAPM.bs.BSXfun("НЕ ДОСТУПЕН УКАЗАТЕЛЬ НА ССЫЛКУ БАЗУ ДАННЫХ DDR="_A4) Q 0
 S A5=$O(@Bsr@(Bst,"KEY",""),-1),YXX1=$G(@A4@("^","YXX1")),DOKS=0,KOR=$G(@A4@("^","W"))
 D DOSOPN^%ZAPM.bs.BSBL1 Q:'$D(%FN) 0 U %DEV W ";%BS-FORMAT. "_$S($ZV["Cach"||($ZV["IRIS"):"Windows Text (Cirillic, 1251)",1:"MS-DOS Text (Cirillic, 866)"),!
 S pO="IF ST(ST)["""_KOR_"=1""" I $G(^%ZAPM.bs.BSbufB("HISTPFLF5",1))'="" S pO=^%ZAPM.bs.BSbufB("HISTPFLF5",1)
 U 0 I KOR'="" S KOR=$$LineEdit^%ZAPM.bs.BSXfun(pO,"ВВЕДИТЕ ДОПОЛНИТЕЛЬНОЕ УСЛОВИЕ ВЫВОДА ДОКУМЕТОВ (F1-ПОМОЩЬ)","","","^%ZAPM.bs.BSHLP,PFLF5","^%ZAPM.bs.BSbufB(""HISTPFLF5"")") I YES<1 S KOR=""
 D Wait^%ZAPM.bs.BSXfun("ВЫВОД В ФОРМАТЕ ПЕРФОЛЕНТЫ")
 D
 .I $D(%DIA) S do="I i>2 S A3=$P(^(j),""@"",15) I A3'="""" D PFL1^%ZAPM.bs.BSBD(A3)" D BLOK^%ZAPM.bs.BSF1 Q
 .D PFL1(A3)
 U %DEV W !,$$KOLDOK
 C %DEV U 0
 D OkMsg^%ZAPM.bs.BSXfun($$KOLDOK)
 Q 0
KOLDOK() I $G(DOKS) Q ";ВЫВЕДЕНО "_$G(DOKS)_" ДОКУМЕНТ(А,ОВ) !"
 Q ";НЕ ВЫВЕДЕНО НИ ОДНОГО ДОКУМЕНТА !"
ErrUz() I '(key>0&(ny<4)) Q 0
 I '(key=0&(ny<3)) Q 0
 D ErrMsg^%ZAPM.bs.BSXfun("УКАЗАТЕЛЬ НАХОДИСЯ НЕ НА УЗЛЕ БАЗЫ ДАННЫХ !")
 Q 1
ToBu(U) S A5=$G(A5)+1 D Copy^%ZAPM.bs.BSF8($NA(@A1@(U)),$NA(@A2@(U)),1,1) Q
ToBuff() ;копи в буфер
 I $$ErrUz Q 0
 N A1,A2,A3,A4,A5 S A4=d N d
 S A1=$$SSYL(key-1,.%KEYS),A2="^%ZAPM.bs.BSbufB(""NodeBaseToBu1"")" K @A2 D
 .I $D(%DIA) S do="I i>2 S A3=$P(^(j),""@"",15) I A3'="""" D ToBu^%ZAPM.bs.BSBD(A3)" D BLOK^%ZAPM.bs.BSF1 Q
 .D ToBu(A4)
 S ^%ZAPM.bs.BSbufB("NodeBaseToBu2")=A1
 D OkMsg^%ZAPM.bs.BSXfun("В БУФЕР СКОПИРОВАЛИ "_A5_" УЗЕЛ(ОВ,А)") Q 0
BuffTo() ;буфер в базу
 N A1,A2,A3,A4,A5 S A4=d N d
 S A1=$$SSYL(key-1,.%KEYS),A2="^%ZAPM.bs.BSbufB(""NodeBaseToBu1"")",A3=$G(^%ZAPM.bs.BSbufB("NodeBaseToBu2"))
 I A3="" D ErrMsg^%ZAPM.bs.BSXfun("БУФЕР ПУСТОЙ !") Q 0
 I $P(A3,"(")'=$P(A1,"(") D Yes^%ZAPM.bs.BSXfun("БАЗЫ ДАННЫХ РАЗНЫЕ ! "_A1_" и "_A3_" ВЫ УВЕРЕНЫ ?") I YES<1 Q 0
 S A5=$$LineEdit^%ZAPM.bs.BSXfun(A1,"КОПИРУЕМ ИЗ "_A3_" В ...")
 I $QL(A5)'=$QL(A3) D ErrMsg^%ZAPM.bs.BSXfun("КОЛИЧЕСТВО УРОВНЕЙ НЕ СОВПАДАЕТ ! "_A5_" и "_A2) Q 0
 I $$Data^%ZAPM.bs.BSF12(A5) D Yes^%ZAPM.bs.BSXfun("УЗЕЛ БАЗЫ ДАННЫХ УЖЕ СУЩЕСТВУЕТ ! "_A5_". СМЕШИВАЕМ, ВЫ УВЕРЕНЫ ?") I YES<1 Q 0
 I $D(@$QS(A5,0))["0" S @$QS(A5,0)=@$QS(A3,0)
 D Copy^%ZAPM.bs.BSF8(A2,A5,1,1)
 Q 1
SAVE D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) K %DEV Q  ;СОХРАНЕНИЕ УЗЛОВ БАЗЫ ДАННЫХ
 S %NAm=BSD_$G(%KEYS(0))
 I key=0 S %NAm=BSD_%iii
 S po=endkey I $D(@%NAm)
 S ls="СОХРАНЕНИЕ..."_BSD_" "_$S($D(da):"ПО ДАТАМ ",1:"")_$S($D(hot):"ГОРЯЧЕЕ ",1:"")_$S($D(pol):"ПОЛЬЗОВАТЕЛЬ "_pol,1:"") D WAITS^%ZAPM.bs.BSF2 S c=$ZR
 F  S c=$ZO(@c) Q:c=""  D  U 0 Q:c=""
SA .Q:$P(c,",",po)'[")"  S mE=@c,YES=1 D  Q:'YES  S:$D(hot) $P(@c,",",4)="" S cc=c,ccc=$P(cc,")") D NEW U %DEV W c,!,@c,! F  S cc=$ZO(@cc) Q:cc=""!(cc'[ccc)  U %DEV W:$G(@cc)'="" cc,!,$G(@cc),! U 0 X WA
 ..I $D(da) S md=+$TR($P(mE,",",1,2),",",".") I '(da(1)'>md&(da(2)'<md)) S YES=0 Q  ;Y2000
 ..I $D(hot) I '$P(mE,",",4) S YES=0 Q
 ..I $D(pol) I $P(mE,",",3)'=pol S YES=0 Q
 .S c=$G(cc) Q:c=""  G SA
 K c1,%3,%1,%2,c,cc,ccc,mE,po
SAVEND Q:'$D(%NEWRITE)  U %DEV W "*",!,"*",!,"**",!,"**",! Q
NEW Q:$D(%NEWRITE)  S %NEWRITE=1,%0=$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3()) U %DEV W %0,!,";BASE@"_$P(c,"(")_"@"_@BSD_"@"_po,! Q
COPY S OO=33,OOO="^%ZAPM.bs.BS" K %JB D  D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF K Dark G:R1=27 D
 .K Dark I $G(%BS("Tmp","AKBD",BSD),"RWD")'="RWD" S Dark(33,1)=" 1 1 1 1 1 0"
 I '$D(%JB(2)),%B=6 S Tmp=$$PFL() S $ZT=$G(%zT) G D:'$G(Tmp) S R1=27 Q
 I '$D(%JB(2)),%B=5 S Tmp=$$BuffTo() S $ZT=$G(%zT) G D:'$G(Tmp) S R1=27 Q
 I '$D(%JB(2)),%B=4 S Tmp=$$ToBuff() S $ZT=$G(%zT) G D:'$G(Tmp) S R1=27 Q
 I '$D(%JB(2)),%B=3 S Tmp=$$CopyTree() S $ZT=$G(%zT) G D:'$G(Tmp) S R1=27 Q
 I '$D(%JB(2)),%B=2 D REST S $ZT=$G(%zT) G D:'$D(%FN) K %FN,%DEV S R1=27 Q
 K %FN,DEV S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSS1" D  S $ZT=$G(%zT),%DIAP="" K mE,md,hot,pol,da,PR1 G:'$D(%FN) D C %DEV K %DEV,%FN,%NEWRITE G 71^%ZAPM.bs.BSF5
 .S PR1="?:\???.%BD" I %B=1 D  Q
 ..I $D(%DIA) S do="I i>2 S %iii=$P(^(j),""@"",15) D COP^%ZAPM.bs.BSBD" D BLOK^%ZAPM.bs.BSF1,COPE Q
 ..S %iii=d D COP,COPE Q
 .K pol,hot I %B=2 D COPYD Q
 .I %B=3 D COPYH Q
 .I %B=4 D COPYU Q
 .I %B=5 D ALL Q
COP D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) K %DEV Q  ;СОХРАНЕНИЕ
 S po=endkey,%NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 I key=0 S %NAm=BSD_%iii G CO
 S %NAm=%NAm_$S(%iii=+%iii:%iii,1:$C(34)_%iii_$C(34))_")"
CO I $D(@%NAm)
 S ls="СОХРАНЕНИЕ..."_%NAm D WAITS^%ZAPM.bs.BSF2 S c=$ZR,cc=$P($ZR,")") I '$D(%NEWRITE) S %NEWRITE=1,%0=$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3()) U %DEV W %0,!,";BASE@"_$P(c,"(")_"@"_$G(@BSD)_"@"_po,!
 D  F  S c=$ZO(@c) Q:c=""!(c'[cc)  D  U 0 X WA
 .U %DEV W:$G(@c)'="" c,!,$G(@c),!
 K c1,%3,%1,%2,c,cc Q
COPE Q:'$D(%NEWRITE)  U %DEV W "*",!,"*",!,"**",!,"**",! Q
REST D DOSREAD^%ZAPM.bs.BSS1 I '$D(%FN) K %DEV Q  ;ВОССТАНОВЛЕНИЕ УЗЛОВ БАЗЫ ДАННЫХ
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSS1"
 U %DEV R %CO F  U %DEV R %IN U 0 G:$ZC'=0 CLO^%ZAPM.bs.BSS1 D RES G:$ZC'=0!(%IN="**")!($ZE["<ENDOFFILE") CLO^%ZAPM.bs.BSS1
 S $ZT=$G(%zT),ls=" В Файле "_%FN_" Баз Данных не найдено " D O^%ZAPM.bs.BSF7 G CLO^%ZAPM.bs.BSS1
RES I $E(%IN,1,6)[";BASE" U 0 S ls=" Восстановим:"_$P(%IN,"@",2)_" " D YES^%ZAPM.bs.BSF I YES G I
e Q
I S li=$P(%IN,"@",2),ll="@",ls="Корректируйте имя Восстанавливаемой Базы Данных. <Esc>-Отмена" S:li["]" li="^"_$P(li,"]",2) S li=$$BSR^%ZAPM.bs.BSA(li) D LE^%ZAPM.bs.BSTT Q:'YES
 Q:li=""  S:li'["^" li="^"_li S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSS1"
 I $D(@(li)) S ls=" База Данных "_li_" Уже существует ! Пишем свеpху ? " D YES^%ZAPM.bs.BSF G I:'YES S %NAM=BSR,%TAB=BST D PASE^%ZAPM.bs.BS1 I '$D(%w(4)) G I
 ; !!! S %NAM=%NA ПРОВЕРКА НА СУЩЕСТВОВАНИЕ !!!!! РАЗНЫЕ ИМЕННЫЕ КЛЮЧИ !!!!!! ДОДЕЛАТЬ
 S $ZT=$G(%zT),BSd=li,ls="ВОССТАНОВЛЕНИЕ..."_BSd D WAITS^%ZAPM.bs.BSF2 F  U %DEV R %IN,%VA U 0 Q:$ZC'=0!(%IN="")!(%IN="**")  X WA I %IN'="*" S @(BSd_$S(%IN["(":"(",1:"")_$P(%IN,"(",2,999))=%VA
 Q:$ZC'=0  Q
FIND ;ПОИСК КЛЮЧЕЙ НАХОДЯСЬ В КЛЮЧАХ
 K da,hot,mE,po,pol,lk,END
 G D:key=0,B1:key'=endkey S m=" КЛЮЧЕЙ ПО_ДАТЕ_МОДИФИКАЦИИ ПО_ПОЛЬЗОВАТЕЛЮ ГОРЯЧИХ_DDR ЛЮБЫХ_ГОРЯЧИХ " D MENU^%ZAPM.bs.BSF5(m," ОПРЕДЕЛИТЕ РЕЖИМ ПОИСКА ") I R1=27 G D
 G @("B"_%B)
B1 S ls=" ВВЕДИТЕ ЗНАЧЕНИЕ КЛЮЧА,КОТОРЫЙ БУДЕМ ИСКАТЬ ",li="" D LE^%ZAPM.bs.BSTT I 'YES G D
 I li["@" D FINDKEY^%ZAPM.bs.BSIND(li,ny,nx,BSR,BST) G:$G(END)=2 NEWKEY,D ;ИНДЕКСИРОВАННЫЕ КЛЮЧИ
 S lk=li G FIN
B2 S l1=$$h^%ZAPM.bs.BS3() D D1 G D:'$D(da),FIN
B3 D DATE,POL G D:'$D(pol),FIN
B4 D DATE S hot=2 G FIN
B5 D DATE S hot=1 G FIN
FIN S %NAm=BSD_$G(%KEYS(0))
 S po=endkey I $D(@%NAm)
 S c=$ZR D SAY I $D(lk) D FIND^%ZAPM.bs.BS2(c,lk,key,"S c=$ZR D NAS^%ZAPM.bs.BSBD") G FINAL
 F  S c=$ZO(@c) Q:c=""!($D(END))  D  U 0 Q:c=""!($D(END))  X WA
 .;~~I $D(lk),("@"_$P($P($P(c,"(",2),")"),",",key))[("@"_lk) D NAS Q:$D(END)
 .;~~~I $D(lk),("@"_$P($P($P(c,"(",2),")"),",",key))[("@"_lk) I $P($P($P(c,"(",2),")"),",",key+1)="" D NAS Q:$D(END)
FI .Q:$P(c,",",po)'[")"  Q:$D(END)!($D(lk))  S mE=@c,YES=1 D  Q:'YES  D NAS
 ..I $D(da) S md=+$TR($P(mE,",",1,2),",",".") I '(da(1)'>md&(da(2)'<md)) S YES=0 Q  ;Y2000
 ..I $D(hot) I hot'=$P(mE,",",4) S YES=0 Q
 ..I $D(pol) I $P(mE,",",3)'=pol S YES=0 Q
FINAL G:$G(END)=2 NEWKEY I '$D(END) S ls=" КЛЮЧ НЕ НАЙДЕН " D O^%ZAPM.bs.BSF7
 K c1,%3,%1,%2,c,cc,ccc,mE,po,m
 G D
SAY S ls="ПОИСК..."_BSD_" "_$S($D(da):"ПО ДАТАМ ",1:"")_$S($D(hot):"ГОРЯЧЕЕ ",1:"")_$S($D(pol):"ПОЛЬЗОВАТЕЛЬ "_pol,1:"") D WAITS^%ZAPM.bs.BSF2 Q
NAS S ls=" НАШЛИ..."_$P($P(c,"(",2),",",1,key) D MENU^%ZAPM.bs.BSF5(" УСТАНовить ДАЛЬШЕ ПРЕКРатить ",ls) S:%B=1 END=2 S:%B=3 END=1 Q:$D(END)  I %B=2 S YES=1 D SAY Q
NEWKEY ;c - НОВАЯ ССЫЛКА $QS !!!!
 S zr=c K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)) F m=1:1:9 K ^%ZAPM.bs.BSbufB(m_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 S k=$P($P(zr,"(",2),")") F i=1:1:key-1 Q:$P(k,",",i)=""  S %KEYS(i)=$P(k,",",i) I %KEYS(i)'=+%KEYS(i)&($E(%KEYS(i),1)=$C(34)) S %KEYS(i)=$E(%KEYS(i),2,$L(%KEYS(i))-1)
 S %IND="",i=2,%NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)'=+%KEYS(ii):$C(34)_%KEYS(ii)_$C(34),1:%KEYS(ii))_","
 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)="@@1@70@@@@@1@"_$P(%BS,"!",4)_"@@@@@ .. k"_key_" "_%NAm
 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)="@@"_k6_"@@@@@1@"_k10_"@@@@@ "_$S(k5'="":k5,1:"НОВЫЙ "_key_"-Й ИНДЕКСНЫЙ КЛЮЧ")
 I kt'="" S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3,1)=@$ZR,i=i+1,$P(@$ZR,"@",3)="",$P(@$ZR,"@",8)=0,^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",3,1)=kt,kt1="3,1" D:kd1
 .S @$ZR=@$ZR_" I $P(BS,""@"",19)'="""" S kd=$S($P(BS,""@"",19):$$ESDAY^%ZAPM.bs.BSsFUNR(9,$P($P(BS,""@"",19),"","",1,2)),1:$P(BS,""@"",19)),d1=d1_$J("""",$P(BS,""@"",4)-$L(d1)-22)_kd_"" ""_$P($P(BS,""@"",19),"","",3)"
 F  S %IND=$O(@(%NAm_"%IND)")) Q:%IND=""  I %IND'["@" S i=i+1,ii=%IND,^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@"_k6_"@@@@"_$G(kt1)_"@1@"_k10_"@@@@@"_ii_"@@@@"_$G(@(%NAm_"%IND)"))
 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@X MRMR@1@@%FKR^%ZAPM.bs.BST1@1",$P(@$ZR,"@",25)=1,$P(@$ZR,"@",17)=1,se=i,ke=1 K MX,MY D RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1,W^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 G D
]]></Routine>


<Routine name="%ZAPM.bs.BSBD1" type="MAC" languagemode="0"><![CDATA[
%BSBD1 ; пpогpамма РАБОТЫ С УЗЛАМИ БД ; 17:32   20.06.2001
 Q
PFLREAD ;ВВОД И РАЗРЕЗКА НА ПРЕДВВВОД ДОКУМЕНТОВ
 S D=0,SS="",%zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSBD1",NEWFORMAT=S
 S (S2,S1)=""
 ;I $ZV["MSM",S["Cirillic,",S["1251" D INIT^%ZAPM.bs.BSre(0) S S=S1,S1=S2,S2=S ;ПЕРЕКОДИРОВАТЬ В ASCII
 I $ZV["Cach"||($ZV["IRIS"),S["Cirillic,",S["866" D INIT^%ZAPM.bs.BSre(0) ;ПЕРЕКОДИРОВАТЬ В ANSI
 D Wait^%ZAPM.bs.BSXfun("Ввод документов %BS-FORMAT")
 ;F  U %DEV R S Q:$ZC'=0  D
 //ion 27.01.2006 проверка на корректность парных скобок {}
 I '$$PFLOK^%ZAPM.bs.BSBD1() Q
 S i="" F  S i=$O(fT2(i)) Q:i=""  S S=fT2(i) D
 .I $E(S,1)=";" Q  ;КОММЕНТАРИЙ
 .I S["{" D DOKUM Q
Vi U 0 I '$D(N) D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ФОРМАТА ДОКУМЕНТА "_%FN) K %FN G EEE
EEE S $ZT=$G(%zT) D CLO
 Q
 
PFLOK()
 N F1,F2,L1,L2,L,i,Z,ZZ,ZZZ,STOP
 S (F1,F2,F3,L)=0
 F Z=0:1:255 S $E(ZZ,Z+1)=$C(Z) 
 S Z=$TR(ZZ,"{}"),ZZZ=""
 S i="" F  S i=$O(fT2(i)) Q:i=""  D  Q:$G(STOP)
 .S S=fT2(i),L1=$L(S)-$L($TR(S,"{","")),L2=$L(S)-$L($TR(S,"}","")),L=L+L1-L2
 .S ZZZ=ZZZ_$TR(S,Z) I $L(ZZZ,"{")=$L(ZZZ,"}") S ZZZ=""
 .I ZZZ["{{"!(ZZZ["}}") S STOP=i Q
 .I F1=0,L1=1,L2=0 S F1=1,F2=0
 .I F1=1,L1=0,L2=1 S F1=0,F2=1
 I F1=0,F2=1,L=0 Q 1
 D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА РАССТАНОВКИ СКОБОК В ДОКУМЕНТЕ! {В СТРОКЕ: "_$G(STOP,"???")_"}"_%FN)
 Q 0
 
DOKUM ;ВВОД ДОКУМЕНТА
 S D=D+1,N=0
 ;F  U %DEV R S Q:$ZC'=0  Q:S="}"  D
 F  S i=$O(fT2(i)) Q:i=""  S S=fT2(i)  Q:S="}"  D
 .S S=$TR(S,S1,S2) 
 .I $E(S,1)=";" Q  ;КОММЕНТАРИЙ
 .I $TR(S," ","")'="" S N=N+1,@TM@(%FN,D,N)=S
 D USE0^%ZAPM.bs.BSMDDR1 X $G(WA)
 Q
ERFILE U 0 I $ZE["<ENDOFFILE" G Vi
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) G CLO
CLO U 0 C:$D(%DEV) %DEV Q
 Q
FORMAF ;ОБЩИЙ МОДУЛЬ
 S:F="" F="?????" S ND=$G(@BP@("@Last"))+1,@BP@("@Last")=ND D L^%ZAPM.bs.BS3($NA(@BP@(F,ND)))
 S @BP@(F,ND,"INF")=FN_"?"_$$h^%ZAPM.bs.BS3()_"?"_$G(%BS(12))_"?"_$$FILE^%ZAPM.bs.BSDOS(FN,1)_"?"_$$FILE^%ZAPM.bs.BSDOS(FN,2)
 D TempTX^%ZAPM.bs.BSTT($P(FN,"\",$L(FN,"\"))_" *"_F_"* ?"_ND_"?") S TmpND=TmpND+1
 Q
BP ;ОБРАБОТКА ДОКУМЕНТОВ
 S FN="",TmpND=0 F  S FN=$O(@TM@(FN)) Q:FN=""  D Wait^%ZAPM.bs.BSXfun("обработка "_FN) S D="" F  S D=$O(@TM@(FN,D)) Q:D=""  D  X WA
 .S N="" F  S N=$O(@TM@(FN,D,N)) Q:N=""  S S=@TM@(FN,D,N) D
 ..I N=1 S F=$P($P(S,"NODE_DDR=",2)," ") D FORMAF
 ..S @BP@(F,ND,(N+1)_",2")=S
 .D U^%ZAPM.bs.BS3($NA(@BP@(F,ND)))
 .D CTRL^%ZAPM.bs.BSMDDR1(BP,F,ND,BD)
 Q
 ;Z="" СИНТ. КОНТРОЛЬ ДОКУМЕНТА
 ;Z=1 ЗАНЕСЕНИЕ В БД
 ;Z=1,$G(uzel)'="" ЛОГ. КОНТРОЛЬ ДОКУМЕНТА БЕЗ ЗАНЕСЕНИЯ В БД
 ;Z=1,$G(uzel)="KILL" ОТКАТ-УДАЛЕНИЕ УЗЛОВ БД ДОКУМЕНТА
 ;BP-МАСССИВ БПО
 ;F - ИМЯ ФОРМЫ
 ;ND - НОМЕР ДОКУМЕНТА
CTT ;КОНТРОЛЬ НОВОГО ФОРМАТА
 F K=0:1:9 I $D(LB(F,K)) S LastKey=K I '$D(LB(F,K,1)) D CTRK(K,.Ke) Q:$D(ErrKey)  S Ke(K)=d
 I $D(ErrKey) D PROT^%ZAPM.bs.BSMDDR1(2,"ОШИБКА В ОПИСАНИИ КЛЮЧА "_K) Q
 S KK=LastKey ;ПОСЛЕДНИЙ КЛЮЧ
 S %zT=$ZT,$ZT="ERPOK^%ZAPM.bs.BSMDDR1"
 S bd=$P(LB(F,"KEY"),"@")_$G(Ke(0))  D varBLOCK^%ZAPM.bs.BSCocx
 I '$$Data^%ZAPM.bs.BSF12(bd) S @bd="BSD - MSW@" ;D PROT^%ZAPM.bs.BSMDDR1(2,"НЕ ДОСТУПНА БАЗА "_bd_" !  ВОЙДИТЕ НА 0-Й КЛЮЧ И СОЗДАЙТЕ НОВЫЙ УЗЕЛ БАЗЫ ДАННЫХ") Q
ctr K ls,POK,stOP,stoP I $G(LB(F,"W"))="!!!" S Wt=1 ;РАЗРЕШИТЬ ДУБЛИРОВАНИЕ
 S N=2 F  S N=$O(S(N)) Q:N=""  S OSN=0 D  I OSN D ER^%ZAPM.bs.BSMDDR1("в"_(N-1),OSN)
 .S PO=$P(S(N),"=")
 .S (d,d1,d0)=$P(S(N),"=",2,999)
 .I $G(LB(F,"PI"))[(PO_",") Q  ;ИГНОРИРУЕМЫЕ ПОКАЗАТЕЛИ
 .I $G(LB(F,"W"))=PO D  Q:$D(stOP)
 ..I d=0 D  Q
 ...I $G(uzel)'="KILL" D PROT^%ZAPM.bs.BSMDDR1(N,"ПОКАЗАТЕЛЬ "_PO_d_" ТРЕБУЕТ УДАЛЕНИЕ ДОКУМЕНТА ! ЭТО МОЖНО ВЫПОЛНИТЬ КОМАНДОЙ <ALT-F2> --> <ОТКАТ>") S OS=OS+1,OSN=OSN+1,stOP=1 Q
 ...I $G(uzel)="KILL" S stoP=1
 ..S Wt=$S(d=1:1,1:PO) Q
 .I '$D(LB(F,"I",PO)) D  Q
 ..D PROT^%ZAPM.bs.BSMDDR1(N,".НЕСУЩЕСТВУЮЩИЙ ПОКАЗАТЕЛЬ "_PO_" !!!") S OS=OS+1,OSN=OSN+1 K ls
 .I $D(LB(F,"I",PO,1)) D
 ..I $D(LB(F,"SPO")),LB(F,"SPO")[(PO_",") Q  ;СНЯТИЕ КОНТРОЛЯ
 ..S YES=1 X LB(F,"I",PO,1) I 'YES D PROT^%ZAPM.bs.BSMDDR1(N,PO_"="_d_" !!! "_$G(ls,"СИНТ.ОШИБКА")) S OS=OS+1,OSN=OSN+1 K ls Q
 .I $G(Z)=2,$G(LB(F,"I",PO))["@" S REC(PO)=d
 I $D(LB(F,"Singl")),'$D(stOP),'$D(stoP) S bd1=$$SingB^%ZAPM.bs.BSMDDR1 n sblo d  q:$d(sblo)
  .i $$block^%ZAPM.bs.BSCocx($P(bd1,"AsIs",2)) D PROT^%ZAPM.bs.BSMDDR1(N,bd1_" Узел Блокирован Администратором !") S OS=OS+1,sblo=1 Q
  .I $D(@bd1),'$G(Wt) D PROT^%ZAPM.bs.BSMDDR1(N,bd1_" УЖЕ СУЩЕСТВУЕТ И НЕТ ."_$G(Wt,"""КОР1""")) S OS=OS+1,sblo=1 Q
 I $D(LB(F,"P")) D PROT^%ZAPM.bs.BSMDDR1(" ФОРМА НАСТРОЕНА КАК ""МНОГО-ЛИНЕЙНАЯ"",НОВЫМ ФОРМАТОМ ТАКИЕ НЕ ПОДДЕРЖИВАЮТСЯ") S OS=OS+1 Q
 I 'OS S:$G(uzel)="" @BP@(F,ND,"2,1")=3 I $G(Z)=1 K REC,DUBL S Z=2 G ctr
 I OS D ER^%ZAPM.bs.BSMDDR1(" всего",OS) Q
 I $G(Z)=2 S RECK=1 D REC^%ZAPM.bs.BSMDDR1 S:$G(uzel)'="" @BP@(F,ND,"2,1")=OldP I "KILL"'[$G(uzel) S $P(@BP@(F,ND,"INF"),"?",6)=$S($D(oTl):"",1:+$G(rlo))
 I $G(uzel)="KILL" S Z="" K REC,DUBL,uzel G ctr ;ЭМУЛЯЦИЯ СИНТ.КОНТРОЛЯ
 Q
CTRK(K,%KEYS) ;КОНТРОЛЬ КЛЮЧЕЙ ИЗ НЕПОВТОРЯЮЩИХСЯ ПОКАЗАТЕЛЕЙ
 N FO,d1,d0,YES,Iv,ls,%NAm,ii
 S %zT=$ZT,$ZT="ERKEY^%ZAPM.bs.BSBD1"
 S %NAm=$$BSD^%ZAPM.bs.BSA($P(LB(F,"KEY"),"@"),$G(%KEYS(0))) F ii=1:1:9 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 S (d1,d,d0)=$P($P(S(2),"KEY"_K_"=",2)," ")
 I $G(LB(F,K))["^%" X "S (d1,d,d0)="_LB(F,K)
 I d="" D PROT^%ZAPM.bs.BSMDDR1(2,"КЛЮЧ НОМЕР "_K_" ПУСТОЙ !") S OS=OS+1 Q
 I $D(LB(F,"KEY",K,1)) D
 .I $D(LB(F,K,2)) Q
 .X LB(F,"KEY",K,1) I 'YES D PROT^%ZAPM.bs.BSMDDR1($G(Iv,2),"ОШИБКА ДАННЫХ КЛЮЧА НОМЕР "_K_" "_$G(ls)) S OS=OS+1 K ls Q
 Q
ERKEY D PROT^%ZAPM.bs.BSMDDR1($G(Iv,2),"!!!КЛЮЧ "_K_" !!! "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) S OS=OS+1
 S ErrKey=1
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSBL" type="MAC" languagemode="0"><![CDATA[
%BSBL ;СОЗДАНИЕ БЛОКА,ОТКРЫТИЕ HFS,EXPORT DOS-FILE;;[ 30/09/93 11:17 ] ; 14:45   02.03.99
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"_%BS(15)) I '$P(@(BSR_"(BST)"),"@",3) S ls="А блок-то где ?" D O^%ZAPM.bs.BSF7 Q
BL1 ;ОТБОР БЛОКА С ТИТУЛОМ
 S BS=@(BSR_"(BST)"),^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15))=BS S:$P(BS,"@",19) %TIT=$P(BS,"@",19),i1=$P(%TIT,",")-1,j1=$P(%TIT,",",2)-1
 ;ТИТУЛ ДЛЯ ПЕЧАТИ```MSW
 S:$P(BS,"@",50) %TIT=$P(BS,"@",50),i1=$P(%TIT,",")-1,j1=$P(%TIT,",",2)-1
 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  I $P(^(j),"@",12) S BS=^(j) D
 .D OBR S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=BS
 .S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),0,j)=@(BSR_"(BST,i,j)"),^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,0)=@(BSR_"(BST,i,j)")
 .I '$D(%TIT) Q
 .F i2=1:1:i1 S I=i,BS=@(BSR_"(BST,i2,j)"),i=i2 D OBR S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i2,j)=BS,i=I
 .F j2=1:1:j1 S J=j,BS=@(BSR_"(BST,i,j2)"),j=j2 D OBR S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j2)=BS,^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),"0",j2)=@(BSR_"(BST,i,j2)"),j=J
 I '$D(%TIT) G BL2
 F i2=1:1:i1 F j2=1:1:j1 S BS=@(BSR_"(BST,i2,j2)"),i=i2,j=j2 D OBR S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i2,j2)=BS,^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i2,0)=@(BSR_"(BST,i2,j2)")
BL2 ;СОЗДАНИЕ ТАБЛИЦЫ
 S i=0,(BS,BS1,BS2)=0,BS3=1 F  S i=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  D  X WA S BS3=BS3+BS2 ;ПРИВЕДЕНИЕ КООРДИНАТ
 .S BS=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,0),BS1=$P(BS,"@"),BS2=$P(BS,"@",3) S:BS1>BS3 $P(BS,"@")=BS3 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,0)=BS
 S j=0,(BS,BS1,BS2)=0,BS3=1 F  S j=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),0,j)) Q:j=""  D  S BS3=BS3+BS2
 .S BS=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),0,j),BS1=$P(BS,"@",2),BS2=$P(BS,"@",4) S:BS1>BS3 $P(BS,"@",2)=BS3 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),0,j)=BS
 S i1=1,i=0 F  S i=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  D  S i1=i1+1 ;ПОДЖАТИЕ
 .S j1=1,j="" F  S j=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),0,j)) Q:j=""  S BS1=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,0),BS11=$P(BS1,"@"),BS12=$P(BS1,"@",3),BS2=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),0,j),BS21=$P(BS2,"@",2),BS22=$P(BS2,"@",4) D  S j1=j1+1
 ..I '$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) D  S BS=BS11_"@"_BS21_"@"_BS12_"@"_BS22_"@@@@@1@@@@@@",^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"_%BS(15),i1,j1)=BS Q
 ..S BS=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j),$P(BS,"@")=BS11,$P(BS,"@",2)=BS21,^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"_%BS(15),i1,j1)=BS
 S ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"_%BS(15))=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15)) K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 ;I $D(@(BSR_"(BST,""PRN"")")) S ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"_%BS(15),"PRN")=@(BSR_"(BST,""PRN"")") Q
 Q
OBR ;ОБРАБОТКА ДАННЫХ КЛЕТКИ
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j))
 I d0="" S d0=0
 I $P(BS,"@",8)'="" S nx=j,ny=i D  ;
 .I '$P(BS,"@",8) X @(BSR_"(BST,""FTR"",i,j)") Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 S $P(BS,"@",8)="",$P(BS,"@",15)=d1,$P(BS,"@",9)=1
e Q
BF ;ОПЦИИ ВЫВОДА
BFB D SA^%ZAPM.bs.BSsBUF D BF2 D RE^%ZAPM.bs.BSsBUF Q
BF2 I $D(@(BSR_"(BST,""HFS"")")) S PRA1=@(BSR_"(BST,""HFS"")") F i=1:1:8 S @("PR"_i)=$P(PRA1,"@",i) G:i=8 BF1
 F ii=2:1:9 S i=ii-1,@("PR"_i)=$P(^%ZAPM.bs.BSS("HFS",ii,2),"@",15) G:ii=9 BF1
BF1 K BSd,BSk S (BSt1,kk)="HFS",BSr1="^%ZAPM.bs.BSS",BSt2="fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSr2="^%ZAPM.bs.BSbufB" D COPY^%ZAPM.bs.BSTK S ii=@(BSr2_"(BSt2)") F jj=2,4,5,12,13,14,15 S $P(ii,"@",jj)=""
 S @(BSr2_"(BSt2)")=ii F PRB=2:1:9 S i=PRB-1,$P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),PRB,2),"@",15)=@("PR"_i) Q:PRB=9
 S yyy1=BSR,yyy2=BST D  K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15)) Q
 .D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,yyy1,yyy2,BSB,PRA1)
 .S BST="fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSR="^%ZAPM.bs.BSbufB" D ^%ZAPM.bs.BST Q:R1=27  F PRB=2:1:9 S i=PRB-1,@("PR"_i)=$P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),PRB,2),"@",15) Q:PRB=9
 .D  I PR8="Y" S $P(PRA1,"@",8)="N" S @(yyy1_"(yyy2,""HFS"")")=PRA1
 ..S PRA1="" F i=1:1:8 S PRA1=PRA1_@("PR"_i)_"@" Q:i=8
]]></Routine>


<Routine name="%ZAPM.bs.BSBL1" type="MAC" languagemode="0"><![CDATA[
%BSBL1 ;ОТКРЫТИЕ HFS, EXPORT DOS-FILE ; 16:39   12.05.99
DosOpn(NumDev,PR1) ;
DOSOPN ;ОТКРЫТИЕ УСТРОЙСТВА HFS ДЛЯ ЗАПИСИ
 I $ZV["Cach"||($ZV["IRIS"),'$$ASK^%ZAPM.bs.BSCi Q
 S YES=1 I $D(%DEV)&($D(%FN)) G U:%DEV>50&(%DEV<55),U:$ZV["Cach"||($ZV["IRIS")
DEV I $ZV["Cach"||($ZV["IRIS") S %DEV=51 G FN
 F %DEV=$G(NumDev,51):1:54 O %DEV::0 Q:$T
 I '$T S %DEV=0 S ls=" Все файловые устpойства ДОС заняты ..." D O^%ZAPM.bs.BSF7 G END
 N Qq
FN U 0 S %DEVTYPE="HFS" K %FN S ls=" Введите полный путь к DOS-файлу для ЗАПИСИ (F3-Каталог) ",li=$G(PR1)
         I li="" S li=$$DIRUSER^%ZAPM.bs.BSCmDDR(%BS(12)) //```
 D ChP^%ZAPM.bs.BSF10(2) ;ПЕРЕОПРЕДЕЛЕНИЕ ТЕКУЩЕГО КАТАЛОГА
 I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 I $G(pacetD)=""!($G(pacetO)=1&($G(pacetD)=2))!($G(PR1)="") S %KAT="D DOS^%ZAPM.bs.BSDOS",ll="",%HIS="^%ZAPM.bs.BSbufB(""HISFILE"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")" D LE^%ZAPM.bs.BSTT Q:'YES  I li="" S YES=0 Q
 //```
 I $E(li,2)'=":"!("Aa"[$E(li,1))!($E(li,$L(li))="\") D ER^%ZAPM.bs.BSF("Вводите имя файла в формате... "_$$DIRUSER^%ZAPM.bs.BSCmDDR(%BS(12))_"FileName") G FN
 S %FN=li G:"^."[%FN END I $G(%SDEV)="HISTORY" C %DEV Q  ;!!!
 S:$P(li,"\",$L(li,"\")+1)'["." li=li_".%BS" I $E(li,$L(li)-3,$L(li))'=".%BS" S ls=" НЕОБХОДИМО РАСШИРЕНИЕ *.%BS " D O^%ZAPM.bs.BSF7 G FN
 I $G(pacetD)'="" I pacetD=1!(pacetO=1) D  G:$G(Qq) FN
 .I $$ZOS10^%ZAPM.bs.BSDOS(%FN)>0 I $$DelFile^%ZAPM.bs.BSXdos(%FN) S Qq=1
 S:$G(pacetD)'="" pacetO=2,pacetPR1=%FN
 I $G(pacetD)="" I $$OverAdd^%ZAPM.bs.BSXdos(%FN) G FN
U I $ZV["MSM" O %DEV:(%FN:"A") U %DEV I $ZA<0 G ErrO
  I $ZV["Cach"||($ZV["IRIS") G ErrO:'$$OpenFile^%ZAPM.bs.BSCF1(%FN,"A")
END S %3=250 I "^."[%FN S %4="" C %DEV K %DEV,%FN D CL^%ZAPM.bs.BSF4 Q
 U 0 Q
C C %DEV K %DEV,%FN D CL^%ZAPM.bs.BSF4 Q
ErrO U 0 S ls=" Ошибка откpытия файла "_%FN D O^%ZAPM.bs.BSF7 C %DEV
 I $G(pacetD)'="" Q
 G FN
 
IntTXT2T(BSr,BSt,BSR,BST) 
 ;ВНУТРЕННЯЯ ТОЧКА ВХОДА ИЗ BSr,BSt ---> BSR,BST
 S IntTXT2T=1 G IntTXT
EXPORTXT ;ВОССТАНОВЛЕНИЕ ИЗ ТЕКСТА
 D RIT^%ZAPM.bs.BSF3 I 'YES G D
IntTXT K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S %I=$I
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSBL1"
 S %IN=$G(@(BSr_"(BSt,1)")) I %IN="" S ls=" Нет ведь ничего !" D O^%ZAPM.bs.BSF7 G D
 I $E(%IN,1)'="#" S ls=" Не тот формат !" D O^%ZAPM.bs.BSF7 G D
 I '$D(IntTXT2T) S ls=" Восстановим ? Но текущая таблица будет потеряна! " D YES^%ZAPM.bs.BSF G:'YES D
 S AN=%IN,DL=$L(%IN)
IF S ls="ВОССТАНОВЛЕНИЕ..." D WAITS^%ZAPM.bs.BSF2  D TRANS
 S i=1 F  S i=$O(@(BSr_"(BSt,i)")) Q:i=""  Q:$G(@(BSr_"(BSt,i)"))=""  D
 .S %IN=$G(@(BSr_"(BSt,i)"))
 .S:i=2 AN=$E(%IN,1) S AN1=$E(%IN,1) D TRANS1 X $G(WA)
 G QQQ
tr(S) //АВТО-ТРАНСЛЯЦИЯ ИЗ ASCII
 S (S2,S1)="" D INIT^%ZAPM.bs.BSre(1)
 Q $TR(S,S1,S2)
EXPORT ;ВОССТАНОВЛЕНИЕ ИЗ DOS-ФАЙЛА
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 S %I=$I D DEV^%ZAPM.bs.BSS1
REST D DOSREAD I '$D(%FN) K %DEV Q  ;ВОССТАНОВЛЕНИЕ ТАБЛИЦ
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSBL1" U %DEV R %IN G:$ZC'=0 CLO
RES I $E(%IN,1)["#"!($E(%IN,1)["$") U 0 S ls=" Восстановим ? Но текущая таблица будет потеряна! " D YES^%ZAPM.bs.BSF G:'YES D S AN=%IN,DL=$L(%IN) G I
 U 0 S ls=" Не тот формат !" D O^%ZAPM.bs.BSF7 G D
I U 0 S ls="ВОССТАНОВЛЕНИЕ..." D WAITS^%ZAPM.bs.BSF2 S (S2,S1)="" I ($E(%IN,1)["#") D INIT^%ZAPM.bs.BSre(1)
 D TRANS
 F i=1:1 U %DEV R %IN Q:$ZC'=0  S %IN=$tr(%IN,S1,S2) D 
 .U 0 S:i=1 AN=$E(%IN,1) S AN1=$E(%IN,1) D TRANS1 X $G(WA)
QQQ S QQ=1 U 0 D TRANS1,TRA2
QQ S $ZT=$G(%zT) U 0 D CLO,TAB^%ZAPM.bs.BSF1,DEND^%ZAPM.bs.BSF2,REND^%ZAPM.bs.BSF2 G:$D(IntTXT2T) D D W^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM G D
 G D
DOSREAD I $D(%DEV)&($D(%FN)) I %DEV>50&(%DEV<55) G U^%ZAPM.bs.BSS1
e Q
ER U 0 I $ZE["<INRP" S ls=" ПРЕРВАНО..." G ERE
 I $ZE["<ENDOFFILE" G QQQ
 I $ZE["<MXSTR" S ls=" Слишком длинная строка считана " G ERE
 S ls=$ZE
ERE S $ZT=$G(%zT) D O^%ZAPM.bs.BSF7,CLO K:$E($G(BST),1)="@" @(BSR_"(BST)") G END^%ZAPM.bs.BSF
CLO U 0 C:$D(%DEV) %DEV Q
D ;???MSW D U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
 I $D(IntTXT2T) K IntTXT2T Q
 G 0^%ZAPM.bs.BSTM
TRANS ;ЗАПИСЬ ТАБЛИЦЫ
 S QQ="",FS=@(BSR_"(BST)") K @(BSR_"(BST)") S @(BSR_"(BST)")=FS
 S k=1,k1=2,k2=3,AN1=$E(AN,2) F i=k2:1 S AN2=$E(AN,i) D  Q:AN2=""
 .I AN2'=AN1 S j=i-1,^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),k)=k1_","_j,k2=i,AN1=AN2,k=k+1,k1=k2
 S l=0,BSI=0 Q
TRANS1 ;
 I $L(%IN)<DL S %IN=%IN_$J("",(DL-$L(%IN)))
 I '$D(AN1) G TRA2
 I AN1=AN D  Q
 .S j=0,l=l+1 F  S j=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),j)) Q:j=""  S k=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),j),^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15),l,j)=$E(%IN,$P(k,","),$P(k,",",2))
TRA2 S AN=AN1,l=0,BSII=0,BSI=BSI+1,j1=0
TRA S BSII=BSII+1,STR="",STR1=""  F  S j1=$O(^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15),j1)) Q:j1=""  S SY=j1 S:QQ=1 SY=SY-1 D  G:STR1="" TRA1 S STR=STR_STR1
 .Q:'$D(^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15),j1,BSII))  S STR1=^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15),j1,BSII),SX=$L(STR1)
 D  S @(BSR_"(BST,BSI,BSII)")="@@"_SY_"@"_SX_"@@@@@1@@@@@@"_STR G TRA
 .I $TR(STR," ","")="" S STR="" Q
 .S f2=STR,f=$L(STR) I STR[" " F f=$L(STR):-1 S f1=$E(STR,f) Q:f1'=" "
 .S STR=$E(STR,1,f)
 .I $L(STR)>502 S STR=$E(STR,1,502)_"??"
TRA1 K ^%ZAPM.bs.BSbufB("P"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G:QQ="" TRANS1
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC" type="MAC" languagemode="0"><![CDATA[
%BSC ;ДЛЯ CACHE' - ДИСПЕТЧЕР ; 11:04   24.01.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 N  ;
 N LOGIN
 F  D START Q:'$D(LOGIN)  Q:"^ ."[LOGIN&(LOGIN'="")
MGR Q
START ;N  L  ;ГОЛОВНОЙ МОДУЛЬ 
 S $ZT="ALLERR^%ZAPM.bs.BSC"
 D CLr^%ZAPM.bs.BSF4,CCC
 D PROT
 D Registr^%ZAPM.bs.BSX(1)
 do Z
 do DelKills^%ZAPM.bs.BSX L
 D REGE^%ZAPM.bs.BSMSMF
 Q
MENU D MENU^%ZAPM.bs.BSCp Q
Z N N,I,II,III,BSR,BST,NSP,APP
 K GLOBALIST
 ///z I '$D(BSLOGIN) D LOGIN I '$G(YES,1) G EXIT
 S %BS(12)="m",%BS(39)="NAV" D REGSERV^%ZAPM.bs.BS1,EMUL
 D WORKGRP^%ZAPM.bs.BS1
 I %BS(12)'="",$G(@%BS(18)@(%BS(37),0,"7,4"))'="" S i=@$ZR,ii=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""ARM"")") I $$Data^%ZAPM.bs.BSF12(ii) I $D(@ii@(i,"5,4"))'="" S i=@$ZR D ARM^%ZAPM.bs.BSTT(i) G EXIT
 I $D(%BS(39))[0 W !,"   ошибка доступа при регистрации" H 2 Q
 S APP=@%BS(18) ;I $O(@APP@("-0",""))'="" S %BS(1)=$O(@APP@("-0",""))
 ;S %BS(1)="00000100001101001100" //DFLT
NSP ;СПИСОК ИМЕННОВАННЫХ ОБЛАСТЕЙ
 ;S NSPL=$$NS^%ZAPM.bs.BSCi("NAV",$G(%BS(39))) 
 S NSPL=$$NS^%ZAPM.bs.BSCp()  ///z
 I NSPL=""  D ErrMsg^%ZAPM.bs.BSXfun("Нет доступных областей !") G EXIT
 S BSR="^%ZAPM.bs.BSbufB",BST="NameSpace"_$G(%BS(3),$P)_$J_"u"_%BS(15)
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""ALINS"")",$NA(@BSR@(BST)))
 S $P(@BSR@(BST,1,1),"@",15)="  NameSpace in   '"_$ZU(110)_"'",$P(@BSR@(BST,1,2),"@",15)=$ZV_" (%BS version "_$$ver()_") № "_$$n()
 S $P(@BSR@(BST,2,1),"@",15)=" ..",$P(@BSR@(BST,2,2),"@",15)=" ...ВЫХОД ИЗ КОМПЛЕКСА"
 F I=1:1:$L(NSPL,$C(1)) i $P(NSPL,$C(1),I)'=""  D
 .S @BSR@(BST,I+2,1)=@BSR@(BST,2,1),@BSR@(BST,I+2,2)=@BSR@(BST,2,2)
 .S $P(@BSR@(BST,I+2,1),"@",15)=$P(NSPL,$C(1),I),$P(@BSR@(BST,I+2,2),"@",15)=" ..."
 S $P(@BSR@(BST),"@",15)=0,$P(@BSR@(BST),"@",19)="2,2",$P(@BSR@(BST),"@",16)=1
 S $P(@BSR@(BST),"@",41)="FKEY^%ZAPM.bs.BSC"
 S $P(@BSR@(BST),"@",39)="^%ZAPM.bs.BSC,ZHELP1"
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST I R1=27,R2=-1 G EXIT
 I ny=2 G EXIT
 I $G(R1)=13,$G(R2)=-1 D GLO($P(@BSR@(BST,ny,1),"@",15)),MGR^%ZAPM.bs.BS G NSP
 Q
REC S YY=15 W /CUP(YY,1),$ZV,/CUP(YY+1,1),"%BS ",$$ver,/CUP(YY+2,1),$$WEEKEND^%ZAPM.bs.BSsFUNR(1,$$h^%ZAPM.bs.BS3()),"  ",$$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3()),/CUP(YY+3,1),"Server : ",$ZU(110)
 Q       
LOGIN ;ПРОВЕРКА ПАРОЛЯ
 N PASS,APP 
 W "%SYS>",!
 W /ED(2),$$atr^%ZAPM.bs.BS3(0) D SAY^%ZAPM.bs.BS3(5,3),REC
 W /CUP(YY+4,1),"Id terminal "_$$n ;,/CUP(YY+5,1),". ^ - выход из терминального режима" 
 S YES=0
 I $G(%BS(43))="" D RED^%ZAPM.bs.BS1 W /CUP(YY+6,1)," Enter username (exit-.) : ",$$atr^%ZAPM.bs.BS3(0) R LOGIN
 E  D  S LOGIN=$$LineEdit^%ZAPM.bs.BSXfun(""," Enter username (.-exit)") quit:$G(YES)<1  
 .//в AdvSockTerm должен быть выставлен таймаут=0 для запуска программ
 .W " Username:",! R LOGIN:1,R1:1 I LOGIN="SYS" W "Password:",! R PASS:1,R1:1  I PASS="XXX"!(R1="XXX")  W "%SYS>",! R XXX:1,R1:1 D GTKlog(XXX)
  Quit:"^ ."[LOGIN  ;s LOGIN=$$BIGL^%ZAPM.bs.BSsFUNM(R)
 D GTKlog(LOGIN) 
 I $G(%BS(43))="" W /CUP(YY+7,1),/EL(0),$$clr^%ZAPM.bs.BS3(11)," password :",$$atr^%ZAPM.bs.BS3(0) D CL^%ZAPM.bs.BS1 R PASS D CachOn^%ZAPM.bs.BS1
 I $G(%BS(43))'="" S PASS=$$LineEdit^%ZAPM.bs.BSXfun(""," password for user '"_LOGIN_"'") H:$G(YES)<1  
 S APP=$$CheckPass^%ZAPM.bs.BSCp(LOGIN,PASS,"NAV") 
 ;I APP="" S ls=" password wrong " D O^%ZAPM.bs.BSF7 q
 set APP="NAV"
 S YES=1,%BS(12)=LOGIN,%BS(39)=APP D REGSERV^%ZAPM.bs.BS1,EMUL
 Q
GTKlog(LOGIN) I $E(LOGIN,1,11)="D BST^%ZAPM.bs.BSC(" D GTKcheckGO(LOGIN) H
 Q
GTKcheckGO(L) N YES //код для сертификации
 I L[",""""""," S L=$$repl^%ZAPM.bs.BSCp2(L,","""""",",","""",") //S ^%Z(1)=L ЭМУЛЯЦИЯ ОШИБКИ ДЛЯ ADVSOCKTERM V.4
 S YES=0 X $$TR^%ZAPM.bs.BSsFUNM(L,"D BST^%ZAPM.bs.BSC(","D GTKc^%ZAPM.bs.BSC(") I 'YES W /ED(2),$$atr^%ZAPM.bs.BS3(0) D RED^%ZAPM.bs.BS1 W /CUP(13,25)," Ошибка доступа !!! "_$G(YES) R *R H
 X L
 Q
GTKc(U,BSR,BST,EDIT,MODE,BSLOGIN,BSSES) //проверка на соответствие сессии, пользователя
 N (YES,BSLOGIN,BSSES) I $G(BSLOGIN)="" S YES="Неопределен пользователь" Q
 I $G(BSSES)="" S YES="Неопределен ID сессии" Q
 D MAINVAR^%ZAPM.bs.BSC4 I $G(@BDSES@(BSSES,"CHR"))'="" S YES="Сессия закрыта" Q
 I $G(@BDSES@(BSSES,"NM"))'=BSLOGIN S YES="ID сессии не соответствует пользователю" Q
 S YES=1
 Q
EMUL I $G(%BS(12))'="" s %BS(18)="%BS(39)",%BS(37)=%BS(12),%BS(39,%BS(12),"*")="" ;ЭМУЛЯЦИЯ БД MSM
 Q
GLO(NAMESP) ;СПИСОК ГЛОБАЛЕЙ
 I '$$CNS^%ZAPM.bs.BSCp(NAMESP) D ErrMsg^%ZAPM.bs.BSXfun(NAMESP_" НЕДОСТУПЕН !") Q
 N TIPPA,I,II,BSR,BST,COM,%NAM,IntFKR ;,GLOBALIST
 S TIPPA="P ;" ;CBKMP````ВСЕ ТИПЫ ГЛОБАЛЕЙ
GLOBALS 
 I $D(%BS(39))[0 W !,"   ошибка доступа при регистрации" H 2 Q
 ;I $D(@%BS(39)@(NAMESP,"-1")) S TIPPA=$O(@$ZR@("")) I TIPPA="" 
 //все раздлы
 S TIPPA="BKMP ;"
 I '$D(GLOBALIST(NAMESP)) S GLOBALIST(NAMESP)=$$BSR^%ZAPM.bs.BSCi(NAMESP,,%BS(39),TIPPA) I GLOBALIST(NAMESP)="~" W !,"В доступе отказано" H 3 Q
 S BSR="^%ZAPM.bs.BSbufB",BST="GlobaList"_$G(%BS(3),$P)_$J_"u"_%BS(15) D CCC
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""ALINS"")",$NA(@BSR@(BST))) S $P(@BSR@(BST,1,1),"@",15)="List of Globals in "_NAMESP,$P(@BSR@(BST,1,2),"@",15)=">>> Comments: № "_$$n()
 S $P(@BSR@(BST,2,1),"@",15)=" ^new",$P(@BSR@(BST,2,2),"@",15)=" ...create new partition" ///z
 F I=1:1 Q:$P(GLOBALIST(NAMESP),$C(1),I)=""  D
 .S @BSR@(BST,I+2,1)=@BSR@(BST,2,1),@BSR@(BST,I+2,2)=@BSR@(BST,2,2)
 .S GLO="^"_$P(GLOBALIST(NAMESP),$C(1),I)
 .S $P(@BSR@(BST,I+2,1),"@",15)=GLO I $$Data^%ZAPM.bs.BSF12(GLO) S COM=$$TIPP^%ZAPM.bs.BS($P($G(@GLO),"@",1))_" ;"_$P($G(@GLO),"@",2)
 .S $P(@BSR@(BST,I+2,2),"@",15)=$G(COM," ...")
 S $P(@BSR@(BST),"@",15)="INTGLO^%ZAPM.bs.BSC",$P(@BSR@(BST),"@",19)="2,2",$P(@BSR@(BST),"@",16)=1
 S $P(@BSR@(BST),"@",41)="FKEYPART^%ZAPM.bs.BSC"
 S $P(@BSR@(BST),"@",39)="^%ZAPM.bs.BSC,ZHELP2"
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST I R1=27,R2=-1 Q
 I ny=2 S li="" D NEWRAZD^%ZAPM.bs.BS1 K GLOBALIST(NAMESP) G GLOBALS ;НОВЫЙ РАЗДЕЛ
 D PART($P(@BSR@(BST,ny,1),"@",15),$E(d,1,4)) G GLOBALS
 Q
INTGLO S %NAM=$P(@BSR@(BST,ny,1),"@",15),IntFKR=1 G IntFKR^%ZAPM.bs.BS2 ;ФУНКЦИОНАЛЬНЫЕ КЛАВИШИ
FKEY ;ПРЕДОБРАБОТКА NAMESPACE
 ;I R1=27,R2=79,R3=85 D 0^%ZAPM.bs.BSDOS S R1=-2 Q  ;F6
 I R1=27,R2=79,R3=88 I $D(@%BS(39)@("-3")) D  Q  ;F9
 .S IYI="^%ZAPM.bs.BSETUP(SETUP" D NE^%ZAPM.bs.BSN D CLr^%ZAPM.bs.BSF4 S R1=-2 Q
 I R1<332,$E(%BS(1),3)=2,'$E($G(%BS(14)),4),R1>31,R1'=127 D CM^%ZAPM.bs.BSF6 S (R1,R2,R3)=0 Q
 I R1=8,R2=-1,R3=-1 S R1=27 Q  ;BACKSPACE
 Q
FKEYPART ;
 I R1=27,R2=79,R3=85 I $$COPYPART($P(@BSR@(BST,ny,1),"@",15)) S R1=-2 Q
 I R1=27,R2=79,R3=88 S IYI="^%ZAPM.bs.BSETUP(SETUP" D NE^%ZAPM.bs.BSN K %BS D CLr^%ZAPM.bs.BSF4 S R1=-2 Q
 I R1<332,$E(%BS(1),3)=2,'$E($G(%BS(14)),4),R1>31,R1'=127 D CM^%ZAPM.bs.BSF6 S (R1,R2,R3)=0 Q
 I R1=8,R2=-1,R3=-1 S R1=27 Q  ;BACKSPACE
 Q
EXIT D OP^%ZAPM.bs.BSF4 D  W #
 N II,ii,i S II="" F  S II=$O(^%ZAPM.bs.BSbufB(II)) Q:II=""  I II["u" D
 .L +^%ZAPM.bs.BSbufB(II):0  I  K ^%ZAPM.bs.BSbufB(II) Q
 Q
ALLERR I $ZE["<ZINRP" S ls="ПРЕРВАНО" D ER^%ZAPM.bs.BSF(ls) S R1=27,R2=-1,R3=-1 Q
 S ls="Произошла Ошибка ! "_$$ZE() D Tex^%ZAPM.bs.BSMSMF("ErrorTermA="_$ze,$G(BSG,"?")_","_$G(BSROU)_","_$ZN_","_$ZU(5)_","_$G(%KEY("MGWLPN"),"?")_","_$s_","_$G(BSSES))
ALLE D ER^%ZAPM.bs.BSF(ls) W $$atr^%ZAPM.bs.BS3(0) D EXIT G KL
ZE() Q $ZE_". "_$$ErrSay^%ZAPM.bs.BSF8($ZE)
PART(PARTITION,TIPP) ;СПИСОК ГЛОБАЛЕЙ
 I TIPP="PART" D PARTIT^%ZAPM.bs.BSF12(PARTITION) Q
 D ^%ZAPM.bs.BSMSMG(PARTITION)
 Q
COPYPART(PART) ;КОПИРОВАНИЕ РАЗДЕЛА
 N NP
 S NP=$$LineEdit^%ZAPM.bs.BSXfun("^","ВВЕДИТЕ ИМЯ РАЗДЕЛА, КУДА КОПИРОВАТЬ") Q:YES<1 0
 I $$Data^%ZAPM.bs.BSF12(NP) D Yes^%ZAPM.bs.BSXfun("РАЗДЕЛ "_NP_" УЖЕ СУЩЕСТВУЕТ, КОПИРОВАТЬ ?") Q:YES<1 0
 D Copy^%ZAPM.bs.BSF8(PART,NP,1) Q 1
 Q
C N %BS,Tmp,Qu D CM^%ZAPM.bs.BSF6
 Q
 ;-------------------------- 
 ;D INIT^%ZAPM.bs.BSChW ;ПЕРВОНАЧАЛЬНАЯ ИНИЦИАЛИЗАЦИЯ КОМПЛЕКСА
CACHERUN ;МОДУЛЬ ЗАПУСКА ПРИ КАЖДОЙ ЗАГРУЗКИ %BS В CACHE'
 I '$D(GREEN) D VAR^%ZAPM.bs.BSCh
 i $e($io,1,5)="|TCP|" S %BS(43)="W /CUP($Y,$X+1) W !" //это не ТЕЛНЕТ, TCP - сокетS
 I '$D(^%ZAPM.bs.BSETUP("OPTION")) D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSCDFLT(""N17"")","^%ZAPM.bs.BSETUP(""OPTION"")")
 i $tr($$ZV^%ZAPM.bs.BSCp,".")>200812||($p($$ZV^%ZAPM.bs.BSCp,".",1)>2008) s %BS(2008)=1
 if $zversion(1)=3 s %BS(2008)="1L" ;!msw
 Q
ver() Q +$G(^%ZAPM.bs.BS)_"."_$P($P(^%ZAPM.bs.BSC4,"@",2),"Version :",2)
PROT D Tex^%ZAPM.bs.BSMSMF("TermLogin",$G(U)_","_$G(BSR)_","_$G(BST)_","_$G(EDIT)_","_$G(MODE)_","_$G(BSLOGIN)_","_$G(BSSES))
 Q
ErrBST D Tex^%ZAPM.bs.BSMSMF("ErrorTerm="_$ze,$G(BSG,"?")_","_$G(BSROU)_","_$ZN_","_$ZU(5)_","_$G(%KEY("MGWLPN"),"?")_","_$s_","_$G(BSSES))
ErrBST1 N SAY I $D(BST),$ZE["<NOLINE" S SAY="Нет метки "_$P($G(BST),"^")_" в программе "_$P($G(BST),"^",2)_"."
 I $D(BST),$ZE["<NOROUTINE>" S SAY="Нет программы "_$G(BST)_"."
 D ER^%ZAPM.bs.BSF($G(SAY)_" Произошла Ошибка ! "_$$ZE())
 G KL
BST(U,BSR,BST,EDIT,MODE,BSLOGIN,BSSES) //Альтернативный вход в ТАБЛИЦУ
 N %intZAP,%intFK,ONS 
 D CC,DBL ;PLUS("%Bs"_BSLOGIN)
 S ONS=$ZU(5) W /CUP(1,1),$J("",999),# //ЧИСТКА ПЕРВЫХ СТРОК
 I $G(U)=1 D ^%ZAPM.bs.BSC G KL
 I $G(U)'="",'$$ZU^%ZAPM.bs.BSF4(U) D ^%ZAPM.bs.BSC G KL
 I BSR="$",BST="$" s $zt="ErrBST" W !,"...загружаем объекты "_U D PROT,GLO(U) G KL
 I BSR="#" s $zt="ErrBST1" D PROT D  G KL
 .I $$CFG^%ZAPM.bs.BSCp="ASU",$$ZU^%ZAPM.bs.BSF4("PRG") D VAR^BSe
 .D @BST
 I $G(BSR)="" D ^%ZAPM.bs.BSC G KL
 I $E(BSR,1)'="^" S BSR="^"_BSR
 I '$$Data^%ZAPM.bs.BSF12(BSR) D ^%ZAPM.bs.BSC G KL
 I BST="$" s $zt="ErrBST" D PROT,PARTIT^%ZAPM.bs.BSF12(BSR) G KL
 I '$$Data^%ZAPM.bs.BSF12($NA(@BSR@(BST))) D ^%ZAPM.bs.BSC G KL
 D PROT s $zt="ErrBST"
 I $G(EDIT)=0 D
 .N EDIT,ONS I '$P(@BSR@(BST),"@",16) S %intZAP=1,$P(@BSR@(BST),"@",16)=1
 .I $P(@BSR@(BST),"@",15)'="" S %intFK=$P(@BSR@(BST),"@",15),$P(@BSR@(BST),"@",15)=""
 .D
 ..I $G(MODE)=1 D  Q
 ...S W132=$P(@BSR@(BST),"@",10,11),$P(@BSR@(BST),"@",10,11)="45@132"
 ...S P132=$P(@BSR@(BST),"@",50) I P132 S O132=$P(@BSR@(BST),"@",19),$P(@BSR@(BST),"@",19)=P132
 ...D
 ....N %intZAP,%intFK,W132,P132,O132,EDIT,MODE
 ....D ^%ZAPM.bs.BST132
 ...I $D(W132) S $P(@BSR@(BST),"@",10,11)=W132
 ...I $D(O132) S $P(@BSR@(BST),"@",19)=O132
 ..D
 ...N %intZAP,%intFK,W132,P132,O132,EDIT,MODE
 ...D ^%ZAPM.bs.BST
 .I $D(%intZAP) S $P(@BSR@(BST),"@",16)=""
 .I $D(%intFK) S $P(@BSR@(BST),"@",15)=%intFK
 I $G(EDIT)=1 D
 .N EDIT,ONS D ^%ZAPM.bs.BST
 I $G(ONS)'="",'$$ZU^%ZAPM.bs.BSF4(ONS)
ERror G KL
DBL I BST["^^" S BST=$$TR^%ZAPM.bs.BSsFUNM(BST,"^^","^")
 Q
IP(S) N (S) D MAINVAR^%ZAPM.bs.BSC4
 I $D(BDSES),$D(@BDSES@(S)) Q $G(@BDSES@(S,"IP"))
 Q ""
CCC S %BS(40)=$G(BSSES,$J),%BS(41)=$$IP(%BS(40))
 ;I $D(%BS(39))'[0,$O(@%BS(39)@("-0",""))'="" S %BS(1)=$O(@%BS(39)@("-0",""))
 I '$D(GREEN) D VAR^%ZAPM.bs.BSCh
 Q
CC N APP,TOBD,GC
 S TOBD="^%ZAPM.bs.BSC(""PROTECT"")",GC=$$KBD^%ZAPM.bs.BSF12(TOBD)
 S APP=$$PROTECT^%ZAPM.bs.BSCp($G(BSLOGIN),"","NAV",1)
 D   D CLr^%ZAPM.bs.BSF4,EMUL,CCC
 .S (%BS(37),%BS(12))=BSLOGIN I "1"'[APP D  Q
 ..S %BS(39)=APP D CCC
 .I $D(^%ZAPM.bs.BSETUP("SETUP")) S %BS(1)=$P(@$ZR@(20,2),"@",15) Q
 .S %BS(1)="00000100001101001100" //DFLT
 Q
KL W $$atr^%ZAPM.bs.BS3(0) D EXIT^%ZAPM.bs.BS ;MINUS("%Bs"_BSLOGIN)
 R *R:1 H
n() Q $G(%BS(3),$P)_$J_"u"_%BS(15)
init d iniT^%ZAPM.bs.BSChW
q
 // for  do $$r^%ZAPM.bs.BSC(999) if R1=13 quit
r(R) O 0:(:"IS")
 R *R1:R,*R2:0,*R3:0,*R4:0,*R5:0 
 w !,"==="_R1_" "_R2_" "_R3_" "_R4_" "_R5,!
 q 1
 ///z 
 /*
 Вход в таблицу по ^NEW  S IYI="^PART(TAB" D NE^%ZAPM.bs.BSN         см 1.  
   c сохранением видео -    или                                             
    картинки               D Table^%ZAPM.bs.BSN(BSR,BST)   возвращает  YES, гд
                 YES=1@2@3@4@5@6@7@8@9    - статус выхода из таблицы          
                 1=Y,X - номер клетки                                         
                 7 - координата клетки по строке                              
                 8 - координата клетки по колонке                             
                 4,5,6 - скан коды                                            
                 9 - данные лежащие в этой клетке      

   Вход в таблицу  без      S BSR="^PART",BST="TAB"             см 1.         
   сохpанения видео         D ENTER^%ZAPM.bs.BSN                              
                                                                              
   Вывод сообщений об       S ls="ТЕКСТ ОШИБКИ" D O^%ZAPM.bs.BSF7  или        
   ошибке                   D ErrMsg^%ZAPM.bs.BSXfun("ТЕКСТ ОШИБКИ")          
                                                                              
   Вывод простого сообщения D OkMsg^%ZAPM.bs.BSXfun("ТЕКСТ")                  
                                                                              
   Меню  ДА/НЕТ             S ls="ВЫ УВЕРЕНЫ ?" D YES^%ZAPM.bs.BSF"      YES=1
                                                                              
   Сообщение о действии     S ls="ТЕКСТ" D WAITS^%ZAPM.bs.BSF2          X WA-с
                            D Wait^%ZAPM.bs.BSXfun("ТЕКСТ")                   
                                                                              
   Сообщение "ЖДИТЕ..."     WAIT^%ZAPM.bs.BSF2           
  Строковый редактор  S ls="Text"                                             
                       S li="строка"                        li-результат      
                       S ll="запрещенные символы"            YES=0 отмена     
                       D LE^%ZAPM.bs.BSS                                      
                              или                                             
                       S li=$$LineEdit^%ZAPM.bs.BSXfun("СТРОКА","ТЕКСТ")      
                                                                          
                                                                              
ВХОД В РЕДАКТОР ГЛОБАЛИ   D ^%ZAPM.bs.BSMSMG("^A(1,2,3)")                     
          ИЛИ ЛОКАЛИ      D ^%ZAPM.bs.BSMSMG("XXX")         
                  ER D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($>


 */
 /// do FOR^%ZAPM.bs.BSCp - клавиши
 /// D INIT^%ZAPM.bs.BSChW ;ИНИЦИАЛИЗАЦИЯ КОМПЛЕКСА
 /// do ^%ZAPM.bs.BSC - Навигация по областям и глобалям
 /// do ^%ZAPM.bs.BSMSMG("^A(1,2,3)")	- Редактор глобалов
 /// ИЛИ ЛОКАЛИ      D ^%ZAPM.bs.BSMSMG("XXX")
 /// do ^%ZAPM.bs.BSXprog - Редактор программ
 /// do ErrMsg^%ZAPM.bs.BSXfun("ГЛЯ - !!"_$ZE) - вывод текста об ошибке
 /// F  D READM^%ZAPM.bs.BSre W !
 ///
 /// d Exports^%ZAPM.bs.BSC("d:\_proj\_zapp\zpm-addition+\zapm-")
 ///
 /// d Exp2016^%ZAPM.bs.BSC("d:\_proj\_zapm\ENS2016\")
 /// 
Exp2016(dir) // 
	set slash=$select($zversion(1)=3:"/",1:"\")
	s ed="editor"
	k list
	set dirpath=dir_"src"_slash_"xml"_slash
	s list("%ZAPM.bs.*.GBL")=""
	do $system.OBJ.Export(.list,dirpath_"_ZAPM.bs.gbl.xml","d",.err) 
	k list
	s list("%ZAPM.bs.*.MAC")=""
	do $system.OBJ.Export(.list,dirpath_"_ZAPM.bs.mac.xml","d",.err) 
	k list
	s list("%ZAPM.*.INC")=""
	do $system.OBJ.Export(.list,dirpath_"_ZAPM.bs.inc.xml","d",.err) 
 q
Exports(dir) // d Exports^%ZAPM.bs.BSC("d:\_proj\_zapp\zpm-addition+\zapm-")
	set slash=$select($zversion(1)=3:"/",1:"\")
	s ed="editor"
	do Exp(dir_ed_slash,,,"BSpg")
	;for d="globals,MSM","routine,BSXpr","text,BSX","table,BST" {
	;	s di=$p(d,",")
	;	s mask=$p(d,",",2)
	;	do Exp(dir_di_"-"_ed_slash,mask,0)
	;}
	do Exp(dir_"tkweb"_slash,"pgWEB","pgWEB")
	do Exp(dir_"tkimail"_slash,"pgWEM","pgWEM")
 q
Exp(dir,mask="",glomask="",isk="") ;d Exp^%ZAPM.bs.BSC("d:\_proj\_zapp\zpm-addition+\zapm-editor\")
	new $namespace
	set $namespace="%SYS"
	set slash=$select($zversion(1)=3:"/",1:"\")
	set dirpath=dir_"src"_slash_"mac"_slash_"_ZAPM"_slash_"bs"_slash
	s st=##class(%File).CreateDirectoryChain(dirpath)
	i 'st w !,st q
 	do ##class(%File).RemoveDirectoryTree(dirpath)
	;Rou
	set r=""
	for { set r=$O(^ROUTINE(r)) q:r=""  continue:r'["%ZAPM.bs."
		if mask'="",r'[mask continue 
		if isk'="",r[isk  continue
		set file=$tr(r,"%","_")_".mac"
		Set st = $System.OBJ.ExportUDL(r_".mac",dirpath_file,"-d")
		s rou(r_".mac")=""
		if 'st w !,st q
		else  w !,file
	}
	;Glo
	if 0,glomask'=0 {
		kill gl
		set dirpath=dir_"src"_slash_"gbl"_slash
		d GetGlobalDir^%ZAPM.bs.BSCp($namespace,.gl)
		s i=""
		for { s i=$o(gl(i)) q:i=""  continue:i'["%ZAPM.bs."
			if glomask'="",i'[glomask continue
			k list
			s list(i_".GBL")=""
			do $system.OBJ.Export(.list,dirpath_"_"_$e(i,2,*)_".xml","d",.err) 
		}
	}
	k list
	set dirpath=dir_"src"_slash_"gbl"_slash
	s list("%ZAPM.bs.*.GBL")=""
	do $system.OBJ.Export(.list,dirpath_"_ZAPM.bs.xml","d",.err) 
	
	kill list
	set dirpath=dir_"bs"_slash
		do $system.OBJ.Export(.rou,dirpath_"_ZAPM.bs.mac.xml","d",.err) 
	zw err
	kill list
	set dirpath=dir_"bs"_slash
	;m list=rou
	s list("%ZAPM.bs.*.GBL")=""
	do $system.OBJ.Export(.list,dirpath_"_ZAPM.bs.gbl.xml","d",.err) 
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4" type="MAC" languagemode="0"><![CDATA[
%BSC4 ; Портал B4I ; 14:50 12.01.2003
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 Q
RUN ;Выполнение
 S $ZT="ErrRun^%ZAPM.bs.BSC4"
 D %KEY,MAINVAR
 I '$D(BSLABEL) W RED,$$LNG("Не определена метка выполнения",32),EF Q
 ;КОНТРОЛЬ И БИЛИНГ
 I $G(BSNSP)'="" D UCI($G(BSNSP))
 I $D(@BDREF@(BSRoutineId,"Name")) D  Q
 .S BDREQ=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""RouReq"")"),BDREQ1=$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)
 .S @BDREQ@(BDREQ1,"Ref")=BSRoutineId,@BDREQ@(BDREQ1,"IP")=CurUS,@BDREQ@(BDREQ1,"Time")=$H //ЗДЕСЬ МОЖНО СЧИТАТЬ ТРАФИК
 .D RU(BSLABEL_"^"_$G(@BDREF@(BSRoutineId,"Name")))
 .K @BDREQ@(BDREQ1)
 W RED,$$LNG("Некооректная переменная BSRoutineId=",33),BSRoutineId,EF
 Q
ErrRun S $ZT="",ze=$p($ZE,"^")  W RED,"Error: "_$$TRa^%ZAPM.bs.BSCh0(ze),EF,BBK
 Q
RU(%ZName) ;ЗАПУСК ПОЛЬЗ. ПРОГРАММЫ
 N %KEY,%CGI,%CGIEVAR,BDTAR,BDREF,BDREQ,BDREQ1,BDPIN,BDUSE,BDSES,GTmp,%BS,%ZCS,%zT,CMND
 N MGWCHD,MGWEBP,MGWJSP,MGWLPN,MGWNSP,MGWPWD,MGWUCI,MainOpt,NSPACE,ROU,TIMEOUT,X,bsg,bsd
 ;N BDDIC
 D @%ZName
 Q
LNG(ID,nu) i $d(nu) Q:$G(@BDDIC@(nu,$E($G(BSLNG,"RUS"),1)))="?" ID Q @$ZR
 Q $G(@BDDIC@(ID,$E($G(BSLNG,"RUS"),1)),ID)
MAIN ;ГОЛОВНАЯ ПРОГРАММА - ДИСПЕТЧЕР
 ;S $ZT="ErrRun^%ZAPM.bs.BSC4"
 D %KEY
 D MAINVAR
 I $G(%KEY("UZN"))'="" D:$$ZU^%ZAPM.bs.BSF4(%KEY("UZN")) ^dispatcher Q
 I $P($P($G(^%ZAPM.bs.BSC4("ADV")),"@",1),":",2)["Portal" D REMONT("Информационный портал") Q
 I $G(BSSES)'="",'$$EnablSess() D CLOSEWIN("#"_BSSES_". "_$$LNG("Текущая сессия закрыта. Открывайте новую сессию.",34)) Q
 I '$D(BSLABEL) W "Не определена программа !"   D l^%ZAPM.bs.BSCp2 Q
 S BSLABEL=$$%^%ZAPM.bs.BSCh(BSLABEL)
 D UCI($G(BSNSP))
 //I $G(BSPART)["~" S BSPART=$$%^%ZAPM.bs.BSCh(BSPART)
 I $G(BSLABEL)'="" D  Q
 .;I $G(BSLABEL)'["^" D @BSLABEL Q
 .I $G(BSLABEL)["N%" S BSLABEL=$$TR^%ZAPM.bs.BSsFUNM(BSLABEL,"N%","^%") D @BSLABEL Q
 .;I $G(BSLABEL)["^%ZAPM.bs.BS" 
 .D @BSLABEL Q
 .W $$LNG("Запрещенная метка 'BSLABEL'...",174)_$G(BSLABEL)_"!!!"
 W $$LNG("Нет переменной 'BSLABEL'...",36)
 Q
UCI(BSNSP) Q:BSNSP="" "?"
 I BSNSP["~" Q $$ZU^%ZAPM.bs.BSF4("%"_$E(BSNSP,2,99))
 I BSNSP'["~" Q $$ZU^%ZAPM.bs.BSF4(BSNSP)
 Q "?"
 //$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bzOUTtables","V","^[""%SYS""]BSC4.ISS.Setup") //ТИПОВОЙ ВЫЗОВ ОБЩЕСИСТЕМНЫХ ПАРАМЕТРОВ
MainOpt() N t    S t=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Acfg")
 I t="" S t="^%ZAPM.bs.BSETUP(""CFG"")"
 Q t
MAINVAR ;ОСНОВНЫЕ ПЕРЕМЕННЫЕ ПОРТАЛА
 S MainOpt=$$MainOpt
 ;```I '$D(BStyle) 
 S BStyle=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"CurCSS")
 I '$D(GREEN) D VAR^%ZAPM.bs.BSCh
 S NAVIG=$G(%CGIEVAR("HTTP_USER_AGENT"))
 S BDDIC=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""DICT"")")
 S BDREF=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""RouRef"")")
 S BDPIN=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PIN"")")
 S BDUSE=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")") ;W RED_111_$G(BDUSE,"?")_222_EF
 S BDSES=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")")
 S BDTAR=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""TARIFF"")")
 S BSDOMAIN=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bb4y1") 
VARI     S (%BS(41),CurUS)=$$ADDRIP
 S GTmp=$NA(^["%SYS"]mtempBD4(CurUS))
 S HTTPREF=$G(%CGIEVAR("HTTP_REFERER"))
 I $D(BSSES) S %BS(40)=BSSES
 I $D(BSLOGIN) S %BS(12)=BSLOGIN
 S %BS(24,1)=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""PROTOKOL"")")
 Q
EnablSess() ;КОНТРОЛЬ СЕССИЙ
 I $D(@BDSES@(BSSES)),$G(BSLOGIN)=$G(@BDSES@(BSSES,"NM")),$G(CurUS)=$G(@BDSES@(BSSES,"IP")),$G(@BDSES@(BSSES,"CHR"))="" S @BDSES@(BSSES,"CUR")=$H D  Q 1
 .S @BDSES@(BSSES,"COUNT")=$G(@BDSES@(BSSES,"COUNT"))+1
 Q 0
%KEY N I,II,J  S I="" F  S I=$O(%KEY(I)) Q:I=""  D
 .;S $ZT="%ErKey" 
 .I $D(%KEY(I))>1 D  Q
 ..I $D(%KEY(I,$O(%KEY(I,""),-1)))=1 S @I=%KEY(I,$O(%KEY(I,""),-1)) Q
 ..S II="",J="",JJ=$O(%KEY(I,""),-1) I JJ="" S @I="" Q
 ..F  S II=$O(%KEY(I,JJ,II)) Q:II=""  S J=J_%KEY(I,JJ,II)
 ..S @I=J
 .I $E(I)'?1N S @I=%KEY(I)
 I $G(BSLNG)="" S BSLNG="RUS"
 K BSROU,BSNSPACE
 Q
%ErKey Q
BEG1 ;i $d(zBEG1) q
 D GRA N BSGRANT
 i '$D(BK) D VAR^%ZAPM.bs.BSCh
 W "<HTML><HEAD>"_BK ;_"<LINK REL=""SHORTCUT ICON"" HREF=""http://localhost:1962/b4y/b4y.ico"">"	
 s zBEG1=1 //флаг о том, что заголовок уже выведен 
 w $$STYLE
 Q
First2 ;H 1
First ;ПЕРВАЯ УГЛОВАЯ СТРАНИЦА
 S Frame="LeftUp"
 D BEG1
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function ReSet() {",BK
 S BSLABEL="L1"
   w "parent.L1.location='"_$$ADDBSGET()_"';",BK
 S BSLABEL="U1"
   ;w "alert(parent.U1.name);"
   w "parent.U1.location='"_$$ADDBSGET()_"';",BK
 S BSLABEL="D1"
   w "parent.D1.location='"_$$ADDBSGET()_"';",BK
 W "}",BK
 W "</script>",BK
 D UGOL(1)
 S II=BSLNG,BSLABEL="First"
 I $$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"MultiL") D
 .W "<p align='center'><font size=1 face='Arial, Helvetica, MS Sans Serif'>"
 .F I="RUS","ENG" d  ;,"GER","FRA" D
 ..N BSLNG W " "
 ..I II=I W I
 ..E  S BSLNG=I W "<A HREF='",$$ADDBSGET(),"'>",I,"</A>"
 ..W " "
 .W EF,"</p>"
 W "</span>"
 D END
 q
UGOL(O)     W "</HEAD>",BK
 W "<BODY "_$S(O:"onload='ReSet();'",1:"")_">" // background='"_BSDOMAIN_"/logo/ugol.gif'>",BK
 N IP,IP1,IP2 S IP1="" //$$LNG("P")
 S IP=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"IP") I IP'="" S IP1=IP
 S IP2=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"B4I")
 i IP1'="" S IP1="<font size=1 face='Arial, Helvetica, MS Sans Serif'>"_IP1_EF //_BBK
 S IP2=BLUE_"<big><strong>"_IP2_"</strong></big>"_EF //__BBK
 N BD,z,GR1L,GR1B S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""GRAND"")")
 s BSGRANT=$G(BSGRANT,"DFLT") I $G(BSGRANT)="" s BSGRANT="DFLT"
 S z=$$GetVar^%ZAPM.bs.BSC4("GRANT") I z'["ERROR",z'="" S BSGRANT=z
 S GR1L=$G(@BD@(BSGRANT,"TXTLITL")),GR1B=$G(@BD@(BSGRANT,"TXTBIG"))
 I GR1L'="" S IP1=GR1L
 I GR1B'="" S IP2=GR1B
 W "<span id=Ugol >"
 I $G(BSframe) d @("UGOL"_BSframe)
 E  w "<table border=0 width=100%><tr><td align=center>"_IP1_"</td></tr><tr><td align=center>"_IP2_"</td></tr></table>"
 Q
END W "</BODY></HTML>",BK
 Q
RECURS(S) Q:S=""  ;РЕКУРСИВНЫЙ МОДУЛЬ ВЫЧЛЕНЕНИЯ НЕПЕРЕСЕКАЮЩИХСЯ АТОМАРНЫХ ГРАНДОВ
 N FFF
 I S'["," D  Q
 .I $G(@BD@(S,"Z1"))'="" D RECURS($G(@BD@(S,"Z1"))) Q
 .I $G(@BD@(S,"MENU"))'="" I '$D(FF(S)) S F=$G(F)+1,F(F)=S,FF(S)=""
 F FFF=1:1 Q:$P(S,",",FFF,FFF+1)=""  D RECURS($P(S,",",FFF))
 Q
GRA N BD,z,GR1S S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""GRAND"")")
 s BSGRANT=$G(BSGRANT,"DFLT") I $G(BSGRANT)="" s BSGRANT="DFLT"
 S z=$$GetVar^%ZAPM.bs.BSC4("GRANT") I z'["ERROR",z'="" S BSGRANT=z
 S GR1S=$G(@BD@(BSGRANT,"STYLE"))
 I GR1S'="" S BStyle=GR1S
 Q
L1 ;ЛЕВЫЙ ФРЭЙМ
 N Cm,FF,F,BD
 S Frame="LeftDn"
 D BEG1
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""GRAND"")")
 s BSGRANT=$G(BSGRANT,"DFLT") I $G(BSGRANT)="" s BSGRANT="DFLT"
 S z=$$GetVar^%ZAPM.bs.BSC4("GRANT") I z'["ERROR",z'="" S BSGRANT=z
 S Cm=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Commerce")
 W "</HEAD><DIV id=BodyL1 >"
 //w "<BODY TEXT=#8F8F8F LINK=#000095 VLINK=#460080 ALINK=BLUE>",BK
 w "<BODY TEXT=black LINK=black VLINK=black ALINK=black>",BK
 
 d RECURS(BSGRANT) I '$D(F)  W "Грант: "_RED_$G(BSGRANT)_EF_" - пустой!"
 N BSGRANT 
 
 I $G(BSframe) d @("Top"_BSframe)
 e  W "<H3><table border=0>" D LA1,LAend
 
 s I="" F  S I=$O(F(I)) Q:I=""  i F(I)'="" D  S BSmenuID=F(I) D @PMENU
 .S PMENU=$G(@BD@(F(I),"MENU")),PREM=$G(@BD@(F(I),"REM")),PTITLE=$G(@BD@(F(I),"TITLE"))
 .S PPROG=$G(@BD@(F(I),"PROG")),PWRITE=$G(@BD@(F(I),"WRITE")),PTOPIC=$G(@BD@(F(I),"TOPIC"))
 .S PTOPIC1=$G(@BD@(F(I),"TOPIC1")),NSP1=$G(@BD@(F(I),"NSP"))
 .I PMENU="" S PMENU="zerro^%ZAPM.bs.BSC4b"
 
 I $G(BSframe) d @("TopEnd"_BSframe)
 e  D LA1,LAend W "</table>" W "</H3>"
 D JS^%ZAPM.bs.BSCp
 	w "var Prev1='1';"_BK
 	W "function Cur(tt)",!
	W "    {",!  
	//w "alert(11);"_BK
	W "        if (Prev1=='2') {Prev.className = 'TopMenuNorm';}"_BK
	//W "        tt.className = 'TopMenuSel';"_BK
	//W "        tt.style.color='white';"_BK
	W "        Prev=tt; Prev1='2';",!
	W "    };",!
	W "function MOver(t) {",!
	W "     if (t.className!='TopMenuSel') {t.className = 'TopMenuOver';}"_BK
	W "    };",!	
	W "function MOut(t) {",!
	W "     if (t.className!='TopMenuSel') {t.className = 'TopMenuNorm';}"_BK
	W "    };",!	
	W "function MDown(t) {",!
	W "     if (t.className!='TopMenuSel') {t.className = 'TopMenuSel'; Cur(t);} "_BK
	W "    };",!	
 D JSE^%ZAPM.bs.BSCp
 w "<br>" 
 I $G(BSframe)="" D FOO("footer")
 W ""
 W "</BODY></DIV></HTML>"
 Q
mouse() n q s q=" ONMOUSEOVER='MOver(this);' ONMOUSEOUT='MOut(this);' ONMOUSEDOWN='MDown(this);' " 
	//ONMOUSEUP="this.className = 'ParamOver';"> 
	q q
FOO(HTML) S gr=$G(^%ZAPM.bs.BS("Config",HTML)) I gr="" D
 .D BSdebug
 .I $G(BSdebug) d logo
 .D COPYR
 E  W AF_"Конфигурация :"_RED_$$CFG^%ZAPM.bs.BSCp_EF_""_EF_"<BR><BR>" W gr
 Q
BSdebug I $G(BSdebug),$d(BSLOGIN),'$$GRA^%ZAPM.bs.BSCGIS(BSLOGIN,"zDebug") K BSdebug
 Q
LA1 I $G(BSframe) d @("LA1"_BSframe)
 E  W "<TR><TD class=s3> </TD><TD class=s3><font size=4 face='Arial, Helvetica, MS Sans Serif'><b>"
 Q
LA(TOP,ENABLE,IMG) ;ВЫВОД ПУНКТА
 D LA1
 S BSLABEL=TOP
 I '$G(ENABLE) W "<div class=TopMenuDis id='"_F(I)_"'>"_$G(IMG)_$$LNG(TOP)_"</div>" g LAend
 S BSTOP=TOP
 W "<span id='"_F(I)_"'><A class=TopMenuNorm "_$$mouse()_" HREF='"_$$ADDBSGET_"' target='U1' "_$$title(TOP)_">"_$G(IMG)_$$LNG(TOP)_" </A><span>" ;,BBK
LAend I $G(BSframe)  d @("LAend"_BSframe)
 E  W "</b></font></TD><TD class=s3> </TD></TR>"_BK
 Q
mR I $G(BSNOREG)="0" D LA("reg",$G(BSSES))
 Q
reg D BSTOP Q
reg2 D ^%ZAPM.bs.BSC4reg
 Q
mH D LA("docum",1,"<img src='"_BSDOMAIN_"/img/help1.gif' border=0 title='Документация разработчика' >") q
docum D BSTOP Q
docum2 D help
 Q
mSCO //попробуем без этого режима  D LA^%ZAPM.bs.BSC4($S($G(BSSES)'="":"Sclose",1:"Sopen"),1,$S($G(BSSES)'="":"<img border=0 src='"_BSDOMAIN_"/img/exit.gif'>",1:"<img border=0 src='"_BSDOMAIN_"/img/open.gif'>"))  
 I $G(BSSES)'="" D
 .N BSnewREG S BSnewREG=1
 .D LA^%ZAPM.bs.BSC4("Sopen",1,"<img border=0 src='"_BSDOMAIN_"/img/open.gif'>")  Q
 Q
Sopen D BSTOP q
Sopen2 D Sopen^%ZAPM.bs.BSC4reg
 Q
Sclose D BSTOP q
Sclose2 D CloseSes^%ZAPM.bs.BSC4reg
 Q
mA D LA("ADM",1,"<img src='"_BSDOMAIN_"/img/option.gif' border=0>") Q
ADM D BSTOP q
ADM2 D ADM^%ZAPM.bs.BSC4rout
 Q
projimg() q "<img src='"_BSDOMAIN_"/img/proj.gif' border=0>"
mP D LA("proo",$G(BSSES)'="",$$projimg) q
proo D BSTOP Q
proo2 D ^%ZAPM.bs.BSC4base
 Q
mRe I $g(Cm)=1 D LA("rent",$G(BSSES)'="")
 q
rent D BSTOP Q
rent2 D rent^%ZAPM.bs.BSC4rout
 Q
mT  I $g(Cm)=1 D LA("tariff",1)
 q
tariff D BSTOP Q
tariff2 ;тарифы
 D BEG1 N BDT,I
 W " <table border=0 width=100%>"
 W "<tr><td align='right' class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("tariff")_"</strong></td class=s3 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s3 >&nbsp;"_$$LNG^%ZAPM.bs.BSC4("T"_I)_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(24)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"D"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(25)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"PG"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(26)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"GOD"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(23)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"M"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(27)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"BD"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(28)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"ROU"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(29)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$G(@BDTAR@(I,"TRF"))_"</td>"
 W "<tr><td align='right' class=s3 >"_$$LNG^%ZAPM.bs.BSC4(30)_"</td class=s1 >" D  W "</tr>",BK
 .F I=0:1:3 W "<td class=s1 >&nbsp;"_$$LNG^%ZAPM.bs.BSC4($G(@BDTAR@(I,"PRI"),"?"))_"</td>"
 W "</table>"
 //D TXTARIF^%ZAPM.bs.BSC4reg(
 D InfoSess^%ZAPM.bs.BSC4rout
 D END
 Q
mAb I Cm=1 D LA("about",1)
 q
about D BSTOP Q
about2
 D SITE("D1",BSDOMAIN_"/about/"_$$LITL^%ZAPM.bs.BSsFUNM(BSLNG)_"/index.htm")
 Q
SITE(FRAME,URL)
 D BEG1
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function ReSet2() {",BK
 w "parent."_FRAME_".location='"_URL_"';",BK
 W "}",BK
 W "</script>",BK
 W "</HEAD>",BK
 W "<BODY onload='ReSet2();'>",BK
 D END
 Q
BSTOP1 W "<table border=0 width=100%><tr>"
 W "<td align=center width=70% class=TopHeadSel>" //<font color=#FFFFFF>"
 Q
Header(s) q "<DIV id=HeadU1 align=center class=TopHeadSel >"_s_"</DIV>"
BSTOP ;ВЫВОД ЗАГОЛОВКА В ВЕРХНЕМ ФРЭЙМЕ
 S Frame="RightUp"
 D BEG1
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function ReSet1() {",BK
 S BSLABEL=BSTOP_2
 w "parent.D1.location='"_$$ADDBSGET()_"';",BK
 W "}",BK
 W "</script>",BK
 W "</HEAD>",BK
 W "<BODY onload='ReSet1();'>"_BK // background='"_BSDOMAIN_"/logo/up.gif'>",BK
 w $$Header($s($G(BSTOP2)'="":$$LNG^%ZAPM.bs.BSC4(BSTOP2),1:$$LNG^%ZAPM.bs.BSC4(BSTOP))) g END //для ASU
 D BSTOP1
 W "<H1><DIV id=HeadU1 >"_$$LNG(BSTOP)_"</DIV></H1>" //,EF
 W "</td><td><DIV id=TabU1 ><table border=0>"
 I BSTOP="proo" D
 .n BSLABEL,A1
 .S BSLABEL="PRO^~BSC4base" W "<tr><td>"_$$A1(1)_$$LNG("проекты",37)_A1_"</td></tr>",BK
 .S BSLABEL="TAB^~BSC4base" W "<tr><td>"_$$A1(0)_$$LNG("таблицы",38)_A1_"</td></tr>",BK
 .S BSLABEL="ROU^~BSC4base1" W "<tr><td>"_$$A1(0)_$$LNG("программы",39)_A1_"</td></tr>",BK
 W "</table></DIV>"
 W "</td></tr></table>"
 D END
A1(O) S A1="</LI>" Q "<LI class=u1 style=""list-style-image: url('"_BSDOMAIN_"/logo/open"_O_".gif')"" OnClick=""parent.D1.location='"_$$ADDBSGET()_"';"">"
U1 ;ВЕРХНИЙ ФРЭЙМ
 S Frame="RightUp"
 D BEG1
 W "</HEAD><BODY>"_BK // background='"_BSDOMAIN_"/logo/up.gif'>",BK
 ;W "<table border=0 width=100%><tr><td align=center width=70% class=s3><font color=#FFFFFF><H1><DIV id=HeadU1 >",$$LNG(0)," ",$$LNG(1)_EF_"</DIV></H1></B></font></td><td><DIV id=TabU1 ><table border=0></table></DIV></td></tr></table>"
 w $$Header($$LNG(0)_" "_$$LNG(1))
 D END
 Q
D1 ;НИЖНИЙ ФРЭЙМ
 S Frame="RightDn"
 D BEG1
 W "</HEAD><BODY>",BK
 I $g(Cm)=1 W $$LNG(2),"<br><br>" D  D D11 I 1
 .//_$$LNG(4)_" "_$$GetAllVisit^%ZAPM.bs.BSCh("R","B4Y")_"<br>"_$$LNG(3)," ",$$GetAllVisit^%ZAPM.bs.BSCh("Q","B4Y"),"<br>"
 E  W $$LNG(333),"<br><br>"
 N GetAccLU I $G(BSLOGINDFLT)'="" I $$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGINDFLT,"Aautoreg")!($G(@BDUSE@(BSLOGINDFLT,"REG"))=1) D  //ВКЛ АВТОРЕГИСТРАЦИЯ
 .D JS^%ZAPM.bs.BSCp
 .n BSLOGIN,BSLABEL S BSLOGIN=BSLOGINDFLT,BSLABEL="SopenP^~BSC4reg",BSPASS=$G(BSPASS)
 .w "parent.D1.location='"_$$ADDBSGET()_"';"_BK
 .D JSE^%ZAPM.bs.BSCp
 D InfoSess^%ZAPM.bs.BSC4rout,END
 Q
D11 w "<br>",$$LNG(5),"<br><br>",$$LNG(6),"<br>" q
title(ID) n i s i=$G(@BDDIC@(ID,"t"_$E(BSLNG,1)))
 i i="" q ""
 Q "title='"_i_"'"
BSPARVAR(A,B) //ВОССТАНОВИТЬ ПЕРЕМЕННЫЕ
 N I F I=1:1 Q:$P(A,"@",I,I+1)=""  S @$P(A,"@",I)=$P(B,"@",I)
 Q I
BSADDVAR() //СОБРАТЬ ВСЕ ПЕРЕМЕННЫЕ
 N %zz1,%zz0,%zz2,%zz3,II
 S %zz1="",%zz1=$O(@%zz1)
 S II="",x="" F  Q:%zz1=""  D:%zz1'["%zz"  S %zz1=$O(@%zz1)
 .I "11"[$D(@%zz1),$E(%zz1,1,2)="BS" S x=x_%zz1_"@",II=II_@%zz1_"@"
 S I=x Q II
ADDRIP() N CurUS //АДРЕС УДАЛЕННОГО КЛИЕНТА
 S CurUS=$G(%CGIEVAR("REMOTE_ADDR"),$G(BSLOGIN,"?")) I CurUS="" S CurUS="?"
 Q CurUS
ADDSN() i $G(%("HOST:"))'="" Q $G(%("HOST:"))  //ИМЯ СЕРВЕРА С ПОРТОМ, Без порта $ZU(110)
  Q $$ipS^%ZAPM.bs.BSCp2  //ip сервера
ADDLIB()  I $G(MGWLIB)="" d
 .i $G(%("HOST:"))'="" S MGWLIB="/?BSTKWEB%20" q  ;TK-WEB
 .S MGWLIB="/scripts/mgwms32.dll"                 ;WEBLINK
 Q $G(MGWLIB)_"?"
ADDBSGET(%zz4,%zz8) ;ДОБАВИТЬ ВСЕ BS-ПЕРЕМЕННЫЕ
 N %zz1,%zz0,%zz2,%zz3,I,II,%zz7
 S II=$$addbs()
 Q $$ADDLIB()_"BSG=B4"_$G(%zz4,"I")_II_%zz7
addbs()  I $G(%zz8)'="" N BSLABEL S BSLABEL=$TR(%zz8,"%","~")
 S %zz1="",%zz1=$O(@%zz1),%zz7="" I $G(MGWSTO) S %zz7="&MGWSTO="_MGWSTO
 S II="" F  Q:%zz1=""  D:%zz1'["%zz"  S %zz1=$O(@%zz1)
 .I "11"[$D(@%zz1),$E(%zz1,1,2)="BS",%zz1'="BSG" S II=II_"&"_%zz1_"="_@%zz1
 Q II
addb(%zz4,%zz8) ;ДОБАВИТЬ ВСЕ BS-ПЕРЕМЕННЫЕ
 N %zz1,%zz0,%zz2,%zz3,I,II,%zz7
 Q $$addbs()
logo ;логотип
 W AF_"Конфигурация :"_RED_$$CFG^%ZAPM.bs.BSCp_EF_""_EF_"<BR><BR>"
 I $g(Cm)=1 W $$logo2 Q
 W $$logo1
 Q
logo2() Q "<a href='http://www.intersystems.ru' target='_new'>"_$$logo1_"</a>"_"<br>"_BK
logo1() Q "<img src='"_BSDOMAIN_"/logo/logo.gif' alt='InterSystems' border=0>"
COPYR W "<p align='left'><font size=1 face='Arial, Helvetica, MS Sans Serif'>",BK
 I BSLNG="RUS" W BLUE_"<div title='"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"ENDUSER")_"'>""Нужное не сложно,<br>Сложное не нужно"".<br></div>"_EF
 E  W BLUE_"""Necessary it is not difficult,<BR>Difficult it is not necessary"".<BR>"_EF
 W "<br>",BK S YY=$P($P($G(^%ZAPM.bs.BSC4),"от",2),"-") I YY="" S YY="2005"
 W $$News("&copy; 1993 -"_YY_". %BS-Portal")_"<br>"
 I $g(Cm)=1      W "&copy; 1993-"_YY_". "_$S(BSLNG="RUS":"Сергей В. Михайленко",1:"Serge W. Mikhaylenko")_"<br>"
 I BSLNG="RUS" W "Все права защищены<br>Версия "
 E  W "All Rights Reserved<br>Version "
 W $$ver^%ZAPM.bs.BSC_"<br>"_BK
 N A S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin") S BSend2mail=$ZCONVERT($P($P(A,"<",2),"@"),"U")
 W "e-mail: <a href='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"SMTP1^~BSvdaMAIL")_"' target=new title='Послать письмо админиcтратору портала'>"_$P(A,"<",1)_"</a>"
 W $P(A,">",2)
 I $g(Cm)=1 w "<br>phone: +7 (095) 361-8735"
 W "</p>"_BK
 /*      I $D(BSSES) D  //НЕ ПОЛУЧИЛСЯ ФОКУС
 .W "<script LANGUAGE='JavaScript' EVENT='onunload()' FOR='window'>"_BK
 .S BSLABEL="CloseSession^~BSC4reg" W "open('"_$$ADDBSGET()_"','Dummy','width=1,height=1');",BK
 .W "</script>"_BK */
 ;S NoDetal=1 d InfoSess^%ZAPM.bs.BSC4rout
 Q
HelpPortal() N I ; N GetAccLU I $D(BSLOGIN),$$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGIN,"BSDA")>2 S I=" <a class=u1 onclick='open("""_$$ADDLIB^%ZAPM.bs.BSC4()_"BSG=B4&BSLABEL=Navigator&BSLNG=RUS&BSNSP=~SYS&BSPRO=DOC&BSRoutineId=839116428"","""",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1")_",status=1,resizable=1"");'><img src='"_BSDOMAIN_"/img/edithelp.gif' ALT='EditHelpPortal' border=0></a>"
 Q $G(I)_"<li><a class=u1 onclick='open("""_$$ADDLIB^%ZAPM.bs.BSC4()_"BSG=B4&BSLABEL=ViewTree&BSLNG=RUS&BSNSP=~SYS&BSPRO=DOC&BSRoutineId=2441218863"","""",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1")_",status=1,resizable=1"");' ><img src='"_BSDOMAIN_"/img/help.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4(" Схемы функционирования и информация о функциях, программных модулях и внутренних переменных необходимых для разработки пользовательских проектов'",42)_"' border=0></a>"
 ;HelpCOS() q "<li><a href='"_BSDOMAIN_"/docs/olr/olrrefTOC.html' title='Cach&eacute; ObjectScript Language Reference' target='_new1'>HelpCOS</a>"
 ;HelpSQL() q "<li><a href='"_BSDOMAIN_"/docs/sqr/sqlreference.html' title='Cach&eacute; SQL Reference' target='_new2'>Cach&eacute;SQL</a> <a href='"_BSDOMAIN_"/docs/err/errsql.html' title='Cach&eacute; SQL Errors' target='_newE'>SQL Errors</a>"
HelpCache() Q "<li><a href='http://"_$P($$ADDSN^%ZAPM.bs.BSC4(),":")_":"_$s($$ZV^%ZAPM.bs.BSCp>5:8,1:1)_"972/csp/docbook/DocBook.UI.Page.cls' title='Online Full Documentation' target='_new5'>Полная документация по СУБД Cache'</a> "
HelpCacheClass() q "<li><a href='http://"_$P($$ADDSN^%ZAPM.bs.BSC4(),":")_":"_$s($$ZV^%ZAPM.bs.BSCp>5:"8972/csp/documatic/%25CSP.Documatic.cls",1:"1972/apps/documatic")_"' title='Online Class Documentation' target='_new5'>Class Documentation</a> "_$$LNG^%ZAPM.bs.BSC4(" Докуметация Классов СУБД Cache'",47)
HelpDhtml() q "<li><a href='"_BSDOMAIN_"/docs/html4spec/index.html' title='"_$$LNG^%ZAPM.bs.BSC4("Спецификация",40)_" HTML 4.0' target='_new3'>DHTML</a>"
HelpJS() q "<li><a href='"_BSDOMAIN_"/docs/javascript/index.htm' title='"_$$LNG^%ZAPM.bs.BSC4("Спецификация",40)_" JavaScript' target='_new4'>JavaScript</a>"
News(n) I $G(BSLOGIN)="" Q n
 I '$$GRA^%ZAPM.bs.BSCGIS(BSLOGIN,"zDebug") Q n
 n BSfile S BSfile="http://"_$$ADDSN^%ZAPM.bs.BSC4()_BSDOMAIN_"/docs/BS-Portal_Release_notes.txt"
 q "<a href='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"GETTXT^~BSC4")_"' target=new TITLE='Что нового в комплексе'>"_n_"</a>"
BSDOC  w "<li>"_$$News("BS-Portal_Release_notes"),BBK,BBK
 S BSfile="http://"_$$ADDSN^%ZAPM.bs.BSC4()_"/vv/bsdoc/BS_Release_notes.txt"
 w "<li><a href='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"GETTXT^~BSC4")_"#GOend' target=new TITLE='новости в комплексе до 9 версии для MSM'>Новости до 9 версии (Система MSM)</a> "
       W "<a href='http://"_$$ADDSN^%ZAPM.bs.BSC4()_"/vv\bsdoc\index.htm' target=new TITLE='Официальная документация %BS - Терминальный режим для MSM до 9 версии'>Официальная документация %BS</a>"
 Q
help ;
 D BEG1 W "<title>Документация по порталу для разработчика</title></HEAD>"_$$B27^%ZAPM.bs.BSCm4()
 w !,"<li>Комплекс %BS<ul>" D BSDOC
 W !,"<LI>"_$$mBSDOC1^%ZAPM.bs.BSC4b_BBK,BBK
 w !,"<li>"_$$BsDoc^%ZAPM.bs.BSC4b("Докуметация по комплексу %BS")_BBK,BBK
 W !,$$HelpPortal,"Докуметация BS-портала",BBK,BBK ;http://localhost:1972/CSP/MSW/Bsdoc.csp
 W !,"<li><a href='http://"_$P($$ADDSN^%ZAPM.bs.BSC4(),":")_":"_$s($$ZV^%ZAPM.bs.BSCp>5:8,1:1)_"972/csp/msw/Bsdoc.csp' title='Online BS-Doc' target='_new9'>Online BS-Doc</a> "
 W !,"<li><a href='http://"_$P($$ADDSN^%ZAPM.bs.BSC4(),":")_":"_$s($$ZV^%ZAPM.bs.BSCp>5:8,1:1)_"972/csp/msw/BsLib.csp' title='Online BS-Lib' target='_new99'>Online BS-Lib</a> "
 ;W !,$$HelpCOS,$$LNG^%ZAPM.bs.BSC4(" Описние языка программирования в СУБД Cache'",43),BBK,BBK
 ;S UR="http://"_$$ADDSN^%ZAPM.bs.BSC4()_BSDOMAIN_"/docs/Kirsten-Cache-book/index.htm",A=$$HTTP^%ZAPM.bs.BSCmail(UR) I $P(A," ",2)=200 D
 ;.w !,"<a href='"_UR_"' title='Книга В.Кирстена' target='_ne4'><img border=0 src='"_BSDOMAIN_"/img/cos.gif'> СУБД Cache' объектно-ориентированная разработка приложений</a>",BBK,BBK
 ;W !,$$HelpSQL,$$LNG^%ZAPM.bs.BSC4(" Описние SQL в СУБД Cache'",44),BBK,BBK
 W !,"</ul>",$$HelpDhtml,$$LNG^%ZAPM.bs.BSC4(" Спецификация HTML 4.0",45),BBK,BBK
 W !,$$HelpJS,$$LNG^%ZAPM.bs.BSC4(" Спецификация JavaScript",46),BBK,BBK
 w !,"<li><a href='"_BSDOMAIN_"/docs/tags.chm' title='Помощь по HTML и CSS' target='_ne4'>Помощь по HTML и CSS. © 1999-2002 А.Климов</a>",BBK,BBK
 W !,$$HelpCache,BBK,BBK
 W !,$$HelpCacheClass,BBK,BBK
 W !,"<li><a href='http://"_$P($$ADDSN^%ZAPM.bs.BSC4(),":")_":"_$s($$ZV^%ZAPM.bs.BSCp>5:8,1:1)_"972/csp/samples/menu.csp' title='Online CSP Sample Menu' target='_new6'>CSP Sample Menu</a> ",$$LNG^%ZAPM.bs.BSC4(" Примеры применения технологии Cache'ServerPages",48),BBK,BBK
 D symbol^%ZAPM.bs.BSpgBS
 D InfoSess^%ZAPM.bs.BSC4rout
 Q
GETTXT n tmp,AA,OK,S1,S2
 D BEG1^%ZAPM.bs.BSC4  W $$B27^%ZAPM.bs.BSCm4()
 I $ZCONVERT($E(BSfile,1,4),"L")="http" D  Q:'$D(tmp)
 .S OK=$$HTTP^%ZAPM.bs.BSCmail(BSfile,2,.AA) I $P(OK," ",2)'=200 Q
 .M tmp=AA("Data")
 E  D File2Arr^%ZAPM.bs.BSCEXE($TR(BSfile,"/","\"),.tmp) 
 W "<PRE><TT>"
 S tmp="" F  S tmp=$O(tmp(tmp)) Q:tmp=""  D
 .I '$D(S1),$$IFDOS^%ZAPM.bs.BSHTML1(tmp(tmp)) D INIT^%ZAPM.bs.BSre(1)
 .W $TR(tmp(tmp),$G(S1),$G(S2))
 W "</TT></PRE><A NAME='GOend'></BODY></HTML>"
 Q
meta() ;^^^q "<meta http-equiv=""Content-Type"" content=""text/html; charset=windows-1251"">"
 q "<meta http-equiv=""Content-Type"" content=""text/html; charset=utf-8"">"
STYLE() ;СТИЛИ
 N Q
 I $G(BStyle)'="" S:$D(BStyleOver) BStyle=BStyleOver  N %ZName S Q=$$GetDirectTabN1^%ZAPM.bs.BSC4r("[""%SYS""]BSC4.CFG","FrameStyle",BStyle,"MainS")_BK_$$GetDirectTabN1^%ZAPM.bs.BSC4r("[""%SYS""]BSC4.CFG","FrameStyle",BStyle,$G(Frame,"RightDn")) I Q'="" Q Q
 S Q=$$meta()_BK
 S Q=Q_"<style type=""text/css"">"_BK
 S Q=Q_"body { scrollbar-face-color:#E4E4E4; scrollbar-shadow-color: #B4B4B4;"_BK
 S Q=Q_"scrollbar-highlight-color: #B4B4B4; scrollbar-3dlight-color:#E4E4E4; scrollbar-darkshadow-color:BLACK;"_BK
 S Q=Q_"scrollbar-track-color: #B4B4B4; scrollbar-arrow-color: #B4B4B4; "_BK
 S Q=Q_"}"_BK
 //S Q=Q_"Body { BackGround-Image: url("_BSDOMAIN_"/img/fon1.gif); BackGround-Repeat: repeat;  }"_BK
 S Q=Q_"TD.s1 { BACKGROUND: #E4E4E4; }"_BK
 S Q=Q_"TD.s2 { BACKGROUND: #B4B4B4; }"_BK
 S Q=Q_".u1 { color:blue; text-decoration:underline; cursor:hand;  }"_BK
 S Q=Q_"</style>"
 Q Q
SetVar(Name,Val)  N A S A=$$CheckVar() I 'A Q A
 S @BDSES@(BSSES,"VAR",Name)=Val
 Q 1
GetVar(Name,DFLT) N A S A=$$CheckVar() I 'A Q A
 Q $G(@BDSES@(BSSES,"VAR",Name),$G(DFLT))
CheckVar() I $G(BSSES)="" Q "!ERROR BSSES"
 I $G(BDSES)="" Q "!ERROR BDSES"
 I $G(Name)="" Q "!ERROR NameVariable"
 Q 1
REMONT(NA) s BStyleOver="GKVVBLUE" D BEG1
 Write "<title>"_NA_" - ремонтные работы </title></head><body><center>"_BK
 Write "<h2> Ресурс '"_NA_"' временно недоступен.</h2>"_BK
 Write "<hr>"_BK
 Write "<p align=""center"">Проводятся ремонтные работы. За допонительной информацией обращайтесь"_BK
 Write " по тел. 27-04.</p>"_BK
 Write "<table border=""0"" cellspacing=""0"" cellpadding=""0"">"_BK
 Write "<tr><td align=""left""><img src=""/iss/img/constr1.gif"" WIDTH=""16"" HEIGHT=""16""></td><td align=""right""><img src=""/iss/img/constr1.gif"" WIDTH=""16"" HEIGHT=""16""></td></tr>"_BK
 Write "<tr><td align=""center"" colspan=""2""><img src=""/iss/img/constr2.gif"" WIDTH=""459"" HEIGHT=""28""></td></tr>"_BK
 Write "</table>"_BK
 Write "<p>&nbsp;</p>"_BK
 Write "<p align=""center"">ИВЦ</p>"_BK
 Write "<hr></center></body></html>"_BK      D END
   Q     
CLOSEWIN(SAY,CL) D BEG1^%ZAPM.bs.BSC4
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function ReSet() {",BK
 W "status='Status :CloseWin:'"_BK
 W "alert('"_SAY_"."_$$LNG(" Окно браузера будет закрыто.")_"');"_BK
 I $G(CL)'=0 W "parent.window.close();"_BK
 W "}",BK
 W "</script>",BK
 W "</HEAD>",BK
 W "<BODY onload='ReSet();'>",BK
 D END
 Q
RUNTIME
 ;S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb") I A'="" K MGWLIB S %("HOST:")=$ZU(110)_":"_A D  Q
 ;.D JS^%ZAPM.bs.BSCp
 ;.w "var=parent.location;"_BK //...И ТАК ДАЛЕЕ 
 ;.;--- ПОДМЕНА В url       http://home/scripts/mgwms32.dll?        НА      http://home:82/?BSTKWEB%20?
 ;.D JSE^%ZAPM.bs.BSCp
 ;.;D locvar^%ZAPM.bs.BSCh0("",1) //1 - выводить %KEY,%CGI,%ZCS,%CGIEVAR
 w $$meta() 
    s zlABEL=$G(^%ZAPM.bs.BS("Config","Frame"),"LogoL1U1D1")
    I zlABEL'="" D  D @zlABEL G RUNTIME2
    .I zlABEL'="LogoL1U1D1",$$CbaseNS^%ZAPM.bs.BSCp //перейти в базовый нс
    E  D LogoL1U1D1   
RUNTIME2    W "</html>"_BK
    Q
LogoL1U1D1 w "<title>"_$ZU(110)_" (Информационный Портал)</title></head>"_BK //СТАНДАРТНАЯ
 w "<frameset framespacing='0' border='false' frameborder='0' cols='*,82%'>"_BK
     w "<frameset framespacing='0' border='false' frameborder='0' rows='1,90,*'>"_BK //0!!!
     s BSLABEL="First" //добавь в урл   BSNOREG=0&BSBBS=NewPin
     N BSLOGIN S BSframe=""
      w "<frame name='WORK' SCROLLING='no'>"_BK //noresize //WORK для WAKAVIKI
      w "<frame SRC='"_$$ADDBSGET_"' name='logo' SCROLLING='no'>"_BK //noresize
      W "<frame name='L1' SCROLLING='auto'>"_BK //
     W "</frameset>"_BK
    W "<frameset  framespacing='0' border='false' frameborder='0' rows='30,*'>"_BK //
     W "<frame name='U1' marginheight=0 marginwidth=0  SCROLLING='no'>"_BK ////для ASU
     W "<frame name='D1' SCROLLING='auto'>"_BK //
    W "</frameset>"_BK
    W "</frameset>"_BK
 Q
NewLogoL1U1D1 //НОВАЯ
   w "<frameset framespacing='0' border='false' frameborder='0' rows='0%,7%,15%,*'>"_BK
     s BSLABEL="First" //добавь в урл   BSNOREG=0&BSBBS=NewPin
      N BSLOGIN S BSframe="1"
       w "<frame name='WORK' SCROLLING='no'>"_BK //noresize //WORK для WAKAVIKI
      w "<frame SRC='"_$$ADDBSGET_"' name='logo' SCROLLING='no'>"_BK //noresize
      W "<frame name='L1' SCROLLING='auto'>"_BK //
     
    W "<frameset  framespacing='0' border='false' frameborder='0' cols='*,80%'>"_BK //
     W "<frame name='U1' SCROLLING='auto'>"_BK //
     W "<frame name='D1' SCROLLING='auto'>"_BK //
    W "</frameset>"_BK
   W "</frameset>"_BK
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4base" type="MAC" languagemode="0"><![CDATA[
%BSC4base ; пpогpамма управления БД ; 14:38   17.09.2002
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
PRO ;ПРОЕКТЫ
 W BK,BK
 D pin
 D BEG1^%ZAPM.bs.BSC4  Q:pi=""
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="ActPR01^~BSC4base"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
   W "<div align='right'>" 
      S BSLABEL="ENTER^~BSC4cfg" W " <a class=u1 onclick='open("""_$$1^%ZAPM.bs.BSC4rout("CfgPro","^"_pi)_""","""",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWO1")_",status=1,resizable=1"");' >"_$$param_"</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
   W $$HelpB
   S BSLABEL="help^~BSC4" W " <a class=u1 onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWO1")_",status=1,resizable=1"");' ><img src='"_BSDOMAIN_"/img/help1.gif' ALT='Документация DHTML, JavaScript, COS, SQL, Errors'></a> "
   W "</div>"_BK
 W "<table border=0 width=100%>"
 W "<tr><td class=s1 width=5%>"_$$projimg^%ZAPM.bs.BSC4_RED_$G(BSPRO)_EF_"</td><td class=s1  width=75%><strong>"_$$LNG^%ZAPM.bs.BSC4("ПРОЕКТЫ",50)_"</strong></td><td class=s1  width=20%></td></tr>",BK
 N I,N,BD,Sort
 S Sort=+$$GETOPT^%ZAPM.bs.BSC4cfg("^"_pi_"(""CfgPro"")","Sort1") I 'Sort S Sort=-1
 W "<tr><td class=s3 title='"_pi_"'>"_$$LNG^%ZAPM.bs.BSC4("ИМЯ",51)_"</td><td class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ОПИСАНИЕ ПРОЕКТОВ",52)_"</td><td class=s3 ></td></tr>"
 I '$D(@("^"_pi_".PRO")) S @$ZR="" W RED_$ZR_EF_" "_$$LNG^%ZAPM.bs.BSC4("Нет проектов ! Обратитесь к Администратору",53) g PROe
 W "<tr><td class=s1 ><input type=""text"" size=8 maxlength=8 name='Proj' value='"_$$NewProj("NewProj")_"'></td><td class=s1 > " D OPro() W "</td><td class=s1 >" W "<input type=""submit"" name=""newOK"" value='&gt;&gt;"_$$LNG^%ZAPM.bs.BSC4("Создать проект",54)_"'></td></tr>",BK
 S N="",I=0,Co=0
 F  S N=$O(@("^"_pi_".PRO")@(N),Sort) Q:N=""  D
 .S Co=Co+1
 .W "<input type=""hidden"" name='Proj"_Co_"' value="""_N_""">"
 .W "<tr><td class=s1 >"_N_"</td><td class=s1 ><input type=""text"" size=40 maxlength=148 name='Desc"_Co_"' value='"_$G(@("^"_pi_".PRO")@(N,"REM"))_"'></td><td class=s1 >" W "<input type=""submit"" name='ActOK"_Co_"' value='&gt;&gt;'>" D ACT W "</td></tr>"
 W "<input type=""hidden"" name='ProjCount' value="""_Co_""">"
PROe  W " </table>"
 W "</form>"
 D InfoSess^%ZAPM.bs.BSC4rout,END^%ZAPM.bs.BSC4
 Q
param() q "<img src='"_BSDOMAIN_"/img/opt.gif' width=2% ALT='"_$$LNG^%ZAPM.bs.BSC4("настройка",49)_"'>"
NewProj(N) N NN ;НОВОЕ ИМЯ ПРОЕКТА
 F NN=1:1 I '$D(@("^"_pi_".PRO")@(N_NN)) Q
 Q N_NN
OPro() N I,P,T,BD ;ВСЕ ПРОЕКТЫ ДОСТУПНЫЕ КАК ШАБЛОН
 W "<select name=""newPR"" size=1>"
 W "<option value=''>"_$$LNG^%ZAPM.bs.BSC4("взять за основу ...",55)_"</option>"
 I $D(@GTmp@(BSLOGIN,"PRO")) W "<option value='"_$ZR_"'>"_$$LNG^%ZAPM.bs.BSC4("Копировать из буфера",56)_"</option>"
 W "<option value='1'>"_$$LNG^%ZAPM.bs.BSC4("Импорт из ODBC",57)_"</option>"
 W "<option value='2'>"_$$LNG^%ZAPM.bs.BSC4("Связь с ODBC",58)_"</option>"
 W "<option value='4'>----- "_$$LNG^%ZAPM.bs.BSC4("Типовые проекты",322)_"</option>"
 s IC=+$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Conc")
 S I="",BD="^[""%SYS""]BSC4.CFG.Projects"
 F  S I=$O(@BD@(I)) Q:I=""  D
 .I $E(I,1)="*",'IC Q  //КОНКУРСНЫЕ ПРОЕКТЫ ОТМЕНИТЬ
 .W "<option value='"_I_"'>"_$G(@BD@(I,"Descr"),"*?")_"</option>"
 ;W "<option " W " value='DOCUM'>"_$$LNG^%ZAPM.bs.BSC4("Документация",59)_"</option>"
 ;W "<option " W " value='*DOCUM*'>"_$$LNG^%ZAPM.bs.BSC4("*СтатСчетчик")_"</option>"
 ;W "<option " W " value='*DOCUM*'>"_$$LNG^%ZAPM.bs.BSC4("*Гост.Книга")_"</option>"
 ;W "<option " W " value='*DOCUM*'>"_$$LNG^%ZAPM.bs.BSC4("*ЧатКомната")_"</option>"
 ;W "<option " W " value='*DOCUM*'>"_$$LNG^%ZAPM.bs.BSC4("*Анкетирование")_"</option>"
 ;W "<option " W " value='*DOCUM*'>"_$$LNG^%ZAPM.bs.BSC4("*ПрайсЛисты")_"</option>"
 ;S P="^%ZAPM.bs.BSC4E" W "<option " W " value='"_$NA(@P)_"'>"_$P($G(@P),"@",2)_"</option>"
 ;.I I=+$G(T) W "selected"
 I 'IC Q  //КОНКУРСНЫЕ ПРОЕКТЫ ОТМЕНИТЬ
 W "</select>"
 W "<select name=""Complet"" size=1>"
 W "<option value=''></option>"
 W "<option value=''>"_$$LNG^%ZAPM.bs.BSC4("Конкурсные проекты")_"</option>"
 W "<option value=''>...</option>"
 W "</select>"
 Q
ActPR01 ;ДЕЙСТВИЕ С ПРОЕКТОМ
 D pin
 I $D(newOK) G CreatPro
 F I=1:1:$G(ProjCount) I $D(@("ActOK"_I)) Q
 I $D(@("Proj"_I)) D
 .I $G(@("Act"_I))=2 D KILLPRO^%ZAPM.bs.BSC4rout(pi,@("Proj"_I)) G PRO
 .I $G(@("Act"_I))=1 D EditP(@("Proj"_I)) Q
 .I $G(@("Act"_I))=3 D CopyP2B(@("Proj"_I)) G PRO
 Q
TR(S) Q $TR(S,$C(34)_"@'","`^`")
IntEditPro(pi,P) S I=1,Desc1=$G(@("^"_pi_".PRO")@(P,"REM")) D EditP(P) //внутренняя точка входа для редактирвания проекта
 Q
EditP(P) N x     S BSPRO=P,@BDSES@(BSSES,"PROJ")=P
 I $G(@("^"_pi_".PRO")@(P,"REM"))'=@("Desc"_I) S @("^"_pi_".PRO")@(P,"REM")=$$TR(@("Desc"_I))
 N %ZName S %ZName="^"_pi_"." S x=$$GetDirectTabN1^%ZAPM.bs.BSC4r(BSPRO,"Param","NOTE","V") I x="" S x=$$GetDirectTabN1^%ZAPM.bs.BSC4r(BSPRO,"Param","NOTE","Val")
 W x
 D TAB G ROU^%ZAPM.bs.BSC4base1
CreatPro ;СОЗДАТЬ ПРОЕКТ
 i $d(@("^"_pi_".PRO")@(Proj)) W $$LNG^%ZAPM.bs.BSC4("Проект с именем",60)," '",RED,Proj,EF,"' ",$$LNG^%ZAPM.bs.BSC4("уже существует",61),BK G:$G(newPR)="" PRO G MERGE^%ZAPM.bs.BSC4r2
 I $G(newPR)="" D NEWPRO^%ZAPM.bs.BSC4rout(Proj,$$LNG^%ZAPM.bs.BSC4("ПРОЕКТ ДЛЯ ",317)_"`"_BSLOGIN_"`")
CreatMERG D pin
 I $G(newPR)="4"  w RED,$$LNG^%ZAPM.bs.BSC4("Типовые проекты находятся ниже",323),EF G PRO
 I $G(newPR)="1"  D ODBC2P(Proj) q
 I $G(newPR)="2"  D ODBC2P(Proj) q
 I $G(newPR)=""  G PRO
 N BDP,PP,PP1,PP2 S BDP="^[""%SYS""]BSC4.CFG.Projects"
 I $D(@BDP@(newPR)) D  G PRO
 .S PP=$G(@BDP@(newPR,"Prog"),"*?"),PP1=$G(@BDP@(newPR,"Descr"),"*?")
 .s PP2=$G(@BDP@(newPR,"Request"),"*?"),PP3=$G(@BDP@(newPR,"Award"),"*?"),PP4=$G(@BDP@(newPR,"Conc"),"*?")
 .I PP'="*?" D @(PP_"(pi,Proj)")
 D COPYPRO(newPR,Proj)
 G PRO
CreatNewPro(a,b) s IC=+$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Conc")
 w "<H3>",RED,$$LNG^%ZAPM.bs.BSC4("Типовые проекты находятся в стадии разработки"),EF,"</H3>" I 'IC Q
 w "<H3>",RED,$$LNG^%ZAPM.bs.BSC4(" и выставлены на конкурс"),EF,"</H3>"
 w BBK,RED,$$LNG^%ZAPM.bs.BSC4("Название проекта"),EF," :","<br>",$G(PP1),"<br>"
 w BBK,RED,$$LNG^%ZAPM.bs.BSC4("Требуемый функционал проекта"),EF," :","<br><PRE>",$G(PP2),"</PRE><br>"
 w BBK,RED,$$LNG^%ZAPM.bs.BSC4("Условия конкурса"),EF," :","<br><PRE>",$G(PP4),"</PRE><br>"
 w BBK,RED,$$LNG^%ZAPM.bs.BSC4("Награда 3 победителям"),EF," :","<br>",$G(PP3),"<br>"
 q
COPYPRO(newPR,p) ;КОПИРОВАТЬ ПРОЕКТ ИЗ БУФЕРА В НОВЫЙ
 N pin S pin=pi_"."_p
 D Copy^%ZAPM.bs.BSF8($P(newPR,""")")_".ROU"")","^"_pin_".ROU")
 M @("^"_pin)=@newPR
 S N="" F  S N=$O(@("^"_pin)@(N)) Q:N=""  I $P($G(@("^"_pin)@(N)),"@",17)=2 D
 .S @("^"_pin)@(N,"Compile")="Create "_$$TD
 .S @("^"_pin)@(N,"KEY")="^"_pin_"."_N
 .I $D(@("^"_pin)@(N,"GLOBAL")) M @("^"_pin_"."_N)=@("^"_pin)@(N,"GLOBAL") K @("^"_pin)@(N,"GLOBAL")
 S @("^"_pi_".PRO")@(p,"REM")=$P($G(@newPR),"@",2)
 Q
CopyP2B(BSPRO,DEST) ;КОПИРОВАТЬ ПРОЕКТ В БУФЕР
 N pin,N
 S pin=pi_"."_BSPRO I '$D(DEST) S DEST=$NA(@GTmp@(BSLOGIN))
 K @DEST@("PRO"),@DEST@("PRO.ROU")
 ;M @DEST@("PRO.ROU")=@("^"_pin_".ROU")
 S N="" F  S N=$O(@("^"_pin_".ROU")@(N)) Q:N=""  D R2B^%ZAPM.bs.BSC4base1(N,$NA(@DEST@("PRO.ROU",N)))
 M @DEST@("PRO")=@("^"_pin)
 S p="" F  S p=$O(@("^"_pin)@(p)) Q:p=""  I $P($G(@("^"_pin)@(p,"B4I")),"@",2) D  ;И ДАННЫЕ ТОЖЕ ПОЛОЖИТЬ
 .M @DEST@("PRO",p,"GLOBAL")=@(@("^"_pin)@(p,"KEY"))
 Q
DSN() I $G(DSN)="" W $$LNG^%ZAPM.bs.BSC4("Вы не определили 'Data Sours Name'",62),BK Q 0
 Q 1
TABODBC I TABODBC="" W $$LNG^%ZAPM.bs.BSC4("Вы не определили ТАБЛИЦУ",63) G TAB
 I '$$DSN G TAB
 D Tab2TOBD^%ZAPM.bs.BSCBD(DSN,$G(USER),$G(PASS),TABODBC,TOBD) K:$D(ErroR) @TOBD
 I $D(ODBCD),'$D(ErroR) J JTB2TOBD^%ZAPM.bs.BSCBD(DSN,$G(USER),$G(PASS),TABODBC,TOBD)
 I '$D(ErroR) W BK,$$LNG^%ZAPM.bs.BSC4("Таблица из ODBC источника будет создана в фоновом режиме",64)
 G TAB
ODBC ;ЗАГРУЗКА ПРОЕКТА ИЛИ ТАБЛИЦЫ
 N ErroR,part,PxPUSTO
 I $D(TABODBC) G TABODBC
 I '$$DSN G PRO
 D NEWPRO^%ZAPM.bs.BSC4rout(Proj,"ПРОЕКТ из ODBC `"_DSN_"`") S part="^"_pin
 I $D(ODBCD) J JOBODBS(DSN,$G(USER),$G(PASS),part)
 I $D(ODBCS) D
 .D Stream1^%ZAPM.bs.BSCBD(DSN,$G(USER),$G(PASS),part)
 .D PART2BSD^%ZAPM.bs.BSCRG(part) i $G(Errors) W !,"Произошла ошибка конвертации таблиц",!,BK q
 I '$D(ErroR) W BK,$$LNG^%ZAPM.bs.BSC4("Проект из ODBC источника будет создан в фоновом режиме",65)
 G PRO
JOBODBS(DSN,USER,PASS,part) ;DEMON ДЛЯ ВСЕГО ДСН-ПРОЕКТА+ДАННЫЕ
 D Stream^%ZAPM.bs.BSCBD(DSN,$G(USER),$G(PASS),part,"")
 Q
ODBC2P(Proj,TOBD) ;импортировать из ODBC
 n aa,Cm D pin   D BEG1^%ZAPM.bs.BSC4
 W "<div align='right'>"_$$HelpB_"</div>"_BK
 S Cm=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Commerce")
 s aa=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"ImportODBC")
 I $G(newPR)="2" s aa=0 ;пока так - это линк
 I $G(newTP)="2" s aa=0 ;пока так - это линк
 i 'aa D
 .I Cm=1 W $$LNG^%ZAPM.bs.BSC4("Режим связи или импорта таблиц из ODBC источников доступны при тарифном плане КОРПОРАТИВНЫЙ, или при согласовании условий с администратором при тарифном плане ПРОФЕССИОНАЛЬНЫЙ.",66) Q
 .E  W $$LNG^%ZAPM.bs.BSC4("Режим связи не включен в данной версии")
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 W "<input type=""hidden"" name='Proj' value="""_Proj_""">"
 I $G(TOBD)'="" W "<input type=""hidden"" name='TOBD' value='"_TOBD_"'>"
 S BSLABEL="ODBC^~BSC4base"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<table border=0 width=100%>"
 W "<tr><td  width=30% align='right' class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Имя DSN",67)_"</td><td align='left' class=s1 ><input type=""text"" size=20 maxlength=48 name='DSN' "_$s('aa:"disabled",1:"")_" value=''></td></tr>"
 W "<tr><td align='right' class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Имя пользователя",68)_"</td><td  align='left' class=s1 ><input type=""text"" size=20 maxlength=48 name='USER' value=''></td></tr>"
 W "<tr><td align='right' class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Пароль",69)_"</td><td  align='left' class=s1 ><input type=""text"" size=20 maxlength=48 name='PASS' value=''></td></tr>"
 I $G(newTP)=1 W "<tr><td align='right' class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Таблица",70)_"</td><td  align='left' class=s1 ><input type=""text"" size=20 maxlength=48 name='TABODBC' value='"_Table_"'></td></tr>"
 W " </table>"
 W "<input "_$s('aa:"disabled",1:"")_" type=""submit"" name='ODBCS' value='"_$$LNG^%ZAPM.bs.BSC4("Загрузить только структуру таблиц",71)_"'><br>",BK
 w "<input type=""submit"" "_$s('aa:"disabled",1:"")_" name='ODBCD' value='"_$$LNG^%ZAPM.bs.BSC4("Загрузить структуру и данные таблиц",72)_"'><br><input type=""reset"" name='ESC' value='"_$$LNG^%ZAPM.bs.BSC4("отмена",73)_"'>",BK
 W "</form>"_BBK d BACK^%ZAPM.bs.BSCh
 D InfoSess^%ZAPM.bs.BSC4rout,END^%ZAPM.bs.BSC4
 q
pin I $G(BSPRO)="",$G(BSSES)'="" S BSPRO=$G(@BDSES@(BSSES,"PROJ"))
 i '$d(pi) D
 .I $G(BSPIN)'="" S pi=BSPIN Q
 .S (BSPIN,pi)=$g(@BDUSE@(BSLOGIN,"PIN")) //?????
 S pin=pi_"."_$G(BSPRO,"DFLT")
 S BSNSP=$G(@BDPIN@(BSPIN,"NSP"),$ZU(5)) I $ZU(5)'=BSNSP I $$ZU^%ZAPM.bs.BSF4(BSNSP) //ТО ПЕРЕШЛИ //?????
 Q
SQL(IM) S BSLABEL="MAIN^~BSCGH"
 Q "<a class=u1 onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""",""RESULT3"",""toolbar=yes,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1")_",status=1,resizable=1"");' >"_IM_"</a>"
 ///scripts/mgwms32.dll?BSG=SQL
TAB ;ВСЕ ТАБЛИЦЫ PIN
 D BEG1^%ZAPM.bs.BSC4
 D pin
 I $G(BSPRO)="" W $$LNG^%ZAPM.bs.BSC4("Сначало определите ПРОЕКТ",74) G PRO
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="ActT1^~BSC4base"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W $$SERVIS("TAB^~BSC4base","CfgTab","NWT1")
 W "<table border=0 width=100%>"
 W "<tr><td width=10% align='right' class=s1 ><strong TITLE='"_$G(BSNSP,"?")_"'>"_$$LNG^%ZAPM.bs.BSC4("ТАБЛИЦЫ",75)_"</strong></td><td width=70% class=s1 >"_$$LNG^%ZAPM.bs.BSC4("текущего проекта ",76)_RED_pin_EF_"</td><td width=20% class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Групповое действие над всеми",77)_"</td></tr>"
 N I,N,BD,Sort,WebEditDT1,NWT1
 S Sort=+$$GETOPT^%ZAPM.bs.BSC4cfg("^"_pi_"(""CfgTab"")","Sort1") I 'Sort S Sort=-1
 W "<tr><td width=10% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ИМЯ",51)_"</td><td  width=70% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ОПИСАНИЕ ТАБЛИЦЫ БАЗЫ ДАННЫХ",78)_"</td><td width=20% class=s3 >" D ACT0 W $$Che(0)_"<input type=""submit"" name='ActOK0' title='"_$$LNG^%ZAPM.bs.BSC4("Групповое действие",79)_"' value='&gt;&gt;'></td></tr>"
 S N="",I=0 I '$D(@("^"_pin)) W $$LNG^%ZAPM.bs.BSC4("Нет раздела ! Обратитесь к Администратору",80) Q
 ;
 W "<tr><td class=s1 ><input type='text' size=13 maxlength=13 name='Table' value='"_$$NewTable("NewTable")_"'></td><td class=s1 > "
 D OT() W "</td><td class=s1 >" W "<input type=""submit"" name=""newOK"" value='&gt;&gt;"_$$LNG^%ZAPM.bs.BSC4("Создать таблицу",81)_"'></td></tr>",BK
 S Co=0,NWT1=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1"),WebEditDT1=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"WebEditDT")
 F  S N=$O(@("^"_pin)@(N),Sort) Q:N=""  I $P($G(@("^"_pin)@(N)),"@",17)=2 D
 .I N="ROU"!($E(N,1)="@") Q
 .S Co=Co+1
 .W "<input type='hidden' name='Table"_Co_"' value="""_N_""">" s sta=$G(@("^"_pin)@(N,"Compile"))
 .W "<tr><td width=20% class=s1 ><a title='"_$$NameTab_"'>"_$$RedStar^%ZAPM.bs.BSC4rou($e(sta,1,2)'="OK")
 .w N_"</a></td><td class=s1 >"
 .I $e(sta,1,2)="OK" D
 ..W $$PAform^%ZAPM.bs.BSCm()
 ..W $$PAframe^%ZAPM.bs.BSCm()
 ..;W " <A title='форма редактирования таблицы' "_$$AN^%ZAPM.bs.BSCm("^"_pin,N,"T^~BSCm4")_"><img src='"_BSDOMAIN_"/img/form.gif'></A>"
 ..;W "<a title='"_$$NameTab_"'><img src='"_BSDOMAIN_"/img/const.gif'></A>"
 .W " "_$$BP1_AF_$P($G(@("^"_pin)@(N)),"@",1)_EF
 .W "</td><td class=s1 ><input type=""submit"" name='ActOK"_Co_"' value='&gt;&gt;'>" D ACT W $$Che(Co,N)_"</td></tr>"_BK
 W "<input type='hidden' name='TableCount' value="""_Co_""">"_BK
 W " </table>"_BK
 W "</form>"
 D InfoSess^%ZAPM.bs.BSC4rout D END^%ZAPM.bs.BSC4
 Q
NameTab() N S,BSLABEL,BSDJS,T,P
 I $e(sta,1,2)'="OK" S S=$$LNG^%ZAPM.bs.BSC4("не компилирована",316) Q S
 S BSLABEL="EDIT^~BSChT1",BSDJS=BSDOMAIN,P="^"_pin,T=N
 S S=$$LNG^%ZAPM.bs.BSC4("компилирована")_$P(sta,"OK",2) I 'WebEditDT1 Q S
 S S=S_"' class=u1 onclick='open("""_$$1^%ZAPM.bs.BSC4rout(T,P)_""","""",""toolbar=no,menubar=no,scrollbars=yes,"_NWT1_",status=1,resizable=1"");"
 Q S
NewTable(N) N NN ;НОВОЕ ИМЯ
 F NN=1:1 I '$D(@("^"_pin)@(N_NN)) Q
 Q N_NN
CompTab ;КОМПИЛИРОВАТЬ
 I $G(NoFON) D FTAB^%ZAPM.bs.BSC4base("^"_pin,TabName,MainOpt) Q
 J FTAB^%ZAPM.bs.BSC4base("^"_pin,TabName,MainOpt)::0 I  W $$LNG^%ZAPM.bs.BSC4("Таблица '",82)_RED,TabName,EF_$$LNG^%ZAPM.bs.BSC4("' будет откомпилирована",83),BBK I 1
 E  W $$LNG^%ZAPM.bs.BSC4("Неудачная компиляция Таблицы '",84)_RED,TabName,EF
 Q
FTAB(BSR,BST,MainOpt) ;ФОРМАТИРОВАТЬ И КОМПИЛИРОВАТЬ
 N ErroR,OK,NOKILLER,PxPUSTO
 S $ZT="ErrComp^"_$ZN
 D TAB^%ZAPM.bs.BSF1
 S PxPUSTO="" ;,NOKILLER=1
 D START^%ZAPM.bs.BSCBD($NA(@BSR@(BST)),1,"")
 Q
ErrComp S $ZT="",@BSR@(BST,"Compile")=$ZE
 Q
ErrSave S $ZT="",ze1=$p($ZE,"^")  W RED,"Error: "_$$TRa^%ZAPM.bs.BSCh0(ze1),EF,BBK
 I $G(A)'="" W "'",A,"' "_$$LNG^%ZAPM.bs.BSC4("Некорректный идентификатор",85),BBK,BBK
 G BACK^%ZAPM.bs.BSCh
 Q
helpkeywords() q " "_$$NEWIN^%ZAPM.bs.BSC4base1($$LNG^%ZAPM.bs.BSC4("Список ключевых, зарегистрированных слов",86),"1",$$LNG^%ZAPM.bs.BSC4("загрузить cписок запрещенных слов в новом окне браузера",87),"KeyWord^~BSC4r")
CtrlKeyWord(A) ;контроль на зарезервированные имена
 i $d(^%ZAPM.bs.BSC4KWD($$LITL^%ZAPM.bs.BSsFUNM(A))) W $$LNG^%ZAPM.bs.BSC4("Имя поля",88)," '",A,"' ",$$LNG^%ZAPM.bs.BSC4("зарезервировано системой",89),$$helpkeywords,BBK q 0
 q 1
SaveTab ;СОХРАНИТЬ КОРРЕКЦИЮ
 D pin
 k ze1 D SaveTab2 i $d(ze1) q
 I Y<2 W $$LNG^%ZAPM.bs.BSC4("Таблица модифицирована.",90),RED,$$LNG^%ZAPM.bs.BSC4("Но она не имеет полей !",91),EF,BK G SaveTab1
 I $D(CompTab) D CompTab G TAB
 W $$LNG^%ZAPM.bs.BSC4("Таблица модифицирована.",90),BK
SaveTab1 D Edit(TabName)
 Q
SaveTab2
 N BDorig
 S PT=$NA(@("^"_pin)@(TabName)),PR=$NA(@("^"_pin)@("ROU"))
 S $P(@PT@("B4I"),"@",1)=$S($D(SuffSave):1,1:0)
 S $P(@PT@("B4I"),"@",2)=$S($D(InsD):1,1:0)
 I '$D(@PT) W $$LNG^%ZAPM.bs.BSC4("Таблица '",82),PT,$$LNG^%ZAPM.bs.BSC4("' не существует",92),BKK ZT "errorName"
 S $ZT="ErrSave^"_$ZN
 S BD="^"_pin_"."_TabName
 I $E($G(Suff),1)="!" S BD=$E($G(Suff),2,999) I 1 S BDorig=1
 E  I $G(Suff)'="" S BD="^"_pin_"."_Suff
 ;//КОНТРОЛЬ НА ИМЕНА ПОЛЯ И ИНДЕКСЫ
 S A=BD,@A=1 i '$$CtrlKeyWord(A) ZT "errorName"
 I $D(Suff),$E($G(Suff),1)'="!" S A=Suff,@A=1
 I '$D(FCount) G Sa
 K S F I=1:1:FCount I $G(@("Field"_I))'="" S A=@("Field"_I),@A=1 D  i '$$CtrlKeyWord(A) ZT "errorName"
 .I '$D(S(A)) S S(A)="" Q
 .E  W $$LNG^%ZAPM.bs.BSC4("ИМЕНА ПОЛЕЙ НЕ ДОЛЖНЫ ПОВТОРЯТЬСЯ",93)," '",A,"'",BBK ZT "errorName"
 K A,a N TT
 I $G(Desc)'="" S $P(@PT,"@",1)=$$TR($G(Desc))
 S Y=1 F I=1:1:FCount I $G(@("Field"_I))'="" S A=@("Field"_I) D
 .S Y=Y+1
 .I '$D(@PT@(Y)) S @PT@(Y,1)=@PR@(2,1),@PT@(Y,2)=@PR@(2,2)
 .;индекс
 .I $G(@("Ind"_I))'="" S $P(@PT@(Y,2),"@",15)=@("Ind"_I),InDx=1 I 1
 .E  S $P(@PT@(Y,2),"@",15)=""
 .S $P(@PT@(Y,2),"@",17)=$$TR($G(@("Desc"_I)))
 .S $P(@PT@(Y,1),"@",15)=$$TR($G(@("Desc"_I)))
 .S TT=$G(@("TIP"_I)),$P(@PT@(Y,2),"@",21)=TT D
 ..I "86"[TT D SETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",A)),"xRO","V",1)
 ..I TT=4 D SETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",A)),"fTRN","V","$$TXTD^%ZAPM.bs.BSsFUNR(d)")
 .S $P(@PT@(Y,2),"@",18)=A
 F I=(Y+1):1 Q:'$D(@PT@(I))  K @PT@(I)
Sa ;F I="KEY","FTR","RTR","FCL","COL" K @PT@(I)
        F I="FTR","RTR","FCL","COL" K @PT@(I)
 S $P(@PT,"@",19)="2,2"
 S @PT@("DSN")="Создана B4I "_$ZD($H,3)
 I '$D(SuffSave) K @BD
 I '$D(BDorig) S @BD="BSD - MSW@"_"^"_pin_"@"_TabName
 S @PT@("KEY")=BD
 D
 .N Y D TA2BD^%ZAPM.bs.BSCRG("^"_pin,TabName,1,$G(InDx)) ;1 НЕ ПРИСВАИВАТЬ ИМЯ ПО-УМОЛЧАНИЮ
 S @("^"_pin)@(TabName,"Compile")="Save "_$$TD
 Q
TD(H) I '$D(H) S H=$H
 I H="" Q "время/дата пустое"
 ;Q H
 Q $ZT($P(H,",",2),1)_" "_$ZD(H,3)
Edit(TAB) ;РЕДАКТИРОВАТЬ
 D BEG1^%ZAPM.bs.BSC4
 ;W "рабочей области '"_$zu(5)_"' "_pin_","_TAB
 N Y,STa,SuffSave,ti,de,SuffKEY,in,AllTip
 S STa=$G(@("^"_pin)@(TAB,"Compile"))
 I STa["Begin " W $$LNG^%ZAPM.bs.BSC4("Таблица '",82)_RED,TAB,EF_$$LNG^%ZAPM.bs.BSC4("' еще компилируется",94),BBK G TAB
 W $$SERVIS("TAB^~BSC4base","CfgTab")
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="SaveTab^~BSC4base"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<table border=0 width=100%>"
   W "<input type=""hidden"" name='TabName' value="""_TAB_""">"
 W "<tr><td align='CENTER' width=40% class=s1 >"_$$LNG^%ZAPM.bs.BSC4("РЕДАКТИРОВАНИЕ ТАБЛИЦЫ",95)_"</td><td  width=60% class=s1 >"_RED_BSPRO_"."_EF_TAB_"</td></tr>",BK
 W "<tr><td width=30% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ОБЩИЕ ПАРАМЕТРЫ",96)_" "_$$ParmTab_"</td><td  width=70% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ЗНАЧЕНИЯ",97)_"</td></tr>",BK
   W "<tr><td class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Описание",98)_"</td><td class=s1 ><input type=""text"" size=45 maxlength=145 name='Desc' value='"_$P($G(@("^"_pin)@(TAB)),"@",1)_"'></td></tr>",BK
 S SuffSave=$P($G(@("^"_pin)@(TAB,"B4I"),"1"),"@",1)
 S InsD=$P($G(@("^"_pin)@(TAB,"B4I"),"1"),"@",2)
 S SuffKEY=$P($G(@("^"_pin)@(TAB,"KEY")),pin_".",2) I SuffKEY="" S SuffKEY="!"_$G(@("^"_pin)@(TAB,"KEY"))
   W "<tr><td class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Суффикс массива данных",99)_" <input type=""text"" size=10 maxlength=25 name='Suff' value='"_SuffKEY_"'></td>"
    W "<td class=s1 ><input type=""checkbox"" title='"_$$LNG^%ZAPM.bs.BSC4("",100)_"' name=""SuffSave"" value="""_SuffSave_""" "_$$ch^%ZAPM.bs.BSC4cfg(SuffSave)_" >"_$$LNG^%ZAPM.bs.BSC4("сохранять при перекомпиляции")
     W " <input type=""checkbox"" title='"_$$LNG^%ZAPM.bs.BSC4("При копировании в буфер обмена включать данные в проект")_"' name=""InsD"" value="""_InsD_""" "_$$ch^%ZAPM.bs.BSC4cfg(InsD)_" >"_$$LNG^%ZAPM.bs.BSC4("включать в шаблон проекта")_" </td></tr>",BK
   W "<tr><td class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Статус таблицы",101)_"</td><td class=s1 ><input type=""text"" size=45 maxlength=145 name='StatTab' value='"_STa_"'></td></tr>",BK
 W "</table>"
 W " <table border=0 width=100%>"
 W "<tr><td width=20% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ИМЕНА ПОЛЕЙ",102)_"</td><td  width=10% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ТИП ПОЛЯ",103)_"</td><td  width=10% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ИНДЕКС",104)_"</td><td width=* class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ОПИСАНИЕ ПОЛЯ",105)_"</td></tr>",BK
 F Y=2:1 Q:'$D(@("^"_pin)@(TAB,Y))  D
 .W "<tr><td class=s1 >" S NameField2=$P($P(@("^"_pin)@(TAB,Y,2),"@",18),"#")
 .W "<input type=""text"" tabindex='"_Y_"' size=13 maxlength=13 name='Field"_Y_"' value='"_NameField2_"'> "_$$ParmField_"</td><td class=s1 >"
 .s ti=$P(@("^"_pin)@(TAB,Y,2),"@",21) //ТИП
 .S in=$P(@("^"_pin)@(TAB,Y,2),"@",15) //ИНДЕКС
 .s de=$P(@("^"_pin)@(TAB,Y,1),"@",15) //ОПИСАНИЕ ПОЛЯ
 .d TIPS(ti) w "</td><td class=s1 >"
 .D IND(in)
 .W "</td><td class=s1 ><input type=""text"" size=45 maxlength=2000"
 .i ti=2 w " title='"_$$LNG^%ZAPM.bs.BSC4("Для поля типа Radio текст вариантов введите в описании поля, разделенными ~",106)_"' " i de'["~" s de=$tr(de," ","~")
 .i ti'=2 w " title='В описании поля в вертикальных скобках || можно ввести значение по-умолчанию' "
 .w " name='Desc"_Y_"' value='"_de_"'></td></tr>",BK
 W "<tr><td class=s1 ><input type=""text""  tabindex='"_Y_"' size=13 maxlength=13 name='Field"_Y_"' value=''></td><td class=s1 >"
  d TIPS("") w "</td><td class=s1 >"
  D IND("") W "</td><td class=s1 ><input type=""text"" size=45 maxlength=2000 name='Desc"_Y_"' value='"_$$LNG^%ZAPM.bs.BSC4("Новое описание поля",107)_"'></td></tr>",BK
 W " </table>"
 W "<input type=""hidden"" name='FCount' value="""_Y_""">"
 W "<nobr><input type=""submit"" name=""SaveTab"" title='"_$$LNG^%ZAPM.bs.BSC4("Только сохранить изменения",108)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Сохранить",109)_"'>"
 w "<input type=""submit"" name=""CompTab"" title='"_$$LNG^%ZAPM.bs.BSC4("Создать объектное и SQL представление таблицы",110)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Компилировать",111)_"'>"
 w "<input type='RESET' title='"_$$LNG^%ZAPM.bs.BSC4("Отменить текущие изменения",112)_"' name='Reset1' value='"_$$LNG^%ZAPM.bs.BSC4("Отменить",73)_"'>"
 W "</nobr></form>"
 I STa["Begin" D BACK^%ZAPM.bs.BSCh
 D InfoSess^%ZAPM.bs.BSC4rout,END^%ZAPM.bs.BSC4
 Q
TIPS(S) N i,t ;ТИПЫ ПОЛЕЙ ИЗ ТАБЛИЦЫ
 W "<select name='TIP"_Y_"'>"
 s i="" f  s i=$o(^%ZAPM.bs.BSC4TIP(i)) q:i=""  W "<option " D  W " value='"_i_"'>"_$g(^%ZAPM.bs.BSC4TIP(i,"Name"))_"</option>"
 .I i=S W "selected"
 ;I $D(AllTip) W $$AllTipProTab(S) //БЫСТРЕЕ РАБОТАТЬ С ЛОКАЛЬНЫМ МАССИВОМ ? НОСОВ!? ПРОТЕСТИРОВАТЬ ЧТО БЫСТРЕЕ!!! ПОТОМ
 ;I '$D(AllTip) W $$TipProTab(S)
 W "</select>"
 Q
IND(S) N I,T
 W "<select name='Ind"_Y_"' size=1>"
 F I="",1:1:9 W "<option " D  W " value='"_I_"'>"_I_"</option>"
 .I I=S W "selected"
 W "</select>"
 Q
Creat ;СОЗДАТЬ ТАБЛИЦУ
 i $d(@("^"_pin)@(Table)) W $$LNG^%ZAPM.bs.BSC4("Таблица с именем",115)," '",RED,Table,EF,"' ",$$LNG^%ZAPM.bs.BSC4("уже существует",61),BK G TAB
 S $ZT="ErrSave^"_$ZN
 s A=Table,@A=1  i '$$CtrlKeyWord(A) ZT "errorName"
 S $ZT=""
 I newTP=1 D ODBC2P(BSPRO,$NA(@("^"_pin)@(Table))) Q
 I newTP=2 D ODBC2P(BSPRO,$NA(@("^"_pin)@(Table))) Q  ;ПОКА ТАК
 I newTP=3 D UPLOADF^%ZAPM.bs.BSC4r3(BSPRO,pin,Table) Q
 d NewT(newTP,pin,Table)
 G TAB
NewT(newTP,pin,Table) ;новая таблица
 M @("^"_pin)@(Table)=@newTP
 I newTP'[pin S @("^"_pin)@(Table,"KEY")="^"_pin_"."_Table D
 .I $D(@newTP@("GLOBAL")) M @("^"_pin_"."_Table)=@newTP@("GLOBAL") K @("^"_pin)@(Table,"GLOBAL")
 S $P(@("^"_pin)@(Table),"@",17)=2
 S @("^"_pin)@(Table,"Compile")="Create "_$$TD
 q
AcT(A,T,NoFON) ;Групповые операции
 I A=2 D KILL(T) Q
 I A=1 S TabName=T D  ;рекомпиляция
 .N InsD,Desc,Suff,Y,PT,a,A,BD,Y,I,SuffSave,SuffKEY,FCount
 .D Group
 Q
Group S SuffKEY=$P($G(@("^"_pin)@(T,"KEY")),pin_".",2) I SuffKEY="" S SuffKEY="!"_$G(@("^"_pin)@(T,"KEY"))
 F Y=2:1 Q:'$D(@("^"_pin)@(T,Y))
 S Suff=SuffKEY
 S SuffSave=$P($G(@("^"_pin)@(T,"B4I"),"1"),"@",1) i 'SuffSave k SuffSave
 s InsD=$P($G(@("^"_pin)@(T,"B4I"),"1"),"@",2) i 'InsD k InsD
 D SaveTab2,CompTab
 Q
ActT1 ;ДЕЙСТВИЯ НАД ТАБЛИЦЕЙ
 D pin
 I $D(newOK) G Creat
 I $D(ActOK0) D  G TAB ;ГРУППОВАЯ
 .I $D(Check0) D  Q
 ..F I=1:1:$G(TableCount) D AcT($G(Act0),@("Table"_I)) ;ВСЕ
 .E  F I=1:1:$G(TableCount) I $D(@("Check"_I)) D AcT($G(Act0),@("Table"_I))
 .q
 F I=1:1:$G(TableCount) I $D(@("ActOK"_I)) Q
 I $D(@("Table"_I)) D
 .I $G(@("Act"_I))=3 D T2B(@("Table"_I)) G TAB
 .I $G(@("Act"_I))=2 D KILL(@("Table"_I)) G TAB
 .I $G(@("Act"_I))=1 D Edit(@("Table"_I)) Q
 Q
T2B(TAB,DEST) ;ТАБЛИЦУ В БУФЕР ОБМЕНА
 I '$D(DEST) S DEST=$NA(@GTmp@(BSLOGIN,"TAB"))
 K @DEST
 M @DEST=@("^"_pin)@(TAB)
 I $P($G(@("^"_pin)@(TAB,"B4I")),"@",2) M @DEST@("GLOBAL")=@(@("^"_pin)@(TAB,"KEY")) ;W $ZR КОПИРУЕМ И ДАННЫЕ
 Q
KILL(TAB) ;УДАЛИТЬ ТАБЛИЦУ
 I $$Delete^%apiOBJ(pin_"."_TAB,,.ERR)
 W $G(ERR),BK
 S BD=@("^"_pin)@(TAB,"KEY")
 K @("^"_pin)@(TAB),@BD
 W $$LNG^%ZAPM.bs.BSC4("ТАБЛИЦА",116)," '",RED,TAB,EF,"' ",$$LNG^%ZAPM.bs.BSC4("УДАЛЕНА",117),BBK,BBK
 Q
ACT0 ;ГРУППОВЫЕ ДЕЙСТВИЯ
 N I,T
 S T=1 W "<select name='Act0' size=1>"
 F I=$$LNG^%ZAPM.bs.BSC4("Рекомпилировать",118),$$LNG^%ZAPM.bs.BSC4("Удалить",119) W "<option value='"_T_"'>"_I_"</option>" S T=T+1
 W "</select>"
 Q
ACT N I,T
 S T=1 W "<select name='Act"_Co_"' size=1>"
 F I=$$LNG^%ZAPM.bs.BSC4("Редактировать",120),$$LNG^%ZAPM.bs.BSC4("Удалить",119),$$LNG^%ZAPM.bs.BSC4("Копировать в буфер",121) W "<option value='"_T_"'>"_I_"</option>" S T=T+1
 W "</select>"
 Q
OT() N I,P,T ;ВСЕ ТАБЛИЦЫ ДОСТУПНЫЕ КАК ШАБЛОН
 W "<select name=""newTP"" size=1>"
 S P="^%ZAPM.bs.BSC4E" F T="EMPTY" W "<option value='"_$NA(@P@(T))_"'>"_$$LNG^%ZAPM.bs.BSC4("Пустой шаблон",330)_"</option>"
 I $D(@GTmp@(BSLOGIN,"TAB")) W "<option value='"_$ZR_"'>"_$$LNG^%ZAPM.bs.BSC4("Копировать из буфера",56)_"</option>"
 W "<option value='1'>"_$$LNG^%ZAPM.bs.BSC4("Импорт из ODBC",57)_"</option>"
 W "<option value='2'>"_$$LNG^%ZAPM.bs.BSC4("Связь с ODBC",58)_"</option>"
 W "<option value='3'>"_$$LNG^%ZAPM.bs.BSC4("Загрузить из файла (*.txt *.csv)")_"</option>"
 S P="^[""%SYS""]BSC4.CFG" F T="Param","UStatus","Dict" W "<option value='"_$NA(@P@(T))_"'>"_$P($G(@P@(T),"?@"),"@")_"</option>"
 W "</select>"
 Q
Che(N,NN) Q "<input type=""checkbox"" title='"_$$LNG^%ZAPM.bs.BSC4("Групповая работа включая ",122)_$S(N=0:$$LNG^%ZAPM.bs.BSC4("всех",123),1:NN)_"' name='Check"_N_"' value=''>"
ALLPART(PART) ;КОМПИЛИРОВАТЬ ВЕСЬ РАЗДЕЛ B4Y
 N PP
 D MAINVAR^%ZAPM.bs.BSC4
 S pin=$P(PART,"^",2,99)
 S PP="" F  S PP=$O(@PART@(PP)) Q:PP=""  I PP'="ROU" D
 .I $P(@PART@(PP),"@",17)=2 D AcT(1,PP,1)
 Q
BP1() N G I '$P($G(@("^"_pin)@(N,"Parms")),"@",1) Q ""
 S G=$$KBD^%ZAPM.bs.BSF12($NA(@("^"_pin)@(N))) I G="" Q ""
 Q $$BP^%ZAPM.bs.BSC4cfgP("ПАРАМЕТРЫ "_N,"Редактировать параметры",G,G,1)
ParmField()
 Q $$BP^%ZAPM.bs.BSC4cfgP("Параметры "_NameField2,$$LNG^%ZAPM.bs.BSC4("дополнительные параметры поля"),"^[|~SYS|]BSC4.CFG.PropFields",$NA(@("^"_pin)@(TAB,"ParmsCell",NameField2)),1)
ParmTab()
 Q $$BP^%ZAPM.bs.BSC4cfgP("Параметры Таблицы",$$LNG^%ZAPM.bs.BSC4("дополнительные параметры таблицы"),"^[|~SYS|]BSC4.CFG.PropTables",$NA(@("^"_pin)@(TAB,"Parms")),1)
SERVIS(A1,A2,A3) N BSLABEL,Q
 S Q="<div align='right'>"_$$REFRESH(A1)_" "
 I $D(A3) S BSLABEL="ENTER^~BSC4cfg" S Q=Q_" <a class=u1 onclick='open("""_$$1^%ZAPM.bs.BSC4rout(A2,"^"_pi)_""","""",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,A3)_",status=1,resizable=1"");' >"_$$param_"</a>"
 S Q=Q_"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_$$HelpB
 S Q=Q_$$Help
 Q Q_"</div>"_BK
HelpB() Q $$SQL("<img src='"_BSDOMAIN_"/img/bssql.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4("Загрузить SQL менеджер")_"'>")
Help() S BSLABEL="help^~BSC4" Q "<a class=u1 onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""",""RESULT3"",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWO1")_",status=1,resizable=1"");' ><img src='"_BSDOMAIN_"/img/help1.gif' ALT='Документация DHTML, JavaScript, COS, SQL, Errors'></a>"
REFRESH(A1) n BSLABEL S BSLABEL=A1
 Q "<a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'><img border=0 src='"_BSDOMAIN_"/img/refr.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4("обновить")_"'></a>"_BK
]]></Routine>


<Routine name="%ZAPM.bs.BSC4base1" type="MAC" languagemode="0"><![CDATA[
%BSC4base1 ; пpогpамма управления БД ; 15:21   10.09.2002
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
ROU ;ПРОГРАММЫ
 D BEG1^%ZAPM.bs.BSC4
 D pin^%ZAPM.bs.BSC4base
 I $G(BSPRO)="" W $$LNG^%ZAPM.bs.BSC4("Сначало определите ПРОЕКТ",74) G PRO^%ZAPM.bs.BSC4base
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="ActRou^~BSC4base1"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W $$SERVIS^%ZAPM.bs.BSC4base("ROU^~BSC4base1","CfgRou","NWO1")
 W "<table border=0 width=100%>"
 W "<tr><td width=10% align='right' class=s1 ><strong>"_$$LNG^%ZAPM.bs.BSC4("ПРОГРАММЫ",124)_"</strong></td><td width=60% class=s1 >"_$$LNG^%ZAPM.bs.BSC4("текущего проекта ",76)_RED_BSPRO_EF_"</td><td class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Групповое действие над всеми",77)_"</td></tr>"
 N I,N,BD,Sort
 S Sort=+$$GETOPT^%ZAPM.bs.BSC4cfg("^"_pi_"(""CfgRou"")","Sort1") I 'Sort S Sort=-1
 W "<tr><td class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ИМЯ",51)_"</td><td class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ОПИСАНИЕ ПРОГРАММНОГО МОДУЛЯ",125)_"</td><td class=s3 >" D ACT0^%ZAPM.bs.BSC4base W $$Che^%ZAPM.bs.BSC4base(0)_"<input type=""submit"" name='ActOK0' title='"_$$LNG^%ZAPM.bs.BSC4("Групповое действие",79)_"' value='&gt;&gt;'></td></tr>"
 S N="",I=0 I '$D(@("^"_pin)) W $$LNG^%ZAPM.bs.BSC4("Нет раздела ! Обратитесь к Администратору",80) Q
 W "<tr><td class=s1 ><input type=""text"" size=13 maxlength=13 name='Rou' value='"_$$NewRoutin("NewRoutin")_"'></td><td class=s1 > "
 D OR(),TLIST() W "</td><td class=s1 >"
 W "<input type=""submit"" name=""newOK"" value='&gt;&gt;"_$$LNG^%ZAPM.bs.BSC4("Создать программу",126)_"'></td></tr>",BK
 S Co=0
 F  S N=$O(@("^"_pin_".ROU")@(N),Sort) Q:N=""  D
 .S Co=Co+1
 .W "<input type=""hidden"" name='Rou"_Co_"' value="""_N_""">" s sta=$G(@("^"_pin_".ROU")@(N,"STA"))
 .W "<tr><td width=20% class=s1 ><a title='"_$s($e(sta,1,2)'="OK":$$LNG^%ZAPM.bs.BSC4("не компилирована",316),1:$$LNG^%ZAPM.bs.BSC4("компилирована")_$P(sta,"OK",2))_"'>"_$$RedStar^%ZAPM.bs.BSC4rou($e(sta,1,2)'="OK")_N_"</a>"
 .w "</td><td class=s1 >"
 .i $d(@("^"_pin_".ROU")@(N,"HTM"))
 .s Tmp=$ZR i sta["OK" W $$NEWIN("<IMG SRC='"_BSDOMAIN_"/img/ie.gif'>",Tmp,$$LNG^%ZAPM.bs.BSC4("загрузить предлагаемый HTML код в новом окне",139),,$S(sta["OK":" ",1:"disabled"))
 .w AF_$G(@("^"_pin_".ROU")@(N,"REM"))_EF_"</td><td class=s1 >"
 .W "<input type=""submit""  title='"_$$LNG^%ZAPM.bs.BSC4("Действие",127)_"' name='ActOK"_Co_"' value='&gt;&gt;'>" D ACT^%ZAPM.bs.BSC4base W $$Che^%ZAPM.bs.BSC4base(Co,N)_"</td></tr>",BK
 W "<input type=""hidden"" name='RouCount' value="""_Co_""">"
 W " </table>"
 W "</form>"
 D END^%ZAPM.bs.BSC4
 Q
NewRoutin(N) N NN ;НОВОЕ ИМЯ ПРОГРАММЫ
 F NN=1:1 I '$D(@("^"_pin_".ROU")@(N_NN)) Q
 Q N_NN
EditRou(Rou) ;РЕДАКТИРОВАТЬ ПРОГРАММУ
 D BEG1^%ZAPM.bs.BSC4
 W $$SERVIS^%ZAPM.bs.BSC4base("ROU^~BSC4base1","CfgRou")
 N Y,STA,ht,ht1,oFFe
 S STA=$G(@("^"_pin_".ROU")@(Rou,"STA"))
 S CheckCode=$P($G(@("^"_pin_".ROU")@(Rou,"FLG")),"@",1)
 S ProtCode=$P($G(@("^"_pin_".ROU")@(Rou,"FLG")),"@",2)
 S Answer=$G(@("^"_pin_".ROU")@(Rou,"ROU")) I Answer="" S Answer=$$LNG^%ZAPM.bs.BSC4("Контроль не производился",128)
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="SaveRou^~BSC4base1"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<table border=0 width=100%>"
    W "<input type=""hidden"" name='Rou' value="""_Rou_""">"
 W "<tr><td align='CENTER' width=40% class=s1 >"_$$LNG^%ZAPM.bs.BSC4("РЕДАКТИРОВАНИЕ ПРОГРАММЫ",129)_"</td><td  width=60% class=s1 >"_RED_BSPRO_"."_EF_Rou_"</td></tr>",BK
 W "<tr><td width=30% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ОБЩИЕ ПАРАМЕТРЫ",96)_"</td><td  width=70% class=s3 >"_$$LNG^%ZAPM.bs.BSC4("ЗНАЧЕНИЯ",97)_"</td></tr>",BK
  W "<tr><td class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Описание",98)_"</td><td class=s1 ><input type=""text"" size=45 maxlength=145 name='Desc' value='"_$G(@("^"_pin_".ROU")@(Rou,"REM"))_"'></td></tr>",BK
   W "<tr><td class=s1 > <input type=""checkbox"" name=""CheckCode"" value="""_CheckCode_""" "_$$ch^%ZAPM.bs.BSC4cfg(CheckCode)_">"_$$LNG^%ZAPM.bs.BSC4("Контроль кода Администратором",130)_"</td><td class=s1 ><input type=""text"" size=25 maxlength=45 name='Answer' value='"_Answer_"'>"
    W " <input type=""checkbox"" name=""ProtCode"" title='"_$$LNG^%ZAPM.bs.BSC4("Запретить ремастеринг во избежания уничтожения пользовательской редакции кода")_"' value="""_ProtCode_""" "_$$ch^%ZAPM.bs.BSC4cfg(ProtCode)_">"_$$LNG^%ZAPM.bs.BSC4("Запретить ремастеринг")_"</td></tr>",BK
     W "<tr><td class=s1 >"_$$LNG^%ZAPM.bs.BSC4("Статус программы",131)_" Cache'ObjectScript</td><td class=s1 ><input type=""text"" size=45 maxlength=145 name='StatRou' value='"_STA_"'></td></tr>",BK
 W "</table>"
 S oFFe=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"WebEditRou")
 D BUTT
 s ht=$G(@("^"_pin_".ROU")@(Rou,"COS")),Tmp=$ZR
 W " ",$$NEWIN("<IMG SRC='"_BSDOMAIN_"/img/cos.gif'> COS",Tmp,$$LNG^%ZAPM.bs.BSC4("загрузить предлагаемый COS код в новом окне браузера",134),"NumADD^~BSC4r","BUT")
 s ht1=$G(@("^"_pin_".ROU")@(Rou,"HTM")),Tmp=$ZR
 W $$NEWIN("<IMG SRC='"_BSDOMAIN_"/img/ie"_$S(STA["OK":"",1:"off")_".gif'> HTML",Tmp,$$LNG^%ZAPM.bs.BSC4("загрузить предлагаемый HTML код в новом окне",139),,$S(STA["OK":" ",1:"disabled"))
 W "<table border=0 width=100%>"
 W "<tr><td width=* class=s1 ><IMG SRC='"_BSDOMAIN_"/img/cos.gif'>"_$$LNG^%ZAPM.bs.BSC4("Серверная часть (выполняет Cache' сервер) ",132)_$$HelpCache^%ZAPM.bs.BSC4_" "
 I $G(@BDSES@(BSSES,"TEXTARIA","COS"))="" w "<A HREF='"_$$GETH^%ZAPM.bs.BSC4r2("COS","B")_"'><IMG SRC='"_BSDOMAIN_"/img/b.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4("увеличить окно редактирования",138)_"' border=0></A>"_BK
 I $G(@BDSES@(BSSES,"TEXTARIA","COS"))'="" w "<A HREF='"_$$GETH^%ZAPM.bs.BSC4r2("COS","L")_"'><IMG SRC='"_BSDOMAIN_"/img/l.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4("уменьшить окно редактирования",133)_"' border=0></A>"_BK
 W $s(STA'["OK":RED_$$LNG^%ZAPM.bs.BSC4("необходима компиляция")_EF,1:"")_"</td></tr>",BK
 W "<tr><td class=s1 >"
 I oFFe W "<textarea "_$$GETTA^%ZAPM.bs.BSC4r2("COS")_" name='ServR'>"_$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(ht,"<","&lt;"),">","&gt;")_"</textarea>"
 i 'oFFe W "<CENTER>"_RED_$$LNG^%ZAPM.bs.BSC4("РЕДАКТОР ВЫКЛЮЧЕН")_EF_"</CENTER>"
 W "</td></tr>",BK
 W "<tr><td width=* class=s3 ><IMG SRC='"_BSDOMAIN_"/img/ie.gif'>"_$$LNG^%ZAPM.bs.BSC4("Клиентская часть (выполняется в WEB браузере) ",135)_$$HelpDhtml^%ZAPM.bs.BSC4_", "_$$HelpJS^%ZAPM.bs.BSC4_" "
 I $G(@BDSES@(BSSES,"TEXTARIA","HTM"))="" w "<A HREF='"_$$GETH^%ZAPM.bs.BSC4r2("HTM","B")_"'><IMG SRC='"_BSDOMAIN_"/img/b.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4("увеличить окно редактирования",138)_"' border=0></A>"_BK
 I $G(@BDSES@(BSSES,"TEXTARIA","HTM"))'="" w "<A HREF='"_$$GETH^%ZAPM.bs.BSC4r2("HTM","L")_"'><IMG SRC='"_BSDOMAIN_"/img/l.gif' ALT='"_$$LNG^%ZAPM.bs.BSC4("уменьшить окно редактирования",133)_"' border=0></A>"_BK
 W "</td></tr>",BK
 W "<tr><td class=s3 >"_$s(STA'["OK":RED_$$LNG^%ZAPM.bs.BSC4("после компиляции",136)_EF,1:"")
 w $$LNG^%ZAPM.bs.BSC4(" возьмите в буфер обмена и вставте в ваш WEB сайт",137)
 W "</td></tr>",BK
 w "<tr><td class=s3 ><textarea "_$$GETTA^%ZAPM.bs.BSC4r2("HTM")_" name='ClienR'>"_$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(ht1,"<","&lt;"),">","&gt;")_"</textarea></td></tr>",BK
 W "</table>"
 W "</form>"
 D InfoSess^%ZAPM.bs.BSC4rout,END^%ZAPM.bs.BSC4
 Q
NEWIND I BSTMP["|" S BSTMP=$TR(BSTMP,"|",$C(34))
 w $g(@BSTMP," ") ;новое окно
NEWIN(t,ZR,tit,CodeM,BUT) ;новое окно
 n BSLABEL,BSLOGIN,BSPRO,BSRoutineId,BSSES,BSTMP,BSTOP,BSGRANT s BSLABEL=$g(CodeM,"NEWIND^~BSC4base1"),BSTMP=ZR
 S R=$$ADDBSGET^%ZAPM.bs.BSC4() I R[$C(34) S R=$TR(R,$C(34),"|")
 I $D(BUT) Q "<BUTTON "_BUT_" title='"_tit_"' onclick=""open('"_R_"','','toolbar=yes,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1")_",status=1,resizable=1');"">"_t_"</BUTTON>"
 Q "<a title='"_tit_"' class=u1 onclick=""open('"_R_"','Tmp"_$TR($H,",","")_"','toolbar=yes,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1")_",status=1,resizable=1');"">"_t_"</a>"
CheckRou(ServR) ;        трансляция и синтаксический контроль кода
 I ServR="" W RED_Rou_" "_$$LNG^%ZAPM.bs.BSC4("Программа пустая!",140)_EF_BBK Q 0
 I '$$Security^%ZAPM.bs.BSC4r(ServR) W RED_Rou_" "_$$LNG^%ZAPM.bs.BSC4("Контроль на безопасность не пройден!",141),EF," ",$$NEWIN($$LNG^%ZAPM.bs.BSC4("Запрещенные команды",142),"1",$$LNG^%ZAPM.bs.BSC4("загрузить запрещенный COS код в новом окне браузера",143),"Protect^~BSC4r"),BBK Q 0
 S ServR=" #include %BSC4inc"_BK_ServR
 s K=$L(ServR,BK)
 F I=1:1:K S ServR(I)=$P(ServR,BK,I) ;W ServR(I),BK
 S ServR="",ServR(0)=K,out=""
 D ROUTINE^%R(pin_"."_Rou_".MAC",.ServR,.err,"CS",0)
 I $G(err)'="" W "<PRE>",RED,$$FMTERR^%R(.err,.ServR),EF,"</PRE>",BK Q 0
 ;D ROUTINE^%R(pin_"."_Rou_".INT",.ServR,.err,"D",0)
 ;I $G(err)'="" W "<PRE>",RED,$$FMTERR^%R(.err,.ServR),EF,"</PRE>",BK Q 0
 ;D DEL1^%ZAPM.bs.BSC4r4(pin_"."_Rou_".MAC") ;,filedate,nsp)
 Q 1
CompRou ;КОМПИЛИРОВАТЬ ПРОГРАММУ
 N N1,R1,I,K,out,err
 s N1=$ZU(5),R1=$zcrc(N1_"^"_pin_"."_Rou,7)
 I '$$CheckRou(ServR) D  Q  ;ИЛИ СИНТАКСИС НЕ ПРОШЕЛ
 .S @("^"_pin_".ROU")@(Rou,"STA")="Error "_$$TD^%ZAPM.bs.BSC4base
 .D DEL1^%ZAPM.bs.BSC4r4(pin_"."_Rou_".*") K @BDREF@(R1)
 .S @("^"_pin_".ROU")@(Rou,"ROU")=" "
 ;контроль прошел
 S @BDREF@(R1,"Name")=pin_"."_Rou,@BDREF@(R1,"Namespace")=N1 ;,@BDREF@(R1,"pi")=pi
 I $G(ClienR)'="" S @("^"_pin_".ROU")@(Rou,"HTM")=$$TR^%ZAPM.bs.BSsFUNM(ClienR,"????????",R1)
 ;I $G(ServR)'="" S @("^"_pin_".ROU")@(Rou,"COS")=$$TR^%ZAPM.bs.BSsFUNM(ServR,"????????",R1) !!!!!! НЕЛЬЗЯ
 S @("^"_pin_".ROU")@(Rou,"STA")="OK "_$$TD^%ZAPM.bs.BSC4base,@("^"_pin_".ROU")@(Rou,"ROU")=" BSRoutineId="_R1
 Q
ReMST(newTP,EnablT) K @("^"_pin_".ROU")@(Rou)
 I newTP["^" D @(newTP_"(pin,Rou,EnablT)") I 1
 E  D @(newTP_"^%ZAPM.bs.BSC4rou(pin,Rou,EnablT)")
 D EditRou(Rou) Q
BUTT W "<nobr><input type=""submit"" name=""SaveRou"" "_$S('$G(oFFe):"disabled",1:"")_" title='"_$$LNG^%ZAPM.bs.BSC4("Только сохранить изменения",108)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Сохранить",109)_"'>"
 w "<input type=""submit"" name=""CompRou"" "_$S('$G(oFFe):"disabled",1:"")_" title='"_$$LNG^%ZAPM.bs.BSC4("Компилировать серверную часть модуля",144)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Компилировать",111)_"'>"
 w "<input type='RESET' "_$S('$G(oFFe):"disabled",1:"")_" title='"_$$LNG^%ZAPM.bs.BSC4("Отменить текущие изменения",112)_"' name='Reset1' value='"_$$LNG^%ZAPM.bs.BSC4("Отменить",73)_"'>"
 N MST S MST=$G(@("^"_pin_".ROU")@(Rou,"MST"))
 I MST'="" w "<input type=""submit"" name=""ReMST"" "_$S('$G(oFFe):"disabled",1:"")_" "_$S($G(ProtCode):"disabled",1:"")_" title='"_$$LNG^%ZAPM.bs.BSC4("Создать заново программу, используя Мастер `",145)_$P($P(MST,","),"^")_$$LNG^%ZAPM.bs.BSC4("` для таблицы `",146)_$P(MST,",",2)_"`' value='"_$$LNG^%ZAPM.bs.BSC4("РеМастеринг",147)_"'>"
 W "</nobr>" Q
SaveRou ;СОХРАНИТЬ ИЗМЕНЕНИЯ
 D pin^%ZAPM.bs.BSC4base
 I $D(ReMST) S ReMST=@("^"_pin_".ROU")@(Rou,"MST") D ReMST($P(ReMST,",",1),$P(ReMST,",",2)) Q
 I $G(Desc)'="" S @("^"_pin_".ROU")@(Rou,"REM")=Desc
 I $G(Suff)'="" S @("^"_pin_".ROU")@(Rou,"ROU")=Suff
 S $P(@("^"_pin_".ROU")@(Rou,"FLG"),"@",1)=$S($D(CheckCode):1,1:0)
 S $P(@("^"_pin_".ROU")@(Rou,"FLG"),"@",2)=$S($D(ProtCode):1,1:0)
 I $D(CheckCode),'$$TARIF^%ZAPM.bs.BSC4rout("TIP") W RED,$$LNG^%ZAPM.bs.BSC4("Контроль кода Адмигистратором",148)," ",$$LNG^%ZAPM.bs.BSC4("возможно только на старших тарифных планах",149),EF,BBK,BBK
 ;ZW %KEY("ServR"),BK
 I $G(ServR)'="" S @("^"_pin_".ROU")@(Rou,"COS")=ServR
 I $G(ClienR)'="" S @("^"_pin_".ROU")@(Rou,"HTM")=ClienR
 S @("^"_pin_".ROU")@(Rou,"STA")="Save "_$$TD^%ZAPM.bs.BSC4base
 ;S @("^"_pin_".ROU")@(Rou,"ROU")=" "
 I $D(CompRou) D CompRou
 D EditRou(Rou) Q
ActRou ;ДЕЙСТВИЯ НАД ПРООГРАММОЙ
 N I D pin^%ZAPM.bs.BSC4base
 I $D(newOK) G CreatRou
 I $D(ActOK0) D  G ROU ;ГРУППОВАЯ
 .I $D(Check0) F I=1:1:$G(RouCount) D Ac($G(Act0),@("Rou"_I)) ;ВСЕ
 .E  F I=1:1:$G(RouCount) I $D(@("Check"_I)) D Ac($G(Act0),@("Rou"_I))
 F I=1:1:$G(RouCount) I $D(@("ActOK"_I)) Q
 I $D(@("Rou"_I)) D
 .I $G(@("Act"_I))=2 D KillRou(@("Rou"_I)) G ROU
 .I $G(@("Act"_I))=1 D EditRou(@("Rou"_I)) Q
 .I $G(@("Act"_I))=3 D R2B(@("Rou"_I)) G ROU
 Q
Ac(A,R) ;ГРУППОВОЕ ДЕЙСТВИЕ
 I A=1 S Rou=R,ServR=$G(@("^"_pin_".ROU")@(Rou,"COS")),ClienR=$G(@("^"_pin_".ROU")@(Rou,"HTM")) D CompRou Q
 I A=2 D KillRou(R) Q
 Q
ALLROU(PART) //КОМПИЛИРОВАТЬ ВСЕ ПРОГРАММЫ B4Y
 N Rou,PP,pin
 D MAINVAR^%ZAPM.bs.BSC4
 S pin=$P(PART,"^",2,99)
 S PP=$G(@PART@("ROU","KEY")) Q:PP=""
 S Rou="" F  S Rou=$O(@PP@(Rou)) Q:Rou=""  D Ac(1,Rou)
 Q
R2B(ROU,DEST) ;ПРОГРАММУ В БУФЕР ОБМЕНА
 I '$D(DEST) S DEST=$NA(@GTmp@(BSLOGIN,"ROU"))
 N ID K @DEST
 S ID=$P($G(@("^"_pin_".ROU")@(ROU,"ROU"))," BSRoutineId=",2)
 M @DEST=@("^"_pin_".ROU")@(ROU)
 I ID'="" D
 .S @DEST@("HTM")=$$TR^%ZAPM.bs.BSsFUNM(@("^"_pin_".ROU")@(ROU,"HTM"),ID,"????????")
 .S @DEST@("COS")=$$TR^%ZAPM.bs.BSsFUNM(@("^"_pin_".ROU")@(ROU,"COS"),ID,"????????")
 .K @DEST@("ROU"),@DEST@("STA")
 Q
KillRou(Rou) ;УДАЛИТЬ ПРОГРАММУ
 N ID
 D DEL1^%ZAPM.bs.BSC4r4(pin_"."_Rou_".*") S ID=$P($G(@("^"_pin_".ROU")@(Rou,"ROU"))," BSRoutineId=",2)
 K @("^"_pin_".ROU")@(Rou) I ID'="" K @BDREF@(ID)
 W $$LNG^%ZAPM.bs.BSC4("ПРОГРАММА",150)," '",RED,Rou,EF,"' ",$$LNG^%ZAPM.bs.BSC4("УДАЛЕНА",117),BBK,BBK
 Q
CreatRou ;СОЗДАТЬ ПРОГРАММУ
 I $D(@("^"_pin_".ROU")@(Rou)) W $$LNG^%ZAPM.bs.BSC4("Программа с именем",151)," '",RED,Rou,EF,"' ",$$LNG^%ZAPM.bs.BSC4("уже существует",61),BK G ROU
 I newTP[$P(GTmp,")") D Copy^%ZAPM.bs.BSF8(newTP,$NA(@("^"_pin_".ROU")@(Rou))) G ROU
 I newTP="" S @("^"_pin_".ROU")@(Rou,"REM")="" I 1
 E  D
 .I newTP["*" W $$LNG^%ZAPM.bs.BSC4("Мастер создания программ '",152)_$E(newTP,2,99)_$$LNG^%ZAPM.bs.BSC4("' доступен только на старших тарифных планах",153) I 1
 .E  D @(newTP_"^%ZAPM.bs.BSC4rou(pin,Rou,EnablT)")
 G ROU
OR() N B,I,P,T ;ВСЕ ПРОГРАММЫ ДОСТУПНЫЕ КАК ШАБЛОН
 W "<select name=""newTP"" size=1>"
 I $D(@GTmp@(BSLOGIN,"ROU")) W "<option value='"_$ZR_"'>"_$$LNG^%ZAPM.bs.BSC4("Копировать из буфера",56)_"</option>"
 ;S P="^%ZAPM.bs.BSC4E",T=""
 ;S B=$$KBD^%ZAPM.bs.BSF12($NA(@P@("ROU")))
 W "<option value=''>"_$$LNG^%ZAPM.bs.BSC4("применить мастер..",154)_"</option>"
 F T="RunCode","InputForm","Populate","DynamicSQL","Find","Navigator"  W "<option value='"_T_"'>"_T_"</option>"
 W "</select>"
 Q
TLIST() N N ;ДОСТУПНЫЕ ТАБЛИЦЫ
 S N=""
 W "<select name=""EnablT"" size=1>"
 W "<option " W " value=''>"_$$LNG^%ZAPM.bs.BSC4("к таблице..",155)_"</option>"
 F  S N=$O(@("^"_pin)@(N)) Q:N=""  I $P($G(@("^"_pin)@(N)),"@",17)=2 D
 .I N="ROU" Q
 .I $G(@("^"_pin)@(N,"Compile"))'["OK" q  ;не компилирована
 .W "<option " W " value='"_N_"'>"_N_"</option>"
 W "</select>"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4cal" type="MAC" languagemode="0"><![CDATA[
%BSC4cal ;CALENDAR FUNCTION  ; Compiled February 22, 2002 23:26:36
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ; 
 q
A(d,T,Targ) ;ЯКОРЬ ;КАЛЕНДАРЬ d-дата предустановки, d="" - дата текущая d=YYYYMMDD
 I d="" S d=$ZD($h,8)
 Q $$a^%ZAPM.bs.BSC4rout($$CALGET(d),T,T,300,250)
on(BSLABEL,W,H) q " onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_$G(Targ,"calend")_""",""toolbar=no,menubar=no,scrollbars=no,width="_$G(W,640)_",height="_$G(H,480)_",status=1,resizable=1"");' "
B(d,N,Targ,ROU,AN) ;кнопка/ЯКОРЬ В НОВОМ ОКНЕ
 I d="" S d=$ZD($h,8)
 N BSLABEL,BSDATE,Q,QQ S BSLABEL=$G(ROU,"CALDATE^~BSC4cal"),BSDATE=d,Q=""
 I $G(AN)="" S Q=Q_"<BUTTON name='Calendar2' ",QQ="</BUTTON>"
 E  S Q=Q_"<A name='Calendar2' ",QQ="</A>"
 S Q=Q_$$on(BSLABEL,300,250)_" ><IMG src='"_BSDOMAIN_"/img/cal.gif' alt='"_$G(N,""_$$LNG^%ZAPM.bs.BSC4("календарь",156)_"")_"'>"
 Q Q_QQ
EDITDATE ;ВЫЗВАТЬ КАЛЕНДАРЬ
 D CAL($E(BSDATE,1,4),$E(BSDATE,5,6)-1,+$E(BSDATE,7,8),"Календарь","",BS1,BS2,,1) //BS2=ПРОГРАММА ВОЗВРАТА
 Q
 //ПРИНЯТЬ ДАТУ ОТ КАЛЕНДАРЯ
D4(N) S:N="" N=1 Q $S($L(N)=1:"0"_N,1:N)
RETURN() ;ПРИНЯТЬ ДАТУ ОТ КАЛЕНДАРЯ
 N D
 I $D(Today) S D=$ZD($h,8)
 I $D(Ok) S D=tbSelYear_$$D4(tbSelMonth)_$$D4(calSelectedDate)
 I $D(Esc) S D=""
 Q D //D=YYYYMMDD
CALDATE ;ВЫЗВАТЬ КАЛЕНДАРЬ
 D CAL($E(BSDATE,1,4),$E(BSDATE,5,6)-1,+$E(BSDATE,7,8),$$LNG^%ZAPM.bs.BSC4("Календарь",157))
 Q
CALGET(d) N BSLABEL,BSDATE S BSLABEL="CALDATE^~BSC4cal",BSDATE=d
 Q $$ADDBSGET^%ZAPM.bs.BSC4()    
CAL(Yy,Mm,Dd,TiT,BODY,BSG,BSLABEL,GRAY,NOCLOSE,YearOT,YearDO) ;//Календарь - RUS
 ;Yy,- год по-умолчанию
 ;Mm,- месяц по-умолчанию
 ;Dd,- день по-умолчанию
 ;TiT,- атрибут тага <title>
 ;BODY,- атрибут тага <body>
 ;BSG,- скрытая переменная ссылки на узел BS-WebLink
 ;BSLABEL,- скрытая переменная ссылки на программу обработки выбора даты
 ;GRAY,- цвета календаря
 ;NOCLOSE,- не закрывать текущее окно браузера
 ;YearOT,- нижний диапазон годов
 ;YearDO- верхний диапазон годов
 Write "  ",BK
 Write "<html>",BK
 Write "<head><title>"_TiT_"</title>",BK
 W $$STYLE^%ZAPM.bs.BSC4
 Write "<script language=""javascript"">",BK
 W "<!--",BK
 Write " //Скачано с cgi.ru",BK
 Write " //Все скрипты : cgi.ru",BK
 Write " //info@cgi.ru",BK
 Write " // Идея и основная часть кода: Nick Korosi (nfk2000@hotmail.com).",BK
 Write " // Дополнено:",BK
 Write " //  1. Отображение порядка дней недели в соответствии с принятым в России;",BK
 Write " //      2. Подсветка текущего дня месяца;",BK
 Write " //      3. Возможность общей настройки цветового решения;",BK
 Write " // Автор дополнений: Боронин Денис (bdv@freemail.ru). ",BK
 Write " // Idea and main code part: Nick Korosi (nfk2000@hotmail.com) ",BK
 Write " // Adds:",BK
 Write " //  1. Russian week date order;",BK
 Write " //      2. Current day illumination;",BK
 Write " //      3. Simple color setting up.",BK
 Write " // Author of adds: Denis Boronin (bdv@freemail.ru)",BK
 Write "var dDate = new Date("_(Yy)_","_(Mm)_","_(Dd)_");",BK
 Write "var dCurMonth = dDate.getMonth();",BK
 Write "var dCurDayOfMonth = dDate.getDate();",BK
 Write "var dCurYear = dDate.getFullYear();",BK
 Write "var objPrevElement = new Object();",BK
 Write "var bgcolor",BK
 Write "var webgcolor",BK
 Write "var wecolor",BK
 Write "var nwecolor",BK
 Write "var tbgcolor",BK
 Write "var ntbgcolor",BK
 Write "var sbgcolor",BK
 Write "function fToggleColor(myElement) ",BK
 Write "{",BK
 Write " var toggleColor = ""#ff0000"";",BK
 Write " if (myElement.id == ""calDateText"") ",BK
 Write "  {",BK
 Write "  if (myElement.color == toggleColor) ",BK
 Write "   {",BK
 Write "   myElement.color = """";",BK
 Write "   } ",BK
 Write "  else ",BK
 Write "  {",BK
 Write "  myElement.color = toggleColor;",BK
 Write "  }",BK
 Write " } ",BK
 Write " else ",BK
 Write "  if ((myElement.id == ""calCell"") || (myElement.id == ""calTodayCell""))",BK
 Write "  {",BK
 Write "  for (var i in myElement.children) ",BK
 Write "   {",BK
 Write "   if (myElement.children[i].id == ""calDateText"") ",BK
 Write "    {",BK
 Write "    if (myElement.children[i].color == toggleColor) ",BK
 Write "     {",BK
 Write "     myElement.children[i].color = """";",BK
 Write "     } ",BK
 Write "    else ",BK
 Write "    {",BK
 Write "    myElement.children[i].color = toggleColor;",BK
 Write "    }",BK
 Write "   }",BK
 Write "  }",BK
 Write " }",BK
 Write "}",BK
 Write "function fSetSelectedDay(myElement)",BK
 Write "{",BK
 Write " if (myElement.id == ""calCell"") ",BK
 Write " {",BK
 Write "  if (!isNaN(parseInt(myElement.children[""calDateText""].innerText))) ",BK
 Write "   {",BK
 Write "   myElement.bgColor = sbgcolor;",BK
 Write "   objPrevElement.bgColor = ntbgcolor;",BK
 Write "   document.all.calSelectedDate.value = parseInt(myElement.children[""calDateText""].innerText);",BK
 Write "   objPrevElement = myElement;",BK
 Write "   }",BK
 Write "  }",BK
 Write "}",BK
 Write "function fGetDaysInMonth(iMonth, iYear) ",BK
 Write "{",BK
 Write " var dPrevDate = new Date(iYear, iMonth, 0);",BK
 Write " return dPrevDate.getDate();",BK
 Write "}",BK
 Write "function fBuildCal(iYear, iMonth, iDayStyle) ",BK
 Write "{",BK
 Write " var aMonth = new Array();",BK
 Write " aMonth[0] = new Array(7);",BK
 Write " aMonth[1] = new Array(7);",BK
 Write " aMonth[2] = new Array(7);",BK
 Write " aMonth[3] = new Array(7);",BK
 Write " aMonth[4] = new Array(7);",BK
 Write " aMonth[5] = new Array(7);",BK
 Write " aMonth[6] = new Array(7);",BK
 Write " var dCalDate = new Date(iYear, iMonth-1, 1);",BK
 Write " var iDayOfFirst = dCalDate.getDay();",BK
 Write " var iDaysInMonth = fGetDaysInMonth(iMonth, iYear);",BK
 Write " var iVarDate = 1;",BK
 Write " var i, d, w;",BK
 Write " if (iDayOfFirst==0)",BK
 Write " {",BK
 Write "  iDayOfFirst=6",BK
 Write " }",BK
 Write " else",BK
 Write " {",BK
 Write "  iDayOfFirst=iDayOfFirst-1",BK
 Write " }",BK
 Write " if (iDayStyle == 2) ",BK
 Write "  {",BK
 Write "  aMonth[0][0] = ""Понедельник"";",BK
 Write "  aMonth[0][1] = ""Вторник"";",BK
 Write "  aMonth[0][2] = ""Среда"";",BK
 Write "  aMonth[0][3] = ""Четверг"";",BK
 Write "  aMonth[0][4] = ""Пятница"";",BK
 Write "  aMonth[0][5] = ""Суббота"";",BK
 Write "  aMonth[0][6] = ""Воскресенье"";",BK
 Write "  } ",BK
 Write " else ",BK
 Write "  if (iDayStyle == 1) ",BK
 Write "  {",BK
 Write "  aMonth[0][0] = ""Пон"";",BK
 Write "  aMonth[0][1] = ""Вт"";",BK
 Write "  aMonth[0][2] = ""Ср"";",BK
 Write "  aMonth[0][3] = ""Чт"";",BK
 Write "  aMonth[0][4] = ""Пт"";",BK
 Write "  aMonth[0][5] = ""Сб"";",BK
 Write "  aMonth[0][6] = ""Вск"";",BK
 Write "  } ",BK
 Write "  else ",BK
 Write "   {",BK
 Write "   aMonth[0][0] = ""Пн"";",BK
 Write "   aMonth[0][1] = ""Вт"";",BK
 Write "   aMonth[0][2] = ""Ср"";",BK
 Write "   aMonth[0][3] = ""Чт"";",BK
 Write "   aMonth[0][4] = ""Пт"";",BK
 Write "   aMonth[0][5] = ""Сб"";",BK
 Write "   aMonth[0][6] = ""Вс"";",BK
 Write "   }",BK
 Write " for (d = iDayOfFirst; d < 7; d++) ",BK
 Write "  {",BK
 Write "  aMonth[1][d] = iVarDate",BK
 Write "  iVarDate++;",BK
 Write "  }",BK
 Write " for (w = 2; w < 7; w++) ",BK
 Write "  {",BK
 Write "  for (d = 0; d < 7; d++) ",BK
 Write "   {",BK
 Write "   if (iVarDate <= iDaysInMonth) ",BK
 Write "    {",BK
 Write "    aMonth[w][d] = iVarDate",BK
 Write "    iVarDate++;",BK
 Write "    }",BK
 Write "   }",BK
 Write "  }",BK
 Write " return aMonth;",BK
 Write "}",BK
 Write "function fDrawCal(iYear, iMonth, iCellWidth, iCellHeight, sDateTextSize, sDateTextWeight, iDayStyle, ibgcolor, iwebgcolor, inwecolor, iwecolor, itbgcolor, intbgcolor, isbgcolor) ",BK
 Write "{ ",BK
 Write " bgcolor = ibgcolor;",BK
 Write " webgcolor = iwebgcolor;",BK
 Write " wecolor = iwecolor;",BK
 Write " nwecolor = inwecolor;",BK
 Write " tbgcolor = itbgcolor;",BK
 Write " ntbgcolor = intbgcolor;",BK
 Write " sbgcolor = isbgcolor;",BK
 Write " var myMonth;",BK
 Write " myMonth = fBuildCal(iYear, iMonth, iDayStyle);",BK
 Write " document.write(""<table border='0'>"")",BK
 Write " document.write(""<tr>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ bgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ nwecolor +""'>"" + myMonth[0][0] + ""</td>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ bgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ nwecolor +""'>"" + myMonth[0][1] + ""</td>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ bgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ nwecolor +""'>"" + myMonth[0][2] + ""</td>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ bgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ nwecolor +""'>"" + myMonth[0][3] + ""</td>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ bgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ nwecolor +""'>"" + myMonth[0][4] + ""</td>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ webgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ wecolor +""'>"" + myMonth[0][5] + ""</td>"");",BK
 Write " document.write(""<td align='center' style='BACKGROUND-COLOR:""+ webgcolor +"";FONT-FAMILY:Arial;FONT-SIZE:12px;FONT-WEIGHT:bold;COLOR:""+ wecolor +""'>"" + myMonth[0][6] + ""</td>"");",BK
 Write " document.write(""</tr>"");",BK
 Write " for (w = 1; w < 7; w++) ",BK
 Write "  {",BK
 Write "  document.write(""<tr>"")",BK
 Write "  for (d = 0; d < 7; d++) ",BK
 Write "   {",BK
 Write "   if (myMonth[w][d]==dCurDayOfMonth)",BK
 Write "    {",BK
 Write "    document.write(""<td id=calTodayCell bgcolor='""+ tbgcolor +""' align='center' valign='center' width='"" + iCellWidth + ""' height='"" + iCellHeight + ""' style='CURSOR:Hand;FONT-FAMILY:Arial;FONT-SIZE:"" + sDateTextSize + "";FONT-WEIGHT:"" + sDateTextWeight + ""' onMouseOver='fToggleColor(this)' onMouseOut='fToggleColor(this)' onclick=fSetSelectedDay(this)>"");",BK
 Write "    }",BK
 Write "   else",BK
 Write "    {",BK
 Write "    document.write(""<td id=calCell bgcolor='""+ ntbgcolor +""' align='center' valign='center' width='"" + iCellWidth + ""' height='"" + iCellHeight + ""' style='CURSOR:Hand;FONT-FAMILY:Arial;FONT-SIZE:"" + sDateTextSize + "";FONT-WEIGHT:"" + sDateTextWeight + ""' onMouseOver='fToggleColor(this)' onMouseOut='fToggleColor(this)' onclick=fSetSelectedDay(this)>"");",BK
 Write "    }",BK
 Write "  if (!isNaN(myMonth[w][d])) ",BK
 Write "   {",BK
 Write "   document.write(""<font id=calDateText onclick=fSetSelectedDay(this)>"" + myMonth[w][d]);",BK
 Write "   } ",BK
 Write "  else ",BK
 Write "   {",BK
 Write "   document.write(""<font id=calDateText onclick=fSetSelectedDay(this)>"");",BK
 Write "   }",BK
 Write "  document.write(""</td>"")",BK
 Write "  }",BK
 Write "  document.write(""</tr>"");",BK
 Write "  }",BK
 Write " document.write(""</table>"")",BK
 Write " }",BK
 Write "function fUpdateCal(iYear, iMonth) ",BK
 Write "{",BK
 Write " myMonth = fBuildCal(iYear, iMonth);",BK
 Write " objPrevElement.bgColor = ntbgcolor;",BK
 Write " if (((iMonth-1)==dCurMonth) && (iYear==dCurYear))",BK
 Write "  {",BK
 Write "  calTodayCell.bgColor = tbgcolor",BK
 Write "  }",BK
 Write " else",BK
 Write "  {",BK
 Write "  calTodayCell.bgColor = ntbgcolor",BK
 Write "  }",BK
 Write " document.all.calSelectedDate.value = """";",BK
 Write " for (w = 1; w < 7; w++) ",BK
 Write "  {",BK
 Write "  for (d = 0; d < 7; d++) ",BK
 Write "   {",BK
 Write "   if (!isNaN(myMonth[w][d])) ",BK
 Write "    {",BK
 Write "    calDateText[((7*w)+d)-7].innerText = myMonth[w][d];",BK
 Write "    } ",BK
 Write "   else ",BK
 Write "    {",BK
 Write "    calDateText[((7*w)+d)-7].innerText = "" "";",BK
 Write "    }",BK
 Write "   }",BK
 Write "  }",BK
 Write "}",BK
 Write "-->",BK
 Write "</script>",BK
 ;Write "<!-- ОКОНЧАНИЕ -->",BK
 Write "</head>",BK
 ;Write "<body ONUNLOAD='window.returnValue = frmCalendar.tbSelYear.value+"",""+frmCalendar.tbSelMonth.value+"",""+frmCalendar.calSelectedDate.value; YeaR=frmCalendar.tbSelYear.value; MontH=frmCalendar.tbSelMonth.value;'>",BK
 Write "<body "_$G(BODY)_"  onkeyPress=""javascript: if (27 == event.keyCode) window.close(); "" ><center>",BK
 ;Write "<!--",BK
 ;Write " Вставить текст в необходимое место Вашей страницы",BK
 ;Write "-->",BK
 ;Write "<!-- НАЧАЛО -->",BK
 Write "<script language=""JavaScript"" for=window event=onload>",BK
 Write "<!--",BK
 Write " var dCurDate = new Date("_(Yy)_","_(Mm)_","_(Dd)_");",BK
 Write " frmCalendar.tbSelMonth.options[dCurDate.getMonth()].selected = true;",BK
 Write " for (i = 0; i < frmCalendar.tbSelYear.length; i++)",BK
 Write "  if (frmCalendar.tbSelYear.options[i].value == dCurDate.getFullYear())",BK
 Write "  frmCalendar.tbSelYear.options[i].selected = true;",BK
 Write "-->",BK
 Write "</script>",BK
 Write "<form name=""frmCalendar"" method=""post"" action="""_$$ADDLIB^%ZAPM.bs.BSC4_""">",BK
 ;;;Write "<form name=""frmCalendar"" method=""post"" action="""">",BK     
 Write "<input type=""hidden"" name=""calSelectedDate"" value="""">",BK
 ;Write "<input type=""hidden"" name=""YeaR"" value="""">",BK
 ;Write "<input type=""hidden"" name=""MontH"" value="""">",BK
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 Write "<table border=""0"" bgcolor=""white"">",BK
 Write " <tr>",BK
 Write " <td align=center>",BK
 Write " <select name=""tbSelMonth"" onchange='fUpdateCal(frmCalendar.tbSelYear.value, frmCalendar.tbSelMonth.value)'>",BK
 Write " <option value=""1"">Январь</option>",BK
 Write " <option value=""2"">Февраль</option>",BK
 Write " <option value=""3"">Март</option>",BK
 Write " <option value=""4"">Апрель</option>",BK
 Write " <option value=""5"">Май</option>",BK
 Write " <option value=""6"">Июнь</option>",BK
 Write " <option value=""7"">Июль</option>",BK
 Write " <option value=""8"">Август</option>",BK
 Write " <option value=""9"">Сентябрь</option>",BK
 Write " <option value=""10"">Октябрь</option>",BK
 Write " <option value=""11"">Ноябрь</option>",BK
 Write " <option value=""12"">Декабрь</option>",BK
 Write " </select>",BK
 Write " <select name=""tbSelYear"" onchange='fUpdateCal(frmCalendar.tbSelYear.value, frmCalendar.tbSelMonth.value)'>",BK
 F Y=$G(YearOT,$E($ZD($h,8),1,4)-3):1:$G(YearDO,$E($ZD($h,8),1,4)+2) Write "                         <option value="""_Y_""">"_Y_"</option>",BK
 Write " </select>",BK
 Write " </td>",BK
 Write " </tr>",BK
 Write " <tr>",BK
 Write "  <td>",BK
 Write "  <script language=""JavaScript"">",BK
 Write "  <!--",BK
 Write "  var dCurDate = new Date("_(Yy)_","_(Mm)_","_(Dd)_");",BK
 Write "  fDrawCal(dCurDate.getFullYear(), dCurDate.getMonth()+1, 30, 16, ""12px"", ""bold"", 3, ""gray"", ""blue"", ""white"", ""white"", ""Aqua"", """_$g(GRAY,"silver")_""", ""Teal"");",BK
 Write "  -->",BK
 Write "  </script>",BK
 Write " </td>",BK
 Write " </tr>",BK
 Write "</table>",BK
 I $D(NOCLOSE) S NOC=""
 E  S NOC="ONCLICK='window.close();'"
 Write "<input type=""submit"" name=""Ok"" "_NOC_" value=""Выбрать"">",BK
 Write "<input type=""submit"" name=""Today"" "_NOC_" value=""Сегодня"">",BK
 Write "<input type=""submit"" name=""Esc"" "_NOC_" value=""Отмена"">",BK
 Write "</center></form>",BK
 Write "</body>",BK
 Write "</html>",BK
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4cfg" type="MAC" languagemode="0"><![CDATA[
%BSC4cfg ;БИБЛИОТЕКА ФУНКЦИЙ РАБОТЫ С ОПЦИЯМИ ; 21:45   11.01.2001
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 ;КОРРЕКТНО РАБОТАЮТ ТОЛЬКО НОВЫЙ ФОРМАТ ТАБЛИЦ ОПЦИИ: OPT=1 !!!!!!!!!!
 Q
VAR ;НАЧАЛО
 S Bs=$$CurT^%ZAPM.bs.BSChT($$%^%ZAPM.bs.BSCh(BSNSP),$$%^%ZAPM.bs.BSCh(BSPART),$$%^%ZAPM.bs.BSCh(BSTABL))
 S PART=$P(Bs,"("),TABL=$QS(Bs,1)
 S O=Bs
 Q
BSVAR ;ПЕРЕМЕННЫЕ ДЛЯ ТАБЛИЦЫ
 w "<input type=""hidden"" name=""BSTABL"" value="""_%KEY("BSTABL")_""">",$G(BK) 
 w "<input type=""hidden"" name=""BSPART"" value="""_%KEY("BSPART")_""">",$G(BK) 
 ;w "<input type=""hidden"" name=""BSNSPACE"" value="""_%KEY("BSNSPACE")_""">",$G(BK)     
 Q
ENTER ;основной вход в таблицу опций
 N O D VAR
 D BEG1^%ZAPM.bs.BSC4
 W "<TITLE> <<<<<<<<<<<< "_$$TITLE(O)_"</TITLE></HEAD>",BK
 W "<BODY  onkeyPress=""javascript: if (27 == event.keyCode) window.close();"" "_$$0^%ZAPM.bs.BSCh(3)_">",BK
 W "<CENTER>"_AF_O_EF
 I $G(@O@("OPT"))'=1,'$P($G(@O@("OPT")),",",2) W $$LNG^%ZAPM.bs.BSC4("В таблице опций",158)_" '"_O_"' "_$$LNG^%ZAPM.bs.BSC4("неправильный параметр",159)_BK D BACK^%ZAPM.bs.BSCh Q
 D OPT(O)
 D BSVAR
 w "<BR><input type=""hidden"" name=""BSNSP"" value="""_BSNSP_""">"
 w "<BR><input type=""hidden"" name=""BSLABEL"" value=""SAVE^~BSC4cfg"">"
 D BU2
 W "</form></CENTER>"
ENTE D END2^%ZAPM.bs.BSCh
 Q
BU2      w "<input type=""SUBMIT"" name=""SubMit1""  value=""Запомнить""> "
 w "<input type=""RESET"" name=""Reset1""  ONCLICK=""window.close();""  value=""Отменить"">"
 Q       
SAVE ;СОХРАНИТЬ НОВЫЕ ПАРАМЕТРЫ
 N O
 D VAR
 D SAVEOPT^%ZAPM.bs.BSC4cfg(O)
 D END2^%ZAPM.bs.BSCh
 q
TITLE(TBL) ;вывести заголовок
 I $G(@TBL@("OPT"))=1 Q $P($G(@TBL@(2,4)),"@",15)
 E  Q $P($G(@TBL),"@",1)
 Q
OPT(TBL,NOFORM) ;ФОРМА С ПАРАМЕТРАМИ
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 N BSLABEL,BSTOP,BSNSP1
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 D BU2
 I '$D(@TBL@("OPT")) W $$LNG^%ZAPM.bs.BSC4("В таблице опций отсутствуют базовые параметры",160)_BK D BACK^%ZAPM.bs.BSCh G ENTE
 ;w "<input type=""hidden"" name=""BSROU"" value="""_$G(MainRef,"MAIN^~BSCh1")_""">"
 N I,II,P1,P2,P3,P4,P5,X,Y,S
 w BK,"<table border=0>",BK
 I $G(@TBL@("OPT"))'=1 S S=@$ZR F I=$S($P(S,",",3):$P(S,",",2),1:1):1 Q:'$D(@TBL@(I))  D  W BK
 .Q:'$P(S,",",2)  Q:'$P(S,",")
 .S P4=$P($G(@TBL@(I,+$P(S,",",1))),"@",15),P1=$P($G(@TBL@(I,+$P(S,",",2))),"@",15)
 .S P3=" SIZE=50 ",P5=$P($P($G(@TBL@(I,$P(S,",",2))),"@",18),"#")
 .I P4'="",$P($G(@TBL@(I,$P(S,",",2))),"@",5)="" D text1(P1,P3,P5)
 I $G(@TBL@("OPT"))=1 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D  W BK
 .S P1=$P(@TBL@(I,1),"@",15),P2=$P(@TBL@(I,2),"@",15),P3=$P(@TBL@(I,3),"@",15)
 .S P4=$P(@TBL@(I,4),"@",15),P5=$P(@TBL@(I,5),"@",15)
 .D TAB
 I $$GETOPT(TBL,"NO")
 w "</table>"
 Q
TAB ;ТЕКУЩАЯ СТРОКА
 I P2="textarea" D  Q
 .W "<tr><td align=""right""><textarea name="""_$$name(P5)_""" "_P3_" >"_P1_"</textarea></td><td>",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 I P2="text" D text(P1,P3,P5) Q
 I P2="checkbox" D  Q
 .W "<tr><td align=""right""><input type=""checkbox"" name="""_$$name(P5)_""" value="""_P1_""" "_P3_$$ch(P1)_"></td><td>",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 I P2="radio" w "<p>",BK D  Q
 .F II=1:1:$L(P4,"~") W "<tr><td align=""right""><input type=""radio"" name="""_$$name(P5)_""" value="_II_" "_P3_$$ch(P1=II)_"></td><td>",$$TEGS^%ZAPM.bs.BSre($P(P4,"~",II)),"</td></tr>",BK
 .w "</p>"
 Q       
text(P1,P3,P5) W "<tr><td align=""right""><input type=""text"" name="_$$name(P5)_" "_P3_" value='"_P1_"'></td><td>",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 Q
text1(P1,P3,P5) W "<tr><td align=""right"">",$$TEGS^%ZAPM.bs.BSre(P4),"</td><td><input type=""text"" name="_$$name(P5)_" "_P3_" value='"_P1_"'></td></tr>"
 Q
name(P) ;ИМЯ КОМПОНЕНТЫ
 I P="" Q $QS(TBL,1)_I
 Q P
ch(P) I P q " checked "
 q ""
SAVEOPT(TBL) ;ПРИСВОЕНИЕ
 N I,C,N,S
 ;W "<BODY >",BK
 W "<BODY onload='window.close();'>",BK
 W "<CENTER>"
 W "<H3>"_$$LNG^%ZAPM.bs.BSC4("Опции запомнены",161)_"</H3>"
 
 W "<HR></CENTER>"
 I $G(@TBL@("OPT"))'=1 S S=@$ZR F I=$S($P(S,",",3):$P(S,",",2),1:1):1 Q:'$D(@TBL@(I))  D
 .Q:'$P(S,",",2)  Q:'$P(S,",")  Q:$P($G(@TBL@(I,$P(S,",",2))),"@",5)'=""
 .;S P4=$P($G(@TBL@(I,+$P(S,",",1))),"@",15),P1=$P($G(@TBL@(I,+$P(S,",",2))),"@",15)
 .S N=$P($P($G(@TBL@(I,$P(S,",",2))),"@",18),"#") i N="" s N=$QS(TBL,1)_I
 .I $TR($G(%KEY(N)),"@","")=$G(%KEY(N)) S $P(@TBL@(I,$P(S,",",2)),"@",15)=$G(%KEY(N)) Q
 .S $P(@TBL@(I,$P(S,",",2)),"@",15)=$TR($G(%KEY(N)),"@","") D PROT(N)
 
 I $G(@TBL@("OPT"))=1 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .S C=$P($G(@TBL@(I,2)),"@",15)
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .I C="checkbox" D  Q
 ..I $D(%KEY(N)) S $P(@TBL@(I,1),"@",15)=1
 ..E  S $P(@TBL@(I,1),"@",15)=0
 .I $TR($G(%KEY(N)),"@","")=$G(%KEY(N)) S $P(@TBL@(I,1),"@",15)=$G(%KEY(N)) Q
 .S $P(@TBL@(I,1),"@",15)=$TR($G(%KEY(N)),"@","") D PROT(N)
 Q
PROT(N) ;ЗАПИСЬ ЗАПРЕЩЕННОГО
 W "<br>"_$$LNG^%ZAPM.bs.BSC4("Параметр",162)_" '"_N_"' "_$$LNG^%ZAPM.bs.BSC4("имеет запрещенный символ",163)_" '@': "_RED_$G(%KEY(N))_EF_"<br>"
 W "<br>"_$$LNG^%ZAPM.bs.BSC4("Запомнили",164)_" : "_GREEN_$TR($G(%KEY(N)),"@","")_EF_"<br>"
 Q
GETOPT(TBL,NO,NK) ;ВОЗВРАТИТЬ ЗНАЧЕНИЕ ОПЦИИ NO
 ;NO - ИМЯ ПОКАЗАТЕЛЯ
 ;NK - НОМЕР КОЛОНКИ В ТАБЛИЦЕ 
 N N,I,Q S Q="?"
 try { ;в TBL может быть ссылка на несуществующую область
	 I $G(@TBL@("LST"),1)'=$G(@TBL@("OPT","LST")) D GREATINDX
 } catch e {}
 I $G(@TBL@("OPT","LST",NO))'="" S I=$G(@TBL@("OPT","LST",NO)) Q $P($G(@TBL@(I,$G(NK,1))),"@",15)
 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .I N=NO S Q=$P($G(@TBL@(I,$G(NK,1))),"@",15) Q
 Q Q
SETOPT(TBL,NO,Q,NK) ;ПРИСВОИТЬ ЗНАЧЕНИЕ ОПЦИИ NO=Q
 N N,I
 I $G(@TBL@("LST"),1)'=$G(@TBL@("OPT","LST")) D GREATINDX
 I $G(@TBL@("OPT","LST",NO))'="" S I=$G(@TBL@("OPT","LST",NO)),$P(@TBL@(I,$G(NK,1)),"@",15)=Q Q
 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .I N=NO S $P(@TBL@(I,$G(NK,1)),"@",15)=Q Q
 Q
GREATINDX //СОЗДАТЬ ИНДЕКС ПОКАЗАТЕЛЕЙ ОПЦИЙ
 S $ZT="ERRGREAT^%ZAPM.bs.BSC4cfg"
 K @TBL@("OPT","LST") S @TBL@("OPT","LST")=$G(@TBL@("LST"),1)
 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .S @TBL@("OPT","LST",N)=I
 Q
ERRGREAT Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4cfgP" type="MAC" languagemode="0"><![CDATA[
%BSC4cfgP ;БИБЛИОТЕКА ФУНКЦИЙ РАБОТЫ С ТАБЛИЦАМИ ПАРАМЕТРОВ ; 21:44   21.12.2002
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
A(TIT,BSBD,BSBD1,d,W,H) ;ЯКОРЬ
 N BSLABEL,BSMODE S BSLABEL="ENTER^~BSC4cfgP",BSMODE=d
 Q "<a name='Param1' title='"_BSBD_"' class=u1 "_$$on(BSLABEL)_" >"_TIT_"</a>"
on(BSLABEL) I $G(BSBD1)="" K BSBD1
 q " onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""",""Button"_$TR($G(BSSES),".","")_""",""toolbar=no,menubar=no,scrollbars=yes,width="_$G(W,800)_",height="_$G(H,500)_",status=1,resizable=1"");' "
B(TIT,BSBD,BSBD1,d,W,H) ;кнопка
 N BSLABEL,BSMODE,Q S BSLABEL="ENTER^~BSC4cfgP",BSMODE=d,Q=""
 S Q=Q_"<BUTTON name='Param1' "_$$on(BSLABEL)_" >"_TIT_"</BUTTON>"
 Q Q
BP(A1,A2,G1,G2,M,AN,IMG) //УНИВЕРСАЛЬНЫЙ ВЫЗОВ ПАРАМЕТРОВ
 N BSTITLE S BSTITLE=$$TR^%ZAPM.bs.BSsFUNM(A1," ","%20")
 I $G(AN)="" Q $$B("<img src='"_BSDOMAIN_"/img/"_$G(IMG,"param.gif")_"' ALT='"_A2_"'>",$$%T^%ZAPM.bs.BSCh(G1),$$%T^%ZAPM.bs.BSCh(G2),M)
 Q $$A("<img src='"_BSDOMAIN_"/img/"_AN_"' ALT='"_A2_"'>",$$%T^%ZAPM.bs.BSCh(G1),$$%T^%ZAPM.bs.BSCh(G2),M)
VARI //СОЗДАНИЕ ЛОКАЛЬНЫХ ПЕРМЕННЫХ
 S O=$$SW^%ZAPM.bs.BSF12($$%^%ZAPM.bs.BSCh(BSBD)),OO=$$SW^%ZAPM.bs.BSF12($$%^%ZAPM.bs.BSCh($G(BSBD1)))
 ;S ^%ZZZ(1)=O,^%ZZZ(2)=OO
 ;S ArrOUT=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")")
 Q
ENTER //
 D VARI
 D OPEN(O,OO,$G(BSMODE,0))
 Q
OPEN(O,OO,BSMODE) ;основной вход в таблицу опций
 ;MODE=0  ТОЛЬКО СМОТРЕТЬ ПАРАМЕТРЫ
 ;MODE=1  РЕДАКТИРОВАТЬ ПАРАМЕТРЫ
 ;MODE=2  РЕДАКТИРОВАТЬ И САМУ ТАБЛИЦУ ПАРАМЕТРОВ
 I OO="" S OO=O
 D BEG1^%ZAPM.bs.BSC4
 W "<TITLE> "_$$place(OO)_$$TITLE(OO)_" _________________________________</TITLE></HEAD>",BK
 W "<BODY onkeyPress=""javascript: if (27 == event.keyCode) window.close(); "">"_BK
 W "<CENTER>"
 D  //ПРОГРАММЫ ПРЕДОБРАБОТКИ
 .N OP,p1 
 .S OP="" F  S OP=$O(@O@(OP)) Q:OP=""  I $G(@O@(OP,"T"))="HR" S p1=$G(@O@(OP,"V")) I p1["^" D @p1
 D OPT(O,OO,BSMODE)
 ;w "<BR><input type=""hidden"" name=""BSNSP"" value="""_BSNSP_""">"
 ;w "<BR><input type=""hidden"" name=""BSLABEL"" value=""SAVE^~BSC4cfg"">"
 I '$D(NoBU2) D BU2 //ВЫВОДИТЬ ВТОРОЙ РАЗ КНОПКУ СОХРАНЕНИЯ
 W "</form></CENTER>"
 D END^%ZAPM.bs.BSC4 Q
ENTE D END2^%ZAPM.bs.BSCh
 Q
BU2 ;I BSMODE w "<input type=""SUBMIT"" name=""SubMit1""  value=""Запомнить""> "
 ;w "<input type=""RESET"" name=""Reset1""  ONCLICK=""window.close();""  value=""Отменить"">"
 ;w "<INPUT name=bSAV title='сохранить текущую коррекцию' TYPE='submit' VALUE='Запомнить'>"_BK
 w "<BUTTON tabindex=0 onclick='submit();' title='сохранить текущую коррекцию' VALUE='сохранить' ><IMG SRC='"_BSDOMAIN_"/img/save.gif'></BUTTON>"_BK
 W "<BUTTON onclick='window.close();' title='отменить текущее изменение'><IMG SRC='"_BSDOMAIN_"/img/del.gif' ></BUTTON>"_BK
 q
GetAcc(L,A) //ВОЗВРАТИТЬ ПРАВА ДОСТУПА ДЛЯ ПОЛЬЗОВАТЕЛЯ L К ПРИЛОЖЕНИЮ A 
 N BD,D,U
 ;S BD="^%ZAPM.bs.BSc4uSERS" ;
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")
 S D=$$GETOPT($NA(@BD@(L,"FNM")),A,,"^[""%SYS""]BSC4.ISS.Access")
 I D'="" Q D  //СВОИ ПРАВА ИМЕЮТ НАИВЫСШИЙ ПРИОРИТЕТ
 S U=$G(@BD@(L,"ARRAY")) I U="" Q D
 I $G(GetAccLU(L))>2 Q D
 S GetAccLU(L)=$G(GetAccLU(L))+1 ;
 ;S ^%ZZZ($I(^%ZZZ))=A
 S U=$$GetAcc(U,A) //ПРАВА ЭКВИВАЛЕНТНОГО ПОЛЬЗОВАТЕЛЯ
 I D?1N,U?1N,D>U Q D  //ПРАВ ТОТ У КОГО БОЛЬШЕ ПРАВ
 I D?1N,U?1N,D'>U Q U
 Q U
place(T) Q $ZU(110)_"/"_$QS(T,-1)_"/"_$QS(T,0)_"/"_$QS(T,1)_"/"
TITLE(TBL) ;вывести заголовок БАЗЫ ДАННЫХ ТАБЛИЦЫ ПАРАМЕТРОВ
  N A S A=$P($G(@TBL),"@",4) I A="" S A=$G(BSTITLE)
  ;I A="" S A=$QS(TBL,1)
  Q A
OPT(TBL,OO,BSMODE) ;ФОРМА С ПАРАМЕТРАМИ
 W "<form name='first1' action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 N BSLABEL,BSTOP,BSNSP1,FirstNam
 I BSMODE S BSLABEL="SAVE^~BSC4cfgP"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 D BU2 W "<HR>"
 I $O(@TBL@(""))="" W "<DIV title='"_TBL_"'>В ШАБЛОНЕ опций '"_TBL_"' отсутствуют данные</DIV>"_BBK G ENTE
 N I,II,P1,P2,P3,P4,P5,X,Y,S,D,D2,D3,D4,OP,DIS
 w BK,"<table border=0>",BK
 S OP="",DIS="" I 'BSMODE S DIS=" disabled "
 F  S OP=$O(@TBL@(OP)) Q:OP=""  S P4=$G(@TBL@(OP,"O")),P3=$G(^("T")),D5=$G(^("D")),P1=$G(@OO@(OP,"V")) D
 .I P3="HR" W "</table><table width=100% border=0><tr><td align='center' class=s5>"_P4_"</td></tr></table><table>" Q
 .S D3=+P3,P2=$S(D3=1:"textarea",D3=2:"radio",D3=3:"checkbox",1:"text"),P5=OP I P1="" S P1=D5
 .S P3=$P(P3," ",2,99),D4=" title='"_OP_"' "_DIS I P3="" S P3=" size=50 "
 .D TAB
 w "</table><HR>"
 I '$D(FirstNam) Q
 W BK D JS^%ZAPM.bs.BSCp W BK
 w "first1."_FirstNam_".focus();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
TAB ;ТЕКУЩАЯ СТРОКА
 I D3=6 D  Q  //COMBOBOX
 .W BK_BK_"<tr><td align=""right"" class=s1 ><SELECT name="_$$name(P5,1)_" >"  D  W "</SELECT></td><td class=s1 >"_$P($$TEGS^%ZAPM.bs.BSre($P(P4,"~",1)),":")_"</td></tr>"
 ..N p4 S p4=P4 I P4[":" S p4=$P(P4,":",2,99) 
 ..F II=1:1:$L(p4,"~") W "<OPTION value="_II_" "_P3_D4_" "_$S(P1=II:"SELECTED",1:"")_" >"_$$TEGS^%ZAPM.bs.BSre($P(p4,"~",II))_"</OPTION>",BK
  I P2="textarea" D  Q
 .W "<tr><td align=""right"" class=s1 ><textarea name="_$$name(P5,1)_" "_$S(P3["size=50":" cols=50 rows=3 ",1:P3)_D4_" >"_P1_"</textarea></td><td class=s1 >",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 I P2="text" D text(P1,P3,P5) Q
 I P2="checkbox" D  Q
 .W "<tr><td align=""right"" class=s3 ><input type=""checkbox"" name="_$$name(P5)_" value="""_P1_""" "_P3_D4_$$ch(P1)_"></td><td class=s3 >",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 I P2="radio" w "<p>",BK D  Q
 .F II=1:1:$L(P4,"~") W "<tr><td align=""right"" class=s4 ><input type=""radio"" name="_$$name(P5)_" value="_II_" "_P3_D4_$$ch(P1=II)_"></td><td class=s4 >",$$TEGS^%ZAPM.bs.BSre($P(P4,"~",II)),"</td></tr>",BK
 .w "</p>"
 Q
text(P1,P3,P5) W "<tr><td align=""right"" class=s2 ><input type=""text"" name="_$$name(P5,1)_" "_P3_D4_" value='"_P1_"'></td><td class=s2 >",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 Q
name(P,T) ;ИМЯ КОМПОНЕНТЫ
 I P="" S P=$QS(TBL,1)_I
 I '$D(FirstNam),$d(T) S FirstNam=P
 Q "'"_P_"'"
ch(P) I P q " checked "
 q ""
SAVE ;СОХРАНИТЬ НОВЫЕ ПАРАМЕТРЫ
 D VARI
 D SAVEOPT(O,OO,$G(BSMODE,0))
 D END2^%ZAPM.bs.BSCh
 q
SAVEOPT(TBL,OO,BSMODE) ;ПРИСВОЕНИЕ
 I OO="" S OO=TBL
 N C,N,S,LABPRE,LABPOST,StopSave
 N I,II,P1,P2,P3,P4,P5,X,Y,S,D,D2,D3,D4,OP
 W "<BODY >",BK
 ;W "<BODY onload='window.close();'>",BK
 ;W "<CENTER>"
 ;W "<H3>"_$$LNG^%ZAPM.bs.BSC4("Опции запомнены",161)_"</H3>"
 ;W "<HR></CENTER>"
 Q:BSMODE<1
 S OP="" F  S OP=$O(@TBL@(OP)) Q:OP=""  S P4=$G(@TBL@(OP,"O")),D3=$G(^("T")),D5=$G(^("D")),P1=$G(@OO@(OP,"V")) D
 .I D3="HR" I D5["^" S LABPOST=D5 //ПОЛЬЗОВАТЕЛЬСКАЯ ПРОГРАММА ПОСТ-СОХРАНЕНИЯ ПАРАМЕТРОВ
 .S C=$S(D3=1:"textarea",D3=2:"radio",D3=3:"checkbox",1:"text"),N=OP
 .I C="checkbox" D SE($NA(@OO@(N,"V")),$S($D(%KEY(N)):1,1:0)) Q
 .D SE($NA(@OO@(N,"V")),$G(%KEY(N)))
 D SNX^%ZAPM.bs.BSChT1("S",OO,TBL,$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")"))
 I $G(LABPOST)'="" D  Q:$G(StopSave)=2  I $G(StopSave) G ENTER
 .;D locvar^%ZAPM.bs.BSCh0("")
 .D @LABPOST
 W BK D JS^%ZAPM.bs.BSCp W BK
 w "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
SE(G,S) I S="" K @G Q
 S @G=S Q
GETOPT(TBL,NO,NK,SH) ;ВОЗВРАТИТЬ ЗНАЧЕНИЕ ОПЦИИ NO 
 ;NO - ИМЯ ПОКАЗАТЕЛЯ
 ;NK - другие поля параметра V D,O,T  имеет значение если TBL - ШАБЛОН
 ;SH - ШАБЛОН ОТКУДА БРАТЬ ЗНАЧЕНИЯ ПО-УМОЛЧАНИЮ
 I TBL=""!(NO="") Q ""
 S TBL=$$SW^%ZAPM.bs.BSF12(TBL)
 S NK=$G(NK,"V")
 I $D(SH),'$D(@TBL@(NO,NK)) Q $G(@SH@(NO,"D"))
 Q $G(@TBL@(NO,NK))
SETOPT(TBL,NO,NK,VAL) ;ПРИСВОИТЬ ЗНАЧЕНИЕ ОПЦИИ NO
 ;NO - ИМЯ ПОКАЗАТЕЛЯ
 ;NK - другие поля параметра V D,O,T имеет значение если TBL - ШАБЛОН
 I TBL=""!(NO="") Q ""
 I $G(NK)="" S NK="V"
 S NK=$G(NK,"V")
 S TBL=$$SW^%ZAPM.bs.BSF12(TBL)
 D SE($NA(@TBL@(NO,NK)),VAL)
 Q
Save123 //СОХРАНЕНИЕ ОБЩЕСИСТЕМНЫХ ПАРАМЕТРОВ (СИНИЙ МОЛОТОК)
 S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb")
 I A'="" S $P(^%ZAPM.bs.BSpgWEBC("Control"),",",7)=A
 S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aterm")
 I A'="" S $P(^%ZAPM.bs.BSpgBS("Control"),",",7)=A
 S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atmdapi")
 I A'="" S ^%ZAPM.bs.BSCmdapicfg("port")=A
 S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkmail")
 I A'="" D
 .K ^%ZAPM.bs.BSpgWEM("HOST"),^%ZAPM.bs.BSpgWEMM("HOST") S ^%ZAPM.bs.BScSMTP($ZCONVERT($ZU(110),"U"),"POP")=$P(A,",",2),^%ZAPM.bs.BScSMTP($ZCONVERT($ZU(110),"U"),"SMTP")=$P(A,",",1)
 .S ^%ZAPM.bs.BSpgWEM("HOST",$ZCONVERT($ZU(110),"U"))=A,^%ZAPM.bs.BSpgWEMM("HOST",$ZCONVERT($ZU(110),"U"))=A
 .S ^%ZAPM.bs.BSpgWEM("HOST")=$ZCONVERT($ZU(110),"U"),^%ZAPM.bs.BSpgWEMM("HOST")=$ZCONVERT($ZU(110),"U")
 i $P($g(%BS(44)),",",1) D SYSMSG^%ZAPM.bs.BSCek("User: "_$g(BSLOGIN)_" Change System Parametrs.","W")
 // w $$w2f^%ZAPM.bs.BSCp2("N:\!\FnameSYS.LOG")
 D Tex^%ZAPM.bs.BSMSMF("ChangeSysParametrs","")
 Q
Save1234 //СОХРАНЕНИЕ ПАРАМЕТРОВ ПРАВ ДОСТУПА ПОЛЬЗОВАТЕЛЯ (ЧЕРНЫЙ МОЛОТОК)
 S A=$G(@OO@("Amail","V")),NM=$QS(OO,1),NMU=$ZCONVERT($QS(OO,1),"U") //?????
 S SN=$ZCONVERT($ZU(110),"U")
 I A D
 .S ^%ZAPM.bs.BSpgWEM("USER",NM)=$QS(OO,1)
 .S ^%ZAPM.bs.BSpgWEM("USER",NMU)=$QS(OO,1)
 .S ^%ZAPM.bs.BSpgWEM("HOST")=SN
 I 'A K ^%ZAPM.bs.BSpgWEM("USER",NM),^%ZAPM.bs.BSpgWEM("USER",NMU) ;В ПРОТИВНОМ СЛУЧАЕ УДАЛИМ ...
 
 K ^%ZAPM.bs.BSpgWEMM("HOST"),^%ZAPM.bs.BSpgWEMM("USER") 
 M ^%ZAPM.bs.BSpgWEMM("HOST")=^%ZAPM.bs.BSpgWEM("HOST")
 M ^%ZAPM.bs.BSpgWEMM("USER")=^%ZAPM.bs.BSpgWEM("USER")
 i $P($g(%BS(44)),",",1) D SYSMSG^%ZAPM.bs.BSCek("User: "_$g(BSLOGIN)_" ChangeUserParametrs For: "_NM_".","W")
 
 // w $$w2f^%ZAPM.bs.BSCp2("N:\!\Fname.LOG")
 
 D Tex^%ZAPM.bs.BSMSMF("ChangeUserParametrs","For: "_NM)
 Q
 
]]></Routine>


<Routine name="%ZAPM.bs.BSC4demon" type="MAC" languagemode="0"><![CDATA[
%BSC4demon ; ФОНОВЫЙ ПРОЦЕС СИСТЕМНЫХ РАБОТ (СУПЕРВИЗОР,МУСОРЩИК...) ; 15:36   05.09.2002
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
START D GTmp
 L +%BSDemon:0 E  H
 S CFG="^[""%SYS""]BSC4.CFG.DemonCFG"
 S CMD="^[""%SYS""]BSC4.CFG.DemonCMD"
 k @GTmp 
 ;S $ZT="Err"
 s $P(@GTmp,"~",1)=$$TD^%ZAPM.bs.BSC4base($H) //ВРЕМЯ СТАРТА ДЕМОНА
 S BDSES=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")")
 S BDRouRef=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""RouRef"")")
 S BSPIN="%BSdemon"
 I $D(BSLOGIN) S BSLOGIN="%BSdeamon"
  S @GTmp@(1)=BDSES
 D MAINVAR^%ZAPM.bs.BSC4
  S @GTmp@(2)=RED
1 HANG $G(@CFG@("Interval","Val"),1) //ЦИКЛ С ИНТЕРВАЛОМ
 S C="" F  S C=$O(@CMD@(C))  Q:C=""  D
 .I $$HoldActivate Q
 .S If=$G(@CMD@(C,"If"),0),Cmd=$G(@CMD@(C,"Cmd"),"Dummy")
 .w "." D
 ..;w !,"CMD: "_"I "_If_" D "_Cmd  ;S @GTmp@($H)="CMD: "_"I "_If_" D "_Cmd 
 ..X "I "_If_" D "_Cmd_" w !,$$TD^%ZAPM.bs.BSC4base($H)_"" ""_Cmd" //КОМАНДА ПРИ УСЛОВИИ
 G 1
 ;Err S @GTmp@($H)=$ZE
 Q
GTmp S GTmp="^[""%SYS""]mtemp.Demon"
 Q       
Report //сделать новый отчет по ресурсам
 ;ЗАПУСК ПОДСЧЕТА У КОГО СКОЛЬКО БАЙТ НАТИКАЛО
 D RR^%ZAPM.bs.BSC4rout
 Q
ReportNewDay() S BDSTAT="^[""%SYS""]BSC4.CFG.UStatus("""_$ZD($H,8)_""")"
 i '$d(@BDSTAT) q 1
 Q 0
NewDay(BDS) I $G(BDS)="" Q 0
 i '$d(@BDS) S @BDS=$H q 1
 Q 0
RouRefCheck //Контроль потерянных ссылок на программы
 S I="" F  S I=$O(@BDRouRef@(I)) Q:I=""  S n1=$G(@BDRouRef@(I,"Name")),n2=$G(@BDRouRef@(I,"Namespace")) D
 .I $$EXIST^%R(n1_".MAC",n2) Q
 .I $$EXIST^%R(n1_".INT",n2) Q
 .k @BDRouRef@(I)
 q
SessCheck //Контроль незакрытых сессий
 S KS=$G(@CFG@("Sess","Val"),20)*60 //Сколько минут не закрывать насильно, брошенную сессию
 S KD=$G(@CFG@("SessDay","Val"),3) //Сколько дней не удалять ссылку на сессию
 I $D(BSLOGIN) S BSLOGIN="%BSdeamon"
 S I="" F  S I=$O(@BDSES@(I)) Q:I=""  S CHR=$G(@BDSES@(I,"CHR")),CUR=$G(@BDSES@(I,"CUR")) D
 .w !,"ceссия "_I  
 .i CHR'="" w " закрыта "_$$TD^%ZAPM.bs.BSC4base(CHR)
 .e  w " не закрыта"
 .I CHR'="" D  Q  //УДАЛЕНИЕ ЗАКРЫТЫХ СЕССИЙ
 ..s ra=$H-CHR w " if "_ra_">"_KD
 ..I (ra>KD) D  K @BDSES@(I) w " удаляем ",$zr D DelUser^%ZAPM.bs.BSCp("",I) Q
 ...//СУММИРОВАНИЕ СЧЕТЧИКОВ В БАЗУ ДАННЫХ ВИЗИТОВ
 ...D Tex^%ZAPM.bs.BSMSMF("EraseSess",$G(@BDSES@(I,"OHR"))_","_$G(@BDSES@(I,"COUNT"))_","_$G(@BDSES@(I,"CUR"))_","_$G(BSLOGIN)_","_$G(I))
 .s ra1=$H*86400+$P($H,",",2),ra2=(CUR*86400+$P(CUR,",",2)) w " if ("_ra1_"-"_ra2_")>"_KS
 .I (ra1-ra2)>KS S @BDSES@(I,"CHR")=$H w " закрываем ",$zr D DelUser^%ZAPM.bs.BSCp("",I) //НАСИЛЬНОЕ ЗАКРЫТИЕ СЕССИИ
 q
 ;S (^mtempBSsinx,^mtempBSprot)=1 //СБРОС СИСТЕМНЫХ СЧЕТЧИКОВ
RJCheck() //проверить есть ли команды в глобали
 n i
 s i="" f  s i=$O(@GTmp@(i)) q:i=""   i $G(@GTmp@(i))=0 j RJExe^%ZAPM.bs.BSC4demon($na(@GTmp@(i)))::0 //Запустить процесс
 q 1
RJExe(zr) //выполнить команду
 i $I(@zr)=1 x $g(@zr@("cmd"))
 Q       
SessTimeHour() //Срабатывать в начале каждого часа
 S CT=$P($h,",",2)\3600
 I CT'=$G(CTIME) S CTIME=CT Q 1
 Q 0
EvTimeSec(CTIMEm,M) //Срабатывать КАЖДЫЕ М СЕКУНД
 S CTm=$P($h,",",2)\$G(M,60)
 I CTm'=$G(@CTIMEm) S @CTIMEm=CTm Q 1
 Q 0
HoldActivate() Q $G(@CFG@("Hold","Val"),0) //задержать работу Демона
Halt H  //остановить Демон - задание снять
HaltActivate() Q $G(@CFG@("Halt","Val"),0)
Check(S) //проверка подвисших заданий (сек разрешено выполняться)
 Q
CheckKJ(JOB) N ONSP S ONSP=$ZU(5) I $$ZU^%ZAPM.bs.BSF4("%SYS")
 S RET=$$INT^RESJOB(JOB) //УДАЛИТЬ ПОДВИСШЕЕ ЗАДАНИЕ
 I $$ZU^%ZAPM.bs.BSF4(ONSP)
 Q
Dummy Q
STATUS ;СТАТУС ТАЙМЕРА
 L +%BSDemon:0 I  W !,"%BS-Demon NOT ACTIVE." Q
 W !,"%BS-Demon ALLREADY STARTED."
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4r" type="MAC" languagemode="0"><![CDATA[
%BSC4r ;Трансляция и контроль кода ; 15:37   05.09.2002
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
DelBS ;УДАЛИТЬ ВЕСЬ ИСХОДНЫЙ КОД КОМПЛЕКСА
 S I="%BS" D  F  S I=$O(^ROUTINE(I)) Q:I'["%BS"  D
 .D DelSours(I)
 Q
DelSours(ro) K ^ROUTINE(ro,0),^rMAC(ro,0) ;УДАЛИТЬ ИСХОДНЫЙ ТЕКСТ
 Q
DelBSAll ;УДАЛИТЬ ВЕСЬ КОМПЛЕКС
 I '$$ZU^%ZAPM.bs.BSF4("%SYS") Q
 //I $ZU(5,"%SYS")="" Q
 S I="^%ZAPM.bs.BS" D  F  S I=$O(^$GLOBAL(I)) Q:I'["^%ZAPM.bs.BS"  D
 .K @I
 S I="%BS" D  F  S I=$O(^rINC(I)) Q:I'["%BS"  D
 .K ^rINC(I)
 S I="%BS" D  F  S I=$O(^ROUTINE(I)) Q:I'["%BS"  I I'=$ZN D
 .D DEL1^%ZAPM.bs.BSC4r4(I_".*")
 X "D DEL1^%ZAPM.bs.BSC4r4($ZN_"".*"")"
 Q
XECUTE(CODE)
 N pin,Rou S pin="Temp",Rou=BSRoutineId
 I $$CheckRou^%ZAPM.bs.BSC4base1(CODE) D @("^"_pin_"."_Rou),DEL1^%ZAPM.bs.BSC4r4(pin_"."_Rou_".*") Q
 Q
GetResultRef(A,F) ;возвратить результат ссылки
 i $e(A,1)="^" q $$GetTableBS^%ZAPM.bs.BSCi($P(A,":",1),$P(A,":",2),$P(A,":",3),$P(A,":",4),$P(A,":",5)) ;это таблица/текст %BS
 i $e(A,1)="/"!($e(A,1,4)="HTTP")!($e(A,1,4)="http") q $$onLOAD(A,F) ;создание страницы с JS кодом на загрузку A-URL
 i $e(A,1,6)="DoMaIn" q $$onLOAD($$TR^%ZAPM.bs.BSsFUNM(A,"DoMaIn",BSDOMAIN),F) ;--//--
 i A'="^%" q @A
 q A
onLOAD(A,F) ;
 N Q S Q="<HTML><HEAD>"_$$meta^%ZAPM.bs.BSC4_BK
 S Q=Q_"<script LANGUAGE=""JavaScript""><!--"_BK
 S Q=Q_"function ReSet() {"_BK
 ;S Q=Q_"alert('"_A_"');"_BK
 S Q=Q_"parent."_F_".location='"_A_"';"_BK
 S Q=Q_"}"_BK
 S Q=Q_"// --></script>"_BK
 S Q=Q_"</HEAD>"_BK
 S Q=Q_"<BODY onload='ReSet();'>"_BK
 S Q=Q_"</BODY></HTML>"_BK
 Q Q
href(C) ;СГЕНЕРИТЬ CGI ПЕРЕМЕННЫЕ В ФОРМАТЕ GET
 Q $$add^%ZAPM.bs.BSC4rou_C
GetTabProp(P,T,NF) //ВОЗВРАТИТЬ ЗНАЧЕНИЕ СВОЙСТВ ПОЛЯ
 Q "ПОКА ТАК!"
GetDirTabFile(P,T,Key,NF,FILE) //ВОЗВРАТИТЬ ПУТЬ И ИМЯ ФАЙЛА ЛЕЖАЩЕЕ В ПОЛЕ, ЕСЛИ ПОЛЕ - FILESTREAM
 N FF,FN1,FN2,PTab
 S FF=$$GetDirectTab(P,T,.Key,NF) I FF="" Q ""
 S FN2=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PTab@("Parms")),"DF"),FN1=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PTab@("ParmsCell",NF)),"xSubDir")
 S FN2=##class(%File).NormalizeDirectory(FN2_FN1)_FF
 I $D(FILE) S FILE(1)=FN2
 I $ZU(140,4,FN2)'=0 Q ""
 I $D(FILE) S FILE(2)=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PTab@("Parms")),"WF")_FN1_FF
 Q FN2
GetDirectTabN1(P,T,A,NF)
 N Key
 S Key=1,Key(1)=A
 Q $$GetDirectTab(P,T,.Key,NF)
GetDirectTabN2(P,T,A1,A2,NF)
 N Key
 S Key=2,Key(1)=A1,Key(2)=A2
 Q $$GetDirectTab(P,T,.Key,NF)
GetDirectTabN3(P,T,A1,A2,A3,NF)
 N Key
 S Key=3,Key(1)=A1,Key(2)=A2,Key(3)=A3
 Q $$GetDirectTab(P,T,.Key,NF)
GetDirectTabN4(P,T,A1,A2,A3,A4,NF)
 N Key
 S Key=4,Key(1)=A1,Key(2)=A2,Key(3)=A3,Key(4)=A4
 Q $$GetDirectTab(P,T,.Key,NF)
GetDirectTabN5(P,T,A1,A2,A3,A4,A5,NF)
 N Key
 S Key=5,Key(1)=A1,Key(2)=A2,Key(3)=A3,Key(4)=A4,Key(5)=A5
 Q $$GetDirectTab(P,T,.Key,NF)
GetDirectTabN6(P,T,A1,A2,A3,A4,A5,A6,NF)
 N Key
 S Key=6,Key(1)=A1,Key(2)=A2,Key(3)=A3,Key(4)=A4,Key(5)=A5,Key(6)=A6
 Q $$GetDirectTab(P,T,.Key,NF)
GetDirectTab(P,T,Key,NF) //ВОЗВРАТИТЬ ЗНАЧЕНИЕ ПОЛЯ КОНКРЕТНОЙ ЗАПИСИ
 N GL,K,KK,G
 i NF="" ZT "SUBSC"
 D GL
 //i GL["%" ZT "%Prot"
 ;W pin,0,G,1 ZW Key
 F K=1:1:Key Q:'$D(Key(K))  I Key(K)'="" S G=$NA(@G@(Key(K)))
 ;ZW Key
 S KK=$G(@G@(NF))
 Q KK
GL I $E(P,1)="^" S PTab=$NA(@P@(T)),G=$$KBD^%ZAPM.bs.BSF12(PTab) Q
 I '$D(%ZName) S GL="^"_P_"."_T,PTab=$NA(@("^"_P)@(T))
 E  S GL="^"_$P($P(%ZName,"."),"^",2)_"."_P_"."_T,PTab=$NA(@("^"_$P($P(%ZName,"."),"^",2)_"."_P)@(T)) i GL["%" ZT "%Prot"
 S G=GL
 Q
KillDirectTab(P,T,Key)
 N GL,K,KK,G
 D GL
 //i GL["%" ZT "%Prot"
 F K=1:1:Key Q:'$D(Key(K))  I Key(K)'="" S G=$NA(@G@(Key(K)))
 K @G
SetDirectTab(P,T,Key,NF,VAL)
 N GL,K,KK,G
 i NF="" ZT "SUBSC"
 D GL
 //i GL["%" ZT "%Prot"
 F K=1:1:Key Q:'$D(Key(K))  I Key(K)'="" S G=$NA(@G@(Key(K)))
 S @G@(NF)=VAL
 Q 1
ORDEr(P,T,Key,Node,Nap)
 N GL,K,KK,G
 D GL
 //i GL["%" ZT "%Prot"
 F K=1:1:Key-1 Q:'$D(Key(K))  I Key(K)'="" S G=$NA(@G@(Key(K)))
 S KK=$O(@G@(Node),Nap)
 ;I KK="" Q Node
 Q KK
RO(R,L) //ЗАПУСК ПРОГРАММ
 D @(L_"^"_R)
    Q
DoRou(P,R,L)
 N GL
 S GL=$P($P(%ZName,"."),"^",2)_"."_P_"."_R //это только в B4Y
 i GL["%" q
 D @(L_"^"_GL)
    Q
DDATA(S) ;$D
 I S["^" ZT "^Prot"
 I S["@" ZT "@Prot"
 Q $D(@S)
DGET(S) ;$G
 I S["^" ZT "^Prot"
 I S["@" ZT "@Prot"
 Q $G(@S)
DSET(S,V) ;SET @S=V
 ;w S," ",V," "
 I S["^" ZT "^Prot"
 I S["@" ZT "@Prot"
 S @S=V Q
DKILL(S) ;kill @S        ;w S," ",V," "
 I S["^" ZT "^Prot"
 I S["@" ZT "@Prot"
 k @S Q
DynSQLprep(SQL,%qHandle)        n %st S %st=##class(%DynamicQuery).SQLPrepare(.%qHandle,SQL) q:+%st'=1 %st      S %st=##class(%DynamicQuery).SQLExecute(.%qHandle) q %st
DynSQLfetch(%qHandle,%row,%stop)   D ##class(%DynamicQuery).SQLFetch(.%qHandle,.%row,.%stop) Q %stop
DynSQLColInfo(%COL,%qHandle)    D ##class(%DynamicQuery).SQLGetInfo(.%COL,.%PAR,.%IDI,.%qHandle) Q ""
DynSQLcol(%COL,%num)            Q $L($LI(%COL,%num),1)
DynSQLrow(%row,%num)            Q $LI(%row,%num)
DynSQLclose(%qHandle)            d ##class(%DynamicQuery).SQLClose(.%qHandle) Q ""
 
beg(tit) q "<html><HEAD>"_BK_$$STYLE^%ZAPM.bs.BSC4_BK_"</HEAD><title>"_tit_"</title>"
NumADD W $$beg(""_$$LNG^%ZAPM.bs.BSC4("Текст программы на языке",165)_" Cache'ObjectScript") I BSTMP["|" S BSTMP=$TR(BSTMP,"|",$C(34))
 N S,K,I,L,LA,LAB,Z0,Z1,Z2,Z3,Z4
 S S=$G(@BSTMP),K=$L(S,BK)
 S Z1="<strong title='"_$$LNG^%ZAPM.bs.BSC4("Коментарий программы",324)_"'>",Z0="</strong>"
 S Z2="<strong title='"_$$LNG^%ZAPM.bs.BSC4("SQL - утверждение COS программы",325)_"'>"
 S Z3="<strong title='"_$$LNG^%ZAPM.bs.BSC4("Метка программы",326)_"'>"
 S Z4="<strong title='"_$$LNG^%ZAPM.bs.BSC4("Макрос HTML кода",327)_"'>"
 W "<TT>" S BL=0,LA=0,LAB=""
  F I=1:1:K S L=$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM($P(S,BK,I),"<","&lt;"),">","&gt;") D  S L(I+1)=L,LA=LA+1,L(I+1,0)=$G(LAB)_"+"_LA
  .I L["&html" S L=BLUE_Z4_L_Z0_EF S BL=1 Q
  .I L="&gt;" S L=BLUE_Z4_L_Z0_EF S BL=0 Q
  .I BL S L=BLUE_Z4_L_Z0_EF Q
  .I $E(L,1)=" " S L="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"_L
  .E  S LAB=$P(L," ",1),L=RED_Z3_$P(L," ",1)_Z0_EF_" "_$P(L," ",2,999),LA=-1
  .I L[" ;" S L=$P(L," ;",1)_GREEN_Z1_" ;"_$P(L," ;",2,999)_Z0_EF
  .I L[" //" S L=$P(L," //",1)_GREEN_Z1_" //"_$P(L," //",2,999)_Z0_EF
  .I L["&sql" S L=$P(L,"&sql",1)_MAROON_Z2_"&sql"_$P(L,"&sql",2,999)_Z0_EF
  s I="" f  s I=$o(L(I)) q:I=""  W "<NOBR><a title='"_$G(L(I,0))_"'>",I,") </a>",L(I),"</NOBR><BR>",BK
  W "</TT></html>"
 Q
KeyWord W $$beg(""_$$LNG^%ZAPM.bs.BSC4("вывод списка ЗАРЕЗЕРВИРОВАННЫХ СЛОВ",166)_"")
 N S,K,I S S=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""Keywords"")")
  w "<h3>"_$$LNG^%ZAPM.bs.BSC4("Список зарезервированных системой слов",167)_"</H3>",BBK,BBK
  s I="" f K=1:1 s I=$o(@S@(I)) q:I=""  W "<LI> ",RED,I,EF," ",GREEN,$G(@S@(I,"Description")),EF,"</LI>",BBK
  W "</html>"
  Q
Protect W $$beg(""_$$LNG^%ZAPM.bs.BSC4("вывод списка запрещенных команд",168)_"")
 N S,K,I S S=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SafeCode"")")
  w "<h3>"_$$LNG^%ZAPM.bs.BSC4("Запрещены следующие команды и символы",169)_"</H3>",BBK,BBK
  s I="" f K=1:1 s I=$o(@S@(I)) q:I=""  W "<LI>  ",RED,I,EF," ",GREEN,$G(@S@(I,"Description")),EF,"</LI>",BBK
  W "</html>"
  Q
Security(S) ;проверка на небезопастный код COS
 N B,i,I,K
 S BDSC=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SafeCode"")"),S=$$LITL^%ZAPM.bs.BSsFUNM(S)
 s K=$L(S,BK)
 F I=1:1:K S S(I)=$P(S,BK,I)
 S S(0)=K K Sec
 s i="" f  s i=$o(@BDSC@(i)) q:i=""  I S[i F I=1:1:K I S(I)[i S Sec(I)=$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(S(I),"<","&lt;"),">","&gt;"),Sec(I)=$$TR^%ZAPM.bs.BSsFUNM(Sec(I),i,RED_i_EF)
 I $D(Sec) D  Q 0
 .s i="" f  s i=$o(Sec(i)) q:i=""  W i+1,") ",Sec(i),BBK
 Q 1
%R ;entery points
 ; #; This function currently assumes the calling parameters are valid.
 ; #; parameters:
 ; #;   rou - name.ext.ver of the routine to compile
 ; #;   .array - array of source code; array(0)=lines, array(1-n)=source
 ; #;   .err - errors detected ($LIST format, call $$FMTERR to display)
 ; #;   options:
 ; #;     L - Load saved routine into 'array' parameter
 ; #;     C - Compile
 ; #;     D - Delete source
 ; #;     S - Save
 ; #;     B - create Backup copy when saving MAC,INC routines
 ; #;     M - generate routine map (INTERNAL OPTION ONLY)
 ; #;     I - Bypass <PROTECT> errors (INTERNAL OPTION ONLY)
 ; #;   langmode - language mode, 0-9 (optional)
 ; #;   filedate - datestamp to be used (optional)
 ; #;   nsp - desired namespace (optional)
 ; #; return:
 ; #;   1 for success; 0 for failure if any of the specified options do not succeed
 ; #;     The return value also concatenates the status of each specified option.
 ; #;     The format of the return value is: 0/1 ^ , status1, status2, status3...
ROUTINE(rou,array,err,options,langmode,filedate,nsp)
 ;
 ; ...
 ; #; This function syntax checks INT source code
 ; #;   src - source (INT) code;
 ; #;         either a single line stored in a variable, or
 ; #;         an array where: array(0)=#lines, array(1-n)=source
 ; #;   .err - errors detected ($LIST format, call $$FMTERR to display)
 ; #;   langmode - language mode, 0-9 (optional)
 ; #; return:
 ; #;   1 for success; 0 for failure (syntax errors found)
CHECK(src,err,langmode) ;
 ;
 ; ...
 ; #; Get save date/time
 ; #; parameters:
 ; #;   rou - name.ext of the routine to fetch date for
 ; #;   fmt - $ZDateTime format of date/time returned (0-12, optional);
 ; #;          0 58142,34718 [default]
 ; #;          1 03/09/2000 09:37:35
 ; #;          2 09 Mar 2000 09:37:35
 ; #;          3 2000-03-09 09:37:35
 ; #;          4 09/03/2000 09:37:35
 ; #;          5 Mar 9, 2000 09:37:35
 ; #;          6 Mar 9 2000 09:37:35
 ; #;          7 Mar 09 2000 09:37:35
 ; #;          8 20000309 09:37:35
 ; #;          9 March 9, 2000 09:37:35
 ; #;          10 4 09:37:35
 ; #;          11 Thu 09:37:35
 ; #;          12 Thursday 09:37:35
 ; #;   nsp - namespace (optional)
 ; #; return: routine save date/time
DATE(rou,fmt,nsp)
 ;
 ; ...
 ; #; Delete a routine
 ; #; parameters:
 ; #;   rou - name.ext[.ver] of the routine to delete;
 ; #;         name.* will delete all types of routine code
 ; #;   nsp - namespace (optional)
 ; #; return: none
DEL(rou,nsp)
 ; ...
 ; #; Determine whether routine exists
 ; #; parameters:
 ; #;   rou - name.ext[.ver] of the routine to fetch language mode
 ; #;   nsp - namespace to check (optional)
 ; #; return: 0/1
EXIST(rou,nsp)
 ; ...
 ; #; Return language mode
 ; #; parameters:
 ; #;   rou - name.ext[.ver] of the routine to fetch language mode
 ; #;   nsp - namespace to check (optional)
 ; #; return: 0 = Cache ObjectScript
 ; #;         1 = DSM-11
 ; #;         2 = DTM
 ; #;         3 = Ipsum
 ; #;         4 = Cobra
 ; #;         5 = DSM-VMS
 ; #;         6 = DSM-J
 ; #;         7 = DTM-J
 ; #;         8 = MSM
 ; #;         9 = Cache Basic
LANG(rou,nsp)
 ; ...
 ; #; Set language mode
 ; #; parameters:
 ; #;   rou - name.ext of the routine to set language mode
 ; #;   lang - language mode
 ; #; return: 1/0 (success/fail)
LANGSET(rou,lang)
 ; ...
 ; #; Get # of routine lines
 ; #; parameters:
 ; #;   rou - name.ext[.ver] of the routine to fetch language mode
 ; #;   nsp - namespace to check (optional)
 ; #; return: # of lines
LENGTH(rou,nsp)
 ; ...
 ; #; Get a single routine line
 ; #; parameters:
 ; #;   rou - name.ext of the routine
 ; #;   lnum - number of line to fetch
 ; #;   nsp - namespace to check (optional)
 ; #; return: routine line
LINE(rou,lnum,nsp)
 ; ...
 ; #; Set a routine line
 ; #; parameters:
 ; #;   rou - name.ext of the routine
 ; #;   lnum - number of line to fetch
 ; #;   line - line to set
 ; #; return: 1/0 (sucess/failure)
LINESET(rou,lnum,line)
 ; ...
 ; #; Get a bunch of routine names and, optionally, routine info
 ; #; parameters:
 ; #;   mask - routine wildcard.extension selection mask
 ; #;          valid extensions:
 ; #;              SRC = MAC/INT,INC source code (default)
 ; #;              COS = MAC/INT source code
 ; #;              BAS = BASIC source code
 ; #;              MAC = MACRO source code
 ; #;              INT = INTERMEDIATE source code
 ; #;              INC = INCLUDE source code
 ; #;              OBJ = OBJECT code
 ; #;              * = ALL code
 ; #;          (e.g. A*.INT;B*.MAC;'C*;D*.*;E*.COS;F*.SRC)
 ; #;   size - # of routines to fetch
 ; #;   detail - return detailed data in data buffer (0/1)
 ; #;   .data - routine information ($LIST format)
 ; #;           if detail=0: data = $LIST(routine1.ext,routine2.ext,...)
 ; #;           if detail=1: data = $LIST($LIST(routine1.ext,date,size,lang),...)
 ; #;   .ctx - context information for subsequent call to $$LIST,
 ; #;           (i.e. set ctx=0 for first call, ctx=1 for subsequent calls)
 ; #;   nsp - namespace (optional)
 ; #; return: 1 if more routines can be fetched; 0 if no more routines
LIST(mask,size,detail,data,ctx,nsp)
 ; ...
 ; #; Lock a routine
 ; #; parameters:
 ; #;   rou - name.ext of the routine to lock
 ; #;   timeout - lock timeout, optional (default=2 seconds)
 ; #; return: lock status (1 - locked; 0 - not locked)
LOCK(rou,timeout)
 ; ...
 ; #; Unlock a routine
 ; #; parameters:
 ; #;   rou - name.ext of the routine to lock
 ; #; return: none
UNLOCK(rou)
 ; ...
 ; #; Get next routine (i.e. $Order)
 ; #; parameters:
 ; #;   from - starting point
 ; #;           (i.e. "" for first call, rtn.ext for subsequent calls)
 ; #;   nsp - namespace (optional)
 ; #; return: next routine.exe[.ver]; "" if no more routines
NEXT(from,nsp)
 ; ...
 ; #; Get routine size
 ; #; parameters:
 ; #;   rou - name.ext[.ver] of the routine to fetch size (version is optional)
 ; #;   nsp - namespace to check (optional)
 ; #; routine = routine size (# characters)
SIZE(rou,nsp)
 ; ...
 ; #; Get the maximum # of versions to keep (backups + master)
 ; #; parameters:
 ; #;   type - routine type (MAC,INC,BAS,etc)
 ; #;   nsp - namespace to check (optional)
 ; #; return: max # versions
VERMAX(type,nsp)
 ; ...
 ; #; Set the maximum # of versions to keep (backups + master)
 ; #; parameters:
 ; #;   type - MAC or INC
 ; #;   nsp - namespace to check (optional)
 ; #; return: none
VERMAXSET(type,max,nsp)
 ; ...
 ; #; Get a backup version # from a relative version #
 ; #; parameters:
 ; #;   rou - name.ext[.ver] of the routine to fetch language mode (version is optional)
 ; #;         The version # can be a relative #.  For example, routine.MAC.-1 will
 ; #;         return the most recent backup version #.
 ; #;   nsp - namespace to check (optional)
 ; #; return: version #
VERSION(rou,nsp)
 ; ...
 ; #; Get the first (oldest) backup version #
 ; #; parameters:
 ; #;   rou - name.ext of the routine to fetch language mode
 ; #;   nsp - namespace to check (optional)
 ; #; return: oldest backup version #
VERSION1(rou,nsp)
 ; ...
 ; #; Format an error list:
 ; #; This function will format an error for display by converting it
 ; #; from $LIST($LIST) format to either a string, delimited by $c(13,10),
 ; #; or a local array to be passed back in the 'out' parameter.  If 'out'
 ; #; is defined it populates the array, otherwise it creates a string
 ; #; which is passed back as the return value.
 ; #; parameters:
 ; #;   e - $LIST($LIST) errors
 ; #;   .src - source code array, if this is defined it will show the line
 ; #;          of source code where the error occurred.
 ; #;   .out - return detailed data in out() array instead of the function
 ; #;          return value
 ; #; return: error text, if .out parameter is undefined
FMTERR(e,src,out)
 Q
 /*
 Set rtn=$$ParseRoutineHeader^%R(rtn,.type) Set:type="" type="INT"
 Set:m["." m=$$ParseRoutineName^%R(m,.e),e=$s(e="*":"",e="SRC":".INC.MAC.INT.BAS",e="":"",1:"."_e)
 If $e(ROU)="%" && ($e($zu(5),1,2)'="^^") && ('$$CheckPercentRoutineChange^%R(ROU,EXT))
 */
]]></Routine>


<Routine name="%ZAPM.bs.BSC4r1" type="MAC" languagemode="0"><![CDATA[
%BSC4r1 ;HELPER PROJECT
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
CREAT(pi,BSPRO) ;СОЗДАТЬ ПРОЕКТ "Документация"
 ;i $zu(5,"%SYS")
 I '$D(@("^"_pi_".PRO")@(BSPRO,"REM")) S @("^"_pi_".PRO")@(BSPRO,"REM")=$$LNG^%ZAPM.bs.BSC4("Документация",59)_" ..."
 S pin=pi_"."_BSPRO
 I '$D(@("^"_pin)) S @("^"_pin)="BaSe MsW @"_$$LNG^%ZAPM.bs.BSC4("Документация",59)_" ..."
 M @("^"_pin_"(""ROU"")")=^%ZAPM.bs.BSC4E("ROU")
 M @("^"_pin_"(""Tree"")")=^["%SYS"]BSC4.DOC("Tree")
 S @("^"_pin)@("Tree","Compile")="Save "_$$TD^%ZAPM.bs.BSC4base
 F I=1:1:3 M @("^"_pin_"(""Content"_I_""")")=^["%SYS"]BSC4.DOC("Content"_I) S @("^"_pin)@("Content"_I,"Compile")="Save "_$$TD^%ZAPM.bs.BSC4base
 M @("^"_pin_"(""Param"")")=^["%SYS"]BSC4.DOC("Param") S @("^"_pin)@("Param","Compile")="Save "_$$TD^%ZAPM.bs.BSC4base
 S @("^"_pin)@("ROU","KEY")="^"_pin_".ROU"
 M @("^"_pin_".ROU")=^["%SYS"]BSC4.DOC.ROU
 F I="ViewMenu","EditMenu" D                             //ЧИСТКА СТАРЫХ ССЫЛОК
 .S II=$P($G(@("^"_pin_".ROU(I,""ROU"")")),"=",2)
 .S @("^"_pin_".ROU(I,""HTM"")")=$$TR^%ZAPM.bs.BSsFUNM($G(@("^"_pin_".ROU(I,""HTM"")")),"BSNSP=~SYS&BSPRO=DOC&BSRoutineId="_II,"BSNSP="_BSNSP_"&BSPRO="_BSPRO_"&BSRoutineId=????????")
 .K ^("STA"),^("ROU")
 .S @("^"_pin_".ROU(I,""COS"")")=$$TR^%ZAPM.bs.BSsFUNM($G(@("^"_pin_".ROU(I,""COS"")")),"BSNSP=~SYS","BSNSP="_BSNSP)
 F I=1:1:3 S @("^"_pin)@("Content"_I,"KEY")="^"_pin_".Content"_I
 S @("^"_pin)@("Tree","KEY")="^"_pin_".Tree"
 F I=1:1:3 S @("^"_pin_".Content1")@(I,"Descr")=""_$$LNG^%ZAPM.bs.BSC4("Пункт меню",170)_" "_I F I2=10:1:13 S II="Y"_I_"F"_I2,@("^"_pin_".Content2")@(II,"Descr")=""_$$LNG^%ZAPM.bs.BSC4("Подменю",171)_" "_II  F II2=100:1:103 S III="T"_I_"P"_II_"S"_II2,@("^"_pin_".Tree")@(I,II,III,"zero")=7,@("^"_pin_".Content3")@(III,"Descr")=""_$$LNG^%ZAPM.bs.BSC4("Статья",172)_" "_III
 S @("^"_pin)@("Param","KEY")="^"_pin_".Param"
 M @("^"_pin_".Param")=^["%SYS"]BSC4.DOC.Param
 S @("^"_pin_".Param(""HEADER"",""Val"")")=$$BIGL^%ZAPM.bs.BSsFUNM(@("^"_pin_".Param(""HEADER"",""Descr"")"))
 S newTP="Navigator" F I=1:1:3 D Navigator^%ZAPM.bs.BSC4rou(pin,"EditContent"_I,"Content"_I)
 S newTP="Navigator" D Navigator^%ZAPM.bs.BSC4rou(pin,"EditParam","Param")
 Q
 ;D Helper(pin,"EditMenu","Tree")
 ;D TreeMenu(pin,"ViewMenu","Tree")
 
 ;ОТКЛЮЧИТЬ
TreeMenu(pin,Rou,Tab) Q  I $G(Tab)="" G TabEmpty^%ZAPM.bs.BSC4rou
 S newTP="TreeMenu^%ZAPM.bs.BSC4r1"
 D MST^%ZAPM.bs.BSC4rou S V=" "_$$LNG^%ZAPM.bs.BSC4("Просмотр пунктов меню ",173)
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,A,GetField
 s C="ViewTree ; "_$$say2^%ZAPM.bs.BSC4rou_V_BK_$$hr^%ZAPM.bs.BSC4rou_BK
 D
 .N BSRoutineId F I="T","C","D" S BSLABEL="Tree"_I S A(I)=$$ADDBSGET^%ZAPM.bs.BSC4("")
 S C=C_" &html<"_BK
 S C=C_"<html><head><title>"_V_"</title>"_BK_$$meta^%ZAPM.bs.BSC4()_BK
 S C=C_"</head>"_BK
 S C=C_"<frameset framespacing=0 frameborder='1' rows='*,83%'>"_BK
 S C=C_"  <frame SRC="""_A("T")_"&BSRoutineId=#(BSRoutineId)#"" noresize name='TITLE2' SCROLLING='no'>"_BK
 S C=C_" <frameset  framespacing='0' border='false' frameborder='1' cols='*,60%'>"_BK
 S C=C_"  <frame SRC="""_A("C")_"&BSRoutineId=#(BSRoutineId)#"" name='CONTENT2' noresize SCROLLING='auto'>"_BK
 S C=C_"  <frame SRC="""_A("D")_"&BSRoutineId=#(BSRoutineId)#"" name='DESCRIPT2' noresize SCROLLING='auto'>"_BK
 S C=C_" </frameset>"_BK
 S C=C_"</frameset>"_BK
 S C=C_"</html>"_BK
 S C=C_">"_BK
 S C=C_" Q  "_BK
 S C=C_"H1() Q ""<html><head>""_BK "_BK
 S C=C_"H2() Q ""</head><body>""_BK "_BK
 S C=C_"H3() Q ""</body></html>""_BK "_BK
 S C=C_"TreeT ; "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" W $$H1"_BK
 S C=C_" W $$$GetDirectTabN1("""_BSPRO_""",""Param"",""TITLE"",""Val"")"_BK
 S C=C_" W $$$Meta(1251)"_BK
 S C=C_" W $$H2"_BK
 S C=C_" W ""<H3><center>""_$$$GetDirectTabN1("""_BSPRO_""",""Param"",""HEADER"",""Val"")_""</center></H3><br>"" "_BK
 S C=C_" W ""<div align='right'>| <a target='DESCRIPT2' ""_$$ah(""Find"")_"""_$$LNG^%ZAPM.bs.BSC4("Поиск",175)_"</a>"" "_BK
 S C=C_" W "" | <a target='CONTENT2' ""_$$ah(""Indx"")_"""_$$LNG^%ZAPM.bs.BSC4("Индексы",176)_"</a>"" "_BK
 S C=C_" W "" | <a target='CONTENT2' ""_$$ah(""TreeC"")_"""_$$LNG^%ZAPM.bs.BSC4("Содержание",177)_"</a> |</div>"" "_BK  
 S C=C_" W $$H3"_BK
 S C=C_" Q"_BK  
 S C=C_"Find ;"_$$LNG^%ZAPM.bs.BSC4("Поисковый модуль для документации",328)_" "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" W 1 Q"_BK  
 S C=C_"Indx ;"_$$LNG^%ZAPM.bs.BSC4("Формировать индексы документации по ключевым словам",329)_" "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" W $$H1,$$$GetDirectTabN1("""_BSPRO_""",""Param"",""CONTENT"",""Val""),$$H2,BK "_BK
 S C=C_" Q"_BK
 S C=C_"ah(L) ;"_BK
 S C=C_" N BSLABEL S L=""&BSLABEL=""_L"_BK
 S C=C_" q ""href='""_$$$href(L)_""' >"" "_BK
 S C=C_"TreeC ; "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" W $$H1,$$$GetDirectTabN1("""_BSPRO_""",""Param"",""CONTENT"",""Val""),BK,$$$GetDirectTabN1("""_BSPRO_""",""Param"",""JSMENU"",""Val""),BK"_BK
 S C=C_" W ""<style type='text/css'>""_BK"_BK
 S C=C_" W ""  UL.toc LI {list-style-image:url("_BSDOMAIN_"/img/bclose.gif)}""_BK"_BK
 S C=C_" W ""  UL.toc LI.open {list-style-image:url("_BSDOMAIN_"/img/bopen.gif)}""_BK"_BK
 S C=C_" W ""</style>""_BK"_BK
 S C=C_" W $$$Meta(1251)"_BK
 S C=C_" &html<"_BK
 S C=C_"</head><body ONCLICK='return false'>"_BK
 S C=C_"<UL CLASS='toc' ONCLICK='outliner();' ONSELECTSTART='return false;' ONMOUSEOVER='mouseEnters();' ONMOUSEOUT='mouseLeaves();' ONKEYPRESS='checkChar(event.srcElement);'>"_BK
 S C=C_">"_BK    
 D
 .N BSRoutineId,BStop S BSLABEL="TreeDesc" S A=$$ADDBSGET^%ZAPM.bs.BSC4("")
 S C=C_" N K1,K2,K3,Key1,Key2,Key3 "_BK
 S C=C_" W BK S K1="""",Key1=1,Key1(1)="""" F  S K1=$$$ORDER("""_BSPRO_""",""Tree"",.Key1,K1,1) Q:K1=""""  D  "_BK
 S C=C_" .W ""<LI><A ONCLICK='parent.DESCRIPT2.location="""""_A_"""_$$C3(K1)_"""""";' ""_$$C2(K1,1)_"">""_$$C1(K1,1)_""</A><UL>""_BK "_BK
 S C=C_" .S K2="""",Key2=2,Key2(1)=K1,Key2(2)=""""  F  S K2=$$$ORDER("""_BSPRO_""",""Tree"",.Key2,K2,1) Q:K2=""""  D  "_BK
 S C=C_" ..W "" <LI STYLE='list-style-image: URL("_BSDOMAIN_"/img/bopen1.gif)'><A ONCLICK='parent.DESCRIPT2.location="""""_A_"""_$$C3(K1,K2)_"""""";' ""_$$C2(K2,2)_"">""_$$C1(K2,2)_""</A><UL>""_BK "_BK
 S C=C_" ..S K3="""",Key3=3,Key3(1)=K1,Key3(2)=K2,Key3(3)=""""  F  S K3=$$$ORDER("""_BSPRO_""",""Tree"",.Key3,K3,1) Q:K3=""""  D  "_BK
 S C=C_" ...W ""  <LI STYLE='list-style-image: URL("_BSDOMAIN_"/img/bopen2.gif)'><A ONCLICK='parent.DESCRIPT2.location="""""_A_"""_$$C3(K1,K2,K3)_"""""";' ""_$$C2(K3,3)_"">""_$$C1(K3,3)_""</A></LI>""_BK "_BK
 S C=C_" ..W "" </UL></LI>""_BK "_BK  
 S C=C_" .W ""</UL></LI>""_BK "_BK
 S C=C_" W ""</UL>""_BK "_BK
 S C=C_" W $$H3"_BK
 S C=C_" Q"_BK
 S C=C_"Topic(K,Nu) ;"_$$LNG^%ZAPM.bs.BSC4("СОДЕРЖАНИЕ ПУНКТА",178)_BK
 S C=C_" W $$$GetDirectTabN1("""_BSPRO_""",""Content""_Nu,K,""Html"")_BK"_BK
 S C=C_" N A S A=$$$GetDirectTabN1("""_BSPRO_""",""Content""_Nu,K,""Refer"")"_BK
 S C=C_" ;I A'="""" W $$$GetTableBS($P(A,"":"",1),$P(A,"":"",2),$P(A,"":"",3),$P(A,"":"",4),$P(A,"":"",5))_BK"_BK
 S C=C_" I A'="""" W $$$GetResultRef(A,""DESCRIPT2"")_BK"_BK
 S C=C_" Q"_BK
 S C=C_"TreeDesc ;"_$$LNG^%ZAPM.bs.BSC4("ПРОГРАММА ОТОБРАЖЕНИЯ СОДЕРЖАНИЯ ПУНКТА ",179)_BK
 S C=C_" I $G(BSK3)'="""" D Topic(BSK3,3) Q"_BK
 S C=C_" I $G(BSK2)'="""" D Topic(BSK2,2) Q"_BK
 S C=C_" I $G(BSK1)'="""" D Topic(BSK1,1) Q"_BK
 S C=C_" //N K1,K2,K3,Key1,Key2,Key3 "_BK
 S C=C_" //S K3="""",Key3=3,Key3(1)=BSK1,Key3(2)=BSK2,Key3(3)=""""  F  S K3=$$$ORDER("""_BSPRO_""",""Tree"",.Key3,K3,1) Q:K3=""""  D  "_BK
 S C=C_" //.D Topic(K3,3) w ""<br>"" "_BK
 S C=C_" Q"_BK
 S C=C_"C3(K1,K2,K3) ;"_$$LNG^%ZAPM.bs.BSC4("ПОДГОТОВКА CGI-ПЕРЕМЕННЫХ",180)_BK
 S C=C_" N A S A=""&BSRoutineId=""_BSRoutineId"_BK
 S C=C_" S A=A_""&BSK1=""_K1"_BK
 S C=C_" I $D(K2) S A=A_""&BSK2=""_K2"_BK
 S C=C_" I $D(K3) S A=A_""&BSK3=""_K3"_BK
 S C=C_" Q A "_BK
 S C=C_"C1(K,Nu) ;"_$$LNG^%ZAPM.bs.BSC4("ТЕКСТ ПУНКТА",181)_BK
 S C=C_" N A S A=$$$GetDirectTabN1("""_BSPRO_""",""Content""_Nu,K,""Descr"")"_BK
 S C=C_" I A="""" S A=K"_BK
 S C=C_" Q A "_BK
 S C=C_"C2(K,Nu) ;"_$$LNG^%ZAPM.bs.BSC4("КОМЕНТАРИЙ ПУНКТА",182)_BK
 S C=C_" N A S A=$$$GetDirectTabN1("""_BSPRO_""",""Content""_Nu,K,""FDescr"")"_BK
 S C=C_" I A="""" S A=K"_BK
 S C=C_" Q "" title='""_A_""' "" "_BK
 S C=C_"TreeD ; "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" W $$H1,$$$GetDirectTabN1("""_BSPRO_""",""Param"",""DESCRIPT"",""Val""),$$H2"_BK
 S C=C_" W $$$Meta(1251)_BK"_BK
 S C=C_" W ""</head><body>"" "_BK
 S C=C_" W 1211"_BK  
 S C=C_" W ""</body></html>"" "_BK
 S C=C_" Q"_BK  
 S C=C_"ViewTNF ; "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" W !!! "_BK    
 S C=C_" Q"_BK 
 ;-----------------------------------------
 s H="<!-- "_$$say1^%ZAPM.bs.BSC4rou_" -->"_BK
 S H=H_$$VAR^%ZAPM.bs.BSC4rou(1,"ViewTree"),BSLABEL="ViewTree"
 S H=H_"<a href="_$$add^%ZAPM.bs.BSC4rou_">"_$$LNG^%ZAPM.bs.BSC4("Загрузить Просмотр пунктов меню (Вариант с фрэймами)",183)_"</a>"_BK
 S H=H_$$VAR^%ZAPM.bs.BSC4rou(2,"ViewTNF"),BSLABEL="ViewTNF"
 S H=H_"<a href="_$$add^%ZAPM.bs.BSC4rou_">"_$$LNG^%ZAPM.bs.BSC4("Загрузить Просмотр пунктов меню (Вариант без фрэймов)",184)_"</a>"_BK
 S H=H_"</center>"_BK
 s H=H_$$end^%ZAPM.bs.BSC4rou
 g Save^%ZAPM.bs.BSC4rou
         ;ОТКЛЮЧИТЬ
Helper(pin,Rou,Tab) Q    I $G(Tab)="" G TabEmpty^%ZAPM.bs.BSC4rou
 S newTP="Helper^%ZAPM.bs.BSC4r1"
 D MST^%ZAPM.bs.BSC4rou S V=" "_$$LNG^%ZAPM.bs.BSC4("Редактор пунктов меню ",185)
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 s C="Navigator ; "_$$say2^%ZAPM.bs.BSC4rou_V_BK_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" set Home1=1 // "_$$LNG^%ZAPM.bs.BSC4("заголовок страницы",186)_BK     
 S C=C_"Navig1 ; "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" set Header="""_V_""" // "_$$LNG^%ZAPM.bs.BSC4("заголовок страницы",186)_BK  
 S C=C_" set Max=$$$CoutFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество полей",187)_BK
 S C=C_" set MaxI=$$$CoutIndxFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество индексированных полей",188)_BK
 S C=C_" D $$$DKILL(""Dis"") // "_$$LNG^%ZAPM.bs.BSC4("удалить массив признака опции",189)_" DISABLE"_BK
 S C=C_" D $$$DKILL(""STOP"") "_BK
 S C=C_" for Num=1:1:MaxI D  Q:$G(STOP)=1  G:$G(STOP)=2 Navigator  //"_$$LNG^%ZAPM.bs.BSC4("цикл по индексным полям",190)_BK
 S C=C_"    .D KKey(Num)  "_BK
 S C=C_"    .IF $$$DDATA(""Home""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",1)) D CheckL Q:$D(STOP)  "_BK
 S C=C_"    .IF $$$DDATA(""End""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",-1)) D CheckR "_BK
 S C=C_"    .IF $$$DDATA(""Del""_Num) D $$$DKILL(""Del""_Num) D $$$DSET(""Left""_Num,1) D $$$KillDirectTab("""_BSPRO_""","""_Tab_""",.Key) D  //"_$$LNG^%ZAPM.bs.BSC4("удалить узел ",191)_BK
 S C=C_"    ..D $$$DKILL(""Ke1""),$$$DSET(""Ke1(1)"",$$$DGET(""value""_Num)) S Ke1=1 D $$$KillDirectTab(""DOC"",""Content""_Num,.Ke1) "_BK
 S C=C_"    .IF $$$DDATA(""Left""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),-1)) D CheckL Q:$D(STOP)  "_BK
 S C=C_"    .IF $$$DDATA(""Right""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),1)) D CheckR "_BK
 S C=C_"    .S Dis(Num,1)=($$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),-1)="""") "_BK
 S C=C_"    .S Dis(Num,2)=($$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),1)="""") "_BK
 S C=C_" &html<"_BK
 S C=C_"<html><title>#(Header)#</title>"_BK_$$STYLE^%ZAPM.bs.BSC4()_BK
 S C=C_"<body><center>"_BK
 D 
 .N BSRoutineId
 .S C=C_""_$$form^%ZAPM.bs.BSC4rou("NameForm")
 S C=C_"<input type='hidden' name='BSLABEL' value='Navig2'>"_BK
 S C=C_"<table border=0>"_BK
 S C=C_">"_BK
 S C=C_"   D $$$DSET(""Key(Key)"",$$$DGET(""value""_Num)) //"_$$LNG^%ZAPM.bs.BSC4("присвоить значение последнего индекса",192)_" "_BK
 S C=C_"    IF $D(Save) D  //"_$$LNG^%ZAPM.bs.BSC4("присвоить исправления",193)_BK
 S C=C_"     .for Num=1:1:MaxI D  "_BK   
 S C=C_"     ..n w,a s w=1,w(1)=$$$DGET(""value""_Num)"_BK
 S C=C_"     ..IF w(1)'="""" D  "_BK
 S C=C_"     ...S a=$$$DGET(""DescU""_Num) i $$$SetDirectTab("""_BSPRO_""",""Content""_Num,.w,""Descr"",a)"_BK
 S C=C_"     ...S a=$$$DGET(""FDescU""_Num) i $$$SetDirectTab("""_BSPRO_""",""Content""_Num,.w,""FDescr"",a)"_BK
 S C=C_"     ...S a=$$$DGET(""ReferU""_Num) i $$$SetDirectTab("""_BSPRO_""",""Content""_Num,.w,""Refer"",a)"_BK
 S C=C_"     ...S a=$$$DGET(""HtmlU""_Num) i $$$SetDirectTab("""_BSPRO_""",""Content""_Num,.w,""Html"",a)"_BK
 S C=C_"     ...S a=$$$DGET(""KeyWordsU""_Num) i $$$SetDirectTab("""_BSPRO_""",""Content""_Num,.w,""KeyWords"",a)"_BK
 S C=C_"     .for Num=(MaxI+1):1:Max D  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем неиндексным полям",194)_BK
 S C=C_"     ..set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля",195)_BK
 S C=C_"     ..set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     ..IF $$$SetDirectTab("""_BSPRO_""","""_Tab_""",.Key,NameFeild,$$$DGET(""value""_Num)) //"_$$LNG^%ZAPM.bs.BSC4("присвоим в прямом доступе",197)_BK
 S C=C_"   for Num=1:1:Max {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"     set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля",195)_BK
 S C=C_"     set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     set Description=$P(var1,""~"",2),CLASS="""" s:'(Num#2) CLASS="" class=s3 "" //"_$$LNG^%ZAPM.bs.BSC4("вычленить описание поля",199)_BK
 S C=C_"     write ""<tr>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести описание",200)_BK
 S C=C_"     if $P(var1,""~"",4)'="""" D  //"_$$LNG^%ZAPM.bs.BSC4("эти поля индексные",201)_BK
 S C=C_"       .W ""<td align='right'""_CLASS_""><input type='submit' name='Del""_Num_""' title='"_$$LNG^%ZAPM.bs.BSC4("удалить узел",202)_" ""_$SELECT(Num=MaxI:"""",1:"""_$$LNG^%ZAPM.bs.BSC4("со всеми потомками высших уровней",203)_""")_""' value='"_$$LNG^%ZAPM.bs.BSC4("Удалить",119)_"'>&nbsp;<input type='submit' ""_$$Disable(Num,1)_"" name='Home""_Num_""' value='&lt;&lt;'><input type='submit' name='Left""_Num_""' ""_$$Disable(Num,1)_"" value='&lt;'></td>"""_BK
 S C=C_"     if Num=(MaxI+1) w ""<tr><td><hr></td><td><hr></td><td></td><td><hr></td></tr><td align='right'""_CLASS_""><input type='submit' name='Save' value='"_$$LNG^%ZAPM.bs.BSC4("Сохранить",109)_"'></td>"" "_BK
 S C=C_"     if Num=(MaxI+2) w ""<td align='right'""_CLASS_""><input type='Reset' name='Reset' value='"_$$LNG^%ZAPM.bs.BSC4("Отменить",204)_"'></td>"" "_BK
 S C=C_"     if Num>(MaxI+2) w ""<td""_CLASS_""></td>"""_BK
 S C=C_"     if $P(var1,""~"",4)="""" D  //"_$$LNG^%ZAPM.bs.BSC4("эти поля неиндексные",205)_BK
 S C=C_"       .D $$$DSET(""value""_Num,$$$GetDirectTab("""_BSPRO_""","""_Tab_""",.Key,NameFeild)) //"_$$LNG^%ZAPM.bs.BSC4("прямой доступ к данным таблицы, когда знаешь индексы",206)_BK
 S C=C_"     write ""<td""_CLASS_""><input type='text' size=10 maxlength=2048 title='""_NameFeild_""' name='value""_Num_""' value='""_$$$DGET(""value""_Num)_""'></td>"""_BK
 S C=C_"     S var2=""<td align='left'""_CLASS_"">"" "_BK
 S C=C_"     if $P(var1,""~"",4)'="""" D  //"_$$LNG^%ZAPM.bs.BSC4("эти поля индексные",201)_BK
 S C=C_"       .S var2=var2_""<input type='submit' name='Right""_Num_""' ""_$$Disable(Num,2)_"" value='&gt;'><input type='submit' ""_$$Disable(Num,2)_"" name='End""_Num_""' value='&gt;&gt;'>"" "_BK
 S C=C_"     w var2_""</td>"""_BK
 S C=C_"     write $$DDD()_""</tr>"" "_BK
 S C=C_"     }"_BK
 S C=C_" write ""<input type='hidden' name='BSRoutineId' value='""_BSRoutineId_""'>"""_BK
 S C=C_" &html<"_BK
 S C=C_"</table></form></center>"_BK
 S C=C_"</body></html>"_BK
 S C=C_">"_BK
 ;S C=C_" D TREE ;D $$$DoRou("""_BSPRO_""",""NewRoutin3"",""Variables1"") Q  "_BK
 S C=C_" quit"_BK
 S C=C_"DDD()    n a,a1,a2,a3,a4,a5,w     s w=1,w(1)=$$$DGET(""value""_Num) Q:Num>MaxI ""<td align='LEFT'""_CLASS_""></td><td align='LEFT'""_CLASS_""></td>"" "_BK
 S C=C_" s a=$$$GetDirectTab("""_BSPRO_""",""Content""_Num,.w,""Descr"")"_BK
 S C=C_" s de=$p($$$GetFeild("""_BSPRO_""",""Content""_Num,""Descr""),""~"",2)"_BK
 S C=C_" S a1=""<div><textarea title='""_de_""' name='DescU""_Num_""' cols=20 rows=1>""_a_""</textarea>"_$$LNG^%ZAPM.bs.BSC4("описание",207)_"</div>"""_BK
 
 S C=C_" s a=$$$GetDirectTab("""_BSPRO_""",""Content""_Num,.w,""FDescr"")"_BK
 S C=C_" s de=$p($$$GetFeild("""_BSPRO_""",""Content""_Num,""FDescr""),""~"",2)"_BK
 S C=C_" S a2=""<div><textarea title='""_de_""' name='FDescU""_Num_""' cols=20 rows=3>""_a_""</textarea>"_$$LNG^%ZAPM.bs.BSC4("полное описание",208)_"</div>"""_BK
 
 S C=C_" s a=$$$GetDirectTab("""_BSPRO_""",""Content""_Num,.w,""Refer"")"_BK
 S C=C_" s de=$p($$$GetFeild("""_BSPRO_""",""Content""_Num,""Refer""),""~"",2)"_BK
 S C=C_" S a3=""<div><textarea title='""_de_""' name='ReferU""_Num_""' cols=30 rows=1>""_a_""</textarea>"_$$LNG^%ZAPM.bs.BSC4("ссылка",209)_"</div>"""_BK
 
 S C=C_" s a=$$$GetDirectTab("""_BSPRO_""",""Content""_Num,.w,""KeyWords"")"_BK
 S C=C_" s de=$p($$$GetFeild("""_BSPRO_""",""Content""_Num,""KeyWords""),""~"",2)"_BK
 S C=C_" S a5=""<div><textarea title='""_de_""' name='KeyWordsU""_Num_""' cols=20 rows=1>""_a_""</textarea>"_$$LNG^%ZAPM.bs.BSC4("Ключевые слова",210)_"</div>"""_BK
 
 S C=C_" s a=$$$GetDirectTab("""_BSPRO_""",""Content""_Num,.w,""Html"")"_BK
 S C=C_" s de=$p($$$GetFeild("""_BSPRO_""",""Content""_Num,""Html""),""~"",2)"_BK
 S C=C_" S a4=""<div><textarea title='""_de_""' name='HtmlU""_Num_""' cols=50 rows=10>""_a_""</textarea>html</div>"""_BK
 
 S C=C_" Q ""<td align='LEFT'""_CLASS_"">""_a1_a2_a3_a5_""</td><td align='LEFT'""_CLASS_"">""_a4_""</td>"" "_BK
 S C=C_"CheckL //"_$$LNG^%ZAPM.bs.BSC4("проверить значение ключей",211)_BK
 S C=C_" if $$$DGET(""value""_Num)="""" D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",1)) d  "_BK
 S C=C_" .if $$$DGET(""value""_Num)="""" D  "_BK
 S C=C_" ..I Num=1 S STOP=1 Q  "_BK
 S C=C_" ..E  S Num=Num-1 S STOP=2"_BK
 S C=C_" quit"_BK
 S C=C_"CheckR //"_$$LNG^%ZAPM.bs.BSC4("проверить значение ключей",211)_BK
 S C=C_" if $$$DGET(""value""_Num)="""" D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",-1)) d  "_BK
 S C=C_" .if $$$DGET(""value""_Num)="""" D  "_BK
 S C=C_" ..I Num=1 S STOP=1 Q  "_BK
 S C=C_" ..E  S Num=Num-1 S STOP=2"_BK
 S C=C_" quit"_BK
 S C=C_"Disable(N,A) Q $S($G(Dis(N,A)):""DISABLED"",1:"""") //"_$$LNG^%ZAPM.bs.BSC4("выставить опцию",212)_BK        
 S C=C_"KKey(k) //"_$$LNG^%ZAPM.bs.BSC4("подготовить массив данных узлов",213)_BK    
 S C=C_" D $$$DKILL(""Key"") //"_$$LNG^%ZAPM.bs.BSC4("Удалить массив",214)_BK
 S C=C_" n i f i=1:1:k s Key(i)=$$$DGET(""value""_i)"_BK 
 S C=C_" s Key=k Q"_BK   
 S C=C_"Navig2 ; "_$$hr^%ZAPM.bs.BSC4rou_BK
 S C=C_" G Navig1"_BK    
 ;----------------------------------------- 
 s H="<!-- "_$$say1^%ZAPM.bs.BSC4rou_" -->"_BK
 S H=H_$$VAR^%ZAPM.bs.BSC4rou(1,"Navigator"),BSLABEL="Navigator"
 S H=H_"<a href="_$$add^%ZAPM.bs.BSC4rou_">"_$$LNG^%ZAPM.bs.BSC4("Загрузить Редактор пунктов меню",215)_"</a>"_BK
 S H=H_"</center>"_BK
 s H=H_$$end^%ZAPM.bs.BSC4rou
 g Save^%ZAPM.bs.BSC4rou
]]></Routine>


<Routine name="%ZAPM.bs.BSC4r2" type="MAC" languagemode="0"><![CDATA[
%BSC4r2 ;МОДУЛЬ ДЛЯ СПЕЦИАЛЬНЫХ ФУНКЦИЙ  ; 11:11   12.09.2002
 Q
MERGE ;СМЕШАТЬ ПРОЕКТЫ
 D BEG1^%ZAPM.bs.BSC4
 W "<BODY>"
 N BSPASS,BSNAME,BSTARIF,BSEMAIL,BSFIRMA,BSCOUNTRY,BSCITY,BSLABEL
 S BSTMP1=newPR,BSTMP2=Proj
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="MERG^~BSC4r2"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<HR>"_RED,$$LNG^%ZAPM.bs.BSC4("Будем смешивать ? Вы уверены ?",318),EF,BK_BBK
 W "<input type=""submit"" name=""sMER"" value='"_$$LNG^%ZAPM.bs.BSC4("СМЕШАТЬ",319)_"'>",BK
 W "</form>" d BACK^%ZAPM.bs.BSCh
 D END^%ZAPM.bs.BSC4
 Q
MERG ;ПОДТВЕРЖДЕНИЕ УДАЛЕНИЯ
 I $D(sMER) W "<HR>"_$$LNG^%ZAPM.bs.BSC4("Объединим два проекта",320)_BBK S newPR=BSTMP1,Proj=BSTMP2 G CreatMERG^%ZAPM.bs.BSC4base
 E  W "<HR>"_$$LNG^%ZAPM.bs.BSC4("Смешение отменено",321)_BBK
 G PRO^%ZAPM.bs.BSC4base
 Q
WIND ;ИЗМЕНИТЬ ОКНО
 N S,i,I,K,M
 D pin^%ZAPM.bs.BSC4base
 I BSTMPL="B" D
 .s S=$G(@("^"_pin_".ROU")@(BSR1,BSTMPH)),Tmp=$ZR
 .S M=0
 .s K=$L(S,BK)
 .F I=1:1:K I M<$L($P(S,BK,I)) S M=$L($P(S,BK,I))
 .S:M<255 M=255 S:K<25 K=25
 .S @BDSES@(BSSES,"TEXTARIA",BSTMPH)="cols="_M_" rows="_K
 I BSTMPL="L" K @BDSES@(BSSES,"TEXTARIA",BSTMPH)
 D EditRou^%ZAPM.bs.BSC4base1(BSR1)
 Q
GETH(H,L) ;GET - ПЕРЕМЕННЫЕ ДЛЯ УВЕЛИЧЕНИЯ/УМЕНЬШЕНИЯ ОКОН ТЕXTARIA
 n BSLABEL,BSRoutineId,BSTMPH,BSTMPL,BSTOP,BSGRANT,BSROU
 s BSLABEL="WIND^~BSC4r2",BSTMPH=H,BSTMPL=L,BSR1=Rou
 S R=$$ADDBSGET^%ZAPM.bs.BSC4()
 Q R
GETTA(A) ;РАЗМЕРЫ ТЕКCТ АРИИ ПО УМОЛЧАНИЮ
 N I
 S I=$G(@BDSES@(BSSES,"TEXTARIA",A))
 I I="" S I=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,A) I I="" Q "cols=70 rows=4"
 Q I
 ;====================================================================================
prg ;РАЗОВАЯ ПРОКАЧКА ПРОГРАММ для АСУРП
 zn "USER" 
 n g,S,SS,I,FLAG,ROU,V,II,err
 s g="^%ZAPM.bs.BSC(""asurpPRG"")"
 F I=1:1 Q:'$D(@g@(I))  S SS(I,1)=$P(@g@(I),"|",1),SS(I,2)=$P(@g@(I),"|",2)
 S I="A" F  S I=$O(^ROUTINE(I)) Q:I=""  D
 .K FLAG,ROU W !,I 
 .F II=0:1:^ROUTINE(I,0,0) I $D(^ROUTINE(I,0,II)) S (ROU(II),S)=@$ZR D
 ..S V="" F  S V=$O(SS(V)) Q:V=""  I S[SS(V,1) S S=$$TR^%ZAPM.bs.BSsFUNM(S,SS(V,1),SS(V,2))
 ..I ROU(II)'=S S ROU(II)=S,FLAG=1 w "+"
 .I $D(FLAG) D
 ..D ROUTINE^%R(I_".INT",.ROU,.err,"CS",0)
 ..ZW err
 . //ЗАПИСАТЬ ПРОГРАММУ
 Q
 ;====================================================================================
132 ;РАСШИРИТЬ ОКНО КОНСОЛИ!!! РАЗОВАЯ ПРОКАЧКА ПРОГРАММ
 K SS F I=1:1 Q:'$D(^%ZAPM.bs.BSC("T132X48",I))  S SS(I,1)=$P(^%ZAPM.bs.BSC("T132X48",I),"|",1),SS(I,2)=$P(^%ZAPM.bs.BSC("T132X48",I),"|",2)
 S I="%BS" D  F  S I=$O(^ROUTINE(I)) Q:I=""  I I["%BST132"  I I'=$ZN D
 .K FLAG,ROU W !,I
 .F II=0:1:^ROUTINE(I,0,0) I $D(^ROUTINE(I,0,II)) S (ROU(II),S)=@$ZR D
 ..S V="" F  S V=$O(SS(V)) Q:V=""  I S[SS(V,1) S S=$$TR^%ZAPM.bs.BSsFUNM(S,SS(V,1),SS(V,2))
 ..I ROU(II)'=S S ROU(II)=S,FLAG=1
 .I $D(FLAG) D
 ..D ROUTINE^%R(I_".INT",.ROU,.err,"CS",0)
 ..ZW err
 . //ЗАПИСАТЬ ПРОГРАММУ
 Q
 ;====================================================================================
CNODE Q  ;СОЗДАТЬ УЗЕЛКИ ДЛЯ LNG!!! РАЗОВАЯ ПРОКАЧКА
 S X=$O(^%ZAPM.bs.BSC4DIC("!"),-1)+1 K SSS
 S I="%BSC4" D  F  S I=$O(^ROUTINE(I)) Q:I'["%BSC4"  I I'=$ZN D
 .F II=1:1:^ROUTINE(I,0,0) I $D(^ROUTINE(I,0,II)) S (S4,S)=@$ZR D
 ..F SS="$$LNG(","$$LNG^%ZAPM.bs.BSC4(" D XE(SS,S)
 ..I S4'=S S ^ROUTINE(I,0,II)=S4
 ;ZW SSS
 Q
XE(SS,S) I S'[SS Q
 F S2=2:1 Q:$P(S,SS,S2,S2+1)=""  S S3=$P($P(S,SS,S2),")",1) D
 .I $E(S3,1)'=$C(34) Q
 .I $E(S3,$L(S3))'=$C(34)&(S3'[",") S S3=$P($P(S,SS,S2),")",1,2)
 .I S3["""_"!(S3["_""") Q
 .;W !,S3
 .S S1="D XEC^%ZAPM.bs.BSC4r2("_S3_")" X S1
 Q
XEC(T,N)
 I $D(^%ZAPM.bs.BSC4DIC(T)) Q
 I $D(N) D  Q
 .I $D(^%ZAPM.bs.BSC4DIC(N)) Q
 .S ^%ZAPM.bs.BSC4DIC(N,"R")=T,^%ZAPM.bs.BSC4DIC(N,"E")="?",^%ZAPM.bs.BSC4DIC(N,"F")="?",^%ZAPM.bs.BSC4DIC(N,"G")="?"
 s XX(T)=$G(XX(T))+1 I XX(T)=1 S X=X+1,N=X S XX(T,1)=X S ^%ZAPM.bs.BSC4DIC(N,"R")=T,^%ZAPM.bs.BSC4DIC(N,"E")="?",^%ZAPM.bs.BSC4DIC(N,"F")="?",^%ZAPM.bs.BSC4DIC(N,"G")="?"
 I XX(T)>1 S N=XX(T,1),^%ZAPM.bs.BSC4DIC(N,"Multu")=XX(T)
 S S4=$$TR^%ZAPM.bs.BSsFUNM(S4,""""_T_"""",""""_T_""","_N)
 Q
 ;===========================================================
 ;
 ;ИДЕЯ : ОТЧЕТНУЮ ТАБЛИЦУ
 ;1. ОТСКАНИРОВАТЬ И СОЗДАТЬ ВРЕМЕННЫЙ МАССИВ ПО ТАБЛИЦЕ ОТЧЕТА
 ;2. ОБВЯЗАТЬ ЕГО SQL-Ю ...
 ;3. УБИТЬ И МАССИВ И КЛАСС И ОТЧЕТНУЮ ТАБЛИЦУ
 ;
ARRAY2OBJ(GN,P,T,KKOL,FIELDS,NAMECLASS,TEMPDIR) ;СОЗДАТЬ ОБЪЕКТНУЮ ОБВЯЗКУ ДЛЯ МАССИВА БД
 N I,II,III,NF,BSR,BST,PxPUSTO,se,ke
 ;S P="^Struct",T="KNHA"
 i $P($G(@P),"@",1)'="BaSe MsW " S @P="BaSe MsW @РАЗДЕЛ@@"
 K @P@(T)
 S @P@(T)="МАССИВ "_GN_", ПОЛЯ="_FIELDS_"@@@@@1@1@1@1@22@80@1@@1@@@2@@2,2@1@@@@@1@@@7@2@@@@@@@@@@"
 S @P@(T,1,1)="1@1@2@20@@@@@1@2;6;35;42@@@@@"
 S @P@(T,1,2)="1@21@2@53@@@@0@1@2;6;35;42@@@@@@"
 S @P@(T,"FTR",1,2)="S d1="" КЛЮЧИ: ""_$G(k1)_"" ""_$G(k2)_"" ""_$G(k3)_"" ""_$G(k4)_"" ""_$G(k5)_"" ""_$G(k6)_"" ""_$G(k7)_"" ""_$G(k8)_"" ""_$G(k9)"
 S @P@(T,"FTR",1,2,1)=" КЛЮЧИ: "_$G(k1)_" "_$G(k2)_" "_$G(k3)_" "_$G(k4)_" "_$G(k5)_" "_$G(k6)_" "_$G(k7)_" "_$G(k8)_" "_$G(k9)
 S @P@(T,"KEY")=GN
 S @GN="BSD - MSW@"_P_"@"_T
 I '$G(KKOL)!($G(FIELDS)="") D ARRAYSCAN(GN)
 F I=1:1:KKOL S @P@(T,"KEY",I)="49@@64@@НОВЫЙ "_I_"-КЛЮЧ@1,70@@@ "_I_"-Й ИНДЕКСНЫЙ@1;6;33;42@@@@@Введите "_I_"-КЛЮЧ@@@@@"
 S III=FIELDS ;"KNP,KPD,KSP,OKATO,SNM,VSV"
 S II=2 F I=1:1 Q:$P(III,",",I,I+1)=""  S NF=$P(III,",",I) D
 .S @P@(T,II,1)="3@1@2@20@@@@@1@2;6;35;42@@@@@ ИМЯ ПОЛЯ: "_NF
 .S @P@(T,II,2)="3@21@2@53@@@@@2@2;6;34;43@@@@@@@@"_NF_"@"
 .S II=II+1
 S BSR=P,BST=T D TAB^%ZAPM.bs.BSF1
 I $D(NAMECLASS) S PxPUSTO="" I $$START^%ZAPM.bs.BSCBD($NA(@P@(T)),1,$G(NAMECLASS),$G(TEMPDIR))
 Q
ARRAYSCAN(GN) ;СКАНИРОВАТЬ МАССИВ И ОПРЕДЕЛИТЬ КАКИЕ ПОЛЯ И СКОЛЬКО УРОВНЕЙ
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSC4r3" type="MAC" languagemode="0"><![CDATA[
%BSC4r3 ;МОДУЛЬ ДЛЯ СПЕЦИАЛЬНЫХ ФУНКЦИЙ = CSP-UPLOAD ; 11:11   12.09.2002
 Q
UPL ;ОСНОВНОЙ ВЫЗЫВАЮЩИЙ МОДУЛЬ UPLOAD
 N BSS1,BSS2,BSS3,BSS4,BSS5 ;BSS6=ПРОГРАММА КОТОРУЮ НАДО ВЫПОЛНИТЬ ПОТОМ
 S BSS1=$G(BSLOGIN),BSS3=$G(BSSES),BSS4=CurUS
 W $$NEWIN^%ZAPM.bs.BSC4base1($$LNG^%ZAPM.bs.BSC4("UploadFile"),"1",$$LNG^%ZAPM.bs.BSC4("UploadFile"),"UP^~BSC4r3"),BBK
 Q
UP D BEG1^%ZAPM.bs.BSC4
 ;<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
 W "<title>UpLoad File</title>"_$g(BK)
 W "</head><body onkeyPress='javascript: if (27 == event.keyCode) window.close();' >"
 D CSPUPLOAD("")
 W "</form>"_$g(BK)
 D END^%ZAPM.bs.BSC4
 Q
ERRR ;
 W "<pre>"
 W
 W "</pre>"
 Q
TKUPLOAD //ЗАКОНЧИТЬ ПРИЕМ ФАЙЛА
 S F=$G(%KEY("FileStream"))
 Set by=$P(F,"~",3)
 S FiNa=$P(F,"~",5,9)
 S GL=$P(F,"~",1)
 I FiNa="" S BK=$c(13,10) D CLOSEWIN Q
 i by'=0,BSS1'="" D
 .K ^mtempBSC4(BSS1,BSS3)
 .S ^mtempBSC4(BSS1,BSS3)=BSS4_","_by_","_FiNa
 .S I="" F  S I=$O(@GL@(I)) Q:I=""  D
 ..Set bytes=$G(@GL@(I))
 ..s ^mtempBSC4(BSS1,BSS3,I)=bytes
 .K @GL
 .Write !,"Загружен с Login :",BSS1,!,"<BR>Адрес IP:",BSS4,!
 I $g(BSS6)'="" D  I $G(BSNSP)'="" I $$ZU^%ZAPM.bs.BSF4(BSNSP) D @BSS6
 .I BSS6["^~" S BSS6=$$%^%ZAPM.bs.BSCh(BSS6)
 .S BSSES=BSS3,BSNSP=$$%^%ZAPM.bs.BSCh($$GetVar^%ZAPM.bs.BSC4("NSpace"))
 // D locvar^%ZAPM.bs.BSCh0("",1)
 D CLOSEWIN 
 Q
CSPUPLOAD(F) N uri ;S uri="/csp/asu/b4y/b4yupload"_F_".csp"
 s uri="http://"_$P($ZU(54,13,$zu(110)),",")_":"_$$WebPort^%ZAPM.bs.BSCp2_"/csp/asu/b4y/b4yupload"_F_".csp"
 ;i $G(%("HOST:"))'="" S uri=""_$$ADDLIB^%ZAPM.bs.BSC4_"" 
 W "<hr><form action='"_uri_"' enctype='multipart/form-data' method='post'>"_BK
 W $$LNG^%ZAPM.bs.BSC4("Введите полное имя файла")_": <input name=FileStream size=""50"" type=""file"">"_BK
 W "<p>"_BK
 W "<ul><input type='submit' value='"_$$LNG^%ZAPM.bs.BSC4("Загрузить")_"'></ul>"_BK
 W "</p><hr>"_BK
  i $G(%("HOST:"))'="" W "<input type='hidden' name='BSLABEL' value='TKUPLOAD^~BSC4r3 '>"_BK
 I $D(BSS1) D
 .W "<input type='hidden' name='BSS1' value='"_BSS1_"'>"_BK
 .W "<input type='hidden' name='BSS2' value='"_$L(BSS1)_"'>"_BK
 W "<input type='hidden' name='BSS3' value='"_BSS3_"'>"_BK
 I $D(BSS4) D
 .W "<input type='hidden' name='BSS4' value='"_BSS4_"'>"_BK
 .W "<input type='hidden' name='BSS5' value='"_$L(BSS4)_"'>"_BK
 I $D(BSS6) D
 .W "<input type='hidden' name='BSS6' value='"_BSS6_"'>"_BK
 .W "<input type='hidden' name='BSS7' value='"_$L(BSS6)_"'>"_BK
 I $D(BSS8) D
 .W "<input type='hidden' name='BSS8' value='"_BSS8_"'>"_BK
 .W "<input type='hidden' name='BSS9' value='"_$L(BSS8)_"'>"_BK
 Q
UPLOAD ;CSP-МОДУЛЬ
 New by,I,BSS1,byte,BSS2,BSS3,BSS4,BSS5
 ;S $ZT="ERRR^%ZAPM.bs.BSC4r3"
 S BSS2=+%request.Get("BSS2")
 S BSS1=$E(%request.Get("BSS1"),1,BSS2)
 S BSS3=+%request.Get("BSS3")
 S BSS5=+%request.Get("BSS5")
 S BSS4=$E(%request.Get("BSS4"),1,BSS5)
 S BSS7=+%request.Get("BSS7")
 S BSS6=$E(%request.Get("BSS6"),1,BSS7)
 S BSS9=+%request.Get("BSS9")
 S BSS8=$E(%request.Get("BSS8"),1,BSS9)
 W "<input type='hidden' name='BSS1' value='"_$g(BSS1)_"'>",!
 W "<input type='hidden' name='BSS2' value='"_$g(BSS2)_"'>",!
 W "<input type='hidden' name='BSS3' value='"_$g(BSS3)_"'>",!
 W "<input type='hidden' name='BSS4' value='"_$g(BSS4)_"'>",!
 W "<input type='hidden' name='BSS5' value='"_$g(BSS5)_"'>",!
 W "<input type='hidden' name='BSS6' value='"_$g(BSS6)_"'>",!
 W "<input type='hidden' name='BSS7' value='"_$g(BSS7)_"'>",!
 W "<input type='hidden' name='BSS8' value='"_$g(BSS8)_"'>",!
 W "<input type='hidden' name='BSS9' value='"_$g(BSS9)_"'>",!
 Set by=%request.GetMimeData("FileStream").Size
 S FiNa=%request.GetMimeData("FileStream").FileName
 I FiNa="" D UPEND S BK=$c(13,10) D CLOSEWIN Q
 i by'=0,BSS1'="" D
 .K ^mtempBSC4(BSS1,BSS3)
 .S ^mtempBSC4(BSS1,BSS3)=BSS4_","_by_","_FiNa
 .F I=0:30000:by D
 ..Set bytes=%request.GetMimeData("FileStream").Read(30000)
 ..s ^mtempBSC4(BSS1,BSS3,I)=bytes
 .Write !,"Загружен с Login :",BSS1,!,"<BR>Адрес IP:",BSS4,!
 I $g(BSS6)'="" D  D @BSS6
 .I BSS6["^~" S BSS6=$$%^%ZAPM.bs.BSCh(BSS6)
UPEND F I=1:1:30 W "<BR>"
 D %session.%Close()
 d CLOSEWIN
 Q
CLOSEWIN I $G(NoCloseWin) Q
 D JS^%ZAPM.bs.BSCp
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
UPLOADFL ;импорт из ТЕКСТОВОГО ФАЙЛА (3 ШАГ)
 D MAINVAR^%ZAPM.bs.BSC4
 W "<HR><H3>"_$$LNG^%ZAPM.bs.BSC4("Создание таблицы из текстового файла")_$$LNG^%ZAPM.bs.BSC4(" ( 3 ШАГ )")_"<H3>"
 k ^mtempBSC4LF(BSS1,BSS3),by
 S I="",j=0 F  S I=$O(^mtempBSC4(BSS1,BSS3,I)) Q:I=""  S ST=^mtempBSC4(BSS1,BSS3,I) D
 .i j'=0 S ST=III_ST,j=j-1
 .F II=1:1 Q:$P(ST,BK,II,II+1)=""  S III=$P(ST,BK,II) d
 ..s j=j+1,^mtempBSC4LF(BSS1,BSS3,j)=III
 ;W BK,!,"OK"
 N InsD,Desc,Suff,Y,PT,a,A,BD,Y,I,SuffSave,SuffKEY,FCount,FC
 S P="^%ZAPM.bs.BSC4E",T="EMPTY",pin=$P(BSS8,"~",2),TabName=$P(BSS8,"~",3) d NewT^%ZAPM.bs.BSC4base($NA(@P@(T)),pin,TabName)
 S NAMF=$P(BSS8,"~",4)
 F I=1:1 Q:$P(NAMF,";",I,I+1)=""  S (FC(I),@("Field"_I))=$P(NAMF,";",I),@("Desc"_I)="Description of "_$P(NAMF,";",I)
 S FCount=I-1,T=TabName,Desc=%request.GetMimeData("FileStream").FileName
 D Group^%ZAPM.bs.BSC4base
 N DEL,BD,S,i,I
 S DEL=$P(BSS8,"~",5),BD=$G(@("^"_pin)@(T,"KEY"))
 S I="" F  S I=$O(^mtempBSC4LF(BSS1,BSS3,I)) Q:I=""  S i=I,S=^mtempBSC4LF(BSS1,BSS3,I) F Y=1:1:FCount D
 .I $P(S,DEL,Y)'="" S @BD@(I,FC(Y))=$P(S,DEL,Y)
 W $$LNG^%ZAPM.bs.BSC4("Загружено записей: "),i,BK
 k ^mtempBSC4LF(BSS1,BSS3),^mtempBSC4(BSS1,BSS3)
 ;D ERRR
 Q
UPLOADF2         ;ПАРАМЕТРЫ импорта из ТЕКСТОВОГО ФАЙЛА (2 ШАГ)
 D BEG1^%ZAPM.bs.BSC4    W $$STYLE^%ZAPM.bs.BSC4
 W "<BODY><H3>"_$$LNG^%ZAPM.bs.BSC4("Создание таблицы из текстового файла")_$$LNG^%ZAPM.bs.BSC4(" ( 2 ШАГ )")_"<H3>"
 N BSS1,BSS2,BSS3,BSS4,BSS5,BSS6,BSS7,BSS8,BSS9
 S $ZT="ErrSave^%ZAPM.bs.BSC4base"
 F I=1:1 Q:$P(NAMF,";",I,I+1)=""
 K S,A,a F I=1:1 Q:$P(NAMF,";",I,I+1)=""  S ii=$P(NAMF,";",I) S A=ii,@A=1 D  i '$$CtrlKeyWord^%ZAPM.bs.BSC4base(A) ZT "errorName"
 .I '$D(S(A)) S S(A)="" Q
 .E  W $$LNG^%ZAPM.bs.BSC4("ИМЕНА ПОЛЕЙ НЕ ДОЛЖНЫ ПОВТОРЯТЬСЯ",93)," '",A,"'",BBK ZT "errorName"
 K A,a
 S BSS1=$G(BSLOGIN),BSS3=$G(BSSES),BSS4=CurUS,BSS6="UPLOADFL^%ZAPM.bs.BSC4r3",BSS8=Proj_"~"_Pn_"~"_Ta_"~"_NAMF_"~"_DELIM
 D CSPUPLOAD("f")
 W "</form>"
 d BACK^%ZAPM.bs.BSCh
 D END^%ZAPM.bs.BSC4
 Q
 //ErrSaveUP G ErrSave^%ZAPM.bs.BSC4base
UPLOADF(Proj,pin,Table) ;ПАРАМЕТРЫ импорта из ТЕКСТОВОГО ФАЙЛА (1 ШАГ)
 n aa ;D pin^%ZAPM.bs.BSC4base
 D BEG1^%ZAPM.bs.BSC4
 W $$STYLE^%ZAPM.bs.BSC4
 W "<BODY><H3>"_$$LNG^%ZAPM.bs.BSC4("Создание таблицы из текстового файла")_$$LNG^%ZAPM.bs.BSC4(" ( 1 ШАГ )")_"<H3>"
 s aa=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"ImportTXT")
 ;I $G(newPR)="2" s aa=0 ;пока так - это линк
 ;I $G(newTP)="2" s aa=0 ;пока так - это линк
 i 'aa W $$LNG^%ZAPM.bs.BSC4("Режимы импорта таблиц из Текстовых файлов доступны при тарифном плане КОРПОРАТИВНЫЙ, или при согласовании условий с администратором при тарифном плане ПРОФЕССИОНАЛЬНЫЙ.")
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="UPLOADF2^~BSC4r3"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<input type=""hidden"" name='Proj' value="""_Proj_""">"
 W "<input type=""hidden"" name='Pn' value='["""_$zu(5)_"""]"_pin_"'>"
 W "<input type=""hidden"" name='Ta' value='"_Table_"'>"
 W "<table border=0 width=100%>"
 s namf="F1;F2;F3;F4;F5;F6;F7;F8;F9;F10;F11;F12;F13;F14"
 W "<tr><td  width=30% align='right' class=s1>"_$$LNG^%ZAPM.bs.BSC4("Имена полей будущей таблицы")_"</td><td align='left' class=s1 ><input type=""text"" title='"_$$LNG^%ZAPM.bs.BSC4("не меняйте разделитель ; между именами полей")_"' size=50 maxlength=50 name='NAMF' value='"_namf_"'></td></tr>"
 W "<tr><td align='right' class=s1>"_$$LNG^%ZAPM.bs.BSC4("Разделитель между даными в строках файла")_"</td><td  align='left' class=s1 ><input type=""text"" size=1 maxlength=1 name='DELIM' value=';'></td></tr>"
 W " </table>"
 ;W "<input "_$s('aa:"disabled",1:"")_" type=""submit"" name='UPLOAD' value='"_$$LNG^%ZAPM.bs.BSC4("Загрузить только структуру таблиц",71)_"'><br>",BK
 w "<input type=""submit"" "_$s('aa:"disabled",1:"")_" name='UPLOAD' value='"_$$LNG^%ZAPM.bs.BSC4("Загрузить структуру и данные")_"'><br><input type=""reset"" name='ESC' value='"_$$LNG^%ZAPM.bs.BSC4("отмена",73)_"'>",BK
 W "</form>" d BACK^%ZAPM.bs.BSCh
 D END^%ZAPM.bs.BSC4
 Q
 //------------------------------------------ CSP TEMPLATE
 
 q "<a href='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"aGET^")_"' target=new TITLE='"_dt_"'>"_t_"</a>"
BSRES D BEG1^%ZAPM.bs.BSC4 S name=BStype
  D BACK^%ZAPM.bs.BSCh W "<HR>"
 s a=$$TR^%ZAPM.bs.BSsFUNM($$txttab^%ZAPM.bs.BSC4r3($P(name,"_",1),$P(name,"_",2)),$C(34),"&#34;") 
 w $$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(a,"'","&#8217;"),"<Ins>","&#60;Ins&#62;")_"';"
 W "<HR>" D BACK^%ZAPM.bs.BSCh
 D END^%ZAPM.bs.BSC4 Q
BSDOC D BEG1^%ZAPM.bs.BSC4
 W "<style type='text/css'>"_BK
 W "h4 { background-color: #007D7D; color: yellow; }"_BK
 W "h2 { background-color: yellow; color: #007D7D; }"_BK
 W "textarea {font-family: Fixedsys, Courier New, Courier;}"_BK
 W "</style>"_BK
 W "</HEAD>"_BK
 W "<BODY>"_BK
 W "<form action='' method=post><CENTER>"_BK
 W "<h4>1. Документация по текстовому процессору %BS"_BK
 W "<select id=type1 name=type onchange=""location='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"BSRES^%ZAPM.bs.BSC4r3")_"&BStype='+document.getElementById('type1').value;"">"_BK
 W "	<option value=""""></option>"_BK
	D TampleteTXT^%ZAPM.bs.BSC4r3
 W "</select></h4>"_BK
 W "<h4>2. Документация по табличному процессору %BS"_BK
 W "<select id=type2 name=type onchange=""location='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"BSRES^%ZAPM.bs.BSC4r3")_"&BStype='+document.getElementById('type2').value;"">"_BK
 W "	<option value=""""></option>"_BK
	D TampleteTAB^%ZAPM.bs.BSC4r3
 W "</select></h4>"_BK
 W "<h4>3. Стpуктуpа %BS-ресурсов. Локали,буфера,NS"_BK
 W "<select id=type3 name=type onchange=""location='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"BSRES^%ZAPM.bs.BSC4r3")_"&BStype='+document.getElementById('type3').value;"">"_BK
 W "	<option value=""""></option>"_BK
	D TampleteBSD^%ZAPM.bs.BSC4r3
 W "</select></h4>"_BK
 W "<h4>4. Cache'-ОПИСАНИЕ ФУНКЦИЙ И МОДУЛЕЙ"_BK
 W "<select id=type4 name=type onchange=""location='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"BSRES^%ZAPM.bs.BSC4r3")_"&BStype='+document.getElementById('type4').value;"">"_BK
 W "	<option value=""""></option>"_BK
	D TampleteBSC^%ZAPM.bs.BSC4r3
 W "</select></h4>"_BK
 W "<h4>5. Документация по ""Информационному порталу"""_BK
 W " <A CLASS=s2 HREF='http://"_($$ipS^%ZAPM.bs.BSCp2)_":1962/vv/bsdoc/index.htm' >Загрузить</A>"_BK
 W "</h4>"_BK
 W "</CENTER><HR>"_BK
 D BACK^%ZAPM.bs.BSCh
 D END^%ZAPM.bs.BSC4
 Q
TampleteBSC //
	S P="^%ZAPM.bs.BSC"
	F I="FUN" D
	.W "<option value=C_"_I_" >"_$P($G(@P@(I)),"@")_"</option>",!
	Q
TampleteBSD //
	S P="^%ZAPM.bs.BSHLP",T="DOC_TAB"
	F I=1:1 Q:'$D(@P@(T,I))  D
	.I $G(@P@(T,I))["_____" S S=$G(@P@(T,I)) W "<option value="_T_$TR($E(S,1,4),".","")_" >"_$P($P($G(@P@(T,I+1)),"== ",2)," ==",1)_"</option>",!
 Q
TampleteTXT //
	S P="^%ZAPM.bs.BSX"
	F I="DocMain","DocStruct","DocGlobals","DocVariabl" D
	.W "<option value=X_"_I_" >"_$P($G(@P@(I)),"@")_"</option>",!
 Q
TampleteTAB //
	S P="^%ZAPM.bs.BSHLP"
	F I=1:1:9 W "<option value=HLP_D"_I_" >"_$P($G(@P@("D"_I)),"@")_"</option>",!
 Q
TampleteRES(N)  Q $$txttab($P(N,"_",1),$P(N,"_",2))
 
txttab(B,T) N Q i B="" Q ""
  S P="^%ZAPM.bs.BS"_B,$ZT="TampleERROR",Q=""
  I B="DOC" S G=$NA(^%ZAPM.bs.BSHLP("DOC_TAB")) S T=$P($P(T,"TAB",2)," ") D  G txt2 
  .F I=1:1 Q:'$D(@G@(I))  I $E($G(@G@(I)),1,3)[(T_".") S II=I D txt1($P($P($G(@G@(II+1)),"== ",2)," ==",1)) D  Q
  ..D  F II=I+1:1 Q:'$D(@G@(II))  Q:$G(@G@(II))["_____"  D
  ...S Q=Q_$G(@G@(II))_"<BR>" 
  E  S G=$NA(@P@(T))
  D txt1($P($G(@G),"@")) 
  F I=1:1 Q:'$D(@G@(I))  S Q=Q_" "_$G(@G@(I))_"<br>" ;$C(13,10)
txt2 S Q=Q_"</pre>" ;  </textarea>"_$C(13,10)
 q Q
txt1(SS)  S Q=Q_"<H2>"_SS_"</H2><pre>"_$C(13,10)  ;_" <textarea cols=95 rows=10 >"
 Q
SetSelectTXT(T,R) 
 i R'="" S ^%ZAPM.bs.BSbufB("SetSelectTXT",R)=T 
 Q $J
GetSelectTXT(R) Q $G(^%ZAPM.bs.BSbufB("SetSelectTXT",R)," //?")
TampleERROR Q $ZE
PROFREST I '$$EXIST^%R("tempBS.INT") D ErrMsg^%ZAPM.bs.BSXfun("НЕ из чего ВОССТАНАВЛИВАТЬ, сначало импортируйте программы *.rgr") Q
 D RestGlo^tempBS,DelRou^tempBS,DEL1^%ZAPM.bs.BSC4r4("tempBS.*") D OkMsg^%ZAPM.bs.BSXfun("Восстановлено")
 Q
GetLenRou(r) //возвратить размер программы в байтах
 i r="" q "???"
 n n,I,i S r=$P(r,".")
 m n=^ROUTINE(r,0)
 S I=0  F i=1:1 Q:'$D(^ROUTINE(r,0,i))  S I=I+$L($G(^ROUTINE(r,0,i)))
 q r_" - имеет размер <font color=red>"_I_"</font> байт."
 //.........................................
VerEX() N F,M1,N1,N2,i,SS,N,FN,STR,T,T1
 S F="L:\MSW_Tools\MakeCab-Copy2---Installation.BAT" ////////////////////////////
 D File2Arr^%ZAPM.bs.BSCEXE(F,.M1),STR2MAS^%ZAPM.bs.BSCmail(.M1,.N,$C(13,10))
 S SS=0,i="",STR="",N2=0,T1=0
  F  S i=$O(N(i)) Q:i=""  D  Q:SS=2
 .I N(i)["@echo !  Recompilation" S SS=1 Q
 .I N(i)["rem -STOP-" S SS=2 Q
 .I SS=0 Q
 .I N(i)["copy " S FN=$P(N(i)," ",2) i FN[":" D
 ..S T=$ZU(140,2,FN) S:T>T1 T1=T S T=$$TD^%ZAPM.bs.BSC4base(T)
 ..S N1=$$VerEXE(FN),STR=STR_$$JF^%ZAPM.bs.BSC4r4($$JF^%ZAPM.bs.BSC4r4($P(FN,"\",$L(FN,"\")),20)_N1,35)_T_$C(13,10),N1=$TR(N1,".0"),N2=N2+N1
  S STR=$$JF^%ZAPM.bs.BSC4r4($$JF^%ZAPM.bs.BSC4r4("Client BS-Portal ver.",20)_"4."_$I(^%ZAPM.bs.BS("Client BS-Portal ver.4.")),35)_$$TD^%ZAPM.bs.BSC4base(T1)_$C(13,10)_"--------------------------------"_$C(13,10)_STR
 K SS S SS(1)=STR D Arr2File^%ZAPM.bs.BSCEXE(.SS,"L:\MSW_Tools\_installation_ext\soft\dsr-client-dev\Support\client.inf")
 Q STR
VerEXE(FN) //ВЕРСИЯ ПРОГРАММЫ
 N I,N,M,i,S,AA S $ZT="VerEr"
 S I="ProductVersion",S="" F i=1:1:$L(I) S S=S_$E(I,i)_$C(0)
 D File2Arr^%ZAPM.bs.BSCEXE(FN,.M),STR2MAS^%ZAPM.bs.BSCmail(.M,.N,$C(1))
 S i="" F  S i=$O(N(i)) Q:i=""  I N(i)[S Q
 S i=$TR($P($P(N(i),S,2),$C(16)),$C(0,1,20,24,12,14,22),"")
 S AA=$TR($P(i,"("),", ",".")
 ;F I=1:1:$L(AA) W !,$E(AA,I),"---",$A($E(AA,I))
 Q $P(AA,".",1,3)
VerEr Q "..." ;$ZE
SetALLStyle //ALL
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Style Set"),$$B27^%ZAPM.bs.BSCGIS(1)
 ;D locvar^%ZAPM.bs.BSCh0("",1)
 I V["@" W RED_"Запрещенный символ @"_EF G SetALLStyle1
 S T=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Acfg")
 I V'="" D
 .I A=2 S $P(@T@(10,1),"@",15)=V,SET=1
 .I A=1,$G(BSGRANT)'="" S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""GRAND"")") D  ;W 1_BD_1 D
 ..I $D(@BD@(BSGRANT)) S @BD@(BSGRANT,"STYLE")=V,SET=1
 I $G(SET)=1 W GREEN_"Параметры изменены<HR>"_EF 
 E  W RED_"Параметры НЕ изменены<HR>"_EF
SetALLStyle1 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 Q
 //////////////// ЕСЛИ УДАЛЯТ BSC4.CFG.FrameStyle.MAC то вставить снова в программу
%BSC4inc ;встроенные функции   ; Compiled October 26, 2005 20:19:50
Navigator ; Пример CacheObjectScript кода : Навигатор прямого доступа к таблице `FrameStyle` 
 ;============================================================
 set Home1=1 
Navig1 ;  ;============================================================
 set Header=" Навигатор прямого доступа к таблице `FrameStyle` " // заголовок страницы
 set Max=$$GetField^%ZAPM.bs.BSC4rou("CFG","FrameStyle","Count") //количество полей
 set MaxI=$$GetField^%ZAPM.bs.BSC4rou("CFG","FrameStyle","Index") //количество индексированных полей
 D DKILL^%ZAPM.bs.BSC4r("Dis") // удалить массив признака опции DISABLE
 D DKILL^%ZAPM.bs.BSC4r("STOP") 
 for Num=1:1:MaxI D  Q:$G(STOP)=1  G:$G(STOP)=2 Navigator  //цикл по индексным полям
    .D KKey(Num)  
    .IF $$DDATA^%ZAPM.bs.BSC4r("Home"_Num) D DSET^%ZAPM.bs.BSC4r("Home"_(Num+1),1) D DSET^%ZAPM.bs.BSC4r("value"_Num,$$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,"",1)) D CheckL Q:$D(STOP)  
    .IF $$DDATA^%ZAPM.bs.BSC4r("End"_Num) D DSET^%ZAPM.bs.BSC4r("Home"_(Num+1),1) D DSET^%ZAPM.bs.BSC4r("value"_Num,$$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,"",-1)) D CheckR 
    .IF $$DDATA^%ZAPM.bs.BSC4r("Del"_Num) D DKILL^%ZAPM.bs.BSC4r("Del"_Num) D DSET^%ZAPM.bs.BSC4r("Left"_Num,1) D KillDirectTab^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key) //удалить узел 
    .IF $$DDATA^%ZAPM.bs.BSC4r("Left"_Num) D DSET^%ZAPM.bs.BSC4r("Home"_(Num+1),1) D DSET^%ZAPM.bs.BSC4r("value"_Num,$$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,$$DGET^%ZAPM.bs.BSC4r("value"_Num),-1)) D CheckL Q:$D(STOP)  
    .IF $$DDATA^%ZAPM.bs.BSC4r("Right"_Num) D DSET^%ZAPM.bs.BSC4r("Home"_(Num+1),1) D DSET^%ZAPM.bs.BSC4r("value"_Num,$$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,$$DGET^%ZAPM.bs.BSC4r("value"_Num),1)) D CheckR 
    .S Dis(Num,1)=($$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,$$DGET^%ZAPM.bs.BSC4r("value"_Num),-1)="") 
    .S Dis(Num,2)=($$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,$$DGET^%ZAPM.bs.BSC4r("value"_Num),1)="") 
 Write "",!
	Write "<html><title>"_(Header)_"</title>"_$c(9),!
	Write "",!
 W $$GetDirectTabN1^%ZAPM.bs.BSC4r("CFG","FrameStyle",$$DGET^%ZAPM.bs.BSC4r("value1"),"MainS")_$$GetDirectTabN1^%ZAPM.bs.BSC4r("CFG","FrameStyle",$$DGET^%ZAPM.bs.BSC4r("value1"),"LeftDn")
 Write "",!
	Write "<body><center><H4>"_(Header)_"</H4>",!
	//ДЕМОНСТРАЦИЯ СТИЛЕЙ ---------
	Write "<table border=1 class=tpTable ><tr>",!
	Write "",!
 	F I=1:1:5 w "<td class=s"_I_" >class=s"_I_"</td>"
 	w "<td ><th title='для оформления ZEN таблицы'>class='table.tpTable th'</th></td>",!
 	w "<td class=u1 ><A ONCLICK='SS(1,NameForm1.value1.value);' class=u1 TITLE='Применить текущий стиль, как основной для Гранда `"_$G(BSGRANT)_"`, который использует текущий пользователь `"_$G(BSLOGIN)_"`'>class=u1</A></td>",!
 	w "<td><A ONCLICK='SS(2,NameForm1.value1.value);' class=item TITLE='Применить текущий стиль, как основной для ВъХ пользователей'>class=A.item</A></td>"
 	Write "</table>",!
 	Write "",!
 D JS^%ZAPM.bs.BSCp
 	w "function SS(A,V) {"_BK
 	;W "alert(V);"_BK
 	W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"SetALLStyle^%ZAPM.bs.BSC4r3")_"&A=""+A+""&V=""+V,""xxx"",""toolbar=no,menubar=no,scrollbars=1,width=500,height=200,status=1,resizable=1"");"_BK
 	W "}"_BK
 D JSE^%ZAPM.bs.BSCp
	//------------------------------
	Write "<form name='NameForm1'  method='POST' action='"_($$ADDLIB^%ZAPM.bs.BSC4())_"' >",!
    D
    I $G(BSLOGIN)'="" Write "<input type=hidden name='BSLOGIN' value='"_$G(BSLOGIN)_"'>",!
    I $G(BSGRANT)'="" Write "<input type=hidden name='BSGRANT' value='"_$G(BSGRANT)_"'>",!
 
	Write "<input type=hidden name='BSDOMAIN' value='/b4y'>",!
	Write "<input type=hidden name='BSG' value='B4'>",!
	Write "<input type=hidden name='BSLABELt' value='Sopen2'>",!
	Write "<input type=hidden name='BSLNG' value='RUS'>",!
	Write "<input type=hidden name='BSNSP' value='~SYS'>",!
	Write "<input type=hidden name='BSPRO' value='CFG'>",!
	Write "<input type=hidden name='BSaX' value='1'>",!
 ;	Write "<input type=hidden name='BSdebug' value='1'>",!
	Write "<input type=hidden name='BSnewREG' value='1'>",!
	Write "<input type=hidden name='BStyle' value='GREEN'>",!
	Write "<input type='hidden' name='BSLABEL' value='Navig2'>",!
	Write "<table border=0>",!
	Write "",!
   D DSET^%ZAPM.bs.BSC4r("Key(Key)",$$DGET^%ZAPM.bs.BSC4r("value"_Num)) //присвоить значение последнего индекса 
    IF $D(Save) D  //присвоить исправления
       .for Num=(MaxI+1):1:Max D  //цикл по всем неиндексным полям
       ..set var1=$$GetField^%ZAPM.bs.BSC4rou("CFG","FrameStyle",Num) //взять все атрибуты текущего поля
       ..set NameFeild=$P(var1,"~",1) //вычленить имя поля
       ..IF $$SetDirectTab^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,NameFeild,$$DGET^%ZAPM.bs.BSC4r("value"_Num)) //присвоим в прямом доступе
   for Num=1:1:Max {  //цикл по всем полям
     set var1=$$GetField^%ZAPM.bs.BSC4rou("CFG","FrameStyle",Num) //взять все атрибуты текущего поля
     set NameFeild=$P(var1,"~",1) //вычленить имя поля
     set Description=$P(var1,"~",2) //вычленить описание поля
     write "<tr>" //вывести описание
     if $P(var1,"~",4)'="" D  //эти поля индексные
       .W "<td align='right'><input type='submit' name='Del"_Num_"' title='удалить узел "_$SELECT(Num=MaxI:"",1:"со всеми потомками высших уровней")_"' value='Удалить'> <input type='submit' "_$$Disable(Num,1)_" name='Home"_Num_"' value='<<'><input type='submit' name='Left"_Num_"' "_$$Disable(Num,1)_" value='<'></td>"
     if Num=(MaxI+1) w "<tr><td><hr></td><td><hr></td><td></td><td><hr></td></tr><td align='right'><input type='submit' name='Save' value='Coхранить'></td>" 
     if Num=(MaxI+2) w "<td align='right'><input type='Reset' name='Reset' value='Отменить'></td>" 
     if Num>(MaxI+2) w "<td></td>"
     if $P(var1,"~",4)="" D  //эти поля не индексные
       .D DSET^%ZAPM.bs.BSC4r("value"_Num,$$GetDirectTab^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,NameFeild)) //прямой доступ к данным таблицы, когда знаешь индексы
     if $P(var1,"~",3)'=1 write "<td><input type='text' size=40 maxlength=2048 title='"_NameFeild_"' name='value"_Num_"' value='"_$$DGET^%ZAPM.bs.BSC4r("value"_Num)_"'></td>"
     if $P(var1,"~",3)=1 write "<td><textarea cols=40 rows=5 title='"_NameFeild_"' name='value"_Num_"' >"_$$DGET^%ZAPM.bs.BSC4r("value"_Num)_"</textarea></td>"
     S var2="<td align='left'>" 
     if $P(var1,"~",4)'="" D  //эти поля индексные
       .S var2=var2_"<input type='submit' name='Right"_Num_"' "_$$Disable(Num,2)_" value='>'><input type='submit' "_$$Disable(Num,2)_" name='End"_Num_"' value='>>'>" 
     write var2_"</td>" 
     write $$Desc(" ("_NameFeild_") "_Description)_"</tr>" 
     }
 write "<input type='hidden' name='BSRoutineId' value='"_BSRoutineId_"'>"
 Write "",!
	Write "</table></form></center>",!
	Write "</body></html>",!
	Write "",!
 ;D $$$DoRou("CFG","NewRoutin3","Variables1") Q  
 quit
Desc(D) Q "<td align='lift'><strong>"_D_"</strong></td>" //вывести описание
CheckL //проверить значение ключей
 if $$DGET^%ZAPM.bs.BSC4r("value"_Num)="" D DSET^%ZAPM.bs.BSC4r("value"_Num,$$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,"",1)) d  
 .if $$DGET^%ZAPM.bs.BSC4r("value"_Num)="" D  
 ..I Num=1 S STOP=1 Q  
 ..E  S Num=Num-1 S STOP=2
 quit
CheckR //проверить значение ключей
 if $$DGET^%ZAPM.bs.BSC4r("value"_Num)="" D DSET^%ZAPM.bs.BSC4r("value"_Num,$$ORDEr^%ZAPM.bs.BSC4r("CFG","FrameStyle",.Key,"",-1)) d  
 .if $$DGET^%ZAPM.bs.BSC4r("value"_Num)="" D  
 ..I Num=1 S STOP=1 Q  
 ..E  S Num=Num-1 S STOP=2
 quit
Disable(N,A) Q $S($G(Dis(N,A)):"DISABLED",1:"") //выставить опцию
KKey(k) //подготовить массив данных узлов
 D DKILL^%ZAPM.bs.BSC4r("Key") //Удалить массив
 n i f i=1:1:k s Key(i)=$$DGET^%ZAPM.bs.BSC4r("value"_i)
 s Key=k Q
Navig2 ;  ;============================================================
 G Navig1
DOCOUT 
 S Fname="N:\123.TXT" I $ZU(140,4,Fname)'=0 S OLDIO=$I O Fname:"UWN" U Fname W "-----",! d  W "-------",! U OLDIO C Fname 
 .s BSR="^%ZAPM.bs.BSHLP" F I=1:1:9 D DOCOUT1(BSR,"D"_I) 
 .s BSR="^%ZAPM.bs.BSX",I="" F  S I=$O(@BSR@(I)) Q:I=""  I $E(I,1,3)="Doc" D DOCOUT1(BSR,I) 
 Q
DOCOUT1(R,T) W !!,"------------------------------------------------------------------"
 S II="" F  S II=$O(@R@(T,II)) Q:II=""  W !,$G(@R@(T,II))
 Q 
]]></Routine>


<Routine name="%ZAPM.bs.BSC4r4" type="MAC" languagemode="0"><![CDATA[
%BSC4r4 ;СОЗДАНИЕ ДИСТРИБУТИВОВ. Модуль выкачки массивов из MSM в ^%ZZZ 
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
LST N M1,N,i,FI,F,T
 S F="d:\MSW_Tools\_installation_ext\soft\dsr-client-dev\Support\"
 D File2Arr^%ZAPM.bs.BSCEXE(F_"Setup.Lst",.M1),STR2MAS^%ZAPM.bs.BSCmail(.M1,.N,$C(13,10))
 S i=""  F  S i=$O(N(i)) Q:i=""  D  
 .I $E(N(i),1,4)="File" S FI=$P($P(N(i),"@",2),",",1) D
 ..S T=$ZU(140,2,F_FI) S T=$$TR^%ZAPM.bs.BSsFUNM($ZD(T,1),"/200","/0")_" "_$ZT($P(T,",",2),3) S $P(N(i),",",5)=$E(T,1,$L(T)-2)_" "_$E(T,$L(T)-1,$L(T))
 ..S T=$ZU(140,1,F_FI) S $P(N(i),",",6)=T
 ..W !,N(i)
 .S N(i)=N(i)_$C(13,10)
 D Arr2File^%ZAPM.bs.BSCEXE(.N,F_"Setup.Lst")
 D ANY
 Q
AUxml s onlyxml=1 //только создать xml
AUFREE S FREE=1 G AU //ДИСТРИБУТИВ ДЛЯ ВСЕХ, А НЕ ТОЛЬКО ДЛЯ ВВ
 Q
AUFON S addFON=1 //C МАССИВАМИ FON 
AU I $$ZU^%ZAPM.bs.BSF4("%SYS") S $ZT="Er" D AUTO //ПОЛНАЯ СБОРКА ДИСТРИБУТИВА БЕЗ FON
 q
Er W !,$ZE D ANY
 Q 
AUTO S AUTO=1 D ALL,VAR1^%ZAPM.bs.BSCm1,VAR3^%ZAPM.bs.BSCm1,ARX
 I $G(FREE) W !,"!!!!!!!! ДЛЯ ВСЕХ !!!!!!!!!!!!!",!
 I $ZU(140,4,ARX)=0 D  //ЕСЛИ СУЩЕСТВУЕТ СТАРЫЙ, ТО ...
 .S Time=$ZU(140,2,ARX),Time=$ZD(Time,3)_"~"_(VER-1) 
 .W !,"Копируем предыдущий дистрибутив в "_Time,!
 .D exec^%ZAPM.bs.BSCEXE(COMM_"COPY "_$TR(ARX_" "_$$TR^%ZAPM.bs.BSsFUNM(ARX,"bsdsr.zip","bs"_Time_".zip"),"/","\"),0)
 .I $ZU(140,5,ARX)
 S COMM1=COMM_" "_Dbin_"\Rar.exe a -ep "_$TR(ARX_" "_PR1,"/","\")_"\*.*"
 W !,"Формирование архива "_COMM1,!!
 D exec^%ZAPM.bs.BSCEXE(COMM1,0) ;_" -ps3v9e3t6a8m9y0",0)
 I $ZU(140,4,ARX)=0 W !,"Архив готов. "_$ZU(140,1,ARX)_" byte. "_$ZD($ZU(140,2,ARX),3),!,ARX
 E  W !,"!!! Архив НЕ готов ! "_ARX
 W !! i $g(onlyxml) g xml1
 D exec^%ZAPM.bs.BSCEXE(COMM_" N:\InfoPortal\rarcsp.bat",0) s CSPf=$$TR^%ZAPM.bs.BSsFUNM(ARX,"bsdsr.zip","ip\cache\csp.rar")
 I $ZU(140,4,CSPf)=0 W !,"Архив готов. "_$ZU(140,1,CSPf)_" byte. "_$ZD($ZU(140,2,CSPf),3),!,CSPf
 E  W !,"!!! Архив НЕ готов ! "_CSPf
xml1 W !,$$VerEX^%ZAPM.bs.BSC4r3 //ПРОСЧИТАТЬ ВЕРСИЮ КЛИЕНТА 
ANY W !!,"...Press ANY KEY ..." R *r1
 Q
ARX S PR1=$p(PR1,"/",1,$l(PR1,"/")-1) ;,ARX=$$TR^%ZAPM.bs.BSsFUNM(PR1,"BSNEW","bssetup")_"\bsdsr.zip"
 S ARX=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSRA")_"bsdsr.zip"
 ;I $G(^%ZAPM.bs.BSETUP("BSDSR","ARX"))'="" S ARX=^%ZAPM.bs.BSETUP("BSDSR","ARX")
 Q
ALL I $G(addFON) D FON^%ZAPM.bs.BSCAsIs1("^%ZAPM.bs.BStemp",1)
 N GOF,RSA 
 D BSC,BSc,BSETUP,BSCACHE
 K ^%ZAPM.bs.BStemp
 ;I '$G(AUTO) D ARX S A=$$LineEdit^%ZAPM.bs.BSXfun(ARX,"!!!!!!!! ВВЕДИТЕ ПОЛНЫЙ ПУТЬ К ДИСТРУБУТИВУ !!!!!!!!") I A'="" S ^%ZAPM.bs.BSETUP("BSDSR","ARX")=A
 i '$g(onlyxml) D GOFRSA
 D XML
 Q
GOFRSA N dir,g,g1,I,II
 S dir="N:/ROU/Install" I '$$exists^%ZAPM.bs.BSCEXE(dir) W "Директория "_dir_" не создана!" Q
 //массивы
 F II="MAC","INC" i $d(@("r"_II)) K @("^tempBSr"_II) S GOF("BSC","tempBSr"_II)="",I="" F  S I=$O(@("r"_II)@(I)) Q:I=""  m @("^tempBSr"_II)@(I)=@("^r"_II)@(I)
 S I="" F  S I=$O(GOF(I)) Q:I=""  D
 .N g
 .M g=GOF(I) D %GOF^%ZAPM.bs.BSCEXE($ZCONVERT(dir_"/bs-portal/"_I,"L")_".gof",.g,$G(GOF(I)))
 N g
 //программы
 S I="" F  S I=$O(RSA(I)) Q:I=""  I I'["-" D
 .M g=RSA(I)
 .S II="" F i=1:1 S II=$O(g(II)) Q:II=""  S g1(i)=II_"."_g(II)
 .S g1(i)="ZSTU.INT"
 .I $$Ro^%ZAPM.bs.BSCEXE($ZCONVERT(dir_"/update","L")_".rsa","g1",,$G(RSA(I)))
 Q
XML //ВСЕ ВЫБРОСИТЬ В XML
 N List,I,g,g1,II,dir
 S dir="N:/ROU/b4y" I '$$exists^%ZAPM.bs.BSCEXE(dir) W "Директория "_dir_" не создана!" Q
 i '$g(onlyxml) S (List("/csp/msw/BsDoc.csp"),List("/csp/msw/BsDocResult.csp"),List("/csp/msw/BsLib.csp"),List("/csp/msw/BsLibresult.csp"))=""
 S (List("/csp/msw/b4y/b4yupload.csp"),List("/csp/msw/b4y/b4yuploadf.csp"))=""
 i $g(onlyxml) S (List("/isc/studio/templates/BsLIB.csp"),List("/isc/studio/templates/BsLIB2.csp"))=""
 F I="BSG","BSQLDSN","BSWebService","GRAND","GRANDAPP","HELP","MAIL","PROTECT","SESSIONS","TEST","VISIT" S List("BSC."_I_".CLS")=""
 F I="Content1","Content2","Content3","Param","Tree" S List("BSC4.BSDOC."_I_".CLS")=""
 F I="DemonCFG","DemonCMD","Dict","FrameStyle","Param","Projects","PropFields","PropTables","UStatus" S List("BSC4.CFG."_I_".CLS")=""
 //программы
 S I="" F  S I=$O(RSA(I)) Q:I=""  I I'["-" D
 .M g=RSA(I)
 .S II="" F  S II=$O(g(II)) Q:II=""  D
 ..I $D(^rINC(II)) S List(II_".INC")="" Q
 ..S List(II_"."_g(II))=""
 .;S List("ZSTU.INT")=""
 i '$g(onlyxml) S List("%BSALL.PRJ")=""   //^oddPROJECT(nameProj,item,....
 //массивы
 K g
 S I="" F  S I=$O(GOF(I)) Q:I=""  D
 .I I="BScBDPROFILE" D  Q
 ..S II="" F  S II=$O(GOF(I,II)) Q:II=""  S g(II_".GBL")=""
 ..do $system.OBJ.Export(.g,dir_"/"_I_".xml","d",.err)
 .S II="" F  S II=$O(GOF(I,II)) Q:II=""  I II'["tempBSr" S List(II_".GBL")=""
 do $system.OBJ.Export(.List,dir_"/BSALL.xml","d",.err)
 K List S List("BsBuild.INT")=""
 do $system.OBJ.Export(.List,dir_"/BsBuild.xml","d",.err)
 Q 
 ;
G2F(GLN,%DEV,CURDEV,RComment) //МАССИВ В ФАЙЛ -----------
 N NFN,LR,LTR,f,DOS,FNO
 D GSAVE(GLN,"tempBS")
 i $$RREST("tempBS") U $G(CURDEV,0) w "Есть ошибки !!!",! q
 I $$Open^%ZAPM.bs.BSCF1(%DEV,"W")<0  U $G(CURDEV,0) W "Ошибка открытия файла ! "_%DEV,! Q
 U %DEV
 D RComment(RComment),RO("^ROUTINE","INT",1,0,"+tempBS*") 
 C %DEV U $G(CURDEV,0)
G2F1 D DeltempBS
 Q
OPENFILE(PR1,AUTO) I '$G(AUTO)   D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q 0
 I $G(AUTO) S %FN=PR1 D  I '$$OpenFile^%ZAPM.bs.BSCF1(PR1,"A") K %FN,%DEV Q 0
 .I $$DelFile^%ZAPM.bs.BSCEXE(PR1)
 Q 1
BSETUP //СОЗДАТЬ ДИСТРИБУТИВ %BSETUP.RGR
 D DeltempBS
 N %FN,%DEV,NFN,LR,LTR
 S PR1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSR")_"%bsetup.rgr"
 ;I PR1'["/" S PR1=$g(^%ZAPM.bs.BSETUP("BSDSR",2),"D:/MSW/!")_"/%bsetup.rgr"
 S GOF="BSETUP"
 D GSAVE("+%BSETUP*","tempBS")
 W !!! i $$RREST("tempBS") w "Есть ошибки !!!",!!! q
 ;D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 U %DEV ;s ^%ZAPM.bs.BSETUP("BSDSR",2)=$p(%FN,"/",1,$l(%FN,"/")-1)
 S RSA="BSETUP-"
 S GOF(GOF)="%BSETUP-global. Version "_$$ver^%ZAPM.bs.BSC
 D RComment(GOF(GOF)),RO("^ROUTINE","INT",1,0,"+tempBS*") W !!!!
 C %DEV
BSETUP1 D DeltempBS
 Q
PROF //СОЗДАТЬ ДИСТРИБУТИВ ПРОФИЛЕЙ
 D DeltempBS
 N %FN,%DEV,NFN,LR,LTR
 S PR1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSR")_"%bs-profile.rgr"
 ;S PR1=$g(^%ZAPM.bs.BSETUP("BSDSR",3),"D:/MSW/!")_"/%bs-profile.rgr"
 S GOF="PROFILE"
 D GSAVE("+%BSc4uSERS,+%BSC4.Profile,+%BSC4grand,+%BScGRAND,+%BScGAPP,+%BScPROT","tempBS")
 ;D GSAVE("%BSC4.Profile","tempBS")
 ;D GSAVE("%BSC4grand","tempBS")
 ;D GSAVE("%BScGRAND","tempBS")
 ;D GSAVE("%BScGAPP","tempBS")
 ;D GSAVE("%BScPROT","tempBS")
 W !!! i $$RREST("tempBS") w "Есть ошибки !!!",!!! q
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 U %DEV ;s ^%ZAPM.bs.BSETUP("BSDSR","Profile")=$p(%FN,"/",1,$l(%FN,"/")-1)
 S RSA="PROFILE-"
 S GOF(GOF)="%BS profile. Version "_$$ver^%ZAPM.bs.BSC
 D RComment(GOF(GOF)),RO("^ROUTINE","INT",1,0,"+tempBS*") W !!!!
 C %DEV
 D DeltempBS
 d GOFRSA
 Q
BSc //СОЗДАТЬ ДИСТРИБУТИВ %BScBD.RGR
 D DeltempBS
 N %FN,%DEV,NFN,LR,LTR
 S PR1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSR")_"%bscbd.rgr"
 ;S PR1=$g(^%ZAPM.bs.BSETUP("BSDSR",3),"D:/MSW/!")_"/%bscbd.rgr"
 S GOF="BScBDPROFILE"
 I $G(FREE) S MASK="+%BSc*,-%BScVIS,-%BScMAIL,-%BSc4uSESS,-%BSc4uSERS,-%BScPROT"
 E  S MASK="+%BSc*,-%BScVIS,-%BScMAIL,-%BSc4uSESS"
 D GSAVE(MASK,"tempBS")
 W !!! i $$RREST("tempBS") w "Есть ошибки !!!",!!! q
 ;D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 U %DEV ;s ^%ZAPM.bs.BSETUP("BSDSR",3)=$p(%FN,"/",1,$l(%FN,"/")-1)
 S RSA="BSc-"
 S GOF(GOF)="%BSc*-globals. Version "_$$ver^%ZAPM.bs.BSC
 D RComment(GOF(GOF)),RO("^ROUTINE","INT",1,0,"+tempBS*") W !!!!
 C %DEV
BSc1 D DeltempBS
 Q
BSC //СОЗДАТЬ ДИСТРИБУТИВ %BSС.RR %BSС.RGR
 D DeltempBS
 N %FN,%DEV,NFN,LR,LTR
 X "ZL %BSF11 ZS %BSCnewF11"
 S PR1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSR")_"%bsc.rr"
 ;S PR1=$g(^%ZAPM.bs.BSETUP("BSDSR",0),"D:/MSW/!")_"/%bsc.rr"
 d VERADD($P(PR1,"/",1,$L(PR1,"/")-1)_"/#.ver")
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 U %DEV ;s ^%ZAPM.bs.BSETUP("BSDSR",0)=$p(%FN,"/",1,$l(%FN,"/")-1)
 S RSA="BSC",RSA(RSA)="%BSC-routine. Version "_$$ver^%ZAPM.bs.BSC
 I $G(FREE) S ROULIST="+%BSC*,-%BSCSV*"
 E  S ROULIST="+%BSC*"
 D RComment(RSA(RSA)),RO("^rINC","INC","","","+%BSC*")
 D RO("^ROUTINE","INT",1,0,ROULIST) //,RO("^ROUTINE","INT","",0,"+%ZMGWS*") //,RO("^ROUTINE","INT","",0,"+%a*")
 D RO("^rMAC","MAC","",0,"+%BSC*"),RO("^rMAC","MAC","",0,"+%zek*") W !!!!
 C %DEV U 0
 S GOF="BSC"
 I $G(FREE) S MASK="+%BSC*,-%BSC4SNX*,+BSC*,-BSC4.CFG.UStat*,-%BSZ,+%BSC4SNX,-%BSZ*,-%BSMDDR,-%BSCmdapilog"
 E  S MASK="+%BSC*,-%BSC4SNX.OUT*,-%BSC4SNX.BPO*,-%BSC4SNX.Protokol*,-%BSC4SNX.VKS*,+BSC*,-BSC4.CFG.UStat*,-%BSCmdapilog"
 D GSAVE(MASK,"tempBS") ;,GSAVE("BSC","tempBS")
 W !!! i $$RREST("tempBS") w "Есть ошибки !!!",!!! q
 S NFN=$P(%FN,".",1)_".rgr"
 i $$Open^%ZAPM.bs.BSCF1(NFN,"W")
 U NFN
 S RSA="BSC-"
 S GOF(GOF)="%BSC-globals. Version "_$$ver^%ZAPM.bs.BSC
 D RComment(GOF(GOF)),RO("^ROUTINE","INT",1,0,"+tempBS*") W !!!!
 C NFN
BSC1 D DeltempBS
 Q
BSCACHE //СОЗДАТЬ ДИСТРИБУТИВ %BSСACHE.RR %BSСACHE.RGR
 D DeltempBS
 N %FN,%DEV,NFN,LR,LTR,MASK
 S PR1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSR")_"%bscache.rr" 
 ;S PR1=$g(^%ZAPM.bs.BSETUP("BSDSR",1),"D:/MSW/!")_"/%bscache.rr"
 ;D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 U %DEV ;s ^%ZAPM.bs.BSETUP("BSDSR",1)=$p(%FN,"/",1,$l(%FN,"/")-1)
 S RSA="BSCACHE",RSA(RSA)="%BSCACHE-routine. Version "_$$ver^%ZAPM.bs.BSC
 I $G(FREE) S ROULIST="+%BS*,-%BSC*,-%BSc*,-%BSTAB*,-%BSMOL*,-%BSmirO*,-%BSion*,-%BSgsv*,-%BSfon*,-%BSkov*"
 E  S ROULIST="+%BS*,-%BSC*,-%BSc*"
 D RComment(RSA(RSA)),RO("^ROUTINE","INT",1,0,ROULIST),RO("^rMAC","MAC","",0,"+%BS*") W !!!!
 C %DEV U 0
 S GOF="BSCACHE"
 I $G(FREE) S MASK="+%BS*,-%BSC*,-%BSc*,-%BSETUP,-%BSb*,-%BSpgWEB*,+%BSpgWEBC,-%BSpgWEMM"
 E  S MASK="+%BS*,-%BSC*,-%BSc*,-%BSETUP,-%BSb*,-%BSvda*,-%BSpgWEB*,+%BSpgWEBC,-%BSpgWEMM,-%BSC4MON.SINX.BPO,+%BSCiP*"
 D GSAVE(MASK,"tempBS")
 W !!! i $$RREST("tempBS") w "Есть ошибки !!!",!!! q
 S NFN=$P(%FN,".",1)_".rgr"
 i $$Open^%ZAPM.bs.BSCF1(NFN,"W")
 U NFN
 S RSA="BSCACHE-"
 S GOF(GOF)="%BSCACHE-globals. Version "_$$ver^%ZAPM.bs.BSC
 D RComment(GOF(GOF)),RO("^ROUTINE","INT",1,0,"+tempBS*") W !!!!
 C NFN
BSCACHE1 D DeltempBS
 Q
VERADD(PR1) //СЧЕТЧИК ВЕРСИЙ+1
 S VE=$P(^%ZAPM.bs.BSC4,"@",2)
 S VER=$P(VE,"Version :",2)+1
 S $P(VE,"Version :",2)=VER_" от "_$ZD(+$H,3)
 S $P(^%ZAPM.bs.BSC4,"@",2)=VE
 S ^ROUTINE("%BS",0,1)="%BS ///"_$$ver^%ZAPM.bs.BSC
 N %FN,%DEV,NFN,LR,LTR
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 U %DEV W $$ver^%ZAPM.bs.BSC," ",$ZU(110)
 C %DEV U 0
 Q
Ver() q "Ver. "_$P($P(^%ZAPM.bs.BSC4,"@",2),"Version :",2)
 //--------------------------------------------------------------------------
RO(M,EXT,N,NN,MA) //ВЫВЕСТИ СТРОКИ ПРОГРАММ
 N I,MI,MI2,MI3,MI4
 ;I MA["-" S MI2=$P(MA,"-",2),MI3=$P(MA,"-",3),MI4=$P(MA,"-",4),MI5=$P(MA,"-",5),MA=$P(MA,"-",1)
 S I=""  F  S I=$O(@M@(I)) Q:I=""  I $$MASK(I,MA) D  ;I ("@"_I)[("@"_MA) D
 .;I $G(MI2)'="",("@"_I)[("@"_MI2) Q  //ИСКЛЮЧЕНИЯ
 .;I $G(MI3)'="",("@"_I)[("@"_MI3) Q
 .;I $G(MI4)'="",("@"_I)[("@"_MI4) Q
 .;I $G(MI5)'="",("@"_I)[("@"_MI5) Q
 .S II=0
 .I EXT="INT",$D(^rMAC(I)) Q  //
 .I M="^rMAC" S rMAC(I)=""
 .I M="^rINC" S rINC(I)=""
 .S RSA(RSA,I)=EXT
 .W I,"^",EXT,"^"_N_"^",$G(@M@(I,0)),"^"_NN,!
 .F II=1:1 Q:'$D(@M@(I,0,II))   W @M@(I,0,II),!
 .W !
 Q
RComment(T) W $S($D(FREE):"Дистрибутив Для Всех. ",1:"")_"Cache for Windows NT^MAC^"_T_" из области "_$ZU(5)_"^~Format=Cache.S~",!,"%BS version "_$$ver^%ZAPM.bs.BSC_" ~"_$ZU(5)_"~",!
 Q
MASK(NAME,MASK) //ЛОГИКА ВКЛЮЧЕНИЯ\ВЫКЛЮЧЕНИЯ ИМЕН
 N A,I,J,M,RET S RET=0
 i MASK="*" q 1
 I '$D(MI) F I=1:1 Q:$P(MASK,",",I,I+1)=""  S A=$P(MASK,",",I),J=$E(A,1) S MI(J,$E($P(A,"*"),2,99))=A["*"
 S I="" F  S I=$O(MI("+",I)) Q:I=""  D  Q:RET=2
 .I MI("+",I)=0,NAME=I S RET=2 Q
 .I MI("+",I)=1,("@"_NAME)[("@"_I) S RET=1 Q
 I RET=1 S I="" F  S I=$O(MI("-",I)) Q:I=""  D  
 .I MI("-",I)=1,("@"_NAME)[("@"_I) S RET=0 Q
 .I MI("-",I)=0,NAME=I S RET=0 Q
 Q RET
GSAVE(MA,ROU) //СОХРАНИТЬ ГЛОБАЛИ В ПРОГРАММАХ
 N t,NS,i,ii,rc,MI,MI2,MI3,MI4,MI5
 S NS=$ZU(5),t="^mtempmBSdirGlob"
 D GetGlobalDir^%ZAPM.bs.BSCp(NS,t)
 ;I MA["-" S MI2=$P(MA,"-",2),MI3=$P(MA,"-",3),MI4=$P(MA,"-",4),MI5=$P(MA,"-",5),MA=$P(MA,"-",1)
 S i="" F ii=1:1 S i=$O(@t@(i)) Q:i=""  I $$MASK(i,MA) D  ;I ("@"_i)[("@"_MA) D
 .;I $G(MI2)'="",("@"_i)[("@"_MI2) Q
 .;I $G(MI3)'="",("@"_i)[("@"_MI3) Q
 .;I $G(MI4)'="",("@"_i)[("@"_MI4) Q
 .;I $G(MI5)'="",("@"_i)[("@"_MI5) Q
 .S GOF(GOF,i)=""
 .S LR=$G(LR)+1,LR(LR)=$$G2R("^"_i,ROU_"."_$$NaR(i)) ;W !,i
 K @t
 Q
NaR(N) I $E(N,1)="%" Q "p"_$E(N,2,99)
 Q N
RREST(ROU) //СОБРАТЬ ПРОГРАММУ ВОССТАНОВЛЕНИЯ
 N ERR
 D NEWROU(ROU),ADDSTR(ROU,"RestGlo //")
 S I="" F  S I=$O(LR(I)) Q:I=""  D ADDSTR(ROU,LR(I)) I LR(I)["!ERROR" S ERR=$G(ERR)+1
 D ADDSTR(ROU," Q"),ADDSTR(ROU,"DelRou //") //,ADDSTR(ROU," S $ZT=""DelErr^"_ROU_""" //")
 S I="" F  S I=$O(LTR(I)) Q:I=""  I LTR(I)'=ROU D ADDSTR(ROU," D DEL1^%ZAPM.bs.BSC4r4("""_LTR(I)_".*"")")
 D ADDSTR(ROU," Q") //,ADDSTR(ROU,"DelErr Q  //")
 D SAVEROU(ROU)
 I $G(ERR) Q +$G(ERR)
 Q 0
 /*
 >w $$Quote^%cspQuote($lb("123",123))
$c(5,1)_"123"_$c(3,4)_"{"
>w $$Quote^%cspQuote($lb("123",123,"aa ""111"" bb"))
$c(5,1)_"123"_$c(3,4)_"{"_$c(13,1)_"aa ""111"" bb"
 */
G2M(i) ;ГЛОБАЛЬ В ЛОКАЛЬ
 K STR S FLAG=0
 S STR(1)=" S "_GG_"="_$$CUT($E(i,1,LONG))
 F f=2:1 Q:$E(i,f*LONG-LONG+1,LONG+(LONG*(f-1)))=""  S FLAG=0,STR(f)=" S @$ZR=@$ZR_"_$$CUT($E(i,f*LONG-LONG+1,LONG+(LONG*(f-1))))
 Q
CUT(S)  I S="" Q """"""
 S SS="" F II=1:1:$L(S) S v=$A($E(S,II)) D
 .I v<32 D ADSUM(v) Q  ;//"$C("_v_")") Q
 .I v>126&(v<161) D ADSUM(v) Q  ;//"$C("_v_")") Q
 .I v=34 D ADSUM(v) Q  ;//"$C("_v_")") Q
 .D ADSU($E(S,II))
 I FLAG=2 S SS=SS_""""
 I FLAG=1 S SS=SS_")"
 Q SS
ADSUM(S) I FLAG=1 S SS=SS_","_S ;//S SS=SS_"_"_S
 I FLAG=0 S SS="$C("_S ;//S SS=S
 I FLAG=2 S SS=SS_"""_$C("_S ;//S SS=SS_"""_"_S
 S FLAG=1
 Q
ADSU(S) I FLAG=1 S SS=SS_")_"""_S ;//S SS=SS_"_"""_S
 I FLAG=0 S SS=""""_S
 I FLAG=2 S SS=SS_S
 S FLAG=2
 Q
G2R(G,R) //ГЛОБАЛЬ В ПРОГРАММУ ЗАСУНУТЬ
 N BT,ND,BTR,BTR1,R1,RR,GG,I,II,ROUTINE,LONG,f,v,ERROR,FLAG,RSTR,STR,SS,err
 S ERROR=0
 I '$D(@G) Q $$GINFO(" // global: "_G_" not exist")
 D NEWROU(R)     S RR=R,R1=0,BTR=0,BT=0,ND=0,LONG=1000
 I $D(@G)'[0 D SAVENODE(G)
 S GG=G F  S GG=$ZO(@GG) Q:GG=""  D SAVENODE(GG)
 D SAVEROU(RR)
 I $G(ERROR) Q $$GINFO(" //D ^"_R_" //!!!ERROR="_ERROR_" // ")
 Q $$GINFO(" D ^"_R_" // ")
GINFO(S) N A S A=$$JF(S,50) I $D(BT) S A=A_$$JF(BT,8,".")_$$JF("bytes",9)_$$JF(ND,6,".")_"nodes"
 Q A
JF(S,N,C) Q S_$TR($J("",N-$L(S))," ",$G(C," "))
SAVENODE(GG) //СОХРАНИТЬ УЗЕЛ
  S BT=BT+$L(@GG)+$L(GG),ND=ND+1
  D G2M(@GG)
  S I="" F  S I=$O(STR(I)) Q:I=""  D
  .S BTR=BTR+$L(STR(I))
  .I BTR>31000 S R1=R1+1 D ADDSTR(RR," S LTR=$G(LTR)+1,LTR(LTR)="""_RR_""" G ^"_R_"."_R1),SAVEROU(RR) S RR=R_"."_R1 D NEWROU(RR)
  .D ADDSTR(RR,STR(I))
  Q
ADDSTR(RR,S) //ДОБАВИТЬ СТРОКУ В ПРОГРАММУ
 S RSTR=RSTR+1,ROUTINE(RSTR)=S
 Q
NEWROU(R) K ROUTINE
 S ROUTINE(1)=" //Программа создающая массив"
 S BTR=$L(ROUTINE(1)),RSTR=1,LTR=$G(LTR)+1,LTR(LTR)=R
 Q
SAVEROU(R) //СОХРАНИТЬ ПРОГРАММУ
 S ROUTINE(0)=RSTR
 D ROUTINE^%R(R_".INT",.ROUTINE,.err,"CS",0)
 I $G(err)'="" W $$FMTERR^%R(.err,.ROUTINE) S ERROR=ERROR+1
 E  W !,R," Ok"
 Q
MIR //СОЗДАТЬ ДИСТРИБУТИВ %GKDO*.RR %MIR*.RGR --- ДИСПЕТЧЕР ДОКУМЕНТОВ --- МИРЕНБУРГ АНДРЕЙ ЛЬВОВИЧ
 D DeltempBS
 N %FN,%DEV,NFN,LR,LTR
 S PR1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBSDSR")_"%GKDOC.rg"
 ;S PR1=$g(^%ZAPM.bs.BSETUP("BSDSR",0),"D:/MSW/!")_"/%GKDOC.rg"
 I '$$OPENFILE(PR1,$G(AUTO)) Q
 D GSAVE("+%MIR*","tempBS")
 W !!! i $$RREST("tempBS") w "Есть ошибки !!!",!!! q
 U %DEV ;s ^%ZAPM.bs.BSETUP("BSDSR","%MIR")=$p(%FN,"/",1,$l(%FN,"/")-1)
 D RComment("%GKDOC-routine. Version "_$$ver^%ZAPM.bs.BSC),RO("^ROUTINE","INT",1,0,"+%GKDO*"),RO("^ROUTINE","INT",1,0,"+tempBS*") W !!!!
 C %DEV U 0 D DeltempBS
 Q               
DeltempBS I $$EXIST^%R("tempBS.INT")     D DelRou^tempBS,DEL1("tempBS.*") Q
DEL1(r) i $$ZV^%ZAPM.bs.BSCp>5 s r=$p(r,".*")
 d DEL^%R(r)
 q
DELs(mask) //удаление программ по маске
 q
 n i,ii
 S (i,ii)=$p(mask,"*") d  F  S i=$O(^ROUTINE(i)) Q:i=""  d
 .i $Zname(i,1) i ("@"_i)[("@"_ii) w !,$$DEL^%R(i)
 q 
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;Модуль выкачки массивов из MSM в ^%ZZZ 
 ;0. Перенести в MSM под именем ^z в кип PRG
 ;1. создать там новый том ZZZ,ZZZ для хранения массива Z с длиной узла до 511
 ;2. запустить gd^z
 ;3. перенести массив ^[""ZZZ"",""ZZZ""]Z в Кашу в namespace PRG
 ;4. восстановить d Z^%ZAPM.bs.BSC4r4("^Z")
g2g(G,gl) ;положить глобаль в линейный массив
 s LONG=200
 i $g(gl)="" s gl="^mtempGL"
 ;s l=0
 I $D(@G)'[0 D sAVENODE(G)
 S GG=G F  S GG=$ZO(@GG) Q:GG=""  D sAVENODE(GG)
 q
sAVENODE(GG) ;СОХРАНИТЬ УЗЕЛ
  S BT=$g(BT)+$L(@GG)+$L(GG),ND=$g(ND)+1
  D G2M(@GG)
  S I="" F  S I=$O(STR(I)) Q:I=""  D
  .S BTR=$g(BTR)+$L(STR(I))
  .s l=l+1,@gl@(l,0)=$l(@GG)+$L(GG),@gl@(l)=$e(STR(I),1,510) i $e(STR(I),511)'="" s @gl@(l,1)=$e(STR(I),511,511+510) 
  Q
gMT k ^%ZZZ d g2g("^MT","^%ZZZ")
 q
g(gl) k @gl g gd1
gd s gl="^[""ZZZ"",""ZZZ""]Z" k @gl
gd1 S i="^",l=0 F  S i=$O(@i) Q:i=""  S i="^"_i w !,i D
 .;i i="^GRAF" w " пропущено <DKSER>" q
 .d g2g(i,gl)
 w !," количество ошибок: " zw ERR
 q
Z(G) ;Модуль закачки массивов из ^Z в ... с перекодирокой из ASCII в ANSI
 s nm1="" //,(S1,S2)="" //
 d INIT^%ZAPM.bs.BSre(0) 
 i $g(G)="" S G="^Z" K ^%ZZZ,ERR
 S I="" F  S I=$O(@G@(I)) Q:I=""  S xxx=I
 .s cs=@G@(I,0),s=@G@(I) i $d(@G@(I,1)) s s=s_@G@(I,1)
 .s in=$p(s,"=",1),nm=$p($p(s," ^",2),"=",1) s v=$p(s,"=",2,999) 
 .D  i nm'=nm1 s nm1=nm k @("^"_nm1) w !,nm1_" "
 ..I nm["(" S nm=$P(nm,"(")
 ..I in["(",in'[")" S in=$p(s,"=",1,2),v=$p(s,"=",3,999) 
 ..I in["(",in'[")" S in=$p(s,"=",1,3),v=$p(s,"=",4,999) 
 .D  x "s ^%ZZZ="_v 
 ..I $E($g(@G@(I+1)),1,12)=" S @$ZR=@$ZR" S v=v_" "_@G@(I+1),I=I+1
 .S in=$P($tr(in,S1,S2),"S ",2,999) S @in=$tr(^%ZZZ,S1,S2)
 .s g=$zr,cs1=$l(g)+$L(@g) i cs1'=cs w !,g w " "_cs1_","_cs_" не совпадает кол-во символов" S ERR=$g(ERR)+1,ERR(ERR,g)=cs1
 q
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 //Создание дистрибутива комплекса АСУРП
PRG N LIST
 s dir="Z:\n\ASU-AST\Arhiv\rou\prg\"
 zn $$v^%ZAPM.bs.BSCp("vPRG")
 d addRou("+A*,+Q*,+W*,+E*,+R*,+T*,+Y*,+U*,+I*,+O*,+P*,+S*,+D*,+F*,+G*,+H*,+J*,+K*,+L*,+Z*,+X*,+C*,-CSP*,+V*,+B*,+N*,+M*")
 d addGlo("+BS*,-BSprot*,-BSbufS*,+MSM*,+ASU*") //"+A*,+Q*,+W*,+E*,+R*,+T*,+Y*,+U*,+I*,+O*,+P*,+S*,+D*,+F*,+G*,+H*,+J*,+K*,+L*,+Z*,+X*,+C*,+V*,+B*,+N*,+M*")
 s time=$zd($h,3)_"("_$tr($p($ZDATETIME($ZUTIL(188),1,1,2)," ",2),":","'")_")"
 do $system.OBJ.Export(.LIST,dir_time_"-prg.xml","d",.err)
 zn "%SYS" k LIST
 d addRou("+%BS*,+%ZM*,+%GBA*")
 d addGlo("+%ZM*")
 do $system.OBJ.Export(.LIST,dir_time_"-sys.xml","d",.err)
 w ! zw err
 Q
DescOut2File(ClassName,dir) //выгрузить в файл описание класса
 n menFile,menuU,OLDIO,pr,i,z
 d lp^%ZAPM.bs.BSCp2(ClassName,.pr)
 d menuBeg,menuTab,menuEnd
 q
menuTab 
 U menFile  w "<table border=1 >"
 w "<tr><td><b>Имя таблицы</b></td><td> -</td><td><b>"_ClassName_"</b></td></tr>"
 w "<tr><td><b>Описание таблицы</b></td><td> -</td><td><b>"_pr_"</b></td></tr>"
 w "<tr><td><i>Имя поля</i></td><td>Тип</td><td>Описание поля</td></tr>"
 S i="" F  S i=$O(pr(i)) Q:i=""  d
 .w "<tr><td><i>"_pr(i)_"</i></td><td>"_$g(pr(i,"type"))_"</td><td>"_$g(pr(i,"desc"),"?"_pr(i))_"</td></tr>"
 w "</table>"_BK
 U OLDIO q
menuBeg
 i pr["%Zen" s z="zen"
 s i=$o(pr("")) i i'="" i $g(pr(i,"type"))["%ZEN" s z="zen"
 S menFile=dir_$g(z,"tab")_ClassName_".html" ;I $ZU(140,4,menFile)'=0 
 S OLDIO=$I O menFile:"UWN" U menFile 
 D BEG1^%ZAPM.bs.BSC4 
 U OLDIO s menU=0
 q
menuEnd
 U menFile D END^%ZAPM.bs.BSC4 U OLDIO
 C menFile 
 q
addRouMac(MA) //Создание дистрибутива комплекса АСУРП программы MAC 
 n i,ii,rc,MI,MI2,MI3,MI4,MI5
 S (i,ii)=""  i '$g(noSay) w !,"выбираем MAC программы по маске :"_MA
 F  S i=$O(^rMAC(i)) Q:i=""  i $$MASK^%ZAPM.bs.BSC4r4(i,MA) s LIST(i_".MAC")=""  i '$g(noSay) w !,"MAC: "_i
 i $d(LIST(".MAC")) k LIST(".MAC")
 q
addRou(MA) //Создание дистрибутива комплекса АСУРП 
 n i,ii,rc,MI,MI2,MI3,MI4,MI5
 S (i,ii)=""  i '$g(noSay) w !,"выбираем INT программы по маске :"_MA
 F  S i=$O(^ROUTINE(i)) Q:i=""  i $$MASK^%ZAPM.bs.BSC4r4(i,MA) s LIST(i_".INT")="" 
 i $d(LIST(".INT")) k LIST(".INT")
 q
addGlo(MA)
 N t,NS,i,ii,rc,MI,MI2,MI3,MI4,MI5
 S NS=$ZU(5),t="^||mtempmBSdirGlob"
 D GetGlobalDir^%ZAPM.bs.BSCp(NS,t) 
 i '$g(noSay) w !,"выбираем глобали по маске :"_MA
 S i="" F ii=1:1 S i=$O(@t@(i)) Q:i=""  I $$MASK^%ZAPM.bs.BSC4r4(i,MA) s LIST(i_".GBL")="" 
 K @t
 q
AddMenu(a)  i '$g(noSay) w !,"выбираем меню ИП по маске :"_a
 n i
 s (a,i)=$p(a,$c(34),2) f  s i=$o(@g@(i)) q:i=""  i i[a  w !,i m @g1@(i)=@g@(i)
 s LIST(g1_".GBL")=""
 q
 //$$GetF^%ZAPM.bs.BSCtree("Security.Applications","ID","/csp/ndoc","Path","%SYS") = реальный путь
addCSP(dir)  i '$g(noSay) w !,"выбираем файлы по маске :"_dir
 n rs,dir1,file
 s dir=$zconvert($tr(dir,"\","/"),"L")
 i dir'["+",dir'["*" s LIST(dir)="" q  //явный путь
 i $e(dir)="+" s dir=$p($p(dir,"+",2,9),"*")
 s dir1=dir
 i $e(dir)'="/" s dir="/"_dir
 s dir2=$$GetF^%ZAPM.bs.BSCtree("Security.Applications","ID",dir,"Path","%SYS")
 ;w !,"---",7,dir2,7
 i "?."[dir2 s dir3=$p(dir,"/",$l(dir,"/")),dir2=$$GetF^%ZAPM.bs.BSCtree("Security.Applications","ID",$p(dir,"/",1,$l(dir,"/")-1),"Path","%SYS") d
 .;w !,"=====",$p(dir,"/",1,$l(dir,"/")-1)
 .i "?."'[dir2 s dir2=dir2_"/"_dir3 q
 .i "?."[dir2 s dir2=$$CacheSysDir^%ZAPM.bs.BSCp(dir)
 ;w !!!,1,dir2,1
 N i,in,U1,MAS,m,FN,FN1
 S MAS="m" K @MAS D FileListDir^%ZAPM.bs.BSCEXE(dir2,MAS,2,"")
 S U1="" F i=1:1 S U1=$O(@MAS@(U1)) Q:U1=""  D
 .S FN=$P(@MAS@(U1),"?",1)
 .s file=$ZCONVERT($tr(FN,"/","\"),"L")
 .w !,file
 .s LIST(dir1_$tr($p(file,$tr(dir1,"/","\"),2),"\","/"))=""
 q
addCls(MA) n ClassName,res i '$g(noSay)  w !,"выбираем классы по маске :"_MA
 N t,NS,i,ii,rc,MI,MI2,MI3,MI4,MI5
 s res=##class(%ResultSet).%New("%ClassDefinition.ClassInfo")
 i 'res w:$zu(67,10,$j)=1 !,"Can not open res" q
 d res.Execute()
 f  q:'res.Next()  d
 . s ClassName=res.GetData(1)
 . I $$MASK^%ZAPM.bs.BSC4r4(ClassName,MA) s LIST(ClassName_".CLS")="" i $g(^%ZAPM.bs.BS("Debug")) d DescOut2File(ClassName,"d:\_snap\")
 k res ;d res.%Close() 
 q
BuildMS(name,dir) //сборка по АРМу на основе конфигурационного файла MS, кладем в dir
 n i,ns,ons,LIST,err,g,g1
 i $g(name)="" q
 i '$g(noSay) w !,"======================== Сборка :"_name
 i $g(MS(name,"active"))=0  i '$g(noSay) w " билд не активен" q
 s ons=$zu(5),ns=$$%^%ZAPM.bs.BSCh($g(MS(name,"namespace")))
 i ns'="",ons'=ns zn ns
 i $e(dir,$l(dir))'="\" s dir=dir_"\"
 s g="^[""prg""]MSM.ASURP.MatrAcc",g1=g_"Tempo" k @g1
 s i="" f  s i=$o(MS(name,i)) q:i=""  d 
 .i $e(i,1,4)="menu" d AddMenu(MS(name,i)) q
 .i $e(i,1,3)="INT" d addRou(MS(name,i)) q
 .i $e(i,1,3)="GBL" d addGlo(MS(name,i)) q
 .i $e(i,1,3)="CLS" d addCls(MS(name,i)) q
 .i $e(i,1,3)="CSP" d addCSP(MS(name,i)) q
 .i $e(i,1,3)="MAC" d addRouMac(MS(name,i)) q
 i '$d(LIST) g BuildMS2
 ;;s LIST("d:\scool2007\!_Упражнения\UNITTE~1.DOC")=""
 n fn,%datetime,%date,%section,%namespace,a
 s %datetime=$zd($h,3)_"("_$tr($p($ZDATETIME($ZUTIL(188),1,1,2)," ",2),":.","'-")_")"
 s %date=$zd($h,3)
 s %namespace=$g(MS(name,"namespace")),%section=name
 s a=$g(MS(name,"sfilename")) i a="" s a="%section"
 e  i a'[$c(34) s a=$c(34)_a_$c(34)
 x "s a="_a
  s fn=dir_a_".xml" 
 do $system.OBJ.Export(.LIST,fn,"d",.err)
 w !!,"Выведено в файл :"_fn,!!
 w ! zw err
BuildMS2 zn ons
 k @g1
 q
LoadXML(BSfile) //загрузка из сборки
 n fn,g,g1,I,STOP,ERR,i,menu
 s fn=$$b64d^%ZAPM.bs.BSCp2(BSfile)
 //нужен ini файл для команд перед восстановлением....но пока так.//////////////////////////////////
LoadXMLint s g="^[""prg""]MSM.ASURP.MatrAcc",g1=g_"Tempo",g2=g_"Back" k @g1
 m @g2=@g  //сделаем запасную копию 
 w "Загрузка из сборки :",fn
 s name=$p(fn,"\",$l(fn,"\")),ns=$$%^%ZAPM.bs.BSCh($p(name,"_",2)) i ns'="" zn ns
 w !,"В рабочей области :"_$zu(5) 
 i '$d(auto) r !!,"Вы уверены? [YyнН/N] <N>",r q:r=""  q:"YyнН"'[r
 
 do $system.OBJ.Load(fn,"ck",.ERR) 
 S I="" F  S I=$O(ERR(I)) Q:I=""  D  ;Q:$G(STOP)
 .I ERR(I,"code")'=5475 S STOP=I Q
 .I ERR(I,"param",1)["%BSC" S STOP=I Q
 w !!,"Восстанавливаем меню ИП..."
 s i="" f  s i=$o(@g1@(i)) q:i=""  w !,i s menu=$p(i,":") i menu'="" s menu(menu)=""
 s i=""  f  s i=$o(@g@(i)) q:i=""  i $p(i,":")'="",$d(menu($p(i,":"))) k @g@(i) w !,"удалили : "_i
 m @g=@g1  
 i '$d(auto) D ANY^%ZAPM.bs.BSC4r4
 q 
LoadAllXml(sec,dirfile) n auto s auto=1
 d INI^%ZAPM.bs.BSCindx(dirfile,.MS)
 S i1="" F  S i1=$O(MS(sec,i1)) Q:i1=""  i $e(i1,1,4)="File" s fn=MS(sec,i1) i fn'="" d
 . w !,"//////////////////////////////////////////////////////////////////////////",!
 .d LoadXMLint
 D ANY^%ZAPM.bs.BSC4r4
 q
 
]]></Routine>


<Routine name="%ZAPM.bs.BSC4rou" type="MAC" languagemode="0"><![CDATA[
%BSC4rou ;Программа создания программных модулей
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 q
MST  S @("^"_pin_".ROU")@(Rou,"MST")=newTP_","_Tab
 Q
UFD(pin,Rou,Tab) ;ПОКА ОТКЛЮЧЕНА - НЕ ОПРАВДАЛА СЕБЯ - НЕТ ИД СЕССИИ
 D MST S V=$$LNG^%ZAPM.bs.BSC4("Унифицированная форма занесения данных в таблицу")_" '"_Tab_"'"
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 S C="UFD1 ; "_$$say2_" "_BK
 S C=C_" S V1="""_pin_""",V2="""_Tab_""""_BK
 S C=C_" D $$$ROU(""%BSCm3"",""T"")"_BK
 S C=C_" quit"_BK
 S H="<HTML><BODY>"_$$VAR(1,"UFD1"),BSLABEL="UFD1" 
 S H=H_"<a href="_$$add_">"_V_"</a>"_BK
 S H=H_"</BODY></HTML>"_BK
 g Save
RunCode(pin,Rou,Tab) ; 
 D MST S V=$$LNG^%ZAPM.bs.BSC4("Выполнить программу",226)
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 S C="Variables1 ; "_$$say2_" "_$$hr_BK
 S C=C_" write ""<pre>"""_BK
 S C=C_" D $$$XECUTE(CACHECODE)"_BK
 S C=C_" write ""</pre>"""_BK
 S C=C_" quit"_BK
 S H="<HTML><BODY>"_$$VAR(1,"Variables1"),BSLABEL="Variables1" 
 S H=H_$$form("NameForm")        
 S H=H_"<textarea cols=70 rows=5 name='CACHECODE'> "_BK
 S H=H_" W ""<br>СЕГОДНЯ: "",$ZD($H,3)"_BK_" W ""<br>СЕЙЧАС: "",$ZT($P($H,"","",2),1) </textarea><br>"_BK
 S H=H_"<input type='submit' name='Run' title='"_$$LNG^%ZAPM.bs.BSC4("Выполнить программу",226)_"' value='RUN'>"_BBK
 S H=H_RED_$$LNG^%ZAPM.bs.BSC4("Не используйте макрос $$$XECUTE в цикле, так как при каждом его выполнении создается и компилирутся программа, а по окончании выполнения она удаляется.")_EF_BK
 S H=H_"</form></center></BODY></HTML>"_BK
 g Save
Populate(pin,Rou,Tab) I $G(Tab)="" G TabEmpty
 D MST S V=$$LNG^%ZAPM.bs.BSC4(" Создать тестовые записи для `",228)_Tab_"` "
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 S C="Populate1 ; "_$$say2_" "_$$hr_BK
 S C=C_" s Num=50 do Pop(Num)"_BK
 S C=C_" w !,"""_$$LNG^%ZAPM.bs.BSC4("Создание",229)_" ""_(Num-$G(Error))_"" "_$$LNG^%ZAPM.bs.BSC4("записей произведено",230)_""""_BK
 S C=C_"  d ShowRow(100) quit"_BK
 d InputForm1
 S C=C_" quit"_BK
 S C=C_"Pop(N) for i=1:1:N do  ;"_$$LNG^%ZAPM.bs.BSC4("создание N записей",231)_""_BK
 F I=1:1:K S C=C_"  .set "_$p(C1,",",I)_"=$$RandomField(10)"_BK  
 S C=C_"  .do NewRow if SQLCODE'=0 s Error=$G(Error)+1"_BK       
 S C=C_" quit"_BK
 S C=C_"RandomField(N) ;"_$$LNG^%ZAPM.bs.BSC4("создание строки из N случайных символов",232)_""_BK
 S C=C_" new st,str ;"_$$LNG^%ZAPM.bs.BSC4("делаем приватными переменные",233)_" st,str"_BK     
 S C=C_"  set str="""" ; "_$$LNG^%ZAPM.bs.BSC4("делаем начальное присвоение",234)_""_BK 
 S C=C_"  for st=1:1:N set str=str_$char($$CodeLetter)"_BK       
 S C=C_" quit str ;"_$$LNG^%ZAPM.bs.BSC4("возвратить строку",235)_""_BK
 S C=C_"CodeLetter() ;"_$$LNG^%ZAPM.bs.BSC4("функция возвращает код случайной буквы",236)_""_BK
 S C=C_" new с"_BK       
 S C=C_" for  set c=$R(255) if c>64&(c<123)!(c>191&(c<256)) q  "_BK      
 S C=C_" q c"_BK 
 d ShowRow S C=C_" quit"_BK
 ;-----------------------------------------
 S H=$$VAR(1,"Populate1"),BSLABEL="Populate1" 
 S H=H_"<a href="_$$add_">"_$$LNG^%ZAPM.bs.BSC4("Создать для таблицы 50 тестовых записей",237)_"</a>"_BK
 S H=H_"</center>"_BK
 g Save
DynamicSQL(pin,Rou,Tab)  I $G(Tab)="" G TabEmpty
 D MST S V=" "_$$LNG^%ZAPM.bs.BSC4("Динамические SQL запросы для `",238)_""_Tab_"` "
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 s C="DynSQL ; "_$$say2_V_BK_$$hr_BK
 S C=C_"DynSQL1 ; (вариант 1)"_$$hr_BK
 S C=C_" set Header="""_V_""" // "_$$LNG^%ZAPM.bs.BSC4("заголовок страницы",186)_""_BK  
 S C=C_" &html<"_BK
 S C=C_"<html><title>#(Header)#</title>"_BK
 S C=C_"<body><center><H4>#(Header)#</H4>"_BK
 D 
 .N BSRoutineId
 .S C=C_""_$$form("NameForm")
 S C=C_"<input type='hidden' name='BSLABEL' value='DynSQL2'>"_BK
 S C=C_">"_BK
 S C=C_" set Maxfeild=$$$CoutFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество полей",187)_""_BK
 
 S C=C_" G:$D(SQLstr1) L2  set var2="""" //"_$$LNG^%ZAPM.bs.BSC4("начальное пустое значение",239)_""_BK
 S C=C_" set SQLstr1=""INSERT INTO ""_$$$NameTable("""_BSPRO_""","""_Tab_""")_"" ("" //"_$$LNG^%ZAPM.bs.BSC4("присвоим начальное значение строки утверждения",240)_""_BK
 S C=C_" for Num=1:1:Maxfeild {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_""_BK
 S C=C_"    set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля в переменную",241)_""_BK
 S C=C_"    set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_""_BK
 S C=C_"    s SQLstr1=SQLstr1_NameFeild //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_""_BK
 S C=C_"    s var2=var2_""'ТЕСТОВОЕ ЗНАЧЕНИЕ'"" //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_""_BK
 S C=C_"     if Num'=Maxfeild s SQLstr1=SQLstr1_"", "",var2=var2_"", "" //"_$$LNG^%ZAPM.bs.BSC4("присвоить запятую если это не последнее поле",243)_""_BK
 S C=C_"  }"_BK
 S C=C_" s SQLstr1=SQLstr1_"") VALUES (""_var2_"")"" //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_""_BK
 S C=C_"L2 w ""<table border=0>"""_BK
 S C=C_" w ""<tr><td><input type='submit' name='INSERT' value='"_$$LNG^%ZAPM.bs.BSC4("Вставить",244)_"'></td><td><textarea cols=70 rows=5 name='SQLstr1'>"",SQLstr1,""</textarea></td></tr>"""_BK
 
 S C=C_" G:$D(SQLstr2) L3  set var2="""" //"_$$LNG^%ZAPM.bs.BSC4("начальное пустое значение",239)_""_BK
 S C=C_" set SQLstr2=""UPDATE ""_$$$NameTable("""_BSPRO_""","""_Tab_""")_"" SET "" //"_$$LNG^%ZAPM.bs.BSC4("присвоим начальное значение строки утверждения",240)_""_BK
 S C=C_" for Num=1:1:Maxfeild {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_""_BK
 S C=C_"    set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля в переменную",241)_""_BK
 S C=C_"    set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_""_BK
 S C=C_"     if Num=1 set var2=NameFeild //"_$$LNG^%ZAPM.bs.BSC4("запомнить первое поле",245)_""_BK
 S C=C_"    s:Num'=1 SQLstr2=SQLstr2_NameFeild_""='НОВОЕ ТЕСТОВОЕ ЗНАЧЕНИЕ'"" //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения, если это не 1 поле",246)_""_BK
 S C=C_"     if Num'=Maxfeild s:Num'=1 SQLstr2=SQLstr2_"", "" //"_$$LNG^%ZAPM.bs.BSC4("присвоить запятую если это не последнее поле",243)_""_BK
 S C=C_"  }"_BK
 S C=C_" s SQLstr2=SQLstr2_"" WHERE ""_var2_""='ТЕСТОВОЕ ЗНАЧЕНИЕ'"" //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_""_BK
 S C=C_"L3 write ""<tr><td><input type='submit' name='UPDATE' value='"_$$LNG^%ZAPM.bs.BSC4("Обновить",247)_"'></td><td><textarea cols=70 rows=5 name='SQLstr2'>""_SQLstr2_""</textarea></td></tr>""  "_BK
 
 S C=C_" G:$D(SQLstr3) L4  set var2="""" //"_$$LNG^%ZAPM.bs.BSC4("начальное пустое значение",239)_""_BK
 S C=C_" set SQLstr3=""DELETE FROM ""_$$$NameTable("""_BSPRO_""","""_Tab_""")_"" "" //"_$$LNG^%ZAPM.bs.BSC4("присвоим начальное значение строки утверждения",240)_""_BK
 S C=C_" for Num=1:1:Maxfeild {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"    set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля в переменную",241)_BK
 S C=C_"    set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     if Num=1 set var2=NameFeild //"_$$LNG^%ZAPM.bs.BSC4("запомнить первое поле",245)_BK
 S C=C_"  }"_BK
 S C=C_" s SQLstr3=SQLstr3_"" WHERE ""_var2_""='ТЕСТОВОЕ ЗНАЧЕНИЕ'"" "_BK
 S C=C_"L4 write ""<tr><td><input type='submit' name='DELETE' value='"_$$LNG^%ZAPM.bs.BSC4("Удалить",119)_"'></td><td><textarea cols=70 rows=5 name='SQLstr3'>""_SQLstr3_""</textarea></td></tr>""  "_BK
 
 S C=C_" G:$D(SQLstr4) L5  set SQLstr4=""SELECT "" //"_$$LNG^%ZAPM.bs.BSC4("присвоим начальное значение стоки утверждения",248)_BK
 S C=C_" for Num=1:1:Maxfeild {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"    set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля в переменную",241)_BK
 S C=C_"    set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     if Num=1 set var2=NameFeild //"_$$LNG^%ZAPM.bs.BSC4("запомнить первое поле",245)_BK
 S C=C_"    s SQLstr4=SQLstr4_NameFeild //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_BK
 S C=C_"     if Num'=Maxfeild s SQLstr4=SQLstr4_"", "" //"_$$LNG^%ZAPM.bs.BSC4("присвоить запятую если это не последнее поле",243)_BK
 S C=C_"  }"_BK
 S C=C_" s SQLstr4=SQLstr4_"" FROM ""_$$$NameTable("""_BSPRO_""","""_Tab_""")_"" WHERE ""_var2_"" LIKE '%ТЕСТОВОЕ ЗНАЧЕНИЕ%'"" //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_BK
 S C=C_"L5 write ""<tr><td><input type='submit' name='SELECT' value='"_$$LNG^%ZAPM.bs.BSC4("Выбрать",249)_"'></td><td><textarea cols=70 rows=5 name='SQLstr4'>""_SQLstr4_""</textarea></td></tr>""  "_BK
 S C=C_" &html<"_BK
 S C=C_"</table>"_BK
 S C=C_"<input type='hidden' name='BSRoutineId' value='#(BSRoutineId)#'>"_BK
 S C=C_"</center></form></body></html>"_BK
 S C=C_">"_BK
 
 S C=C_" quit"_BK
 S C=C_"DynSQL2 ; "_$$hr_BK
 S C=C_" if $D(SELECT) set SQLstat=SQLstr4"_BK
 S C=C_" if $D(INSERT) set SQLstat=SQLstr1"_BK
 S C=C_" if $D(UPDATE) set SQLstat=SQLstr2"_BK
 S C=C_" if $D(DELETE) set SQLstat=SQLstr3"_BK
 D DYNS
 S C=C_" GOTO DynSQL1"_BK
 ;-----------------------------------------
 s H="<!-- "_$$say1_" -->"_BK
 S H=H_$$VAR(1,"DynSQL1"),BSLABEL="DynSQL1"
 S H=H_"<a href="_$$add_">"_$$LNG^%ZAPM.bs.BSC4("Вызвать сгенеренные на сервере формы Динамических SQL запросов",250)_"</a>"_BK
 S H=H_"</center>"_BK
 s H=H_$$end
 g Save
DYNS ;ТЕЛО ПРОГРАММЫ
 S C=C_" write ""<center>"" s result=$$$DynSQLprep(SQLstat,.hhh) //hhh - "_$$LNG^%ZAPM.bs.BSC4("ссылка на объект - результат запроса",251)_BK
 S C=C_" if +result=1 write """_GREEN_"SQL "_$$LNG^%ZAPM.bs.BSC4("утверждение выполнилось удачно",252)_"."_EF_""",! "_BK
 S C=C_" else  write """_RED_$$LNG^%ZAPM.bs.BSC4("Ошибка выполнения SQL утверждения",253)_" : "_EF_"""_$$$MsgSQLError(result) goto DynSQL2end"_BK
 S C=C_" w ""<table border=1>"" new allcol,row2 //"_$$LNG^%ZAPM.bs.BSC4("делаем приватной переменную",254)_" allcol и row2"_BK
 S C=C_" s x=$$$DynSQLColInfo(.COL,.hhh) // "_$$LNG^%ZAPM.bs.BSC4("получим информацию о колонках, она присвоится в переменную",255)_" COL"_BK
 S C=C_"  for  Q:$$$DynSQLfetch(.hhh,.row1,.STOP)=1  s row2=$G(row2)+1  D  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем записям результата выполнения утверждения",256)_BK
 S C=C_"  .if '$D(allcol) s allcol=$LISTLENGTH(row1) d  //"_$$LNG^%ZAPM.bs.BSC4("один раз вычисляется количество колонок в результате запроса",257)_BK
 S C=C_"  ..W ""<tr><td bgcolor=#E4E4E4>.</td>"""_BK
 S C=C_"  .. for col=1:1:allcol W ""<td bgcolor=#E4E4E4>"",$$$DynSQLcol(COL,col),""</td>""  //"_$$LNG^%ZAPM.bs.BSC4("цикл по колонкам",258)_BK
 S C=C_"  .W ""<tr><td bgcolor=#E4E4E4>"",row2,""</td>"""_BK
 S C=C_"  . for col=1:1:allcol do  //"_$$LNG^%ZAPM.bs.BSC4("цикл по колонкам",258)_BK
 S C=C_"  ..W ""<td>"",$$$DynSQLGetData(row1,col),""</td>"""_BK
 S C=C_"  .W ""</tr>"""_BK       
 S C=C_" w ""</table><BR>"""_BK
 S C=C_" if '$D(row2) w ""<br>"_$$LNG^%ZAPM.bs.BSC4("но нет ни одной записи удовлетворяющей предложенным условиям",259)_""""_BK
 S C=C_"DynSQL2end  w $$$DynSQLclose(.hhh)"_BK
 S C=C_"  write ""</center>"""_BK
 Q       
Find(pin,Rou,Tab)  I $G(Tab)="" G TabEmpty
 D MST S V=" Модуль поиска для `"_Tab_"` "
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 s C="Find ; "_$$say2_V_BK_$$hr_BK
 S C=C_"Find1 ; "_$$hr_BK
 S C=C_" set Header="""_V_""" // "_$$LNG^%ZAPM.bs.BSC4("заголовок страницы",186)_BK  
 S C=C_" &html<"_BK
 S C=C_"<html><title>#(Header)#</title>"_BK
 S C=C_"<body><center><H4>#(Header)#</H4>"_BK
 D 
 .N BSRoutineId
 .S C=C_""_$$form("NameForm")
 S C=C_"<input type='hidden' name='BSLABEL' value='Find2'>"_BK
 S C=C_"<table border=0>"_BK
 S C=C_">"_BK
 S C=C_" set Maxfeild=$$$CoutFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество полей",187)_BK
 S C=C_" set MaxIndxfeild=$$$CoutIndxFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество индексированных полей",188)_BK
 S C=C_" N Sel"_BK
 S C=C_" for Num=1:1:Maxfeild {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"     set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля",195)_BK
 S C=C_"     set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     set Description=$P(var1,""~"",2) //"_$$LNG^%ZAPM.bs.BSC4("вычленить описание поля",199)_BK
 S C=C_"     write ""<tr><td align='right'><strong>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести начало строки таблицы",260)_BK
 S C=C_"       if MaxIndxfeild'<Num write ""<FONT COLOR=RED>*</FONT>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести красную звездочку если поле индексированное",261)_BK
 S C=C_"     write Description,"" ("",NameFeild,"") <input type='checkbox' title='"_$$LNG^%ZAPM.bs.BSC4("поле учавствует в SQL запросе",262)_"' name='C""_Num_""' checked></strong></td>"""_BK
 S C=C_"     write ""<td> AS <input type='text' size=7 maxlength=48 title='"_$$LNG^%ZAPM.bs.BSC4("превдоним",263)_"' name='A""_Num_""' value=''>"""_BK
 S C=C_"     write ""</td></tr>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести окончание строки таблицы",264)_BK
 S C=C_"      if '$D(Sel) s Sel=""<option value='""_NameFeild_""' selected>""_NameFeild_""</option>"" //"_$$LNG^%ZAPM.bs.BSC4("подготовить опции для",265)_" SELECT"_BK
 S C=C_"      else  set Sel=Sel_""<option value='""_NameFeild_""'>""_NameFeild_""</option>"""_BK
 S C=C_"     }"_BK
 S C=C_" write ""<input type='hidden' name='BSRoutineId' value='""_BSRoutineId_""'>"""_BK
 S C=C_" &html<"_BK
 S C=C_"</table><hr>"_BK 
 S C=C_"<select name='FIELD1'>#(Sel)#</select><select name='OPER1'><option value='1' selected>равно</option><option value='2'>"_$$LNG^%ZAPM.bs.BSC4("начинается",266)_"</option><option value='3'>"_$$LNG^%ZAPM.bs.BSC4("включает",267)_"</option></select>"_BK
 S C=C_"<input type='text' size=7 maxlength=48 title='"_$$LNG^%ZAPM.bs.BSC4("строка",268)_"' name='STR1' value='123'><br><input type='submit' name='Find1' title='"_$$LNG^%ZAPM.bs.BSC4("искать",269)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Искать",270)_"'>"_BK
 S C=C_"<br><hr><FONT COLOR=RED>*</FONT> "_$$LNG^%ZAPM.bs.BSC4("обязательные (индексированные) показатели",271)_"</form>"_BK
 S C=C_"</center></body></html>"_BK
 S C=C_">"_BK
 S C=C_" quit  ;"_$$LNG^%ZAPM.bs.BSC4("внутри тела макроса &html можно применять выражения COS в скобках",272)_" #(...)#"_BK
 S C=C_"Find2 ; "_$$hr_BK
 S C=C_" &html<"_BK
 S C=C_"<html><title></title>"_BK
 S C=C_"<body><center><H4>SQL "_$$LNG^%ZAPM.bs.BSC4("утверждение",273)_"</H4>"_BK
 D 
 .N BSRoutineId
 .S C=C_""_$$form("NameForm")
 S C=C_">"_BK
 S C=C_" set Maxfeild=$$$CoutFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество полей",187)_BK
 S C=C_" s SQL=""SELECT "" "_BK
 S C=C_" for Num=1:1:Maxfeild if $$$DDATA(""C""_Num) D  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"    .set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля в переменную",241)_BK
 S C=C_"    .set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"    .s SQL=SQL_NameFeild if $$$DGET(""A""_Num)'="""" s SQL=SQL_"" AS ""_$$$DGET(""A""_Num) //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_BK
 S C=C_"    . if Num'=Maxfeild s SQL=SQL_"", "" //"_$$LNG^%ZAPM.bs.BSC4("присвоить запятую если это не последнее поле",243)_BK
 S C=C_" IF $G(OPER1)=1 S S1=""="",(S2,S3)="""" "_BK
 S C=C_" IF $G(OPER1)=2 S S1=""LIKE"",S2="""",S3=""%"" "_BK
 S C=C_" IF $G(OPER1)=3 S S1=""LIKE"",S2=""%"",S3=""%"" "_BK     
 S C=C_" s SQLstat=SQL_"" FROM ""_$$$NameTable("""_BSPRO_""","""_Tab_""")_"" WHERE ""_FIELD1_"" ""_S1_"" '""_S2_STR1_S3_""'"" //"_$$LNG^%ZAPM.bs.BSC4("присвоить имя поля к строке утверждения",242)_BK
 S C=C_" write ""<input type='hidden' name='BSRoutineId' value='""_BSRoutineId_""'>"""_BK
 S C=C_" write ""<textarea cols=70 rows=5 name='SQLstat'>""_SQLstat_""</textarea>"""_BK
 S C=C_" write ""<input type='submit' name='SELECT' value='"_$$LNG^%ZAPM.bs.BSC4("Выбрать",249)_"'>"""_BK
 S C=C_" W ""<input type='hidden' name='BSLABEL' value='Find3'>"""_BK
 S C=C_" W ""</form></center></body></html>"""_BK        
 S C=C_" quit  "_BK
 S C=C_"Find3 ; "_$$hr_BK
 D DYNS
 S C=C_" G Find1"_BK
 ;-----------------------------------------
 s H="<!-- "_$$say1_" -->"_BK
 S H=H_$$VAR(1,"Find1"),BSLABEL="Find1"
 S H=H_"<a href="_$$add_">"_$$LNG^%ZAPM.bs.BSC4("Вызвать поисковый модуль",274)_"</a>"_BK
 S H=H_"</center>"_BK
 s H=H_$$end
 g Save
Navigator(pin,Rou,Tab) I $G(Tab)="" G TabEmpty
 D MST S V=" "_$$LNG^%ZAPM.bs.BSC4("Навигатор прямого доступа к таблице `",275)_Tab_"` "
 S @("^"_pin_".ROU")@(Rou,"REM")=V
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 s C="Navigator ; "_$$say2_V_BK_$$hr_BK
 S C=C_" set Home1=1 "_BK     
 S C=C_"Navig1 ; "_$$hr_BK
 S C=C_" set Header="""_V_""" // "_$$LNG^%ZAPM.bs.BSC4("заголовок страницы",186)_BK  
 S C=C_" set Max=$$$CoutFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество полей",187)_BK
 S C=C_" set MaxI=$$$CoutIndxFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество индексированных полей",188)_BK
 S C=C_" D $$$DKILL(""Dis"") // "_$$LNG^%ZAPM.bs.BSC4("удалить массив признака опции",189)_" DISABLE"_BK
 S C=C_" D $$$DKILL(""STOP"") "_BK
 S C=C_" for Num=1:1:MaxI D  Q:$G(STOP)=1  G:$G(STOP)=2 Navigator  //"_$$LNG^%ZAPM.bs.BSC4("цикл по индексным полям",190)_BK
 S C=C_"    .D KKey(Num)  "_BK
 S C=C_"    .IF $$$DDATA(""Home""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",1)) D CheckL Q:$D(STOP)  "_BK
 S C=C_"    .IF $$$DDATA(""End""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",-1)) D CheckR "_BK
 S C=C_"    .IF $$$DDATA(""Del""_Num) D $$$DKILL(""Del""_Num) D $$$DSET(""Left""_Num,1) D $$$KillDirectTab("""_BSPRO_""","""_Tab_""",.Key) //"_$$LNG^%ZAPM.bs.BSC4("удалить узел ",191)_BK
 S C=C_"    .IF $$$DDATA(""Left""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),-1)) D CheckL Q:$D(STOP)  "_BK
 S C=C_"    .IF $$$DDATA(""Right""_Num) D $$$DSET(""Home""_(Num+1),1) D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),1)) D CheckR "_BK
 S C=C_"    .S Dis(Num,1)=($$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),-1)="""") "_BK
 S C=C_"    .S Dis(Num,2)=($$$ORDER("""_BSPRO_""","""_Tab_""",.Key,$$$DGET(""value""_Num),1)="""") "_BK
 S C=C_" &html<"_BK
 S C=C_"<html><title>#(Header)#</title>"_BK
 S C=C_"<body><center><H4>#(Header)#</H4>"_BK
 D 
 .N BSRoutineId
 .S C=C_""_$$form("NameForm")
 S C=C_"<input type='hidden' name='BSLABEL' value='Navig2'>"_BK
 S C=C_"<table border=0>"_BK
 S C=C_">"_BK
 S C=C_"   D $$$DSET(""Key(Key)"",$$$DGET(""value""_Num)) //"_$$LNG^%ZAPM.bs.BSC4("присвоить значение последнего индекса ",276)_BK
 S C=C_"    IF $D(Save) D  //присвоить исправления"_BK
 S C=C_"       .for Num=(MaxI+1):1:Max D  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем неиндексным полям",194)_BK
 S C=C_"       ..set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля",195)_BK
 S C=C_"       ..set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"       ..IF $$$SetDirectTab("""_BSPRO_""","""_Tab_""",.Key,NameFeild,$$$DGET(""value""_Num)) //"_$$LNG^%ZAPM.bs.BSC4("присвоим в прямом доступе",197)_BK
 S C=C_"   for Num=1:1:Max {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"     set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля",195)_BK
 S C=C_"     set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     set Description=$P(var1,""~"",2) //"_$$LNG^%ZAPM.bs.BSC4("вычленить описание поля",199)_BK
 S C=C_"     write ""<tr>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести описание",200)_BK
 S C=C_"     if $P(var1,""~"",4)'="""" D  //"_$$LNG^%ZAPM.bs.BSC4("эти поля индексные",201)_BK
 S C=C_"       .W ""<td align='right'><input type='submit' name='Del""_Num_""' title='"_$$LNG^%ZAPM.bs.BSC4("удалить узел",202)_" ""_$SELECT(Num=MaxI:"""",1:""со всеми потомками высших уровней"")_""' value='Удалить'>&nbsp;<input type='submit' ""_$$Disable(Num,1)_"" name='Home""_Num_""' value='&lt;&lt;'><input type='submit' name='Left""_Num_""' ""_$$Disable(Num,1)_"" value='&lt;'></td>"""_BK
 S C=C_"     if Num=(MaxI+1) w ""<tr><td><hr></td><td><hr></td><td></td><td><hr></td></tr><td align='right'><input type='submit' name='Save' value='Coхранить'></td>"" "_BK
 S C=C_"     if Num=(MaxI+2) w ""<td align='right'><input type='Reset' name='Reset' value='"_$$LNG^%ZAPM.bs.BSC4("Отменить",204)_"'></td>"" "_BK
 S C=C_"     if Num>(MaxI+2) w ""<td></td>"""_BK
 S C=C_"     if $P(var1,""~"",4)="""" D  //"_$$LNG^%ZAPM.bs.BSC4("эти поля неиндексные",205)_BK
 S C=C_"       .D $$$DSET(""value""_Num,$$$GetDirectTab("""_BSPRO_""","""_Tab_""",.Key,NameFeild)) //"_$$LNG^%ZAPM.bs.BSC4("прямой доступ к данным таблицы, когда знаешь индексы",206)_BK
 S C=C_"     if $P(var1,""~"",3)'=1 write ""<td><input type='text' size=40 maxlength=2048 title='""_NameFeild_""' name='value""_Num_""' value='""_$$$DGET(""value""_Num)_""'></td>"""_BK
 S C=C_"     if $P(var1,""~"",3)=1 write ""<td><textarea cols=40 rows=5 title='""_NameFeild_""' name='value""_Num_""' >""_$$$DGET(""value""_Num)_""</textarea></td>"""_BK
 S C=C_"     S var2=""<td align='left'>"" "_BK
 S C=C_"     if $P(var1,""~"",4)'="""" D  //"_$$LNG^%ZAPM.bs.BSC4("эти поля индексные",201)_BK
 S C=C_"       .S var2=var2_""<input type='submit' name='Right""_Num_""' ""_$$Disable(Num,2)_"" value='&gt;'><input type='submit' ""_$$Disable(Num,2)_"" name='End""_Num_""' value='&gt;&gt;'>"" "_BK
 S C=C_"     write var2_""</td>"" "_BK
 S C=C_"     write $$Desc("" (""_NameFeild_"") ""_Description)_""</tr>"" "_BK
 S C=C_"     }"_BK
 S C=C_" write ""<input type='hidden' name='BSRoutineId' value='""_BSRoutineId_""'>"""_BK
 S C=C_" &html<"_BK
 S C=C_"</table></form></center>"_BK
 S C=C_"</body></html>"_BK
 S C=C_">"_BK
 S C=C_" ;D $$$DoRou("""_BSPRO_""",""NewRoutin3"",""Variables1"") Q  "_BK
 S C=C_" quit"_BK
 S C=C_"Desc(D) Q ""<td align='lift'><strong>""_D_""</strong></td>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести описание",200)_BK
 S C=C_"CheckL //"_$$LNG^%ZAPM.bs.BSC4("проверить значение ключей",211)_BK
 S C=C_" if $$$DGET(""value""_Num)="""" D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",1)) d  "_BK
 S C=C_" .if $$$DGET(""value""_Num)="""" D  "_BK
 S C=C_" ..I Num=1 S STOP=1 Q  "_BK
 S C=C_" ..E  S Num=Num-1 S STOP=2"_BK
 S C=C_" quit"_BK
 S C=C_"CheckR //"_$$LNG^%ZAPM.bs.BSC4("проверить значение ключей",211)_BK
 S C=C_" if $$$DGET(""value""_Num)="""" D $$$DSET(""value""_Num,$$$ORDER("""_BSPRO_""","""_Tab_""",.Key,"""",-1)) d  "_BK
 S C=C_" .if $$$DGET(""value""_Num)="""" D  "_BK
 S C=C_" ..I Num=1 S STOP=1 Q  "_BK
 S C=C_" ..E  S Num=Num-1 S STOP=2"_BK
 S C=C_" quit"_BK
 S C=C_"Disable(N,A) Q $S($G(Dis(N,A)):""DISABLED"",1:"""") //"_$$LNG^%ZAPM.bs.BSC4("выставить опцию",212)_BK        
 S C=C_"KKey(k) //"_$$LNG^%ZAPM.bs.BSC4("подготовить массив данных узлов",213)_BK    
 S C=C_" D $$$DKILL(""Key"") //"_$$LNG^%ZAPM.bs.BSC4("Удалить массив",214)_BK
 S C=C_" n i f i=1:1:k s Key(i)=$$$DGET(""value""_i)"_BK 
 S C=C_" s Key=k Q"_BK   
 S C=C_"Navig2 ; "_$$hr_BK
 S C=C_" G Navig1"_BK    
 ;-----------------------------------------
 s H="<!-- "_$$say1_" -->"_BK
 S H=H_$$VAR(1,"Navigator"),BSLABEL="Navigator"
 S H=H_"<a href="_$$add_">"_$$LNG^%ZAPM.bs.BSC4("Загрузить навигатор прямого доступа",277)_"</a>"_BK
 S H=H_"</center>"_BK
 s H=H_$$end
 g Save
ShowRow S C=C_"ShowRow(MaxNum)  &sql(DECLARE ActiveRow CURSOR FOR SELECT "_C1_" INTO "_C2_" FROM "_TN_")"_BK
 S C=C_"  &sql(OPEN ActiveRow)"_BK
 S C=C_" W $$$Meta(1251)"_BK
 S C=C_"  write ""<center><br><table border=1><tr><td>"_$$LNG^%ZAPM.bs.BSC4("Имена полей",278)_"</td>"",!"_BK
 F I=1:1:K S C=C_"  write ""<td bgcolor=#B4B4B4>"_$$RedStar^%ZAPM.bs.BSC4rou(I'>INDX)_$p(C1,",",I)_"</td>"""_BK
 S C=C_"  write ""</tr>"",! set Num=0"_BK        
 S C=C_"  for   &sql(FETCH ActiveRow) q:SQLCODE'=0  q:MaxNum=Num  do  ;"_$$LNG^%ZAPM.bs.BSC4("цикл по выбранным записям",279)_BK
 S C=C_"  .write ""<tr>"",!"_BK
 S C=C_"  .set Num=Num+1   write ""<td bgcolor=#E4E4E4> "_$$LNG^%ZAPM.bs.BSC4("Запись",280)_" "",Num,""</td>"""_BK
 F I=1:1:K S C=C_"  .write ""<td>"",$G("_$p(C1,",",I)_"),""</td>"""_BK
 S C=C_"  .write ""</tr>"",!"_BK
 S C=C_"  &sql(CLOSE ActiveRow)"_BK
 S C=C_"  write ""</table><br></center>"",!"_BK  
 q
InputForm1 S TN=$TR(pin,".","_")_"."_Tab
 S C=C_"NewRow &sql( INSERT INTO "_TN_" ("
 s K=$$GetField("","","Count")   ;РАЗБОР ПОЛЕЙ ТАБЛИЦЫ
 S (I1,I2,C1,C2)="" F Y=1:1:K S TA=$$GetField("","",Y) D  ;NAME ~ DESCRIPTION ~ TYPE ~ INDEX
 .S C1=C1_$p(TA,"~",1),C2=C2_":"_$p(TA,"~",1) D  I Y'=K S C1=C1_",",C2=C2_"," ;ВСЕ ПОЛЯ
 .I $p(TA,"~",4) S INDX=Y,I1=I1_$p(TA,"~",1)_"=:"_$p(TA,"~",1)_" and "  ;ИНДЕКСНЫЕ ПОЛЯ
 .S I2=I2_$p(TA,"~",1)_"=:"_$p(TA,"~",1)_","
 S I1=$E(I1,1,$L(I1)-5),I2=$E(I2,1,$L(I2)-1)
 S C=C_C1_") VALUES ("_C2_") )"_BK
 q
InputForm(pin,Rou,Tab) I $G(Tab)="" G TabEmpty
 D MST 
 n BSSES,BSLOGIN,BSLABEL,BSG,BSGRANT,BSTOP
 S BSG="B4",BSRoutineId="????????"
 n C,H,T1,T2,I,TA,RT,PT,TAB,K,KI,Y,TN,GetField
 s I=$$LNG^%ZAPM.bs.BSC4("Форма ввода для",281)_" `"_Tab_"`"
 S @("^"_pin_".ROU")@(Rou,"REM")=I
 s C="InputForm ; "_$$say2_" ("_I_")"_BK_$$hr_BK                          ;_" #include %BSC4inc"_BK   
 S C=C_"Label1 ; ("_$$LNG^%ZAPM.bs.BSC4("вариант",282)_" 1)"_$$hr_BK
 S C=C_" do Update:$d(Upd),NewRow:$d(New),Delete:$d(Del) //"_$$LNG^%ZAPM.bs.BSC4("диспетчер",283)_BK
 S C=C_" do ShowRow($GET(CountRows,10)) // "_$$LNG^%ZAPM.bs.BSC4("ограничим вывод списка 10 записями, если неопределена переменная",284)_" CountRows"_BK        
 S C=C_" quit"_BK
 d InputForm1
 S C=C_" goto Final"_BK  
 S C=C_"Update &sql(UPDATE "_TN_" SET "_I2_" WHERE "_I1_")"_BK
 S C=C_" goto Final"_BK
 
 S C=C_"Delete &sql(DELETE FROM "_TN_" WHERE "_I1_")"_BK
 S C=C_" goto Final"_BK
 
 S C=C_"Final write ""<center>"" if '$Data(SQLCODE) quit  "_BK
 S C=C_" if SQLCODE=0 write """_GREEN_"SQL "_$$LNG^%ZAPM.bs.BSC4("утверждение выполнилось удачно",252)_"."_EF_""",! "_BK
 S C=C_" else  write """_RED_""_$$LNG^%ZAPM.bs.BSC4("Ошибка выполнения SQL утверждения",253)_" : "_EF_""",$$$ASqlError("""_BSDOMAIN_""","""_$$LNG^%ZAPM.bs.BSC4("смотреть код ошибки",285)_"""),SQLCODE,$$$A"_BK
 ;S C=C_" if SQLCODE=-119 write "" "_$$LNG^%ZAPM.bs.BSC4("Такая Запись уже есть",286)_" !"",! "_BK
 S C=C_"  write ""</center>"""_BK        
 S C=C_" quit"_BK
 
 d ShowRow ;SQL
 S C=C_" goto Label2"_BK
 
 S C=C_"Label2 ; (вариант 2)"_$$hr_BK
 S C=C_"     set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",1) //"_$$LNG^%ZAPM.bs.BSC4("взять атрибуты первого поля",287)_BK
 S C=C_"     set NameFeild=$P(var1,""~"",1) // "_$$LNG^%ZAPM.bs.BSC4("взять имя первого поля",288)_BK
 S C=C_"     set Header=""Форма ввода для `"_Tab_"`"" // "_$$LNG^%ZAPM.bs.BSC4("заголовок страницы",186)_BK  
 S C=C_" write ""<html><title>"",Header,""`</title>"""_BK
 //S C=C_" write ""<body onload='NameForm1.""_NameFeild_"".focus();'>"""_BK //ДАВАЛА ОШИБКУ
 S C=C_" write ""<body >"""_BK
 S C=C_" write ""<center><H3>"",Header,""</H3>"""_BK
 S C=C_" &html<"_BK      
 D 
 .N BSRoutineId
 .S C=C_""_$$form("NameForm")
 S C=C_"<input type='hidden' name='BSLABEL' value='Label1'>"_BK
 S C=C_"<table border=0>"_BK
 S C=C_">"_BK
 S C=C_" set Maxfeild=$$$CoutFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество полей",187)_BK
 S C=C_" set MaxIndxfeild=$$$CoutIndxFeild("""_BSPRO_""","""_Tab_""") //"_$$LNG^%ZAPM.bs.BSC4("количество индексированных полей",188)_BK
 S C=C_" for Num=1:1:Maxfeild {  //"_$$LNG^%ZAPM.bs.BSC4("цикл по всем полям",198)_BK
 S C=C_"     set var1=$$$GetFeild("""_BSPRO_""","""_Tab_""",Num) //"_$$LNG^%ZAPM.bs.BSC4("взять все атрибуты текущего поля",195)_BK
 S C=C_"     set NameFeild=$P(var1,""~"",1) //"_$$LNG^%ZAPM.bs.BSC4("вычленить имя поля",196)_BK
 S C=C_"     set Description=$P(var1,""~"",2) //"_$$LNG^%ZAPM.bs.BSC4("вычленить описание поля",199)_BK
 S C=C_"     write ""<tr><td align='right'><strong>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести начало строки таблицы",260)_BK
 S C=C_"       if MaxIndxfeild'<Num write ""<FONT COLOR=RED>*</FONT>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести красную звездочку если поле индексированное",261)_BK
 S C=C_"     write Description,""</strong></td>"""_BK
 S C=C_"     if $P(var1,""~"",3)=1 write ""<td><textarea cols=40 rows=5 title='""_NameFeild_""' name='""_NameFeild_""' ></textarea>"""_BK
 S C=C_"     if $P(var1,""~"",3)'=1 write ""<td><input type='text' size=40 maxlength=2048 title='""_NameFeild_""' name='""_NameFeild_""' value=''>"""_BK
 S C=C_"     write ""</td></tr>"" //"_$$LNG^%ZAPM.bs.BSC4("вывести окончание строки таблицы",264)_BK
 S C=C_"     }"_BK
 S C=C_" write ""<input type='hidden' name='BSRoutineId' value='""_BSRoutineId_""'>"""_BK
 S C=C_" &html<"_BK
 S C=C_"</table><BR>"_BK 
 S C=C_"<input type='text' size=3 maxlength=3 title='"_$$LNG^%ZAPM.bs.BSC4("количество записей",289)_"' name='CountRows' value='#($g(CountRows,15))#'>"_BK      
 S C=C_"<input type='submit' name='Show' title='смотреть первые записи' value='смотреть записи'>"_BK
 S C=C_"<input type='submit' name='New' title='"_$$LNG^%ZAPM.bs.BSC4("создать новую запись",292)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Новая запись",293)_"'>"_BK
 S C=C_"<input type='submit' name='Upd' title='"_$$LNG^%ZAPM.bs.BSC4("модифицировать существующую запись",294)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Обновить запись",295)_"'>"_BK
 S C=C_"<input type='submit' name='Del' title='"_$$LNG^%ZAPM.bs.BSC4("удалить существующую запись",296)_"' value='"_$$LNG^%ZAPM.bs.BSC4("Удалить запись",297)_"'>"_BK
 S C=C_"<input type='reset' title='"_$$LNG^%ZAPM.bs.BSC4("Отменить текущие изменения",112)_"' name='Reset1' value='"_$$LNG^%ZAPM.bs.BSC4("Отменить",204)_"'>"_BK
 S C=C_"<br><FONT COLOR=RED>*</FONT> "_$$LNG^%ZAPM.bs.BSC4("обязательные (индексированные) показатели",271)_"</form></center>"_BK
 S C=C_"</center></body></html>"_BK
 S C=C_">"_BK
 S C=C_" quit   ;"_$$LNG^%ZAPM.bs.BSC4("внутри тела макроса &html можно применять выражения COS в скобках",272)_" #(...)#"_BK
 ;-----------------------------------------
 ;S BSLABEL="NewRow"
 s H="<!-- "_$$say1_" -->"_BK
 S H=H_$$VAR(1,"Label2"),BSLABEL="Label2"
 S H=H_"<a href="_$$add_">"_$$LNG^%ZAPM.bs.BSC4("Вызвать динамически сгенеренную на сервере форму ввода. Отрабатывают их статические SQL запросы",298)_"</a>"_BK
 S H=H_"</center>"_BK
 s H=H_$$end
Save S @("^"_pin_".ROU")@(Rou,"HTM")=H ;$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(H,"<","&lt;"),">","&gt;")
 S @("^"_pin_".ROU")@(Rou,"COS")=C ;$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(C,"<","&lt;"),">","&gt;")
 q
add() q $$ADDBSGET^%ZAPM.bs.BSC4("")   ;$P($G(HTTPREF),$G(MGWLIB),1)_$$ADDBSGET^%ZAPM.bs.BSC4("")
RedStar(a) i a q RED_"*"_EF
 q ""
TabEmpty W RED,$$LNG^%ZAPM.bs.BSC4("Вы не определили таблицу",299),EF Q
TypeBeg(t) q "<input type=""text"" size=27 maxlength=2048"
TypeEnd(t) q ""
NameTable(P,T) ;имя таблицы для SQL
 q $P($P(%ZName,"."),"^",2)_"_"_P_"."_T
GetField(P,T,A,BSFLAG) ;Информация по полям таблицы // Современем сделать по объектам
 N PT,a
 S a=$NA(@("GetField")@("1"_P,"2"_T))
 I $D(BSFLAG) G GetField1
 I P="" S P="^"_pin
 I P'["." D
 .I $D(pi) S P="^"_pi_"."_P Q
 .S P="^"_$P($P(%ZName,"."),"^",2)_"."_P Q
 I T="" S T=Tab
GetField1 S PT=$NA(@P@(T)) I '$$Data^%ZAPM.bs.BSF12(PT) Q "!NoTable="_PT
 N K,KI,TA,Y,I
 I '$D(@a) D GetMass 
 I A="Count" Q +$G(@a)
 I A="Index" Q $P($G(@a),",",2)
 I A?.N Q $G(@a@(A),"?")
 F I=1:1:+$G(@a) I $P($G(@a@(I),"?"),"~")=A Q
 q $G(@a@(I),"?")
GetMass          //ОСОБАЯ МОДЕЛЬ BS- БАЗ ДАННЫХ
 N X
 S K=0,KI=0   //...ИМЯ ПОЛЯ~ОПИСАНИЕ~ТИП ДАННЫХ~№ИНДЕКСА~YxX-НОМЕРА СТРОКxКОЛОНОК
 F Y=1:1 Q:'$D(@PT@("KEY",Y))  S K=K+1,TA=@PT@("KEY",Y),KI=K,@a@(K)=$P(TA,"@",22)_"~"_$P(TA,"@",17)_"~"_$P(TA,"@",21)_"~"_Y D
 .I $P(TA,"@",17)="" S $P(@a@(K),"~",2)=$P(TA,"@",9)
 .I $P(@a@(K),"~",1)="" S $P(@a@(K),"~",1)="KEY"_Y 
 .S $P(@a@(K),"~",5)=Y
 F Y=2:1 Q:'$D(@PT@(Y))  F X=1:1 Q:'$D(@PT@(Y,X))  I $P(@PT@(Y,X),"@",9)=2 S TA=@PT@(Y,X) S K=K+1 D 
 .S @a@(K)=$P($P(TA,"@",18),"#")_"~"_$P(TA,"@",17)_"~"_$P(TA,"@",21)
 .I $P(TA,"@",17)="" S $P(@a@(K),"~",2)=$P($P(TA,"@",18),"#")
 .S $P(@a@(K),"~",5)=Y_"x"_X
 S @a=K_","_KI
 Q
1 W BK,pin,BK
 W Rou,BK
 W Tab,BK Q
t1 q "&lt;"      
t2 q "&gt;"
VAR(N,L) Q "<hr><center><H2>"_$$say1_" ("_$$LNG^%ZAPM.bs.BSC4("вариант",282)_" "_N_")</H2> "_BK_$$cmt(L)_BK
cmt(L) Q AF_" "_$$LNG^%ZAPM.bs.BSC4("Этот HTML-код вызывает выполнение программного модуля Cache' с метки :",300)_L_" "_EF_"<br>"
say1() q $$LNG^%ZAPM.bs.BSC4("Пример HTML кода :",301)
say2() q $$LNG^%ZAPM.bs.BSC4("Пример CacheObjectScript кода :",302)
form(Tab) q "<form name='"_Tab_"1'  method='POST' action='#("_$$cgievar_")#' >"_BK_$$ADDBSPOST0^%ZAPM.bs.BSC4reg()_BK
beg(tit,first) q "<html><title>"_tit_"</title><body onload='"_Tab_"1."_first_".focus();'>"
end() q "</body></html>"
hr() q " ;"_$tr($j("",60)," ","=")
cgievar() q "$$ADDLIB^%ZAPM.bs.BSC4()" ; $p($g(%CGIEVAR("HTTP_REFERER")),"?")
]]></Routine>


<Routine name="%ZAPM.bs.BSC4rout" type="MAC" languagemode="0"><![CDATA[
%BSC4rout ; пpогpамма управления программами ; 11:12   12.09.2002
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 w "пpогpамма управления программами"
 Q
snrip() q "<BR>Имя сервера и порт :"_RED_$g(%CGIEVAR("SERVER_NAME"))_EF_"<br>IP адрес клиента :"_GREEN_$g(%CGIEVAR("REMOTE_ADDR"))_EF
snW() Q "Имя сервера ОС: <font color=red title='"_$$ipS^%ZAPM.bs.BSCp2_"'>"_$ZU(110)_EF
wnW() q "Веб сервер: "_RED_$G(%CGIEVAR("SERVER_SOFTWARE"))_EF
InfoSess //ИНФОРМАЦИЯ О СЕССИИ
 D BSdebug^%ZAPM.bs.BSC4
 I '$G(BSdebug) Q 
InfoSess3 I '$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"WebInfoSess") W $$snW_"<BR>"_$$wnW_$$snrip Q 
 W "<HR>"_AF
 I $G(BSdebug) W "Версия СУБД :<A TARGET='_new' TITLE='Лицензия' "_$s($G(BSSES)="":"",1:"HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"InfoKEY^~BSC4rout")_"'")_">"_$zv_"</A><BR>" W "Имя сервера :<font color=MAROON title='"_$$ipS^%ZAPM.bs.BSCp2_"'><A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"IPA^~BSvdaSTAT")_"' TARGET='NEWIP'>"_$ZU(110)_"</A>"_EF
 E  W $$snW
 W " "_$$SysVer^%ZAPM.bs.BSCEXE
 I $G(BSdebug) W "<BR>"_$$wnW_BBK W "Веб клиент :"_MAROON_$G(NAVIG)_EF_$$snrip
 Q:$G(NoDetal)  Q:'$G(BSdebug) 
 W "<BR>Версия %BS :",RED,$$ver^%ZAPM.bs.BSC_EF_" Текущая конфигурация :"_RED_$$CFG^%ZAPM.bs.BSCp_EF_BBK
 W " ID процесса :",RED,$J,EF,", Сервис :",RED,$G(%KEY("MGWLPN"),"no weblink"),EF
  I '$G(%KEY("BSONLY")) W ", Рабочая область :",BLUE,$$ZU^%ZAPM.bs.BS3(0),EF,"<br> <font TITLE='Доступный размер раздела (байт)'>Доступный размер раздела (байт) :",MAROON,$S,EF,"</font><br> Текущее устройство вывода :",BLUE,$I,EF_BBK
 i $d(BSLOGIN) D
 .W "Имя пользователя :"_RED_$G(BSLOGIN,"?")_EF //_" Sessions id: "_RED_$$InfoSession($G(BSSES,"?"))_EF 
 .I $G(BSdebug) S CRLF=$C(13,10) d
 ..D ErrHEAD^%ZAPM.bs.BSCh0 D LOCLIST^%ZAPM.bs.BSCh0(1) 
 .;
 .;ЗАПУСТИТЬ ПОЛНЫЙ ТЕРМИНАЛ ЧЕРЕЗ RunDos.OCX
 .;S HREF=$$ADDBSGET^%ZAPM.bs.BSC4(,"InfoTerm^~BSC4rout"),TA="target=new"
 .;w " - <A HREF='"_HREF_"' "_TA_" TITLE='Загрузить терминал'>Terminal</A>"
 .;
 .;I $$PORT^%ZAPM.bs.BSpgTEL D  //Загрузить TCP-сокет
 .;.S HREF=$$ADDBSGET^%ZAPM.bs.BSC4(,"InfoTCP^~BSC4rout"),TA="target=new"
 .;.I WorkDir'="" S TA="",HREF="javascript: TELNETP(""1"",""$"",""$"",""BS_TELNET"");"
 .;.w " - <A HREF='"_HREF_"' "_TA_" TITLE='Загрузить TCP-сокет'>TCP-socket</A>"
 .;//test!!!
 .;I $$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","AsysEInoActivX") 
 .;Q
 .i '$d(BSSES) Q
 .D ExecTel^%ZAPM.bs.BSCp D  //TECT!!!!!!
 ..;w BK_" - <A HREF=""javascript: Exec('C:/utl/UltraEdit/uedit32.exe','L:/MSW_Tools/_installation_ext/soft/dsr-client-dev/Support/Setup.Lst','L:/!');"" TITLE='Загрузить ЗАДАНИЕ'>EXE</A>"
 ..;w BK_" - <A HREF=""javascript: Exec('NOTEPAD.exe','L:/MSW_Tools/_installation_ext/soft/dsr-client-dev/Support/Setup.Lst','C:/Program Files/MSW-Tools/ClientIP/');"" TITLE='Загрузить ЗАДАНИЕ'>EXE</A>"
 ..;
 ..;В ТЕРМИНАЛЕ СМОТРЕТЬ УЗЛЫ ТЕКУЩЕЙ СЕССИИ
 ..w BK_"ID сессии :<A HREF=""javascript: "_$$TELNET^%ZAPM.bs.BSCp2("%SYS","#","InfoSessi^^%ZAPM.bs.BSC4rout("_BSSES_")","Sessions")_" "" TITLE='Sessions id: '>"_$G(BSSES)_"</A>"
 ..;
 ..;ЗАПУСТИТЬ ПОЛНЫЙ ТЕРМИНАЛ
 ..I $G(BSdebug) D
 ...w BK_" <A HREF=""javascript: "_$$TELNET^%ZAPM.bs.BSCp2("1","$","$","Terminal")_" "" TITLE='Загрузить Terminal'>Терминал</A>"
 ...w BK_" <A HREF=""javascript: "_$$TELNET^%ZAPM.bs.BSCp2("%SYS","%BSC","PROTECTM","Основные БД")_" "" TITLE='Основные БД'>Основные таблицы</A>"
 ...;w BK_" - <A HREF=""javascript: "_$$WebView^%ZAPM.bs.BSCp2("http://VM-MSW:1962/?BSTKWEB%20?BSG=Phone&&WEBPAGE=FRAMES")_" "" TITLE='Загрузить ЗАДАНИЕ'>WebView</A>"
 ...;w BK_" - <A HREF=""javascript: "_$$OpenWeb^%ZAPM.bs.BSCp2("http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,"InfoKEY^~BSC4rout"),"'")_" "" TITLE='Загрузить ЗАДАНИЕ'>OpenWeb</A>"
 ...//ПсевдоГиперСобытия
 ...;w BK_" <A HREF="""" onClick='"_$$HyperRunTel^%ZAPM.bs.BSCp2("1","$","$","Terminal")_"' TITLE='Загрузить Terminal через ПсевдоГиперСобытие'>HyperTerminal</A>"
 ...;w BK_" <A HREF="""" onClick='"_$$HyperRunTel^%ZAPM.bs.BSCp2("%SYS","%BSC","PROTECTM","Основные БД")_"' TITLE='Загрузить Terminal через ПсевдоГиперСобытие'>HyperTerminal</A>"
 W EF_BBK
 D FOO^%ZAPM.bs.BSC4("footer")
 Q
Lab W 11111111
 Q
InfoKEY N CK,I,AK
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Параметры лицензии"),$$B27^%ZAPM.bs.BSCGIS(0)
 I $G(BSSES)="" W "надо зарегистрироваться!"
 E  D
 . zn "%sys" D OutSpool^%ZAPM.bs.BSCpool("D ^CKEY"),Spool2BSSES^%ZAPM.bs.BSCpool(+$J,"^CKEY") M CK=@BDSES@(BSSES,"VAR","SPOOL","^CKEY")
 .W "<PRE>" D  W "</PRE><HR>"
 ..S I="" F  S I=$O(CK(I)) Q:I=""  D
 ...W CK(I) I CK(I)["AuthorizationKey" S AK=$TR($P($P(CK(I),"=",2),$C(13))," ","")
 .W "<PRE>" I $D(AK) D DecodeW^CKEY(AK) W "</PRE><HR>"
 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 Q
InfoSession(S) I '$G(BSdebug) Q S
 S BSLABEL="InfoSessio^~BSC4rout" 
 N HREF,TA S HREF=$$ADDBSGET^%ZAPM.bs.BSC4(),TA="target=new" 			;по старому
 I $$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","AsysEInoActivX") d  	;по новому
 .D TELNETP^%ZAPM.bs.BSCmDDR S TA="",HREF="javascript: TELNETP(""%SYS"",""#"",""InfoSessi^^%ZAPM.bs.BSC4rout("_BSSES_")"",""Sessions"");"
  Q "<A HREF='"_HREF_"' "_TA_" TITLE='Загрузить в терминале редактор массивов с узлом сессии'>"_S_"</A>"
InfoSessio D RunProSess("TELNETP(""%SYS"",""#"",""InfoSessi^^%ZAPM.bs.BSC4rout("_BSSES_")"",""Sessions"");") Q
 
InfoTerm D RunProSess("TELNETP(""1"",""$"",""$"",""BS_TELNET"");") Q
InfoTCP N tcpPORT S tcpPORT=$$PORT^%ZAPM.bs.BSpgTEL d  D RunProSess("TELNETP(""1"",""$"",""$"",""BS_TELNET"");") Q
 .i tcpPORT="" k tcpPORT 
InfoSessi(S) N R S R=$NA(@$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")")@(S)) D ^%ZAPM.bs.BSMSMG(R)
 Q
RunProSess(JS,Other) //загрузить ПРОЦЕСС JS
 D BEG1^%ZAPM.bs.BSC4 
 S rd1="" i $g(Other)'="" d @Other
 e  D FUN^%ZAPM.bs.BSCmDDR
 w "<BODY ONLOAD='"_JS D  W "'><OBJECT ID=RDos"_BK 
 .W "window.close();"
 w "CLASSID=""CLSID:23F82604-18EB-4BBD-943B-60C05C57DFB4"" "_BK 
 w "CODEBASE=""RunDos.CAB#version=2,4,0,4"" width=0 >"_BK 
 w "</OBJECT>"_BK 
 D END^%ZAPM.bs.BSC4
 Q
ExeRun1 D JS^%ZAPM.bs.BSCp
 n Ext,WorkDir 
 s WorkDir=$$DR^%ZAPM.bs.BSCp2
 i WorkDir'="" s Ext=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","AsysEInoActivX")  //WebView--STATUS
 w "function ExeRun2(workdir,exe,param) {",BK
 ;W "alert(workdir);"_BK
 I '$G(Ext) D
 .w "parent."_$G(rd1,"rd1.")_"RDos.RunOption=1;"_BK
 .w "if (workdir=='') parent."_$G(rd1,"rd1.")_"RDos.WorkDir="_$$WorkDir^%ZAPM.bs.BSCAsIs()_";"_BK
 .w "else parent."_$G(rd1,"rd1.")_"RDos.WorkDir=workdir;"_BK
 ;W "prompt('Вот она!',parent."_$G(rd1,"rd1.")_"RDos.WorkDir);"_BK 
 I '$G(Ext) w "parent."_$G(rd1,"rd1.")_"RDos.Command=exe+' '+param;"_BK 
 E  D
 .w "var Rou=exe;"_BK  //запуск через статус-бар программы WebView.exe
 .w "var Par=cmdline;"_BK
 .w "var Dir='"_$G(WorkDir)_"';"_BK
 .w "status='Status :Exec:*'+Rou+'*'+Par+'*'+Dir+'*';"_BK
 .w "status='Ждите, программа запускается...';"_BK
 ;W "var aa=prompt('Вот она!','"_FTerm_"');"_BK
 ;W "alert(param);"_BK
 I '$G(Ext) w "parent."_$G(rd1,"rd1.")_"RDos.RunCommand();"_BK
 w "}",BK
 D JSE^%ZAPM.bs.BSCp
 Q
tit(T) Q "<title>"_T_"</title>"
a(R,A,T,W,H) S R=$$R(R) I R[$C(34) S R=$$TR^%ZAPM.bs.BSsFUNM(R,$C(34),$C(34,34))
 Q "<a title='"_$G(T)_"' class=u1 onclick='open("""_R_""",""RESULT3"",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWO1")_",status=1,resizable=1"");'>"_A_"</a>"
R(L) ;СТАНДАРТНАЯ ЗАГРУЗКА ИЗ ПРОГРАММЫ
 N BSLABEL S BSLABEL=L
 Q $$ADDBSGET^%ZAPM.bs.BSC4()
1(T,P) ;СТАНДАРТНАЯ ЗАГРУЗКА ТАБЛИЦЫ ИЗ РАЗДЕЛА
 N BSNSP S BSNSP=$TR($ZU(5),"%","~")
 Q $$ADDBSGET^%ZAPM.bs.BSC4()_"&BSPART="_P_"&BSTABL="_T
ADM2 W "<tr><td width=10% class=s3 >"_T_"</td><td  width=70% class=s3 >"
 W "<a class=u1 title='Таблица "_PA_"("_T_")' onclick='open("""_$$1(T,P)_""","""",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWO1")_",status=1,resizable=1"");' align='right'>"_$P($G(@PA@(T)),"@")_"</a>"
 W "</td></tr>",BK
 Q
primg() q "<img border=0 src='"_BSDOMAIN_"/img/printer.gif' >"
blank() q "<img border=0 src='"_BSDOMAIN_"/img/fon-polos.jpg' >"
DEL  w t_"<td width=10% >"_y_BK
 Q
option
 D ExecTel^%ZAPM.bs.BSCp 
 W "<div align='right'><TABLE BORDER=0><TR>" d  W "</TR></TABLE></div>"_BK_BK
 .n t,y,Tit,NewStart
 .S t="<TD>",y="</TD>"_BK
 .w t_$$NEWUSERS_y
 .w t_$$a("USERLIST^~BSC4rout","<img border=0 src='"_BSDOMAIN_"/img/persons.gif' ALT='Список Пользователей и их ресурсы'>")_y
 .w t_$$a("ShowUser^~BSmirWAKA","<img border=0 src='"_BSDOMAIN_"/img/persons-.gif' ALT='Групповая работа с аккаунтами пользователей'>")_y
 .N BSLABEL,BSBBS,BSintREG1 S BSBBS="MSM",BSLABEL="^~BSC4reg"
 .W t_"<a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' target='RESULT3'><img border=0 src='"_BSDOMAIN_"/img/person.gif' ALT='Ввести, модифицировать и удалить пользователя'></a>"_y
 .W t D CHANGEKillUser W y
 .w t D EMPTYPASS("<img border=0 src='"_BSDOMAIN_"/img/person2.gif' ALT='Пользователь забыл пароль'>") W y
 .i $g(^%ZAPM.bs.BS("Config"))="VV" w t D ACCESS($$ACCIMG^%ZAPM.bs.BSCm2) w y
 .D DEL
 .W t_$$PARIP^%ZAPM.bs.BSCm1("param.gif")_y
 .I $$GRA^%ZAPM.bs.BSCGIS(BSLOGIN,"zDebug") W t_$$PARIPED^%ZAPM.bs.BSCm1("refr-blu.gif")_y
 .D DEL
 .w t D SETU("<img border=0 src='"_BSDOMAIN_"/img/option.gif' ALT='") w y
 .W t_$$A^%ZAPM.bs.BSC4cfgP("<img border=0 src='"_BSDOMAIN_"/img/ham-blue.gif' ALT='Дополнительные параметры системы'>","^[|~SYS|]BSC4.ISS.Setup","^~BSETUP(|ISS|)",1)_y
 .I $$GRA^%ZAPM.bs.BSCGIS(BSLOGIN,"zDebug") N g s g="^[""%SYS""]BSC4.ISS.Setup" W t_$$Param3^%ZAPM.bs.BSCAsIs_y
 .D DEL
 .i $g(^%ZAPM.bs.BS("Config"))="VV" d
 ..W t_$$PARSNXI^%ZAPM.bs.BSCm1("refr-blu.gif")_y
 ..W t_$$PARSNXIED^%ZAPM.bs.BSCm1("refr-red.gif")_y
 ..D DEL
 .w t_"<A HREF=""javascript: "_$$TELNET^%ZAPM.bs.BSCp2("%SYS","%BSC","PROTECTM","Основные БД")_" "" TITLE='Основные БД'><img border=0 src='"_BSDOMAIN_"/ext/mdb.gif' ALT='Основные БД'></A>"_y
 .D DEL
 .W t_"<a target='RESULT3' href='"_$$ADDLIB^%ZAPM.bs.BSC4()_"BSGRANT="_$G(BSGRANT)_"&BSLOGIN="_BSLOGIN_"&BSG=B4&BSDOMAIN=/b4y&BSLABEL=Navigator&BSLNG=RUS&BSNSP=~SYS&BSPRO=CFG&BSRoutineId=1814453359'><img border=0 src='"_BSDOMAIN_"/img/paint.gif' ALT='Навигатор по Стилям'></a>"_y
 .;W t_"<a target='style1' href='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"Navigator^~BSC4r3")_"'><img border=0 src='"_BSDOMAIN_"/img/paint.gif' ALT='Параметры Стилей'></a>"_y
 .D SDemon^%ZAPM.bs.BSCZSTU
 .S Tit=$$LNG^%ZAPM.bs.BSC4("Фоновое задание")_" "_$S($G(NewStart)="":$$LNG^%ZAPM.bs.BSC4("не запущено"),1:$$LNG^%ZAPM.bs.BSC4("уже работает с ")_$G(NewStart))
 .W t_"<a target='RESULT3' href='"_$$ADDLIB^%ZAPM.bs.BSC4()_"BSG=B4&BSDOMAIN=/b4i&BSLABEL=Navigator&BSLNG=RUS&BSNSP=~SYS&BSPRO=CFG&BSRoutineId=3381443579'><img border=0 WIDTH=15 src='"_BSDOMAIN_"/img/daemon.gif' ALT='Параметры Демона. "_Tit_"'></a>"_y
 .W t_"<a target='RESULT3' href='"_$$ADDLIB^%ZAPM.bs.BSC4()_"BSG=B4&BSDOMAIN=/b4i&BSLABEL=Navigator&BSLNG=RUS&BSNSP=~SYS&BSPRO=CFG&BSRoutineId=3010540426'><img border=0 WIDTH=15 src='"_BSDOMAIN_"/img/daemonfly.gif' ALT='Команды Демону. "_Tit_"'></a>"_y
 .w t_"<A HREF=""javascript: "_$$TELNET^%ZAPM.bs.BSCp2("%SYS","%BSJPRN","DPP","Устройства вывода")_" "" TITLE='Устройства вывода'><img border=0 src='"_BSDOMAIN_"/img/printer.gif'></A>"_y
 .;W t_"<a title='устройства вывода' "_$$AN^%ZAPM.bs.BSCm("^%ZAPM.bs.BSJPRN","PRN","EDIT^~BSChT1")_"><img src='"_BSDOMAIN_"/img/printer.gif'></a>"_y
 .w t_$$STAT^%ZAPM.bs.BSvdaSTAT("")_y
 .D DEL
 .W t_$$CHANGESYSDATE^%ZAPM.bs.BSCp_y
 .W t_$$CHANGESYSTIME^%ZAPM.bs.BSCp_y
 .i $g(^%ZAPM.bs.BS("Config"))="VV" W t_$$LTA("<img border=0 src='"_BSDOMAIN_"/img/cos.gif'>")_y
 .W t_$$S^%ZAPM.bs.BSCsys_y
 .W t_$$cconsolelog("<img border=0 src='"_BSDOMAIN_"/ext/ini.gif'>")_y
 .D DEL
 .w t_$$a("RR^~BSCrr","<img border=0 src='"_BSDOMAIN_"/ext/mdl.gif' ALT='Загрузить документ из Rotional Rose'>")_y
 .W t_$$HelpB^%ZAPM.bs.BSC4base_y
 .W t_$$Help^%ZAPM.bs.BSC4base_y
 .w t_$$a("TEST^~BSpgBS","<img border=0 src='"_BSDOMAIN_"/img/edit.gif' ALT='Тестовая страница'>")_y
 q
ADM ;МОДУЛЬ АДМИНИСТРАТОРА
 d GRA^%ZAPM.bs.BSC4 N BSGRANT,BSintREG
 D BEG1^%ZAPM.bs.BSC4
 d option
 W "<table border=0 width=100%>"
 W "<tr><td width=20% class=s1 ><STRONG>------</STRONG>"_"</td></tr>"_BK
 W "</table>"_BK
 D part
 D part2
 ;W $$BsDoc^%ZAPM.bs.BSC4b("<img border=0 src='"_BSDOMAIN_"/img/bsdoc.gif' >")," %BS - Документация"_BBK_BBK
 
 d Weblink
 D NuSphere
 D InfoSess
 ;S BSLABEL="Reg^~BSCm6" W "<a HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' target='NuSphere'>REG INT</A><HR>"
 D END^%ZAPM.bs.BSC4
 Q
part2
 D STY^%ZAPM.bs.BSCm2(2),DIV^%ZAPM.bs.BSCm2(2,"Редактивать параметры синхронизации","СИСТЕМА СИНХРОНИЗАЦИИ")
 D   D DI^%ZAPM.bs.BSCm2
 .N ta
 .s ta=0,ta("Text")=0,ta("Par")=0 //ВСЕ КРОМЕ
 .D PARTS^%ZAPM.bs.BSCm("^%ZAPM.bs.BSC4SNX","|",1,.ta)
 q
part  ;D PARTS^%ZAPM.bs.BSCm("^[""%SYS""]BSC4.CFG|^%ZAPM.bs.BSC4|^%ZAPM.bs.BSC4SNX","|",3)
 D STY^%ZAPM.bs.BSCm2(0),DIV^%ZAPM.bs.BSCm2(0,"Редактивать системные БД","ОБЩИЕ ПАРАМЕТРЫ КОМПЛЕКСА")
 D   D DI^%ZAPM.bs.BSCm2 
 d part3
 q
part3  N ta
 s ta=1,ta("GRAND")=1,ta("SESSIONS")=1,ta("PROTECT")=1,ta("PIN")=1,ta("IP")=1,ta("Profile")=1 //ТОЛЬКО УКАЗАННЫЕ
 D PARTS^%ZAPM.bs.BSCm("^%ZAPM.bs.BSC4","|",1,.ta)
 q
Weblink i $G(%("HOST:"))'="" Q  //НЕТ ЕГО
 W "<FIELDSET><LEGEND>Weblink</LEGEND>" d   w "</FIELDSET>"
 .S U="http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDLIB^%ZAPM.bs.BSC4() W "<hr><a HREF='"_U_"' target='Weblink'>Конфигурирование Weblink ситемного интегратора</A>"
 q
NuSphere W "<HR>" D
 .S ST=$$HTTP^%ZAPM.bs.BSCmail("http://"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_":81") I $P(ST," ",2)'=200 Q 
 .S U="http://"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_":9000" 
 .W "<FIELDSET><LEGEND>NuSphere Technology Platform: (Apache:port-81, PHP, MySQL)</LEGEND>"
 .W "<a HREF='"_U_"' target='NuSphere'>NuSphere Administration Web Site</A><HR>" D
 ..W $$xAWIKI^%ZAPM.bs.BSC4b("WackoWiki Портал - База знаний")
 ..w "<br><a HREF='"_$$testODBC^%ZAPM.bs.BSCGH()_"' target='MGWSI'>Пример доступа из PHP к СУБД Cache' по ODBC</A>"
 ..
 ..S U="http://"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_":81/cgi-bin/nph-mgwsic.exe"
 ..S ST=$$HTTP^%ZAPM.bs.BSCmail(U,2,.OUT) I $P(ST," ",2)'=200 Q
 ..Q:'$D(OUT)  S OUT=$O(OUT("Data","")) I OUT'="" I $G(OUT("Data",OUT))["error occurred" Q
 ..W "<hr><a HREF='"_U_"' target='MGWSI'>Конфигурирование m_PHP ситемного интегратора (M/Gateway Developments Ltd.)</A>"
 ..S U="http://"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_":81/test/m/mainmenu.php" W "<br><a HREF='"_U_"' target='MGWSI'>1. Пример доступа из PHP(n:\infoportal\nus\test\...) к СУБД Cache'</A>"
 ..S U="http://"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_":81/test/m/test.php" W "<br><a HREF='"_U_"' target='MGWSI'>2. Пример доступа из PHP(n:\infoportal\nus\test\...) к СУБД Cache'</A>"
 ..
 .w "</FIELDSET>"
 Q
cconsolelog(IMG) //ПОКАЗАТЬ clog
 N BSPARENT,BSLABEL,BSTABL,BSPART S BSLABEL="CLOG^~BSC4rout"
 Q " <a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"#LOGend' TARGET='RESULT3' title='Показать CCONSOLE.LOG'>"_IMG_"</a>"
CLOG  n filename,deflocation,tmp
 D BEG1^%ZAPM.bs.BSC4  W $$B27^%ZAPM.bs.BSCm4()
 s filename=$$CacheSysDir^%ZAPM.bs.BSCp("\mgr\cconsole.log")
 D File2Arr^%ZAPM.bs.BSCEXE(filename,.tmp) W "<PRE>"
 S tmp="" F  S tmp=$O(tmp(tmp)) Q:tmp=""  W tmp(tmp)
 W "</PRE><A NAME='LOGend'>"
 Q
LTA(IMG) //ПОКАЗАТЬ ТАБЛИЦУ ЛОКИРОВКИ
 N BSPARENT,BSLABEL,BSTABL,BSPART S BSLABEL="LT^~BSCp"
 Q " <a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' TARGET='RESULT3' title='Таблица Залоченных Ссылок'>"_IMG_"</a>"
SETU(IMG)        N T,P,nEW,PA
 S BSLABEL="ENTER^~BSC4cfg"
 S P=$$MainOpt^%ZAPM.bs.BSC4,PA=$P(P,"("),T=$QS(P,1),P=$$%T^%ZAPM.bs.BSCh(PA)
 W "<a class=u1 title='!!!' onclick='open("""_$$1(T,P)_""",""RESULT3"",""toolbar=no,menubar=no,scrollbars=yes,"_$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWO1")_",status=1,resizable=1"");'>"_IMG_$P($G(@PA@(T)),"@")_"'></a>"
 Q
ACCESS(IMG)   N BSPARENT,BSLABEL,BSTABL,BSPART S BSLABEL="T^~BSCm4",BSPART="^~BSC4",BSTABL="PROTECT",BSPARENT="EditForm"_$p(BSSES,".")
 W " <a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' TARGET='"_BSPARENT_"'>"_IMG_"</a>"
 Q
CHANGEKillUser D CHANGEKILL("<img border=0 src='"_BSDOMAIN_"/img/person3.gif' ALT='Сменить пароль или удалить пользователя "_$G(BSLOGIN)_"'>")
 Q
CHANGEKILL(IMG) N BSintREG1,BSLABEL S BSintREG1=1,BSLABEL="^~BSC4reg"
 W " <a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' target='RESULT3' >"_IMG_"</a>"
 Q
EMPTYPASS(IMG) N BSintREG1,BSLABEL S BSintREG1=1,BSLABEL="EMPTYPASS1^~BSC4rout"
 W " <a target='RESULT3'  TITLE='"_$$LNG^%ZAPM.bs.BSC4("Обнулить пароль пользователю")_"' href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>"_IMG_"</a>"
 Q
EMPTYPASS1 N Q,I,II S Q=""
 D BEG1^%ZAPM.bs.BSC4
 W "<h3>"_$$LNG^%ZAPM.bs.BSC4("Пользователь забыл пароль")_"</h3>"
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="EMPTYPASS2^~BSC4rout"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 S Q=Q_"<SELECT NAME=USER><OPTION></OPTION>"
 S II="" F I=1:1 S II=$O(@BDUSE@(II)) Q:II=""  S Q=Q_"<OPTION>"_II_"</OPTION>"
 W " Пользователю "_Q_"</SELECT><HR>"
 W "<input type='submit' name=""sNEW"" value='"_$$LNG^%ZAPM.bs.BSC4("Обнулить пароль")_"'></FORM>"
 d BACK^%ZAPM.bs.BSCh D END^%ZAPM.bs.BSC4
 Q
EMPTYPASS2       D BEG1^%ZAPM.bs.BSC4
 I $G(USER)="" G EMPTYPASS3
 D PassNew^%ZAPM.bs.BSCp(USER,"","0","",1)
 S @BDUSE@(USER,"PSW")=$$CRC^%ZAPM.bs.BSCp(USER,0)
 W "<h3>Пользователю "_RED_USER_EF_" присвоен пароль 0</h3>"
EMPTYPASS3 d BACK^%ZAPM.bs.BSCh D END^%ZAPM.bs.BSC4
 Q
NEWUSERS() N BSintREG,BSLABEL
 S BSintREG=1,BSLABEL="^~BSC4reg"
 Q "<a href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' target='RESULT3'><img border=0 src='"_BSDOMAIN_"/img/pers-new.gif' ALT='Новый пользователь'></a>"_BK
ADM1() I nEW S nEW=nEW+1 Q nEW
 Q ""
RR ;ЗАПУСК ПОДСЧЕТА У КОГО СКОЛЬКО БАЙТ НАТИКАЛО
 N BSLOGIN,pi,pin,BSPRO,Num,BSNSP,ONSP
 D MAINVAR^%ZAPM.bs.BSC4
 N Cm S Cm=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Commerce")
 I '$D(BDTAR) S BDTAR=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""TARIFF"")")
 S ONSP=$ZU(5)
 S BDSTAT="^[""%SYS""]BSC4.CFG.UStatus("""_$ZD($H,8)_""")"
 S pi="" F Num=1:1 S pi=$O(@BDPIN@(pi)) Q:pi=""  D
 .S BSLOGIN=$G(@BDPIN@(pi,"LOGIN"))
 .D USR
 .S @BDSTAT@(pi,"MainLogin")=BSLOGIN,@BDSTAT@(pi,"NSP")=BSNSP,@BDSTAT@(pi,"TRF")=TARIF
 .S @BDSTAT@(pi,"ProjCount")=$P($P(KP1,","),"="),@BDSTAT@(pi,"ProjSize")=$P($P(KP1,",",1),"=",2)
 .S @BDSTAT@(pi,"ProgCount")=$P($P(KP1,",",2),"="),@BDSTAT@(pi,"ProgSize")=$P($P(KP1,",",2),"=",2)
 .S @BDSTAT@(pi,"TabCount")=$P($P(KP1,",",3),"="),@BDSTAT@(pi,"TabSize")=$P($P(KP1,",",3),"=",2)
 .S @BDSTAT@(pi,"Total")=KP2,@BDSTAT@(pi,"TotalOST")=(TARIF-KP2)
 .I $G(@BDPIN@(pi,"DAT"))'="" S @BDSTAT@(pi,"DateRegistr")=$ZD($G(@BDPIN@(pi,"DAT")),8)
 .S @BDSTAT@(pi,"TimeReport")=$ZT($P($H,",",2),1)
 I $$ZU^%ZAPM.bs.BSF4(ONSP)
 q
USERLIST ;СПИСОК ПОЛЬЗОВАТЕЛЕЙ
 W $$tit($$LNG^%ZAPM.bs.BSC4("СПИСОК ПОЛЬЗОВАТЕЛЕЙ",305))
 W $$STYLE^%ZAPM.bs.BSC4
 W " <table border=0 width=100%>"
 N BSLOGIN,pi,pin,BSPRO,Num,BSNSP
 N Cm S Cm=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Commerce")
 I '$D(BDTAR) S BDTAR=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""TARIFF"")")
 S BSLOGIN="" F Num=1:1 S BSLOGIN=$O(@BDUSE@(BSLOGIN)) Q:BSLOGIN=""  D US(BSLOGIN,BDTAR,BDPIN,BDUSE,$G(BDSTAT))
 Q
US(BSLOGIN,BDTAR,BDPIN,BDUSE,BDSTAT) K pi,pin,BSPRO,BSNSP
 D pin^%ZAPM.bs.BSC4base I pi="" Q
USR S BSNSP=$G(@BDPIN@(pi,"NSP"))
 I '$$ZU^%ZAPM.bs.BSF4(BSNSP) Q
 I BDSTAT="" W "<tr><td class=s1 >"_Num_"</td><td>"
 D STATUS
 I BDSTAT="" W "</td>"
 Q
STATUS ;О РЕСУРСАХ ПОЛЬЗОВАТЕЛЯ
 ;N KP1,KP2,TARIF
 I '$D(Cm) S Cm=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"Commerce")
 I '$D(BDTAR) S BDTAR=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""TARIFF"")")
 D pin^%ZAPM.bs.BSC4base
 S KP1=$$OcupSize
 S TARIF=$$TARIF("M")*1024*1024 ;БАЙТ
 S KP2=$P($P(KP1,",",1),"=",2)+$P($P(KP1,",",2),"=",2)+$P($P(KP1,",",3),"=",2)
 I $G(BDSTAT)'="" Q
 w "<hr>"_$$LNG^%ZAPM.bs.BSC4("Статус ресурса...",306)
 W " <table border=0 width=100%>"
 W "<tr><td width=30% class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4(22)_"</strong></td><td  width=70% class=s1 >"_BSLOGIN_"</td><tr>",BK
 W "<tr><td width=30% class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4(12)_"</strong></td><td  width=70% class=s1 >"_pi_"</td><tr>",BK
 W "<tr><td width=30% class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("Рабочая область",307)_"</strong></td><td  width=70% class=s1 >"_$G(@BDPIN@(pi,"NSP"))_"</td><tr>",BK
 I Cm=1 W "<tr><td width=30% class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("Ptariff")_"</strong></td><td  width=70% class=s1 >"_$$LNG^%ZAPM.bs.BSC4("T"_TARIF1)_"</td><tr>",BK
 W "</table>",BBK
 I Cm'=1 Q
 W " <table border=0 width=100%>"
 W "<tr><td align='right' class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("ВАШИ РЕСУРСЫ",308)_"</strong></td><td class=s3  align='CENTER'><strong>"_$$LNG^%ZAPM.bs.BSC4("Количество",309)_"</strong></td><td class=s3  align='CENTER'><strong>"_$$LNG^%ZAPM.bs.BSC4("Занимаемый Объем (Байт)",310)_"</strong></td><td class=s3  align='CENTER'><strong>"_$$LNG^%ZAPM.bs.BSC4("Осталось (Байт)",311)_"</strong></td></tr>",BK
 W "<tr><td align='right' class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("Проекты",312)_"</strong></td><td class=s1 >"_$P($P(KP1,","),"=")_"</td><td class=s1 >"_$P($P(KP1,",",1),"=",2)_"</td><td class=s1 >-</td></tr>",BK
 W "<tr><td align='right' class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("Программы",313)_"</strong></td><td class=s1 >"_$P($P(KP1,",",2),"=")_"</td><td class=s1 >"_$P($P(KP1,",",2),"=",2)_"</td><td class=s1 >-</td></tr>",BK
 W "<tr><td align='right' class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("Таблицы",314)_"</strong></td><td class=s1 >"_$P($P(KP1,",",3),"=")_"</td><td class=s1 >"_$P($P(KP1,",",3),"=",2)_"</td><td class=s1 >-</td></tr>",BK
 
 W "<tr><td align='right' class=s3 ><strong>"_$$LNG^%ZAPM.bs.BSC4("ИТОГО:",315)_"</strong></td><td class=s1 >.</td><td class=s1 >"_KP2_"</td><td class=s1 >"_(TARIF-KP2)_"</td></tr>",BK
 W "</table>",BBK
 Q
TARIF(CELL) N TARIF ;ЗНАЧЕНИЕ ПАРАМЕТРА ТАРИФНОГО ПЛАНА ДЛЯ ТЕКУЩЕГО ПОЛЬЗОВАТЕЛЯ
 S TARIF1=$G(@BDPIN@(pi,"TRF"))
  I TARIF1="" S TARIF1=$G(@BDUSE@(BSLOGIN,"TRF"),"?") //ПОКА ТАК
 S TARIF=$G(@BDTAR@(TARIF1,CELL))
 Q TARIF
OcupSize() ;ЗАНИМАЕМОЕ ПРОСТРАНСТВО
 N I,P,R,T,OP,OR,OT,BD
 S I="",P=0,R=0,T=0,OP=0,OR=0,OT=0 F  S I=$O(@("^"_pi_".PRO")@(I)) Q:I=""  D OPRO(pi,I) S P=P+1
 D OPRO(pi) ;ТЕПЕРЬ СЛУЖЕБНЫЙ
 S BD=$P($G(@("^"_pi)@("PRO","KEY")),"@")
 I $$Data^%ZAPM.bs.BSF12(BD) S OP=OP+$$^%ZAPM.bs.BSCGS("",BD) //ТОЛЬКО ДЛЯ WINDOWS
 Q P_"="_OP_","_R_"="_OR_","_T_"="_OT
OPRO(pi,BSPRO) ;ПОДСЧЕТ ПРОЕКТОВ С ТАБЛИЦАМИ И ПРОГРАММАМИ
 N I,N,BD
 S I=0
 I $D(BSPRO) S pin=pi_"."_BSPRO
 E  S pin=pi
 I '$D(@("^"_pin)) Q
 ;ЦИКЛ ПО ПРОГРАММАМ
 S BD=$P($G(@("^"_pin)@("ROU","KEY")),"@")
 I $$Data^%ZAPM.bs.BSF12(BD) D  S OR=OR+$$^%ZAPM.bs.BSCGS("",BD) ;ОПИСАНИЕ ПРОГРАММ
 .S N="" F  S N=$O(@BD@(N)) Q:N=""  D
 ..S OR=OR+$$OROU(pin_"."_N) S R=R+1 ;ПРОГРАММЫ
 S N="" F  S N=$O(@("^"_pin)@(N)) Q:N=""  I $P($G(@("^"_pin)@(N)),"@",17)=2 D
 .I N'="ROU"&(N'="PRO") S T=T+1
 .S BD=$P($G(@("^"_pin)@(N,"KEY")),"@") I BD="" Q
 .S BD=$QS(BD,0) I $D(@BD) S OT=OT+$P($$^%ZAPM.bs.BSCGS("",BD),"^") ;ИНФМАССИВЫ
 S OP=OP+$$^%ZAPM.bs.BSCGS("",pin) ;РАЗДЕЛ
 q
OROU(NameROU) ;ПОСЧИТАТЬ ПРОГУ
 Q 0
NEW ;СЛУЖЕБНЫЙ РЕСУРС ДЛЯ НОВОГО ПОЛЬЗОВАТЕЛЯ
 D pin^%ZAPM.bs.BSC4base
NewR I $G(@("^"_pi))["BaSe MsW" D  Q  //УЖЕ СУЩЕСТВУЕТ
 .S @BDPIN@(pi,"LOGIN",BSLOGIN)=$H
 S @("^"_pi)="BaSe MsW @СЛУЖЕБНЫЙ РЕСУРС ДЛЯ НОВОГО ПОЛЬЗОВАТЕЛЯ '"_BSLOGIN_"'"
 /*
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSC4E(""PRO"")","^"_pi_"(""PRO"")")
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSC4E(""CfgPro"")","^"_pi_"(""CfgPro"")")
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSC4PRO","^"_pi_".PRO")
 */
 M @("^"_pi_"(""PRO"")")=^%ZAPM.bs.BSC4E("PRO")
 M @("^"_pi_"(""CfgPro"")")=^%ZAPM.bs.BSC4E("CfgPro")
 M @("^"_pi_".PRO")=^%ZAPM.bs.BSC4PRO
 S @("^"_pi)@("PRO","KEY")="^"_pi_".PRO"
 S @("^"_pi_".PRO")="BSD - MSW@"
 M @("^"_pi_"(""CfgRou"")")=^%ZAPM.bs.BSC4E("CfgRou")
 M @("^"_pi_"(""CfgTab"")")=^%ZAPM.bs.BSC4E("CfgTab")
 /*
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSC4E(""CfgRou"")","^"_pi_"(""CfgRou"")")
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSC4E(""CfgTab"")","^"_pi_"(""CfgTab"")")
 */
 Q
NEWPRO(BSPRO,REM) D pin^%ZAPM.bs.BSC4base
NewP S @("^"_pi_".PRO")@(BSPRO,"REM")=REM
 S @("^"_pin)="BaSe MsW @"_REM
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSC4E(""ROU"")","^"_pin_"(""ROU"")")
 S @("^"_pin)@("ROU","KEY")="^"_pin_".ROU"
 S @("^"_pin_".ROU")="BSD - MSW@"
 Q
KILL() ;удаление ВСЕХ ресурсов И ЛОГИНА
 D pin^%ZAPM.bs.BSC4base
 N I,J,NSP
 ;КОНТРОЛЬ НА ЗАНЯТОСТЬ ДРУГИМ ПОЛЬЗОВАТЕЛЕМ -- Q 0
 S NSP=$G(@BDPIN@(pi,"NSP")) I '$$UCI^%ZAPM.bs.BSC4(NSP) Q 0
 S I="" F  S I=$O(@("^"_pi_".PRO")@(I)) Q:I=""  D KILLPRO(pi,I)
 D KILLPRO(pi) ;ТЕПЕРЬ СЛУЖЕБНЫЙ
 k @BDPIN@(pi),@BDUSE@(BSLOGIN) ;А ТЕПЕРЬ ВЕСЬ ЛОГИН
 Q 1
KILLPRO(pi,BSPRO) ;удаление ПРОЕКТОВ С ТАБЛИЦАМИ И ПРОГРАММАМИ
 N I,N,BD,ERR
 I $G(BSSES)'="" I $G(@BDSES@(BSSES,"PROJ"))=BSPRO K @BDSES@(BSSES,"PROJ") ;УДАЛИТЬ ИМЯ ТЕКУЩЕГО ИЗ СЕССИИИ
 S I=0
 I $D(BSPRO) S pin=pi_"."_BSPRO
 E  S pin=pi
 I '$D(@("^"_pin)) Q
 ;ЦИКЛ ПО ПРОГРАММАМ
 S BD=$P($G(@("^"_pin)@("ROU","KEY")),"@")
 I $$Data^%ZAPM.bs.BSF12(BD) S N="" F  S N=$O(@BD@(N)) Q:N=""  D
 .D DEL1^%ZAPM.bs.BSC4r4(pin_"."_N_".*") ;УДАЛЯЕМ ПРОГРАММЫ
 ;ЦИКЛ ПО ТАБЛИЦАМ
 S N="" F  S N=$O(@("^"_pin)@(N)) Q:N=""  I $P($G(@("^"_pin)@(N)),"@",17)=2 D
 .I $$Delete^%apiOBJ(pin_"."_N,,.ERR)
 .W $G(ERR),BK
 .S BD=$P($G(@("^"_pin)@(N,"KEY")),"@")
 .I BD="" Q
 .S BD=$QS(BD,0) I $D(@BD) K @BD
 K @("^"_pin)
 I $G(BSPRO)'="" K @("^"_pi_".PRO")@(BSPRO)
 q
rent ;w "информация о ренте"
 D BEG1^%ZAPM.bs.BSC4
 D STATUS
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSCB" type="MAC" languagemode="0"><![CDATA[
%BSCB ;СОЗДАНИЕ ДИСТРИБУТИВОВ ; 10:12   18.10.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
BsBuild //загрузка и компиляция классов BS-Portal
 //ОСНОВА КОДА ПОДСМОТРЕНА У ШУТОВА СЕРГЕЯ (ДИМАС)
 D Uninstall
 D Install
 Q
Install
 N STOP,I,II
 S DIR="c:\bs\" //ДИРЕКТОРИЯ ИСХОДНИКОВ. НЕ УДАЛЯЙТЕ И НЕ ПЕРЕНОСИТЕ ЕЕ!
 s OWNER="Михайленко Сергей <Mikhaylenko@b4y.net.ru>"
 do $system.OBJ.Load(DIR_"BSALL.xml","ck",.ERR) 
 S I="" F  S I=$O(ERR(I)) Q:I=""  D  Q:$G(STOP)
 .I ERR(I,"code")'=5475 S STOP=I Q
 .I ERR(I,"param",1)["%BSC" S STOP=I Q
 I $G(STOP) W "Обнаружены критичные ошибки...",!,"Обратитесь к разработчику "_OWNER q
 W "Обнаружены некритичные ошибки, продолжаем..."
 d iniT^%ZAPM.bs.BSCB
 Q 
Show do $system.OBJ.ShowFlags()
 Q
Uninstall
 N I,i Q:'$D(^%ZAPM.bs.BS)
 S BS="BS-Portal"
 write !,"удаление полного проекта "_BS,!
 k ^oddPROJECT("%BSALL")
 write !,"удаление всех описаний классов "_BS,!
 do $system.OBJ.DeletePackage("BSC")
 do $system.OBJ.DeletePackage("BSC4")
 F I="Doc","DocResult","Lib","Libresult" S II="/csp/msw/Bs"_I_".csp" I ##class(%CSP.Routine).Delete(II) W !,"Удалили CSP страницу "_II
 
   write !,"удаление всех программ "_BS,!
 // удаляются все программы из области, кроме текущей
 set rset = ##class(%ResultSet).%New()
 set rset.ClassName = "%Library.Routine"
 set rset.QueryName = "RoutineList"
 
 for I="%BS","%zek"  {
 	S rext=I_"*.MAC,"_I_"*.INT,"_I_"*.OBJ"
 	do rset.Execute(rext,1,0)
	 while (rset.Next(.sc)) {
	    if ($SYSTEM.Status.IsOK(sc)) {
	       set rname = rset.Data("Name")
	       if ($t(+0)'=$extract(rname,1,$length(rname)-4)) {
	       	write rname,!
	       	do ##class(%Library.Routine).Delete(rname)
	       }
	    }
	 }
  }
  write !,"удаление всех массивов "_BS,!
 // удаляются все программы из области, кроме текущей
 S I="" F i=1:1  S I=$O(^$GLOBAL(I)) Q:I=""  W:'(i#10) "." I I["^%ZAPM.bs.BS"!(I["^BSC") W !,I K @I
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCBD" type="MAC" languagemode="0"><![CDATA[
%BSCBD ;Генератор классов для ТаблицОписанияБазДанных %BS ; 18:26   06.04.2003
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
LD(D) D LoadDir^%apiOBJ(D,"cru",.ErroR) ;ЗАГРУЗИТЬ КЛАССЫ ИЗ ДИРЕКТОРИИ
 q
LF(D) D LoadFile^%apiOBJ(D,"cru",.ErroR) ;ЗАГРУЗИТЬ КЛАССЫ ИЗ CDL
 ;do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),!
 Q
ALL(UCI) ;КОМПИЛИРОВАТЬ ВСЕ РАЗДЕЛЫ И КОДИФИКАТОРЫ
 N PxPUSTO
 I $G(UCI)="" G ALLP
 I $ZU(5)'=UCI,$$ZU^%ZAPM.bs.BSF4(UCI)
 I $ZU(5)'=UCI Q "No found "_UCI
 S PxPUSTO=""
ALLP N GL S GL="" F  S GL=$O(^$GLOBAL(GL)) Q:GL=""  D
 .I $E($G(@GL),1,9)="BaSe MsW ",($E(GL,1,5)="^%ZAPM.bs.BSC"!($E(GL,1,4)="^%ZAPM.bs.BSS")) W !,"partition ",GL D ALLPART(GL) Q
 .D kdf^%ZAPM.bs.BSCKD(GL)
 Q 1
ALLPART(PART) ;КОМПИЛИРОВАТЬ ВЕСЬ РАЗДЕЛ
 S PP="" F  S PP=$O(@PART@(PP)) Q:PP=""  D
 .I $P(@PART@(PP),"@",17)=2 W !,$$START($NA(@PART@(PP)),1) ;БАЗА ДАННЫХ
 Q
START(TOBD,COMPILE,NC,DIR) ;
 N FN,K,S,I,J,P,SS,BD,CBD,BSK,P3,SUBK,OK
 I '$D(@TOBD) S ErroR="1,Undefine TOBD" Q ErroR
 I $G(DIR)="" S DIR=$$TEMPDIR^%ZAPM.bs.BSCF1
 I $D(NOKILLER),NOKILLER[":\" S DIR=NOKILLER
 I $P(@TOBD,"@",17)'=2 S ErroR="1,This no BD" Q ErroR
 D Copy^%ZAPM.bs.BSF8($NA(@TOBD@("KEY")),"K")
 S BD=$P(K,"@",1) ;ИМЯ БАЗЫ ДАННЫХ
 I $G(NC)="" S NC=$TR(TOBD,"(]%[)""^","..") S NC=$P(NC,".",1,$L(NC,".")-1)_"."_$S($E($P(NC,".",$L(NC,".")),1)?1N:"B",1:"")_$P(NC,".",$L(NC,"."))
 ;W NC Q
 S FN=DIR_NC_".CDL"
 I '$$OpenFile^%ZAPM.bs.BSCF1(FN,"W") S ErroR="1,No access to file "_FN Q ErroR
 U FN
 D TITLE W "class ",NC,!,"{",!
 D SUPER,KEYS I $D(@TOBD@("Metod")) S I="" F  S I=$O(@TOBD@("Metod",I)) Q:I=""  D METOD($G(@TOBD@("Metod",I)),I)
 D METOD("NameKey()",,"Q "_$D(K(0))) I '$G(NOqListBD) D QUERY
 D STORAGE
 W !,"}",!
 C FN
 I $G(COMPILE) D  I $g(NOKILLER)="",$$DelFile^%ZAPM.bs.BSCEXE(FN)
 .S @TOBD@("Compile")="Begin "_$$TD^%ZAPM.bs.BSC4base
 .K ErroR
 .D LF(FN)
 .I $G(ErroR) S OK=$TR($G(ErroR(1),ErroR),$C(34)_"'","``")
 .E  S OK="OK "_$$TD^%ZAPM.bs.BSC4base
 .S @TOBD@("Compile")=OK,@TOBD@("LST")=$H_","_$G(BSLOGIN)
 .D SNX^%ZAPM.bs.BSChT1("S",$TR(TOBD,"@",""),"TABLE")
 Q "1 OK"
TITLE W !,"/***********************************************************************\"
 W !,"          File: ",FN
 W !,"        Author: Serge W. Mikhaylenko"
 W !,"          Date: ",$ZD($H,9)
 W !,"   Description: Tree-DataBase from %BS"
 W !,"         Above: This File is Generated by %BS+++Cache"
 W !,"\***********************************************************************/",!!
 Q
SUPER W !,"description = {",!,$P(@TOBD,"@",1),!,"}",!
 W !,"   super = %Library.Persistent,%Library.Populate;",!
 W !,"persistent = BD;"
 W !,"index i1 { attributes = " D  W "; extent = 0; idkey; primarykey = 0; unique = 0; }",!
 .S S="",SUBK=0
 .F I=0:1:9 I $D(K(I)) S SUBK=SUBK+1,S=S_$$nk(I,"K"_SUBK)_","
 .W $E(S,1,$L(S)-1)
 Q
tra(S) Q $TR(S,$C(34)_"'","``")
nk(n,a) i $p(K(n),"@",22)'="" q $p(K(n),"@",22)
 e  q a
KEYS S SUBK=0
 F I=0:1:9 I $D(K(I)) D
 .S SUBK=SUBK+1
 .W !,"attribute "_$$nk(I,"K"_SUBK)," { type = %String(MAXLEN=""""); calculated = 0; description = ""Индексный ключ номер "_I_". Описан как :"
 .I $P(K(I),"@",17)'="" W $$tra($P(K(I),"@",17))_""";"
 .E  W $$tra($P(K(I),"@",15))_""";"
 .W " not final; multidimensional = 0; public; required; sqlcomputed = 0; transient = 0; }"
 w ! F I=1:1 Q:'$D(@TOBD@(I))  F J=1:1 Q:'$D(@TOBD@(I,J))  I $P(@TOBD@(I,J),"@",9)=2 D
 .I $P($P(@TOBD@(I,J),"@",18),"#")'="" S nynx=$P($P(^(J),"@",18),"#"),S=$TR(nynx,",ЁЙЦУКЕНГШЩЗХЪЭЖДЛОРПАВЫФЯЧСМИТЬБЮ","xQQWERTYUIOPPPPPLKJHGFDSAZXCVBNMMM"),S=$$Px(S)
 .E  S nynx=I_","_J,S="Px"_I_"x"_J
 .S P(S)=nynx W !,"  attribute "_S_" { type = %Library.String(MAXLEN=""""); calculated = 0; "
 .W "description = {",!
 .I $P(@TOBD@(I,J),"@",17)'="" W $$tra($P(@TOBD@(I,J),"@",17)),!
 .E  W "Показатель хранимый в базе данных. В таблице описания базы данных лежит в строке "_I_" колонке "_J_".",!
 .W "} "
 .W " not final; multidimensional = 0; public; not required; sqlcomputed = 0; transient = 0; }",!
 Q
Px(P) I $G(NOqListBD) Q "P"_$S($L(P)=1:"00",$L(P)=2:"0",1:"")_P
	I $E(P,1)?1N Q "Px"_P
 Q $G(PxPUSTO,"Px")_P
METOD(NM,N,code)
 W !!,"   method "_NM
 W !,"   {"
 W !,"   returntype = %Library.String;"
 W !,"   classmethod;"
 W !,"   not final;"
 W !,"   public;"
 W !,"   sqlproc = 0;"
 W !,"   code ="
 W !,"   ["
 I $D(code) W !,"     "_code
 E  S M="" F  S M=$O(@TOBD@("Metod",N,M)) Q:M=""  W !,"    "_$G(@TOBD@("Metod",N,M))
 W !,"   ]"
 W !,"   }",!
 Q
QUERY S S=""
 W !,"   query ListBD((Param1:%Library.String))"
 W !,"   {"
 W !,"           type = %Library.SQLQuery(CONTAINID=0,ROWSPEC=""" D  W """);"
 .;K1:%String,K2:%String,P1:%String,P2:%String,P3:%Library.String,P4:%Library.String
 .S SUBK=0
 .F I=0:1:9 I $D(K(I)) S SUBK=SUBK+1 W $$nk(I,"K"_SUBK)_":%String," S S=S_$$nk(I,"K"_SUBK)_", "
 .S J="",SS="" F  S J=$O(P(J)) Q:J=""  S SS=SS_J_":%String,",S=S_J_", "
 .W $E(SS,1,$L(SS)-1)
 W !,"           sqlquery ="
 W !,"           ["
 W !,"                   :SELECT "_$E(S,1,$L(S)-2)
 W !,"                   :FROM "_$P(NC,".",$L(NC,"."))
 I $D(K(1)) W !,"                   :WHERE ("_$$nk(1,"K1")_" = :Param1)"
 I $D(K(2)) W !,"                   :ORDER BY "_$$nk(2,"K2")
 W !,"            ]"
 W !,"            sqlproc = 0;"
 W !,"            sqlview = 0;"
 W !,"   }",! Q
STORAGE ;
 W !!,"       storage BD"
 W !,"       {"
 W !,"               description = ""Конструкция SQL доступа к базам данных %BS"";"
 W !,"               type = %CacheSQLStorage;"
 W !,"               sql"
 W !,"               {"
 W !,"                       map Master"
 W !,"                       {"
         W !,"                               type = data;"
 I $D(K(0)) D  ;ЕСТЬ ИМЕННОЙ КЛЮЧ
 .W !,"                               structure = list;"
 .W !,"                               global = ^*;"
 E  W !,"                               global = "_BD_";"
 W !
 S SUBK=0
 I $D(K(0)) D
 .S SUBK=1
    .W !,"       subscript 1 {"
    .W !,"        accesstype = global;"
    .W !,"        nextcode = ["
 .W !,"         I {L1}="""" S {L1}="_$$BD34
    .W !,"         S {L1}=""^""_{L1}"
    .W !,"         S {L1}=$O(^$GLOBAL({L1}))"
    .W !,"         S {L1}=$E({L1},2,$L({L1}))"
    .W !,"         I $E({L1},1,$L("_$$BD34_"))'="_$$BD34_" S {L1}="""""
 .W !,"            Q"
    .W !,"         ]"
    .W !,"         expression = "_$$BD34_"_{K1}; "
    .W !,"        }"
 F I=1:1:9 I $D(K(I)) D
 .S SUBK=SUBK+1
 .W !,"       subscript "_SUBK_"   { expression = {"_$$nk(I,"K"_SUBK)_"}; accesstype = sub; }"
 S J="" F  S J=$O(P(J)) Q:J=""  D
 .W !,"                           data "_J_" { node = """_P(J)_"""; }"
 S SUBK=0
 I $D(K(0)) S SUBK=1 W !,"   rowidspec 1 { field = K1; expression=$E({L1},$L("_$$BD34_")+1,$L({L1})); }"
         F I=1:1:9 I $D(K(I)) D
         .S SUBK=SUBK+1
         .W !,"   rowidspec "_SUBK_" { field = "_$$nk(I,"K"_SUBK)_"; expression={L"_SUBK_"}; }"
 W !,"                       }" ;MAP
 W !,"               }" ;SQL
 W !,"       }"
 Q
BD34() ;Q $C(34)_$E($$TR^%ZAPM.bs.BSsFUNM(BD,$C(34),$C(34,34)),2,999)_$C(34)
 N B1
 S B1=BD I BD["]" S B1="^"_$P(BD,"]",2,999)
 Q $C(34)_$E(B1,2,999)_$C(34)
NextNameBD(B) ;ПОКА НЕ ИСПОЛЬЗУЕТСЯ
 N NBD,NS,us,BD1
 S NBD=B
 I B["^[""" D
 .S NS=$ZU(5)
 .S us=$P(B,$C(34),2) I us'=$ZU(5) I $$ZU^%ZAPM.bs.BSF4(us)
 .S BD1="^"_$P(B,"]",2,9) S NBD=$O(^$GLOBAL(BD1))
 .I $ZU(5)'=NS,$$ZU^%ZAPM.bs.BSF4(NS)
 I B'["^[""" S NBD=$O(^$GLOBAL(B))
 Q NBD
Tab2TOBD(DSN,USER,PASS,NAME,TOBD) ;СТРУКТУРУ ТАБЛИЦЫ В ТАБЛИЦУ %BS
 N WEBSQL,I,II,flag
 D TABLE2T^%ZAPM.bs.BSCRG(DSN,NAME,TOBD,USER,PASS)
 I '$D(@TOBD) S ErroR=" Произошла ошибка импорта таблицы " W !,ErroR q
 D TA2BD^%ZAPM.bs.BSCRG($QS(TOBD,0),$QS(TOBD,1))
 I $P($G(@TOBD),"@",17)'=2 S ErroR=" Произошла ошибка импорта таблицы %BS " W ErroR,! q
 Q
JTB2TOBD(DSN,USER,PASS,NAME,TOBD) ;ТАБЛИЦУ %BS + КОМПИЛИРВАТЬ + ДАННЫЕ
 S PxPUSTO="" D START(TOBD,1) I $G(ErroR)>0 W !," Произошла ошибка компиляции ",! zw ErroR q
 D TAB2BSD^%ZAPM.bs.BSCRG(DSN,USER,PASS,NAME,$QS(TOBD,0),$QS(TOBD,1))
 Q
Stream(DSN,USER,PASS,part,NOKILLER) ;потоковая закачка всего DSN в Cache
 N (DSN,USER,PASS,part,NOKILLER) ;NOKILLER=путь к временной директории в которой CDL не удаляются (для отладки)
 d Stream1(DSN,USER,PASS,part)
 d Stream2(DSN,USER,PASS,part)
 q
Stream1(DSN,USER,PASS,part) ;закачка структуры DSN в раздел BS
 i $g(part)="" s part="^"_DSN
 D DSN2PART^%ZAPM.bs.BSCRG(DSN,part,$G(USER),$G(PASS)) I $G(ErV) W !,"Произошла ошибка доступа до DSN:"_DSN_" ",! zw ErV q
 q
Stream2(DSN,USER,PASS,part) ;закачка данных из таблиц DSN в таблицы BS
 D PART2BSD^%ZAPM.bs.BSCRG(part) i $G(Errors) W !," Произошла ошибка конвертации таблиц ",! q
 S PxPUSTO="" D ALLPART(part)
 I $G(ErroR)>0 W !," Произошла ошибка компиляции ",! zw ErroR q
 D DSN2BS^%ZAPM.bs.BSCRG(DSN,$G(USER),$G(PASS),part)
 W !,"Ok",!!     Q
 /////////////////////////////////////
MSETSQL(TD)
	I '$D(@TD) Q "0 ПУСТАЯ "_TD
	N GC,GD,PxPUSTO,NOKILLER,NOqListBD,IDU,%code
	S IDU=$$2LAT^%ZAPM.bs.BSCp($G(%BS(12),$G(BSLOGIN)))_"x"
	S GC=$NA(@("^CacheTempSQL")@(IDU))
	S GD="^CacheTempSQL."_IDU K @GD	M @GD=@TD 
	I $D(@GC) Q "1 @CacheTempSQL."_IDU
	M @GC=^%ZAPM.bs.BSC4("SQL")	S @GC@("KEY")=GD 
	S PxPUSTO="" ;,NOKILLER=1 ;НЕ УДАЛЯТЬ ФАЙЛ CDL
	S NOqListBD=1 ;НЕ СОЗДАВТЬ ЗАПРОС И ИМЕНА ПОЛЕЙ НОРМАЛИЗОВАТЬ
	S OK=$$START^%ZAPM.bs.BSCBD(GC,1) I $E(OK)="0" K @GD,@GC
	Q OK_" @CacheTempSQL."_IDU
 
MSETSQL1   S BSR="^CacheTempSQL",BST="SQL1" D ^%ZAPM.bs.BST
	Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCEXE" type="MAC" languagemode="0"><![CDATA[
%BSCEXE ; Cache' Dos-Functions for %BS ; 15:50   02.11.2001
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
 ;The following table shows the $ZU(140) flags recognized by Cache:
 ;Flag Operation
 ;  1 Returns file size in bytes.
 ;  2 Returns modification date/time in $H format
 ;  3 Returns creation date/time in $H format
 ;  4 Tests whether the named file exists (returns 0 if yes)
 ;  5 Deletes the named file
 ;  6 Renames the file specified in name with the name specified in newname. May move the file
 ;      to a different location, if the host operating system supports it.
 ;  7 Returns file attributes as a bit map.
 ;  8 [unused]
 ;  9 Creates the directory specified in name.
 ;  10 Deletes the directory specified in name
FileListDir(DIR,OUT,MODE,MASK) //выходной массив @OUT
 N mask,IndexLoop K @OUT D FileList(DIR,OUT,MODE,$G(MASK)) Q
FileList(DIR,OUT,MODE,MASK) //ВЫДАТЬ СПИСОК ФАЙЛОВ В ДИРЕКТОРИИ. MASK="exe,jpg,bmp" --- РАБОТАЕТ В ВЕБЛИНКЕ
 N rs,X,N
 I $G(MASK)'="" S mask=","_MASK_","
 set rs=##Class(%ResultSet).%New("%File.FileSet")
 S X=rs.Execute(DIR,"*.*") I X'=1 S Error=-1 Q
 F  Q:'rs.Next()  S N=rs.Get("Name") D
 .I ".."'[$P(N,"\",$L(N,"\")) D
 ..I $G(mask)'="",mask'[(","_$ZCONVERT($P($P(N,"\",$L(N,"\")),".",2),"L")_",") Q
 ..I MODE=1 S @OUT@($P(N,"\",$L(N,"\")))=rs.Get("Type")_"?"_rs.Get("Size")_"?"_rs.Get("DateCreated")_"?"_rs.Get("DateModified")
 ..I MODE=2,rs.Get("Type")'="D" S IndexLoop=$G(IndexLoop)+1,@OUT@(IndexLoop)=N_"?"_rs.Get("Type")_"?"_rs.Get("Size")_"?"_rs.Get("DateCreated")_"?"_rs.Get("DateModified")
 .I rs.Get("Type")="D",".."'[$P(N,"\",$L(N,"\")) D FileList(N_"\",$S(MODE=1:$NA(@OUT@($P(N,"\",$L(N,"\")))),1:OUT),MODE,$G(MASK))
 Q
 //$zu(140,1,filename)
GetFileSize(file,size,mode)  //ПРОЧИТАТЬ ИЗ ФАЙЛА  --- РАБОТАЕТ В ВЕБЛИНКЕ, ЕСЛИ size МЕНЬШЕ 32К !!! ТОЛЬКО ТЕКСТОВЫЕ ФАЙЛЫ
 N str,f,ok,len
 set f=##class(%File).%New(file)
 set ok=f.Open($G(mode,"RU"))     if 'ok do f.%Close() Q "-2"  //do DecomposeStatus^%apiOBJ(ok,.err) write !,err(err),!
 ;set len=$zu(140,1,file) I len<size S size=len
 S str=f.Read(.size) if size=-1 do f.%Close() Q "-1"
 do f.%Close()
 Q str
FileCopy(S,T) //КОПИРОВАТЬ ФАЙЛ
 N K,MM S K=$$File2Arr^%ZAPM.bs.BSCEXE(S,.MM) I 'K Q K
 Q $$Arr2File^%ZAPM.bs.BSCEXE(.MM,T)
Arr2File(Mas,file)  //ПРОЧИТАТЬ ИЗ МАССИВА И ПОЛОЖИТЬ В ФАЙЛ
 N str,f,ok,len,I,size
 set f=##class(%File).%New(file)
 set ok=f.Open("WN"),len=0     if 'ok do f.%Close() Q $$Err(ok)
 S I="" F  S I=$O(Mas(I)) Q:I=""  D f.Write(Mas(I)) S len=len+$L(Mas(I))
 do f.%Close()
 Q len_" byte"
File2Arr(file,Mas)  //ПРОЧИТАТЬ ИЗ ФАЙЛА И ПОЛОЖИТЬ В МАССИВ
 N str,f,ok,len,I,size
 set f=##class(%File).%New(file)
 set ok=f.Open("RSU")     if 'ok do f.%Close() Q $$Err(ok)
 set len=$zu(140,1,file)
 F I=0:30000:len D
 .S size=30000 S Mas(I)=f.Read(.size)
 do f.%Close()
 Q len_" byte"
 ; Note : need "W" to write, "R" to read, "N" for new, "U" to read over crlf delims ,S - BINARY STREAM
Err(ok) do DecomposeStatus^%apiOBJ(ok,.err) Q err(err)
 Q
File2Arr1() s file="L:\_ZD\mpki-.txt"
 N str,f,ok,len,I,size
 set f=##class(%File).%New(file),co=0
 set ok=f.Open("RSU")     if 'ok do f.%Close() Q $$Err(ok)
 set len=$zu(140,1,file)
 F I=0:1000:len s co=co+1 D   ;i co>10 q
 .S size=1000 S ^tMTKI(co)=f.Read(.size) w !,co," "_$e(^tMTKI(co),1,67)_".."
 do f.%Close()
 Q len_" byte"
GetFileC(file,flag)  //ВОЗВРАТИТЬ СОДЕРЖАНИЕ ФАЙЛА  --- РАБОТАЕТ В ВЕБЛИНКЕ, ЕСЛИ РАЗМЕР ФАЙЛА МЕНЬШЕ 32К
 N str,f,ok,len
 set f=##class(%File).%New(file)
 IF $D(flag) G GetFileCC
 set ok=f.Open("RU")     if 'ok do f.%Close() Q "-2"
 set len=$zu(140,1,file)
 S str=f.Read(.len) if len=-1 do f.%Close() Q "-1"
GetFileCE do f.%Close()
 Q str
GetFileCC K flag
 set ok=f.Open("R") if 'ok do f.%Close() Q "-2"
 F str=1:1 S len=32000,flag(str)=f.Read(.len) I len=-1 Q
 G GetFileCE
GetFile(file,ASCII) //ВОЗВРАТИТЬ СОДЕРЖАНИЕ ТЕКСТОВОГО ФАЙЛА  --- НЕ РАБОТАЕТ В ВЕБЛИНКЕ
  n a,s,x,S1,S2
  s $zt="GetFile1",s="",(S1,S2)="" I $D(ASCII) D INIT^%ZAPM.bs.BSre(ASCII)
  o file:"r":0 i '$t g GetFile1
  u file F  r a s s=s_$c(13,10)_$TR(a,S1,S2) ;u 0 w a,!
GetFile1 c file
 Q s
WINDOWS() Q "NT"
dir(dir,file) N w,a,s
 S w=$$command("d:\!\SHOW.BAT "_dir_" "_file)
  s $zt="dir1",s=""
  o file:"r":0 i '$t g dir1
  u file F  r a s s=s_$c(13,10)_a
  q
command(exec) ; Output directory listing
  n file,a,s,x
  s file=$$exec(exec,1)
  s $zt="dir1",s="" D INIT^%ZAPM.bs.BSre(0)
  o file:"r":0 i '$t g dir1
  u file F  r a s s=s_$c(13,10)_$TR(a,S1,S2) ;u 0 w a,!
dir1 c file
  d del(file)
  ;l -^%dosfile
dirq q s
 
del(D) i $$DelFile(D)
 Q
DelFile(D) ;Удаление файла
 N A S A=$ZU(140,5,D) I A=0 Q 1
 q A
 
files(spec) ; Return list of files that match pattern
  n (spec)
  s spec=$g(spec),Win=$$WINDOWS
  i Win="Win95" s exec="dir "_spec_" /v /a"
  e  i Win="NT" s exec="dir "_spec_" /x"
  e  s exec="dir "_spec_" /v /a"
  s file=$$exec(exec,1)
  s $zt="files1"
  o file:"r":0 i '$t g files1
  s str=""
  i Win="Win95" DO  ; --- Windows 95 Specific "DIR" Output ---
  . f  d
  .. u file r a
  .. i $e(a,1)=" "!(($e(a,9)'=" ")&($e(a,9)'=".")) q
  .. s pre=$tr($e(a,1,8)," ")                ; 8.2 DOS file name
  .. s suf=$tr($e(a,10,12)," ")
  .. s dosnam=pre
  .. i pre'["."&(suf'="") s dosnam=dosnam_"."
  .. s dosnam=dosnam_suf
  .. s a=$e(a,13,$l(a))
  .. d lspc                                  ; No leading spaces
  .. s f=$f(a," ")                           ; Find next space
  .. s size=$e(a,1,f-2),size=+$tr(size,",.") ; Actual size (no punctuation)
  .. s a=$e(a,f-1,$l(a))
  .. d lspc
  .. s f=$f(a," ")                          ; Skip allocated size
  .. s a=$e(a,f-1,$l(a))
  .. d lspc
  .. s f=$f(a," ")
  .. s dat=$e(a,1,f-2)                       ; 'Modified' date
  .. s a=$e(a,f-1,$l(a))
  .. s yy=$p(dat,"-",3)
  .. s mm=$p(dat,"-",2)
  .. s dd=$p(dat,"-",1)
  .. i yy>70 s yy=19_yy
  .. s dat=yy_"-"_mm_"-"_dd
  .. d lspc
  .. s f=$f(a," ")
  .. s tim=$e(a,1,f-2)                       ; 'Modified' time
  .. s a=$e(a,f-1,$l(a))
  .. s hh=+tim,mm=$p(tim,":",2)
  .. i mm["p" s hh=hh+$s(hh=12:0,1:12)
  .. i mm["a",hh=12 s hh=0
  .. s mm=$e(100+mm,2,3),hh=$e(hh+100,2,3)
  .. s tim=hh_":"_mm
  .. d lspc
  .. s f=$f(a," ")                           ; Skip Accessed date
  .. s a=$e(a,f-1,$l(a))
  .. s attr=$e(a,1,8),a=$e(a,9,$l(a))
  .. s attr=$zcvt(attr,"l"),attr=$tr(attr," ")
  .. d lspc
  .. s name=a                                ; 'Real' file name
  .. s str=str_dosnam_";"_attr_";"_size_";"_dat_";"_tim_";"_name_$c(10)
  e  DO  ; --- DEFAULT: Windows NT Specific "DIR" Output ---
  . f  d
  .. u file r a
  .. i $e(a,1)=" "!(($e(a,9)'=" ")&($e(a,3)'="/")) q
  .. s f=$f(a," ")
  .. s dat=$e(a,1,f-2)                       ; 'Modified' date
  .. s a=$e(a,f-1,$l(a))
  .. s mm=$p(dat,"/",1)
  .. s dd=$p(dat,"/",2)
  .. s yy=$p(dat,"/",3)
  .. i yy>70 s yy=19_yy
  .. s dat=yy_"-"_mm_"-"_dd
  .. d lspc
  .. s f=$f(a," ")
  .. s tim=$e(a,1,f-2)                       ; 'Modified' time
  .. s a=$e(a,f-1,$l(a))
  .. s hh=+tim,mm=$p(tim,":",2)
  .. i mm["p" s hh=hh+$s(hh=12:0,1:12)
  .. i mm["a",hh=12 s hh=0
  .. s mm=$e(100+mm,2,3),hh=$e(hh+100,2,3)
  .. s tim=hh_":"_mm
  .. d lspc
  .. i $e(a)="<" DO  ; Handle '<DIR>' stuff...
  ... s f=$f(a," ")                           ; Ignore '<DIR>'
  ... s attr=$e(a,1,f-2)
  ... s a=$e(a,f-1,$l(a))
  ... s attr="d"
  ... d lspc
  .. e  s attr=""
  .. s f=$f(a," ")                           ; Find next space
  .. i a'="",'f s size=a
  .. e  s size=$e(a,1,f-2)
  .. i 'f s (dosnam,name)=$s(size=".":$zcvt($p(spec,"\",$l(spec,"\")),"u"),1:size),size="",str=str_dosnam_";"_attr_";"_size_";"_dat_";"_tim_";"_name_$c(10) QUIT
  .. s size=+$tr(size,",.") ; Actual size (no punctuation)
  .. s a=$e(a,f-1,$l(a))
  .. d lspc
  .. s pre=$p($p(a,".",1)," ")                ; 8.2 DOS file name
  .. s suf=$p($p(a,".",2)," ")
  .. s dosnam=pre
  .. i pre'["."&(suf'="") s dosnam=dosnam_"."
  .. s dosnam=dosnam_suf
  .. s a=$e(a,f-1,$l(a))
  .. d lspc                                  ; No leading spaces
  .. s name=$s(a="":dosnam,1:a)              ; 'Real' file name
  .. s str=str_dosnam_";"_attr_";"_size_";"_dat_";"_tim_";"_name_$c(10)
files1  c file
  d del(file)
  ;l -^%dosfile
filesq  q str
 
size(D) ; Get size of single file (-1 indicates failure)
 N A S A=$ZU(140,1,D)
 Q A
volspace(spec) ; Get space left on drive
  n (spec)
  s spec=$g(spec),Win=$$WINDOWS
  i spec?1a s spec=spec_":"
  i Win="Win95" s exec="dir "_spec_"\"
  e  i Win="NT" s exec="dir "_$$curdrive()_":\"
  e  s exec="dir "_spec_"\"
  s file=$$exec(exec,1)
  s $zt="volspace1"
  o file:"r":0 i '$t g volspace1
  s b="" f i=1:1 s a=b u file r b
volspace1 ;
  c file
  d del(file)
  ;l -^%dosfile
  s a=b
  d lspc
  i Win="Win95" DO  ; --- Windows 95 Specific "DIR" Output ---
  . s f=$f(a," "),a=$e(a,f,$l(a))
  . s f=$f(a," "),a=$e(a,f-1,$l(a))
  . d lspc
  . s a=$p(a," ",1)
  e  DO  ; --- DEFAULT: Windows NT Specific "DIR" Output ---
  . s a=$p(a," ")
volspaceq q $tr(a,",.")
 
CurDisk() Q $$curdrive()
curdrive() ; Get current drive
  n file,i,a,Win
  s file="dir",Win=$$WINDOWS
  s $zt="curdrive1"
  o file:"rq":0 i '$t g curdrive1
  i Win="Win95" u file r a,a
  e  i Win="NT" u file r a
  e  u file r a,a
curdrive1 c file
curdriveq q $p(a," ",5)
 
GCDir(D) q $$ANSI^%ZAPM.bs.BSre($$subdir(D))
subdir(spec) ; Get current directory
  n (spec)
  s spec=$g(spec)
  i spec="" s spec=$$curdrive()
  i spec?1a s spec=spec_":"
  s file="dir "_spec
  s $zt="subdir1"
  o file:"rq":0 i '$t g subdir1
  u file r a,a,a,a
subdir1  c file
  s dir=$p(a," ",4)
  s dir=$p(dir,"\",2,$l(dir,"\"))
  i dir="" s dir="\"
subdirq  q dir
 
verify(spec) ; Check/Set verification of file copy
  n (spec)
  s spec=$g(spec)
  s spec=$zcvt(spec,"l")
  s flag=0 i spec'="on"&(spec'="off")&(spec'="") s spec="",flag=1
  i spec'="" s exec="verify "_spec d exec(exec,0) q
  s exec="verify"
  s file=$$exec(exec,1)
  s $zt="verify1"
  o file:"r":0 i '$t g verify1
  u file r a
verify1  c file
  d del(file)
  ;l -^%dosfile
  i flag w a,! q
verifyq  q a
 
copy(source,target) ; Copy files
  n (source,target)
  s source=$g(source),target=$g(target)
  i source=""!(target="") q
  s exec="copy "_source_" "_target
  d exec(exec,0)
copyq  q
 
RenFile(S,D) ; Rename files
 N A S A=$ZU(140,6,S,D) I A=0 Q 1
 Q 0
CNDir(D) ; Make a directory
 N A S A=$ZU(140,9,D) I A=0 Q 1
 Q 0
DelDir(D) ; Удалить пустую директорию
 N A S A=$ZU(140,10,D) I A=0 Q 1
 Q 0
type(spec) ; Type a file
  n (spec)
  s spec=$g(spec)
  i spec="" q
  s $zt="type1"
  o spec:"r":0 i '$t q
  f  u spec r a u 0 w a,!
type1  c spec
typeq  q
 
var(spec) ; DOS variables
  n exec,file,str,a,flag
  s spec=$g(spec)
  s exec="set"
  s file=$$exec(exec,1)
  s $zt="var1"
  o file:"r":0 i '$t g var1
  s str="",flag=0
  f  u file r a s str=str_a_$c(0) i $zcvt($p(a,"=",1),"l")=$zcvt(spec,"l")
  s str=$p(a,"=",2,999),flag=1 q
var1  c file
  d del(file)
  i spec'=""&('flag) s str=""
varq  q str
exists(file) ; Check to see if a file exists and return 0 or 1
  I $ZU(140,4,file)=0 Q 1
  Q 0
 ;Set Current Drive
SCDrive(D) Q "РЕЖИМ ПОКА НЕ ЭМУЛИРОВАН"
 Q
 ;Set File Attributes
SetAtr(F) Q "РЕЖИМ ПОКА НЕ ЭМУЛИРОВАН"
 Q
 ;Change Current Directory
CCDir(D) Q "РЕЖИМ ПОКА НЕ ЭМУЛИРОВАН"
 Q
 ;Get Drive Parameters
GetDPar(D) Q "РЕЖИМ ПОКА НЕ ЭМУЛИРОВАН"
 Q
 ;Get File Attributes
FileAtr(F,M) //Атрибуты ФАЙЛА
 I M=1 q $ZU(140,1,F) //- РАЗМЕР ФАЙЛА
 I M=2 q $ZD($P($ZU(140,2,F),",",1),3) //- ДАТА   $ZT($P(H,",",2),1)_" "_$ZD(H,3)
 I M=3 q $ZT($P($ZU(140,2,F),",",2),1) //- ВРЕМЯ
 Q ""
GetAtr(File)  //Атрибуты ФАЙЛА
 q $ZU(140,7,File)
 ;Существует ли файл
ExsFile(D) Q $$exists(D)
 Q
BegDir(D,V) ;Begin Directory Search 12 !!
 Q "" ;I $ZV["MSM" Q $ZOS(12,D,V)
SearFile(D,V) Q "РЕЖИМ ПОКА НЕ ЭМУЛИРОВАН"
 Q ""
 ;Continue Directory Search
ContDir(D) Q "РЕЖИМ ПОКА НЕ ЭМУЛИРОВАН"
 Q
Ver() N S1,S2 Q $$ANSI^%ZAPM.bs.BSre($$version)  ;Get MS-DOS Version Number
version() ; Get DOS Version
  n a,file
  s file="ver"
  s $zt="version1"
  o file:"rq":0 i '$t g version1
  u file r a,a
version1 c file
  d del(file)
versionq q a
 
EXE(EXE) I $zf(-1,EXE)
 Q
SysVer() N F,S //ПОЛУЧИТЬ ВЕРСИЮ ОПЕРАЦИОННОЙ СИСТЕМЫ
 I $ZV["Linu" S F="uname -a"
 E  S F="ver"
 S F=$$exec(F,1)
 S S=$TR($$GetFileSize(F,32000),$C(13,10))
 D del(F)
 Q $$ANSI^%ZAPM.bs.BSre(S)
exec(exec,out) ; Executable string
  i out d  q file
  .;l +^%dosfile
  . s file=$$TEMPDIR^%ZAPM.bs.BSCF1_"BS"_$TR($G(%BS(3),$P),":|,","")_$J_".tmp"
  . s x=$zf(-1,exec_" > "_file)
  i 'out d
  . s x=$zf(-1,exec)
execq q
lspc  ; Strip leading spaces
  i $e(a,1)=" " s a=$e(a,2,$l(a)) g lspc
lspcq  q
 ////////////////////////////////////////////////////////////////
 
 
test0 //пример нового доступа к внешней таблицы ODBC
 
 
 ////////////////////////////////////////////////////////////////
 S dsn="NuSphere"
 s BSUsEr="root"
 S BSPsWrD=""
 S sql="SELECT * FROM e107_user"
 //S IF="1 S Break=(ii>1)"
 s TG="^sss"
 d Read(dsn,sql,$G(IF),,TG) ;НОВЫЙ БОЛЕЕ ПРАВИЛЬНЫЙ АНАЛОГ D Read^%ZAPM.bs.BSCG
 I $D(Errors) W !,Errors ;ПОСМОТРЕТЬ ОШИБКИ
 I $G(TG)'="" D ^%ZAPM.bs.BSMSMG(TG) ;ВОЙТИ В РЕДАКТОР МАССИВОВ
 q
test1 M MM=^sss(4,1) D STR2MAS^%ZAPM.bs.BSCmail(.MM,.MMM,$C(13,10)) K ^ss M ^ss=MMM
	Q
test2 K MM M MM=^sss(4,1) D Arr2File^%ZAPM.bs.BSCEXE(.MM,"N:\1")
	Q
Read(DSN,SQL,IF,ErV,TG) ;ЧТЕНИЕ ТАБЛИЦЫ В МАССИВ TG
ReadInt	d ReadSql(DSN,$G(BSUsEr),$G(BSPsWrD),SQL,TG,IF,$G(ErV))
	q
ReadSql(dsn,login,pswd,sql,vcol,IF,ErV) ;ЧТЕНИЕ ТАБЛИЦЫ В МАССИВ TG
 n stmt,con,sc,ncols,i,ii,idRec,v,ColsInfo,Break
 //код для совместимости со старыми программами
 i $G(ErV)'=0 S ErV=1  // ErV=1 ;ВСЕ СООБЩЕНИЯ БУДУТ НАХОДИТСЯ В ПЕРЕМЕННОЙ Errors
 K Errors
 S $ZT="Dis"
 I $G(vcol)'="" K @vcol S @vcol@(-1)=sql
 I $G(IF)'="" I $G(vcol)'="" S @vcol@(-2)=IF
 //
 S con=##Class(%SQLGatewayConnection).%New()
 S sc=con.Connect(dsn,login,pswd)
 s sc=con.AllocateStatement(.stmt)
 I +sc'=1 d Er g Dis
 S sc=con.Prepare(stmt,sql)
 I +sc'=1 d Er g Dis
 S sc=con.Execute(stmt)
 S sc=con.DescribeColumns(stmt,.ColsInfo)
 S ncols=$LI($LI(ColsInfo,1),1)
 ;W "ncols=",ncols,! //количество колонок
 I ncols<1  d Er g Dis
 d hdr
 S ii=0  //счетчик записей
 for  {
	s sc=con.Fetch(stmt)
	I +sc'=1 Q  //дошли до конца
	S ii=ii+1
	for i=1:1:ncols S v="" S sc=con.GetData(stmt,i,1,.v) d
	.s @vcol@(ii,i)=$e(v,1,31743) i $l(v)>31743 D
	..f i1=1:1 q:$e(v,31743)=""  S sc=con.GetData(stmt,i,1,.v) s @vcol@(ii,i,i1)=$e(v,1,31743)
	i $G(IF)'="" x "I "_IF //логика внутри цикла
	I $G(Break) Q  //прерывание перебора - Break создался внутри IF
 }
Dis D con.Disconnect()
 Q
Er do DecomposeStatus^%apiOBJ(sc,.Errors) i $g(ErV)'=1 zw Errors
 q
hdr //информация по полям и заголовке БД
 ;S w(1)=10,w(2)=9,w(3)=11,w(4)=8,w(5)=5,w(6)=12,w(7)=11,w(8)=4
 ;S x(1)=0 for i=2:1:8 S x(i)=x(i-1)+w(i-1) 
 ;W ?x(1),"Name" 
 ;W ?x(2),"SQL type" 
 ;W ?x(3),"Size"
 ;W ?x(4),"Dec dig"
 ;W ?x(5),"Null" 
 ;W ?x(6),"Datype"
 ;W ?x(7),"Dis sz" 
 ;W ?x(8),"Currency",!
 for i=1:1:ncols {
   S ColInfo=$LI(ColsInfo,i+1)
   s @vcol@(0,i)=$LI(ColInfo,1)
   ;for i1=1:1:7 W ?x(i1),$LI(ColInfo,i1)
 }	 
 Q
 
%GOF(IO,glovec,desc) //OUT
 N IOT,IOPAR          ;S IO="C:\FILENAME.GOF",
 S IOT="RMS",IOPAR="" ;,glovec("%A")="",glovec("%B")="",desc="description"
 Q $$entry^%GOF(.glovec,desc) ;W !,"Globals exported successfully" Q
 
%GIF(IO) ;IN
 ;S IO="C:\FILENAME.GOF"
 N IOT S IOT="RMS" 
 Q $$entry^%GIF() ;W !,"Globals imported successfully" Q
 
ASYS4 ;Кривошеев С.А.;Системные процедуры и функции;;[ 23/10/2003 8:54 ]
Ri(File,Typ)                           ; * Импорт программ *
 N case
 ; File  - имя файла
 ; Fetch - строка шаблон
 s Typ=$g(Typ,"Cache")
 s File=File_":(""RU"")"
 S case=$$rload^%Wr(File,Typ,0,2,1,0,0,0)
 Q case
Ro(File,Name,Type,Descrip)             ; * Экспорт программ *
 N case,type,name
 ; File    - имя файла
 ; Name    - имя переменной со списком программ @Name@(i)="rtn.INT"
 ; Type    - тип программ INT, MAC, OBJ
 ; Descrip - коментарий
 S Name=$G(Name)
 S Type=$G(Type,"INT")
 S Descrip=$G(Descrip)
 S name=$NA(^%utility($J))
 I Name'="" K @name M @name=@Name
 S type="Cache"
 S:Type="OBJ" type="Object"
 S case=$$rsave^%Wr(Type,File_":(""NW"")",Descrip,type,0,0,1)
 Q case
FetchR(Fetch,Name,Type)                ; * Выбрать программы по шаблону *
 N case,name,nam,i
 ; Fetch - Строка шаблон "rtn,a*,'ab,'ac"
 ; Name  - имя переменной результата
 ; Type  - переделывать результат в @Name@(i)=rtn или оставить @Name@(rtn)=""
 S Fetch=$G(Fetch,"*")
 S Name=$G(Name)
 S Type=$G(Type,1)
 K:Name'="" @Name
 S name=$NA(^%utility($J))
 K @name
 S case=$$rsel^%Wr(Fetch)
 Q:'case 0
 I Type=0 M:Name'="" @Name=@name K:Name'="" @name Q case
 S:Name="" Name=name
 S nam=""
 F  S nam=$O(@name@(nam)) Q:(nam="")!(+nam=nam)  S @Name@($I(i))=nam K @name@(nam)
 K:Name'=name @name
 Q case
Gi(File,Fetch,Scr)                     ; * Импорт глобалов тип 5 Cache *
 N case,name,IO
 ; File  - имя файла
 ; Fetch - строка шаблон "^glb"_$C(13,10)_"^tmp*"
 ; Scr   - вывод на экран
 S Fetch=$G(Fetch,"*")
 S Scr=$G(Scr,0)
 S IO=Scr
 S case=$$main^%Wgr(File_":(""VR"")",5,Fetch,0,0,0)
 Q case
Go(File,Name,Rm,Scr)                   ; * Экспорт глобала тип 5 Cache *
 N case,name,IO,RM
 ; File  - имя файла
 ; Name  - имя переменной со списком глобалов @Name@(i)="^tmp(1,2"
 ; Rm    - 
 ; Scr   - вывод на экран
 S Name=$G(Name)
 S Rm=$G(Rm,80)
 S Scr=$G(Scr,0)
 S name=$NA(^%utility($J))
 M:Name'="" @name=@Name
 S IO=Scr
 S RM=Rm
 S case=$$main^%Wgs(File_":(""VNW"")",5,"",0,0)
 Q case
Gif(File,Del,Fetch,Name,Scr)           ; * Импорт глобалов тип 7 Cache Block *
 N case,name,IO
 ; File  - имя файла
 ; Del   - удалять глобалы
 ; Fetch - строка шаблон "^glb"_$C(13,10)_"^tmp*"
 ; Name  - имя переменной со списком глобалов @Name@("glb")=""
 ; Scr   - вывод на экран
 S Fetch=$G(Fetch,"*")
 S Name=$G(Name)
 S Scr=$G(Scr,0)
 S Del=$G(Del,1)
 S name=$NA(^%utility($J))
 S IO=Scr
 D Gif1
 Q:case=0 0
 D:Del Gif2
 S case=$$main^%Wgr(File_":(""RU"")",7,Fetch,0,0,0)
 Q case
Gif2                                   ; удаление глобалов
 N var,nam
 S var=""
 F  S nam=$O(@name@(var)) Q:var=""  S nam="^"_var K @nam
 Q
Gif1                                   ; прочитать заголовок из файла
 N i,r
 S case=$$header^%Wgr(File_":(""UR"")",7,0)
 Q:case=0
 I Name'="" Q:Name=1  K @name M @name=@Name Q
 S case=$P(case,$C(22,35,1),2)
 K @name
 S r=$C(19,94,1)
 F i=1:1:$L(case,r)-1 S @name@($P(case,r,i))=""
 Q
Gof(File,Comment,Name,Scr)             ; * Экспорт глобалов тип 7 Cache Block *
 N case,name,IO
 ; File    - имя файла
 ; Comment - строка коментария к данным
 ; Name    - имя переменной со списком глобалов @Name@(i)="^glb"
 ; Scr     - вывод на экран
 S Comment=$G(Comment)
 S Name=$G(Name)
 S Scr=$G(Scr,0)
 S name=$NA(^%utility($J))
 M:Name'="" @name=@Name
 S IO=Scr
 S case=$$main^%Wgs(File_":(""WNU"")",7,Comment,0,0)
 Q case
GoMSM(Fetch,File,Scr)                  ; * Экспорт глобалов в формате %GS MSM *
 n ok,name,glb,i
 s Scr=$g(Scr,1)
 s File=$$FOpen^ASYS(File)
 i File="" q:$q 0 q
 s ok=$$FetchG(Fetch)
 i 'ok q:$q 0 q
 S name=$NA(^%utility($J))
 w:Scr !,"Запись глобалов",!
 d BEGTXT
 s i=0
 s glb=""
 f  s glb=$o(@name@(glb)) q:glb=""  d NEWGLB
 d END("**")
 c File
 w !,"Запись завершена! Записан(о) ",i," глобал(а)"
 q:$q 1
 q
BEGTXT                                 ; Начальный текст
 n txt
 s txt=$$Time^zfunc()_" "_$$Date^zfunc()_" OOO NTC Air, 2003"
 d USE^ASYS3(File)
 w txt,!
 w "",!
 d USE^ASYS3()
 q
NEWGLB                                 ; Очередной глобал
 n uz,val
 s i=i+1
 s uz=@name@(glb)
 w $$PadR^zfunc(uz,10)
 s val=$d(@uz)
 i (val=1)!(val=11) d W(uz)
 f  s uz=$q(@uz) q:uz=""  d W(uz)
 d END("*")
 q
END(Txt)                               ; Записать концовку
 d USE^ASYS3(File)
 w Txt,!
 w Txt,!
 d USE^ASYS3()
 q
W(Name)                                ; Запись узла
 d USE^ASYS3(File)
 w Name,!
 w @Name,!
 d USE^ASYS3()
 q
FetchG(Fetch,Name,Type)                ; * Выбрать глобалы по шаблону *
 N count,name,i,nam
 ; Fetch - Строка шаблон "glb;a*;'ab;'ac"
 ; Name  - имя переменной результата
 ; Type  - переделывать результат в @Name@(i)=glb или оставить @Name@(glb)=""
 S Fetch=$G(Fetch,"*")
 S Name=$G(Name)
 S Type=$G(Type,1)
 K:Name'="" @Name
 S name=$NA(^%utility($J))
 K @name
 S count=$$Fetch^%GD(Fetch,1,0)
 I $I=2 K ^%utility("SPOOL")
 Q:'count 0
 I Type=0 M:Name'="" @Name=@name K:Name'="" @name Q count
 S:Name="" Name=name
 S nam=""
 F  S nam=$O(@name@(nam)) Q:(nam="")!(+nam=nam)  S:$D(@nam) @Name@($I(i))=nam K @name@(nam)
 K:Name'=name @name
 Q count 
 //----------------------------
 /*Сначала насчет хелпа :)
Все системные утилитки ^%W* являются недокументированными и НЕ
предназначены для прямого использования (писаны они как ответная часть
виндовых утилит) Но так как до 5-й версии нет (или я не нашел)
системных утилит для использования из под программ на COS (%RI и %RO
не считаются - т.к. они сугубо интерактивные), то приходится
разбираться с исходниками ^%W* и огромное спасибо ИнтерСистемз за то
что они оставили их открытыми!
Собственно эти исходники и являются единственным ХЕЛПОМ для меня :)
 
Теперь насчет импорта:
Есть аналогичная точка входа в ^%Wr
но с ней НЕ так все просто так как нет возможности в программе
получить список возникших ошибок при компиляции загружаемых программ!
Ее можно только заставить вывалить уведомления на текущее устройство
но для использования в программе сие не годится!
На всякий случай все таки приведу мое описание этой функции:
 
(Всё IMHO)
 
$$rload^%Wr(file,format,selection,over,compile,syntax,backup,showstat,langmode,pasting)
где:
file - по аналогии с rsave: "диск:/путь/файл:(""RS"")" (вместо RS в
       принципе м.б. другие параметры открытия файла)
format - Формат импорта ("Cache","DTM","DSM","Object","ISM","MSM",и.т.д)
selection - 0-все проги из файла
            1-поименным списком (список в ^%utility($j,Имя,Тип)=""
                                 где Имя - имя программы
                                     Тип - "INT","MAC","BAS" и т.д.)
            2-по списку масок   (список в ^%utility($j,Тип,i)=маска
                                 где Тип - "INT","MAC","BAS" и т.д.
                                     i - 1,2,3,...
                                     маска - "=имя" - эквивалентность
                                             "?шаблон" - соотв.М-шаблону
                                             "имя1:имя2" - диапазон)
over - 0 - не перезаписывать существующие
       1 - делать запрос на перезапись (не подходит !!!)
       2 - всегда перезаписывать существующие
compile - 0 - не компилировать а только загрузить тексты
          1 - компилировать при загрузке
syntax - ??? не используется ???
backup - 1 - создавать резервную копию
         0 - не создавать
showstat - 1 - показывать ход выполнения (write на $p -устройство)
           0 - не показывать ход выполнения
langmode - Языковый режим компиляции:("Cache","DSM-11","DTM","Ipsum","Cobra","DSM-VMS","MSM" и т.д.)
pasting - 0 !
 
 
Ну и типа пример: :-)
 s x=$$rload^%Wr("e:/cache5/viewsc.rsa:(""RS"")","Cache",0,2,1,0,0,0,"Cache")
 
 */
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCF1" type="MAC" languagemode="0"><![CDATA[
%BSCF1 ; пpогpамма ФУНКЦИЙ ; 13:37   12.09.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
As2An(Sours) ;ПЕРЕКОДИРОВКА ;трансляциЯ из ASCII в ANSI ; 14:21 26-SEP-97
 I '$D(As2An1) D INIT^%ZAPM.bs.BSre(1) S As2An1=S1,As2An2=S2
 Q $TR(Sours,As2An1,As2An2)
CELL(G,Y,FORX,ANSI,DEL)
 N VALUE,S1,S2,As2An1,As2An2
 I '$$Data^%ZAPM.bs.BSF12(G) Q ""
 S DEL=$G(DEL,$C(1))
 S VALUE="" I $G(ANSI) D  Q VALUE
 .D INIT^%ZAPM.bs.BSre(1) S As2An1=S1,As2An2=S2
 .X "F X="_FORX_" S VALUE=VALUE_$TR($P($G(@G@(Y,X)),""@"",15),As2An1,As2An2)_DEL"
 X "F X="_FORX_" S VALUE=VALUE_$P($G(@G@(Y,X)),""@"",15)_DEL"
 Q VALUE
TEMPDIR() ;ВОЗВРАТИТЬ ДИРЕКТОРИЮ ДЛЯ ВРЕМЕННЫХ ФАЙЛОВ
 Q $$TEMPDIR^%ZAPM.bs.BSpgBS
OpenFile(N,M) ;ОТКРЫТЬ ФАЙЛ
 I M="R" O N:("RW"):3 E  Q 0
 I M="W" O N:("WNS"):3 E  Q 0
 ;I M="A" O N:(/WRITE:/APPEND):3 E  Q 0 ;"ДОПИСАТЬ"
 I M="A" O N:("WAS"):3 E  Q 0 ;"ДОПИСАТЬ"
 S %DEV=N
 Q 1
Open(N,M) ;ОТКРЫТЬ ФАЙЛ
 S DOS=0
 I M="R" O N:("RW"):3 E  D ErO Q -1
 ;I M="A" O N:(/WRITE:/APPEND):3 E  D ErO Q -1   ;"ДОПИСАТЬ"
 I M="A" O N:("WAS"):3 E  D ErO Q -1
 I M="W" O N:("WNS"):3 E  D ErO Q -1
 S DOS=N
 Q 0
ErO u $P d ErrMsg^%ZAPM.bs.BSXfun(" Не могу откpыть файл "_N_" ") Q
WEBROOT() N D
 S D=$$GETOPT^%ZAPM.bs.BSC4cfg($$MainOpt^%ZAPM.bs.BSC4,"TempDir2") //???ПОКА ТАК
 ;S D=$G(^%ZAPM.bs.BSC("WWWROOT"))
 I D="" Q ""
 I $$exists^%ZAPM.bs.BSCEXE(D) Q D
 Q ""
UpWEB(G) ;WEB INSTALLING
 N D,F,S,I,II S D=$$WEBROOT() I D="" Q 0
 I $$DelFile^%ZAPM.bs.BSCEXE(D_"\BS-WEB.BAT")
 S F=D_"\BS-WEB.BAT" I '$$OpenFile(F,"W") Q 0
 U F W $P(D,":",1)_":",!,"CD \",!,"CD ",$P(D,":",2),!,"BS-WEB.EXE -Y",!,"DEL BS-WEB.EXE",!,"DEL BS-WEB.PIF",!,"DEL BS-WEB.BAT",!
 C F
 I $$DelFile^%ZAPM.bs.BSCEXE(D_"\BS-WEB.PIF")
 S S=@G@(0),F=D_"\BS-WEB.PIF" I '$$OpenFile(F,"W") Q 0
 U F W S C F
 I $$DelFile^%ZAPM.bs.BSCEXE(D_"\BS-WEB.EXE")
 S F=D_"\BS-WEB.EXE" I '$$OpenFile(F,"W") Q 0
 S I=0 U F F  S I=$O(@G@(I)) Q:I=""  W @G@(I)
 C F D EXE^%ZAPM.bs.BSCEXE(D_"\BS-WEB.BAT")
 S F=D_"\BS\BS.GIF" I '$$OpenFile(F,"R") Q 0
 C F Q 1
UpDFLT(G) ;УСТАНОВКИ
 N S,SS,I,II,III,IIII D ROU(G,1) Q
ROU(G,F) S S="",III=0,IIII=1 K @G@("ROU") F I=1:1 Q:'$D(@G@(I))  D
 .S S=S_@G@(I) F II=1:1:$L(S,$C(13,10))-1 S SS=$P(S,$C(13,10),II) D:'(I=1&(II<3))
 ..I SS="" S III=0,IIII=IIII+1 Q
 ..S III=III+1,@G@("ROU",IIII,III)=SS
 .S S=$P(S,$C(13,10),II+1)
 G:$G(F) CacheGR S SS="ZR  F I=1:1 Q:'$D(@G@(""ROU"",I))  X III ZS @NAME ZR  ",IIII="S NAME=$P(@$ZR,""."")"
 S III="F II=1:1 Q:'$D(@G@(""ROU"",I,II))  X:II=1 IIII ZI:II'=1 @$ZR:+(II-2)" X SS K @G
 Q
CacheGR ;Restore Globals in Cache' Object
 D NaSET^%ZAPM.bs.BSZRO,ACT
 D NaGET^%ZAPM.bs.BSZRO
 Q
CacheSET(S,SS) S $ZT="CacheERS^"_$ZN
 S @S=SS
 Q
CacheERS ;ОШИБКА
 S ^mtempBSerror(0)=$G(^mtempBSerror(0))+1
 S ^mtempBSerror(^mtempBSerror(0),"R")=S
 S ^("V")=SS,^("E")=$ZE
 Q
ACT S NewG="" K ^mtempBSerror
 F I=1:1 Q:'$D(@G@("ROU",I))  F II=1:2 Q:'$D(@G@("ROU",I,II))  D
 .S S=@G@("ROU",I,II),SS=$G(@G@("ROU",I,II+1))
 .I NewG'=$P(S,"(") S NewG=$P(S,"(") I $E(NewG,1,4)="^%ZAPM.bs.BS"&($E(NewG,1,7)'="^%ZAPM.bs.BSbuf") K @NewG
 .D CacheSET(S,SS)
 K @G I $D(^mtempBSerror) S ^mtempBSerror=$$ESDAY^%ZAPM.bs.BSsFUNR(6,$H) ;Date for Cache'
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCF2" type="MAC" languagemode="0"><![CDATA[
%BSCF2 ; пpогpамма длЯ ИМПОРТА ИЗ Cache' В EXCEL ; 16:41   06.03.2000
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
DIR Q
TableString(G,Y,FORX,ANSI,DEL)
 N VALUE,S1,S2,As2An1,As2An2
 I '$$Data^%ZAPM.bs.BSF12(G) Q -1 ;ПОЛНАЯ ССЫЛКА НА ТАБЛИЦУ
 I '$D(@G@(Y)) Q -2 ;ТАКОЙ СТРОКИ НЕТ
 S DEL=$G(DEL,$C(1)) ;РАЗДЕЛИТЕЛЬ
 S VALUE="" I $G(ANSI) D  Q VALUE ;НАДО ПЕРЕКОДИРОВАТЬ
 .D INIT^%ZAPM.bs.BSre(1) X "F X="_FORX_" S VALUE=VALUE_$TR($P($G(@G@(Y,X)),""@"",15),S1,S2)_DEL"
 X "F X="_FORX_" S VALUE=VALUE_$P($G(@G@(Y,X)),""@"",15)_DEL"
 Q VALUE
TextString(G,FORY,ANSI,DEL)
 N VALUE,S1,S2,As2An1,As2An2
 I '$$Data^%ZAPM.bs.BSF12(G) Q -1 ;ПОЛНАЯ ССЫЛКА НА ТЕКСТ
 I '$D(@G@(Y)) Q -2 ;ТАКОЙ СТРОКИ НЕТ
 S DEL=$G(DEL,$C(1)) ;РАЗДЕЛИТЕЛЬ
 S VALUE="" I $G(ANSI) D  Q VALUE ;НАДО ПЕРЕКОДИРОВАТЬ
 .D INIT^%ZAPM.bs.BSre(1) X "F Y="_FORY_" S VALUE=VALUE_$TR($G(@G@(Y)),S1,S2)_DEL"
 X "F Y="_FORY_" S VALUE=VALUE_$G(@G@(Y))_DEL"
 Q VALUE
]]></Routine>


<Routine name="%ZAPM.bs.BSCG" type="MAC" languagemode="0"><![CDATA[
%BSCG ; пpогpамма SQL-Gate ; 10:19   19.10.2001
 ;===================================================================
 ;| Пример для зимней школы 1999 тема SqlGate                       |
 ;|                                           ;Н.Жохов              |
 ;| loaddll       загрузить dll библиотеку                          |
 ;| freedll       выгрузить dll библиотеку                          |
 ;| connect                                                         |
 ;| disconnect                                                      |
 ;| Create        создать таблицу                                   |
 ;| Populate      создать экзмпляры записей                         |
 ;| Select        Сделать выборку                                   |
 ;| TableCatalog(mode)                                              |
 ;| TableColumn                                                     |
 ;| ProcCatalog                                                     |
 ;| CallProc      Вызов хранимой процедуры                          |
 ;===================================================================
 Q
T2 S DNS="TDBF" G 1
T1 ;ТЕСТ
 N Errors,DNS,SQL,IF,ErV,TG,Break,Return
 ;---ИМЯ DNS
 S DNS="KSP"
1 ;---ЗАПРОС К БАЗЕ
 ;S SQL="SELECT nwc, snaim FROM knh WHERE nwc LIKE '3%' AND snaim LIKE '1%' AND TRUE"
 ;S SQL="SELECT Knh.NWC, Knh.SNAIM, KPD.HAR, KPD.IMJ FROM Knh LEFT JOIN KPD ON Knh.KPD = KPD.KPD WHERE (((Knh.NWC) Like '6%') AND ((KPD.IMJ) Like 'Мо%'));"
 S SQL="SELECT * FROM TEL"
 ;---ФОРМУЛА ДОПОЛНИТЕЛЬНОЙ ВЫБОРКИ ИЗ РЕЗУЛЬТАТОВ ВЫБОРКИ
 ;d - СТРОКА ЗАПИСИ РЕЗУЛЬТАТА ВЫБОРКИ  $LI(d,5) - ЗНАЧЕНИЕ 5 ПОЛЯ
 ;ЕСЛИ ПРИСВОИТЬ Break=1 , ТО ПЕРЕБОР ВЫБОРКИ ПРЕРВЕТСЯ
 S IF="$E($LI(d,1),1)'=0" ;"I $LI(d,1)=""3657"" S Break=1,Return=$LI(d,2)"
 ;---ПОДАВЛЯТЬ ВЫВОД СООБЩЕНИЙ ОБ ОШИБКАХ НА ТЕКУЩЕЕ УСТРОЙСТВО (КОНСОЛЬ)
 S ErV=1 ;ВСЕ СООБЩЕНИЯ БУДУТ НАХОДИТСЯ В ПЕРЕМЕННОЙ Errors
 ;---МАССИВ В КОТОРЫЙ ЗАПИСАТЬ РЕЗУЛЬТАТЫ ВЫБОРКИ, ИНАЧЕ ВСЕ ВЫВЕДЕТСЯ НА КОНСОЛЬ
 S TG="" ;"TEMPO"
 D Read(DNS,SQL,IF,ErV,TG)
 I $D(Errors) W !,Errors ;ПОСМОТРЕТЬ ОШИБКИ
 I $G(TG)'="" D ^%ZAPM.bs.BSMSMG(TG) ;ВОЙТИ В РЕДАКТОР МАССИВОВ
 Q
 
Read(DSN,SQL,IF,ErV,TG) ;выполнение запроса и результат положить В МАССИВ TG
 ;@TG@(-2)=IF - логика ограничения выполнения перебора полученного результата
 ;@TG@(-1)=SQL
 ;@TG@(0,number_field)=ИМЯ ПОЛЯ
 ;@TG@(number_record,number_field)=ЗНАЧЕНИЕ ПОЛЯ
 ;@TG@(number_record,number_field,k)=если ЗНАЧЕНИЕ ПОЛЯ больше 31k
 g ReadInt^%ZAPM.bs.BSCEXE //НОВЫЙ КОД
 N hstmt,e,ColInfo,ncol,d,i,sql,rc,ColName,hdbc,Break
 K Errors
 S $ZT="ERG^%ZAPM.bs.BSCG"
 I $G(TG)'="" K @TG S @TG@(-1)=SQL
 I $G(IF)'="" D  I $G(TG)'="" S @TG@(-2)=IF
 . ;ПРОВЕРИТЬ СИНТАКСИС У IF
 d loaddll(),connect(DSN,$G(BSUsEr),$G(BSPsWrD))
 d Select(SQL,$G(IF),$G(TG))
 d disconnect,freedll
 Q
ERG D EW($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) Q
intDSN(DSN,USER,PASS) ; ИНФОРМАЦИЯ ПО DSN --> WEBSQL
 N I,II,i,ii,ErV,%,d,e,hdbc,iName,iType,name,rc
 S ErV="1 "
 S WEBSQL=DSN D iDSN(DSN,$G(USER),$G(PASS))
 Q
iDSN(DSN,USER,PASS) ; ИНФОРМАЦИЯ ПО DSN
 d loaddll(),connect(DSN,$G(USER),$G(PASS)) I hdbc'=0 D
 .;d TableCatalog(1) ;СТРУКТУРА НО НЕ ТА...
 .d TableCatalog(0) ; КАКИЕ ТАМ ТАБЛИЦЫ
 .d disconnect
 D freedll
 Q
iTAB(DSN,tbl,USER,PASS) ;ИНФОРМАЦИЯ ПО ТАБЛИЦЕ !!!!! НЕ РАБОТАЕТ
 d loaddll(),connect(DSN,$G(USER),$G(PASS)) I hdbc'=0 D
 .D TableColumn(tbl)
 .d disconnect
 D freedll
 Q
iSQL(DSN,tbl,USER,PASS) ;ВЫПОЛНЕНИЕ ПОЛНОЙ ВЫБОРКИ ИЗ ТАБЛИЦЫ
 d loaddll(),connect(DSN,$G(USER),$G(PASS)) I hdbc'=0 D
 .d Select("SELECT * FROM "_tbl,"","")
 .d disconnect
 D freedll
 Q
 
TEST(DSN) ;ТЕСТ С DSN-СОЕДИНЕНИЕМ
 d loaddll(),connect(DSN)
 ;d CreateTable
 d Populate
 d Select("SELECT * FROM TEST","","")
 ;d TableCatalog(1)
 ;d TableCatalog(0)
 d disconnect,freedll
 Q
 ;===================================================================
loaddll(DIR) ;ЗАГРУЗИТЬ DLL
 S %=$ZF(-3,$G(DIR,$P($$defdir^%GLO("%SYS"),"\mgr")_"\bin\cgate.dll"),"Connect","","","") Q
freedll ;ОСВОБОДИТЬ DLL
 S %=$ZF(-3,"") Q
 ;===================================================================
CreateTable ; Создание таблицы TEST
 N hstmt,e
 S hstmt=$ZF(-3,"","AllocStatement",hdbc) I hstmt=0 W "can't alloc statement",!
 S sql="CREATE TABLE TEST (A1 VARCHAR(50), A2 VARCHAR(50))"
 S e=$ZF(-3,"","Prepare",hstmt,sql) I e'=0 D Err(e),DropStatement(hstmt) Q
 S e=$ZF(-3,"","Execute",hstmt) I e'=0 D Err(e),DropStatement(hstmt) Q
 S e=$ZF(-3,"","DropStatement",hstmt) D Err(e)
 Q
 ;===================================================================
 ; Заполнение данными таблицы TEST
 ; Для таких утверждений удобнее работать с параметрами
Populate
 S hstmt=$$AllocStatement I hstmt=0 Q
 S sql="INSERT INTO TEST (A1,A2) VALUES (?, ?)"
 ;S sql="INSERT INTO TEST (A1,A2) VALUES (""ZZZ"", ""QQQ"")"
 S e=$ZF(-3,"","Prepare",hstmt,sql) I e'=0 D Err(e),DropStatement(hstmt) Q
 ;S e=$ZF(-3,"","Execute",hstmt) I e'=0 B
 ;Q
 S pdtl=$LB(50,50)
 S pdt=$LB(12,12)
 S ps=$LB(0,0)
 S piot=$LB(1,1) ; in=1, in/out =2, out=4
 S ppr=$LB(50,50)
 S e=$ZF(-3,"","BindParameters",hstmt,pdtl,pdt,ps,piot,ppr) I e'=0 W "Bind failed",! D Err(e),DropStatement(hstmt) Q
 D new("AA","X")
 D new("AB","X")
 D new("BA","X")
 D new("BB","X")
 D DropStatement(hstmt)
 Q
new(a1,a2)
 S e=$ZF(-3,"","SetParameter",hstmt,$LB(a1),1) I e'=0 B
 S e=$ZF(-3,"","SetParameter",hstmt,$LB(a2),2) I e'=0 B
 S e=$ZF(-3,"","Execute",hstmt) I e'=0 B
 Q
 ;===================================================================
DeleteTable ;
 N hstmt,e
 S hstmt=$ZF(-3,"","AllocStatement",hdbc) I hstmt=0 W "can't alloc statement",! Q
 S sql="DROP TABLE TEST"
 S e=$ZF(-3,"","Prepare",hstmt,sql) I e'=0 D Err(e),DropStatement(hstmt) Q
 S e=$ZF(-3,"","Execute",hstmt) I e'=0 D Err(e),DropStatement(hstmt) Q
 D DropStatement(hstmt)
 Q
 ;===================================================================
 ; показать таблицы в Источнике Данных
TableCatalog(mode)
 N hstmt,e,i,ncol,ColInfo
 S hstmt=$$AllocStatement I hstmt=0 Q
 
 S e=$ZF(-3,"","Tables",hstmt,"","","","") I e'=0 D Err(e),DropStatement(hstmt) Q
 
 S ColInfo=$ZF(-3,"","DescribeColumns",hstmt)
 
 ; показать имена столбцов используемых
 ; для описания запроса списка таблиц
 I $G(mode)=1 D ShowResSetStruc(ColInfo) D DropStatement(hstmt) Q
 
 S ncol=$LI($LI(ColInfo,1),1)
 
 ; найти индексы столбцов имени и типа таблицы
 F i=1:1:ncol D
 .S d=$LI(ColInfo,i+1)
 .S name=$LI(d,1)
 .I $ZCONVERT(name,"U")="TABLE_NAME" S iName=i
 .I $ZCONVERT(name,"U")="TABLE_TYPE" S iType=i
 .S WEBSQ(0,i)=name
 I $D(WEBSQL) S WEBSQL(0,1)="TABLE NAME",WEBSQL(0,2)="TYPE"
 E  W "TABLE NAME",?20,"TYPE",! W $TR($J("",30)," ","-"),!
 F i=1:1 S rc=$ZF(-3,"","Fetch",hstmt) Q:rc'=0  D
 .S d=$ZF(-3,"","GetOneRow",hstmt) I d="" Q
 .I $D(WEBSQL) D
 ..I $D(iName) S WEBSQL(i,1)=$LI(d,iName)
 ..I $D(iType) S WEBSQL(i,2)=$LI(d,iType)
 ..F ii=1:1:ncol D
 ...S WEBSQ(i,ii)=$LI(d,ii)
 .E  W $LI(d,$G(iName,1)),?20,$LI(d,$G(iType,2)),!
 D DropStatement(hstmt)
 Q
ShowResSetStruc(ColsDef)
 N i,n
 S n=$LI($LI(ColsDef,1),1)
 D ShowColDef("ColName","SQLtype","Prcs","Scale","Nulb","dtype","Display","$")
 W $TR($J("",79)," ","-"),!
 F i=1:1:n D
 .S d=$LI(ColsDef,i+1)
 .D ShowColDef($LI(d,1),$LI(d,2),$LI(d,3),$LI(d,4),$LI(d,5),$LI(d,6),$LI(d,7),$LI(d,8))
 Q
ShowColDef(a1,a2,a3,a4,a5,a6,a7,a8)
 W a1
 W ?20,a2
 W ?33,a3
 W ?39,a4
 W ?45,a5
 W ?50,a6
 W ?65,a7
 W ?75,a8
 W !
 Q
 ;===================================================================
 ; показать столбцы и их свойства для таблицы с именем tbl
TableColumn(tbl)
 N hstmt,e,i,d,ncol,ColInfo,rc
 
 S hstmt=$$AllocStatement I hstmt=0 Q
 S e=$ZF(-3,"","Columns",hstmt,"","","X%","A1") I e'=0 D Err(0),DropStatement(hstmt) Q
 
 S ColInfo=$ZF(-3,"","DescribeColumns",hstmt)
 
 ; показать имена столбцов используемых
 ; для описания запроса списка столбцов таблицы
 I 0 D ShowResSetStruc(ColInfo) D DropStatement(hstmt) Q
 
 N iName,iTypeId,iTypeName,iPrec,iLen,iScale,iNull
 N xName,xTypeId,xTypeName,xPrec,xLen,xScale,xNull
 S xName=0
 S xTypeId=xName+20
 S xTypeName=xTypeId+5
 S xPrec=xTypeName+10
 S xLen=xPrec+5
 S xScale=xLen+7
 S xNull=xScale+15
 
 S ncol=$LI($LI(ColInfo,1),1)
 F i=1:1:ncol D
 .S d=$LI(ColInfo,i+1)
 .S name=$LI(d,1)
 .I name="COLUMN_NAME" S iName=i
 .I name="DATA_TYPE" S iTypeId=i
 .I name="TYPE_NAME" S iTypeName=i
 .I name="PRECISION" S iPrec=i
 .I name="LENGTH" S iLen=i
 .I name="SCALE" S iScale=i
 .I name="NULLABLE" S iNull=i
 
 W ?xName,"NAME",?xTypeId,"TID",?xTypeName,"TNAME"
 W ?xPrec,"PREC",?xLen,"LEN",?xScale,"SCALE"
 W ?xNull,"NULL",!
 W $TR($J("",79)," ","-"),!
 
 F  S rc=$ZF(-3,"","Fetch",hstmt) Q:rc'=0  D
 .S d=$ZF(-3,"","GetOneRow",hstmt) I d="" Q
 .W ?xName,$LI(d,iName),?xTypeId,$LI(d,iTypeId),?xTypeName,$LI(d,iTypeName)
 .W ?xPrec,$LI(d,iPrec),?xLen,$LI(d,iLen),?xScale,$LI(d,iScale)
 .W ?xNull,$LI(d,iNull)
 .W !
 D DropStatement(hstmt)
 Q
 ;===================================================================
 ; Сделать запрос и показать результаты
Select(sql,IF,TG)
 N ColInfo,hstmt,ncol,d,i,rc,ColName
 S hstmt=$$AllocStatement I hstmt=0 Q
 S e=$ZF(-3,"","Prepare",hstmt,sql) I e'=0 D Err(0),DropStatement(hstmt)
 S e=$ZF(-3,"","Execute",hstmt) I e'=0 D Err(0),DropStatement(hstmt)
 
 S ColInfo=$ZF(-3,"","DescribeColumns",hstmt)
 I ColInfo="" D EW("Результат запроса пустой") D DropStatement(hstmt) Q
 S ncol=$LI($LI(ColInfo,1),1) ;КОЛИЧЕСТО КОЛОНОК
 
 F i=1:1:ncol D
 .S d=$LI(ColInfo,i+1)
 .S ColName(i)=$LI(d,1) ;ИМЕНА ПОЛЕЙ
 
 I $G(TG)="" D
 .F i=1:1:ncol W ?15*(i-1),ColName(i)            ;ЗАСВЕТИТЬ ШАПКУ
 .W !,$TR($J("",79)," ","-")
 I $G(TG)'="" F i=1:1:ncol S @TG@(0,i)=ColName(i)
 
 S ii=0
 ;ЦИКЛ ПО ОТКРЫТОМУ КУРСОРУ
 F  S rc=$ZF(-3,"","Fetch",hstmt) Q:rc'=0  D  I $G(Break) Q  ;ПРЕРВАТЬ ПЕРЕБОР
 .S d=$ZF(-3,"","GetOneRow",hstmt) I d="" Q  ;ТЕКУЩАЯ ЗАПИСЬ
 .I $G(IF)'="" X "I "_IF E  Q
 .S ii=ii+1 I $G(TG)="" W !
 .F i=1:1:ncol D
 ..I $G(TG)="" W ?15*(i-1),$LI(d,i) Q        ;КОЛОНКИ
 ..S @TG@(ii,i)=$LI(d,i)
 D DropStatement(hstmt)
 Q
 ;===================================================================
ShowResultSet(hstmt)
 N ColInfo
 S ColInfo=$ZF(-3,"","DescribeColumns",hstmt)
 I ColInfo="" W "No Result",! Q
 
 S ncol=$LI($LI(ColInfo,1),1)
 
 F i=1:1:ncol D
 .S d=$LI(ColInfo,i+1)
 .S ColName(i)=$LI(d,1)
 
 F i=1:1:ncol W ?15*(i-1),ColName(i)
 W !
 W $TR($J("",79)," ","-"),!
 
 F  S rc=$ZF(-3,"","Fetch",hstmt) Q:rc'=0  D
 .S d=$ZF(-3,"","GetOneRow",hstmt) I d="" Q
 .F i=1:1:ncol W ?15*(i-1),$LI(d,i)
 .W !
 Q
 ;===================================================================
 ; Просмор каталога процедур
ProcCatalog(mode)
 N name,x,hdr,i,ncol,x
 
 S hstmt=$$AllocStatement I hstmt=0 Q
 S e=$ZF(-3,"","DescribeProcedures",hstmt,"","","")
 
 S ColInfo=$ZF(-3,"","DescribeColumns",hstmt)
 
 ; показать структуру запроса списка процедур
 I +$G(mode)=1 D ShowResSetStruc(ColInfo) D DropStatement(hstmt) Q
 
 S ncol=$LI($LI(ColInfo,1),1)
 ;S ncol=3
 F i=3:1:ncol D
 .S d=$LI(ColInfo,i+1)
 .S hdr(i)=$LI(d,1)
 .I i>3,$P($LI(d,1),"_",2)'="" S hdr(i)=$P($LI(d,1),"_",2)
 .S x(i)=$S(i=3:0,i=4:25,1:$L(hdr(i-1))+1)+$S(i=3:0,1:x(i-1))
 .W ?x(i),hdr(i)
 
 W !,$TR($J("",79)," ","-"),!
 
 F  S rc=$ZF(-3,"","Fetch",hstmt) Q:rc'=0  D
 .S d=$ZF(-3,"","GetOneRow",hstmt) I d="" Q
 .F i=3:1:ncol D
 ..S v=$LI(d,i) I v="<NULL DATA>" S v="<NULL>"
 ..W ?x(i),v
 .W !
 D DropStatement(hstmt)
 Q
 
 ;===================================================================
ProcPar
 Q
 ;===================================================================
CallProc
 N hstmt,sql,e
 S hstmt=$$AllocStatement I hstmt=0 Q
 S sql="CALL DemoQuery_Qy1( '1', '2' )"
 S e=$ZF(-3,"","Prepare",hstmt,sql) I e'=0 D Err(e),DropStatement(hstmt) Q
 S e=$ZF(-3,"","Execute",hstmt) I e'=0 D Err(e),DropStatement(hstmt) Q
 D ShowResultSet(hstmt)
 D DropStatement(hstmt)
 Q
 ;===================================================================
AllocStatement()
 S hstmt=$ZF(-3,"","AllocStatement",hdbc)
 I hstmt=0 D EW("can't alloc statement")
 Q hstmt
 ;===================================================================
DropStatement(hstmt)
 S e=$ZF(-3,"","DropStatement",hstmt)
 Q
 ;===================================================================
connect(dsn,user,pswd)
 S hdbc=$ZF(-3,"","Connect",$G(dsn),$G(user),$G(pswd))
 I hdbc=0 D EW("Connection failor !")
 Q
 ;===================================================================
disconnect
 S e=$ZF(-3,"","Disconnect",hdbc)
 D Err(e)
 Q
 ;===================================================================
EW(V) ;СООБЩЕНИЕ О ОШИБКЕ
 I $D(ErV) S Errors=$G(Errors)_V_". "_$C(13,10) Q
 W V_". ",! Q
ErrWas
 N e S e=$ZF(-3,"","WasError") I e=0 Q
 I e=-1000 D EW("SqlGate error") Q
 I e'=-1 Q
 N el S el=$ZF(-3,"","GetSqlErrors",+$G(hdbc),+$G(hstmt))
 N l S l=$LL(el)
 N i F i=1:1:l D EW($LI(el,i))
 Q
 ;===================================================================
Err(e)
 I e=0 Q
 I e=-1000 D EW("SqlGate error") Q
 I e'=-1 D EW("Other error") Q
 N el S el=$ZF(-3,"","GetSQLErrors",+$G(hdbc),+$G(hstmt))
 N l S l=$LL(el)
 N i F i=1:1:l D EW($LI(el,i))
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCG1" type="MAC" languagemode="0"><![CDATA[
%BSCG1 ; пpогpамма НА ПРАВАХ ПРИМЕРА ПОИСКОВОГО МОДУЛЯ ; 20:09   18.09.2000
 Q     ;ПЛОХОЕ РЕШЕНИЕ, НО РАБОТАЕТ...  ХОРОШЕЕ СМОТРИ %BSCG2
 ;KNH.DBF  SNAIM - СОКР. НАИМЕНОВАНИЕ ВЧ
 ;         NWC - НОМЕР ВЧ
 ;         KPD - КОД ДИСЛОКАЦИИ
 ;         IMG - ПОЛНОЕ НАИМЕНОВАНИЕ ВЧ
 ;KPD.DBF  KPD - САМ КОД
 ;         HAR - ХАРАКТЕРИСТИКА НАСЕЛЕННОГО ПУНКТА
 ;         IMJ - НАИМЕНОВАНИЕ
 ;
 ;!!! НЕ ЗАБУДЬТЕ СДЕЛАТЬ !..
 ;ОПРЕДЕЛИТЕ  DNS="KSP" В CONTROL PANEL -- ODBC DRIVERS
 ;S ^MGWAPP("SAMPLE_KSP")=MAIN^%ZAPM.bs.BSCG1
 ;ВЫЗОВ http://cacheserver/scripts/mgwms32.dll?MGWAPP=SAMPLE_KSP
 ;
FIRST ;ПЕРВАЯ СТРАНИЦА
 D VAR^%ZAPM.bs.BSCh
 D FORM^%ZAPM.bs.BSCh
 W "<P><strong>ВВЕДИТЕ КОНТЕКСТ ПОИСКА  </strong>"
 w "<input type=""submit"" value="" Искать"" name=""FIND1"">"
 W "<input type=""reset"" value="" Очистить текстовые поля"" name=""FIND2"">"
 w "<input type=""hidden"" name=""MGWAPP"" value=""SAMPLE_KSP""></P>"
 w BK,"<table border=""0"">",BK
 w "<tr>",BK
   w "<td align=""right""><strong>Номер В/Ч (4цифры)</strong></td>",BK
   w "<td><input type=""text"" name=""NWC"" size=""17"">"
   W "</td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>Действительное наименование</strong></td>",BK
   w "<td><input type=""text"" name=""IMJ"" size=""17"">"
   W "</td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>Дислокация</strong></td>",BK
   w "<td><input type=""text"" name=""DIS"" size=""17"">"
   W "</td>",BK
 w "</tr>"
 w "</table>",BK
 W "</FORM>"
 Q
MAIN ;ГОЛОВНАЯ ПРОГРАММА - ДИСПЕТЧЕР
 I $G(%KEY("FIND1"))'="" G FIND
 G FIRST
FIND ;ИСКАТЬ...
 N Errors,DNS,ErV,Break,Return,SQL,IF,TK,TD,TempK,TempD,KDS,KDS1
 D VAR^%ZAPM.bs.BSCh
 I $G(%KEY("NWC"))="",$G(%KEY("IMJ"))="",$G(%KEY("DIS"))="" W "ВСЕ ПОЛЯ ПУСТЫЕ !" Q
 S (Z1,Z2)=""
 I $G(%KEY("NWC"))'="" S Z1="nwc LIKE '"_$G(%KEY("NWC"))_"%' AND "
 I $G(%KEY("IMJ"))'="" S Z2="snaim LIKE '"_$G(%KEY("IMJ"))_"%' AND "
 S TK="TempG",TD="TempD"
 I Z1="",Z2="" G DISL
 
 S SQL="SELECT nwc, snaim, kpd FROM knh WHERE "_Z1_" "_Z2_" TRUE"
 S IF="$LI(d,3)'="""" S KDS1($LI(d,3))=1"
 D Read^%ZAPM.bs.BSCG("KSP",SQL,IF,1,TK) I $D(Errors) W !,Errors Q
 I '$D(@TK) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I '$D(@TK@(1)) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I $G(%KEY("DIS"))'="" G DISL1
 
 S SQL="SELECT kpd, har, IMJ FROM kpd WHERE HAR IS NOT NULL AND ("
 S I="" F  S I=$O(KDS1(I)) Q:I=""  S SQL=SQL_" KPD='"_I_"' OR "
 S SQL=SQL_" FALSE)" K KDS1
 S IF="$LI(d,1)'="""" S KDS($LI(d,1))=$LI(d,2)_$LI(d,3)"
 D Read^%ZAPM.bs.BSCG("KSP",SQL,IF,1,TD) I $D(Errors) W !,Errors Q
TAB D TABL1 S II=""
 F I=1:1 Q:'$D(@TK@(I))  D
 .w "<tr>",BK
 .w "<td>",$G(@TK@(I,1)),"</td>"
 .w "<td>",$G(@TK@(I,2)),"</td>"
 .w "<td>" D  W II,"</td>"
 ..I $G(KDS($G(@TK@(I,3),0)))'="" S II=$G(KDS($G(@TK@(I,3),0))) Q
 ..S II="???"
 .w "</tr>"
 D TABL2
 Q
DISL1 ;ДИСЛОКАЦИЯ
 ;Q
DISL ;ДИСЛОКАЦИЯ
 S SQL="SELECT kpd, har, IMJ FROM kpd WHERE HAR IS NOT NULL AND IMJ LIKE '"_$G(%KEY("DIS"))_"%'"
 S IF="$LI(d,1)'="""" S KDS($LI(d,1))=$LI(d,2)_$LI(d,3)"
 D Read^%ZAPM.bs.BSCG("KSP",SQL,IF,1,TD) I $D(Errors) W !,Errors Q
 I '$D(@TD) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I '$D(@TD@(1)) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 K @TD
 S SQL="SELECT nwc, snaim, kpd FROM knh WHERE NWC IS NOT NULL AND ("
 S I="" F  S I=$O(KDS(I)) Q:I=""  S SQL=SQL_" KPD='"_I_"' OR "
 S SQL=SQL_" FALSE)"
 S IF="$E($LI(d,1),1)'=0"
 I $D(KDS1) S IF=IF_" I $D(KDS1($LI(d,3)))" D
 .I $G(%KEY("IMJ"))'="" S IF=IF_",$E($LI(d,2),1,"_$L(%KEY("IMJ"))_")="""_$G(%KEY("IMJ"))_""""
 .I $G(%KEY("NWC"))'="" S IF=IF_",$E($LI(d,1),1,"_$L(%KEY("NWC"))_")="""_$G(%KEY("NWC"))_""""
 D Read^%ZAPM.bs.BSCG("KSP",SQL,IF,1,TK) I $D(Errors) W !,Errors Q
 I '$D(@TK) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I '$D(@TK@(1)) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 G TAB
TABL1 ;НАЧАТЬ ТАБЛИЦУ
  w BK,"<table border=""1"">",BK
 w "<tr>",BK
   w "<td align=""right""><strong>Номер В/Ч (4цифры)<BR>'"_$G(%KEY("NWC"))_"'</strong></td>",BK
   w "<td align=""right""><strong>Действительное наименование<BR>'"_$G(%KEY("IMJ"))_"'</strong></td>",BK
   w "<td align=""right""><strong>Дислокация<BR>'"_$G(%KEY("DIS"))_"'</strong></td>",BK
 w "</tr>"
 Q
TABL2 ;ЗАКОНЧИТЬ
 w "</table>",BK
 Q
 /////////////////////////////////////////////////////////////////////////////////// NEW
 /////////////////////////////////////////////////////////////////////////////////// 
A1 W "<TITLE>НАЧАЛО НОВОГО ПОИСКА КСП</TITLE>"_BK
 w "<FRAMESET rows='60%,10%,*'  >"_BK
 w "<FRAME SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"AR^%ZAPM.bs.BSCG1")_"' NAME='ARH' frameborder=0 SCROLLING=AUTO >"_BK
  w "<FRAME SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"AF^%ZAPM.bs.BSCG1")_"' NAME='FIN' frameborder=0 >"_BK
   w "<FRAME SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"AN^%ZAPM.bs.BSCG1")_"' NAME='NAST' frameborder=0 SCROLLING=AUTO>"_BK
 w "</FRAMESET>"
 Q
ARHIV
AR D BEG1^%ZAPM.bs.BSC4
 I '$D(BSPATT) W "Здесь будет архив искомого ксп" G AR0
 W BSPATT
 S TK="TempG",TD="TempD"
 S IF="1"
 D Read^%ZAPM.bs.BSCG("KSP","SELECT KSP,NKSP,KVD,KPD,KNP,IMJ_D,IMJ_P,IMJ_B,IMJ_R,NPR,DPR,DIZ FROM ArxKsp WHERE KSP LIKE '"_BSPATT_"%'",IF,1,TK) I $D(Errors) W !,Errors Q
  I '$D(@TK) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I '$D(@TK@(1)) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 D TAB^%ZAPM.bs.BSCGH(TK)
AR0 D END^%ZAPM.bs.BSC4
 Q
AF D BEG1^%ZAPM.bs.BSC4
 w "<BODY BGCOLOR=Dodgerblue "_$$27_" onload='F3.patternstr.focus();'>"_BK_$$js^%ZAPM.bs.BSCp_$$Status^%ZAPM.bs.BSCm4("введите контекст поиска. {Esc} - отмена, закрыть окно. {F5} - обновить окно")_$$jse^%ZAPM.bs.BSCp_BK
 W "<CENTER><TABLE BORDER=0><TR><TD>"
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" name=F3 target='NAST' method=""POST"">"_BK
 S BSLABEL="AN^~BSCG1"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 w "Введите начальные цифры КСП <INPUT TYPE=text TITLE='Контекст поиска' size=32 name=patternstr >&nbsp;"
 w "<BUTTON title='поиск начать' TYPE=SUBMIT VALUE='Искать' NAME=F1><img src='"_BSDOMAIN_"/img/find.gif'></BUTTON>&nbsp;"
 W "</FORM></TD>"_BK
 W "</TR><TABLE></CENTER>"_BK
 D END^%ZAPM.bs.BSC4
 Q
27() Q " onkeyPress='javascript: if (27 == event.keyCode) parent.window.close();' "
FINDSTRCONV(S)
 Q $TR(S,"FDULTPBQRKVYJGHCNEAWXIOSMZf,dult`;pbqrkvyjghcnea[wxio]sm'.z","АВГДЕЗИЙКЛМНОПРСТУФЦЧШЩЫЬЯабвгдеёжзийклмнопрстуфхцчшщъыьэюя")
AN D BEG1^%ZAPM.bs.BSC4
 ;SELECT MAX(DAT) As DATA1 FROM Knh_a
 w "<BODY bgcolor=Lightgrey "_$$27_">"_BK
 I $G(patternstr)="" W "Контекст пустой",BK G AN0
 s BSPATT=$$FINDSTRCONV($G(patternstr))
 S TK="TempG",TD="TempD"
 S SQL="SELECT MAX(DAT) As Last_Data FROM Knh_a"
 S IF="1"
 D Read^%ZAPM.bs.BSCG("KSP",SQL,IF,1,TK) I $D(Errors) W !,Errors Q
 S MAXDAT=$E(@TK@(1,1),9,10)_"."_$E(@TK@(1,1),6,7)_"."_$E(@TK@(1,1),1,4)
 D TAB^%ZAPM.bs.BSCGH(TK)
 I '$D(@TK) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I '$D(@TK@(1)) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 S LD=$G(@TK@(1,1)) I LD="" W !,"ДАТА ПУСТАЯ" Q 
 D Read^%ZAPM.bs.BSCG("KSP","SELECT KSP,SNM,DAT,KNH,KPD,OKATO,KNP FROM Knh_a WHERE (KSP LIKE '"_BSPATT_"%') AND (DAT LIKE '"_MAXDAT_"')",IF,1,TK) I $D(Errors) W !,Errors Q
 D TAB^%ZAPM.bs.BSCGH(TK)
 W BK_$$js^%ZAPM.bs.BSCp D  W $$jse^%ZAPM.bs.BSCp_BK 
 .W "parent.ARH.location='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"ARHIV^%ZAPM.bs.BSCG1")_"';"_BK
 ;D locvar^%ZAPM.bs.BSCh0("",1)
AN0
 D END^%ZAPM.bs.BSC4
 Q  
]]></Routine>


<Routine name="%ZAPM.bs.BSCG2" type="MAC" languagemode="0"><![CDATA[
%BSCG2 ; пpогpамма НА ПРАВАХ ПРИМЕРА ПОИСКОВОГО МОДУЛЯ (АНАЛОГ ASP :-) ; 16:06   16.10.2000
 Q     ;ХОРОШЕЕ РЕШЕНИЕ НЕ В ПРИМЕР %BSCG1
 ;KNH.DBF  SNAIM - СОКР. НАИМЕНОВАНИЕ ВЧ
 ;         NWC - НОМЕР ВЧ
 ;         KPD - КОД ДИСЛОКАЦИИ
 ;         IMG - ПОЛНОЕ НАИМЕНОВАНИЕ ВЧ
 ;KPD.DBF  KPD - САМ КОД
 ;         HAR - ХАРАКТЕРИСТИКА НАСЕЛЕННОГО ПУНКТА
 ;         IMJ - НАИМЕНОВАНИЕ
 ;
MAIN ;ГОЛОВНАЯ ПРОГРАММА - ДИСПЕТЧЕР
 I $G(%KEY("FIND1"))'="" G FIND
 G FIRST
 ;!!! НЕ ЗАБУДЬТЕ СДЕЛАТЬ !..
 ;ОПРЕДЕЛИТЕ  DSN="KSP" В CONTROL PANEL -- ODBC DRIVERS DBase IV
 ;S ^MGWAPP("KSP")="MAIN^%ZAPM.bs.BSCG2"
 ;ВЫЗОВ http://webserver/scripts/mgwms32.dll?MGWAPP=KSP
 ;
FIRST ;ПЕРВАЯ СТРАНИЦА
 D VAR^%ZAPM.bs.BSCh
 D FORM^%ZAPM.bs.BSCh
 W "<P><strong>ВВЕДИТЕ КОНТЕКСТ ПОИСКА  </strong>"
 w "<input type=""submit"" value="" Искать"" name=""FIND1"">"
 W "<input type=""reset"" value="" Очистить текстовые поля"" name=""FIND2"">"
 w BK,"<table border=""0"">",BK
 w "<tr>",BK
   w "<td align=""right""><strong>Номер В/Ч (4цифры)</strong></td>",BK
   w "<td><input type=""text"" name=""NWC"" size=""17"">"
   W "</td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>Действительное наименование</strong></td>",BK
   w "<td><input type=""text"" name=""IMJ"" size=""17"">"
   W "</td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>Дислокация (например:Саров)</strong></td>",BK
   w "<td><input type=""text"" name=""DIS"" size=""17"">"
   W "</td>",BK
 w "</tr>"
 w "</table>",BK
 W "</FORM>"
 Q
FIND ;ИСКАТЬ...
 N Errors,DNS,ErV,Break,Return,SQL,IF,TK,TD,TempK,TempD,KDS,KDS1,I,II
 D VAR^%ZAPM.bs.BSCh
 I $G(%KEY("NWC"))="",$G(%KEY("IMJ"))="",$G(%KEY("DIS"))="" W "ВСЕ ПОЛЯ ПУСТЫЕ !" Q
 F I="NWC" I $G(%KEY(I))'="",$L($G(%KEY(I)))<2 W "ДЛИНА СТРОКИ КОНТЕКСТА<BR>ДОЛЖНА БЫТЬ БОЛЬШЕ ОДНОГО СИМВОЛА!" S II=1 Q
 I $G(II) Q
 S (Z1,Z2,Z3)=""
 I $G(%KEY("NWC"))'="" S Z1="((KNH.nwc) LIKE '"_$G(%KEY("NWC"))_"%') AND "
 I $G(%KEY("IMJ"))'="" S Z2="((KNH.SNAIM) LIKE '"_$G(%KEY("IMJ"))_"%') AND "
 I $G(%KEY("DIS"))'="" S Z3="((KPD.IMJ) LIKE '"_$G(%KEY("DIS"))_"%') AND "
 S TK="TempG"
 S SQL="SELECT Knh.NWC, Knh.SNAIM, KPD.HAR, KPD.IMJ"
 S SQL=SQL_" FROM Knh LEFT JOIN KPD ON Knh.KPD = KPD.KPD"
 S SQL=SQL_" WHERE ((KNH.NWC IS NOT NULL) AND (KNH.NWC NOT LIKE '0%') AND "_Z1_" "_Z2_" "_Z3_" TRUE)"
 ;W !,SQL,BK
 D Read^%ZAPM.bs.BSCG("KSP",SQL,"",1,TK) I $D(Errors) W !,"<PRE>",Errors,"</PRE>" Q
 I '$D(@TK) W !,"РЕЗУЛЬТАТ ВЫБОРКИ ПУСТОЙ" Q
 I '$D(@TK@(1)) W !,"РЕЗУЛЬТАТ ВЫБОРКИ СОВСЕМ ПУСТОЙ" Q
TAB D TABL1
 F I=1:1 Q:'$D(@TK@(I))  D
 .w "<tr>",BK
 .w "<td>",$G(@TK@(I,1)),"</td>"
 .w "<td>",$G(@TK@(I,2)),"</td>"
 .w "<td>",$G(@TK@(I,3))_$G(@TK@(I,4)),"</td>"
 .w "</tr>"
 D TABL2
 Q
TABL1 ;НАЧАТЬ ТАБЛИЦУ
  w BK,"<table border=""1"">",BK
 w "<tr>",BK
   w "<td align=""right""><strong>Номер В/Ч (4цифры)<BR>'"_$G(%KEY("NWC"))_"'</strong></td>",BK
   w "<td align=""right""><strong>Действительное наименование<BR>'"_$G(%KEY("IMJ"))_"'</strong></td>",BK
   w "<td align=""right""><strong>Дислокация<BR>'"_$G(%KEY("DIS"))_"'</strong></td>",BK
 w "</tr>"
 Q
TABL2 ;ЗАКОНЧИТЬ
 w "</table>",BK
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCGH" type="MAC" languagemode="0"><![CDATA[
%BSCGH ; пpогpамма SQL-Gate HTML ; 14:56   06.11.2001
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
 ;         !!! НЕ ЗАБУДЬТЕ СДЕЛАТЬ !..
 ;ОПРЕДЕЛИТЕ  DSN В CONTROL PANEL -- ODBC DRIVERS
 ;
 ;ВЫЗОВ /scripts/mgwms32.dll?BSG=SQL
 ;
HELP d InfoSess^%ZAPM.bs.BSC4rout Q
TITLE W "<TITLE>%BS++SQL - Менеджер</TITLE>" Q
 //N FN S FN="C:\CacheSys\Docs\sqr\SQLReference.html"
 //I $$OpenFile^%ZAPM.bs.BSCF1(FN,"R") W "<H7><A HREF=""C:\CacheSys\Docs\sqr\SQLReference.html"">© 2001 Документация по Cache'SQL</H7>"
 //W "<BR><BR><A HREF=""/BS/DEVELOPER.htmL"">" D END^%ZAPM.bs.BSCh("") W "</A>"
 Q
MAINVAR ;ОСНОВНЫЕ ПЕРЕМЕННЫЕ
 I '$D(%BS(1)) D %BS1^%ZAPM.bs.BSF4
 I '$D(GREEN) D VAR^%ZAPM.bs.BSCh
 S MainRef="MAIN^~BSCGH" ;ОСНОВНОЙ ВХОД <---------------------
 S MainTabl="^%ZAPM.bs.BSC(""HTML"")" ;ТАБЛИЦА ОСНОВНЫХ ПАРАМЕТРОВ
 //S CurUS=$$ADDRIP^%ZAPM.bs.BSC4
 //S %BS(CurUS)=$P($G(%KEY("BSUSER"),"?"),",")
 Q
SQLJ S BSLABEL="MAIN^~BSCGH" N BSDSN
 W "<table border=0 width=100%><tr><td align='center' width=10% class=s1><a class=u1 href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' ><img border=no src='"_$G(BSDOMAIN,"/b4y")_"/img/bssql.jpg' ALT='"_$$LNG^%ZAPM.bs.BSC4("Загрузить SQL менеджер")_"'></a>"
 W "</td><td width=90% align='center' class=s1 wi><h3>Менеджер SQL запросов</h3>формируемых к DSN (ODBC Data sources name) сервера '"_RED_$ZU(110)_EF_"'"
 w "</td></tr></table>"
 Q
IFNODSN() S DSN=$S($G(BSDSN)="":$G(LDSN),1:$G(BSDSN))  
 I $G(BSdsn)'="" S DSN=BSdsn
  I $G(DSN)="" D FORMDSN Q 1
 Q 0
MAIN ;ОСНОВНОЙ ВХОД <---------------------
 D MAINVAR
 ;РЕГИСТРАЦИЯ ОБЯЗАТЕЛЬНА
 ;I $G(%KEY("BSUSER"),"GUEST")="GUEST" D REGIST Q
 ;I '$$PASS^%ZAPM.bs.BSChh() D REGIST Q
 //S %BS(CurUS)=$P($G(%KEY("BSUSER"),"?"),",")
MAINR ;ДАЛЬШЕ
 D MGR^%ZAPM.bs.BS ;ПЕРЕЙТИ В СИСТЕМНУЮ ОБЛАСТЬ
 //S %KEY("BSG")="SQL"
 //I $D(%KEY("BSLABEL")) S ROU=$$%^%ZAPM.bs.BSCh(%KEY("BSLABEL")) D @ROU Q
 N I,II,NS,P1,P9,BUFG,nI,BDSN
 I $$IFNODSN Q
 D BEG1^%ZAPM.bs.BSC4,TITLE
 D WDSN
 D SQLJ
 D 
 .N BSDSN S BSLABEL="MAIN^~BSCGH"
 .w "<A href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>Назад, определить DSN</A>"_BBK
 N WEBSQL,I,II,i,ii,WEBSQL1
 S WEBSQL=DSN D iDSN^%ZAPM.bs.BSCG(DSN,$G(BSuser),$G(BSpass)) //открыть DSN
 ;S I="" F  S I=$O(WEBSQL(I)) Q:I=""  I $G(WEBSQL(I,2))="TABLE" S WEBSQL1(I,1)=1
 ;S I="" F  S I=$O(WEBSQ(I)) Q:I=""  I $G(WEBSQ(I,2))="TABLE_NAME" S WEBSQL1(I,1)=1
 i $O(WEBSQL(""))="" w RED,"<br>DSN:"_DSN_" - пуст или не существует!",EF,"<BR>" D HELP Q
 ;D TAB("WEBSQL","WEBSQL1")
 ;ZW WEBSQ
 D TAB("WEBSQ","WEBSQL1")
 S BDSN=$$KBDG("^%ZAPM.bs.BSC(""BSQLDSN"")") I BDSN'="" D
 .I $D(WEBSQL),$O(WEBSQL(""))'="" S @BDSN@($G(CurUS,"DSN"),DSN)="" Q
 .K @BDSN@($G(CurUS,"DSN"),DSN)
 ;W "<PRE>" W WEBSQ W "</PRE>"
 D HELP Q
SQLGO ;ВОЗВРАТИТЬ ТАБЛИЦУ
 I $$IFNODSN Q
 D BEG1^%ZAPM.bs.BSC4,TITLE
 D WDSN
 D SQLJ
 S SQL=$G(mBSQL1)
 S TABLE=$G(TABLE)
 D
 .N BSDSN S BSLABEL="MAIN^~BSCGH"
 .w "<A href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>Назад, определить DSN</A> "_BBK
 S BSLABEL="MAIN^~BSCGH"
 w "<A href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&BSDSN="_DSN_"'>Назад, в список таблиц DSN:"_DSN_"</A>"_BBK
 S BSLABEL="SQL^~BSCGH"
 w "<A href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&TABLE="_TABLE_"&BSDSN="_DSN_"'>Назад, в конструктор SQL-запросов</A> "_BBK
 I SQL="" W "SQL - ЗАПРОС ПУСТОЙ !" Q
 W "Результат SQL - запроса: "_RED_SQL_EF_"<BR>",BK
 N I,II,i,ii,WEBSQL1,IF,TG,Break,BSDN
 S TG=$G(BSTG1,"WEBSQL") K @TG
 S STR=$G(BSTR1,10)
 S IF="1 S Break=(ii>"_STR_")"
 D Read^%ZAPM.bs.BSCG(DSN,SQL,$G(IF),,TG) ;ЧТЕНИЕ ТАБЛИЦЫ В МАССИВ TG
 D TAB(TG)
 S BDSN=$$KBDG("^%ZAPM.bs.BSC(""BSQLDSN"")") I BDSN'="" D
 .S I=$O(@BDSN@("SQL",""),-1)+1,@BDSN@("SQL",I,"SQL1")=SQL
 .I I>$$0^%ZAPM.bs.BSCh(30) S I=$O(@BDSN@("SQL","")) K @BDSN@("SQL",I)
 D HELP
 Q
WDSN     W "<h3>Информация по DSN: "_DSN_"</H3>" 
	Q
sample() n q s q="<HR>Пример ODBC доступа из СУБД Cache' на языке Cache Object Script:<PRE>"_BK
	s q=q_RED_"D Read^%ZAPM.bs.BSCG("""_DSN_""","""_sQL_""",1,,""^mtemple"")"_EF_" ;ЧТЕНИЕ ТАБЛИЦЫ В МАССИВ ^mtemple"_BK
	S q=q_"где: """_DSN_""" - имя DSN источник данных ODBC"_BK
	S q=q_""""_sQL_""" - SQL утверждение"_BK
	S q=q_"^mtemle(0,1...n) - имена полей результат выполнения SQL утверждение. n - количество колонок"_BK
	S q=q_"^mtemle(r,1...n) - значения данных в полях. r - номер записи"_BK
	q q_"</PRE>"_BK
SQL ;ОПРЕДЕЛИТЬ ЗАПРОС
 I $$IFNODSN Q
 I $G(TABLE)="" D FORMDSN Q
 N I,II,NS,P1,P9,BUFG,nI
 D BEG1^%ZAPM.bs.BSC4,TITLE D WDSN D SQLJ
 S BSLABEL="MAIN^~BSCGH"
 w "<A href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&BSDSN="_DSN_"'>Назад, в список таблиц</A> "
 W "<form NAME='FORMSQL' action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" TARGET='sqlresult'>"
 N mBSQL1,BSTG1,BSTR1
 S BSLABEL="SQLGO^~BSCGH"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<P>"
 w "<input type=""submit"" value="" Выполнить SQL-запрос "" name=""FIND1"">",BK
 ;W "<input type=""reset"" value="" Очистить "" name=""FIND2"">",BK
 //w "<input type=""hidden"" name=""BSROU"" value=""MAIN^~BSCGH"">",BK
 //w "<input type=""hidden"" name=""BSLABEL"" value=""SQLGO^~BSCGH"">",BK
 //w "<input type=""hidden"" name=""BSG"" value=""SQL""></P>",BK
 w "<input type=""hidden"" name=""DSN"" value="""_DSN_"""></P>",BK
 w "<input type=""hidden"" name=""TABLE"" value="""_$G(%KEY("TABLE"))_"""></P>",BK
 w BK,"<table border=""0"">",BK
 w "<tr>",BK
   w "<td align=""right""><strong>Текст SQL-запроса </strong></td>",BK
   w "<td><textarea rows=""4"" name=mBSQL1 cols=""70"">" D  W "</textarea>"
   .S sQL="SELECT * FROM "_$S($G(%KEY("BSOWNER"))'="":$G(%KEY("BSOWNER"))_".",1:"")_$G(%KEY("TABLE")) W sQL
   W "</td>",BK
 w "</tr>"
 w "<tr>",BK
  w "<td align=""right"">История запросов" 
  //W "<INPUT TYPE=""button"" VALUE=""'History' Запросов"" onClick=""SetHistory();"">"
  W "</td>",BK
  w "<td>"
  W "<p><select name=""HSQL"" onchange=""javascript:mBSQL1.value=HSQL.value; T1.focus();"" size=""1"">",BK
  W "<option value="""" SELECTED > </option>",BK
 S BDSN=$$KBDG("^%ZAPM.bs.BSC(""BSQLDSN"")") I BDSN'="" D
 .S I="" F  S I=$O(@BDSN@("SQL",I),-1) Q:I=""  S II=$G(@BDSN@("SQL",I,"SQL1")) W "<option " W " value="""_II_""">"_II_"</option>",BK
 W "</select></td>",BK
 W "</tr>"
 w "<tr>",BK
   w "<td align=right><strong>Пользователь</strong></td>"_BK
   w "<td><input type=text name=BSUsEr size=13 VALUE='"_$g(BSuser)_"'></td>"_BK
 w "</tr>"
 w "<tr>",BK
   w "<td align=right><strong>Пароль</strong></td>"_BK
   w "<td><input type=text name=BSPsWrD size=7 VALUE='"_$g(BSpass)_"'></td>"_BK
 w "</tr>"
 w "<tr>",BK
   w "<td align=""right""><strong>Сколько строк<BR>вывести</strong></td>",BK
   w "<td><input type=""text"" name=""BSTR1"" size=""7"" VALUE=100></td>",BK
 w "</tr>"
 w "<tr>",BK
   w "<td align=""right""><strong>Имя временного<BR>массива</strong></td>",BK
   w "<td><input type=""text"" name=""BSTG1"" size=""12"" VALUE='WEBSQL'></td>",BK
 w "</tr>"
 w "<tr>",BK
   w "<td align=""right""><strong>Выводить результат<BR>в браузер</strong></td>",BK
   w "<td><input type=""checkbox"" name=""BSCBX"" CHECKED VALUE='1'></td>",BK
 w "</tr>"
 w "</table>",BK
 W "</FORM>"
 W BK,"<SCRIPT LANGUAGE=""JavaScript""><!--"_BK
 W "function SetHistory() {"_BK
 //W "alert(111);"_BK
 W "FORMSQL.mBSQL1.value=FORMSQL.HSQL.value;",BK
 W "}//--></SCRIPT>",BK
 W $$sample_BK
 D HELP Q
KBDG(A) ;ВОЗВРАТИТИТЬ ССЫЛКУ
 N BDSN S BDSN=$$KBD^%ZAPM.bs.BSF12(A) I BDSN'="" I $$Data^%ZAPM.bs.BSF12(BDSN) Q BDSN
 Q ""
FORMDSN ;ПЕРВАЯ СТРАНИЦА
 N I
 D BEG1^%ZAPM.bs.BSC4,TITLE,SQLJ
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="MAIN^~BSCGH"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<P>"
 w "<input type=""submit"" value="" Затребовать информацию по DSN "" name=""FIND1"">",BK
 W "<input type=""reset"" value="" Очистить "" name=""FIND2"">",BK
 //w "<input type=""hidden"" name=""BSROU"" value=""MAIN^~BSCGH"">",BK
 //w "<input type=""hidden"" name=""BSG"" value=""SQL""></P>",BK
 w BK,"<table border=""0"">",BK
 /*w "<tr>",BK
   w "<td align=""right""><strong>Новый 'Data Source Name'</strong></td>",BK
   w "<td><input type=""text"" name=""BSDSN"" size=""17""></td>",BK
 w "</tr>" */
 N LD,svc //СПИСКИ DSN
 D DSNLIST1
 i '$D(LD) S BDSN=$$KBDG("^%ZAPM.bs.BSC(""BSQLDSN"")") I BDSN'="",$O(@BDSN@(""))'="" S I="" F  S I=$O(@BDSN@($G(CurUS,"DSN"),I)) Q:I=""  S LD(I)="" 
 D
 .w "<tr>",BK
 .w "<td align=""right""><strong>Выберите источник ODBC</strong></td>",BK
 .w "<td>"
 .W "<p><select name=""LDSN"" size=""1"">",BK
 .S I="" F  S I=$O(LD(I)) Q:I=""  W "<option " W " value="""_I_""">"_I_"</option>",BK
 .W "<option value="""" SELECTED > </option>",BK
 .W "</select></TD></TR>"
 .W "<TR><TD align=""right"">или DSN:</TD><TD><INPUT type=""text"" name=""BSdsn"" size=""17""></TD></TR>"
 .W "<TR><TD align=""right"">Имя пользователя</TD><TD><INPUT type=""text"" name=""BSuser"" size=17 ></TD></TR>"
 .W "<TR><TD align=""right"">а также пароль, если нужно:</TD><TD><INPUT type=""text"" name=""BSpass"" size=17 ></TD></TR>"
 .w BK
 w "</table>",BK
 W "</FORM>"
 D HELP Q
DSNLIST1 D DSNLIST
 i $D(svc) S I="" D  I 1
 .F  S I=$O(svc(I)) Q:I=""  I "/ODBC Data Sources/ODBC File DSN/"'[("/"_I_"/") S LD(I)=""
 Q
DSNLIST    S $ZT="DNSPerr"
    I $ZV'["Windows" Q
    d GetKeyNames^%zekreg("HKLM","SOFTWARE\ODBC\ODBC.INI",$na(svc))
 Q
DNSPerr Q
testODBC() N LD,svc,I D DSNLIST1 S I="" F  S I=$O(LD(I)) Q:I=""  I I["Samples" Q
 q "http://"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_":81/test/testODBC.php?resourceName="_I
TAB(TK,SK) ;ЗАСВЕТИТЬ ТАБЛИЦУ
 N I,II,AAA,BSOWNER
 D TABL1
 S BSLABEL="SQL^~BSCGH" 
 S I="-1" F  S I=$O(@TK@(I)) Q:I=""  D
 .w "<tr>",BK
 .S II="" F  S II=$O(@TK@(I,II)) Q:II=""  D
 ..w "<td class=s"_$S(I=0:4,1:2)_">" D
 ...I I=0 D  w $G(@TK@(I,II)) Q
 ....I $ZCONVERT($G(@TK@(I,II)),"U")="TABLE_NAME" S AAA(II)=1
 ....I $ZCONVERT($G(@TK@(I,II)),"U")="TABLE_OWNER" S AAA(II)=2
 ....I $ZCONVERT($G(@TK@(I,II)),"U")="TABLE_TYPE" S AAA=II
 ...I I'=0 D
 ....I $G(AAA(II))=2 S BSOWNER=$G(@TK@(I,II))
 ....I $G(AAA(II))=1,$ZCONVERT($G(@TK@(I,AAA)),"U")="TABLE" w "<A href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&TABLE="_$G(@TK@(I,II))_"&BSDSN="_DSN_"'>"_$G(@TK@(I,II)),"</A>" Q
 ....w $G(@TK@(I,II)) I $D(@TK@(I,II,1)) S i="" F  S i=$O(@TK@(I,II,i)) Q:i=""  W $G(@TK@(I,II,i))
 ..w "</td>"
 .w "</tr>"
 D TABL2
 Q
TABL1 ;НАЧАТЬ ТАБЛИЦУ
 w BK,"<table border=0 >",BK Q
TABL2 ;ЗАКОНЧИТЬ
 w "</table>",BK Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCGIS" type="MAC" languagemode="0"><![CDATA[
%BSCGIS ; пpогpамма связи с КОМПОНЕНТОЙ 
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
TITL(S) Q "<TITLE>"_S_"</TITLE></HEAD>"
INFO //  
 W "ИНФОРМАЦИЯ : X="_$G(BSocxP0kD)_" Y="_$G(BSocxP0kS)
 Q
REG //функция регистации
 N A,noPASS
 I $G(BSocxREG)="notPASS" S noPASS=1
 S A=$$PROTECT^%ZAPM.bs.BSC4reg($G(BSocxP0kD,"Z"),$G(BSocxP0kS))     ;ПРОВЕРКА ПАРОЛЯ
 ;S ^%ZZZ(1)=A
 I A="" W 0 Q
 I '$$GRA($G(BSocxP0kD,"Z"),$G(BSocxGRAND)) W 0 Q
 I A=1 S BSLOGIN=$G(BSocxP0kD,"Z") D Session^%ZAPM.bs.BSC4reg W "-=!=-"_$G(BSSES,"?")_"-=!=-"
 ;S ^%ZZZ(BSLOGIN)=$G(BSSES,"?")
 Q
GRA(BSLOGIN,Gr)  N BSGRANT,A     N Cm,FF,F,BD //НАЙТИ ВХОЖДЕНИЕ ГРАНДА В ОБЩИЙ
 I '$D(BDUSE) D MAINVAR^%ZAPM.bs.BSC4
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""GRAND"")")
 S BSGRANT=$G(@BDUSE@(BSLOGIN,"GRANT")) I BSGRANT="" Q 0
 d RECURS^%ZAPM.bs.BSC4(BSGRANT) I $D(FF(Gr)) Q 1
 Q 0
CLS //ЗАКРЫТИЕ СЕССИИ
 D CloseSess^%ZAPM.bs.BSC4reg W "OK"
 Q
EVENT //СОБЫТИЯ
 W $H
 Q
Report //СОБЫТИЯ
 S Par1=$G(BSocxP0kD),Par2=$G(BSocxP0kS) ;,Par3=$G(BSExtVar)
 W +$G(@Par1@("Count"))_BK
 F i=0:1 Q:'$D(@Par1@(i))  D
 .;W $G(@Par1@(i))_BK
 .S A=$TR($G(@Par1@(i)),BK,"") W A_BK
 W "<End Of File>"
 Q
Step1NewTabel D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Шаг1 - потоковый ввод"),$$B27^%ZAPM.bs.BSCGIS
 d Step1NewTabel^%ZAPM.bs.BSCAsIs 
 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4 //НОВЫЙ ТАБЕЛЬ
 q
ReportTabel2005 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Отчеты"),$$B27^%ZAPM.bs.BSCGIS
 I $G(BSocxP0kD)'=""  S BSPART=$$Normalize($G(BSocxP0kD)),BSTABL=$G(BSocxP0kS),PT=$NA(@BSPART@(BSTABL))
  D ReportLIST^%ZAPM.bs.BSCAsIs
 D BUTT,END^%ZAPM.bs.BSC4
 q
ErrLogTabel2005 
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Cписок ошибок, выявленных при занесении информации в базу данных"),$$B27^%ZAPM.bs.BSCGIS
 D VAR M L=@BDSES@(BSSES,"VAR","ERR","LOG") M C=@BDSES@(BSSES,"VAR","ERR","COU") D BUTT^%ZAPM.bs.BSCGIS
 I $D(C) W "<CENTER><H3><a name=a2>ОШИБКИ ВЫЧИСЛЕНИЯ -------------</H3> "_$s($d(L):"<a href='#a1' TITLE='Перейти'>ОШИБКИ ЛОГИЧЕСКОГО КОНТРОЛЯ",1:"")_"</a></CENTER>" D ErrWrite(.C) 
 I $D(L) W "<CENTER><a name=a1>"_$s($d(C):"<a href='#a2' TITLE='Перейти'>ОШИБКИ ВЫЧИСЛЕНИЯ</a>",1:"")_" <H3>-------------- ОШИБКИ ЛОГИЧЕСКОГО КОНТРОЛЯ</H3></CENTER>" D ErrWrite(.L) 
 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 q
ErrWrite(L)  w "<HR><table border=0>"
 S Y="" F  S Y=$O(L(Y)) Q:Y=""  w "<tr><td class=s1 width=5%>Строка "_Y D  W "</td></tr>"_BK
 .w "<table border=0>"
 .S X="" F  S X=$O(L(Y,X)) Q:X=""  w "<tr><td class=s2 width=5%>Колонка "_X D  W "</td></tr>"_BK
 ..w "<table border=0 width=100%>"
 ..I $D(L(Y,X,"ER")) w "<tr><td class=s3 width=5%>Ошибка выполнения!</td><td class=s4 >"_RED_L(Y,X,"ER")_EF_"</td></tr>"_BK
 ..w "<tr><td class=s4 width=5%>Не выполняется формула</td><td class=s5 >"_L(Y,X,1)_"</td></tr>"_BK
 ..w "<tr><td class=s4 width=5%>Текущие значения :</td><td class=s5 >"_L(Y,X,2)_"</td></tr>"_BK
 ..w "</table>"
 .w "</table>"
 w "</table><HR>"
 Q
DocumTabel2005
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Документация"),$$B27^%ZAPM.bs.BSCGIS
 D VAR d DOCUM2^%ZAPM.bs.BSCAsIs 
 ;d dop^%ZAPM.bs.BSCAsIs,help^%ZAPM.bs.BSC4 
 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 q
HELP //ПОМОЩЬ
 I +$G(BSSES)="0" G STOP
 D BEG1^%ZAPM.bs.BSC4 W $$TITL("HELP"),$$B27
 D help^%ZAPM.bs.BSC4
 D BUTT
 D END^%ZAPM.bs.BSC4
 Q
NEWDOC //ДОНЕСЕНИЯ О ОБЫТИЯХ
 I +$G(BSSES)="0" G STOP
 I '$G(BSocxP0kS) D CLOSEWIN^%ZAPM.bs.BSC4("Некорректные координаты "_$$SD(),0) q
 D VAR
 zn nsmon
 s BSgMODE="NEW",BSList=2
 D PART("^["""_nsmon_"""]BSC4MON.UFD","Новый документ "_$$SD())
 q
SD() Q "--- Широта("_$G(BSocxP0kS)_") Долгота("_$G(BSocxP0kD)_")"
B27(C) Q "<BODY "_$$27_">"_BK_$$js^%ZAPM.bs.BSCp_$$Status^%ZAPM.bs.BSCm4("{Esc} - отмена, закрыть окно. {F5} - обновить окно")_$$GISclose($G(C))_$$jse^%ZAPM.bs.BSCp_BK
27() Q " onkeyPress='javascript: if (27 == event.keyCode) GISclose();' "
GISclose(C) N Q
 S Q="function GISclose() {"_BK
 S Q=Q_"status='Status :CloseWin:'"_BK
 ;S Q=Q_"alert(111);"_BK
 I $G(C) S Q=Q_"window.close();"_BK
 S Q=Q_"}"_BK
 Q Q
BUTT  W "<CENTER><BUTTON onclick='"_$S('$D(BSocxP0kD):"window.close",1:"GISclose")_"();' title='Закрыть окно'><IMG SRC='"_BSDOMAIN_"/img/kill.gif'>Закрыть</BUTTON></CENTER>"
 Q
 
PART(pin,TITL) //РАЗДЕЛ
 D BEG1^%ZAPM.bs.BSC4 W $$TITL(TITL)
 W $$B27 D BUTT
 I $E(pin,1)'="^" S pin="^"_pin
 I '$$Data^%ZAPM.bs.BSF12(pin) w "нет доступа к "_pin Q
 W "<table border=0 width=100%>"
 S N=""  F  S N=$O(@(pin)@(N)) Q:N=""  I $P($G(@(pin)@(N)),"@",17)=2 D
 .I N="ROU" Q
 .W "<tr><td width=20% class=s1 >"
 .W "<a title='редактировать в форме' "_$$AN^%ZAPM.bs.BSCm(pin,N,"T^~BSCm4")_"> "_N_" </a>"
 .W "</td><td class=s1 >"_AF,$P($G(@(pin)@(N)),"@",1),EF_"</td></tr>",BK
 W "</table>"
 D BUTT,END^%ZAPM.bs.BSC4
 Q
VAR //ПЕРЕМЕННЫЕ СОЗДАТЬ
 S nsmon="FON" ;ГДЕ ЛЕЖИТ ПРОЕКТ МОНИТОРИНГ
 Q
Normalize(p) i p'["^" s p="^AsIs"_$ZCONVERT(p,"U") //нормализовать имя раздела для Табеля 2005
 I $E(p,1,2)="^~" S p="^%"_$E(p,3,99)
 q p
EXnewKEY //НОВЫЙ КЛЮЧ ДЛЯ EXCELL
 I +$G(BSSES)="0" G STOP
 D VAR I $G(BSFlagRecord)'=""  S BStyleOver="GKVV7"
 D BEG1^%ZAPM.bs.BSC4 W $$TITL("Новый ключ : Для раздела ("_$$Normalize($G(BSocxP0kD))_") и таблицы ("_$G(BSocxP0kS)_")")
 W $$B27 S BSPART=$$Normalize($G(BSocxP0kD)),BSTABL=$G(BSocxP0kS),PT=$NA(@BSPART@(BSTABL))
 I '$$Data^%ZAPM.bs.BSF12(PT) W "Раздела(Таблицы) "_RED_PT_EF_" в рабочей области '"_RED_BSNSP_EF_"' нет. "_BBK
 I $$ACCE^%ZAPM.bs.BSCocx(5),$G(BSnewForm)'="",$G(BSFlagRecord)="" D  //ЕСЛИ РАЗРЕШЕНО РЕДАКТИРОВАТЬ ТОБД, И НЕ СУЩЕСТВУЕТ "KEY"
 .S BSLABEL="CREATAB^~BSCocx1" 
 .W GREEN_"<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>Создать/Редактировать Таблицу описания Баз Данных</A>"_EF
 i $$ACCES^%ZAPM.bs.BSCocx(BSLOGIN,BSSES)>6,$$Data^%ZAPM.bs.BSF12(PT) D  //ЭТО РАЗРАБОТЧИК
 .;S BSLABEL="KILLTAB^~BSCocx1" 
 .;W GREEN_" Таблицу описания Баз Данных вместе с данными <A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>"_RED_"Удалить"_EF_"</A>"_EF ;d
 I $$Data^%ZAPM.bs.BSF12(PT) D KEYS^%ZAPM.bs.BSCocx
 I $G(BSkeyCC)'="" D BUTT
 d InfoSess^%ZAPM.bs.BSC4rout 
 D END^%ZAPM.bs.BSC4
 Q
NEWLAY //НОВЫЙ СЛОЙ
 I +$G(BSSES)="0" G STOP
 D VAR
 D BEG1^%ZAPM.bs.BSC4 W $$TITL("Новый Слой")
 W $$B27
 S BSNSP=nsmon,BSPRT="BSC4MON"   D FrmRptBrowse^%ZAPM.bs.BSfonRPT
 D BUTT,END^%ZAPM.bs.BSC4
 Q
EDITDOC //
 I +$G(BSSES)="0" G STOP
 D VAR
 D BEG1^%ZAPM.bs.BSC4 W $$TITL("Редактировать документы")
 W $$B27
 zn nsmon
 ;s BSgMODE="NEW",BSList=2
 S BSNSP=nsmon,BSPRT="BSC4MON"   
 D PART("^["""_BSNSP_"""]"_BSPRT_".UFD","Редактировать документы"_$$SD())
 ;D BUTT
 D END^%ZAPM.bs.BSC4
 Q
REPORT //
 I +$G(BSSES)="0" G STOP
 D BEG1^%ZAPM.bs.BSC4 W $$TITL("Формировать отчеты")
 W $$B27
 D LISTP^%ZAPM.bs.BSmirGL
 D BUTT  D END^%ZAPM.bs.BSC4
 Q
STOP D CLOSEWIN^%ZAPM.bs.BSC4("Вы не зарегистрировались",0) 
 Q       
 /*
SQLGO ;ВОЗВРАТИТЬ ТАБЛИЦУ
 D Read^%ZAPM.bs.BSCG(DSN,SQL,$G(IF),,TG) ;ЧТЕНИЕ ТАБЛИЦЫ В МАССИВ TG
 D TAB(TG)
 S BDSN=$$KBDG("^%ZAPM.bs.BSC(""BSQLDSN"")") I BDSN'="" D
 .S I=$O(@BDSN@("SQL",""),-1)+1,@BDSN@("SQL",I,"SQL1")=SQL
 .I I>$$0^%ZAPM.bs.BSCh(30) S I=$O(@BDSN@("SQL","")) K @BDSN@("SQL",I)
 D HELP
 Q
 */
]]></Routine>


<Routine name="%ZAPM.bs.BSCGS" type="MAC" languagemode="0"><![CDATA[
%BSCGS(DiR,gLo) ;Global Size Utility   ; 15:45   05.09.2002 ; Compiled September 21, 2001 14:33:07
 ; +--------------------------------------------------------+
 ; | Copyright 1986-2001 by InterSystems Corporation,       |
 ; | Cambridge, Massachusetts, U.S.A.                       |
 ; | All rights reserved.                                   |
 ; |                                                        |
 ; | Confidential, unpublished property of InterSystems.    |
 ; |                                                        |
 ; | This media contains an authorized copy or copies       |
 ; | of material copyrighted by InterSystems and is the     |
 ; | confidential, unpublished property of InterSystems.    |
 ; | This copyright notice and any other copyright notices  |
 ; | included in machine readable copies must be reproduced |
 ; | on all authorized copies.                              |
 ; +--------------------------------------------------------+
 ;%system.INC ; LFT865 11/08/00
 ;%ST.INC CFL509 04/24/01
 I $zv'["Windows" Q "NoWindows!"
 I $$ZV^%ZAPM.bs.BSCp>5 Q "No5.0!"
 If $$isrem^%GLO Quit $ZN_" does not currently support default global directory located on a remote system."
 If '$zbitget($zversion(0),21) Q $ZN_" only runs on big database system code."
 n (DiR,gLo)
 S $ZT="ERR^"_$ZN
 I $G(DiR)'="" S NSold=$ZU(5) I '$$ZU^%ZAPM.bs.BSF4(DiR) Q "NoDir!"
 s DIR=$$GETDIR ;///
 I DIR="" D NSNAZAD Q "NoDir!"
 
 If $zbitget($zversion(0),21) {
    Set dirinfo=$zu(49,DIR) If (+dirinfo)<0 Write !,*7,DIR," is not available" Quit
    Set bigdb=$Piece(dirinfo,",",21)
    Set blksiz=$Piece(dirinfo,",",2)
 } else {
    Set bigdb=0
    Set blksiz=2048
 }
 
 Set datasize=$Case(blksiz,2048:2036,:(blksiz-$zu(40,32,10)))
 s ONSP=$zu(5) zn "^^"_DIR ;save current namespace
 
 d INT^%T ;,^%GSET ;///%GSET accepts globals in current namespace only
         ;g exit:$o(^UTILITY($j,""))="" ;///
         ;s detail=($$YN("Show details?","N")="Y") ;///
 s detail=1
 ;d ^%IS q:POP  ;///
              s G="",P=1,(tbytes,tblks,tcont,DX)=0
 ;i IO=$I,$G(
 S XY="" ; S DX=18 ;///
 ;i 'detail d showless i 1
 
 I gLo["]" S gLo=$P(gLo,"]",2)
 I $E(gLo,1)="^" S gLo=$E(gLo,2,99)
   d showmore ;d:'POP stop w @IOF       ///
exit zn ONSP
 ;c:$d(IO) IO k %ST
 q $G(TOTAL)
 ;
NSNAZAD() I $G(NSold)'="" I $$ZU^%ZAPM.bs.BSF4(NSold)
 Q
GETDIR() ;
 ;W !
 S R=$zu(12,"") ;W !
 Q:R="QUIT"!(R="quit")!(R="^")!(R="") ""
 q $zu(12,R,3) ;not really necessary as GetDir checked R already
 ;
showmore ;inherit all variables from caller, call detail(), and display
 ;u IO d hdr i IO=$I     d CURRENT^%IS
 ;f  s G=$o(^UTILITY($j,G)) q:G=""  d:'POP
 ;. w ?6,G
 s DY=1,DX=1
 ;. i '$p(^UTILITY("GLO",G),"^",3) w " - implicit",! q
  s x=$$detail(gLo) If x="" Quit
  Set bytes=$p(x,","),blks=$p(x,",",2),cont=$p(x,",",3)
 ;. s tbytes=tbytes+bytes,tblks=tblks+blks,tcont=tcont+cont
 ;. w:'DX ?18,$J($fn(blks,","),8)
 ;. w ?28,$J($fn(bytes,","),15),?45
  S TOTAL=bytes
  i blks=0 S TOTAL=TOTAL_"^"_"0%"
  i blks'=0 S TOTAL=TOTAL_"^"_$j(100*(bytes/(blks*datasize)),1,0)_"%"
  S TOTAL=TOTAL_"^"_$j($fn(cont,","),1)_"^"_$p(x,"?",2)
 ;. i $y>(IOSL-4) d hdr
 ;w !!?6,"TOTAL" d hdr1
 ;w ?18,$J($fn(tblks,","),8)
 ;w ?28,$J($fn(tbytes,","),15)
 ;w:tblks ?45,$j(100*(tbytes/(tblks*datasize)),5,0)," %"
 ;w ?55,$j($fn(tcont,","),7)
 q
showless ;inherit all variables from caller, call brief(), and display
 u IO w @IOF i IO=$I d CURRENT^%IS
 S H="Global Size Display of "_$zu(5)
 U IO W @IOF W !,$J(H,$L(H)+IOM\2)
 D INT^%T S H=%TIM_"  "_$zd($h,7) W !,$J(H,$L(H)+IOM\2)
 w !!
 f  s G=$o(^UTILITY($j,G)) q:G=""  d:'POP
 . w $j(G,12)
 . i '$p(^UTILITY("GLO",G),"^",3) w $j(" - ",8),! q
 . s x=$$brief("^"_G),blks=+x,tblks=tblks+blks
 . i x'["?" w $J(blks,8)
 . e  w $j($p(x,"?",2),8)
 w !!,$j("TOTAL:",12),$j(tblks,8),!
 q
 ;
hdr d stop q:POP  w @IOF
 w "directory: ",DIR,!
 w "Page: ",P,?34,"GLOBAL SIZE",?(IOM-11),$ZDATE($h,2,,4),!,?(IOM-8),%TIM,!
 w ?6,"Global"
 s P=P+1
hdr1 w ?18,"  Blocks",?28,"     Bytes Used",?45,"Packing",?55,"Contig.",!
 w ?6,"--------",?18,"--------",?28,"---------------",?45,"-------",?55,"-------",!
 q
stop i P=1!(IOST'["C-") q
 r !?40,"<RETURN> to continue or '^' to STOP: ",X s:X="^" POP=1
 q
 ;
detail(G) ;detailed version
 n (bigdb,blksiz,dataloc,datasize,dirinfo,G,%ST,DX,DY,XY,DIR) ;DX,DY,XY are used to display progress
 If $Data(dataloc) {
    Set DIR=$Extract(dataloc,2,$Length(dataloc)) ; leave off the "^"
    If ($zbitget($zversion(0),21)) {
       Set dirinfo=$zu(49,DIR) If (+dirinfo)<0 Quit ""
       Set bigdb=$Piece(dirinfo,",",21)
       Set blksiz=$Piece(dirinfo,",",2)
    } else {
       Set bigdb=0
       Set blksiz=2048
    }
 }
 Set datasize=$Case(blksiz,2048:2036,:(blksiz-$zu(40,32,10)))
 s (n,k,c)=0 ;n:bytes,k:blocks,c:contiguous blocks?
 ;W !!,DIR,!,G,!!! R rrrrr
 Set rc=$$GetGlobalPointers^%DM(DIR,G,,.b)
 If ('rc) Do ShowMessage(rc,0) Quit ""
 o 63
 f  q:'b  d  q:$d(err)  s p=b+1,b=$$GetLinkBlockFromViewBuffer^%DMREPAIR(bigdb),c=c+(p=b)
 . v b s t=$$GetBlockTypeFromViewBuffer^%DMREPAIR(bigdb)
 . i t-8,t-12 s err="?TOB: "_b_":"_t q  ;unexpected type of block
 . s n=n+$$GetOffsetFromViewBuffer^%DMREPAIR(bigdb),k=k+1 ;q:t=8  ;so much for normal data blocks
 . Set n=n-$Case(bigdb,0:0,:$zu(40,32,10)) ;Adjust number for header bytes
 . f i=1:1 s x=$v(i*2-1,-6) q:x=""  d  q:$d(err)
 . . ;Next line covers all the long string types for both 2k and bigdb
 . . s v=$v(i*2,-6) If $a(v)'=5,($a(v)'=$Case(bigdb,0:9,:7)),($a(v)'=3) Quit
 . . s nb=$p(v,",",2),r=$p(v,",",3) ;nb: # of blocks,r:#bytes in last block
 . . s n=n+((nb-1)*blksiz)+r,k=k+(nb-1)+''r
 . ;i DX u 0 X XY w $J(k,8) u IO
 ;i DX u 0 X XY w $J(k,8) u IO
 c 63
 q n_","_k_","_c_$g(err)
brief(G) ;brief version (quicker)
 n (bigdb,blksiz,datasize,dirinfo,G,DIR)
 s k=0 ;k:blocks
 Set rc=$$GetGlobalPointers^%DM(DIR,G,.b)
 If ('rc) Do ShowMessage(rc,0) Set err="?" Goto exitbrf
 o 63
 i 'b s err="?GLOBAL" g exitbrf
 f  q:'b  v b s t=$$GetBlockTypeFromViewBuffer^%DMREPAIR(bigdb) q:(t=6!(t=70))  s b=$v(2,-5)
 i 'b s err="?BOTPNT" g exitbrf
 f  k big s lastbig=-1,big=0 q:'b  v b  d  s k=k+i-1
 . f i=1:1 s x=$v(i*2-1,-6) q:x=""  s p=$v(i*2,-6) d:$Piece(p,",")
 . . Set p=$Piece(p,",",2) ;block number with big string
 . . i lastbig=(i-1) s $p(big(big),",",2)=p
 . . e  s big=big+1,big(big)=p
 . . s lastbig=i
 . s b=$$GetLinkBlockFromViewBuffer^%DMREPAIR(bigdb) ;get next linked block before doing big blocks
 . s j="" f  s j=$o(big(j)) q:j=""  s k=k+$$bigblk(big(j))
exitbrf c 63
 q k_$g(err)
bigblk(b) ;
 n (b,bigdb) s beg=+$p(b,","),end=+$p(b,",",2) s:'end end=beg q:'beg 0
 s b=beg,k=0 f  v b  q:($$GetBlockTypeFromViewBuffer^%DMREPAIR(bigdb)'=12)  d  q:b=end  s b=$$GetLinkBlockFromViewBuffer^%DMREPAIR(bigdb) q:'b
 . f i=1:1 s x=$v(i*2-1,-6) q:x=""  d
 . . s v=$v(i*2,-6) q:$a(v)'=3
 . . s k=k+$p(v,",",2)  ;+''($p(v,",",3))
 q k
YN(P,D,t) N R,X S P=$G(P),D=$E($G(D)_"?"),t=$G(t) ;ask Yes/No w/ Prompt,Default
 S D=$S("Yy"[D:"Yes => ","Nn"[D:"No => ",1:"") ;Yes, No or no default
 F  W !,P_"? "_D Read:t R:t Read:'t R DO  I "^YN"[R Q  ;timed or non-timed read
 . S X=R,R=$TR($E(R_D_"?"),"yn","YN") I "^YN"'[R W "  enter Yes or No, please"
 S POP=(R="^") W $E($S(R="N":"No",R="Y":"Yes",1:""),$L(X)+1,3) Q R
GetDir(p,d,exists) ;ask for a directory, allow defaults
 i '$D(exists) s exists=1 ; default is to check if exists
 n neednew s neednew=1 ;expect to new dirlist
 i $g(dirlist) i $g(@dirlist) s neednew=0 ; callers dirlist seems ok
 i neednew n dirlist d
 . S dirlist="mtemp1(""dir"")" ;as good a place as any...
 . I $G(@dirlist)<$H K @dirlist S @dirlist=$H_","_$J_","_$I
 N R,Z,Lock Lock +@dirlist:1 S Lock=$T DO  Lock:Lock -@dirlist Q R
 . N N,OLD,MAX,TWO S (N,MAX)=$G(@dirlist@(0))+1,TWO=0
Get . S OLD=$G(@dirlist@(N)),$ZT="GetErr" I OLD="",N=MAX S OLD=$G(d)
 . W:'TWO ! I TWO W $C(13),$J("",70),$C(13) ;start on new line
 . W p_": "_$S(OLD]"":OLD_" => ",1:"") R R S Z=$ZB,TWO=0 S:R="" R=OLD
 . i $ZM'["R" I $A(Z)=27 S R="" DO  G Get:R="" ;handle special function keys!!
 . . I Z=$C(27,91,65) DO  Q  ;handle ANSI up-arrow
 . . . S TWO=1,N=N-1 I 'N S N=$G(@dirlist@(0))+1 Q
 . . I Z=$C(27,91,66) DO  Q  ;handle ANSI down-arrow
 . . . S N=N+1,TWO=1 I N>MAX S N=1
 . . I Z=$C(27,91,67) S R="@" Q  ;handle ANSI right-arrow --> edit
 . . I Z=$C(27,91,68) S R="@" Q  ;handle ANSI left-arrow --> edit
 . ;
 . I R="@",OLD]"" S R=$$ED(OLD) ;use good-old replace/with editor
 . I $E(R)="?" S Z=R Q  ;pass-on request for elaboration
 . i $$STOP(R) Q
 . S Z=$S(exists:$$ChkDirOrSpecEXISTS(R),1:$$ChkDirVALID(R))
 . I Z="" W *7,"  could not interpret '"_R_"'",! G:exists Get d  g:Z="N" Get
 . . s Z=$$YN("Use this directory anyway")
 . Q  ;needed to not enter 'GetErr'
GetErr . S $ZT="",D="",TWO=0,N=$G(MAX) ; clear default
 . I $P($ZE,">")="<INTERRUPT" S R="" q
 . E  W !,"Error: "_$ZE
 . G Get
UC(x) q $zcvt(x,"u")
Touch(D) ;add directory 'D' to the list of directories 'touched' today
 Q:D=""  Q:D=-1  n neednew s neednew=1 ;expect to new dirlist
 i $g(dirlist) i $g(@dirlist) s neednew=0 ; callers dirlist seems ok
 i neednew n dirlist d
 . S dirlist="mtemp1(""dir"")" ;as good a place as any...
 . I $G(@dirlist)<$H K @dirlist S @dirlist=$H_","_$J_","_$I
 I $D(@dirlist@("*",D)) Q  ;already in list
 N N S N=$G(@dirlist@(0))+1,@dirlist@(0)=N,@dirlist@(N)=D
 S @dirlist@("*",D)=N Q  ;keep track of directories added
ED(%L) ; Edit using the familiar old line editor.
 N %IED,%R,%W,%A,%B,%C,%D,%J X ^%("ED") W !?7,"--> "_%L Q %L
ChkDirVALID(R) N N S $ZE="",$ZT="ChkBad",N=$ZU(12,R,1) Q N
ChkDirEXISTS(R) N N S $ZE="",$ZT="ChkBad",N=$ZU(12,R,2) Q N
ChkDirOrSpecEXISTS(R) N N S $ZE="",$ZT="ChkBad",N=$ZU(12,R,3) Q N
ChkDir(R) N N S $ZE="",$ZT="ChkBad",N=$ZU(12,R,2) Q N
ChkBad S $ZT="" W !,"<"_$P($P($ZE,"<",2),">")_"> error -- invalid directory"
 Q ""
STOP(x) S x=$$UC($E(x,1,4)) Q (x["EXIT")!(x["STOP")!(x["QUIT")!(x["HALT")!($E(x)="^")
ShowMessage(sc,device)
 New msglist d DecomposeStatus^%DM(sc,.msglist,0,"")
 d wrtmsg($C(13,10),device) f i=1:1:msglist d wrtmsg(msglist(i)_$C(13,10),device)
 q
GetMessage(code,locale)
 If $Get(locale)="" Set locale=$$getEnvironment^%DM()
 If locale="" s locale="ENU"
 q $g(^%Messages(code,"text",locale),$g(^%Messages(code,"text","ENU"),1000))
wrtmsg(msg,device) ;
 q:'$L(msg)       ; Avoid argumentless writes...
 i $g(%UI,"CHUI")="CHUI" u device w msg q
 d:$$IjcMsg^%Wprima("DI"_msg)="CANCEL"  ; Return value could be cancel message
 . i $$IjcMsg^%Wprima("DI"_$C(13,10)_"Abort received!"_$C(13,10))
 . zt "Abort"
 q
ERR S $ZT="",ze=$ZE
 I ze["<FUNCTION>" Q "Bad namespace name """_$G(DiR)_"""."
 I ze["<DIRECTORY>" Q "Namespace """_$G(DiR)_""" is not available."
 I ze["<NAMESPACE>" Q "Namespace """_$G(DiR)_""" is not available."
 I ze["<PROTECT>" Q "Insufficient privileges for """_$G(DiR)_"""."
 I ze["<NOTOPEN>" Q "No database in """_$G(DiR)_"""."
 I ze["<INTERRUPT>" Q "Interrupted."
 Q "Error: "_ze
]]></Routine>


<Routine name="%ZAPM.bs.BSCKD" type="MAC" languagemode="0"><![CDATA[
%BSCKD ;Генератор классов для Кодификаторов %BS ; 15:45   05.09.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
ALLKDF(UCI) ;КОМПИЛИРОВАТЬ ВСЕ КОДИФИКАТОРЫ КИПА
 I $G(UCI)="" G ALLK
 I $ZU(5)'=UCI,$$ZU^%ZAPM.bs.BSF4(UCI)
 I $ZU(5)'=UCI Q "No found "_UCI
ALLK N GL S GL="" F  S GL=$O(^$GLOBAL(GL)) Q:GL=""  D kdf(GL)
 Q 1
kdf(GL) I $E($G(@GL),1,11)="%BS-invert-" W !,"dictonary ",GL," " W $$START(GL,1,"")
 Q
START(GL,COMPILE,NC,DIR) ;СОЗДАНИЕ КЛАССА КОДИФИКАТОРА
 N FN,K,S,I,J,P,SS,BD,CBD,BSK,P3
 I $E(GL,1)'="^" S GL="^"_GL
 I '$D(@GL) Q "Undefine "_GL
 I $G(DIR)="" S DIR=$$TEMPDIR^%ZAPM.bs.BSCF1
 I $D(NOKILLER),NOKILLER[":\" S DIR=NOKILLER
 I $P(@GL,"@",1)'["%BS-invert-" Q "This no KDF"
 I $G(NC)="" S NC=$P($P($G(@GL),"@",1),"^",2) S:NC["]" NC=$P(NC,"]",2,99) S:NC["," NC=$P(NC,",",1) S:NC="" NC="KDF"
 I $E(NC,1,3)="%BS" S NC="BSS"
 I GL["]" S NC=NC_"."_$TR($P(GL,"]",2,99),"%","")
 E  S NC=NC_"."_$TR($P(GL,"^",2,99),"%","")
 S FN=DIR_NC_".CDL"
 I '$$OpenFile^%ZAPM.bs.BSCF1(FN,"W") Q "No access to file "_FN
 U FN
 D TITLE W "class ",NC,!,"{",!
 D SUPER,METOD("KodTxt"),METOD("TxtKod"),QUERY,QUERYALL,STORAGE
 W !,"}",!
 C FN
 I $G(COMPILE) D LF^%ZAPM.bs.BSCBD(FN) I '$D(NOKILLER),$$DelFile^%ZAPM.bs.BSCEXE(FN)
 Q "1 OK"
TITLE W !,"/***********************************************************************\"
 W !,"          File: ",FN
 W !,"        Author: Serge W. Mikhaylenko"
 W !,"          Date: ",$ZD($H,9)
 W !,"   Description: Dictonary from %BS"
 W !,"         Above: This File is Generated by %BS+++Cache"
 W !,"\***********************************************************************/",!!
 Q
SUPER W !,"description = {",!,$P(@GL,"@",2),!,"}",!
 W !,"   super = %Library.Persistent;",!
 W !,"persistent = KD;"
 W !,"index i1 { attributes = K1; extent = 0; idkey; primarykey = 0; unique = 0; }",!
 W !,"  attribute K1 { type = %String(MAXLEN=""""); calculated = 0; description = ""Код кодификатора. ""; not final; multidimensional = 0; public; required; sqlcomputed = 0; transient = 0; }"
 W !,"  attribute A1 { type = %String(MAXLEN=""""); calculated = 0; description = ""Текст кодификатора.""; not final; multidimensional = 0; public; required; sqlcomputed = 0; transient = 0; }"
 Q
METOD(LAB)
 W !!,"   method "_LAB_"(PID:%Library.String="""")",!
 W !,"   {",!
 W !,"   returntype = %Library.String;"
 W !,"   classmethod;"
 W !,"   not final;"
 W !,"   public;"
 W !,"   sqlproc = 0;"
 W !,"   code ="
 W !,"   ["
 W !,"             q $$"_LAB_"^%ZAPM.bs.BSCKD(PID)"
 W !,"   ]"
 W !,"   }",!
 Q
QUERY S S=""
 W !,"   query ListKD((Param1:%Library.String))"
 W !,"   {",!
 W !,"           type = %Library.SQLQuery(CONTAINID=0,ROWSPEC=""" D  W """);"
 .;K1:%String,K2:%String,P1:%String,P2:%String,P3:%Library.String,P4:%Library.String
 .W "K1:%String,A1:%String"
 W !,"           sqlquery ="
 W !,"           ["
 W !,"                   :SELECT K1, A1"
 W !,"                   :FROM "_$P(NC,".",$L(NC,"."))
 W !,"                   :WHERE (K1 = :Param1)"
 W !,"                   :ORDER BY K1"
 W !,"            ]"
 W !,"            sqlproc = 0;"
 W !,"            sqlview = 0;"
 W !,"   }",! Q
QUERYALL S S=""
 W !,"   query ALLListKD()"
 W !,"   {",!
 W !,"           type = %Library.SQLQuery(CONTAINID=0,ROWSPEC=""" D  W """);"
 .;K1:%String,K2:%String,P1:%String,P2:%String,P3:%Library.String,P4:%Library.String
 .W "K1:%String,A1:%String"
 W !,"           sqlquery ="
 W !,"           ["
 W !,"                   :SELECT K1, A1"
 W !,"                   :FROM "_$P(NC,".",$L(NC,"."))
 W !,"                   :ORDER BY K1"
 W !,"            ]"
 W !,"            sqlproc = 0;"
 W !,"            sqlview = 0;"
 W !,"   }",! 
 Q
STORAGE ;ХРАНЕНИЕ
 W !!,"       storage KD"
 W !,"       {"
 W !,"               description = ""Конструкция SQL доступа к Кодификаторам %BS"";"
 W !,"               type = %CacheSQLStorage;"
 W !,"               sql"
 W !,"               {"
 W !,"                       map Master"
 W !,"                       {"
 W !,"                               global = "_GL_";"
 W !,"                               structure = delimited;"
 W !,"                               type = data;"
 W !
 W !,"                               subscript 1"
 W !,"                               {"
 W !,"                                      expression = 1;"
 W !,"                                      nextcode ="
 W !,"                                      ["
 W !,"                                      ]"
 W !,"                               }"
 W !,"                               subscript 2"
 W !,"                               {"
 W !,"                                      expression = {K1};"
 W !,"                                      nextcode ="
 W !,"                                      ["
 W !,"                                      ]"
 W !,"                               }"
 W !,"                   data A1 { delimiter = ""@""; piece = 1; }"
 W !,"                       }" ;MAP1
 W !,"                       map Slove"
 W !,"                       {"
 W !,"                               global = "_GL_";"
 W !,"                               structure = delimited;"
 W !,"                               type = index;"
 W !
 W !,"                               subscript 1"
 W !,"                               {"
 W !,"                                      expression = 2;"
 W !,"                                      nextcode ="
 W !,"                                      ["
 W !,"                                      ]"
 W !,"                               }"
 W !,"                               subscript 2"
 W !,"                               {"
 W !,"                                      expression = {A1};"
 W !,"                                      nextcode ="
 W !,"                                      ["
 W !,"                                      ]"
 W !,"                               }"
 W !,"                   data K1 { delimiter = ""@""; piece = 1; }"
 W !,"                       }" ;MAP2
 W !,"               }" ;SQL
 W !,"       }"
 Q
KodTxt ;ПРЯМОЙ ДОСТУП
 Q 1
TxtKod ;
 Q 1
]]></Routine>


<Routine name="%ZAPM.bs.BSCRBB" type="MAC" languagemode="0"><![CDATA[
%BSCRBB ;Remote Black Box
 Q
Action(ID,P1,P2,P3) ;посылка комады серверу
 Q ID
Event(ID) ;опрос сервера, есть ли что нибудь для него
 q 0
]]></Routine>


<Routine name="%ZAPM.bs.BSCRG" type="MAC" languagemode="0"><![CDATA[
%BSCRG ;Cache Relational Gateway - Functions ; 18:28   06.04.2003
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
 ;/////////////////////////// BStempSQL...//////////////////////////
RUN() ;запустить из VISM.ocx
 ;ВХОДНЫЕ ПЕРЕМЕННЫЕ
 ;P1=Data Sours Name
 ;P2=Name User
 ;P3=Password
 ;P4=SQL
 Q $$DSN(P1,P2,P3,P4)
 ;ВЫХОДНЫЕ ПЕРЕМЕННЫЕ
 ;P5=Second EXECUTIVE
 ;P6=Error
 ;P7=Time
 ;P8=Colomn
 ;P9=Rows
TEST ;ТЕСТЫ
 N DSN,SQL
 ;S DSN="EXZ",SQL="SELECT EKZ_VOP.TEXT_V, EKZ_OTV.TEXT_O FROM EKZ_VOP INNER JOIN EKZ_OTV ON EKZ_VOP.N_NOM = EKZ_OTV.N_VOP"
 ;S DSN="ISSBASE",SQL="SELECT [ConnectRazdel]![Pred] & ' ' & [STR_MENU]![HTML] & ' ' & [ConnectRazdel]![Post] AS HTML_STRING FROM (WORKGROUPS INNER JOIN (STR_MENU INNER JOIN ConnectRazdel ON STR_MENU.Kod = ConnectRazdel.PunktMenu) ON WORKGROUPS.ID_WORKGROUP = ConnectRazdel.Workgroup) INNER JOIN SOTR ON WORKGROUPS.ID_WORKGROUP = SOTR.WORKGROUP WHERE SOTR.NET_NAME='hodov' ORDER BY STR_MENU.Nomer"
 S DSN="KSP",SQL="SELECT * FROM KNH"
 W $$DSN(DSN,"","",SQL)
 Q
DSN(DSN,NAME,PASS,SQL) ;ВЫПОЛНЕНИЕ ЗАПРОСА И ФОРМИРОВАНИЕ УЗЛА ОБЕКТОВ
 N Con,Res,Sc,Pid,i,ErrOR,COL,JJ ;,P5,P6,P7,P8,P9
 s Pid=$I_","_$J ;ИДЕНТИФИКАТОР ПРОЦЕССА
 ;ПЕРЕЙТИ В СИСТЕМНЫЙ СПЭЙС
 I $zu(5,"%SYS")
 ;ВЫПОЛНЕНИЕ ЗАПРОСА
 S Con=##Class(%SQLGatewayConnection).%New()
 S Sc=Con.Connect(DSN,NAME,PASS)
 S Res=##Class(%ResultSet).%New("%DynamicQueryGW:SQLGW")
 K ^["%SYS"]BStempSql(Pid)
 S ^["%SYS"]BStempSql(Pid,"SQL",1)=SQL
 S ^["%SYS"]BStempSql(Pid,"SQL",2)=$ZD($H,9)
 S P5=$P($H,",",2)
 s Sc=Res.Prepare(SQL,,Con)
 I 'Res.QueryIsValid() S ErrOR="Недопустимый Запрос" G DSNend
 s Sc=Res.Execute()
 I 'Sc S ErrOR=$$Status(Sc) G DSNend
 S COL=Res.GetColumnCount()
 F J=1:1:COL S ^["%SYS"]BStempSql(Pid,"NAM",J)=Res.GetColumnName(J)
 ;F J=1:1:COL S ^["%SYS"]BStempSql(Pid,"HDR",J)=Res.GetColumnHeader(J)
 ;f i=1:1:10001 q:'Res.Next()  I i<5001 d                                         ;ОГРАНИЧЕНИЯ
 f i=1:1 q:'Res.Next()  D
 .F J=1:1:COL S JJ=Res.GetData(J) I JJ'="" S ^["%SYS"]BStempSql(Pid,i,J)=JJ
 S P6=$P($H,",",2),P5=P6-P5
 S ^["%SYS"]BStempSql(Pid,"SQL",3)=P5
 S (P8,^["%SYS"]BStempSql(Pid,"SQL",7))=COL ;КОЛ-ВО КОЛОНОК
 S (P9,^["%SYS"]BStempSql(Pid,"SQL",8))=i-1 ;КОЛ-ВО СТРОК
 S (P7,^["%SYS"]BStempSql(Pid,"SQL",5))=$ZT($P($H,",",2),1)
DSNend S (P6,^["%SYS"]BStempSql(Pid,"SQL",6))=$G(ErrOR)
 d Res.%Close()
 d Con.Disconnect()
 d Con.%Close()
 Q Pid ;ИДЕНТИФИКАТОР ПРОЦЕССА
Status(sc) ;СТАТУС
 N err,i,st1
 I ('sc) D  Q st1
 .D DecomposeStatus^%apiOBJ(sc,.err)
 .S st1="" F i=1:1:err S st1=st1_err(i)_". "
 Q ""
KILL(P) ;УДАЛЕНИЕ УЗЛА
 I $G(P)'="",$D(^["%SYS"]BStempSql(P)) K ^(P) Q 1
 Q 0
ROWS(P) ;КОЛ-ВО СТРОК
 I $G(P)'="" Q $G(^["%SYS"]BStempSql(P,"SQL",8))
 Q 0
SEC(P) ;КОЛ-ВО СЕКУНД
 I $G(P)'="" Q $G(^["%SYS"]BStempSql(P,"SQL",3))
 Q ""
COLS(P) ;КОЛ-ВО КОЛОНОК
 I $G(P)'="" Q $G(^["%SYS"]BStempSql(P,"SQL",7))
 Q 0
ERRORS(P) ;ОШИБКИ
 I $G(P)'="" Q $G(^["%SYS"]BStempSql(P,"SQL",6))
 Q 0
 ;///////////////////////////////////////////////////////
STREAM(DSN,USER,PASS) ;ВСЕ ТАБЛИЦЫ DSN КОПИРОВАТЬ В РАЗДЕЛ PART И ЗАГРУЗИТЬ ДАННЫЕ
 N PxPUSTO,AUTO
 D DSN2PART^%ZAPM.bs.BSCRG(DSN,"",$G(USER),$G(PASS))
 D PART2BSD^%ZAPM.bs.BSCRG("^"_DSN)
 S PxPUSTO="" D ALLPART^%ZAPM.bs.BSCBD("^"_DSN)
 D DSN2BS^%ZAPM.bs.BSCRG(DSN,$G(USER),$G(PASS))
 Q
DSN2PART(DSN,PART,USER,PASS) ;ВСЕ ТАБЛИЦЫ DSN КОПИРОВАТЬ В РАЗДЕЛ PART
 I $G(PART)="" S PART="^"_DSN
 N WEBSQL,I,II,flag
 I $$DescDsn(DSN)'="" s ErV=1 q
 I $P($G(@PART),"@",1)'="BaSe MsW " S @PART="BaSe MsW @Раздел таблиц импортированных из DSN="_DSN
 S I="0" F  S I=$O(WEBSQL(I)) Q:I=""  I WEBSQL(I,2)="TABLE" s flag=1 D TABLE2T(DSN,WEBSQL(I,1),$NA(@PART@($$TRANAME(WEBSQL(I,1)))),$G(USER),$G(PASS))
 i '$d(flag) s ErV=1
 Q
TABLE2T(DSN,TAB,GLO,USER,PASS) ;СТРУКТУРУ ТАБЛИЦЫ В ТАБЛИЦУ %BS
 N GL,I,St,S,NAME,NAME1,TAB1,N,BSR,BST,se,ke
 S S="^%ZAPM.bs.BSC(""BSG"")"
 S St=$$DescCol(DSN,$G(USER),$G(PASS),TAB,"GL")
 K @GLO S @GLO=St
 I St'="" Q
 ;ZW GL Q
 S St=TAB_"=",@GLO=@S,@GLO@(1,1)=@S@(1,1),@GLO@(1,2)=@S@(1,2)
 ;W S Q
 S $P(@GLO@(1,1),"@",15)=" DSN:"_DSN,$P(@GLO@(1,2),"@",15)=" TABLE:"_TAB
 S TAB1=$$TRANAME(TAB)
 ;W TAB1
 S I="" F N=1:1 S I=$O(GL(0,I)) Q:I=""  S NAME=GL(0,I),NAME1=$$TRANAME(NAME),@GLO@("DSN",NAME)=NAME1 D
 .S @GLO@(N+1,1)=@S@(2,1),@GLO@(N+1,2)=@S@(2,2)
 .S $P(@GLO@(N+1,1),"@",15)=NAME,$P(@GLO@(N+1,2),"@",18)=NAME1,St=St_NAME1_",",$P(@GLO@(N+1,2),"@",9)=1
 ;W 222 Q
 S $P(@GLO,"@",1)=St,$P(@GLO,"@",17)=1,@GLO@("DSN")=TAB
 S BSR=$QS(GLO,0),BST=$QS(GLO,1),ke=2,se=N ;D RESZER^%ZAPM.bs.BSF2
 D TABm^%ZAPM.bs.BSF1
 Q
TRANAME(N) Q $TR(N,"_/\","vso")      ;ТРАНСЛЯЦИЯ ИМЕН ТАБЛИЦ И ПОЛЕЙ
PART2BSD(PART,TAB) ;TAB="" --> ВСЕ ТАБЛИЦЫ РАЗДЕЛА СДЕЛАТЬ БАЗАМИ (1-1 КЛЮЧ, 2=2 КЛЮЧ И Т.Д.)
 N TA
 I $G(TAB)'="" D TA2BD(PART,TAB)
 S TA="" F  S TA=$O(@PART@(TA)) Q:TA=""  D TA2BD(PART,TA)
 Q
TA2BD(BSR,BST,NOBD,InDx) ;СДЕЛАТЬ БАЗАМИ //новая редакция
 N K,KK,S,BD,nk
 I '$D(@BSR@(BST,"DSN")) S Errors="Таблица не для DSN" Q
 S S="^%ZAPM.bs.BSC(""BSG"")"
 F K=2:1 Q:'$D(@BSR@(BST,K,2))  D
 .I $P(@BSR@(BST,K,2),"@",15)'="" d  q  ;идексы не должны совпадать
 ..d SetKK(+$P(@BSR@(BST,K,2),"@",15),$P(@BSR@(BST,K,1),"@",15),$p($P(@BSR@(BST,K,2),"@",18),"#",1),$P(@BSR@(BST,K,2),"@",21),$P(@BSR@(BST,K,2),"@",17))
 ..S $P(@BSR@(BST,K,2),"@",9)=1
 .;S $P(@BSR@(BST,K,2),"@",15)="" ;НЕ НАДО УДАЛЯТЬ
 .S $P(@BSR@(BST,K,2),"@",9)=2
 I '$D(NOBD) S BD=BSR_"."_BST K @BD,@BSR@(BST,"KEY") S @BD="BSD - MSW@"_BSR_"@"_BST S @BSR@(BST,"KEY")=BD
 S $P(@BSR@(BST),"@",17)=2
 S K="" F NK=1:1 S K=$O(KK(K)) Q:K=""  D NEWKEY($p(KK(K),"@",1),$p(KK(K),"@",2),$p(KK(K),"@",3),$p(KK(K),"@",4))
 F nk=NK:1:9 K @BSR@(BST,"KEY",nk) //УДАЛИТЬ СТАРЫЕ КЛЮЧИ
 I '$G(InDx) D NEWKEY("BSiD","BSiD",0,"")
 D SNX^%ZAPM.bs.BSChT1("S",$TR($NA(@BSR@(BST)),"@",""),"TABLE")
 Q
SetKK(i,s,f,t,d) f  q:'$d(KK(i))  s i=i+0.01
 s KK(i)=s_"@"_f_"@"_t_"@"_d
 q
NEWKEY(N,f,t,d) S @BSR@(BST,"KEY",NK)=@S@("KEY",1)
 S $P(@BSR@(BST,"KEY",NK),"@",5)="НОВОЕ ЗНАЧЕНИЕ "_N,$P(@BSR@(BST,"KEY",NK),"@",9)=NK_" ИНДЕКС"
 S $P(@BSR@(BST,"KEY",NK),"@",15)=N
 S $P(@BSR@(BST,"KEY",NK),"@",22)=f,$P(@BSR@(BST,"KEY",NK),"@",21)=t,$P(@BSR@(BST,"KEY",NK),"@",17)=d
 Q
DSN2BS(DSN,USER,PASS,PART) ;ЗАКАЧАТЬ ИНФОРМАЦИЮ ИЗ DSN В BS-БАЗУ (только 4 ключевую)
 I $G(PART)="" S PART="^"_DSN
 I '$D(@PART) S ErrOR="НЕТ РАЗДЕЛА "_PART Q
 N WEBSQL,I,II
 I $$DescDsn(DSN,$G(USER),$G(PASS))'="" Q
 S I="0" F  S I=$O(WEBSQL(I)) Q:I=""  I WEBSQL(I,2)="TABLE" D
 .D TAB2BSD(DSN,$G(USER),$G(PASS),WEBSQL(I,1),PART,$$TRANAME(WEBSQL(I,1)))
 .;D x^%ZAPM.bs.BS3($G(ErrOR,1))     ;---//--- для msm 4.x.x
 Q
TAB2BSD(DSN,USER,PASS,TAB,PART,TOBD) ;ЗАКАЧАТЬ ИНФОРМАЦИЮ ИЗ ТАБЛИЦЫ В БАЗУ
 N I,Con,Res,Sc,Pid,i,COL,J,JJ,clist,column,info,BD,K,K1,K2,K3,K4,K5,K6,K7,K8,K9,ARR,KEY,KK,XX
 ;ВЫПОЛНЕНИЕ ЗАПРОСА
 S Con=##Class(%SQLGatewayConnection).%New()
 S Sc=Con.Connect(DSN,$G(USER),$G(PASS))
 I 'Sc S ErrOR=$$Status(Sc) G TDsNend
 S Res=##Class(%ResultSet).%New("%DynamicQueryGW:SQLGW")
 S SQL="SELECT * FROM "_TAB
 s Sc=Res.Prepare(SQL,,Con)
 I 'Res.QueryIsValid() S ErrOR="Недопустимый Запрос" G TDsNend
 s Sc=Res.Execute()
 I 'Sc S ErrOR=$$Status(Sc) G TDsNend
 S COL=Res.GetColumnCount()
 F J=1:1:COL S ARR(0,J)=Res.GetColumnName(J),ARR(1,ARR(0,J))=J
 I $G(@PART@(TOBD,"DSN"))'=TAB S ErrOR="Несоответсвие полей таблицы "_$ZR_" -> "_TAB G TDsNend
 S BD=$P(@PART@(TOBD,"KEY"),"@",1)
 F KEY=1:1 Q:'$D(@PART@(TOBD,"KEY",KEY))  S KK(KEY)=$P($P(@PART@(TOBD,"KEY",KEY),"@",5),"НИЕ ",2)
 F K=1:1 Q:'$D(KK(K))  S POLE=KK(K) I POLE'="BSiD" S ARR(2,K)=ARR(1,POLE)
 S KEY=KEY-1
 F J=1:1:COL S ARR(0,J)=$G(@PART@(TOBD,"DSN",ARR(0,J)))
 f iD=1:1 q:'Res.Next()  D  ;Q:iD>50
 .I '$G(AUTO) W " ",iD
 .I KEY=1 S XX="S @BD@(iD,ARR(0,J))=JJ"
 .I KEY=2 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S @BD@(K1,iD,ARR(0,J))=JJ"
 .I KEY=3 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S @BD@(K1,K2,iD,ARR(0,J))=JJ"
 .I KEY=4 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S K3=Res.GetData(ARR(2,3)) S:K3="""" K3=""ZERRO"" S @BD@(K1,K2,K3,iD,ARR(0,J))=JJ"
 .I KEY=5 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S K3=Res.GetData(ARR(2,3)) S:K3="""" K3=""ZERRO"" S K4=Res.GetData(ARR(2,4)) S:K4="""" K4=""ZERRO"" S @BD@(K1,K2,K3,K4,iD,ARR(0,J))=JJ"
 .I KEY=6 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S K3=Res.GetData(ARR(2,3)) S:K3="""" K3=""ZERRO"" S K4=Res.GetData(ARR(2,4)) S:K4="""" K4=""ZERRO"" S K5=Res.GetData(ARR(2,5)) S:K5="""" K5=""ZERRO"" S @BD@(K1,K2,K3,K4,K5,iD,ARR(0,J))=JJ"
 .I KEY=7 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S K3=Res.GetData(ARR(2,3)) S:K3="""" K3=""ZERRO"" S K4=Res.GetData(ARR(2,4)) S:K4="""" K4=""ZERRO"" S K5=Res.GetData(ARR(2,5)) S:K5="""" K5=""ZERRO"" S K6=Res.GetData(ARR(2,6)) S:K6="""" K6=""ZERRO"" S @BD@(K1,K2,K3,K4,K5,K6,iD,ARR(0,J))=JJ"
 .I KEY=8 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S K3=Res.GetData(ARR(2,3)) S:K3="""" K3=""ZERRO"" S K4=Res.GetData(ARR(2,4)) S:K4="""" K4=""ZERRO"" S K5=Res.GetData(ARR(2,5)) S:K5="""" K5=""ZERRO"" S K6=Res.GetData(ARR(2,6)) S:K6="""" K6=""ZERRO"" S K7=Res.GetData(ARR(2,7)) S:K7="""" K7=""ZERRO"" S @BD@(K1,K2,K3,K4,K5,K6,K7,iD,ARR(0,J))=JJ"
 .I KEY=9 S XX="S K1=Res.GetData(ARR(2,1)) S:K1="""" K1=""ZERRO"" S K2=Res.GetData(ARR(2,2)) S:K2="""" K2=""ZERRO"" S K3=Res.GetData(ARR(2,3)) S:K3="""" K3=""ZERRO"" S K4=Res.GetData(ARR(2,4)) S:K4="""" K4=""ZERRO"" S K5=Res.GetData(ARR(2,5)) S:K5="""" K5=""ZERRO"" S K6=Res.GetData(ARR(2,6)) S:K6="""" K6=""ZERRO"" S K7=Res.GetData(ARR(2,7)) S:K7="""" K7=""ZERRO"" S K8=Res.GetData(ARR(2,8)) S:K8="""" K8=""ZERRO"" S @BD@(K1,K2,K3,K4,K5,K6,K7,K8,iD,ARR(0,J))=JJ"
 .F J=1:1:COL I ARR(0,J)'="" S JJ=Res.GetData(J) I JJ'="" X XX
TDsNend ;КОНЕЦ
 I $D(Res) d Res.%Close()
 d Con.Disconnect()
 d Con.%Close()
 Q $G(ErrOR)
 Q
 ;///////////////////////////
DescDsn(DSN,USER,PASS) ;СОСТАВ DSN
 D intDSN^%ZAPM.bs.BSCG(DSN,$G(USER),$G(PASS))
 Q $G(ErV)
DescCol(DSN,USER,PASS,TAB,MAS) ;СОСТАВ КОЛОНОК ТАБЛИЦЫ TAB
 Q $$DsnSql(DSN,USER,PASS,"SELECT * FROM "_TAB,MAS,0,1)  ;ВЫПОЛНЕНИЕ ЗАПРОСА И ФОРМИРОВАНИЕ УЗЛА ОБЕКТОВ
DsnSql(DSN,USER,PASS,SQL,ARR,Rows,DescCol) ;ВЫПОЛНЕНИЕ ЗАПРОСА И ФОРМИРОВАНИЕ УЗЛА ОБЕКТОВ
 N Con,Res,Sc,Pid,i,ErrOR,COL,J,JJ,clist,column,info
 ;ВЫПОЛНЕНИЕ ЗАПРОСА
 S Con=##Class(%SQLGatewayConnection).%New()
 S Sc=Con.Connect(DSN,USER,PASS)
 I 'Sc S ErrOR=$$Status(Sc) G DsNend
 S Res=##Class(%ResultSet).%New("%DynamicQueryGW:SQLGW")
 s Sc=Res.Prepare(SQL,,Con)
 I 'Res.QueryIsValid() S ErrOR="Недопустимый Запрос" G DsNend
 s Sc=Res.Execute()
 I 'Sc S ErrOR=$$Status(Sc) G DsNend
 S COL=Res.GetColumnCount()
 F J=1:1:COL S @ARR@(0,J)=Res.GetColumnName(J)
 I $G(DescCol) G DsNend
 I '$G(Rows) S Rows=99999 ;ПОКА ТАК
 f i=1:1 q:'Res.Next()  I i<Rows D
 .F J=1:1:COL S JJ=Res.GetData(J) I JJ'="" S @ARR@(i,J)=JJ
DsNend ;КОНЕЦ
 I $D(Res) d Res.%Close()
 d Con.Disconnect()
 d Con.%Close()
 Q $G(ErrOR)
]]></Routine>


<Routine name="%ZAPM.bs.BSCRGL" type="MAC" languagemode="0"><![CDATA[
%BSCRGL ;Cache Relational Gateway - Functions ; 9:04   26.06.2001
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
RUN() ;запустить из VISM.ocx
 ;ВХОДНЫЕ ПЕРЕМЕННЫЕ
 ;P1=Data Sours Name 
 ;P2=Name User
 ;P3=Password
 ;P4=SQL
 Q $$DSN(P1,P2,P3,P4)
 ;ВЫХОДНЫЕ ПЕРЕМЕННЫЕ
 ;P5=Second EXECUTIVE
 ;P6=Error
 ;P7=Time
 ;P8=Colomn
 ;P9=Rows
TEST ;ТЕСТЫ
 N DSN,SQL
 ;S DSN="EXZ",SQL="SELECT EKZ_VOP.TEXT_V, EKZ_OTV.TEXT_O FROM EKZ_VOP INNER JOIN EKZ_OTV ON EKZ_VOP.N_NOM = EKZ_OTV.N_VOP"
 ;S DSN="ISSBASE",SQL="SELECT [ConnectRazdel]![Pred] & ' ' & [STR_MENU]![HTML] & ' ' & [ConnectRazdel]![Post] AS HTML_STRING FROM (WORKGROUPS INNER JOIN (STR_MENU INNER JOIN ConnectRazdel ON STR_MENU.Kod = ConnectRazdel.PunktMenu) ON WORKGROUPS.ID_WORKGROUP = ConnectRazdel.Workgroup) INNER JOIN SOTR ON WORKGROUPS.ID_WORKGROUP = SOTR.WORKGROUP WHERE SOTR.NET_NAME='hodov' ORDER BY STR_MENU.Nomer"
 S DSN="KSP",SQL="SELECT * FROM KNH"
 W $$DSN(DSN,"","",SQL)
 Q
DSN(DSN,NAME,PASS,SQL) ;ВЫПОЛНЕНИЕ ЗАПРОСА И ФОРМИРОВАНИЕ УЗЛА ОБЕКТОВ
 N Con,Res,Sc,Pid,i,ErrOR,COL,st ;,P5,P6,P7,P8,P9
 s Pid=$I_","_$J ;ИДЕНТИФИКАТОР ПРОЦЕССА
 ;ПЕРЕЙТИ В СИСТЕМНЫЙ СПЭЙС
 I $zu(5,"%SYS")
 ;ВЫПОЛНЕНИЕ ЗАПРОСА
 S Con=##Class(%SQLGatewayConnection).%New()
 S Sc=Con.Connect(DSN,NAME,PASS)
 S Res=##Class(%ResultSet).%New("%DynamicQueryGW:SQLGW")
 K ^["%SYS"]BStempSql(Pid)
 S $P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),1)=SQL
 S $P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),2)=$ZD($H,9)
 S P5=$P($H,",",2)
 s Sc=Res.Prepare(SQL,,Con)
 I 'Res.QueryIsValid() S ErrOR="Недопустимый Запрос" G DSNend
 s Sc=Res.Execute()
 I 'Sc S ErrOR=$$Status(Sc) G DSNend
 S COL=Res.GetColumnCount()
 F J=1:1:COL S $P(^["%SYS"]BStempSqlist(Pid,"NAM"),$C(0),J)=Res.GetColumnName(J)
 ;F J=1:1:COL S $P(^["%SYS"]BStempSqlist(Pid,"HDR"),$C(0),J)=Res.GetColumnHeader(J)
 ;f i=1:1:10001 q:'Res.Next()  I i<5001 d                                               ;ОГРАНИЧЕНИЯ 
 f i=1:1 q:'Res.Next()  D
 .S st="" F J=1:1:COL S st=st_Res.GetData(J)_$C(0)
 .S ^["%SYS"]BStempSqlist(Pid,i)=st
 S P6=$P($H,",",2),P5=P6-P5
 S $P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),3)=P5 ;КОЛ-ВО СЕКУНД
 S (P8,$P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),7))=COL ;КОЛ-ВО КОЛОНОК
 S (P9,$P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),8))=i-1 ;КОЛ-ВО СТРОК
 S (P7,$P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),5))=$ZT($P($H,",",2),1)
DSNend S (P6,$P(^["%SYS"]BStempSqlist(Pid,"SQL"),$C(0),6))=$G(ErrOR)
 d Res.%Close()
 d Con.Disconnect()
 d Con.%Close()
 Q Pid ;ИДЕНТИФИКАТОР ПРОЦЕССА
Status(sc) ;СТАТУС
 N err,i,st1
 I ('sc) D  Q st1
 .D DecomposeStatus^%apiOBJ(sc,.err)
 .S st1="" F i=1:1:err S st1=st1_err(i)_". "
 Q ""    
KILL(P) ;УДАЛЕНИЕ УЗЛА
 I $G(P)'="",$D(^["%SYS"]BStempSqlist(P)) K ^(P) Q 1
 Q 0
SEC(P) ;КОЛ-ВО СЕКУНД
 I $G(P)'="" Q $P($G(^["%SYS"]BStempSqlist(P,"SQL")),$C(0),3)
 Q ""
ROWS(P) ;КОЛ-ВО СТРОК
 I $G(P)'="" Q $P($G(^["%SYS"]BStempSqlist(P,"SQL")),$C(0),8)
 Q 0
COLS(P) ;КОЛ-ВО КОЛОНОК
 I $G(P)'="" Q $P($G(^["%SYS"]BStempSqlist(P,"SQL")),$C(0),7)
 Q 0     
ERRORS(P) ;ОШИБКИ
 I $G(P)'="" Q $P($G(^["%SYS"]BStempSqlist(P,"SQL")),$C(0),6)
 Q 0     
]]></Routine>


<Routine name="%ZAPM.bs.BSCSVG" type="MAC" languagemode="0"><![CDATA[
%BSCSVG ;ПРОГРАММА РАБОТЫ С SVG
 ;
 ;    Copyright Serge Mikhaylenko
 ;    All Rights Reserved
 ;
 ;
 Q
SVG ;ВЫВЕСТИ ВСЕ ГЛОБАЛЬНЫЕ БУФЕРА
 D BEG1^%ZAPM.bs.BSC4
 S BSLABEL="GET^~BSCSVG"
 D BSVG
 w "</HTML>",BK
 q
BSVG W "<BUTTON onclick=""open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"','','toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1')"" title='Открыть SVG'>ЗАГРУЗИТЬ ФАЙЛ SVG</BUTTON>"
 Q
GET  W "HTTP/1.0 200 OK"_BK
 W "Content-type: image/svg+xml"_BK
 ;W "Set-Cookie: cookie_name=cookie_value; path=/;",CRLF
 ;W "Window-target: main_window",CRLF
 W BK
 D SVGOUT
 Q
SVGOUT I '$D(BK) S BK=$C(13,10)
 N M,MM
 ;S F="N:\InfoPortal\WebNodes\vv\svg\sample\anim[1].svg"
 S F="N:\InfoPortal\WebNodes\vv\svg\sample\mgwms32[4].svg"
 D File2Arr^%ZAPM.bs.BSCEXE(F,.M)
 d STR2MAS^%ZAPM.bs.BSCmail(.M,.MM,BK)
 S I="" F  S I=$O(MM(I)) Q:I=""  D
 .;W !,I,"-->>>>>>>>>",MM(I)_BK
 .I MM(I)'["<circle fill" W MM(I)_BK
 Q
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCek" type="MAC" languagemode="0"><![CDATA[
%BSCek //Call-In ФУНКЦИИ Е.Каратаева
INIT(D) //ИНИЦИАЛИЗАЦИИ ФУНКЦИЙ
 N I,A,i S A="ekzlib.dll?ekelog.dll?ekguid.dll?ekreg.dll?ekimg.dll?ekscr.dll?ekntlm.dll",i=1
 F I="ekzlib","ekelog","ekguid","ekreg","ekimg","ekscr","ekntlm" S ^%eklib(I,"library")=D_$P(A,"?",i),i=i+1
 Q
NTLM //проверка пароля у пользователя
 w $$Validate^%zekntlm("","Mikhaylenko","123") 
 q
LOG //Cache': плагин для EventLogging
 s AppName="August Application"
 s EventType="I" ;E(rror) W(arning) I(nformation)
 s EventCategory="1"
 s EventID=1
 s EventMessage="Hello, event logging!"
 d LogData^%zekelog(AppName,EventType,EventCategory,EventID,EventMessage)
 q
SYSMSG(EventMessage,EventType,APP) //ЗАПИСАТЬ В СИСТЕМНЫЕ СООБЩЕНИЯ WINDOWS
 I $ZV'["Windows" Q
 S $ZT="SYSMSGerr" ; EventType=E(rror) W(arning) I(nformation)
 d LogData^%zekelog($G(APP,"%BS-Portal"),EventType,"","",EventMessage)
SYSMSGerr 
 Q
GUID //Cache' плагин для генерации GUID
 w $$GetGuid^%zekguid()
 q
REG //Cache': плагин для доступа к реестру
 I $ZV'["Windows" W $ZV Q
 K svc d GetKeyNames^%zekreg("HKLM","SYSTEM\CurrentControlSet\Services",$na(svc))
 zw svc
 w !,"----------",!
 s Key="SYSTEM\CurrentControlSet\Services\Cache_e-_cachesys"
 s Root="HKLM"
 d GetValueNames^%zekreg(Root,Key,$na(cache))
 zw cache
 W !!!!
 q
ZLIB //Cache': плагин для компрессора - декомпрессора zlib.
 n file,Source,Target,str,size,t
 w "stream test",!
 s t=$ztimestamp
 ; load zekzlib library
 d LoadLib^%zekzlib()
 s file=##class(%Library.File).%New("c:\!\cache.dat")
 d file.Open("RU")
 ; create ekzlib internal streams
 s Source=$$NewStream^%zekzlib()
 s Target=$$NewStream^%zekzlib()
 ; write entire file content into internal stream
 s size=32000
 f  q:size<1  d
 . s str=file.Read(.size)
 . d WriteStream^%zekzlib(Source,str)
 w t_" "_$ztimestamp,!
 s t=$ztimestamp
 d file.Close() ; close file system object
 d file.%Close() ; close Cache object
 ; restore stream location into first position
 d SetPosition^%zekzlib(Source,0)
 ; compress Source to Target using best compression level
 d Compress^%zekzlib(Source,Target)
 w t_" "_$ztimestamp,!
 s t=$ztimestamp
 w "Source size: "_$$GetStreamSize^%zekzlib(Source),!
 w "Target size: "_$$GetStreamSize^%zekzlib(Target),!
 ; remove source internal ekzlib streams
 d KillStream^%zekzlib(Source)
 d KillStream^%zekzlib(Target)
 ; unload zekzlib library
 d UnloadLib^%zekzlib()
 q
IMG //Cache': плагин для генерации графического файла 
 ;http://127.0.0.1:1972/csp/samples/ekImageTest.CSP
 /*
 <html><head>
  <title>This is image container</title>
</head>
<body>
 
<div align="center">
<table width=570 border=0 cellspacing=0 cellpadding=0>
<tr><td><hr>
<p>
<center>This is test image</center>
<p>
<center><img src="ekGetImage.csp"></center>
<p>
<hr>
</td></tr></table>
</div>
 
</body>
</html>
 */
 /*
 <script language=CACHE method=OnPreHTTP arguments="" returntype=%Boolean>
  ; no any symbols before opening tag!
  Set %response.ContentType="image/gif"
</script><script language=CACHE runat=server> ; we cannot insert any symbols between tags!
 n stream,str
 d LoadLib^%zekimg()
 
 ; create new image
 d CreateImage^%zekimg(400,300,8)
 
 ; create image content
 d MoveTo^%zekimg(10,10)
 d LineTo^%zekimg(30,50)
 d SetPenColor^%zekimg($ZH("FF0000"))  ; bgr blue - green - red
 d LineTo^%zekimg(100,60)
 d SetPenColor^%zekimg($ZH("00FF00"))  ; bgr blue - green - red
 d LineTo^%zekimg(150,100)
 d SetPenColor^%zekimg($ZH("0000FF"))  ; bgr blue - green - red
 d LineTo^%zekimg(300,200)
 d SetFontColor^%zekimg($ZH("FF00FF"))
 d SetFontSize^%zekimg(26)
 d SetFontName^%zekimg("Times New Roman")
 d TextOut^%zekimg(10,150,"Hello, World!")
 
 ; out image data
 s stream=$$NewStream^%zekimg()
 d GetGIFData^%zekimg(stream) ; image format must be the same as declared in Content-Type
 d SetPosition^%zekimg(stream,0)
 
 ; out all stream content to device
 f  s str=$$ReadStream^%zekimg(stream,32000) q:str=""  w str
 
 d KillStream^%zekimg(stream)
 d UnloadLib^%zekimg()
 ; no any symbols after closing tag!
</script>
 
 */
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSCh" type="MAC" languagemode="0"><![CDATA[
%BSCh ;ФУНКЦИИ HTML  ; 13:48   12.09.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 ;D INIT^%ZAPM.bs.BSChW ;ПЕРВОНАЧАЛЬНАЯ ИНИЦИАЛИЗАЦИЯ КОМПЛЕКСА
 Q
APPVAL() ;ВЕРНУТЬ ГЛОБАЛЬНУЮ ССЫЛКУ ПРИЛОЖЕНИЯ ???
 N GS S GS=$$GETMP^%ZAPM.bs.BSCp($P($G(%KEY("BSUSER")),",",3),Grand) I $$Data^%ZAPM.bs.BSF12(GS) Q GS
 Q ""
ADMIN() ;ПОЛЬЗОВАТЕЛЬ - АДМИНИСТРАТОР ?
 N GS
 I $G(NameUS)'="" S GS=$$APPVAL I GS'="",$D(@GS@("-3")) Q 1
 Q 0
VAR ;СОЗДАНИЕ НУЖНЫХ ПЕРЕМЕННЫХ
 S GREEN="<font color=Green>",RED="<font color=Red>",BLUE="<font color=Blue>",MAROON="<font color=Maroon>",GOLD="<font color=GOLD>",AQUA="<font color=AQUA>"
 S AF="<font size=1 face='Arial, Helvetica, MS Sans Serif'>"
 S (BK,CRLF)=$C(13,10),EF="</font>",(BBK,BR)="<br>"_BK
 s $P(%BS(44),",",1)=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aevlog")
 s $P(%BS(44),",",2)=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aevlogmail")
 s $P(%BS(44),",",3)=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aevlog1")
 Q
%(S) ;ТРАНСЛЯЦИЯ СТРОКИ //&nbsp;
 S S=$TR(S,"~|","%"_$C(34))
 I S["%20" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"%20"," ")
 Q S
%T(S) ;ТРАНСЛЯЦИЯ СТРОКИ
 I S[" " S S=$$TR^%ZAPM.bs.BSsFUNM(S," ","%20")
 Q $TR(S,"%"_$C(34),"~|")
IMG I $G(%KEY("BSONLY")) W "<P><IMG "_$$0(5)_"></P>"_CRLF Q
 W "<P><A HREF="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"""><IMG "_$$0(5)_"></A></P>"_CRLF
 Q
0(N) ;НОМЕР ПАРАМЕТРА ИЗ ^%ZAPM.bs.BSC("HTML"_?,N)
 I $G(NuMHtml)'="" S N=N+$S(NuMHtml=1:8,NuMHtml=2:12,NuMHtml=3:16,NuMHtml=4:20,1:1)-2
 I $D(MainTabl),$$Data^%ZAPM.bs.BSF12(MainTabl) Q $P($G(@MainTabl@(N,2)),"@",15)
 Q "" ;```$P($G(^%ZAPM.bs.BSETUP("HTML",N,2)),"@",15)
BACK ;ЯКОРЬ НАЗАД
 N A I $G(BSDOMAIN)'="" S A=" src='"_BSDOMAIN_"/img/back.gif' "
 E  S A=$$0(33) 
 I A="" S A="Назад"
 E  S A="<IMG "_A_" border=0 align=""bottom"">"
 W "<A HREF=""javascript:history.back(1)"">Возврат&nbsp;"_A_"</A>"_CRLF
 Q
CRT(T) ;ЗАГОТОВКА ТАБЛИЦЫ
 N CRLF
 S CRLF=$C(13,10)
 W "<TABLE BORDER>",CRLF
 W "<CAPTION><B><H3>",$G(T),"</H3></B></CAPTION>",CRLF
 Q
ENT W "</TABLE><HR>",$C(13,10)
 Q
FORMN(nA) ;НАЧАЛЬНЫЙ ТЕГ ФОРМЫ С ИМЕНЕМ
FORM ;НАЧАЛЬНЫЙ ТЕГ ФОРМЫ
 w "<form action="""_%KEY("MGWLIB")_"""" d  w " method=""POST"">",$G(BK)
 .i $d(nA) W " name="""_nA_""""
 ;I $G(%KEY("MGWLPN"))'="" w "<input type=""hidden"" name=""MGWLPN"" value="""_%KEY("MGWLPN")_""">",$G(BK)
 ;I $G(%KEY("MGWCHD"))'="" w "<input type=""hidden"" name=""MGWCHD"" value="""_%KEY("MGWCHD")_""">",$G(BK)
 ;I $G(%KEY("MGWAPP"))'="" w "<input type=""hidden"" name=""MGWAPP"" value="""_$G(%KEY("MGWAPP"))_"""></P>",$G(BK)
 I $G(%KEY("BSG"))'="" w "<input type=""hidden"" name=""BSG"" value="""_$G(%KEY("BSG"))_"""></P>",$G(BK)
 w "<input type=""hidden"" name=""BSUSER"" value="""_$G(%KEY("BSUSER"),"GUEST")_""">",$G(BK)
 Q
BK() Q $C(13,10)
Er(S) ;СООБЩЕНИЕ ОБ ОШИБКЕ
 D CRP(S,4,2),END(7)
 Q
Ok(S) ;СООБЩЕНИЕ
 D CRP(S,4,1),END(7)
 Q
JavaComm W "<!--",BK
 W BK,"// -->",BK Q
JavaS(NU) I $$0(NU)="" Q  ;ЕСЛИ НЕТ ДЖАВЫ-SCRIPT
 W BK,"<SCRIPT LANGUAGE=""JavaScript"" SRC="""_$$0^%ZAPM.bs.BSCh(NU)_""">",BK
 W "</SCRIPT>",BK Q
CRP(SaY,V,NuMHtml)  ;ЗАГОТОВКА СТАНДАРТНОЙ СТРАНИЦЫ
 N CRLF ; NuMHtml=1 OK 2-ER 3-? 4-!
 S CRLF=$C(13,10)
 W "<HTML>",CRLF I $G(%KEY("BSCAPTION"))'="" S SaY=%KEY("BSCAPTION")
 W "<HEAD><TITLE>"_$$0(2)_" "_$G(SaY)_"</TITLE>"
 W "</HEAD>",CRLF
 W "<BODY "_$$0(3)_">",CRLF
 W "<P>"
 D IMG
 I $G(V)'="" D
 .I +$G(V) W $$0(4)
 .E  W V
 W "</P>",CRLF
 W "<HR>"
 I $G(SaY)'="" W "<H2>"_$G(SaY)_"</H2>",CRLF
 Q
END(T) ;ЗАВЕРШЕНИЕ СТРАНИЦЫ
 I $G(%KEY("BSONLY")) G ENDe
 I $G(T)'="" D
 .I +$G(T) W "<H6>",$$0(T),"</H6>"
 .E  W "<H6>",$$MAIL(T),"</H6>"
ENDe W "<H6>%BS versions ",$G(^%ZAPM.bs.BS),",  ID proc=",$J,", Service=",$G(%KEY("MGWLPN")) I '$G(%KEY("BSONLY")) W ", NS=",BLUE,$$ZU^%ZAPM.bs.BS3(0),EF,", Storage=",$S,", UseDevice=",$I
 W "<br>",$zv," ",BLUE,$ZU(110),EF,"</H6>"
END2 W "</BODY>",BK
 W "</HTML>",BK
 Q
KILLJOB ;W "<a href="""_$$A()_$$NS()_"MGWCDN="_$G(%KEY("MGWCHD"))_"&BSROU=TERMIN^~BSCh1""><IMG "_$$0(6)_">Полностью Завершить Работу</a>"
 ;W "<P>"          _"&MGWCHD="_$G(%KEY("MGWCHD"))_"&"
 ;D FORM
 ;w "<input type=""hidden"" name=""MGWCTO"" value=""5"">"
 ;w "<input type=""hidden"" name=""BSROU"" value=""TERMIN^~BSCh1"">"
 ;w "<input type=""SUBMIT"" name=""B1"" value=""Полностью Завершить Работу"">"
 ;W "</P>"
 Q
MAIL(T) Q "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=MAIL^~BSCh1"">"_T_"</a>"
NS() Q "BSNSPACE="_$$%T($G(%KEY("BSNSPACE"),"~SYS"))_"&"
A() N A S A="Z=A"
 ;I $G(%KEY("MGWLPN"))'="" S A=A_"&MGWLPN="_$G(%KEY("MGWLPN"))
 ;I $G(%KEY("MGWCHD"))'="" S A=A_"&MGWCHD="_$G(%KEY("MGWCHD"))
 ;I $G(%KEY("MGWAPP"))'="" S A=A_"&MGWAPP="_$G(%KEY("MGWAPP"))
 I $G(%KEY("BSONLY"))'="" S A=A_"&BSONLY="_%KEY("BSONLY")
 I $G(%KEY("BSG"))'="" S A=A_"&BSG="_$G(%KEY("BSG"))
 ;Q "http://"_$G(%CGIEVAR("SERVER_NAME"))_$G(%KEY("MGWLIB"))_"?"_A_"&BSUSER="_$G(%KEY("BSUSER"),"GUEST")_"&"
 Q $$ADDLIB^%ZAPM.bs.BSC4()_A_"&BSUSER="_$G(%KEY("BSUSER"),"GUEST")_"&"
ONLY() I $G(%KEY("BSONLY")) Q "&BSONLY="_%KEY("BSONLY")
 Q ""
WebServer() q "http://"_$G(%CGIEVAR("SERVER_NAME"))
3(A1,T1,A2,T2,A3,T3,A4,A5) ;ТРИ+1+1 ССЫЛКИ
 W "<table border=""0"" width=""100%"">"
 W "<tr>"
 I $G(A4)'="" W "<td width=""25%""><p align=""center"">",A4,"</td>"
 W "<td width=""25%""><p align=""center"">" I $G(A1)'="" W "<a href="""_$$A()_$$NS()_A1_""">"_T1_"</a></td>"
 W "<td width=""25%""><p align=""center"">" I $G(A2)'="" W "<a href="""_$$A()_$$NS()_A2_""">"_T2_"</a></td>"
 W "<td width=""25%""><p align=""center"">" I $G(A3)'="" W "<a href="""_$$A()_$$NS()_A3_""">"_T3_"</a></td>"
 I $G(A5)'="" W "<td width=""25%""><p align=""center"">",A5,"</td>"
 W "</tr>"
 W "</table>"
 Q
WHO ;КТО ЭТО
 Q:$G(NameUS)=""
 W "<P>Вы вошли в систему под именем: <FONT COLOR=RED>",NameUS W " (",$$TRAN($$FullName^%ZAPM.bs.BSCp(NameUS)),")</FONT>"
 W "<BR> Текущая Рабочая Область <FONT COLOR=RED>",$$ZU^%ZAPM.bs.BS3(0),"</FONT>"
 ;I $G(@%BS(18)@(NameUS,0,"9,4"))'="" S i=@$ZR W "<BR> Рабочая группа пользователей <FONT COLOR=RED>",i,"</FONT>"
 I $$ADMIN() W "<BR>ВЫ ИМЕЕТЕ ПРАВА АДМИНИСТРАТОРА." D
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=EDIT^~BSChT1&BSTABL=MAIL&BSPART=^~BSC"" TITLE='база данных сообщений'> Messages |</a>"
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=EDIT^~BSChT1&BSTABL=PROTECT&BSPART=^~BSC"" TITLE='база данных пользователей'> Users |</a>"
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=EDIT^~BSChT1&BSTABL=GRAND&BSPART=^~BSC"" TITLE='база данных прав доступа'> Grand |</a>"
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=EDIT^~BSChT1&BSTABL=TRM&BSPART=^~BSVOL"" TITLE='база данных терминалов'> Trm |</a>"
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=EDIT^~BSChT1&BSTABL=VISIT&BSPART=^~BSC"" TITLE='база данных визитов'> Visits |</a>"
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=OPTION^~BSChA"" TITLE='редактировать основные параметры'> Option |</a>"
 .W "<a href="""_$$A()_$$NS()_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=NETOPT^~BSChA"" TITLE='редактировать сетевые параметры'> NetOpt |</a>"
 w "</P><HR>"
I Q
TRAN(S) ;ТРАНСЛЯЦИЯ
 I $$IFDOS(S) N S1,S2 Q $$ANSI^%ZAPM.bs.BSre(S)
 Q S
IFDOS(S) ;ПРОВЕРКА КОДИРОВКИ
 I $TR(S,$C(128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175),"")'=S Q 1
 Q 0
 ;********************************************************************************
 ;  ПРОГРАММНЫЕ МОДУЛИ ВИЗИТОВ
 ;  P="P" попыток ,"R" регистаций ,"E" ошибок "Q" запросов к бд
 ;
TOBD() N TB,BD S TB=$S($G(APP)="":$$0^%ZAPM.bs.BSCh(25),1:"^%ZAPM.bs.BSC(""VISIT"")")
 S BD=$$KBD^%ZAPM.bs.BSF12(TB) I '$$Data^%ZAPM.bs.BSF12(BD) Q ""
 I '$D(CurUS) S CurUS=$$ADDRIP^%ZAPM.bs.BSC4
 Q BD
GetUsersVisit(P,APP) ;КОЛИЧЕСТВО ВИЗИТОВ ПОЛЬЗОВАТЕЛЕЙ С ТЕКУЩЕГО АДРЕСА
 S BD=$$TOBD I BD="" Q 0
 I $G(APP)'="" Q $G(@BD@("USERS",APP,CurUS,P))
 Q +$G(@BD@("USERS",CurUS,P))
GetAllVisit(P,APP) ;КОЛИЧЕСТВО ВСЕГО ВИЗИТОВ СО ВСЕХ АДРЕСОВ
 S BD=$$TOBD I BD="" Q 0
 I $G(APP)'="" Q $G(@BD@("ALL",APP,"ALLIP",P))
 Q +$G(@BD@("ALL","ALL",P))
ADDVISIT(P,APP) ;ВИЗИТ  P="P","R","E","Q"
 D MAINVAR^%ZAPM.bs.BSC4
 D Tex^%ZAPM.bs.BSMSMF("APP="_$G(APP)_" VISIT:"_P,$G(U)_","_$G(BSR)_","_$G(BST)_","_$G(EDIT)_","_$G(MODE)_","_$G(BSLOGIN)_","_$G(BSSES))
 Q
 /*N U1
 S BD=$$TOBD I BD="" Q
 S U1=$P($$h^%ZAPM.bs.BS3,",")
 S Time1=+$P($ZT($P($H,",",2),1),":")
 I $G(APP)'="" D  Q
 .S @BD@(U1,APP,CurUS,Time1,P)=$G(@BD@(U1,APP,CurUS,Time1,P))+1
 .S @BD@(U1,APP,CurUS,P)=$G(@BD@(U1,APP,CurUS,P))+1
 .S @BD@("USERS",APP,CurUS,P)=$G(@BD@("USERS",APP,CurUS,P))+1
 .S @BD@("USERS","ALLAPP",CurUS,P)=$G(@BD@("USERS","ALLAPP",CurUS,P))+1
 .S @BD@("ALL",APP,"ALLIP",P)=$G(@BD@("ALL",APP,"ALLIP",P))+1
 .S @BD@("ALL","ALLAPP","ALLIP",P)=$G(@BD@("ALL","ALLAPP","ALLIP",P))+1
 S @BD@(U1,CurUS,Time1,P)=$G(@BD@(U1,CurUS,Time1,P))+1
 S @BD@(U1,CurUS,P)=$G(@BD@(U1,CurUS,P))+1
 S @BD@("USERS",CurUS,P)=$G(@BD@("USERS",CurUS,P))+1
 S @BD@("ALL","ALL",P)=$G(@BD@("ALL","ALL",P))+1
 Q  */
ShowVisit(APP) Q
 /*W "<h5 align=""left""><font face=""Times New Roman"">Обращений к модулю :"
 W "&nbsp;&nbsp;Всего = "_$$GetAllVisit("Q",APP)_","
 W "&nbsp;&nbsp;"_"с данного компьютера ="_$$GetUsersVisit("Q",APP)_"</font></h5>",$c(13,10)
 Q  */
StatVisit(APP) ;СТАТИСТИКА
 S BD=$$TOBD I BD="" Q
 w BK,"<table border=""1"">",BK
 w "<tr>",BK
   w "<td>Статистика для текущего приложения '"_APP_"'</TD>"
   w "<td align=""center""><strong>Входов</strong></td>",BK
   w "<td align=""center""><strong>Регистраций</strong></td>",BK
   w "<td align=""center""><strong>Запросов в Базе Данных</strong></td>",BK
   w "<td align=""center""><strong>Ошибок</strong></td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>с IP-адреса "_$g(CurUS)_"</strong></td>",BK
   w "<td>"_+$g(@BD@("USERS",APP,CurUS,"P"))_"</td>",BK
   w "<td>"_+$g(@BD@("USERS",APP,CurUS,"R"))_"</td>",BK
   w "<td>"_+$g(@BD@("USERS",APP,CurUS,"Q"))_"</td>",BK
   w "<td>"_+$g(@BD@("USERS",APP,CurUS,"E"))_"</td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>Всего</strong></td>",BK
   w "<td>"_+$g(@BD@("ALL",APP,"ALLIP","P"))_"</td>",BK
   w "<td>"_+$g(@BD@("ALL",APP,"ALLIP","R"))_"</td>",BK
   w "<td>"_+$g(@BD@("ALL",APP,"ALLIP","Q"))_"</td>",BK
   w "<td>"_+$g(@BD@("ALL",APP,"ALLIP","E"))_"</td>",BK
 w "</tr>"
  w "</table>",BK
 Q
 ;********************************************************************************
]]></Routine>


<Routine name="%ZAPM.bs.BSCh0" type="MAC" languagemode="0"><![CDATA[
%BSCh0 ;HTML; 12:48   05.01.00 ; 13:27   04.01.2002
 ;
 ; Copyright (C) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
TESTING D TEST("Тестирование ...") Q
VARTEST D TEST("Показать Локальные Переменные","") Q
BSG(bsg) ;ДИСПЕТЧЕР ПРОГРАММ %BS+++CACHE WEB-LINK
 s $zt="ErrBSG^%ZAPM.bs.BSCh0"
 S bsd=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""BSG"")")
 I bsd="" W $$CRP("БАЗА ДАННЫХ ССЫЛКИ '"_bsg_"' НЕ ОПРЕДЕЛЕНА !") Q
 I '$D(@bsd@(bsg)) W $$CRP("ССЫЛКА '"_bsg_"' ПУСТАЯ !") Q
 S BSROU=$G(@bsd@(bsg,"ROU")),NSPACE=$G(@bsd@(bsg,"NSP")) ;,ROU=$P(BSROU,"^",2) /////
 I $G(MGWLIB)["mgwms32.dll" I $G(@bsd@(bsg,"MGWSTO")) S MGWSTO=+@$ZR I MGWSTO<120 S MGWSTO=120
 I $G(@bsd@(bsg,"BSdebug"))'="" S BSdebug=@$ZR //ОТЛАДЧИК ВКЛЮЧЕН
 I $G(NSPACE)'="",'$$ZU^%ZAPM.bs.BSF4(NSPACE) W $$CRP("Нет NameSpace='"_NSPACE_"' !") Q
 I '$$EXIST^%R($P(BSROU,"^",2)_".INT") W $$CRP("В NameSpace='"_$zu(5)_"' НЕТ ПРОГРАММЫ '^"_BSROU_"' !") Q
 S %KEY("BSNSPACE")=NSPACE,%KEY("BSROU")=BSROU
 D @BSROU
 Q
CRP(S) Q "<H2>"_S_"</H2>"
ErrHEAD ;ЗАГОЛОВОК
 S ErrorCount=$G(ErrorCount)+1 I ErrorCount>10 H  //Если зацикливание...
 w $c(13,10)," <STYLE TYPE=""text/css"">",$c(13,10)
 w "  DIV {color:black; }",$c(13,10)
 w "  .expandedVAR {color:black; }",$c(13,10)
 w "  .collapsedVAR {display:none}",$c(13,10)
 w " </STYLE>",$c(13,10)
 w " <SCRIPT LANGUAGE=""JavaScript"">",$c(13,10)
 w "  function outlinerVAR() {",$c(13,10)
 w "      var child =",$c(13,10)
 w "        document.all[event.srcElement.getAttribute(""child"",",$c(13,10)
 w "           false)];",$c(13,10)
 w "     if (null != child) ",$c(13,10)
 w "        child.className = child.className == ""collapsedVAR"" ?",$c(13,10)
 w "           ""expandedVAR"" : ""collapsedVAR"";",$c(13,10)
 w "  }",$c(13,10)
 w " </SCRIPT>",$c(13,10)
 W $$meta^%ZAPM.bs.BSC4,$c(13,10)
 Q
ErrTxt(ZE) Q "<STRONG><FONT TITLE='"_$$ErrSay^%ZAPM.bs.BSF8(ZE)_"' COLOR=RED>"_$$TRa(ZE)_"</FONT></STRONG>"
ErrBSG I $ZE["<WRITE" Q
 S CRLF=$C(13,10) D ErrHEAD
 W "<TABLE><TR><TD>ОШИБКА:</TD><TD>"_$$ErrTxt($ZE)_"</TD></TR>"
 D Tex^%ZAPM.bs.BSMSMF("Error Web="_$ze,$G(bsg,"?")_","_$G(BSROU)_","_$ZN_","_$ZU(5)_","_$G(%KEY("MGWLPN"),"?")_","_$s_","_$G(BSSES))
 W "<TR><TD>WEBLINK ПРИЛОЖЕНИЕ:</TD><TD>",$G(bsg,"?"),"</TD></TR>"
 W "<TR><TD>ВЫЗЫВАЕМАЯ ПРОГРАММА:</TD><TD>",$G(BSLABEL,"?"),"</TD></TR>"
 W "<TR><TD>ВЫЗЫВАЮЩАЯ ПРОГРАММА:</TD><TD>",$ZN,"</TD></TR>"
 W "<TR><TD>РАБОЧАЯ ОБЛАСТЬ:</TD><TD>",$ZU(5),"</TD></TR>"
 W "<TR><TD>ID ПРОЦЕССА:</TD><TD>",$J,"</TD></TR>"
 W "<TR><TD>ИМЯ СЕРВИСА:</TD><TD>",$G(%KEY("MGWLPN"),"?"),"</TD></TR>"
 W "<TR><TD>РАЗМЕР РАЗДЕЛА</TD><TD>",$S,"</TD></TR></TABLE>"
 D LOCLIST(1)
 Q
RUN ;ДИСПЕТЧЕР ПРОГРАММ %BS+CACHE WEB-LINK
 N ROU,RO,OldNS,NSPACE
 s $zt="ErrBSG^%ZAPM.bs.BSCh0" 
 S ROU=$$%^%ZAPM.bs.BSCh(%KEY("BSROU")),RO=$P(ROU,"^",2)
 I $D(%KEY("BSNSPACE")) S NSPACE=$$%^%ZAPM.bs.BSCh(%KEY("BSNSPACE"))
 s OldNS=$zu(5)
 I $G(NSPACE)'="",$zu(5,NSPACE)
 D
 .I '$D(^ROUTINE(RO)) W "В NSP='"_$zu(5)_"' НЕТ ПРОГРАММЫ '"_ROU_"' !" Q
 .D @ROU
 s OldNS=$zu(5,OldNS)
 Q
TRQ(S) ;ТРАНСЛИРОВАТЬ ""
 Q $$TR^%ZAPM.bs.BSsFUNM(S,$C(34),"&quot;")
TRa(S) ;ТРАНСЛИРОВАТЬ <>
 S S=$$TR^%ZAPM.bs.BSsFUNM(S,"<","&lt;")
 Q $$TR^%ZAPM.bs.BSsFUNM(S,">","&gt;")
Err I $ZE["<WRITE" Q
 W RED_$$TRa($ZE)_EF,$C(13,10)
 D TEST("Error Executing ! "_$ZT,$ze)
 Q
ERRSEND ;ПОСЫЛКА ОШИБКИ АДМИНИСТРАТОРУ
 N BD,U1,U2,U3,NuMHtml,CurUS
 D MAINVAR^%ZAPM.bs.BSCh1
 S BD=$$KBD^%ZAPM.bs.BSF12($$0^%ZAPM.bs.BSCh(24)) I '$$Data^%ZAPM.bs.BSF12(BD) Q
 S U1=$P($$h^%ZAPM.bs.BS3,","),U2=$P($$h^%ZAPM.bs.BS3,",",2)
 S @BD@(U1,CurUS,U2,"B")=$G(ErR)
 S @BD@(U1,CurUS,U2,"U")=$G(%BS(CurUS))
 S @BD@(U1,CurUS,U2,"T")="<ERROR>"
 S @BD@(U1,CurUS,U2,"A")=4
 Q
TEST(SaY,ErR) ; Simple test page
 D MAINVAR^%ZAPM.bs.BSCh1
 D CRP^%ZAPM.bs.BSCh(SaY,"<H3>Тестовая страница</H3>",4)
 D VAR^%ZAPM.bs.BSCh D ErrHEAD
 I $D(ErR) W RED_$$TRa(ErR)_EF D ERRSEND
 W "<HR>"
 W "НОМЕР ЗАДАНИЯ $J=",RED,$J,EF," НА М-СЕРВЕРЕ=",RED,$G(%KEY("MGWLPN")),EF," ТЕКУЩАЯ NameSpace=",RED,$zu(5),EF,BR,BK
 W "ТЕКУЩЕЕ УСТРОЙСТВО $I=",RED,$I,EF," В РАЗДЕЛЕ $S=",RED,$S,EF," БАЙТ",BK
 W " ВЫЗЫВАЕМАЯ ПРОГРАММА :",RED,$G(BSROU,"?"),$C(13,10),EF
 W " ВЫЗЫВЮЩАЯ ПРОГРАММА :",RED,$ZN,$C(13,10),EF
 I $D(ErR) G TEST2
 I '$D(CurUS)!('$D(%BS(CurUS)))!('$D(%BS(18)))!('$D(%BS(CurUS))) G TEST1
 I '$$ADMIN^%ZAPM.bs.BSCh G TEST1
TEST2 D LOCLIST(0)
 W "<H5 child='LOC2' onclick=""outlinerVAR();"">ПЕРЕМЕННЫЕ (%KEY(Node)=Value)</H5>",CRLF
 W "<DIV ID='LOC2' CLASS='collapsedVAR'>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<TR><TH>Node</TH><TH>Value</TH></TR>",CRLF
 S KEY=""  F  S KEY=$O(%KEY(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",$G(%KEY(KEY)),"</TD></TR>",CRLF
 W "</TABLE></DIV>",CRLF
 
 W "<H5 child='LOC3' ONCLICK=""outlinerVAR();"">ПЕРЕМЕННЫЕ CGI ОКРУЖЕНИЯ (%CGIEVAR(Node)=Value)</H5>",CRLF
 W "<DIV ID='LOC3' CLASS='collapsedVAR'>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<TR><TH>Node</TH><TH>Value</TH></TR>",CRLF
 S KEY=""  F  S KEY=$O(%CGIEVAR(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",%CGIEVAR(KEY),"</TD></TR>",CRLF
 W "</TABLE></DIV>",CRLF
 
 W "<H5 child='LOC4' ONCLICK=""outlinerVAR();"">ПЕРЕМЕННЫЕ CGI ОКРУЖЕНИЯ (%CGI(Node)=Value)</H5>",CRLF
 W "<DIV ID='LOC4' CLASS='collapsedVAR'>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<TR><TH>Node</TH><TH>Value</TH></TR>",CRLF
 S KEY=""  F  S KEY=$O(%CGI(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",%CGI(KEY),"</TD></TR>",CRLF
 W "</TABLE></DIV>",CRLF
 
 W "<H5 child='LOC5' ONCLICK=""outlinerVAR();"">ПЕРЕМЕННЫЕ TP-WEB-LINK ОКРУЖЕНИЯ (%ZCS(Node)=Value)</H5>",CRLF
 W "<DIV ID='LOC5' CLASS='collapsedVAR'>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<TR><TH>Node</TH><TH>Value</TH></TR>",CRLF
 S KEY=""  F  S KEY=$O(%ZCS(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",%ZCS(KEY),"</TD></TR>",CRLF
 W "</TABLE></DIV>",CRLF
TEST1
 ;D RETURN("")
 D END^%ZAPM.bs.BSCh("")
 Q
HREFVAR(S) Q "<a href="""_$$A^%ZAPM.bs.BSCh()_"BSROU=VARTEST^~BSCh0"">"_S_"</a>"
RETURN(RETURN,CLOSE) I $G(%KEY("BSONLY")) Q
 W "<HR>",BK
 D 3^%ZAPM.bs.BSCh("BSROU="_$G(MainRef,"MAIN^~BSCh1"),"Вернуться в Главное Меню","BSROU=MAIN0^~BSCh1","Заново Регистрироваться","BSROU=MAIL^~BSCh1","Сообщения",$G(RETURN),$G(CLOSE))
 Q
LOCLIST(Tmp) ;ВЫВЕСТИ СПИСОК ЛОКАЛЬНЫХ ПЕРЕМЕННЫХ
 W "<A child='LOC11' style='color:blue; text-decoration:underline; cursor:hand;' onclick=""outlinerVAR();"" title='смотреть переменные, определенные на момент возникновения прерывания'>Current Local Variables</A>",CRLF
 W "<DIV ID='LOC11' CLASS='collapsedVAR'>",CRLF
 D locvar("",1)
 W "</DIV>",CRLF
 Q
locvar(%zz4,Tmp) W "<style type=""text/css"">"_CRLF
 W ".X1 {BACKGROUND:#FFFFB7; COLOR:BLACK; font-size: xx-small; font-family :FixedSys, Courier New, Courier; }"_CRLF
 W ".X0 {BACKGROUND:#FFFF37; COLOR:BLACK; font-size: xx-small; font-family :FixedSys, Courier New, Courier; }"_CRLF
 W "}</style>"_CRLF
 W "<TABLE BORDER=0 WIDTH=100%>",CRLF
 W "<TR><TD class=X0 style='font-weight: bold'>Name Variable</TD><TD class=X0 style='font-weight: bold'>Data Variable</TD></TR>",CRLF
 N %zz1,%zz0,%zz2,%zz3,%zz5,%zz6
 S %zz5="",%zz1="",%zz1=$O(@%zz1),%zz6=0 I '$D(Tmp) S Tmp=0
 S %zz0=0,%zz4=","_%zz4_"," F  Q:%zz1=""  D:%zz1'["%zz"  S %zz1=$O(@%zz1)
 .I "11"[$D(@%zz1) D LOCVAR(%zz1)
 .I $D(@%zz1)>9 S %zz3=%zz1 F  S %zz3=$Q(@%zz3) Q:%zz3=""  D LOCVAR(%zz3)
 W "</TABLE>"
 Q
LOCVAR(%z) I '$G(Tmp) I %z["%CGI"!(%z["%KEY")!(%z["%ZCS")!(%z["%CGIEVAR") Q
 I %zz4'=",,",%zz4'[(","_$QS(%z,0)_",") Q
 I %zz5'=$QS(%z,0) S %zz5=$QS(%z,0),%zz6=%zz6=0
 W "<TR><TD class=X"_%zz6_">",$G(%z),"</TD><TD class=X"_%zz6_">",$G(@%z),"</TD></TR>",$G(CRLF)
 Q
INTXT ;ВВОД ТЕКСТА В ГЛОБАЛ
 N L,dev,%ANS,IO,IOBS,IOF,IOM,IOPAR,IOSL,IOST,IOT,MSYS,POP,GLO,RMSDF,gui
1 W !,"ВВОД ПОЛНЫЙ ПУТЬ К ДОС-ФАЙЛУ:",! D IN^%IS Q:POP
 I IO=$I W !,"УСТРОЙСТВО ВВОДА НЕ ОПРЕДЕЛЕНО" G 1
 W !,"ВВЕДИТЕ ПОЛНУЮ ГЛОБАЛЬНУЮ ССЫЛКУ ^%ZAPM.bs.BSCh(""HTML"","""_$P($P(IO,"\",$L(IO,"\")),".")_""")" R GLO
 I GLO="" S GLO="^%ZAPM.bs.BSCh(""HTML"","""_$P($P(IO,"\",$L(IO,"\")),".")_""")"
 s dev=IO_":"_IOPAR I GLO'["^" S GLO="^"_GLO
 s gui=0
 S $ZT="ERRF^%ZAPM.bs.BSCh0"
 K @GLO
 F L=1:1 U IO R @GLO@(L)
EXIT C IO Q
ERRF I $ze["ENDOFILE"!($ze["ENDOFFILE") G EXIT
 W !,$ZE,*7 G EXIT
RGR ;ВВОД МАССИВОВ И ПРОГРАММ
 N L,dev,%ANS,IO,IOBS,IOF,IOM,IOPAR,IOSL,IOST,IOT,MSYS,POP,GLO,RMSDF,gui,NS,S,V,SS,NS1,OWER
RG W !,"ВВОД ПОЛНЫЙ ПУТЬ К ДОС-ФАЙЛУ:",! D IN^%IS Q:POP
 I IO=$I W !,"УСТРОЙСТВО ВВОДА НЕ ОПРЕДЕЛЕНО" G RG
 S NS=$E($P($P(IO,"\",$L(IO,"\")),"."),6,8) I NS="" S NS="USER"
 W !,"КУДА ВОССТАНАВЛИВАТЬ ? <",NS,"> " R NS1 I NS1="" S NS1=NS
 S $ZT="ERRGR^%ZAPM.bs.BSCh0"
 S NS=$$ZU^%ZAPM.bs.BS3(0)
 I NS1'="" I '$$ZU^%ZAPM.bs.BSF4(NS1) D ErrMsg^%ZAPM.bs.BSXfun("НЕ МОЖЕМ ТУДА ПЕРЕЙТИ !") Q
 I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 D Yes^%ZAPM.bs.BSXfun("УЖЕ СУЩЕСТВУЮЩИЕ МАССИВЫ УДАЛЯЕМ ?") S OWER='(YES<0)
 s dev=IO_":"_IOPAR
 s gui=0
 U IO R S U 0 W !,"МАССИВЫ :",S,!
 U IO R S U 0 W !,"ПРОГРАММЫ :",S,!!
 S SS="" F  U IO R S,V D  I S="**" U IO R S,V Q
 .I S="*" S SS="" Q
 .I S="**" Q
 .I S="" Q
 .I SS="" S SS=$QS(S,0) U 0 W SS," " I OWER K @SS
 .S @S=V
 S S="F L=0:1 Q:'$D(V(L))  ZI V(L):+L"
 U 0 W !
 F  U IO R NM Q:NM=""  D
 .S NM=$P(NM,".") K V
 .F L=0:1 U IO R V(L) I V(L)="" K V(L) Q
 .S $ZT="ERROU^%ZAPM.bs.BSCh0"
 .X "ZR  X S ZS @NM U 0 W NM,"" """
RGEX U 0 W !,"ЗАВЕРШЕНО УСПЕШНО..."
RGEXIT C IO I $G(NS)'="" I '$$ZU^%ZAPM.bs.BSF4(NS) D ErrMsg^%ZAPM.bs.BSXfun("НЕ МОЖЕМ ВЕРНУТЬСЯ") Q
 Q
ERRGR U 0 I $ze["ENDOFILE"!($ze["ENDOFFILE") G RGEX
 W !,$ZE,*7 G RGEXIT
ERROU U 0 W !,NM," <--- ",$ZE,*7,! Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCh1" type="MAC" languagemode="0"><![CDATA[
%BSCh1 ; пpогpамма %BS+Cache TP\Web-Link ; 13:38   12.09.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 ;!!!!!УСТАРЕЛАЯ ПРОГРАММА
 q
MAINVAR ;ОСНОВНЫЕ ПЕРЕМЕННЫЕ
 ;I '$D(%BS(1)) D %BS1^%ZAPM.bs.BSF4
 I '$D(GREEN) D VAR^%ZAPM.bs.BSCh
 S Grand="NAV" ;ИМЯ ГРАНДА ПРИЛОЖЕНИЯ
 S MainRef="MAIN^~BSCh1" ;ОСНОВНОЙ ВХОД <---------------------
 S MainTabl="^%ZAPM.bs.BSC(""HTML"")" ;ТАБЛИЦА ОСНОВНЫХ ПАРАМЕТРОВ
 S MainOpt="^%ZAPM.bs.BSETUP(""OPTION"")" ;ТАБЛИЦА ОСНОВНЫХ опций
 S CurUS=$$ADDRIP^%ZAPM.bs.BSC4
 S NameUS=$P($G(%KEY("BSUSER"),"?"),",") ;NAME
 Q
MAIN ;ОСНОВНОЙ ВХОД <---------------------
 N CurUS
 D MAINVAR
 ;РЕГИСТРАЦИЯ ОБЯЗАТЕЛЬНА
 I '$$GETOPT^%ZAPM.bs.BSCh2(MainOpt,"REG1") G MAINW
 I $G(%KEY("BSUSER"),"GUEST")="GUEST" D REGIST Q
 I '$$PASS^%ZAPM.bs.BSChh(Grand) D REGIST Q  ;ПРОВЕРКА НА КООРЕКТНОСТЬ ИМЕНИ ПОЛЬЗОВАТЕЛЯ
MAINW ;БЕЗ РЕГИСТРАЦИИ
 S NameUS=$P($G(%KEY("BSUSER"),"?"),",")
 I $G(%KEY("BSLABEL"))="MAIL^~BSCh1" S ROU=$$%^%ZAPM.bs.BSCh(%KEY("BSLABEL")) D @ROU Q
MAINR ;ДАЛЬШЕ
 D MGR^%ZAPM.bs.BS ;ПЕРЕЙТИ В СИСТЕМНУЮ ОБЛАСТЬ
 I $D(%KEY("BSLABEL")) S ROU=$$%^%ZAPM.bs.BSCh(%KEY("BSLABEL")) D @ROU Q
 I $G(%KEY("BSMENU"))=4 G TABL
 I $G(%KEY("BSMENU"))=3 G PART
 I $G(%KEY("BSMENU"))=2 G NSP
 N I,II,NS,P1,P9,BUFG,nI
Ma S (I,nI)=$$NS^%ZAPM.bs.BSCi(Grand,$$APPVAL^%ZAPM.bs.BSCh)
 D CRP^%ZAPM.bs.BSCh("Главное Меню",4)
 D WHO^%ZAPM.bs.BSCh
 W BR,"Рабочие Области Системы: ",BR F II=1:1 Q:$P(nI,$C(1),II,II+1)=""  I $P(nI,$C(1),II)'="" D
 .W "<a title=""перейти в область"" href="""_$$A^%ZAPM.bs.BSCh_"BSMENU=2&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSNSPACE="_$TR($P(nI,$C(1),II),"%","~")_"""> "_$P(nI,$C(1),II)_" |</a>",BK
 W BR,"<HR>"
 K BUFG F I=1:1 S BUFG(I)=$$BUFG^%ZAPM.bs.BSF12(I) I $G(BUFG(I))="" K BUFG(I) Q
 I $D(BUFG) W "Разделы готовых отчетов %BS-Системы:",BR D
 .S I="" F  S I=$O(BUFG(I)) Q:I=""  I BUFG(I)'="",$$Data^%ZAPM.bs.BSF12(BUFG(I)) D
 ..W "<P>- <a title=""зайти в раздел"" href="""_$$A^%ZAPM.bs.BSCh()_$$NS^%ZAPM.bs.BSCh()_"BSMENU=3&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSPART="_$$TAGS^%ZAPM.bs.BSHTML1($$%T^%ZAPM.bs.BSCh(BUFG(I)))_"""> "_$$TAGS^%ZAPM.bs.BSHTML1(BUFG(I))_" </a>"
 ..W $$TRAN^%ZAPM.bs.BSCh($P($G(@BUFG(I),"@Без Комментария"),"@",2)),"</P>",BR
 W "</P>"
 D RETURN^%ZAPM.bs.BSCh0("",$$CLOSE("Закрыть соединение"))
 W "<BR>" D StatVisit^%ZAPM.bs.BSCh("NAV")
 W "<BR><BR><A HREF=""/BS/DEVELOPER.htmL"">" D END^%ZAPM.bs.BSCh("") W "</A>"
 Q
A34(S) I S[$C(34) S S=$$TR^%ZAPM.bs.BSsFUNM(S,$C(34),$C(34,34))
 Q S
TABL ;ДИСПЕТЧЕР ТАБЛИЦ - СТАРЫЙ
 N I,II,NSPACE,GL,P1,P2,P3,P9,PART,TABL,TIP,BSR,BST,CFG,BS,JAVA
 D ADDVISIT^%ZAPM.bs.BSCh("Q","NAV")
 I '$$TABVAR Q
 D TABBEGIN
 i $d(@PART@(TABL,"OPT")) d ENTER^%ZAPM.bs.BSCh2 ;таблица опций
 D @("TIP"_TIP_"^%ZAPM.bs.BSChT")
 D RETURN^%ZAPM.bs.BSCh0($$ESC^%ZAPM.bs.BSChT)
 D END^%ZAPM.bs.BSCh(7) Q
 Q
TABBEGIN  W "<HTML>",BK
 W "<HEAD><TITLE>"_$P(@BS,"@")_"</TITLE></HEAD>",BK
 W "<BODY "_$$0^%ZAPM.bs.BSCh(3)_">",BK
 Q
TABVAR() ;ПРОВЕРИТЬ И СОЗДАТЬ ПЕРЕМЕННЫЕ ТАБЛИЦЫ
 I $D(%KEY("BSNSPACE")) S NSPACE=$$%^%ZAPM.bs.BSCh(%KEY("BSNSPACE")) I $G(NSPACE)'="",'$$ZU^%ZAPM.bs.BSF4(NSPACE) D Er^%ZAPM.bs.BSCh("НЕ МОЖЕМ ПЕРЕЙТИ В ОБЛАСТЬ :"_NSPACE) Q 0
 S PART=$$%^%ZAPM.bs.BSCh(%KEY("BSPART")),TABL=$$%^%ZAPM.bs.BSCh(%KEY("BSTABL"))
 I '$$Data^%ZAPM.bs.BSF12(PART) D Er^%ZAPM.bs.BSCh("РАЗДЕЛ "_PART_" НЕ ДОСТУПЕН") Q 0
 I '$D(@PART@(TABL)) D Er^%ZAPM.bs.BSCh("ТАБЛИЦА :"_TABL_" В РАЗДЕЛЕ :"_PART_" НЕ ДОСТУПНА") Q 0
 I '$D(NSPACE) S NSPACE=$$ZU^%ZAPM.bs.BS3(0)
 S BS=$$CurT^%ZAPM.bs.BSChT(NSPACE,PART,TABL)
 S TIP=$P(@BS,"@",17),CFG=$G(@BS@("HTML","CFG")),BSR=PART,BST=TABL
 Q 1
PART ;ЗАЙТИ В РАЗДЕЛ
 N I,II,NSPACE,GL,P1,P2,P3,P9,PART,tip,Tmp
 D ADDVISIT^%ZAPM.bs.BSCh("Q","NAV")
 I $D(%KEY("BSNSPACE")) S NSPACE=$$%^%ZAPM.bs.BSCh(%KEY("BSNSPACE")) I $G(NSPACE)'="",'$$ZU^%ZAPM.bs.BSF4(NSPACE) D Er^%ZAPM.bs.BSCh("НЕ МОЖЕМ ПЕРЕЙТИ В ОБЛАСТЬ :"_NSPACE) Q
 I $G(%KEY("BSPART"))="" D Er^%ZAPM.bs.BSCh("НЕТ РАЗДЕЛА В ОБЛАСТИ :"_NSPACE) Q
 S PART=$$%^%ZAPM.bs.BSCh(%KEY("BSPART"))
 I '$$Data^%ZAPM.bs.BSF12(PART) D Er^%ZAPM.bs.BSCh("РАЗДЕЛ "_PART_" НЕ ДОСТУПЕН") Q
 I $D(@PART)'=11 D CRP^%ZAPM.bs.BSCh("РАЗДЕЛ ПУСТОЙ"),END^%ZAPM.bs.BSCh(7) Q
 I '$D(NSPACE) S NSPACE=$$ZU^%ZAPM.bs.BS3(0)
 ;                 РАЗМЕРЫ ОКНА БРАУЗЕРА ! 640x480 800x600 1024x768 1280x1024
 N Wi,Hi S Wi=650,Hi=440 ;///////РАЗМЕР НОВОГО ОКНА БРАУЗЕРА
 D CRP^%ZAPM.bs.BSCh("Список Доступных Таблиц") D JavaS^%ZAPM.bs.BSCh(32)
 I '$G(%KEY("BSONLY")) W "Для пользователя :"_$$AMA($G(NameUS))_" в рабочей области :"_$$ANSP($G(NSPACE),1)_" в разделе :"_$$APART($G(PART)),CRLF
 w "<hr>"
 S I="" F  S I=$O(@PART@(I)) Q:I=""  I $E(I,1)'="@" D
 .s tip=$P($G(@PART@(I)),"@",17) w "<LI>"
 .i $$tip(tip) d
 ..I tip=2 D  Q  ;БАЗЫ ДАННЫХ
 ...W "<P><a title=""редактировать базу данных"" href="""_$$A^%ZAPM.bs.BSCh_$S($D(NSPACE):"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(NSPACE)_"&",1:"")_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=EDIT^~BSChT1&BSTABL="_$$%T^%ZAPM.bs.BSCh(I)_"&BSPART="_$$%T^%ZAPM.bs.BSCh(PART)_""">"_$$%T^%ZAPM.bs.BSCh(I)_" [ BSDT ] </A>"
 ..i $d(@PART@(I,"OPT")) S Tmp=@$ZR d  q  ;таблица опций
 ...W "<a title=""редактировать таблицу опций"" href="""_$$A^%ZAPM.bs.BSCh_$S($D(NSPACE):"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(NSPACE)_"&",1:"")_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=ENTER^~BSCh2&BSTABL="_$$%T^%ZAPM.bs.BSCh(I)_"&BSPART="_$$%T^%ZAPM.bs.BSCh(PART)_"""> "_I_" [OPT"_$S(Tmp=1:1,1:2)_"] </a>"
 ..W "<P><INPUT title=""показать таблицу в JAVA-аплете"" TYPE=""button"" VALUE="""_$$%T^%ZAPM.bs.BSCh(I)_""" onClick=""LoadText('"_$$A^%ZAPM.bs.BSCh_$S($D(NSPACE):"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(NSPACE)_"&",1:"")_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=JAVA^~BSChT1("_Wi_","_Hi_")&BSTABL="_$$%T^%ZAPM.bs.BSCh(I)_"&BSPART="_$$%T^%ZAPM.bs.BSCh(PART)_"',"_Wi_","_Hi_");"">"
 ..W "<a title=""показать таблицу фрагментарно"" href="""_$$A^%ZAPM.bs.BSCh_$S($D(NSPACE):"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(NSPACE)_"&",1:"")_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSMENU=4&BSTABL="_$$%T^%ZAPM.bs.BSCh(I)_"&BSPART="_$$%T^%ZAPM.bs.BSCh(PART)_"""> [",$$TIP^%ZAPM.bs.BS(tip),"] </a>"
 .i '$$tip(tip) W "<P><A TITLE=""таблица пока не поддерживается"" HREF=""JAVASCRIPT:alert('?')"">"_$$%T^%ZAPM.bs.BSCh(I)_"  [",$$TIP^%ZAPM.bs.BS(tip),"] </A>"
 .W $$TRAN^%ZAPM.bs.BSCh($P($G(@PART@(I),"Без Комментария"),"@",1)),"</P></LI>",CRLF
 D RETURN^%ZAPM.bs.BSCh0($$ANSP($G(NSPACE),1))
 D END^%ZAPM.bs.BSCh(7) Q
 Q
tip(tip) ;поддерживается тип
 i "1,2,5"[tip   q 1
 q 0
CLOSE(S) Q "<A title=""закрыть сессию"" HREF="""_$$A^%ZAPM.bs.BSCh_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=CLOSE1^~BSCh1"_""">"_S_"</A>"
AMA(U,Q) Q "<A title=""вернуться в Главное меню"" HREF="""_$$A^%ZAPM.bs.BSCh_"BSROU="_$G(MainRef,"MAIN^~BSCh1")_"""> "_U_$S($D(Q):"&lt;==",1:"")_"</A>"
ANSP(NS,Q) Q "<a title=""вернуться в область"" href="""_$$A^%ZAPM.bs.BSCh_"BSMENU=2&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSNSPACE="_$TR(NS,"%","~")_"""> "_NS_$S($D(Q):"&lt;==",1:"")_" </a>"
apart(II) Q $$A^%ZAPM.bs.BSCh_$S($D(NSPACE):"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(NSPACE)_"&",1:"")_"BSMENU=3&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSPART="_$$%T^%ZAPM.bs.BSCh(II)
APART(II,Q) Q "<a title=""вернуться в раздел"" href="""_$$apart(II)_"""> "_II_$S($D(Q):"&lt;==",1:"")_" </a>"
NSP ;ПЕРЕЙТИ В КИП
 N I,II,NSPACE,GL,P1,P2,P3,P9,AAA
 D ADDVISIT^%ZAPM.bs.BSCh("Q","NAV")
 I $D(%KEY("BSNSPACE")) S NSPACE=$$%^%ZAPM.bs.BSCh(%KEY("BSNSPACE")) I $G(NSPACE)'="",'$$ZU^%ZAPM.bs.BSF4(NSPACE) D Er^%ZAPM.bs.BSCh("НЕ МОЖЕМ ПЕРЕЙТИ В ОБЛАСТЬ :"_NSPACE) Q
 S GL=$$GD^%ZAPM.bs.BSCp("","P")
 I '$G(P1) D CRP^%ZAPM.bs.BSCh("В ОБЛАСТИ :"_NSPACE_" НЕТ РАЗДЕЛОВ"),END^%ZAPM.bs.BSCh(7) Q
 I '$D(NSPACE) S NSPACE=$$ZU^%ZAPM.bs.BS3(0)
 D CRP^%ZAPM.bs.BSCh("Список Доступных Разделов")
 I '$G(%KEY("BSONLY")) W "Для пользователя :"_$$AMA($G(NameUS),1)_" в рабочей области :"_$$ANSP($G(NSPACE))
 S AAA=$$ADMIN^%ZAPM.bs.BSCh w "<HR>" I $$GETOPT^%ZAPM.bs.BSCh2(MainOpt,"LIB1") S AAA=1
 S II="" F  S II=$O(@GL@(II)) S:$E(II,1)'="^" II="^"_II I II'="",$$Data^%ZAPM.bs.BSF12(II) D
 .I $E(II,2)="%",'AAA Q
 .W "<P>- <a title=""зайти в раздел"" href="""_$$A^%ZAPM.bs.BSCh_$S($D(NSPACE):"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(NSPACE)_"&",1:"")_"BSMENU=3&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSPART="_$$%T^%ZAPM.bs.BSCh(II)_"""> "_II_" </a>"
 .W $$TRAN^%ZAPM.bs.BSCh($P($G(@II,"@Без Комментария"),"@",2)),"</P>",CRLF
 D RETURN^%ZAPM.bs.BSCh0($$AMA($G(NameUS),1))
 D END^%ZAPM.bs.BSCh(7)
 Q
MAIN0 ;ПЕРЕГИСТРАЦИЯ
 K %KEY("BSUSER") G MAIN
MAIL ;ПИСЬМО ПОДГОТОВИТЬ
 N CurUS
 D MAINVAR
 D CRP^%ZAPM.bs.BSCh("Подготовьте Сообщение для Администратора Системы",4)
 D FORM^%ZAPM.bs.BSCh
 w "<input type=""hidden"" name=""BSROU"" value=""RESEVE^~BSCh1"">"
 W "<p><textarea rows=""4"" name=mBST1 cols=""80""></textarea></p>"
 
 W "<p> ОТ КОГО СООБЩЕНИЕ <input type=""text"" name=""BST2"" " D  W "size=""32"">"
 .I $G(NameUS)'="" W "VALUE="""_$G(NameUS)_""" "
 W " ТЕЛЕФОН <input type=""text"" name=""BST3"" size=""7""></p>"
 
 W "<p><input type=""radio"" value=""1"" name=""BSR1""> СРОЧНОЕ СООБЩЕНИЕ"
 W "<input type=""radio"" value=""2"" name=""BSR1""> НЕ ОЧЕНЬ"
 W "<input type=""radio"" value=""3"" checked name=""BSR1"">СОВСЕМ НЕ СРОЧНОЕ</p>"
 
 W "<input type=""submit"" value=""ОТПРАВИТЬ"" name=""BSB1""> "
 W "<input type=""reset"" value=""ОЧИСТИТЬ"" name=""BSB2"">"
 W "</p></form>"
 D RETURN^%ZAPM.bs.BSCh0("")
 Q
RESEVE ;ПИСЬМО ПРИНЯТЬ
 N BD,U1,U2,U3,NuMHtml,CurUS
 D MAINVAR
 S BD=$$KBD^%ZAPM.bs.BSF12($$0^%ZAPM.bs.BSCh(24)) I '$$Data^%ZAPM.bs.BSF12(BD) D CRP^%ZAPM.bs.BSCh("БАЗА ДАННЫХ НЕ ДОСТУПНА",4,2) G RESE
 S U1=$P($$h^%ZAPM.bs.BS3,","),U2=$P($$h^%ZAPM.bs.BS3,",",2)
 I $G(%KEY("mBST1"))="" D CRP^%ZAPM.bs.BSCh("СООБЩЕНИЕ ПУСТОЕ !",4,2) G RESE
 I $G(%KEY("BST2"))="" D CRP^%ZAPM.bs.BSCh("ЭТО АНОНИМКА, ДА ?",4,2) G RESE
 I $G(%KEY("BST3"))="" D CRP^%ZAPM.bs.BSCh("КАК, А ТЕЛЕФОН !",4,2) G RESE
 S @BD@(U1,CurUS,U2,"B")=$TR($G(%KEY("mBST1")),$C(13,10),"")
 S @BD@(U1,CurUS,U2,"U")=$G(%KEY("BST2"))
 S @BD@(U1,CurUS,U2,"T")=$G(%KEY("BST3"))
 S @BD@(U1,CurUS,U2,"A")=$G(%KEY("BSR1"))
 D CRP^%ZAPM.bs.BSCh("СООБЩЕНИЕ ДЛЯ АДМИНИСТРАТОРА ПРИНЯТО",4,1)
RESE D RETURN^%ZAPM.bs.BSCh0("")
 D END^%ZAPM.bs.BSCh(7)
 Q
CHECKPAS ;ПРОВЕРИТЬ РЕГИСТРАЦИЮ
 D CHECKPA($G(%KEY("USERNAME")),$G(%KEY("USERPASS")))
 Q
CHECKPA(U,P) ;ПРОВЕРКА ПАРОЛЯ
 N BD,U1,U2,U3,NuMHtml,CurUS,AP,GAP
 D MAINVAR
 D ADDVISIT^%ZAPM.bs.BSCh("P","NAV")
 s AP=$$CheckPass^%ZAPM.bs.BSChh(U,P,Grand)
 i AP="" D OTLUP Q
 S NameUS=U
 ;**************************************************************************
 ;ОТКРЫТИЕ СЕССИИ = GAP
 S GAP=$E($$RANDFILE^%ZAPM.bs.BSF11,1,8)_$E($$RANDFILE^%ZAPM.bs.BSF11,1,8)
 D SETMP^%ZAPM.bs.BSCp(GAP,Grand,AP) ;СОХРАНЕНИЕ ПЕРЕМЕННОЙ
 ;**************************************************************************
 K %KEY("USERNAME"),%KEY("USERPASS")
 S %KEY("BSUSER")=U_","_$$CRC^%ZAPM.bs.BSChh(P)_","_GAP
 D ADDVISIT^%ZAPM.bs.BSCh("R","NAV")
 G MAIN
CLOSE1 ;ЗАКРЫТИЕ СЕССИИ
 ;**************************************************************************
 D KILLTMP^%ZAPM.bs.BSCp($P($G(%KEY("BSUSER")),",",3))
 ;**************************************************************************
 D CRP^%ZAPM.bs.BSCh("СЕССИЯ ЗАКРЫТА",4,1)
 D RETURN^%ZAPM.bs.BSCh0("")
 D END^%ZAPM.bs.BSCh(7)
 Q
OTLUP ;ОТКАЗ В РЕГИСТРАЦИИ
 D CRP^%ZAPM.bs.BSCh("ВАМ ОТКАЗАНО В РЕГИСТРАЦИИ ! ПРОВЕРЬТЕ ПРАВИЛЬНОСТЬ ВВЕДЕННОГО ИМЕНИ ПОЛЬЗОВАТЕЛЯ И ПАРОЛЯ.",4,2)
 D RETURN^%ZAPM.bs.BSCh0("")
 D END^%ZAPM.bs.BSCh(7)
 Q
REGIST ;РЕГИСТРАЦИЯ
 d KILLTMP^%ZAPM.bs.BSCp("")
 D CRP^%ZAPM.bs.BSCh("ЗАРЕГИСТРИРУЙТЕСЬ !",4)
 D FORM^%ZAPM.bs.BSCh
 w "<input type=""hidden"" name=""BSROU"" value=""CHECKPAS^~BSCh1"">",BK
 S I="" F  S I=$O(%KEY(I)) Q:I=""  I I'="BSROU",$E(I,1,2)="BS" D
 .w BK,"<input type=""hidden"" name="""_I_""" value="""_%KEY(I)_""">"
 w BK,"<table border=""0"">",BK
 w "<tr>",BK
   w "<td align=""right""><strong>Введите ваше имя</strong></td>",BK
   w "<td><input type=""text"" size=""27"" maxlength=""2048"" name=""USERNAME"" value=""КТО ВЫ ?""></td>",BK
 w "</tr>"
 w "<tr>"
   w "<td align=""right""><strong>и пароль</strong></td>",BK
   w "<td><input type=""password"" size=""27"" maxlength=""2048"" name=""USERPASS""></td>",BK
 w "</tr>"
  w "</table>",BK
  w "<p><input type=""submit"" name=""OK"" value=""ЗАРЕГИСТРИРОВАТЬСЯ""> <input type=""reset"" name=""ON"" value=""ПОВТОРИТЬ ВВОД""></p>",BK
  w "</form>",BK
 W "<BR><A HREF=""/BS/DEVELOPER.htmL"">" D END^%ZAPM.bs.BSCh("") W "</A>"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCh2" type="MAC" languagemode="0"><![CDATA[
%BSCh2 ;БИБЛИОТЕКА ФУНКЦИЙ РАБОТЫ С ОПЦИЯМИ ; 13:39   12.09.2002
  ;УСТАРЕЛАЯ ПРОГРАММА
 Q
VAR ;НАЧАЛО
 I '$$TABVAR^%ZAPM.bs.BSCh1 Q
 D TABBEGIN^%ZAPM.bs.BSCh1
 S O=$NA(@PART@(TABL))
 Q
BSVAR ;ПЕРЕМЕННЫЕ ДЛЯ ТАБЛИЦЫ
 w "<input type=""hidden"" name=""BSTABL"" value="""_%KEY("BSTABL")_""">",$G(BK)
 w "<input type=""hidden"" name=""BSPART"" value="""_%KEY("BSPART")_""">",$G(BK)
 w "<input type=""hidden"" name=""BSNSPACE"" value="""_%KEY("BSNSPACE")_""">",$G(BK)
 Q
ENTER ;основной вход в таблицу опций
 N O
 D VAR
 D TITLE(O)
 I $G(@O@("OPT"))'=1,'$P($G(@O@("OPT")),",",2) W "В ТАБЛИЦЕ ОПЦИЙ НЕ ВЕРНЫЙ ПАРАМЕТР",BK D BACK^%ZAPM.bs.BSCh Q
 D OPT(O)
 D BSVAR
 w "<input type=""hidden"" name=""BSLABEL"" value=""SAVE^~BSCh2"">"
 w "<input type=""SUBMIT"" name=""SubMit1"" value=""Запомнить"">"
 w "<input type=""RESET"" name=""Reset1"" value=""Отменить"">"
 W "</form>"
ENTE D END2^%ZAPM.bs.BSCh D BACK^%ZAPM.bs.BSCh
 Q
SAVE ;СОХРАНИТЬ НОВЫЕ ПАРАМЕТРЫ
 N O
 D VAR
 S O=$NA(@PART@(TABL))
 D SAVEOPT^%ZAPM.bs.BSCh2(O)
 D END2^%ZAPM.bs.BSCh
 q
TITLE(TBL) ;вывести заголовок
 W "<CENTER>"
 I $G(@TBL@("OPT"))=1 W "<H3>",$P(@TBL@(2,4),"@",15),"</H3>" I 1 ;D CRP^%ZAPM.bs.BSCh($P(@TBL@(2,4),"@",15),4) Q
 E  W "<H3>",$P(@TBL,"@",1),"</H3>"
 W "<HR></CENTER>"
 ;D CRP^%ZAPM.bs.BSCh($P(@TBL,"@",1),4)
 Q
OPT(TBL,NOFORM) ;ФОРМА С ПАРАМЕТРАМИ
 I '$G(NOFORM) D FORMN^%ZAPM.bs.BSCh($QS(TBL,1))
 I '$D(@TBL@("OPT")) W "В ТАБЛИЦЕ ОПЦИЙ ОТСУТСТВУЮТ БАЗОВЫЕ ПАРАМЕТРЫ",BK D BACK^%ZAPM.bs.BSCh G ENTE
 w "<input type=""hidden"" name=""BSROU"" value="""_$G(MainRef,"MAIN^~BSCh1")_""">"
 N I,II,P1,P2,P3,P4,P5,X,Y,S
 w BK,"<table border=0>",BK
 I $G(@TBL@("OPT"))'=1 S S=@$ZR F I=$S($P(S,",",3):$P(S,",",2),1:1):1 Q:'$D(@TBL@(I))  D  W BK
 .Q:'$P(S,",",2)  Q:'$P(S,",")
 .S P4=$P($G(@TBL@(I,+$P(S,",",1))),"@",15),P1=$P($G(@TBL@(I,+$P(S,",",2))),"@",15)
 .S P3=" SIZE=50 ",P5=$P($P($G(@TBL@(I,$P(S,",",2))),"@",18),"#")
 .I P4'="",$P($G(@TBL@(I,$P(S,",",2))),"@",5)="" D text1(P1,P3,P5)
 I $G(@TBL@("OPT"))=1 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D  W BK
 .S P1=$P(@TBL@(I,1),"@",15),P2=$P(@TBL@(I,2),"@",15),P3=$P(@TBL@(I,3),"@",15)
 .S P4=$P(@TBL@(I,4),"@",15),P5=$P(@TBL@(I,5),"@",15)
 .D TAB
 w "</table>"
 Q
TAB ;ТЕКУЩАЯ СТРОКА
 I P2="textarea" D  Q
 .W "<tr><td align=""right""><textarea name="""_$$name(P5)_""" "_P3_" >"_P1_"</textarea></td><td>",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 I P2="text" D text(P1,P3,P5) Q
 I P2="checkbox" D  Q
 .W "<tr><td align=""right""><input type=""checkbox"" name="""_$$name(P5)_""" value="""_P1_""""_P3_$$ch(P1)_"></td><td>",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 I P2="radio" w "<p>",BK D  Q
 .F II=1:1:$L(P4,"~") W "<tr><td align=""right""><input type=""radio"" name="""_$$name(P5)_""" value="_II_" "_P3_$$ch(P1=II)_"></td><td>",$$TEGS^%ZAPM.bs.BSre($P(P4,"~",II)),"</td></tr>",BK
 .w "</p>"
 Q
text(P1,P3,P5) W "<tr><td align=""right""><input type=""text"" name="_$$name(P5)_" "_P3_" value='"_P1_"'></td><td>",$$TEGS^%ZAPM.bs.BSre(P4),"</td></tr>"
 Q
text1(P1,P3,P5) W "<tr><td align=""right"">",$$TEGS^%ZAPM.bs.BSre(P4),"</td><td><input type=""text"" name="_$$name(P5)_" "_P3_" value='"_P1_"'></td></tr>"
 Q
name(P) ;ИМЯ КОМПОНЕНТЫ
 I P="" Q $QS(TBL,1)_I
 Q P
ch(P) I P q " checked "
 q ""
SAVEOPT(TBL) ;ПРИСВОЕНИЕ
 N I,C,N,S
 W "<CENTER>"
 W "<H3>Опции запомнены</H3>"
 W "<HR></CENTER>"
 ;D CRP^%ZAPM.bs.BSCh("Опции запомнены",4)
 I $G(@TBL@("OPT"))'=1 S S=@$ZR F I=$S($P(S,",",3):$P(S,",",2),1:1):1 Q:'$D(@TBL@(I))  D
 .Q:'$P(S,",",2)  Q:'$P(S,",")  Q:$P($G(@TBL@(I,$P(S,",",2))),"@",5)'=""
 .;S P4=$P($G(@TBL@(I,+$P(S,",",1))),"@",15),P1=$P($G(@TBL@(I,+$P(S,",",2))),"@",15)
 .S N=$P($P($G(@TBL@(I,$P(S,",",2))),"@",18),"#") i N="" s N=$QS(TBL,1)_I
 .I $TR($G(%KEY(N)),"@","")=$G(%KEY(N)) S $P(@TBL@(I,$P(S,",",2)),"@",15)=$G(%KEY(N)) Q
 .S $P(@TBL@(I,$P(S,",",2)),"@",15)=$TR($G(%KEY(N)),"@","") D PROT(N)
 
 I $G(@TBL@("OPT"))=1 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .S C=$P($G(@TBL@(I,2)),"@",15)
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .I C="checkbox" D  Q
 ..I $D(%KEY(N)) S $P(@TBL@(I,1),"@",15)=1
 ..E  S $P(@TBL@(I,1),"@",15)=0
 .I $TR($G(%KEY(N)),"@","")=$G(%KEY(N)) S $P(@TBL@(I,1),"@",15)=$G(%KEY(N)) Q
 .S $P(@TBL@(I,1),"@",15)=$TR($G(%KEY(N)),"@","") D PROT(N)
 Q
PROT(N) ;ЗАПИСЬ ЗАПРЕЩЕННОГО
 W "<br>Параметр '"_N_"' имеет запрещенный символ '@': "_RED_$G(%KEY(N))_EF_"<br>"
 W "<br>Запомнили : "_GREEN_$TR($G(%KEY(N)),"@","")_EF_"<br>"
 Q
GETOPT(TBL,NO,NK) ;ВОЗВРАТИТЬ ЗНАЧЕНИЕ ОПЦИИ NO
 ;NO - ИМЯ ПОКАЗАТЕЛЯ
 ;NK - НОМЕР КОЛОНКИ В ТАБЛИЦЕ
 N N,I,Q S Q="?"
 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .I N=NO S Q=$P($G(@TBL@(I,$G(NK,1))),"@",15) Q
 Q Q
SETOPT(TBL,NO,Q) ;ПРИСВОИТЬ ЗНАЧЕНИЕ ОПЦИИ NO=Q
 N N,I
 F I=3:1 Q:$P($G(@TBL@(I,2)),"@",15)=""  D
 .I $P($G(@TBL@(I,5)),"@",15)'="" S N=$P($G(@TBL@(I,5)),"@",15)
 .E  S N=$QS(TBL,1)_I
 .I N=NO S $P(@TBL@(I,1),"@",15)=Q
 Q
UPLOAD ;UPLOAD FILES -=CSP=-
 ;&html<
 ;<form enctype="multipart/form-data" method=post action="upload.csp">
 ;Enter a file to upload here: <input type=file size=30 name=FileStream>
 ;<p>
 ;<ul><input type=submit value="Upload file"></ul>
 ;<p>
 ;</form>
 ;>
]]></Routine>


<Routine name="%ZAPM.bs.BSChA" type="MAC" languagemode="0"><![CDATA[
%BSChA ; пpогpамма ОПЦИЙ АДМИНИСТРАТОРА ; 15:16   25.01.2001
 Q
MAIL D TEST^%ZAPM.bs.BSCh0("ПОЧТA")
 Q
OPTION ;ТАБЛИЦА ОСНОВНЫХ ОПЦИЙ MainOpt=ИМЯ ТАБЛИЦЫ
 D SETOPT^%ZAPM.bs.BSCh2(MainOpt,"ROOT",$G(%CGIEVAR("PATH_TRANSLATED")))
 D TITLE^%ZAPM.bs.BSCh2(MainOpt)
 D OPT^%ZAPM.bs.BSCh2(MainOpt)
 w "<input type=""hidden"" name=""BSLABEL"" value=""SAVEOPT^~BSChA"">"
 w "<input type=""SUBMIT"" name=""SubMit1"" value=""Запомнить Опции"">"
 w "<input type=""RESET"" name=""Reset1"" value=""Очистить"">"
 W "</form>"
 D BACK^%ZAPM.bs.BSCh,END^%ZAPM.bs.BSCh("")
 Q
SAVEOPT ;СОХРАНИТЬ НОВЫЕ ПАРАМЕТРЫ
 D SAVEOPT^%ZAPM.bs.BSCh2(MainOpt)
 D BACK^%ZAPM.bs.BSCh,END^%ZAPM.bs.BSCh("")
 Q
NETOPT ;ТАБЛИЦА СЕТЕВЫХ ОПЦИЙ
 S TBL="^%ZAPM.bs.BSETUP(""SERVER"")"
 D TITLE^%ZAPM.bs.BSCh2(TBL)
 D OPT^%ZAPM.bs.BSCh2(TBL)
 w "<input type=""hidden"" name=""BSLABEL"" value=""SAVENOPT^~BSChA"">"
 w "<input type=""SUBMIT"" name=""SubMit1"" value=""Запомнить Опции"">"
 w "<input type=""RESET"" name=""Reset1"" value=""Очистить"">"
 W "</form>"
 D BACK^%ZAPM.bs.BSCh,END^%ZAPM.bs.BSCh("")
 Q
SAVENOPT ;СОХРАНИТЬ НОВЫЕ ПАРАМЕТРЫ
 S TBL="^%ZAPM.bs.BSETUP(""SERVER"")"
 D SAVEOPT^%ZAPM.bs.BSCh2(TBL)
 D BACK^%ZAPM.bs.BSCh,END^%ZAPM.bs.BSCh("")
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChK" type="MAC" languagemode="0"><![CDATA[
%BSChK ;!!!!!!
 ;
 ;
 ;d PCD^%MGW("ISC",7001) ;СТАРТ Cache Web Linl TP ...... EXIT1+2^STU
 ;
 ;
TEST ; Simple test page
 N CRLF,KEY,SYSNAME
 S CRLF=$C(13,10)
 ;
 ;W "HTTP/1.0 200 OK",CRLF
 ;W "Content-type: text/html",CRLF
 ;W "Window-target: main_window",CRLF
 ;W CRLF
 ;
 S SYSNAME=$S($G(%CGIEVAR("SERVER_SOFTWARE"))["Cach":"Cach&eacute; WebLink",1:"Open M/WebLink")
 ;
 W "<HTML>",CRLF
 W "<HEAD><TITLE>",SYSNAME," Test !!!! Page</TITLE></HEAD>",CRLF
 W "<BODY>",CRLF
 W "<H2>",SYSNAME," Тестовая !!!!!!!! страница... </H2>",CRLF
 W "<HR><B> You are connected to the M System</B>",CRLF
 D FLUSH^%MGW
 W "<P>M Job Number ",$J," on M System ",$G(%KEY("MGWLPN")),CRLF
 W "<BR>Form returned by M routine ",$ZN,CRLF
 W "<HR>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<CAPTION><B><I>User defined variables passed to your M System</I></B></CAPTION>",CRLF
 W "<TR><TH>Variable Name</TH><TH>Value</TH></TR>",CRLF
 D FLUSH^%MGW
 S KEY=""  F  S KEY=$O(%KEY(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",$G(%KEY(KEY)),"</TD></TR>",CRLF D FLUSH^%MGW
 W "</TABLE>",CRLF
 W "<HR>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<CAPTION><B><I>CGI Environment variables passed to your M System</I></B></CAPTION>",CRLF
 W "<TR><TH>Variable Name</TH><TH>Value</TH></TR>",CRLF
 D FLUSH^%MGW
 S KEY=""  F  S KEY=$O(%CGIEVAR(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",%CGIEVAR(KEY),"</TD></TR>",CRLF D FLUSH^%MGW
 W "</TABLE>",CRLF
 W "<HR>",CRLF
 W "</BODY>",CRLF
 W "</HTML>",CRLF
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChMGW" type="MAC" languagemode="0"><![CDATA[
%mgw3 ;(CM) Cache WebLink Application Launch Routine ; 10:51   23.01.2001
 ; Version 4.20.491
 ;
 ; +--------------------------------------------------------+
 ; | Copyright 1986-1999 by InterSystems Corporation,       |
 ; | Cambridge, Massachusetts, U.S.A.                       |
 ; | All rights reserved.                                   |
 ; |                                                        |
 ; | Confidential, unpublished property of InterSystems.    |
 ; |                                                        |
 ; | This media contains an authorized copy or copies       |
 ; | of material copyrighted by InterSystems and is the     |
 ; | confidential, unpublished property of InterSystems.    |
 ; | This copyright notice and any other copyright notices  |
 ; | included in machine readable copies must be reproduced |
 ; | on all authorized copies.                              |
 ; +--------------------------------------------------------+
 ;
A0 ; *** Do not edit this routine ***
 
 ;
 ; Copy this routine to %ZMGW2 (or %MGW2) and edit that copy.
 ; User's of Cache 3.x should launch their application code
 ; from %ZMGW2.  This routine will be protected when Cache is
 ; upgraded.
 ;
HTML ; Process incoming HTML form data
 ;
 ;--------------------------------------------------------------------------------------------
 ;  Эти строки вставлены Михайленко С.В. для подключения комплекса %BS-Portal
 I $G(%KEY("BSG"))'="" D BSG^%ZAPM.bs.BSCh0(%KEY("BSG")) Q  //новый вызов
 I $D(%KEY("BSROU")) D RUN^%ZAPM.bs.BSCh0 Q                 //старый вызов
 ;I $G(%KEY("UZN"))'="" I $$ZU^%ZAPM.bs.BSF4(%KEY("UZN")) D ^dispatcher Q  //это приблуда А.Миренбурга
 ;--------------------------------------------------------------------------------------------    
 D TEST
 Q
 ;
JAVA ; Process in-form Cache/M Method (Invoked by Java Applet)
 ; Receive request in %REQUEST
 ;    Associated parameters in %REQUEST(1->n)
 ;
 ; Send each line of response as sendline^%mgwj(<Data>)
 ;    Finally, quit from this code module
 ;
 D TESTJ
 Q
 ;
TIMEOUT ; General (default) timeout procedure for private sessions
 W "ВАШЕ ВРЕМЯ ИСТЕКЛО...<BR>!!!"
 ; This procedure won't be called if the application elects
 ; to deal with this event.
 Q
 ;
TEST ; Simple test page
 N CRLF,KEY,SYSNAME
 S CRLF=$C(13,10)
 ;
 ;W "HTTP/1.0 200 OK",CRLF
 ;W "Content-type: text/html",CRLF
 ;W "Set-Cookie: cookie_name=cookie_value; path=/;",CRLF
 ;W "Window-target: main_window",CRLF
 ;W CRLF
 ;
 S SYSNAME="Cach&eacute; WebLink"
 ;
 W "<HTML>",CRLF
 W "<HEAD><TITLE>",SYSNAME," Test Page</TITLE></HEAD>",CRLF
 W "<BODY>",CRLF
 W "<H2>",SYSNAME," Test Page</H2>",CRLF
 W "<HR><B> You are connected to the Server</B>",CRLF
 D flush^%mgw
 W "<P>Server Job Number <B>",$J,"</B> on Server <B>",$G(%KEY("MGWLPN")),"</B>, TCP Port: <B>",$G(%ZCS("PORT")),"</B>",CRLF
 W "<BR>Form returned by routine <B>",$ZN,"</B>",CRLF
 W "<BR>User-defined variables passed to this routine in the"
 I '$G(%ZCS("GLO")) W " local array: <B>%KEY</B>",CRLF
 I $G(%ZCS("GLO")) W " global: <B>^MGW(""%KEY"",$J,</B>",CRLF
 W "<HR>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<CAPTION><B><I>User-defined variables passed to your Server</I></B></CAPTION>",CRLF
 W "<TR><TH>Variable Name</TH><TH>Value</TH></TR>",CRLF
 D flush^%mgw
 S KEY=""
 I '$G(%ZCS("GLO")) F  S KEY=$O(%KEY(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",$G(%KEY(KEY)),"</TD></TR>",CRLF D flush^%mgw
 I $G(%ZCS("GLO")) F  S KEY=$O(^MGW("%KEY",$J,KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",$G(^MGW("%KEY",$J,KEY)),"</TD></TR>",CRLF D flush^%mgw
 W "</TABLE>",CRLF
 W "<HR>",CRLF
 W "<TABLE BORDER>",CRLF
 W "<CAPTION><B><I>CGI Environment variables passed to your Server</I></B></CAPTION>",CRLF
 W "<TR><TH>Variable Name</TH><TH>Value</TH></TR>",CRLF
 D flush^%mgw
 S KEY=""  F  S KEY=$O(%CGIEVAR(KEY)) Q:KEY=""  W "<TR><TD>",KEY,"</TD><TD>",%CGIEVAR(KEY) D CGI W "</TD></TR>",CRLF D flush^%mgw
 W "</TABLE>",CRLF
 W "<HR>",CRLF
 W "</BODY>",CRLF
 W "</HTML>",CRLF
 Q
 ;
CGI ; Additional CGI Environment Variable content
 N I
 F I=1:1 Q:'$D(%CGIEVAR(KEY,I))  W "<BR>",$G(%CGIEVAR(KEY,I))
 Q
 ;
TESTJ ; Simple response to client-side Java Applet
 D sendline^%mgwj("This is the response to '"_%REQUEST_"' from the Cache System")
 Q
 ;
VERS ; Return the version number
 D VERS^%mgw
 Q
 ;
VER() ; Return the version for this module
 Q "4.20.491"
 ;
]]></Routine>


<Routine name="%ZAPM.bs.BSChT" type="MAC" languagemode="0"><![CDATA[
%BSChT ; пpогpамма РАБОТЫ С ТАБЛИЦЕЙ ; 20:48   03.06.2000
 Q  ;17 ТИП -ТИП =.1 - ТАБЛИЦА БЕЗ БАЗЫ ДАННЫХ (САМА ПО СЕБЕ) (ПО УМОЛЧАНИЮ)
   ;              2 - -- / -- С БАЗОЙ ДАННЫХ (ОПИСАНИЕ БАЗ В ^BSR(BST,"KEY")
   ;              3 - ТАБЛИЦА-СПИСОК
   ;              4 - ТАБЛИЦА-СВОДКА
   ;              .5 - ТЕКСТ
   ;              6 - БЛАНК --- нет
   ;              7 - МЕНЮ ПОЛЬЗОВАТЕЛЯ
   ;              8 - ПАНЕЛЬ С КНОПКАМИ
   ;             
CurTBS() Q $$CurT($$%^%ZAPM.bs.BSCh(%KEY("BSNSPACE")),$$%^%ZAPM.bs.BSCh(%KEY("BSPART")),$$%^%ZAPM.bs.BSCh(%KEY("BSTABL")))
CurT(NS,PR,TB) I PR["^["_$C(34) Q $NA(@PR@(TB))
 Q $NA(@("^["""_NS_"""]"_$P(PR,"^",2))@(TB))
CFGTAB ;ЗАПИСАТЬ CFG
 N BS,CFG
 I $G(%KEY("C1")) S CFG="1,0,0,9,9,9,"_$G(%KEY("C2"))_","_$G(%KEY("PRESS"))_",1,1" D CFGTA Q
 I '$G(%KEY("C1")),$G(%KEY("STR"))=0,$G(%KEY("COL"))=0 S CFG="0,"_$P($$0^%ZAPM.bs.BSCh(28),"=",2)_","_$P($$0^%ZAPM.bs.BSCh(29),"=",2)_",9,9,9,"_$G(%KEY("C2"))_","_$G(%KEY("PRESS"))_",1,1" D CFGTA Q
 I $G(%KEY("STR"))=0,$G(%KEY("COL"))=0 S CFG="1,0,0,9,9,9,"_$G(%KEY("C2"))_","_$G(%KEY("PRESS"))_",1,1" D CFGTA Q
 S CFG="0,"_$G(%KEY("STR"))_","_$G(%KEY("COL"))_",578,578,578,"_$G(%KEY("C2"))_","_$G(%KEY("PRESS"))_",1,1"
CFGTA S BS=$$CurTBS(),@BS@("HTML","CFG")=CFG
GOM D TABBEGIN^%ZAPM.bs.BSCh1
 D TIP1
 D RETURN^%ZAPM.bs.BSCh0($$ESC())
 D END^%ZAPM.bs.BSCh(7) Q
 Q
GOMAP ;ДВИГАТЬ ТАБЛИЦУ
 N BS,CFG,GO,TX,TY,Limit
 S BS=$$CurTBS(),CFG=$G(%KEY("BSTABCFG")),GO=$G(%KEY("BSMAP")) D TITUL
 ;ИЗМЕНИМ 9-10 В CFG
 I GO'=""&(CFG)'="" D @($TR($E(GO,1,2),"КСТ","CPT")_"^%ZAPM.bs.BSChT0")
 G GOM
TITUL ;ТИТУЛ
 N T S T=$P(@BS,"@",19) I 'T S T=$P(@BS,"@",50)
 S TY=+$P(T,",",1),TX=+$P(T,",",2) S:'TY TY=1 S:'TX TX=1
 Q
WR ;ВЫВОД ТАБЛИЦЫ
 N T,I,J,II,JJ,X,Y,CurH,CurW,KolStr,KolP,KolX
 D TITUL
 S Y=$P(CFG,",",9),X=$P(CFG,",",10)
 I TY I $P(CFG,",",9,10)="1,1" S Y=TY,X=TX D  ;УГЛОВЫЕ ТОЧКИ ВЫВОДА
 .S $P(CFG,",",9)=TY
 .S $P(CFG,",",10)=TX
 S (CurH,CurW,KolStr)=0,KolX=$P(@BS,"@",29),KolP=$$0^%ZAPM.bs.BSCh(30) K S,CurWW,Limit
 I TY F I=1:1:TY-1 Q:'$D(@BS@(I))  Q:$$CurH(I)  D WRBS(I)
 F I=Y:1 Q:'$D(@BS@(I))  Q:$$CurH(I)  D WRBS(I)
 S $P(CFG,",",11)=I-1
 S $P(CFG,",",12)=$S($D(CurWW):CurWW-1,1:KolX)
 Q
WRITE ;ВЫВОД ТАБЛИЦЫ
 W BK,"<TT>" D RETRY($P(CFG,",",8),"<SMALL>")
 S I="" F  S I=$O(S(I)) Q:I=""  S J="" F  S J=$O(S(I,J)) Q:J=""  W "<NOBR>",$$CTRL($$SPA(S(I,J))),"</NOBR>",BR,BK
 ;S I="" F  S I=$O(S(I)) Q:I=""  S J="" F  S J=$O(S(I,J)) Q:J=""  W $$CTRL($$SPA(S(I,J))),BR,BK
 ;W "<TABLE BORDER=0>" D  W "</TABLE>" ;ВЫВОД ТАБЛИЦЕЙ
 ;.S I="" F  S I=$O(S(I)) Q:I=""  S J="" F  S J=$O(S(I,J)) Q:J=""  W "<TR>" D  W "</TR>"
 ;..F II=1:1 Q:$P(S(I,J),$C(0),II,II+1)=""  W "<TD>",$P(S(I,J),$C(0),II),"</TD>"
 W "<NOBR>Текущие строка ",$P(CFG,",",11)," Колонка ",$P(CFG,",",12),". Из - (",$P(@BS,"@",28),"x",$P(@BS,"@",29),") ",$P(@BS,"@"),"</NOBR>",BR,BK
 W "</TT>" D RETRY($P(CFG,",",8),"</SMALL>") K S
 I '$P(CFG,",",2) W "<NOBR>" D NAVIG W "</NOBR>" ;КОГДА ВСЯ ТАБЛИЦА
 Q
NAVIG W "Навигация по Таблице "
 I TY<$P(CFG,",",9) D  W "<a href="""_$$A^%ZAPM.bs.BSCh_$$ATAB_""">В_Начало</A> "
 .S I=1,II="N"
 I TY<$P(CFG,",",9) D  W "<a href="""_$$A^%ZAPM.bs.BSCh_$$ATAB_""">Назад</A> "
 .S I=2,II="N"
 I $D(Limit) D  W "<a href="""_$$A^%ZAPM.bs.BSCh_$$ATAB_""">Вперед</A> "
 .S I=3,II="N"
 I $P(@BS,"@",28)'=$P(CFG,",",11) D  W "<a href="""_$$A^%ZAPM.bs.BSCh_$$ATAB_""">В_Конец</A> "
 .S I=4,II="N"
 Q
RETRY(U,T) I U F I=1:1:U W T
 Q
WRC(I,J,BS,T) ;КЛЕТКА
 N d1,BSF
 S d1=$$CELL^%ZAPM.bs.BSCt(T,I,J) ;ДАННЫЕ КЛЕТКИ
 S l=$P(BS,"@",3)*$P(BS,"@",4)
 F BSF=1:1:$P(BS,"@",3) S S(I,BSF)=$G(S(I,BSF))_$E(d1_$J("",l),BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))_$C(0)
 Q
WRBS(I) ;УГОЛ-ШАПКА-БОКОВИНА-СТРОКИ
 I TX F J=1:1:TX-1 Q:$$CurW(J)  D WRC(I,J,@BS@(I,J),BS)
 F J=X:1 Q:$$CurW(J)  D WRC(I,J,@BS@(I,J),BS)
 Q
SPA(S) S S=$$TR^%ZAPM.bs.BSsFUNM(S,"<","&lt;")
 S S=$$TR^%ZAPM.bs.BSsFUNM(S,">","&gt;")
 Q $$TR^%ZAPM.bs.BSsFUNM(S," ","&nbsp;") ;ПРОБЕЛЫ
CTRL(S) Q $TR(S,$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31),"")
CurH(I) I '$P(CFG,",",2) D  Q:$D(Limit) 1 Q 0
 .S KolStr=KolStr+1 I KolP,(KolStr*KolX)>KolP S Limit=I Q
 S CurH=CurH+$P(@BS@(I,1),"@",3)
 I $P(CFG,",",2)<CurH Q 1
 Q 0
CurW(J) I '$D(@BS@(I,J)) S CurWW=J Q 1
 I '$P(CFG,",",3) Q 0
 I $D(CurWW) Q:J<CurWW 0 Q 1
 S CurW=$G(CurW)+$P(@BS@(1,J),"@",4)
 I $P(CFG,",",3)<CurW S CurWW=J Q 1
 Q 0
TIP1 ;ПРОСТАЯ                    4  5  6           9  10 11 12
 ;ЕСЛИ СТАТУС ТАБЛИЦЫ C1,STR,COL,AT,AP,AC,C2,PRESS,CY,CX,EY,EX
 I $G(CFG)="" S CFG="0,"_$P($$0^%ZAPM.bs.BSCh(28),"=",2)_","_$P($$0^%ZAPM.bs.BSCh(29),"=",2)_",578,578,578,0,0,1,1"
 N S,T,I,J,II,JJ,X,Y,CurH,CurW,Limit
 D WR I '$P(CFG,",",1) D Q^%ZAPM.bs.BSChT0
 D FORM
 D WRITE
 Q
FORM D FORM^%ZAPM.bs.BSCh
 N I,II,III
 w "<input type=""hidden"" name=""BSLABEL"" value=""CFGTAB^~BSChT"">",BK
 w "<input type=""hidden"" name=""BSROU"" value="""_$G(MainRef,"MAIN^~BSCh1")_""">",BK
 w "<input type=""hidden"" name=""BSNSPACE"" value="""_$$%^%ZAPM.bs.BSCh(%KEY("BSNSPACE"))_""">",BK
 w "<input type=""hidden"" name=""BSPART"" value="""_$$%^%ZAPM.bs.BSCh(%KEY("BSPART"))_""">",BK
 w "<input type=""hidden"" name=""BSTABL"" value="""_$$%^%ZAPM.bs.BSCh(%KEY("BSTABL"))_""">",BK
 W "<table bBorder=""0"" width=""100%"">",BK
 W "<tr>"
 W "<td width=""28%""><input type=""checkbox"" name=""C1"" value=""1""" D  W ">Таблицу показывать всю"
 .I $P(CFG,",",1) W " CHECKED "
 
 W "<p><select name=""STR"" size=""1"">",BK
 S II=$P(CFG,",",2) F I=$P($$0^%ZAPM.bs.BSCh(28),":"):$P($$0^%ZAPM.bs.BSCh(28),":",2):$P($P($$0^%ZAPM.bs.BSCh(28),":",3)," ") W "<option " D:I=II  W " value="""_I_""">"_I_"</option>",BK
 .W "selected"
 W "<option value=""0""" D  W " >..</option>",BK
 .I $P(CFG,",",2)=0 W " selected"
 W "</select>"
 
 W "строк<select name=""COL"" size=""1"">",BK
 S II=$P(CFG,",",3) F I=$P($$0^%ZAPM.bs.BSCh(29),":",1):$P($$0^%ZAPM.bs.BSCh(29),":",2):$P($P($$0^%ZAPM.bs.BSCh(29),":",3)," ") W "<option " D:I=II  W " value="""_I_""">"_I_"</option>",BK
 .W "selected"
 W "<option value=""0""" D  W " >..</option>",BK
 .I $P(CFG,",",3)=0 W " selected"
 W "</select>симв. </td>",BK
 
 W "<td width=""34%""><p><CENTER>" I $P(CFG,",",2) W "Таблица Страница Клетка",BR
 W "<MAP NAME=""AT"">",BK S II="ТАБЛИЦУ"
 I $P(CFG,",",4)=0 F I=1:1:8 D AREA(I)
 E  F I=1:1:$L($P(CFG,",",4)) D AREA($E($P(CFG,",",4),I))
 W "</MAP>"
 I $P(CFG,",",4)'=9 W "<IMG SRC="""_$$G($P(CFG,",",4))_""" BORDER=0 usemap=""#AT"">"
 
 W "<MAP NAME=""AP"">",BK S II="СТРАНИЦУ"
 I $P(CFG,",",5)=0 F I=1:1:8 D AREA(I)
 E  F I=1:1:$L($P(CFG,",",5)) D AREA($E($P(CFG,",",5),I))
 W "</MAP>",BK
 I $P(CFG,",",5)'=9 W "<IMG SRC="""_$$G($P(CFG,",",5))_""" BORDER=0 usemap=""#AP"">"
 
 W "<MAP NAME=""AC"">",BK S II="КЛЕТКУ"
 I $P(CFG,",",6)=0 F I=1:1:8 D AREA(I)
 E  F I=1:1:$L($P(CFG,",",6)) D AREA($E($P(CFG,",",6),I))
 W "</MAP>",BK
 I $P(CFG,",",6)'=9 W "<IMG SRC="""_$$G($P(CFG,",",6))_""" BORDER=0 usemap=""#AC"">"
 E  D NAVIG
 W "</CENTER></p></td>",BK
 
 W "<td width=""38%"">",BK
 
 W "<input type=""checkbox"" name=""C2"" value=""1""" D  W ">Убрать заголовок и сравнения.",$$ESC,BK
 .I $P(CFG,",",7) W "CHECKED "
 
 W "<p><select name=""PRESS"" size=""1"">",BK
 S II=$P(CFG,",",8) F I=0:1:2 W "<option " D:I=II  W " value="""_I_""">"_$S(I=0:"норма",I=1:"сжать",I=2:"сильнее")_"</option>",BK
 .W "selected"
 W "</select> "
 
 W "<input type=""submit"" value=""Запомнить"" name=""B1""></p></td>",BK
 W "</tr></table></FORM><HR>",BK
 Q
ESC() Q "<a TITLE=""Вернуться назад"" href="""_$$A^%ZAPM.bs.BSCh_"BSNSPACE="_$$%T^%ZAPM.bs.BSCh(%KEY("BSNSPACE"))_"&BSMENU=3&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSPART="_$$%T^%ZAPM.bs.BSCh(%KEY("BSPART"))_"""> &lt;== </a>"
G(F) ;ФАЙЛ НАПРАВЛЕНИЯ
 I F=0 Q $$0^%ZAPM.bs.BSCh(26)
 N I,E S I=$$0^%ZAPM.bs.BSCh(26),E=$P(I,".",2),I=$P(I,".")
 Q I_F_"."_E
SELe(I) Q $S(I=1:"ВЛЕВО-ВВЕРХ",I=2:"ВВЕРХ",I=3:"ВПРАВО-ВВЕРХ",I=4:"ВЛЕВО",I=5:"ВПРАВО",I=6:"ВЛЕВО-ВНИЗ",I=7:"ВНИЗ",I=8:"ВНИЗ-ВПРАВО",1:"")
ATAB() ;ССЫЛКА НА ТАБЛИЦУ
 Q "BSMAP="_I_II_"_"_$$SELe(I)_"&BSNSPACE="_$$%T^%ZAPM.bs.BSCh(%KEY("BSNSPACE"))_"&BSPART="_$$%T^%ZAPM.bs.BSCh(%KEY("BSPART"))_"&BSTABL="_$$%T^%ZAPM.bs.BSCh(%KEY("BSTABL"))_"&BSROU="_$G(MainRef,"MAIN^~BSCh1")_"&BSLABEL=GOMAP^~BSChT"_"&BSTABCFG="_$G(CFG)
AREA(I) ;ЧУСТВИТЕЛЬНАЯ ОБЛАСТЬ
 Q:I=9  W "<AREA TITLE="""_II_" "_$$SELe(I)_""" SHAPE=""RECT"" COORDS=""" D  W """ HREF="""_$$A^%ZAPM.bs.BSCh_$$ATAB_""">"
 .W $S(I=1:"0, 0, 25, 22",I=2:"27, 0, 50, 22",I=3:"55, 0, 79, 22",I=4:"0, 24, 25, 47",I=5:"52, 24, 79, 47",I=6:"0, 50, 25, 73",I=7:"27, 50, 50, 73",I=8:"52, 50, 79, 73",1:"")
 Q
TIP2 ;БАЗА ДАННЫХ
 W "??? "
 W $$ESC,BK
 Q
TIP3 ;3 - ТАБЛИЦА-СПИСОК
 G TIP11
TIP4 ;4 - ТАБЛИЦА-СВОДКА
 G TIP11
 Q
TIP ;НЕИЗВЕСТНЫЙ НАУКЕ ЗВЕРЬ
TIP5 ;5 - ТЕКСТ
 F I=1:1 Q:'$D(@BS@(I))  W @BS@(I),BR,BK
 W $$ESC,BK
 Q
TIP6 ;
TIP7 ;
TIP8 ;
TIP9 ;
TIP10 ;
TIP11 W "Данный тип объекта пока не поддерживается"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChT0" type="MAC" languagemode="0"><![CDATA[
%BSChT0 ; пpогpамма НАВИГАЦИИ ПО ТАБЛИЦЕ ; 12:01   09.02.2000
 Q
QQ(Q) S $P(CFG,",",4)=Q,$P(CFG,",",5)=Q,$P(CFG,",",6)=Q
 Q
Q ;ПРОВЕРКА КАРТИНКИ РОЗЫ ВЕТРОВ
 I TY<$P(CFG,",",9),TX<$P(CFG,",",10),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(0) Q  ;-Ж-
 I TY'<$P(CFG,",",9),TX'<$P(CFG,",",10),$P(@BS,"@",28)=$P(CFG,",",11),$P(@BS,"@",29)=$P(CFG,",",12) D QQ(9) Q
 I TY'<$P(CFG,",",9) D  Q  ;-.-
 .I TX'<$P(CFG,",",10),$P(@BS,"@",28)=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(5) Q
 .I TX'<$P(CFG,",",10),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(578) Q
 .I TX'<$P(CFG,",",10),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)=$P(CFG,",",12) D QQ(7) Q
 .I TX<$P(CFG,",",10),$P(@BS,"@",28)=$P(CFG,",",11),$P(@BS,"@",29)=$P(CFG,",",12) D QQ(4) Q
 .I TX<$P(CFG,",",10),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)=$P(CFG,",",12) D QQ(467) Q
 .I TX<$P(CFG,",",10),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(45678) Q
 .I TX<$P(CFG,",",10),$P(@BS,"@",28)=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(45) Q
 I TX'<$P(CFG,",",10) D  Q  ;K-
 .I TY<$P(CFG,",",9),$P(@BS,"@",28)=$P(CFG,",",11),$P(@BS,"@",29)=$P(CFG,",",12) D QQ(2) Q
 .I TY<$P(CFG,",",9),$P(@BS,"@",28)=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(235) Q
 .I TY<$P(CFG,",",9),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(23578) Q
 .I TY<$P(CFG,",",9),$P(@BS,"@",28)'=$P(CFG,",",11),$P(@BS,"@",29)=$P(CFG,",",12) D QQ(27) Q
 I $P(@BS,"@",29)=$P(CFG,",",12) D  Q  ;-I
 .I TX<$P(CFG,",",10),TY<$P(CFG,",",9),$P(@BS,"@",28)=$P(CFG,",",11) D QQ(124) Q
 .I TX<$P(CFG,",",10),TY<$P(CFG,",",9),$P(@BS,"@",28)'=$P(CFG,",",11) D QQ(12467) Q
 I $P(@BS,"@",28)=$P(CFG,",",11) D  Q  ;_._
 .I TY<$P(CFG,",",9),TX<$P(CFG,",",10),$P(@BS,"@",29)'=$P(CFG,",",12) D QQ(12345) Q
 Q
2C ;^
 I TY'<$P(CFG,",",9) Q
 S $P(CFG,",",9)=$P(CFG,",",9)-1
 Q
4C ;<--
 I TX'<$P(CFG,",",10) Q
 S $P(CFG,",",10)=$P(CFG,",",10)-1
 Q
5C ;-->
 I $P(@BS,"@",29)=$P(CFG,",",12) Q
 S $P(CFG,",",10)=$P(CFG,",",10)+1
 Q
7C ;V
 I $P(@BS,"@",28)=$P(CFG,",",11) Q
 S $P(CFG,",",9)=$P(CFG,",",9)+1
 Q
6C D 4C,7C Q
3C D 2C,5C Q
1C D 2C,4C Q
8C D 5C,7C Q
 Q
3CELL(OT,SH,LONG) ;НА КАКОЙ КЛЕТКЕ ОСТАНОВИМСЯ
 N I,H,Limi,KolX,KolP S H=0,KolStr=0,KolX=$P(@BS,"@",29),KolP=$$0^%ZAPM.bs.BSCh(30)
 I TY'=1 F I=1:1:TY-1 Q:'$D(@BS@(I,1))  S H=H+$P(@BS@(I,1),"@",3)
 F I=OT:SH Q:H'<LONG  Q:'$D(@BS@(I,1))  S H=H+$P(@BS@(I,1),"@",3) I '$P(CFG,",",2) D  Q:$D(Limi)
 .S KolStr=KolStr+1 I KolP,(KolStr*KolX)>KolP S Limi=1
 Q I-SH
4CELL(OT,SH,LONG) ;НА КАКОЙ КЛЕТКЕ ОСТАНОВИМСЯ
 N I,H S H=0
 I TX'=1 F I=1:1:TX-1 Q:'$D(@BS@(1,I))  S H=H+$P(@BS@(1,I),"@",4)
 F I=OT:SH Q:H'<LONG  Q:'$D(@BS@(1,I))  S H=H+$P(@BS@(1,I),"@",4)
 Q I-SH
2P ;^
 I TY'<$P(CFG,",",9) Q
 S $P(CFG,",",9)=$$3CELL($P(CFG,",",9),"-1",$P(CFG,",",2))
 I TY'<$P(CFG,",",9) S $P(CFG,",",9)=TY
 Q
4P ;<--
 I TX'<$P(CFG,",",10) Q
 S $P(CFG,",",10)=$$4CELL($P(CFG,",",10),"-1",$P(CFG,",",3))
 I TX'<$P(CFG,",",10) S $P(CFG,",",10)=TX
 Q
5P ;-->
 I $P(@BS,"@",29)=$P(CFG,",",12) Q
 S $P(CFG,",",10)=$P(CFG,",",12)
 I $P(@BS,"@",29)<$P(CFG,",",10) S $P(CFG,",",10)=$$4CELL($P(@BS,"@",29),"-1",$P(CFG,",",3))
 Q
7P ;V
 I $P(@BS,"@",28)=$P(CFG,",",11) Q
 S Tmp=$P(CFG,",",11)-$P(CFG,",",9)
 S $P(CFG,",",9)=$P(CFG,",",11)
 I $P(@BS,"@",28)<$P(CFG,",",9) S $P(CFG,",",9)=$$3CELL($P(@BS,"@",28),"-1",$P(CFG,",",2))
 Q
8P D 5P,7P Q
6P D 4P,7P Q
1P D 2P,4P Q
3P D 2P,5P Q
5T ;-->
 I $P(@BS,"@",29)=$P(CFG,",",12) Q
 S $P(CFG,",",10)=$$4CELL($P(@BS,"@",29),"-1",$P(CFG,",",3))+1
 Q
7T ;V
 I $P(@BS,"@",28)=$P(CFG,",",11) Q
 S $P(CFG,",",9)=$$3CELL($P(@BS,"@",28),"-1",$P(CFG,",",2))+1
 Q
2T ;^
 I TY'<$P(CFG,",",9) Q
 S $P(CFG,",",9)=TY
 Q
4T ;<--
 I TX'<$P(CFG,",",10) Q
 S $P(CFG,",",10)=TX
 Q
8T D 5T,7T Q
3T D 2T,5T Q
1T D 2T,4T Q
6T D 4T,7T Q
1N S $P(CFG,",",9)=TY,$P(CFG,",",10)=TX
 Q
3N S $P(CFG,",",9)=$P(CFG,",",11)-1,$P(CFG,",",10)=TX
 Q
2N S $P(CFG,",",9)=$$3CELL($P(CFG,",",9),"-1",99999),$P(CFG,",",10)=TX
 Q
4N S $P(CFG,",",9)=$P(@BS,"@",28)-2,$P(CFG,",",10)=TX
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChT1" type="MAC" languagemode="0"><![CDATA[
%BSChT1 ; пpогpамма работы с ДАННЫМИ ТАБЛИЦ ; 21:44   21.12.2002
 q
JAVA(WI,HE) ;ТАБЛИЦА
 N %BsWebL,%DEV,%BS,I,II,NSPACE,GL,P1,P2,P3,P9,PART,TABL,TIP,CFG,BS
 N JAVA,W,H,BODY,STR,COL,TIT,TIX,TIY,BYTE,S1,S2
 S %BsWebL=1 D JAVA^%ZAPM.bs.BSHTML1
 Q
EDIT ;РЕДАКТИРОВАНИЕ БАЗЫ ДАННЫХ
 D BEG1^%ZAPM.bs.BSC4
 w "<script LANGUAGE=""JavaScript"" SRC="""_BSDOMAIN_"/js/mfun.js""></script>",!
 D VAR N KEYS
 W "<title>"_TB_" : "_$P(@TB,"@",1)_" >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>></title>",!
 w "</head>",!
 S KEYS=$O(@TB@("KEY",""),-1)
 w "<frameset cols='30%,*,0%' border='false' frameborder=0 >",!
 w "<frameset rows='"_(KEYS*60+40)_",*,0' border='false' frameborder=0 >",!
 N BSROU,BSUSER,BSMENU,BSTOP
 //S BSPART=$$%T^%ZAPM.bs.BSCh(BSPART),BSTABL=$$%T^%ZAPM.bs.BSCh(BSTABL)
 S BSLABEL="EDIT1^~BSChT1",marg=5
 w "  <frame name=""E1"" scrolling=""AUTO"" marginwidth="_marg_" marginheight="_marg_" src="""_$$ADDBSGET^%ZAPM.bs.BSC4_""">",!
 S BSLABEL="EDIT4^~BSChT1"
 w "  <frame name=""E4"" scrolling=""AUTO"" marginwidth="_marg_" marginheight="_marg_" src="""_$$ADDBSGET^%ZAPM.bs.BSC4_""">",!
 w "  <frame name=""E5"" >",!
 w "</frameset>",!
 S BSLABEL="EDIT2^~BSChT1"
 w "  <frame name=""E2"" scrolling=""AUTO"" marginwidth="_marg_" marginheight="_marg_" src="""_$$ADDBSGET^%ZAPM.bs.BSC4_""">",!
 w "  <frame name=""E3"" >",!
 w "</frameset>",!
 D END^%ZAPM.bs.BSC4
 Q
VAR //СОЗДАТЬ ПЕРЕМЕННЫЕ
 S pP=$$%^%ZAPM.bs.BSCh(BSPART),pT=$$%^%ZAPM.bs.BSCh(BSTABL) I $E(pP,1)'="^" S pP="^"_pP
 S TB=$NA(@pP@(pT))
 S BD=$$KBD^%ZAPM.bs.BSF12(TB)
 S HTT=$$VARHTT()
 S ArrOUT=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")")
 S KOLK=$O(@TB@("KEY",""),-1)
 Q
VARHTT()
 N BSROU,BSUSER,BSMENU,BSTOP
 //S BSPART=$$%T^%ZAPM.bs.BSCh(P),BSTABL=$$%T^%ZAPM.bs.BSCh(T)
 Q $$ADDBSGET^%ZAPM.bs.BSC4
EDIT0 ;НАЧАЛО
 D BEG1^%ZAPM.bs.BSC4
 D JumpKey ;w "<script LANGUAGE=""JavaScript"" SRC=""/"_$G(BSDJS,"bs")_"/js/bsbd.js""></script>",!
 w "</head>",!
 D VAR
 Q
EDIT1 ;ФРэЙМ ИНДЕКСОВ
 N BD,TB,HTT,KOLK
 D EDIT0
 W "<BODY>"
 W BK,AF,"База данных "_RED_BD_EF_EF
 w "<form name=""EE1"">"_BK
 I $D(@TB@("KEY",0)) D KEYS(0) ;НУЛЕВОЙ ИМЕННОЙ КЛЮЧ
 e  w "<input type=""hidden"" name=""k0"" value="""">",BK
 F I=1:1:9 d
 .i $D(@TB@("KEY",I)) D KEYS(I)
 .e   w "<input type=""hidden"" name=""k"_I_""" value="""">",BK
 w "</form>"
 //w RED,"В индексах Запрещены символы ~%& ",EF
 D END
 Q
KEYS(I) ;ВЫВОД КЛЮЧЕЙ
 //W BK,"<BR> Key=",I," ",BLUE,$P(@TB@("KEY",I),"@",15),EF,"<BR>",BK
 W "Ключ=",I," ",BLUE,$P(@TB@("KEY",I),"@",15),EF,"<BR>",BK
 W " <INPUT name=b1u"_I_" title=""на первый ключ"" TYPE=""button"" VALUE=""&lt;&lt;"" onClick=""JumpKey("_I_",'BEG','"_HTT_"',EE1.k0.value,EE1.k1.value,EE1.k2.value,EE1.k3.value,EE1.k4.value,EE1.k5.value,EE1.k6.value,EE1.k7.value,EE1.k8.value,EE1.k9.value);"">",BK
 W "<INPUT name=b2u"_I_" title=""на предыдущий ключ"" TYPE=""button"" VALUE=""&lt;"" onClick=""JumpKey("_I_",'MIN','"_HTT_"',EE1.k0.value,EE1.k1.value,EE1.k2.value,EE1.k3.value,EE1.k4.value,EE1.k5.value,EE1.k6.value,EE1.k7.value,EE1.k8.value,EE1.k9.value);"">",BK
 W "<INPUT title=""Поле текущего ключа"" name=""k"_I_""" TYPE=""text"" SIZE=10 VALUE="""" " d  w "onClick=""JumpKey("_I_",'LIST','"_HTT_"',EE1.k0.value,EE1.k1.value,EE1.k2.value,EE1.k3.value,EE1.k4.value,EE1.k5.value,EE1.k6.value,EE1.k7.value,EE1.k8.value,EE1.k9.value);"">",BK
 .w "onkeypress='if (13 == event.keyCode) return false;' "
 W "<INPUT name=b3u"_I_" title=""на последущий ключ"" TYPE=""button"" VALUE=""&gt;"" onClick=""JumpKey("_I_",'MAX','"_HTT_"',EE1.k0.value,EE1.k1.value,EE1.k2.value,EE1.k3.value,EE1.k4.value,EE1.k5.value,EE1.k6.value,EE1.k7.value,EE1.k8.value,EE1.k9.value);"">",BK
 W "<INPUT name=b4u"_I_" title=""на последний ключ"" TYPE=""button"" VALUE=""&gt;&gt;"" onClick=""JumpKey("_I_",'END','"_HTT_"',EE1.k0.value,EE1.k1.value,EE1.k2.value,EE1.k3.value,EE1.k4.value,EE1.k5.value,EE1.k6.value,EE1.k7.value,EE1.k8.value,EE1.k9.value);"">",BK
 W "<INPUT name=b5u"_I_" title=""удалить ключ"" TYPE=""button"" VALUE=""del"" onClick=""if (confirm('Удаляем "_I_" узел ! Вы уверены ?')) { JumpKey("_I_",'DEL','"_HTT_"',EE1.k0.value,EE1.k1.value,EE1.k2.value,EE1.k3.value,EE1.k4.value,EE1.k5.value,EE1.k6.value,EE1.k7.value,EE1.k8.value,EE1.k9.value); }"">",BK
 Q
EDIT4 D BEG1^%ZAPM.bs.BSC4 W "<BODY><BR>" //"<center> Кликните 2 раза на ПОЛЕ КЛЮЧА для вывода перечня всех значений КЛЮЧА текущего уровня</center>"
 D END^%ZAPM.bs.BSC4
 Q
refresh() q "JumpKey("_$O(@TB@("KEY",""))_",'BEG','"_HTT_"','','','','','','','','','','');"
SAVECARD W "<input type=""submit"" value=""Сохранить изменения"" name=""BSB1"" onmouseover=""SaveKey();"">"
    W "<BUTTON title='ESC' onclick=""javascript:"_$$refresh_""">Отменить изменения</BUTTON>"
 q
EDIT2 ;ФРЭЙМ КАРТОЧКИ БД
 N BD,TB,Y,X,BS,st,dcell
 D EDIT0
 W BR,"<BODY ONLOAD="""_$$refresh_""">"
 W BK,"<H2>",BLUE,$P(@TB,"@"),EF,"</H2>"
 W "<form name='EE2' action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" target='E5'>"
 d SAVECARD
 w "<table border=0>"
 F Y=1:1 Q:'$D(@TB@(Y))  D
 .W "<tr>"
 .F X=1:1 Q:'$D(@TB@(Y,X))  D
 ..W "<td class=s3 "_$S(X=1:"WIDTH=30%",1:"")_" >" S BS=@TB@(Y,X)
 ..I $P(BS,"@",9)=1 D  ;S dcell=$E($$CELL^%ZAPM.bs.BSCt(TB,Y,X),1,$P(BS,"@",4)*$P(BS,"@",3)) W:dcell'?1N dcell  ;ДАННЫЕ КЛЕТКИ
 ...S dcell=$$CELL^%ZAPM.bs.BSCt(TB,Y,X) W:dcell'?1N dcell
 ..E  D
 ...//I $P(BS,"@",21)=???
 ...I $P(BS,"@",21)=1 W "<TEXTAREA name=""X"_Y_"x"_X_""" cols="_$P(BS,"@",4)_" rows="_$S($P(BS,"@",3)<4:4,1:$P(BS,"@",3))_" title='Y:"_Y_" X:"_X_" Field:"_$P($p(BS,"@",18),"#",1)_" Type:"_$P(BS,"@",21)_"'></TEXTAREA>" Q
 ...W "<INPUT TYPE=""text"" name=""X"_Y_"x"_X_""" SIZE=115 VALUE="""" title='Y:"_Y_" X:"_X_" Field:"_$P($p(BS,"@",18),"#",1)_" Type:"_$P(BS,"@",21)_"'>" s st(Y)=$g(st(Y))_"'&y"_Y_"x"_X_"='+e(EE2.X"_Y_"x"_X_".value)+"
 ..W "</td>"
 .W "</tr>",BK
 w "</table>"
 S BSLABEL="HIDD^~BSChT1"
 //w "<input type=""hidden"" name=""BSNSPACE"" value="""_BSNSPACE_""">",BK
 //w "<input type=""hidden"" name=""BSROU"" value=""MAIN^~BSCh1"">",BK
 //w "<input type=""hidden"" name=""BSLABEL"" value=""HIDD^~BSChT1"">",BK
 //w "<input type=""hidden"" name=""BSPART"" value="""_BSPART_""">",BK
 //w "<input type=""hidden"" name=""BSTABL"" value="""_BSTABL_""">",BK
 w "<input type=""hidden"" name=""BSA"" value=""SAVE"">",BK
 w "<input type=""hidden"" name=""BSK"" value="""_KOLK_""">",BK
 F X=0:1:9 w "<input type=""hidden"" name=BSK"_X_" VALUE="""">",BK
 N BSTOP,BS
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 d SAVECARD
 w "</form>"
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function SaveKey() {",BK
 W "parent.E2.EE2.BSK0.value=parent.E1.EE1.k0.value;",BK
 W "parent.E2.EE2.BSK1.value=parent.E1.EE1.k1.value;",BK
 W "parent.E2.EE2.BSK2.value=parent.E1.EE1.k2.value;",BK
 W "parent.E2.EE2.BSK3.value=parent.E1.EE1.k3.value;",BK
 W "parent.E2.EE2.BSK4.value=parent.E1.EE1.k4.value;",BK
 W "parent.E2.EE2.BSK5.value=parent.E1.EE1.k5.value;",BK
 W "parent.E2.EE2.BSK6.value=parent.E1.EE1.k6.value;",BK
 W "parent.E2.EE2.BSK7.value=parent.E1.EE1.k7.value;",BK
 W "parent.E2.EE2.BSK8.value=parent.E1.EE1.k8.value;",BK
 W "parent.E2.EE2.BSK9.value=parent.E1.EE1.k9.value;",BK
 ;W "alert(parent.E2.EE2.BSK1.value);",BK
 W "}",BK
 W "function SaveData(k,a,HTT,k0,k1,k2,k3,k4,k5,k6,k7,k8,k9) {",BK
 ;русские буквы
 //W "var s=HTT+'&BSK='+k+'&BSA='+a+'&"_$$BSDJS()_"BSLABEL=HIDD^~BSChT1'+'&BSK0='+k0+'&BSK1='+k1+'&BSK2='+k2+'&BSK3='+k3+'&BSK4='+k4+'&BSK5='+k5+'&BSK6='+k6+'&BSK7='+k7+'&BSK8='+k8+'&BSK9='+k9+"
 W "var s=HTT+'&BSK='+k+'&BSA='+a+'&BSLABEL=HIDD^~BSChT1'+'&BSK0='+k0+'&BSK1='+k1+'&BSK2='+k2+'&BSK3='+k3+'&BSK4='+k4+'&BSK5='+k5+'&BSK6='+k6+'&BSK7='+k7+'&BSK8='+k8+'&BSK9='+k9+"
 ;%$@#^!
 ;w "var s=HTT+'&BSK='+k+'&BSA='+a+'&"_$$BSDJS()_"BSLABEL=HIDD^~BSChT1'+'&BSK0='+k0+'&BSK1='+e(k1)+'&BSK2='+e(k2)+'&BSK3='+e(k3)+'&BSK4='+e(k4)+'&BSK5='+e(k5)+'&BSK6='+e(k6)+'&BSK7='+e(k7)+'&BSK8='+e(k8)+'&BSK9='+e(k9)+"
 S I=$O(st(""),-1),st(I)=$E(st(I),1,$L(st(I))-1)
 s i="" F  s i=$O(st(i)) Q:i=""  W st(i)
 W BK,"parent.E3.location=s",BK
 W "}",BK
 W "</script>",BK
END W "</BODY></HTML>",BK
 Q
RESET    W "<div align='right'><A HREF=""javascript:"_$$refresh_""">Отменить изменения</A></div>",BK
 Q
HIDD ;СКРЫТАЯ 3 ФОРМА = ДИСПЕТЧЕР
 N BD,TB,Y,X,BS,I,KEY,CBD,STOP,KOLK,ER1
 D BEG1^%ZAPM.bs.BSC4
 D JumpKey
 D VAR
 ;--------------
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function DoAction() {",BK
 ;W "alert(111);",BK
 ;F I=0:1:9 I $D(@("BSK"_I)) S KEY(I)=$G(@("BSK"_I))
 F I=0:1:9 S KEY(I)=$G(@("BSK"_I))
 ;W "/*",BK
 ;D WL("CBD")
 ;ZW KEY
 ;w BSK
 ;W BK,"*/",BK
 S CBD=BD
 I BSK>0 S CBD=BD_$G(BSK0) D HKK(0)
 F I=1:1:BSK-1  D HKK(I) D
 .I KEY(I)'="" S CBD=$NA(@CBD@(KEY(I))) Q
 .I KEY(I)="" S ER1=I_","_$G(ER1)
 I KEY(BSK)="",BSA="SAVE" S ER1=BSK
 I $D(ER1),BSA="SAVE" W "alert('Значение ключа #"_ER1_" пустое!'); ",BK
 I BSA'="LIST",'$D(ER1) D HIDACT
 W "}",BK
 W "</script>",BK
 ;--------------
 w "</head>",!
 W BK,"<BODY ONLOAD=""DoAction();"">"
 I BSA="LIST" d LIST
 D END
 Q
HKK(K) i BSA="LIST"!(BSA="DEL") q
 I '$D(KEY(K)) Q  W "alert('НЕТ "_K_" КЛЮЧА!');" Q
 W "parent.E1.EE1.k"_K_".value='"_KEY(K)_"';",BK
 Q
Keys2P3(BSK,BD,CBD)
 i BSK=0 d
 .S K=0,P0=$$GD^%ZAPM.bs.BSCp("","B") ;ТОЛЬКО БАЗЫ ДАННЫХ
 .K P3 I BD["]" S BD="^"_$P(BD,"]",2)
 .S i="" F  S i=$O(@P0@(i)) Q:i=""  S P1="^"_i I P1[BD,$P(P1,BD,2)'="" S P3($P(P1,BD,2))=""
 i BSK'=0 d
 .K P3
 .s i="" f  s i=$O(@CBD@(i)) q:i=""  S P3(i)=""
 Q
LIST ;перечень ключей
 W "<form name=""EE4"" action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" target='E5'>"
 w "<table width=100% border=0>"
 w "<tr><td class=s1 align='right'>"_BSK_"</td>"
 W "<td class=s1>уровень. Значений <INPUT TYPE=""text"" DISABLED name=KOL SIZE=3 VALUE="""" ></td>"
 W "</tr>"
 N P1,P2,P3,K
 D Keys2P3(BSK,BD,CBD)
 S K=0
 s i="" f  s i=$O(P3(i)) q:i=""  D  S K=K+1
 .I K=0 w "<tr><td class=s3>"_$$GroupC("","")_"</td><td class=s3>" D ACT0 W $$GroupA_"</td></tr>",BK
 .w "<tr><td class=s1>"_$$GroupC(K,i)_"</td><td class=s1><a title='"_$G(@CBD@(i))_"' href=""javascript:NodeSet('"_i_"');"">",i,"</a></td></tr>",BK
 w "</table>"
 S BSLABEL="ActNode^~BSChT1",BSCBD1=$$%T^%ZAPM.bs.BSCh(BD)
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "</form>"
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 w "parent.E4.EE4.KOL.value="_K_";",BK
 W "function NodeSet(i) {",BK
    w "JumpKey("_(BSK+1)_",'BEG','"_HTT_"'"
    F I=0:1:BSK-1 w ",'"_KEY(I)_"'"
    w ",i"
    F I=BSK+1:1:9 w ",''"
 w ");",BK
 W "}",BK
 W "</script>",BK
 q
ActNode //групповое действие над узлом бд
 N BD,TB,Y,X,BS,I,KEY,CBD,STOP,KOLK,ER1
 D BEG1^%ZAPM.bs.BSC4
 D VAR
 N P1,P2,P3,K,MSG,AN
 S (BD,CBD)=$$%^%ZAPM.bs.BSCh(BSCBD1)
 I BSK>0 S CBD=BD_$G(BSK0)
 F I=1:1:+BSK-1 I @("BSK"_I)'="" S CBD=$NA(@CBD@(@("BSK"_I)))
 
 D Keys2P3(BSK,BD,CBD)
 S K=0,K1=0,MSG="Никаких действий не произведено..."
 I $G(Act0)=3 D  //...............УДАЛИТЬ
 .I $D(CheckW) D  Q  //ВСЕ УЗЛЫ
 ..K @CBD S MSG="Узел `"_CBD_"` удален" D SNX("K",$zr,TB)
 .s i="" f  s i=$O(P3(i)) q:i=""  D  S K=K+1
 ..I $D(@("CheckW"_K)) D CLEAR^%ZAPM.bs.BSCm4($NA(@CBD@(i)),TB) K @CBD@(i) D SNX("K",$zr,TB) S K1=K1+1
 .S MSG="Удалено "_K1_" узлов"
  /*
 I $G(Act0)=2 D  //...............ПОСЛАТЬ
 .I $D(CheckW) S AN=1
 .s i="" f  s i=$O(P3(i)) q:i=""  D  S K=K+1
 ..I $D(@("CheckW"_K))!($D(AN)) //S @CBD@(i) S K1=K1+1
 .S MSG="Помечено "_K1_" узлов"
 */
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function DoAction() {",BK
 I $D(MSG) W "alert('"_MSG_"');",BK
 ;W "/*",BK
 ;D WL("CBD")
 ;ZW KEY
 ;W BK,"*/",BK
 W "}",BK
 W "</script>",BK
 ;--------------
 w "</head>",!
 W BK,"<BODY ONLOAD=""DoAction();"">"
 D END
 Q
ACT0 ;ГРУППОВЫЕ ДЕЙСТВИЯ
 N I,T
 S T=1 W "<select name='Act0' size=1>"
 F I=" ",$$LNG^%ZAPM.bs.BSC4("..."),$$LNG^%ZAPM.bs.BSC4("Удалить",119) W "<option value='"_T_"'>"_I_"</option>" S T=T+1
 W "</select>"
 Q
GroupC(N,NN) Q "<input type=""checkbox"" title='"_$$LNG^%ZAPM.bs.BSC4("Групповая работа включая ",122)_$S(N="":$$LNG^%ZAPM.bs.BSC4("всех ",123)_CBD,1:$NA(@CBD@(NN)))_"' name='CheckW"_N_"' value=''>"
GroupA() Q "<input type=""submit"" name='ActOK0' title='"_$$LNG^%ZAPM.bs.BSC4("Групповое действие",79)_"' value='Выполнить'>"
HIDACT ;ДЕЙСТВИЕ
 N Er2,Er8
 I BSA="SAVE" D  Q
 .d CBD N N3 d SAVE
 .W BK,"alert('СОХРАНИЛИ В УЗЛЕ "_CBD_" - "_N3_" ЗНАЧЕНИЙ');",BK
 I BSA="DEL" D
 .i KEY(BSK)="" W BK,"alert('УЗЕЛ "_$zr_" ПУСТОЙ!');",BK G DEL1
 .I BSK=0 S Er8=$NA(@(CBD_KEY(BSK)))
 .E  S Er8=$NA(@CBD@(KEY(BSK)))
 .D CLEAR^%ZAPM.bs.BSCm4(Er8,TB)
 .K @Er8
 .W BK,"alert('УДАЛИЛИ УЗЕЛ "_$zr_" ');",BK
 .D SNX("K",$zr,TB)
DEL1 .S BSA="MIN"
 ;НУЛЕВОЙ ИМЕННОЙ КЛЮЧ
 I BSK=0,$D(@TB@("KEY",0)) W "parent.E1.EE1.k0.value='"_$$HKEY0(0)_"';",BK I $D(STOP) Q
 ;ИНДЕКСНЫЕ КЛЮЧИ
 S i=$S(BSK=0:1,1:BSK)
 F I=i:1:KOLK W "parent.E1.EE1.k"_I_".value='"_$$HKEY(I)_"';",BK I $D(STOP) Q
 I $D(Er2)       W "alert('"_Er2_"."_" Окно браузера будет закрыто.');",BK,"parent.window.close();"_BK Q
 I '$D(STOP) D HDATA ;КАРТА БД
 Q
CBD S CBD=$NA(@CBD@(KEY(BSK)))
 q
WL(L) ;ВЫВЕСТИ ЗНАЧЕНИЕ ЛОКАЛИ
 F I=1:1 Q:$P(L,",",I,I+1)=""  W "// ",$P(L,",",I),"=",$g(@$P(L,",",I),"undef..."),BK
 W BK Q
DI(N,Y) S Y=$S(Y=1:"YES",1:"") W "parent.E1.EE1.b"_N_"u"_I_".disabled='"_Y_"';",BK
 Q
DIS(G,U) ;ПРОВЕРКА
 I $O(@G@(U))="" D DI(3,1),DI(4,1)
 I $O(@G@(U))'="" D DI(3,0),DI(4,0)
 I $O(@G@(U),-1)="" D DI(1,1),DI(2,1)
 I $O(@G@(U),-1)'="" D DI(1,0),DI(2,0)
 Q
HKEY0(I) ;ИМЕННОЙ
 N P1,P2,P3,K
 S K=0,P0=$$GD^%ZAPM.bs.BSCp("","B") ;ТОЛЬКО БАЗЫ ДАННЫХ
 K P3 I BD["]" S BD="^"_$P(BD,"]",2)
 ;D WL("BD,P0")
 S i="" F  S i=$O(@P0@(i)) Q:i=""  S P1="^"_i I P1[BD,$P(P1,BD,2)'="" S P3($P(P1,BD,2))=""
 I '$D(P3) Q ""
 I BSA="MAX" I $$ZK(1) S KEY(K)=$O(P3(KEY(K))) D DIS("P3",KEY(K)),HK0  D DI(5,$S(KEY(K)="":1,1:0))
 I BSA="MIN" I $$ZK(-1) S KEY(K)=$O(P3(KEY(K)),-1) D DIS("P3",KEY(K)),HK0   D DI(5,$S(KEY(K)="":1,1:0))
 I BSA="BEG" S KEY(K)=$O(P3("")) D DIS("P3",KEY(K)),HK0  D DI(5,$S(KEY(K)="":1,1:0))
 I BSA="END" S KEY(K)=$O(P3(""),-1) D DIS("P3",KEY(K)),HK0  D DI(5,$S(KEY(K)="":1,1:0))
 Q KEY(K)
HKEY(K) ;ИНДЕКСЫ
 I '$$Data^%ZAPM.bs.BSF12(CBD) S Er2="Нет доступа до "_$G(CBD,"?") Q ""
 I K'=BSK D  Q KEY(K)
 .S KEY(K)=$O(@CBD@("")) D DIS(CBD,KEY(K)),HK
 ;I $D(KEY(K-1)),KEY(K-1)="" S KEY(K)="" Q ""
 I BSA="MAX" I $$ZK(1) S KEY(K)=$O(@CBD@(KEY(K))) D DIS(CBD,KEY(K)),HK   D DI(5,$S(KEY(K)="":1,1:0))
 I BSA="MIN" I $$ZK(-1) S KEY(K)=$O(@CBD@(KEY(K)),-1) D DIS(CBD,KEY(K)),HK   D DI(5,$S(KEY(K)="":1,1:0))
 I BSA="BEG" S KEY(K)=$O(@CBD@("")) D DIS(CBD,KEY(K)),HK   D DI(5,$S(KEY(K)="":1,1:0))
 I BSA="END" S KEY(K)=$O(@CBD@(""),-1) D DIS(CBD,KEY(K)),HK  D DI(5,$S(KEY(K)="":1,1:0))
 Q KEY(K)
HK I KEY(K)'="" S CBD=$NA(@CBD@(KEY(K)))
 Q
HK0 I KEY(K)'="" S CBD=CBD_KEY(K)
 Q
ZK(P) I KEY(K)="" G ZK1
 I K=0,$O(P3(KEY(K)),P)'="" Q 1
 I $O(@CBD@(KEY(K)),P)'="" Q 1
ZK1 W BK,"alert('ДАЛЬШЕ НЕЛЬЗЯ !');",BK S STOP=1
 Q 0
JumpKey ;
 w BK,"<script LANGUAGE=""JavaScript"">",BK
 W "function JumpKey(k,a,HTT,k0,k1,k2,k3,k4,k5,k6,k7,k8,k9) {",BK
 W "//русские буквы",BK
 W "var s=HTT+'&BSK='+k+'&BSA='+a+'&BSLABEL=HIDD^~BSChT1'+'&BSK0='+k0+'&BSK1='+k1+'&BSK2='+k2+'&BSK3='+k3+'&BSK4='+k4+'&BSK5='+k5+'&BSK6='+k6+'&BSK7='+k7+'&BSK8='+k8+'&BSK9='+k9;",BK
 ;W "//%$@#^!"
 ;W "//var s=HTT+"&BSK="+k+"&BSA="+a+"&BSLABEL=HIDD^~BSChT1"+"&BSK0="+k0+"&BSK1="+e(k1)+"&BSK2="+e(k2)+"&BSK3="+e(k3)+"&BSK4="+e(k4)+"&BSK5="+e(k5)+"&BSK6="+e(k6)+"&BSK7="+e(k7)+"&BSK8="+e(k8)+"&BSK9="+e(k9)
 W "if (a==""LIST"") { parent.E4.location=s;",BK
 ;   // alert(k+' '+a+' '+HTT);
 W "     return true;",BK
 W "     }",BK
  ;//  alert(k+' '+a+' '+HTT);
 W "parent.E3.location=s;",BK
 W "}",BK
 W "function e(S) { return escape(S);",BK
 W "}",BK
 W "function u(S) { return unescape(S);",BK
 W "}",BK
 W "</script>",BK
 Q
HDATA ;БД
 N N1,N2,N3,Y,X,BS
 F Y=1:1 Q:'$D(@TB@(Y))  D
 .F X=1:1 Q:'$D(@TB@(Y,X))  D
 ..S BS=@TB@(Y,X) I $P(BS,"@",9)=1 Q
 ..S N1="X"_Y_"x"_X
 ..I $P($P(BS,"@",18),"#")'="" S N2=$P($P(BS,"@",18),"#")
 ..E  S N2=Y_","_X
 ..S N3=$G(@CBD@(N2)),N3=$$CTRL^%ZAPM.bs.BSre(N3) ;УДАЛЕНИЕ УПРАВЛЯЮЩИХ СИМВОЛОВ из данных
 ..I N3'="" W "parent.E2.EE2."_N1_".value='"_N3_"';",BK
 ..E  W "parent.E2.EE2."_N1_".value='';",BK
 Q
SAVE ;сохранить
 ;D WL("CBD")
 I '$D(@(BD_KEY(0))) S @(BD_KEY(0))=$G(@BD,"BSD - MSW@")
 N N1,N2,Y,X,BS S N3=0
 F Y=1:1 Q:'$D(@TB@(Y))  D
 .F X=1:1 Q:'$D(@TB@(Y,X))  D
 ..S BS=@TB@(Y,X) I $P(BS,"@",9)=1 Q
 ..S N1=$g(%KEY("X"_Y_"x"_X))
 ..I $P($P(BS,"@",18),"#")'="" S N2=$P($P(BS,"@",18),"#")
 ..E  S N2=Y_","_X
 ..S N3=N3+$$DataSet(CBD,N2,N1)
 I N3 S @CBD=$H_","_$G(BSLOGIN)_",1" D SNX("S",$zr,TB)
 q
DataSet(CBD,NODE,VAL) //ПРИСВОИТЬ НОВЫЕ ЗНАЧЕНИЯ В БАЗУ ДАННЫХ
 N OLD   I NODE="" Q 0
 S $ZT="ERRDataSet"
 S OLD=$G(@CBD@(NODE))
 I VAL=OLD Q 0
 I VAL="" K @CBD@(NODE)
 E  S @CBD@(NODE)=VAL
 Q 1
ERRDataSet W " Ошибка присвоения! " Q 0
SNX(S,zr,PT,Arr) //ПРИСВОЕННЫЕ УЗЛЫ ДЛЯ СИСТЕМЫ СИНХРОНИЗАЦИИ
 i '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Aaa") q  //протокол выключен
 I $D(Arr) S ArrOUT=Arr ;".."_$INCREMENT(@(%BS(24,1)_".I")) S (^mtempBSsinx,^mtempBSprot)=1
 I '$D(ArrOUT) S ArrOUT=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")")
 S @ArrOUT@(+$H,$P($H,",",2)_".."_$INCREMENT(^mtempBSsinx),zr,"A")=S,^("D")=PT,^("L")=$G(BSLOGIN),^("NS")=$zu(5)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChT2" type="MAC" languagemode="0"><![CDATA[
%BSChT2 ;РЕДАКТИРОВАНИЕ ТАБЛИЦЫ ОПИСАНИЯ БАЗЫ ДАННЫХ ; 23:33   02.01.2001
 Q
EDITTOB W "Редактирование таблиц описания баз данных пока не поддерживается"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChW" type="MAC" languagemode="0"><![CDATA[
%BSChW ; пpогpамма BS WEB LINK ; 15:41   19.06.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 W "7,<BsWebLink>",$ZE,$C(13,10),!
 Q
Deamons(mdapi,TKweb,smtp,POP,Term) //КОНФИГУРАЦИЯ И ЗАПУСК ДЕМОНОВ
 //СОХРАНЕНИЕ ОБЩЕСИСТЕМНЫХ ПАРАМЕТРОВ (СИНИЙ МОЛОТОК)
 I TKweb'="" D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb","V",TKweb)
 I Term'="" D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aterm","V",Term)
 I mdapi'="" D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atmdapi","V",mdapi)
 I smtp'="" D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkmail","V",smtp_","_POP)
 D Save123^%ZAPM.bs.BSC4cfgP S P6=""
 I TKweb'="" J ^%ZAPM.bs.BSpgWEBC K St S $P(P6,",",2)=$$showstatus^%ZAPM.bs.BSCmdapi(.St,"%BSpgWEBC","|TCP|"_TKweb)
 I Term'="" J ^%ZAPM.bs.BSpgTEL K St S $P(P6,",",5)=$$showstatus^%ZAPM.bs.BSCmdapi(.St,"%BSpgTEL","|TCP|"_Term)
 I mdapi'="" D start^%ZAPM.bs.BSCmdapi K St S $P(P6,",",1)=$$showstatus^%ZAPM.bs.BSCmdapi(.St,"%BSCmdapi")
 I smtp'="" D STARTMAIL^%ZAPM.bs.BSpgWEBC  K St S $P(P6,",",3)=$$showstatus^%ZAPM.bs.BSCmdapi(.St,"%BSpgWEBC","|TCP|"_smtp)
 I POP'="" D STARTMAIL^%ZAPM.bs.BSpgWEBC  K St S $P(P6,",",4)=$$showstatus^%ZAPM.bs.BSCmdapi(.St,"%BSpgWEBC","|TCP|"_POP)
 Q $g(P6)
PrepFileCopy(P1,P2,P3) ;ПОДГОТОВИТЬ КОПИРОВАНИЕ
 K MM S M=1,P5=P2_$P(P3,P1,2)
 I $ZV["Windows" S P5=$TR(P5,"/","\") F I=1:1:$L(P5,"\")-1 S II=$P(P5,"\",1,I)_"\"  I $ZU(140,4,II)'=0 I $ZU(140,9,II)
 E  S P5=$TR(P5,"\","/")  F I=1:1:$L(P5,"/")-1 S II=$P(P5,"/",1,I)_"/"  I $ZU(140,4,II)'=0 I $ZU(140,9,II)
 ;I $ZU(140,5,P5) //УДАЛИТЬ ФАЙЛ
 Q
FileCopy(P4) ;КОПИРОВАНИЕ
 S MM(M)=P4,M=M+1
 Q
FileCopyEnd() ;КОПИРОВАНИЕ
 Q $$Arr2File^%ZAPM.bs.BSCEXE(.MM,P5)
CLEARGLAVK //ОЧИСТИТЬ ССЫЛКИ ОТ GLAVK
 S ^%ZAPM.bs.BSS("TRIGGER","KEY")="^%ZAPM.bs.BStrigg"
 S ^%ZAPM.bs.BSS("USER","KEY")="^%ZAPM.bs.BSuserS"
 S $P(^%ZAPM.bs.BSS("PATH",6,4),"@",15)="^%ZAPM.bs.BSprotkl"
 F I=2:2:12 S ^%ZAPM.bs.BSS("SERVER",I,4)=$$TR^%ZAPM.bs.BSsFUNM(^%ZAPM.bs.BSS("SERVER",I,4),"[""GLAVK""]","%")
 Q 
INIT ;первоначальная ИНИЦИАЛИЗАЦИЯ
 ;S ^MGWAPP("BSWEBLINK")="MGWAPP^%ZAPM.bs.BSChW" ;OCX КОМПОНЕНТА BsWebLTP
 ;S ^MGWAPP("BSQLG")="MAIN^%ZAPM.bs.BSCGH" ;%BS - SQL GateWay
 ;S ^MGWAPP("BSMAIN")="MAIN^%ZAPM.bs.BSCh1" ;Навигатор по ресурсам %BS+Cache'
 d initBD
 ;D ALLPART^%ZAPM.bs.BSCBD("^%ZAPM.bs.BSC") //КОМПИЛЯЦИЯ СИСТЕМНЫХ ТАБЛИЦ %BS
 ;D COMP^%ZAPM.bs.BSCm2 //КОМПИЛЯЦИЯ ПРИКЛАДНЫХ ТАБЛИЦ %BS
 ;d cpf^%ZAPM.bs.BSCm2 //перечитать без перезагрузки
 D upg(0) //обновление и рекомпиляция классов для 5 версии для всех кипов
 D INIT^%ZAPM.bs.BSC4reg
 D SYSXXX
 ;M ^login=^%ZAPM.bs.BS("login") //УСТАНОВКА НОВЫХ ТЕРМИНАЛЬНЫХ ПОЛЬЗОВАТЕЛЕЙ
 ;D BSS2PROT^%ZAPM.bs.BSCm2 //MSM+ISS ПОЛЬЗОВАТЕЛИ
 ;D 0^%ZAPM.bs.BSCm2 //ПРОКАЧКА БАЗЫ - GLAVK - ОЧИСТКА MSM-РУДИМЕНТОВ
 ;D SETUP^%ZAPM.bs.BSCm2(NEWPATH/)   // ПОСЛЕ ИНСТАЛЛЯЦИИ КОМПЛЕКСА - НАСТРОЙКА ISS+Portal //////
 ;D DelBS^%ZAPM.bs.BSC4r //УДАЛИТЬ ИСХОДНЫЕ ТЕКСТЫ ПРОГРАММ
 d zs
 d tkweb
 d setNameMainServer //установка основного почтового сервера и права админа
 
 //обновить узлы в FON для Табеля 2005
 F I=7:1 Q:'$D(^%ZAPM.bs.BSCiP("KEYS",I))  K ^%ZAPM.bs.BSCiP("KEYS",I) //ИСПРАВИТЬ ОШИБКУ
 I $D(^%ZAPM.bs.BStemp),$$ZU^%ZAPM.bs.BSF4("FON") N G S G="^%ZAPM.bs.BStemp" D FON^%ZAPM.bs.BSCAsIs1(G,0) ;K @G //ВОССТАНОВИТЬ МАССИВЫ В FON
 ZN "%SYS"
 Q 
iniT ;первоначальная ИНИЦИАЛИЗАЦИЯ
 d initBD
 D INIT^%ZAPM.bs.BSC4reg
 d zs
 d tkweb
 S BB="Аdministrator"
 S A=BB_" <B4I@"_$ZU(110)_">тел.911;)" //УСТАНОВИТЬ АДМИНИСТРАТОРОМ B4I
 D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin","V",A)
 d setNameMainServer
 q
zs
 ZN "%SYS"
 //???I '$D(tmp) X "ZL %BSCZSTU ZS ZSTU"
 X "ZL %BSCZSTU ZS ZSTU"
 X "ZL %BSCZSHT ZS ZSHUTDOW"
 X "ZL %BSCnewF11 ZS %BSF11"
 ;X "ZL %BS364 ZS %X364"
 ;X "ZL %BSZSTART ZS %ZSTART"
 ;X "ZL %BSZSTOP ZS %ZSTOP"
 q
initBD
 N BD 
 S Co=$ZU(5)
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""BSG"")") I BD="" Q
 S @BD@("SQL","REM")="МОНИТОР <<SQL GATE WAY>>"
 S @BD@("SQL","ROU")="MAIN^%ZAPM.bs.BSCGH"
 S @BD@("SQL","NSP")=Co
 S @BD@("BSWEBLINK","REM")="УТИЛИТА BSWEBLINK"
 S @BD@("BSWEBLINK","ROU")="MGWAPP^%ZAPM.bs.BSChW"
 S @BD@("BSWEBLINK","NSP")=Co
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""BSQLDSN"")") I BD="" Q
 S @BD@("127.0.0.1","CacheSYS")=""
 S @BD@("127.0.0.1","CacheGLAVK")=""
 S @BD@("127.0.0.1","SH1")=""
 S @BD@("127.0.0.1","KSP")=""
 S @BD@("SQL",1,"SQL1")="SELECT * FROM TABLE1 WHERE (FELD1) LIKE 'FIRST%'"
 S @BD@("SQL",2,"SQL1")="INSERT INTO TABLE1 (FELD1,FELD2) VALUES ('ЗНАЧЕНИЕ1','ЗНАЧЕНИЕ1')"
 S @BD@("SQL",3,"SQL1")="DELETE FROM TABLE1 WHERE FELD1='123'"
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""MAIL"")") S @BD@(1,1,1,"U")=""
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""VISIT"")") S @BD@(1,1,"P")=""
 q
tkweb
 //здесь были проблеммы!!!!
 I $G(^["%SYS"]tempBSDSR(-1))'="" S N=@$ZR D
 .S:N=1 N="C:\InfoPortal\" D SETTKWEB^%ZAPM.bs.BSCm2(N)
 .I '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb") D
 ..S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb","D") I 'A S A=1962
 ..D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb","V",A) S $P(^%ZAPM.bs.BSpgWEBC("Control"),",",7)=A
 .I '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atmdapi") D
 ..S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atmdapi","D") I 'A S A=1961
 ..D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atmdapi","V",A) S ^%ZAPM.bs.BSCmdapicfg("port")=A
 q
setNameMainServer N NS,A,OO,B,BB S A=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin") 
 S NS=$P($P(A,"@",2),">") I $ZCONVERT(NS,"U")'=$ZU(110) D
 .S B=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Acfg") I B'="" S BB=$$GETOPT^%ZAPM.bs.BSC4cfg(B,"ENDUSER") 
 .I $G(BB)="" S BB="Аdministrator"
 .S A=BB_" <B4I@"_$ZU(110)_">тел.911;)" //УСТАНОВИТЬ АДМИНИСТРАТОРОМ B4I
 .D SETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin","V",A)
 S OO=$NA(@$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")@("B4I","FNM")),@OO@("Amail","V")=1 D Save1234^%ZAPM.bs.BSC4cfgP //РАЗРЕШИТЬ ЕМУ ПРИНИМАТЬ ПОЧТУ
 q
SYSXXX ; W BBK,"Добавлен терминальный пользователь '"_BSLOGIN_"'"_BBK
 I $$ZV^%ZAPM.bs.BSCp>5 Q  //ЕСЛИ ВЕРСИЯ ВЫШЕ 5.0
 N i,ons S ons=$ZU(5)
 S i="" F  S i=$O(^login(i)) Q:i=""  K ^login(i)
 ZN "%SYS" i $$AddUser^%Wsusers("SYS~XXX~%SYS~^%ZAPM.bs.BSC~0,0")
 I $ZU(5,ons)
 Q
SETLOG(V,BSLOGIN) //ЗАПИСАТЬ В ЛОГ ПОВЫШЕНИЕ ВЕРСИИ
 S BSLOGIN=$TR(BSLOGIN,$C(0,13,10),"")
 D Tex^%ZAPM.bs.BSMSMF("UpdateVersion",V),SYSMSG^%ZAPM.bs.BSCek("UpdateVersion "_V,"W")
 Q
MGWAPP ;OCX КОМПОНЕНТА BsWebLTP !!! ЗАПРЕЩЕНЫ ~ и |
 N iDCODE,I,P0,P1,P2,P3,P4,P5,P6,P7,P8,P9,VALUE,CODE,NSPACE,OldNS,CIn,COu,SCode,S1,S2
 F I=0:1:9 S @("P"_I)=$$%^%ZAPM.bs.BSCh($G(%KEY("P"_I)))
 I $G(%KEY("CIn")) D INIT^%ZAPM.bs.BSre(+$G(%KEY("SCode"))) F I=0:1:9 S @("P"_I)=$TR(@("P"_I),S2,S1)
 S iDCODE=$G(%KEY("iD_CODE"))
 s $zt="Err^%ZAPM.bs.BSChW",VALUE=""
 I $G(%KEY("CODE"))="" W "1,<BsWebLink>,<NoCode> НЕТ ПРОГРАММНОГО КОДА ",$C(13,10),! Q
 S ROU=$$%^%ZAPM.bs.BSCh($G(%KEY("CODE")))
 I $D(%KEY("NSPACE")) S NSPACE=$$%^%ZAPM.bs.BSCh(%KEY("NSPACE"))
 s OldNS=$zu(5)
 I $G(NSPACE)'="",$zu(5,NSPACE)
 D
 .N %KEY
 .I $E(ROU,1)="$" X "S VALUE="_ROU Q
 .I $E(ROU,1,2)?1A1" " X ROU Q
 .D @ROU
 s OldNS=$zu(5,OldNS)
 W "0,<BsWebLink>, ОШИБОК НЕТ",$C(13,10),!
 I $G(%KEY("COu")) D INIT^%ZAPM.bs.BSre(+$G(%KEY("SCode"))) D  G FINAL
 .W $TR($G(VALUE),S1,S2),$C(13,10),! F I=0:1:9 W $TR($G(@("P"_I)),S1,S2),$C(13,10),!
 W $G(VALUE),$C(13,10),! F I=0:1:9 W $G(@("P"_I)),$C(13,10),!
FINAL W $$INFOC(),$C(13,10),!,$G(%KEY("iD_CODE")),$C(13,10),! Q
INFOC() Q "$J="_$J_",$I="_$I_",$ZV="_$ZV_",%BS v."_$G(^%ZAPM.bs.BS)_",MGWLPN="_$G(%KEY("MGWLPN"))_",USER_AGENT="_$G(%CGIEVAR("HTTP_USER_AGENT"))
Err ;ОШИБКА
 W "5,<BsWebLinkError>, ",$ZE,$C(13,10),!
 Q
GETTXT(T) ;ВОЗВРАТИТЬ ВЕСЬ ТЕСТ
 W $G(@T),$C(13,10),! F I=1:1 Q:'$D(@T@(I))  W $G(@T@(I)),$C(13,10),!
 Q
GET() S P1="" F I=1:1:15 S P1=P1_$H_"="_I_" " H 10
 Q P1
ROU S P1="TESTING...PROGRAMM" Q
upg(back) //РЕКОМПИЛЯЦИЯ КЛАСССОВ ПРИ ПЕРЕХОДЕ С 4 НА 5
 I $P($P($ZV,".")," ",$L($P($ZV,".")," "))'>4 q
 ;merge ^%qCacheMsg("ru")=^%qCacheMsg("en") ;ИСПРАВЛЕНИЕ ОШИБКИ В 5.0.2
 f i=1:1:$zu(90,0) s nslist($zu(90,2,0,i))=""
 s ns="" f  s ns=$o(nslist(ns)) q:ns=""  d
 . i "%CACHELIB,DOCBOOK,SAMPLES"[ns k nslist(ns) q
 . I $$ZV^%ZAPM.bs.BSCp>5 ZN ns Do $system.OBJ.Upgrade() Q  //ЕСЛИ ВЕРСИЯ ВЫШЕ 5.0
 . d CHECKUPDATE^%UPDATECLASSES
 i '$d(nslist) w !,"Classes in all namespaces are up to date" q
 I $$ZV^%ZAPM.bs.BSCp>5 Q
 ;;ИСПРАВЛЕНИЕ ОШИБКИ В ЖУРНАЛИРОВАНИИ ПРИ ПЕРЕХОДЕ С 4 НА 5
 K ^SYS("JOURNAL"),^%SYS("JOURNAL") ;ПОТОМ НУЖНА ПЕРЕЗАГРУЗКА
 k ^%SYS("RECOMPILECLASSES")
 w !!,"The following namespaces require that the classes be recompiled:",!
 s ns="" f  s ns=$o(nslist(ns)) q:ns=""  w !,ns
 s ns="",Count=0 f  s ns=$o(nslist(ns)) q:ns=""  d
 . s ^%SYS("RECOMPILECLASSES","QUEUE",ns)="" W !,ns
 . i Count<10 s Count=Count+1
 i back=1 d  q
 . w !,"Starting background processes"
 . f i=1:1:Count j UPGRADEOBJECTS^%UPDATECLASSES(back)::5 i $t w "."
 . w !,"Examine the CCONSOLE.LOG file for errors"
 d UPGRADEOBJECTS^%UPDATECLASSES(back)
 q
install(G,ForGlobal) ;ПРОГРАММА ПЕРВОНАЧАЛЬНОЙ ИНСТАЛЛЯЦИИ (СТАРАЯ ВЕРСИЯ)"
 N S,SS,I,II,III,IIII
 S S="",III=0,IIII=1 K @G@("ROU")
 F I=1:1 Q:'$D(@G@(I))  D
 .S S=S_@G@(I) F II=1:1:$L(S,$C(13,10))-1 S SS=$P(S,$C(13,10),II) D:'(I=1&(II<3))
 ..I SS="""" S III=0,IIII=IIII+1 Q
 ..S III=III+1,@G@("ROU",IIII,III)=SS
 .S S=$P(S,$C(13,10),II+1)
 G:$d(ForGlobal) CacheGR^%ZAPM.bs.BSCF1
 S SS="ZR  F I=1:1 Q:'$D(@G@(""ROU"",I))  X III ZS @NAME ZR  ",IIII="S NAME=$P(@$ZR,""."") S:NAME[""^"" NAME=$P(NAME,""^"")"
 S III="F II=1:1 Q:'$D(@G@(""ROU"",I,II))  X:II=1 IIII ZI:II'=1 @$ZR:+(II-2)" X SS K @G
 Q
BStemp(JOB)  ;ПРОГРАММА ПЕРВОНАЧАЛЬНОЙ ИНСТАЛЛЯЦИИ (НОВАЯ)
 N S,SS,I,II,III,IIII D ROU1(JOB) Q  
ROU1(G,F) S G="^mtempBS1("_G_")",S="",III=0,IIII=1 K @G@("ROU") F I=1:1 Q:'$D(@G@(I))  D  
 .S S=S_@G@(I) F II=1:1:$L(S,$C(13,10))-1 S SS=$P(S,$C(13,10),II) D:'(I=1&(II<3))  
 ..I SS="" S III=0,IIII=IIII+1 Q  
 ..S III=III+1,@G@("ROU",IIII,III)=SS
 .S S=$P(S,$C(13,10),II+1)
 F I=1:1 Q:'$D(@G@("ROU",I))  D  S SS(0)=III D ROUTINE^%R(NAME_"."_EXT,.SS,.err,"CS",0) 
 .K SS S NAME=$G(@G@("ROU",I,1)),EXT=$P(NAME,"^",2),NAME=$P(NAME,"^"),III=0 F II=2:1 Q:'$D(@G@("ROU",I,II))  S III=III+1,SS(III)=$G(@G@("ROU",I,II))
 K @G Q  
]]></Routine>


<Routine name="%ZAPM.bs.BSChh" type="MAC" languagemode="0"><![CDATA[
%BSChh ; пpогpамма ВАЖНЫХ ФУНКЦИЙ ; 17:53   03.03.2001
 Q
CheckPass(U,P,APP) ;ПРОВЕРКА
 Q $$CheckPass^%ZAPM.bs.BSCp(U,P,APP)
CRC(P) ;ГЕНЕРАЦИЯ КОНТРОЛЬНОЙ СУММЫ
 N U,C,A,B,D,J D SET
 Q D
PASS(APP) ;ПРОВЕКА УЖЕ СУЩЕСТВУЮЩЕГО ПАРОЛЯ И КОНТРОЛЬНОЙ СУММЫ
 N U,C,A,B,D,J D SET
 I $$GETMP^%ZAPM.bs.BSCp(J,APP)="" Q 0
 I C'=D Q 0 ;ПОКА ПРИМИТИВ=НОМЕР ДНЯ ДОЛЖЕН СОВПАДАТЬ !!!!!!!!!
 Q 1
SET S U=$P(%KEY("BSUSER"),",",1),C=$P(%KEY("BSUSER"),",",2),J=$P(%KEY("BSUSER"),",",3)
 S A=$$ADDRIP^%ZAPM.bs.BSC4
 S B=$P($P($P($G(%CGIEVAR("HTTP_USER_AGENT"),"?"),"(",2),")"),";",2,3)
 S D=$P($$h^%ZAPM.bs.BS3,",",1) ;НОМЕР ДНЯ
 Q
MGWAPP ;OCX КОМПОНЕНТА BsWebLink
 W "ОТВЕТ",$C(13,10),!
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSChobbit" type="MAC" languagemode="0"><![CDATA[
%BSChobbit ; пpогpамма транслции текста для ResHack + Promt и многое другое
 Q
 
 // 
CSV ;ВВОД И ТРАНСЛЯЦИЯ СТРОК ФАЙЛА В ТАБЛИЦУ HTML
 N L,dev,%ANS,IO,IOBS,IOF,IOM,IOPAR,IOSL,IOST,IOT,MSYS,POP,GLO,RMSDF,gui,NS,S,V,SS,NS1,OWER
RG W !,"ВВОД ПОЛНЫЙ ПУТЬ К ДОС-ФАЙЛУ:",! D IN^%IS Q:POP
 I IO=$I W !,"УСТРОЙСТВО ВВОДА НЕ ОПРЕДЕЛЕНО" G RG
 S NS=$E($P($P(IO,"\",$L(IO,"\")),"."),6,8)
 S $ZT="ERRGR^%ZAPM.bs.BSChobbit"
 I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 s dev=IO_":"_IOPAR
 s gui=0
 S SS="" F I=1:1 U IO R S(I)
 Q
HTMLSAVE 
 N %FN,%DEV,NFN,LR,LTR
 S PR1="D:/!/TMP.HTM"
 D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 U %DEV
 S I="" F  S I=$O(S(I)) Q:I=""  D
 .I S(I)="" W !!,"---------------------------------------",!! Q
 .W "<tr>",!
 .F II=1:1:3 W "<td>",$P(S(I),";",II),"</td>",!
 .W "<td>1</td>",!,"<td>",$P(S(I),";",4),"</td>",!
 .W "</tr>",!
 W !!,"ЗАВЕРШЕНО УСПЕШНО...",!
 C %DEV Q
RGEX U 0 W !,"ЗАВЕРШЕНО УСПЕШНО...",!!!!
RGEXIT C IO G HTMLSAVE
 Q
ERRGR U 0 I $ze["ENDOFILE"!($ze["ENDOFFILE") G RGEX
 W !,$ZE,*7 G RGEXIT
 //////////////////////////////////////////////////////
VAR //ПЕРЕМЕННЫЕ
 D VAR^%ZAPM.bs.BSCh
 S GT="^mtempHobbit("_$J_")"
 S M="Z"
 Q
LABEL(S) D VAR
 S P4=$E($P(S,BK,1),1,50)
 I P4="!" Q "!" //FINISH
 I P4=P1 Q "P1" //ENGLISH WORD
 I P4=P2 Q "P2" //RUSSIAN WORD
 Q "0"   //ЗАПАКОВАТЬ
PARSER(T) //PARSER
 N I
 D VAR K S
 F I=1:1 Q:$P(T,BK,I,I+1)=""  S S(I)=$P(T,BK,I)
 Q
SBOR S S="",I="" F  S I=$O(S(I)) Q:I=""  S S=S_S(I)_BK
 Q
TRANS(S) I S
 Q S
OBRATNO(T)
 D PARSER(T)
 S I="" F  S I=$O(S(I)) Q:I=""  S S=S(I) D
 .I $L(S,M)=3 S S(I)=$$INC($P(S,M,2)) Q
 .S S(I)=$$INC($P(S,M,2))_$C(34)_$P($P(S,M_" ",2)," "_M,1)_$C(34)_$$INC($P(S,M,4)) Q
 K S(1)
 D SBOR
 Q "!"_BK_S
INC(N) S N=M_N_M
 Q $G(@GT@(N))   
TUDA(T)
 D PARSER(T)
 K @GT S N=100
 S I="" F  S I=$O(S(I)) Q:I=""  S S=S(I) D
 .I S="" Q
 .I S'[$C(34) S S(I)=$$ADD(S) Q
 .I S["FONT" S S(I)=$$ADD(S) Q
 .I S[$C(34) D
 ..I $P(S,$C(34),2)="" S S(I)=$$ADD(S) Q
 ..S S(I)=$$ADD($P(S,$C(34),1))_" "_$tr($P(S,$C(34),2),"&","")_" "_$$ADD($P(S,$C(34),3,99)) Q
 D SBOR
 Q P1_BK_S
ADD(S) S N=N+1,@GT@(M_N_M)=S
 Q M_N_M 
]]></Routine>


<Routine name="%ZAPM.bs.BSCi" type="MAC" languagemode="0"><![CDATA[
%BSCi ;ФУНКЦИИ ПРИЛОЖЕНИЙ ; 17:12   03.01.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 q
c(X,D) //ДЛЯ EXCEL
 Q $TR(+$TR($FN(X,"P",D)," ",""),".",",")
 
KeySort(KD4,KD5) ;KK,k1,k2,k3,k4,k5,k6,k7,k8,k9)
 ;S TX=$P($G(^["FON"]AsIKodNVC(1,k3)),"~",4)
 N TT,Ks4,Ks5
 S Ks4=$G(k4) I Ks4'="",KD4'="" d
 .I '$D(@("^[""FON""]AsIKod"_KD4)@(33)) D Creat33("^[""FON""]AsIKod"_KD4) 
 .S Ks4=$G(@("^[""FON""]AsIKod"_KD4)@(33,k4))
 .I Ks4="" S Ks4=$G(k4)
 S Ks5=$G(k5) I Ks5'="",KD5'="" d
 .I '$D(@("^[""FON""]AsIKod"_KD5)@(33)) D Creat33("^[""FON""]AsIKod"_KD5) 
 .S Ks5=$G(@("^[""FON""]AsIKod"_KD5)@(33,k5))
 .I Ks5="" S Ks5=$G(k5)
 S TT=$G(k2,"?")_"_"_$P($G(^["FON"]AsIKodNVC(1,k3)),"~",4)_"_"_$TR($J(Ks4,8)," ","0")_"_"_$TR($J(Ks5,8)," ","0")_"_$_"_$g(k1)_"_"_$g(k2)_"_"_$g(k3)_"_"_$g(k4)_"_"_$g(k5)
 I $D(@zr)
 Q TT
Creat33(GS) //создать 33 уровень для сортировки
 N I,D,K S I="",D=$G(@GS@(3)) F  S I=$O(@GS@(3,I)) Q:I=""  S K=$P(@GS@(3,I),D,1) I K'="" S @GS@(33,K)=I
 q
KeyS(K) I $L(K)=1 Q "00"
GetKey(NK,KD) N T,TT S (TT,T)=$G(@("k"_NK)) //УНИВЕРСАЛЬНАЯ ФУНКЦИЯ ДЛЯ СПИСКОВ НОВОГО ТАБЕЛЯ
 I NK=3 D
 .I '$D(BSokov1) D VARHIST^%ZAPM.bs.BSCAsIs4 N I F I=1:1:3 s @("BSokov"_I)=+$G(@BDHIST@("ReportParametrCustom",BST,I))
 .N T1,T2,T3 S TT=$G(@("^[""FON""]AsIKod"_KD)@(1,T))
 .I BSokov2 S T2="("_$P(TT,"~",2)_")"
 .I BSokov3 S T3="В/Ч "_T
 .I BSokov1 S T1=$P(TT,"~",1) S TT=T1_$G(T2)_$G(T3)
 .E  S TT=$G(T3)_$G(T2)
 I NK>3 D
 .N TX
 .I KD="NPP" Q
 .S TX=$G(@("^[""FON""]AsIKod"_KD_"s")@(1,T)) I TX'="" S TT=TX Q
 .I TX="" S TX=$G(@("^[""FON""]AsIKod"_KD)@(1,T))
 .S TT=$TR("("_T_") "_TX," ","_")
 
 ;I '$D(Fname) S Fname="N:\123.TXT" I $ZU(140,4,Fname)'=0 O Fname:"UWN" U Fname W "-----",! W  W "-------",! C Fname
 
 I $D(@zr)
 Q TT
GetTableBS(%N1,%N2,%N3,%N4,%N5) ;МОДУЛЬ ВЫВОДА ТЕКСТА ИЛИ ТАБЛИЦЫ ДЛЯ B4Y
 N A,GT,nx,DEL,S
 I %N1="" Q "?1"
 S GT=$$TMPG^%ZAPM.bs.BSF11,DEL=$C(0)
 S A=$$BS2EXCEL(%N1,GT,1,1000,DEL,%N2,%N3,%N4,%N5)
 I '$G(@GT) Q "?2"
 S S="<pre>",nx="" F  S nx=$O(@GT@(nx)) Q:nx=""  S A=$G(@GT@(nx)) I A'="" F ny=1:1 Q:$P(A,DEL,ny,ny+1)=""  S S=S_"<nobr>"_$P(A,DEL,ny)_"</nobr><br>"
 Q S_"</pre>"
 ;BS 2 EXCEL
BS2EXCEL(TABLE,GT,CourVV,BYTE,Delim,%NY1,%NY2,%NX1,%NX2,calconly) ;BS TO EXCEL ПРИЛОЖЕНИЕ ДЛЯ CACHE'  Bs2Exc.exe  !!!!!!! МОДУЛЬ ДУБЛИРОВАН ИЗ ^%ZAPM.bs.BSHTML
 N KBT,TIX,TIY,TIT,TISH,XB,YB,XE,YE,X,Y,I,SD,B,YT,XT,YXT,YdT,XdT,ASD,BS,ny,nx,d,d0,d1,LNG,N,NN,NNN,KS,BSR,BST,TIP,S1,S2,TableAlive
 K:$G(%NY1)="" %NY1 K:$G(%NY2)="" %NY2 K:$G(%NX1)="" %NX1 K:$G(%NX2)="" %NX2
 S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1($G(@TABLE)) D  ;ПЕРЕКОДИРОВАТЬ
 .D INIT^%ZAPM.bs.BSre($G(CourVV,1)) S TableAlive=1 ;!!!!!!ДЛЯ ФУНКЦИИ $$TIN^%ZAPM.bs.BSsFUNR
 S LNG=$G(BYTE,1000),N=0,NN="",KS=0,DEL=$G(Delim,$C(1))
 S BSR=$P(TABLE,"("),BST=$QS(TABLE,1),TIP=$P(@TABLE,"@",17)
 S KBT=0,TIY=1,TIX=1,TISH=+$P($G(@TABLE@("ExcelOut")),",",3)
 L +@BSR@(BST):0 E  S @GT@(1)="",@GT@(2)="   Таблица занята другим пользователем",N=2,KBT=$L(@GT@(2)) G bs2
 L -@BSR@(BST)
 D BS2TIT I $G(@BSR@(BST,"RSM"))'="" D XM^%ZAPM.bs.BSre(@$ZR) ;ВЫПОЛНИТЬ КОМАНДУ ВОССТАНОВЛЕНИЯ
 I $D(@BSR@(BST,"FCL")) D CALC^%ZAPM.bs.BSF3 //         ПЕРЕСчИТАТЬ ФОРМУЛЫ```
 ;????s @BSR@(BST,"calc")=$h //флаг о том что пересчитали формулы для EXcel загузчика
 i $g(calconly) q "calconly"
 F ny=$G(%NY1,1):1:$G(%NY2,999999) Q:'$D(@TABLE@(ny))  K S D
 .I TIP=5 S S(1)=$G(@TABLE@(ny)) ;ЭТО ТЕКСТ
 .E  Q:'$P(@TABLE@(ny,1),"@",3)  F nx=$G(%NX1,1):1:$G(%NX2,999999) Q:'$D(@TABLE@(ny,nx))  I $P(@TABLE@(ny,nx),"@",4) D
 ..I $P(TIT,",")=ny&($P(TIT,",",2)=nx) S TIX=$L($G(S(1)))+1,TIY=KS
 ..D CELL
 .S nx="" F  S nx=$O(S(nx)) Q:nx=""  S NNN=$TR(S(nx),S1,S2),KBT=KBT+$L(NNN) D
 ..I ($L(NN)+$L(NNN))>LNG S N=N+1,@GT@(N)=$E(NN,1,$L(NN)-$L(DEL)),NN=""
 ..S NN=NN_NNN_DEL,KS=KS+1
bs2 S N=N+1,@GT@(N)=$E(NN,1,$L(NN)-$L(DEL)),@GT=KS
 S P4="$"_$S(TISH'=0:TISH,1:TIY-2)_":$"_TIY
 S P5=TIX
 S P6=TIY+1 ;ТИТУЛ ПО СТРОКАМ
 S P7=$TR(BST,":!"_$C(34)_"[]","__")
 S P8=KBT ;КОЛ-БАЙТ
 S P9=$R(9)_$R(9)_$R(9)_".txt"
 D U^%ZAPM.bs.BS3($NA(@BSR@(BST))) //СНЯТЬ ЛОКИРОВКУ
 Q +N
 ;BS 2 EXCEL
BS2EXCELold(TABLE,GT,CourVV,BYTE,Delim) ;BS TO EXCEL ПРИЛОЖЕНИЕ ДЛЯ CACHE'  Bs2Exc.exe  !!!!!!! МОДУЛЬ ДУБЛИРОВАН ИЗ ^%ZAPM.bs.BSHTML
 N KBT,TIX,TIY,TIT,TISH,XB,YB,XE,YE,X,Y,I,SD,B,YT,XT,YXT,YdT,XdT,ASD,BS,ny,nx,d,d0,d1,LNG,N,NN,NNN,KS,BSR,BST,TIP,S1,S2,TableAlive
 S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1($G(@TABLE)) D  ;ПЕРЕКОДИРОВАТЬ
 .D INIT^%ZAPM.bs.BSre($G(CourVV,1)) S TableAlive=1 ;!!!!!!ДЛЯ ФУНКЦИИ $$TIN^%ZAPM.bs.BSsFUNR
 S LNG=$G(BYTE,1000),N=0,NN="",KS=0,DEL=$G(Delim,$C(1))
 S BSR=$P(TABLE,"("),BST=$QS(TABLE,1),TIP=$P(@TABLE,"@",17)
 S KBT=0,TIY=1,TIX=1,TISH=+$P($G(@TABLE@("ExcelOut")),",",3)
 D BS2TIT
 F ny=1:1 Q:'$D(@TABLE@(ny))  K S D
 .I TIP=5 S S(1)=$G(@TABLE@(ny)) ;ЭТО ТЕКСТ
 .E  Q:'$P(@TABLE@(ny,1),"@",3)  F nx=1:1 Q:'$D(@TABLE@(ny,nx))  I $P(@TABLE@(ny,nx),"@",4) D
 ..I $P(TIT,",")=ny&($P(TIT,",",2)=nx) S TIX=$L($G(S(1)))+1,TIY=KS
 ..D CELL
 .S nx="" F  S nx=$O(S(nx)) Q:nx=""  S NNN=$TR(S(nx),S1,S2),KBT=KBT+$L(NNN) D
 ..I ($L(NN)+$L(NNN))>LNG S N=N+1,@GT@(N)=$E(NN,1,$L(NN)-$L(DEL)),NN=""
 ..S NN=NN_NNN_DEL,KS=KS+1
 S N=N+1,@GT@(N)=$E(NN,1,$L(NN)-$L(DEL)),@GT=KS
 S P4="$"_$S(TISH'=0:TISH,1:TIY-2)_":$"_TIY
 S P5=TIX
 S P6=TIY+1 ;ТИТУЛ ПО СТРОКАМ
 S P7=$TR(BST,":!"_$C(34)_"[]","__")
 S P8=KBT ;КОЛ-БАЙТ
 S P9=$R(9)_$R(9)_$R(9)_".txt"
 Q +N
BS2TIT S TIT="1,1"
 I $P(@TABLE,"@",19) S TIT=$P(@TABLE,"@",19)
 E  I $P(@TABLE,"@",50) S TIT=$P(@TABLE,"@",50)
 Q
celltra(BSR,BST,ny,nx) N L,X,S,d,d1,d0 D CELLL Q d1
CELL ;ДАННЫЕ КЛЕТКИ !!!!!!! МОДУЛЬ ДУБЛИРОВАН ИЗ ^%ZAPM.bs.BSHTML -- А ТАМ УДАЛЕН!!!
	;УЩЕ ЕСТЬ АНАЛОГИЧНЫЕ ДУБЛИ В ^%ZAPM.bs.BSTM,^%ZAPM.bs.BST
 N L,BS
CELLL S BS=@BSR@(BST,ny,nx)
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_$G(%BS(15),1),ny,nx))
 I $P(BS,"@",8)'="" S %zT=$ZT,$ZT="ERCEEL^%ZAPM.bs.BSCi" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"",ny,nx)")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 S L=$P(BS,"@",3)*$P(BS,"@",4)
 F X=1:1:$P(BS,"@",3) S S(X)=$G(S(X))_$E(d1_$J("",L),X*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(X-1)))
 Q
ERCEEL Q
NS(APP,APPVAL) ;ВСЕ ОБЛАСТИ ДЛЯ ПРИЛОЖЕНИЯ APP С ГРАНДОМ APPVAL
 n i,l,n,GS
 ;VALUE="NS1"_$C(1)_"NS2..."
 S P1=0,P2=""
 I '$$Data^%ZAPM.bs.BSF12(APPVAL) Q P2
 I $D(@APPVAL@("*")) D
 .i '$zu(90,0) Q
 .S P2="",P1=$zu(90,0)
 .f i=1:1:P1 s l($zu(90,2,0,i))=""
 .s l="" f  s l=$o(l(l)) q:l=""  I '$D(@APPVAL@("-"_l))  s P2=P2_l_$C(1)
 S l="" F  S l=$O(@APPVAL@(l)) Q:l=""  I $E(l,1)'="*",$E(l,1)'="-",'$D(l(l)) s P2=P2_$TR(l,"'",$C(34))_$C(1)
 Q $E(P2,1,$L(P2)-1)
 
BSR(NS,APP,APPVAL,TIPPA) ;ВСЕ РАЗДЕЛЫ  В ОБЛАСТИ ДЛЯ ГРАНДА ПРИЛОЖЕНИЯ
 i NS="Global Partition" Q $$LISTPART2^%ZAPM.bs.BSmirGL
 I $TR(NS," ","")="" Q ""
 ;P1=КОЛИЧЕСТВО
 ;P2=ТИПЫ_$C(1)_"...
 ;P3=КОМЕНТАРИИ_$C(1)_"...
 ;VALUE="GL1"_$C(1)_"GL2~..." МАССИВЫ
 N n,i,ii,l,KOL,PA
 S n=""
 I NS["""," S NS=$TR(NS,$C(34),"'")
 ;I NS'[",",($D(@APPVAL@(NS,"*"))!($D(@APPVAL@("*")))) 
 //все глобали
 S n=$$GD^%ZAPM.bs.BSCp(NS,$G(TIPPA,"P ;"))  ;ВСЕ ГЛОБАЛИ В НС
 S l=n I '$D(P1) Q "~"
 S l="",ii="" f  s ii=$O(@n@(ii)) q:ii=""  s PA(ii)=""
 // не приложение
 I 0,$D(@APPVAL@(NS)) D
 .S ii="" f  s ii=$O(PA(ii)) Q:ii=""  I $D(@APPVAL@(NS,"-"_ii))  K PA(ii)
 .S i="" F  S i=$O(@APPVAL@(NS,i)) Q:i=""  I $E(i,1)'="*",$E(i,1)'="-",'$D(PA(i)) s PA(i)=""
 S P2="",P3="",P1=0,i="",l="" F  S i=$O(PA(i)) Q:i=""  D
 .S P1=P1+1,l=l_i_$C(1)
 .S P2=P2_"P"_$C(1) ;ТИПЫ
 .S P3=P3_$P($$TIP^%ZAPM.bs.BSCp(i,1),"@",2)_$C(1) ;КОМЕНТАРИИ
 S P3=$$OEM2ANSI^%ZAPM.bs.BSCp(P3) ;ПЕРЕКОДИРОВАТЬ
 Q $E(l,1,$L(l)-1)
 
BST(BSR,APP,APPVAL,gP)  ;ВСЕ таблицы %BS В разделе BSR ДЛЯ APPVAL
 i $G(gP)="Global Partition" Q $$LISTTAB^%ZAPM.bs.BSmirGL(BSR)
 ;P1=КОЛИЧЕСТВО ТАБЛИЦ
 ;VALUE="T1"_$C(1)_"T2~..."
 S P1=0,(P3,P2,P4)=""
 N n,i,ii,S1,S2,MAS,NS
 S MAS=$P($P(BSR,"]",2),"(",1),NS=$TR($P($P(BSR,"""]",1),"[""",2),$C(34),"'")
 S (n,i)="" F  S i=$O(@BSR@(i)) Q:i=""  d
 .I $D(@APPVAL@(NS,MAS,"-"_i)) Q
 .S n=n_i_$C(1),P1=P1+1,ii=$G(@BSR@(i))
 .S P4=P4_$P(ii,"@",17)_$C(1)              ;ТИПЫ
 .S P2=P2_$$TIP^%ZAPM.bs.BS($P(ii,"@",17))_$C(1)  ;ТЕКСТ ТИПОВ
 .S P3=P3_$P(ii,"@")_$C(1)               ;КОМЕНТАРИИ
 S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1(P3) D  ;ПЕРЕКОДИРОВАТЬ
 .K S1,S2 I $$ANSI^%ZAPM.bs.BSre("")
 .S P3=$TR(P3,S1,S2),P2=$TR(P2,S1,S2),n=$TR(n,S1,S2)
 Q n
 
indexlist(index,total,GL) ;
 i index>@t s VALUE="",P4="" q
 s name=$g(@t@(0,index-1)) ;go back by one
 s VALUE="",P4="",P5="",P6="" I GL'["(" S P5=$G(@GL,$C(1))
 f i=1:1:total s name=$o(@GL@(name)) q:name=""  d
 .s VALUE=VALUE_name_$c(10)
 .s P4=P4_$G(@GL@(name),$C(1))_$c(0)
 .s P6=P6_$d(@GL@(name))_$c(0)
 q
Na(GL,I) i I="" S P9=$D(@GL) q GL
 s P9=$d(@GL@(I))
 q $NA(@GL@(I))
 ;
getname(index) ;
 s name=$g(@t@(0,index))
 Q name
 ;
X(x,P1,P2,P3,P4,P5,P6,P7,P8,P9) ;ВЫПОЛНИТЬ
 X x
 Q
F4(G,I,S) ;ПРИСВАИВАНИЕ
 S @G@(I)=S
 Q
getindex(name) ;
 i name="" q 0
 i $d(@t@(1,name)) q @t@(1,name)
 s name=$o(@t@(1,name))
 i name="" q @t+1
 q @t@(1,name)
 ;
ReInit(g) k ^temBS(g_"¤"_$j) L -@g q
init(g,PAR) k ^temBS(g_"¤"_$j) s t=$zr L +@g
 n n,i
 I g="" S P7=0,(P1,P2,P3,VALUE)="" Q
 s t=$zr
 s n="" f i=0:1 s n=$o(@g@(n)) q:n=""  d
 .s @t@(0,i)=n
 .s @t@(1,n)=i
 s (P7,@t)=i-1 ;всего узлов массива
 S VALUE=$$Data^%ZAPM.bs.BSF12(PAR) I VALUE S P1="Трансформация",P2="Значения ключа",P3="Вид представления индексов в списке" Q
 S P1="Потоком",P2="По индексам",P3="Проход по массиву" Q
 q
Save(I,A) ;СОХРАНИТЬ
 S ^%ZAPM.bs.BSCfg(I,$J)=A
 Q
Rest(I)  ;ВОСТАНОВИТЬ
 Q $G(^%ZAPM.bs.BSCfg(I,$J))
ASK() //ПОКАЗАТЬ ПРИГЛАШЕНИЕ К ВВОДУ ФАЙЛА PR1=DFLT   Q 0   НЕТ
 ;%FN,%DEV НАДО ВЕРНУТЬ С ОТКРЫТЬ ДЛЯ ЗАПИСИ
 Q 1
ADDD(S) //ДОБАВИТЬ ДИСК К ПУТИ
 Q $TR($G(^%ZAPM.bs.BS("DriveISS"),"N:\InfoPortal\")_S,"/","\")
]]></Routine>


<Routine name="%ZAPM.bs.BSCi0" type="MAC" languagemode="0"><![CDATA[
%BSCi0  ;ПРОГРАММА ПЕРВОНАЧАЛЬНОЙ ИНСТАЛЛЯЦИИ
 D ROU("^temBS(144)") Q  
ROU(G) S S="",III=0,IIII=1 K @G@("ROU") F I=1:1 Q:'$D(@G@(I))  D  
 .S S=S_@G@(I) F II=1:1:$L(S,$C(13,10))-1 S SS=$P(S,$C(13,10),II) D:'(I=1&(II<3))  
 ..I SS="" S III=0,IIII=IIII+1 Q  
 ..S III=III+1,@G@("ROU",IIII,III)=SS
 .S S=$P(S,$C(13,10),II+1)
 S SS="ZR  F I=1:1 Q:'$D(@G@(""ROU"",I))  X III ZS @NAME ZR  ",IIII="S NAME=$P(@$ZR,""."")"
 S III="F II=1:1 Q:'$D(@G@(""ROU"",I,II))  X:II=1 IIII ZI:II'=1 @$ZR:+(II-2)" X SS Q
]]></Routine>


<Routine name="%ZAPM.bs.BSClogin" type="MAC" languagemode="0"><![CDATA[
%BSClogin //РЕГИСТРАЦИЯ ПОЛЬЗОВАТЕЛЯ В СИСТЕМЕ
LOGIN ///z
    if $io["TRM" { s x="127.0.0.1" }
    else { s x=$p($zio,"/") } ; UNIX has no "/" here...
    if x?1A.E { // x=machine name; get ipaddr
         s machname=$P(x,".") d $ZU(67,12,machname,$JOB) ; Set machine name into pidtab
         set ipaddr=$PIECE($ZU(54,13,machname),",",1) ; IP lookup on name
         W $ZU(67,15,ipaddr,$JOB)     ; Set IP address into pidtab
    } else { // x=ipaddr; get machine name
         s ipaddr=x d $ZU(67,15,ipaddr,$JOB)
         s machname=$P($$dns(ipaddr),".")
         W $ZU(67,12,machname,$JOB)
    }
    q
dns(address) ; name lookup on IP
 s result=$ZU(54,14,$ZU(54,1,address))
 q $P(result,",",2)
 
 ///z
]]></Routine>


<Routine name="%ZAPM.bs.BSCm" type="MAC" languagemode="0"><![CDATA[
%BSCm ;МОДУЛЬ ДИСПЕТЧЕРА И ПОДДЕРЖАНИЯ ФУНКЦИОНАЛА ПАКЕТА %BS-MSM-MONITOR
 ;
 ;    Copyright (C) 2002 Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 ;ЭТО НАДО ПЕРЕПИСАТЬ, ВСЕ КРИВО И НЕПРАВИЛЬНО
PARTS(P,D,Cm4,PERE) //РАЗДЕЛЫ
 N I S D=$G(D,$C(0))
 I P'[D D PART(P) Q
 F I=1:1 Q:$P(P,D,I,I+1)=""  D PART($P(P,D,I))
 Q
PART(pin) //РАЗДЕЛ
 D BEG1^%ZAPM.bs.BSC4
 I $E(pin,1)'="^" S pin="^"_pin
 I '$$Data^%ZAPM.bs.BSF12(pin) Q
 W "<table border=0 width=100%>" I pin["." S Tmp=$P(pin,"."),Tmp1=$P(pin,".",2),Tmp=$G(@(Tmp_".PRO")@(Tmp1,"REM"))
 I pin'["." S Tmp=$P($G(@(pin)),"@",2)
 W "<tr><td width=30% class=s3 ><strong>"_pin_"</strong></td><td width=70% class=s3 >"_Tmp_"</td></tr>"
 N I,N,BD,Sort,BSTOP
 S N="",I=0 I '$D(@(pin)) W "Нет раздела ! "_PART_" Обратитесь к Администратору" Q
 S Co=0,NWT1=$$GETOPT^%ZAPM.bs.BSC4cfg(MainOpt,"NWT1")
 F  S N=$O(@(pin)@(N)) Q:N=""  I $P($G(@(pin)@(N)),"@",17)=2 D
 .I N="ROU" Q
 .I $D(PERE),$$PERE Q 
 .S Co=Co+1,sta="OK"
 .W "<tr><td width=20% class=s1 >"
 .I $G(Cm4)=1 w $$PAframe
 .I $G(Cm4)=3 W $$PAlist,$$PAform,$$PAframe
 .I $G(Cm4)=2 W $$PAlist,$$PAform
 .W " "_N
 .W "</td><td class=s1 >"_AF,$P($G(@(pin)@(N)),"@",1),EF_"</td></tr>",BK
 W " </table>"
 D END^%ZAPM.bs.BSC4
 Q
PERE() I $G(PERE)=1 Q:$G(PERE(N))=1 0 Q 1
 I $G(PERE)=0 Q:$G(PERE(N))=0 1 Q 0
 Q 1
PAframe() Q "<a title='"_$G(TITl,"редактировать в фрейме")_"' "_$$AN(pin,N,"EDIT^~BSChT1")_"><img src='"_BSDOMAIN_"/img/"_$G(IMG,"const.gif")_"'></a>"
PAlist() Q "<a title='редактировать из списка' "_$$AN(pin,N,"List^~BSCm41")_"><img src='"_BSDOMAIN_"/img/tabl.gif'></a>"
PAform() Q "<a title='редактировать в форме' "_$$AN(pin,N,"T^~BSCm4")_"><img src='"_BSDOMAIN_"/img/form.gif'></a>"
AN(pin,N,BSLABEL,NOWIN)
 n BSTABL,BSPART,BSNSP,BSNSPACE,BSPARENT
 S BSPART=pin
 I pin["""]" S BSNSP=$P(pin,$C(34),2),BSPART="^"_$P(pin,"]",2)
 E  S BSNSP=$TR($ZU(5),"%","~")
 S BSPART=$$%T^%ZAPM.bs.BSCh(BSPART),BSTABL=$$%T^%ZAPM.bs.BSCh(N),BSPARENT=$$ANPAR()
 I $G(NOWIN) Q " href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' "
 Q " class=u1 onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_BSPARENT_""",""toolbar=no,menubar=no,scrollbars=yes,"_$G(NWT1,"width=800,height=600")_",status=1,resizable=1"");' "
ANPAR() Q "EditForm"_$ZCRC(BSPART_BSTABL,7)
EditRecord(P,T,BScurREC) //УСТАНОВКА НА РЕДАКТИРУЕМУ ЗАПИСЬ
 N BSLABEL
 S BSLABEL="EditRec^~BSCm"
 Q "<A title='редактировать данные таблицы' "_$$AN(P,T,BSLABEL)_"> РЕДАКТИРОВАТЬ </A>"
EditRec
 I '$$VAR^%ZAPM.bs.BSCm4 Q
 I '$D(@PT) Q ""
 I $$SetVar^%ZAPM.bs.BSC4(PT_" CurNode",BScurREC) ;УСТАНОВИТЬ ТЕКУЩУЮ ЗАПИСЬ
 I $G(BSPARENT)="" S BSPARENT=$$ANPAR()
 D T^%ZAPM.bs.BSCm4
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCm1" type="MAC" languagemode="0"><![CDATA[
%BSCm1 ;МОДУЛЬ ДИСПЕТЧЕРА И ПОДДЕРЖАНИЯ ФУНКЦИОНАЛА <<MONITORING>>  ; 21:46   21.12.2002
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
DT(H) I '$D(H) S H=$H
 I H="" Q "дата/время пустое"
 Q $ZD(H,3)_" "_$ZT($P(H,",",2),1)
TIB() q " title='вывести в файл репликации модифицированную информацию' "
SEND //ПОСЛАТЬ
 D VAR
 D BEG1^%ZAPM.bs.BSC4
 W "<BODY>"_BK
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="SEND1^~BSCm1"        D ADDBSPOST^%ZAPM.bs.BSC4reg
 S UZ=$O(@BDPR@("SEND",""),-1)
 W "Последняя выдача осуществлялась :"_RED_$$DT(UZ)_EF I UZ'="" W "Пользователем :"_RED_$G(@BDPR@("SEND",UZ,"LOGIN"))_EF
 W "<HR>"
 I KOLout="" S KOLout=100
 W " "_$$GetDirectTabN1^%ZAPM.bs.BSC4r("%BSC4SNX","Text","TD>>>","TXT")_BBK_BBK
 W "<DIV title='Дата,время - протокол всех последних "_KOLout_" выводов'> с даты "
 W "<select name='TDLIST' size=1 >"
 S UZ1="" F I=1:1:KOLout  S UZ1=$O(@BDPR@("SEND",UZ1),-1) Q:UZ1=""  D
 .W "<option " W:I=1 "selected" W " value='"_UZ1_"'>"_$$DT(UZ1)_"</option>"
 W "</select>"
 w " по " S UZ1=$$DT($H)
 W "<input type='TEXT' title='ГГГГ-ММ-ДД' name='sDATA' size=8 value='"_$P(UZ1," ",1)_"'>"
 W "<input type='TEXT' title='ЧЧ:ММ:СС' name='sTIME' size=8 value='"_$P(UZ1," ",2)_"'><br>"_BBK
 W "<input type='submit' name='sSEND3' value='СОЗДАТЬ ФАЙЛ РЕПЛИКАЦИИ>>' "_$$TIB_"></div>"_BBK
 ;W "<input type='submit' name='sSEND3' value='ПОСЛАТЬ>>' "_$$TIB_">"_BBK_BBK
 //
 W "<FIELDSET><LEGEND>Какие модифицированные данные выводить</LEGEND>"
 W "<input type='checkbox' name='cALL' value=0 size=35 checked> ВСЕ "_BBK
  N GetAccLU I $$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGIN,"MONA")=5 W "<input type='checkbox' name='cPRO' value=0 size=35 > ПРОЕКТЫ (программы, массивы, таблицы)"_BBK
  N GetAccLU I $$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGIN,"MONA")>3 W "<input type='checkbox' name='cUFD' value=0 size=35 > ОПИСАНИЕ Унифицированных Форм Донесений "_BBK
 W "<input type='checkbox' name='cDOC' value=0 size=35 > ДОКУМЕНТЫ заполненные по УФД"_BBK
 W "</FIELDSET>"_BK
 W "<FIELDSET><LEGEND>Как выводить</LEGEND>"
 W "<input type='radio' name='cDETAL' value=1 size=35  checked > Не детализировать, выводить все"_BBK
 W "<input type='radio' name='cDETAL' value=2 size=35 > Максимально детализировать, пометить все"_BBK
 W "<input type='radio' name='cDETAL' value=3 size=35 > Максимально детализировать, не помечать"_BBK
 W "</FIELDSET>"
 W "</form>"_BK
 Q
SENDAUTO D VAR
 s cDETAL=1
 D SEND2($O(@BDPR@("SEND",""),-1),$H,"1000",1)
 Q
SEND1 //РАЗБОР ПАРАМЕТРОВ
 D VAR
 N N,I,C
 S C="",I=0
 F N="cALL","cPRO","cUFD","cDOC" S I=I+1 I $D(@N) S $E(C,I)=1
 S TDLIST2=$$DATHR^%ZAPM.bs.BSsFUNR(8,$TR(sDATA,"-","")_$E($TR(sTIME,":",""),1,4))
 D SEND2(TDLIST,TDLIST2,C)
 Q
SEND2(TD,TD2,C,SAY) //ПОЕХАЛИ
 D VAR1,VAR3 i '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Ab") W BBK_BBK_"Send turn off" q
 D BEG1^%ZAPM.bs.BSC4
 W "<BODY>"_BK W "<h3>ПОСЫЛКА ДАННЫХ</h3>"
 I '$D(@BDAL@(CS)) W "Идентификатор текущей системы '"_CS_"' неопределен в БД "_BDAL_". Текущая система не реплицируема." G SEND3
 N U1,U2,U3,U4,NSP,PART,TABL,FNO,DOS,CON,KOLDOC,StringCtrl,size,DOS3
 S KOLDOC=0      ;новый вариант с бинарными файлами
 D DeltempBS^%ZAPM.bs.BSC4r4 ;ПОЧИСТИМ ВРЕМЕННЫЕ ПРОГРАММЫ ПЕРЕД СОЗДАНИЕМ
 D
 .N GetField,GR,MAS,MASF,T1,MASB,DOS1,DOS2,STOP
 .S T1="",MAS="TEMP",MASF="FILE" 
 .K @MASS S MASB=$ZR
 .I $G(SAY)="" W AF
 .;F  S T1=$O(@ArrOUT@(T1),-1) Q:T1=""!(T1<$P(TD,","))  S T2="" F  S T2=$O(@ArrOUT@(T1,T2),-1) Q:T2=""  Q:T1=$P(TD,",",1)&(T2<$P(TD,",",2))  D 
 .F  S T1=$O(@ArrOUT@(T1),-1) Q:T1=""  Q:$D(STOP)  S T2="" F  S T2=$O(@ArrOUT@(T1,T2),-1) Q:T2=""  Q:$D(STOP)  D
 ..I T1<$P(TD,",") S STOP=1 Q
 ..I T1>$P(TD2,",") Q 
 ..I T1=$P(TD,","),$P(T2,".")<$P(TD,",",2) S STOP=2 Q  //ПОЛНЫЙ ПЕРЕБОР 
 ..I T1=$P(TD2,","),$P(T2,".")>$P(TD2,",",2) Q
 ..N NS,L,A,D,RF,RF1,RF2,RF3,U1,U2,U3
 ..S T3="" F  S T3=$O(@ArrOUT@(T1,T2,T3)) Q:T3=""  D  ;W T3,BBK
 ...S RF=T3 I T3["(" S RF=$E(T3,1,$L(T3)-1)_","
 ...S (RF3,RF1)=$G(@ArrOUT@(T1,T2,T3,"D")),RF2=$G(@ArrOUT@(T1,T2,T3,"A")),NS=$G(@ArrOUT@(T1,T2,T3,"NS"))
 ...I NS="" Q  ;нет области
 ...I $D(@MAS@(NS,RF)) Q  ;совпадающие ссылки
 ...I $E(RF1,1)="^" S RF1="DAT" ;ЭТО редактированные документы
 ...D ADDNS(.RF),ADDNS(.RF3)
 ...S @MAS@(NS,RF1,RF)=T1_$C(0)_T2_$C(0)_T3_$C(0)_RF1_$C(0)_RF2_$C(0)_RF3_$C(0)_NS
 .S U1="" F  S U1=$O(@MAS@(U1)) Q:U1=""  I $$ZU^%ZAPM.bs.BSF4(U1) S U2="" F  S U2=$O(@MAS@(U1,U2)) Q:U2=""  D
 ..S U3="",UU="" F  S U3=$O(@MAS@(U1,U2,U3)) Q:U3=""  D
 ...I UU'="",U3[UU K @MAS@(U1,U2,U3) Q  ;очистить вхождения ссылок
 ...S UU=U3,GR=U3 I U3["(" S GR=$E(U3,1,$L(U3)-1)_")"
 ...S UA=$P(@MAS@(U1,U2,U3),$C(0),5) //ДЕЙСТВИЕ С ССЫЛКОЙ
 ...I $E(U2,1,3)="DAT",UA="S" D SOLID(GR,$P(@MAS@(U1,U2,U3),$C(0),6))
 ...S KOLDOC=KOLDOC+1 
 ...I ($g(cDETAL)'=1),$G(SAY)="" d  W "<input type='checkbox' name='cDOC"_KOLDOC_"' value=0 size=35 "_CHE_" >"_KOLDOC_". "_U1_" (",U2,") "_UA_" "_GR_BBK
 ....S CHE="" I $g(cDETAL)=2 S CHE="checked"
 ...I UA="S" M @MASB@(U1,U2,UA,GR)=@GR
 ...I UA="K" S @MASB@(U1,U2,UA,GR)=""
se4 .I KOLDOC=0 W EF_$$se6 Q
 .M @MASB@("%%FILE","FILE")=@MASF
 .I '$D(CON) S CON=$I
 .I $$ZU^%ZAPM.bs.BSF4("%SYS")
 .S DOS1=$$NEWFILE(DS,CS,"rgr") W "<!-- " D G2F^%ZAPM.bs.BSC4r4($E(MASS,2,99),DOS1,CON,"Пользователь '"_BSLOGIN_"' сделал файл репликации данных системы '"_CS_"' от ("_$$TD^%ZAPM.bs.BSC4base(TD)_") до ("_$$TD^%ZAPM.bs.BSC4base(TD2)_") "_MASS) W " -->"_BK
 .K @MASB
 .S DOS2=$$NEWFILE(DS,CS,"zls") S U1="" U DOS2 F  S U1=$O(@MASF@(U1)) Q:U1=""   W U1,!
 .W $ZCONVERT($tr(DOS1,"/","\"),"L"),!
 .C DOS2 U CON
 .S DOS3=$$NEWFILE(DS,CS,"rar",1)
 .D exec^%ZAPM.bs.BSCEXE(COMM_" "_Dbin_"\WINRar.exe a "_DOS3_" -m5 @"_DOS2,0) ;_" -ps3v9e3t6a8m9y0",0)
 .D del^%ZAPM.bs.BSCEXE(DOS1),del^%ZAPM.bs.BSCEXE(DOS2)
 .;S DOS=$$NEWFILE(DS,CS) U DOS D XMLBEG W "<![CDATA[" C DOS U CON
 .;S DOS1=$$NEWFILE(DS,CS,"txt") U DOS1 W "]]]]><![CDATA[>" D XMLEND C DOS1 U CON
 .;D exec^%ZAPM.bs.BSCEXE(COMM_" "_Dbin_"\merge.exe "_DOS_" "_DOS3_" "_DOS1,0)
 .I $G(SAY)="" W EF
se5 .W $$se6_" по состоянию на "_RED_$$DT(TD2)_EF_", в файл: "_BBK_RED_DOS3_EF D  //DOS --- DOS3
 .S size=$ZU(140,1,DOS3) W " (размер "_size_")"
 .I $G(DOS3)'="" D  //FTP  ... послать файлы синхронизации на ...FTP
 ..N ER
 ..S URI=$P($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aftpsinx"),"//",2,99) I URI="" Q
 ..D FtpAF^%ZAPM.bs.BSCmail($P($P(URI,"@",2),":"),$P($P(URI,"@",1),":"),$P($P(URI,"@",1),":",2),$P($P(URI,"@",2),":",2),DOS3,"",0) W BBK_GREEN_"Отправлено на FTP-сервер '"_$P($P(URI,"@",2),":")_"' под именем '"_$P($P(URI,"@",1),":")_"'"_EF
 ..I $G(ER)'=0 W RED_ER_EF
 .;W RED_$$NEWIN^%ZAPM.bs.BSC4base1($P(DOS,"\",$L(DOS,"\")),$$TR^%ZAPM.bs.BSsFUNM(DOS,"\","%5C"),"Смотреть файл ("_size_" байт)","OUTFILE^~BSCm1")_EF
 .S @BDPR@("SEND",TD2,"LOGIN")=BSLOGIN,@BDPR@("SEND",TD2,"CountDocs")=KOLDOC,@BDPR@("SEND",TD2,"PDateTime")=TD
 S SendDocs=KOLDOC
 //SMTP ... послать файлы синхронизации по эл.почте
SEND3 D BACKS
 D END^%ZAPM.bs.BSC4
 Q
ADDNS(RF) I $E(RF,1,2)'="^[" S RF="^["""_NS_"""]"_$E(RF,2,999)
 Q
PRE(M) W "<HR><PRE>" D  W "</PRE><HR>"
 .I $D(M) ZW M Q
 .W
 Q
BACKS S BSLABEL="SINX^~BSCm1" W BBK_BBK_"<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>Главное меню синхронизации</A>" Q      
se6() Q "<HR> Выведено "_RED_$G(KOLDOC,0)_EF_" документ(а,ов)"       
SOLID(CurNode,PT) ;где есть файлы собрать их в список для архивирования
 N FN1,Mf,ny,P,T,var1,FN2
 S FN1=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"DF") I FN1="" Q
 S P=$QS(PT,0),T=$QS(PT,1)
 s Mf=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Count",1) //количество полей
 ;проверить кол-во уровней
 s Mxi=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Index",1)
 i $ql(CurNode)'=Mxi S Cu=$QS(CurNode,0) D  S CurNode=Cu
 .f i=1:1:Mxi s Cu=$NA(@Cu@($QS(CurNode,i)))
 F ny=1:1:Mf s var1=$$GetField^%ZAPM.bs.BSC4rou(P,T,ny,1) i $P(var1,"~",3)=6 D
 .S nf=$P(var1,"~",1),d=$G(@CurNode@(nf)) I d="" Q
 .S FN2=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"xSubDir"),Tmp1=FN1_FN2_d I $ZU(140,4,Tmp1)'=0 Q
 .S @MASF@($TR(Tmp1,"/","\"))=CurNode
 Q
FNC(Tmp1) Q $ZCONVERT($tr(Tmp1,"/","\"),"L")
NAD(RF) I $E(RF1,1)="^" S RF1="DATE"
 S @MAS@(RF1,RF)=T1_$C(0)_T2_$C(0)_T3
 Q
XMLBEG //НАЧАЛО ДОКУМЕНТА
 W "<?xml version=""1.0"" encoding=""Windows-1251"" ?>"_BK
 W "<SendStream NameUser='"_$G(BSLOGIN)_"'  ReqSysDataTime='"_TD_"' SysName='"_CS_"' IDArhive='876'>"
 Q
XMLEND //ОКОНЧАНИЕ
 ;!!! $zcrc(?,7)
 W "<StreamInfo TotalDocs='"_$G(KOLDOC)_"' CurSysDataTime='"_$H_"' ></StreamInfo>"_BK
 W "</SendStream>"_BK
 Q
NEWFILE(DS,CS,EXT,QUIT) //СОЗДАТЬ И ОТКРЫТЬ НОВЫЙ ФАЙЛ ДЛЯ ЗАПИСИ
 N DOS S FNO=DS_$S($E(DS,$L(DS))="\":"",1:"\")_CS_"_"_$ZD(+$H,8)_"_"_$TR($ZT($P($H,",",2),1),":","")_"."_$G(EXT,"xml")
 I $G(QUIT)'="" Q FNO 
 I $$Open^%ZAPM.bs.BSXdos(FNO,"W")
 Q DOS
 //%BSC4inc      ;строенные функции
 //#include %BSC4inc
SINX //МЕНЕДЖЕР СИНХРОНИЗАЦИЙ
 D BEG1^%ZAPM.bs.BSC4
 W "<BODY>"_BK
 w "<hr><br>"_BK
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="SINX1^~BSCm1" D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<table border=0>"_BK
 W "<tr><td align='right'><img border=0 src='"_BSDOMAIN_"/img/REFR-BLU.gif' ><input type='submit' name='sAUTO' value='АВТОМАТИЧЕСКАЯ <<<>>>'></td><td> </td><td align='left'>"_$$GetDirectTabN1^%ZAPM.bs.BSC4r("%BSC4SNX","Text","auto","TXT")_"</td></tr>"_BK
 W "</table>"_BK
 w "<br><hr>"_BK
 W "<table border=0>"_BK
 W "<tr><td align='right'><img border=0 src='"_BSDOMAIN_"/img/REDO.gif' ><input type='submit' name='sSEND' value='ПОСЛАТЬ ДАННЫЕ >>>'></td><td> </td><td align='left'>"_$$GetDirectTabN1^%ZAPM.bs.BSC4r("%BSC4SNX","Text",">>>","TXT")_"</td></tr>"_BK
 W "<tr><td align='right'><img border=0 src='"_BSDOMAIN_"/img/UNDO1.gif' ><input type='submit' name='sRESV' value='ПРИНЯТЬ ДАННЫЕ <<<'></td><td> </td><td align='left'>"_$$GetDirectTabN1^%ZAPM.bs.BSC4r("%BSC4SNX","Text","<<<","TXT")_"</td></tr>"_BK
 W "</table>"_BK
 w "<br><hr>"_BK
  N GetAccLU I $$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGIN,"MONA")=5 D
 .W "<table border=0>"_BK
 .W "<tr><td align='right'>"_$$PARSNX D  W "</td><td align='left'>"_$$GetDirectTabN1^%ZAPM.bs.BSC4r("%BSC4SNX","Text","OPT","TXT")_" "_$$FTPBUTT_"</td></tr>"_BK
 ..I $$GRA^%ZAPM.bs.BSCGIS(BSLOGIN,"zDebug") W "<a title='"_$G(TITl,"редактировать в фрейме")_"' "_$$AN^%ZAPM.bs.BSCm("^%ZAPM.bs.BSC4SNX","Par","EDIT^~BSChT1")_"><img src='"_BSDOMAIN_"/img/"_$G(IMG,"const.gif")_"'></a>"
 .W "</table>"_BK
 .w "<br><hr>"_BK
 W "</form>"_BK
 D END^%ZAPM.bs.BSC4
 Q
FTPBUTT() I '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aft") Q ""
 Q "<BUTTON TITLE='Открыть каталог синхронизации FTP-сервера' ONCLICK='open("""_$$FTP()_""",""FTP"",""toolbar=yes,menubar=yes,scrollbars=yes,status=1,resizable=1"");' ><img border=0 src='"_BSDOMAIN_"/img/open.gif' >FTP-SNX</BUTTON>"
FTP() Q $$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aftpsinx")
PARSNX() N BSLABEL S BSLABEL="ENTER^~BSC4cfg"
 Q $$BP^%ZAPM.bs.BSC4cfgP("ПАРАМЕТРЫ СИНХРОНИЗАЦИИ","ПАРАМЕТРЫ СИНХРОНИЗАЦИИ","^%ZAPM.bs.BSC4SNX.Par","",1)
PARSNXI(IMG) N BSLABEL S BSLABEL="ENTER^~BSC4cfg"
 Q $$BP^%ZAPM.bs.BSC4cfgP("ПАРАМЕТРЫ СИНХРОНИЗАЦИИ","ПАРАМЕТРЫ СИНХРОНИЗАЦИИ","^%ZAPM.bs.BSC4SNX.Par","",1,IMG)
PARSNXIED(IMG) //КОНСТРУКТОР
 N pin,N,TITl S pin="^%ZAPM.bs.BSC4SNX",N="Par",TITl="КОНСТРУКТОР ШАБЛОНА ПАРАМЕТРОВ СИНХРОНИЗАЦИИ"
 Q $$PAframe^%ZAPM.bs.BSCm()
 
PARIP(IMG) N BSLABEL,A,B 
 S B="^[""%SYS""]BSC4.ISS.AppAccess" ;ШАБЛОН ПАРАМЕТРОВ
 S BSLABEL="ENTER^~BSC4cfg",A=$NA(@$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")@(BSLOGIN,"FNM")) ;КУДА СОХРАНЯЕМ
 Q $$BP^%ZAPM.bs.BSC4cfgP("РЕДАКТИРОВАТЬ ПРАВА ДОСТУПА ДЛЯ ПОЛЬЗОВАТЕЛЯ `"_BSLOGIN_"`","ПАРАМЕТРЫ ПРАВ ДОСТУПА ДЛЯ `"_BSLOGIN_"`",B,A,1,IMG)
PARIPED(IMG) N TITl S TITl="КОНСТРУКТОР ШАБЛОНА ПРАВ ДОСТУПА!!! БУДЬТЕ ВНИМАТЕЛЬНЫ!!! РЕДАКТИРУЙТЕ ТОЛЬКО, ЕСЛИ ЗНАЕТЕ ЧТО ДЕЛАЕТЕ!!!"
 N pin,N,IMG S pin="^[""%SYS""]BSC4.ISS",N="AppAccess"
  Q $$PAframe^%ZAPM.bs.BSCm()
AUTO(BSLOGIN,A) i '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Aa") q "turn off"
 I '$G(A) N (BSLOGIN)
 D VAR^%ZAPM.bs.BSCh,SENDAUTO,RECVAUTO
 Q "SendDocs="_+$G(SendDocs)_", Receive="_+$G(KOLDOC)_" files,"_+$G(KOLDOC1)_" documents."
SINX1 D BEG1^%ZAPM.bs.BSC4
 I $D(sAUTO) W "АВТОМАТИЧЕСКАЯ РЕПЛИКАЦИЯ БАЗ ДАННЫХ МЕЖДУ СИСТЕМАМИ..." S A=$$AUTO(BSLOGIN,1) w BBK_BBK_A Q
 I $D(sSEND) D SEND
 I $D(sRESV) D RECV
 D BACKS,END^%ZAPM.bs.BSC4
 Q
RECV D VAR1
 D REC1
 Q
FTPGET   //ЧТО ПРИШЛО В ФТП
 N URI,MM,FIL,i,FILE,CDEV,%DEV
 S URI=$P($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aftpsinx"),"//",2,99) I URI="" q
 D FtpGD^%ZAPM.bs.BSCmail($P($P(URI,"@",2),":"),$P($P(URI,"@",1),":"),$P($P(URI,"@",1),":",2),$P($P(URI,"@",2),":",2),"\",.MM)
 W "<HR>"_GREEN_"Прием файлов с FTP:\\"_URI_EF
 I $G(ER)'=0 W RED_ER_EF G FTPEND
 S i="" F  S i=$O(MM(i)) Q:i=""  S FN=$P(MM(i)," ",$L(MM(i)," ")) D
 .I $$MY Q
 .S FIL(i)=FN
 //ПРИНЯТЬ ФАЙЛЫ ИЗ ФТП В RC
 D FtpGF^%ZAPM.bs.BSCmail($P($P(URI,"@",2),":"),$P($P(URI,"@",1),":"),$P($P(URI,"@",1),":",2),$P($P(URI,"@",2),":",2),.FIL,.FILE)
 W BBK_"<TEXTAREA cols=85 rows=4 >" I $O(FILE(""))="" W "ничего нет"
 S i="" F  S i=$O(FILE(i)) Q:i=""  S FN=$TR(RC,"/","\")_"\"_$P(i,"\",$L(i,"\")) W FN_" - приняли из FTP " D
 .S CDEV=$I I '$$OpenFile^%ZAPM.bs.BSCF1(FN,"W") Q
 .U %DEV S I="" F  S I=$O(FILE(i,I)) Q:I=""  W FILE(i,I)
 .U CDEV W "и скопировали"_BK
 .C %DEV
 W "</TEXTAREA>"
FTPEND w BBK Q
REC1 W "<BODY>"_BK
 D FTPGET
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="REC2^~BSCm1" D ADDBSPOST^%ZAPM.bs.BSC4reg
 N in,U1,MAS,FN,i
 S MAS="in" D FileListDir^%ZAPM.bs.BSCEXE(RC,MAS,2,"rar") ;xml")   W "<hr>" 
 S U1="",i=0 F  S U1=$O(@MAS@(U1)) Q:U1=""  D
 .S FN=$P(@MAS@(U1),"?",1) I $$MY Q
 .S i=i+1
 .W "<div title='Файл прислан из Системы:"_$P($P(FN,"\",$L(FN,"\")),"_")_" ДатаСоздания:"_$P($P(FN,"\",$L(FN,"\")),"_",2)_" ВремяСоздания:"_$P($P($P(FN,"\",$L(FN,"\")),"_",3),".")_" '>"_"<input type=checkbox title='пометить файлы для закачки' name=File"_U1_" value=''>"
 .W $P(FN,"\",$L(FN,"\"))_" (размер "_$P(@MAS@(U1),"?",3)_" байт) "
 .;I $D(@BPO@(FN)) W "<input type=checkbox title='переместить файлы в архив' name=Del"_U1_" value=''>"
 .W "</div>"
 .W BBK
 W "<hr>" 
 I i>0 D
 .I i>1 W "<input type=checkbox title='закачать все файлы' name=FileALL value=''> Все файлы обработать<hr>" 
 .W "<input type=SUBMIT title='закачать данные в буфер предварительной обработки' name=LISTREST value='ПОСМОТРЕТЬ ДАННЫЕ'>"
 .W "<input type=SUBMIT title='произвести репликацию данных' name=REST value='ВВЕСТИ ДАННЫЕ'>"
 E  W "файлов для ввода нет"
 Q
LI(F,S) W "<LI>"_AF_F_" - "_S_EF_"</LI>"
 Q
MY() N F S F=$ZCONVERT($P(FN,"\",$L(FN,"\")),"L") I $P(F,"_")=$ZCONVERT(CS,"L") D LI(FN,"СВОИ ФАЙЛЫ НЕЛЬЗЯ ВВОДИТЬ") Q 1
 I $D(@BPO@(F)) D LI(FN,"УЖЕ ВВОДИЛИ") Q 1
 I '$D(@BDAL@($P(F,"_"))) D LI(FN,"ИЗ ЭТОЙ СИСТЕМЫ ДАННЫЕ НЕ РЕПЛИЦИРУЮТСЯ") Q 1
 Q 0
REC2 i '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Ac") W BBK_BBK_"Receive turn off" q
 D BEG1^%ZAPM.bs.BSC4
 D VAR1,VAR3   W "<h3>ПРИЕМ ДАННЫХ</h3>"
 N in,U1,MAS
 S MAS="in",KOLDOC=0,KOLDOC1=0  D FileListDir^%ZAPM.bs.BSCEXE(RC,MAS,2,"rar") ;"xml")
 S U1="" F i=1:1 S U1=$O(@MAS@(U1)) Q:U1=""  D
 .S FN=$P(@MAS@(U1),"?",1) I $$MY Q
 .I $D(FileALL)!($D(@("File"_U1))) D REC3($$FNC($P(@MAS@(U1),"?",1)))
 W "<HR> Всего "_RED_$G(KOLDOC,0)_EF_" файл(а,ов)"      
 W "<HR> Всего "_RED_$G(KOLDOC1,0)_EF_" документ(а,ов)"      
 W "<hr>" 
 D BACKS,END^%ZAPM.bs.BSC4
 Q
REC3(FN) I $G(SAY)="" W "<hr><STRONG>"_FN_"</STRONG>"_BBK
 S RAR=$$FNC(Dtmp_"\"_$TR($P($ztimestamp,",",2),".","")_"\") ;ВРЕМЕННАЯ ДИРЕКТОРИЯ
 ;D exec^%ZAPM.bs.BSCEXE(COMM_" "_Dbin_"\merge.exe /s "_FN_" "_RAR,0)
 ;n x,i,xx,ii
 ;s x="",xx=$$GetFileC^%ZAPM.bs.BSCEXE(RAR_"x",.x)
 ;s i="" f ii=1:1 s i=$o(x(i)) q:i=""  S @BPO@(FN2,ii)=x(i)
 ;D del^%ZAPM.bs.BSCEXE(RAR_"x")
 D exec^%ZAPM.bs.BSCEXE(COMM_" "_Dbin_"\WINrar x "_FN_" "_RAR,0) ;РАСПАКОВКА АРХИВА
 N in,U1,MAS,i,FN1,FN2
 S MAS="in",KOLDOC1=0,FN2=$ZCONVERT($P(FN,"\",$L(FN,"\")),"L")
 D FileListDir^%ZAPM.bs.BSCEXE(RAR,MAS,2) ;СМОТРИМ ЧТО ПРИШЛО В АРХИВЕ
 S U1="" F i=1:1 S U1=$O(@MAS@(U1)) Q:U1=""  D
 .S FN1=$P(@MAS@(U1),"?",1) ;W FN_BBK
 .I $P(FN1,".",$L(FN1,"."))="rgr" D  //восстановление массивов в БПО 
 ..D RESTROU(FN1)  //ПРОГРАММЫ ВОССТАНОВИТЬ
 ..K @MASS D RestGlo^tempBS,DelRou^tempBS,DEL1^%ZAPM.bs.BSC4r4("tempBS.*")
 ..Q:$O(@MASS@(""))=""   K @BPO@(FN2,"rgr") M @BPO@(FN2,"rgr")=@MASS K @MASS
 ..D RESTGLO($NA(@BPO@(FN2,"rgr")),0) //1-эмуляция
 .I $P(FN1,".",$L(FN1,"."))="rr" D RESTROU(FN1,$NA(@BPO@(FN2,FN1))) //ПРОГРАММЫ ЗАПИСАТЬ В БПО
 I $D(REST) I $ZU(140,6,FN,Darhiv_"\"_$P(FN,"\",$L(FN,"\"))) ;ПЕРЕМЕСТИТЬ ФАЙЛ FN В АРХИВ
 D exec^%ZAPM.bs.BSCEXE(COMM_" rd /S /Q "_RAR,0) ;I $ZU(140,10,RAR) ;УДАЛИТЬ КАТАЛОГ RAR   //I $ZU(140,5,FN1) ;УБИТЬ ОТРАБОТАННЫЙ ФАЙЛ
 I '$D(REST) K @BPO@(FN2) ;БУФЕР ЧИСТИМ
 E  S @BPO@(FN2)=KOLDOC1
 S KOLDOC=KOLDOC+1
 Q
RESTGLO(BP,EMU) //ВООССТАНОВИТЬ АВТОМАТОМ ВСЕ УЗЛЫ ИЗ БПО
 N I1,I2,I3,I4,NSO,TMP
 i $G(SAY)="" W "<HR>"
 S I1="",NSO=$ZU(5) F  S I1=$O(@BP@(I1)) Q:I1=""  D
 .I I1="%%FILE" S I2="" F  S I2=$O(@BP@(I1,I2)) Q:I2=""  S I3="" F  S I3=$O(@BP@(I1,I2,I3)) Q:I3=""  D
 ..I $D(EMU) D EMU("COPYFILE",I3) Q:$G(EMU)
 ..D COPYFILE(RAR_$P(I3,":\",2,999),I3) //КУДА ПОЛОЖИТЬ ФАЙЛЫ И ДЛЯ КАКИХ ТАБЛИЦ? А если диск не N:....!!!!!!
 .i $G(SAY)="" W "<HR>"
 .I $$ZU^%ZAPM.bs.BS3(I1)="" Q  //переход в другой нс 
 .S I2="" F  S I2=$O(@BP@(I1,I2)) Q:I2=""  S I3="" F  S I3=$O(@BP@(I1,I2,I3)) Q:I3=""  S I4="" F  S I4=$O(@BP@(I1,I2,I3,I4)) Q:I4=""  D
 ..I $$Rules(0,CS,I1,I4) Q
 ..i $G(SAY)="" W "<LI>"_I3_" "_I4_"</LI>"
 ..I $D(REST) D
 ...I I3="K" D
 ....I $D(EMU) D EMU("Kill",I4) Q:$G(EMU)
 ....K @I4
 ...I I3="S" D
 ....I $D(EMU) D EMU("Set",I4) Q:$G(EMU)
 ....K @I4 M @I4=@BP@(I1,I2,I3,I4)
 ..S KOLDOC1=$G(KOLDOC1)+1
 I $ZU(5,NSO) //возврат нс 
 Q
Rules(n,sy,ns,GREF) N A,STOP S A="" F  S A=$O(@Rules@(n,A)) Q:A=""  I sy=$G(@Rules@(n,A,"sy"))!(^("sy")="*") I ns=$G(@Rules@(n,A,"ns")),@$G(@Rules@(n,A,"glref")) S STOP=0 Q
 Q $G(STOP,1)
EMU(S,G) W GREEN_" "_S_" "_EF_G_"<LI>" W:$G(EMU) BLUE_"эмуляция "_EF
 Q
COPYFILE(F1,F2)
 N DIR S DIR=$P(F2,"\",1,$L(F2,"\")-1) 
 I $D(REST) D
 .I $ZU(140,4,DIR)'=0 I $ZU(140,9,DIR) ;D exec^%ZAPM.bs.BSCEXE(COMM_" md "_DIR,0) //СОЗДАЕМ ТОЛЬКО ПОСЛЕДНЮЮ ДИРЕКТОРИЮ, А ЕСЛИ НАДО ВСЕ!!!!
 .I $ZU(140,6,F1,F2)
 .;D exec^%ZAPM.bs.BSCEXE(COMM_" copy "_F1_" "_F2_" /Y",0) //ЭТО ПЛОХО РАБОТАЕТ - ТОЛЬКО ДЛЯ ЛАТИНИЦЫ
 i $G(SAY)="" D
 .I '$D(REST)  W "<li>"_RED_F2_EF_" должен быть скопирован"_BK_"</li>" Q
 .I $ZU(140,4,F2)=0 W "<li>"_RED_F2_EF_" скопирован"_BK_"</li>" Q
 Q
RECVAUTO S FileALL=7,SAY=1,REST=1 D FTPGET
 G REC2
RESTROU(FN,BPO) I $d(BBK) W RED_FN_EF_BBK
 n x,i,xx,ii,STR,S,SS
 s x="",xx=$$GetFileC^%ZAPM.bs.BSCEXE(FN,.x),S=0 K STR
 s i="" f ii=1:1 s i=$o(x(i)) q:i=""  D
 .I ii<3 Q  W x(i),!,$G(BBK) Q  //ВЫВОД ЗАГОЛОВКА ФАЙЛА
 .i x(i)="" q
 .I $$RESTLABEL(x(i)) Q
 .S S=S+1,STR(S)=x(i)
 I $$RESTLABEL("zerrO^INT")
 Q
RESTLABEL(X) //РАЗДЕЛЕНИЕ ПОТОКА КОДА НА ПРОГРАММЫ И ВОССТАНОВЛЕНИЕ ИХ
 I X[" "!(X'["^")!(X[";") Q 0
 I $D(STR) S STR(0)=S S NR=$P(SS,"^",1)_"."_$P(SS,"^",2) D
 .i $D(BPO) M @BPO@(NR)=STR I '$D(REST) Q
 .I $G(SAY)="",$D(BPO) W "<li>"_GREEN_NR_EF_"</li>" 
 .D ROUTINE^%R(NR,.STR,.err,"CS",0) I $G(err) ZW err
 S S=0,SS=X K STR
 Q 1
VAR S BDPR=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""Protokol"")") ;ПРОТОКОЛ ДАТ ВЫВОДА
 S KOLout=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","KOLout") ;КОЛИЧЕСТВО ПОСЛЕДНИХ ДАТ ВЫВОДА ВЫВОДИТЬ В СПИСКЕ
 S ArrOUT=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")") ;ПРОТОКОЛ ССЫЛОК ПРИСВОЕННЫХ И УДАЛЕННЫХ УЗЛОВ ДАННЫХ И ПРОГРАММ
 S GRANT=$$GetVar^%ZAPM.bs.BSC4("GRANT","DFLT")
 Q
VAR1 S BDAL=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""AllSys"")")
 S CS=$ZCONVERT($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Asys"),"L") ;ИМЯ ТЕКУЩЕЙ СИСТЕМЫ
 S BPO=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""BPO"")")
 S Rules=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""Rules"")")
 S DS=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","SEND")
 ;S POOL=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Rpool") ;FTP каталог
 S RC=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","RESV")
 S Dbin=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bBIN")
 S Darhiv=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Rarhiv")
 S Dtmp=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","RTmp")
 Q
VAR3 S COMM=$S($ZU(100):"COMMAND.COM",1:"CMD /C")
 S MASS="^%tempSNX"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCm3" type="MAC" languagemode="0"><![CDATA[
%BSCm3 ;МОДУЛЬ UFD (ЗАГОТОВКА ДЛЯ ПРОГРАММ БЕЗ ПОДДЕРЖАНИЯ СЕССИИ)
 ;
 ;    Copyright (C) Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
T //MAIN //W V1," ",V2
 D VAR
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="Act^~BSCm3"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 //W "<form name='EE1'><input type='hidden' name='k0' value=''>"_BK
 W 1,CurNode,2
 W "<table>"
 W "<tr><td><INPUT name=b1u1 title='на первый ключ' TYPE='submit' VALUE='&lt;&lt;' >"_BK
 W "<INPUT name=b2u1 title='на предыдущий ключ' TYPE='submit' VALUE='&lt;' ></td>"_BK
 //W "<INPUT title='Поле текущего ключа' name='k1' TYPE='text' SIZE=10 VALUE='' >"_BK
 w "<td><select name='Act0' size=1>"_BK
 F ind=1:1:100 S GLO=$$O(GLO,KY,1) Q:GLO=""  Q:$QL(GLO)="0"  W "<option value='"_ind_"' " D  W ">"_GLO_"</option>"_BK
 .I CurNode="",ind=1 S CurNode=GLO
 .I GLO=CurNode W "selected "
 I ind=100,GLO'="" W "<option value=''>...дальше</option>"_BK
 w "</select></td>"_BK
 W "<td><INPUT name=b3u1 title='на последущий ключ' TYPE='submit' VALUE='&gt;' >"_BK
 W "<INPUT name=b4u1 title='на последний ключ' TYPE='submit' VALUE='&gt;&gt;'></td>"_BK
 W "<td><INPUT name=b5u1 title='сохранить' TYPE='submit' VALUE='save' ><td>"_BK
 W "<td><INPUT name=b6u1 title='вставить' TYPE='submit' VALUE='new insert' ><td>"_BK
 W "<td><INPUT name=b7u1 title='удалить ключ' TYPE='submit' VALUE='delete' ><td>"_BK
 W "</tr></table>"
 W "</form>"_BK
 I $$SetVar^%ZAPM.bs.BSC4(BSwinID_"QQ",QQ)
 I $$SetVar^%ZAPM.bs.BSC4(BSwinID_"GGG",GGG)
 D SetVar^%ZAPM.bs.BSC4(BSwinID_"CurNode",CurNode)
 D END^%ZAPM.bs.BSC4
 Q
Act W 111
 Q       
 /*
 W "<PRE>"
 ZW  W " ",KY
 W "</PRE>"
 */
 
VAR //ПЕРЕМЕННЫЕ КОМПЛЕКСА
 S BStyle="MONITOR"
 W "<HTML><HEAD>"_BK_$$STYLE^%ZAPM.bs.BSC4
 S PT=$NA(@("^"_V1)@(V2))
 S BSwinID=$G(V3,"w123")
 W "<TITLE>"_PT_"</TITLE>"_BK
 M BD=@PT@("KEY")
 S KY=$O(BD(""),-1)
 S GLO=BD
 //GGG,QQ - СКВОЗНЫЕ ПЕРЕМЕННЫЕ
 S QQ=$$GetVar^%ZAPM.bs.BSC4(BSwinID_"QQ",$C(0))
 S GGG=$$GetVar^%ZAPM.bs.BSC4(BSwinID_"GGG","")
 S CurNode=$$GetVar^%ZAPM.bs.BSC4(BSwinID_"CurNode","")
 Q       
O(G,K,N) //$ORDER 
 N GG S GG=G
 S KK=$C(0)
 I G'["(",N=-1 S GG=$ZO(@(G_"("""")"),-1) I $$C Q $$Q
 F  S GG=$ZO(@GG,N) Q:GG=""  I $$C Q
 Q $$Q
C() //КОНТРОЛЬ
 I $QL(GG)>K Q 0
 I GG[KK Q 0
 S KK=$P(GG,",",1,K)
 I $P(GG,",",1,K)["(" S GGG=$S(GG'[")":$P(GG,",",1,K)_")",1:GG)
 E  S GGG=""
 Q 1
Q() I QQ=GGG Q ""
 S QQ=GGG
 Q GGG
]]></Routine>


<Routine name="%ZAPM.bs.BSCm4" type="MAC" languagemode="0"><![CDATA[
%BSCm4 ;МОДУЛЬ UFD
 ;
 ;    Copyright (C) Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
VAR3 N I
 I BSNODE="" S CurNode=$$O(GLO,KY,BSNAPR),BSNODE=$$Ke(CurNode) Q
 I BSNODE'="" S CurNode=BD F I=1:1 Q:$P(BSNODE,",",I,I+1)=""  S CurNode=$NA(@CurNode@($P(BSNODE,",",I)))
 Q
T N BSNOREG,BSGRANT
 I '$$VAR Q
 s BSNAPR=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"Napr"),(STEP1,STEP2)=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"NaprStep")
 S:'STEP1 (STEP1,STEP2)=5 S BSNAPR=$S(BSNAPR:1,1:-1)
TT I '$$VAR Q
 S KL=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"NaprKL") I KL="" S KL=14
 i $G(BSList)=1 G List0^%ZAPM.bs.BSCm41
 i $G(BSList)=2 W $$B27
 I $G(BSgMODE)="NEW" S bMODE=4,BSgMODE="NEW1" G Act
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name='first1'>"
 N BSNamF,BSnf
 S BSLABEL="Act^~BSCm4"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<INPUT name=bMODE TYPE='hidden' VALUE='0'>"
 D VAR3
 S DISABLE=0 I $$O(CurNode,KY,-BSNAPR)="" S DISABLE=1
 S Q="<table width=100%><tr><td CLASS=s5 ><table><tr>"
 //S Q=Q_"<td> <INPUT name=bSAV title='сохранить текущую коррекию' TYPE='submit' VALUE=''>"_BK
 //S Q=Q_"<BUTTON onclick='bMODE.value=1; submit();' title='сохранить текущую коррекию' VALUE='сохранить' ><IMG SRC='"_BSDOMAIN_"/img/save.gif'></BUTTON><td>"_BK
 S Q=Q_"<td>"
 S Q=Q_"<BUTTON onclick='bMODE.value=1;' title='сохранить текущую коррекию' TYPE='submit' VALUE='сохранить' ><IMG SRC='"_BSDOMAIN_"/img/save.gif'></BUTTON><td>"_BK
 S Q=Q_"<td><BUTTON onclick='reset();' title='отменить текущее изменение'><IMG SRC='"_BSDOMAIN_"/img/undo.gif' ></BUTTON><td>"_BK
 i $G(BSList)'=2 D 
 .S Q=Q_"<td><INPUT name=b1u1 title='на первую запись' TYPE='submit' VALUE='&lt;&lt;&lt;' "_$S($G(DISABLE)=1:"DISABLED",1:"")_" ></TD>"_BK
 .;S Q=Q_"<TD CLASS=s1><INPUT name=Au1 title='на шаг ...' TYPE='submit' VALUE='&lt;&lt;' "_$S($G(DISABLE)=1:"DISABLED",1:"")_" >"_BK
 .;S Q=Q_"<INPUT name=STEP1 title='шаг' size=3 maxlength=3 TYPE='TEXT' VALUE='"_$G(STEP1)_"'></TD>"_BK
 .S Q=Q_"<TD><INPUT name=b2u1 title='на предидущую запись' TYPE='submit' VALUE='&lt;' "_$S($G(DISABLE)=1:"DISABLED",1:"")_" ></td>"_BK
 .S BSLABEL="SETKEY^~BSCm4"
 .S Q=Q_"<td><select name=MODE1 size=1 onclick=""javascript: { if (''!=MODE1.value & ('"_BSNODE_"'!=MODE1.value)) parent.location='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&STEP1="_$G(STEP1)_"&STEP2="_$G(STEP2)_"&BSNODE='+MODE1.value; } "" >"_BK
 .S GLO=CurNode F ind=1:1:KL S GLO=$$O(GLO,KY,-BSNAPR) Q:GLO=""  S GLO1=$$Ke(GLO) S KL(ind)="<option value='"_GLO1_"' >"_GLO1_"</option>"_BK
 .I ind=KL,GLO'="" S KL(ind+1)="<option value='"_GLO1_"'>...дальше</option>"_BK
 .S ind="" F  S ind=$O(KL(ind),-1) Q:ind=""  S Q=Q_KL(ind)
 .S Q=Q_"<option value='"_BSNODE_"' SELECTED >"_BSNODE_"</option>"_BK
 .S GLO=CurNode F ind=1:1:KL S GLO=$$O(GLO,KY,BSNAPR) Q:GLO=""  S GLO1=$$Ke(GLO) S Q=Q_"<option value='"_GLO1_"'>"_GLO1_"</option>"_BK
 .I ind=KL,GLO'="" S Q=Q_"<option value='"_GLO1_"'>...дальше</option>"_BK
 .S Q=Q_"</select></td>"_BK
 .I $$O(CurNode,KY,BSNAPR)="" S DISABLE=2
 .S Q=Q_"<td><INPUT name=b3u1 title='на последущую запись' TYPE='submit' VALUE='&gt;' "_$S($G(DISABLE)=2:"DISABLED",1:"")_" ></td>"_BK
 .;S Q=Q_"<td class=s1><INPUT name=STEP2 title='шаг' size=3 maxlength=3 TYPE='TEXT' VALUE='"_$G(STEP2)_"'>"_BK
 .;S Q=Q_"<INPUT name=Au2 title='на шаг ...' TYPE='submit' VALUE='&gt;&gt;' "_$S($G(DISABLE)=2:"DISABLED",1:"")_" ></td>"_BK
 .S Q=Q_"<td><INPUT name=b4u1 title='на последнюю запись' TYPE='submit' VALUE='&gt;&gt;&gt;' "_$S($G(DISABLE)=2:"DISABLED",1:"")_" ></td>"_BK
 .n BSLABEL S BSLABEL="FIND^~BSCm4"
 .S Q=Q_"<td><BUTTON title='искать запись по ключевым атрибутам' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_BSPARENT_"find"",""toolbar=no,menubar=no,scrollbars=no,width=500,height=200,status=1,resizable=1"");'><IMG SRC='"_BSDOMAIN_"/img/find.gif'></<BUTTON><td>"_BK
 S Q=Q_"<td><BUTTON onclick='bMODE.value=4; submit();' title='вставить новую запись'><IMG SRC='"_BSDOMAIN_"/img/new.gif'></<BUTTON><td>"_BK
 S Q=Q_"<td>&nbsp;&nbsp;&nbsp;&nbsp;</td>"
 I $G(BSgMODE)'["NEW" S Q=Q_"<td><BUTTON onclick='bMODE.value=2; submit();' title='удалить текущую запись'><IMG SRC='"_BSDOMAIN_"/img/kill.gif'></<BUTTON><td>"_BK
 S Q=Q_"</tr></table></td></tr></table>"_BK
 S Q=Q_"<table>"_BK W Q
TTT N var1,Tab,%ZName,xClass,RO,TIT
 //K @BDSES@(BSSES,"VAR",PT,"CARD")
 s Maxfeild=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Count",1) //количество полей
 s MaxIndxfeild=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Index",1) //количество индексированных полей
 f ny=1:1:Maxfeild D  I MaxIndxfeild=ny,BSLABEL["FIND1" G TTTT
 .N TRANS,dflt
 .s var1=$$GetField^%ZAPM.bs.BSC4rou(P,T,ny,1) //взять все атрибуты текущего поля
 .s nf=$P(var1,"~",1) //вычленить имя поля
 .s Description=$P(var1,"~",2) //вычленить описание поля
 .i Description["|" s dflt=$p(Description,"|",2),Description=$p(Description,"|")
 .S xClass="s1" i MaxIndxfeild'<ny S xClass="s2"
 .S TIT="",RO=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"xRO") I RO S TIT="(Только для чтения)"
 .w "<tr><td align='right' CLASS="_xClass_" title='"_$$ip_"'><strong>" //вывести начало строки таблицы
 .i MaxIndxfeild'<ny w "<FONT COLOR=RED> * </FONT>" //вывести красную звездочку если поле индексированное
 .w Description,"</strong></td>"
 .S xNAME="X"_$P(var1,"~",5) I '$D(xxNAME) D
 ..I $G(BSnFOCUS)="" S xxNAME=xNAME Q
 ..I $G(BSnFOCUS)=nf S xxNAME=xNAME
 .s Ta=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"tA") I Ta="" S Ta="cols=32 rows=5"
 .s Tt=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"tT") I Tt="" S Tt="size=40 maxlength=32000"
 .W "<td CLASS="_xClass_">" //------------------------------------------
 .S (d,d1,d0)=$$CELL() I d="" S d0=0 //ТЕКУЩИЕ ДАННЫЕ ПОЛЯ
 .S fTRN=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"fTRN") I fTRN'="" D fTRN(fTRN) //ФУНКЦИЯ ТРАНСФОРМАЦИЯ
 .//I Tmp'="" S @BDSES@(BSSES,"VAR",PT,"CARD",nf)=Tmp //ЗАПИСАТЬ В БУФЕР
 .i $P(var1,"~",3)=1 D  G TTE
 ..D RO(1)
d .//ДАТЫ
 .i $P(var1,"~",3)=4 D  G TTE //дата
 ..D RO(0)
 ..I BSLABEL["FIND1",MaxIndxfeild'<ny Q
 ..S BS1=BSG,BS2="DATE^~BSCm4",BS3=nf,BS4=$S(MaxIndxfeild'<ny:ny,1:0)
 ..W $$B^%ZAPM.bs.BSC4cal(d,"Загрузить календарь",BSPARENT_"cal","EDITDATE^~BSC4cal")
 .//ПАРАМЕТРЫ
p .i $P(var1,"~",3)=7 D  G TTE
 ..D RO(0,BK_BK_"данные поля параметра не должны быть пустыми")
 ..I BSLABEL["FIND1",MaxIndxfeild'<ny Q
 ..Q:CurNode=""  N SH,SH1
 ..S BS1=BSG,BS2="PARA^~BSCm4",BS3=nf,BS4=$S(MaxIndxfeild'<ny:ny,1:0)
 ..S SH=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"pSH") I SH="" S SH="^UNDEFINED"
 ..S SH1=$NA(@CurNode@(nf))
 ..W $$BP^%ZAPM.bs.BSC4cfgP("ПАРАМЕТРЫ "_BS3,"Редактировать параметры",SH,SH1,1)
 ..S d1="<A title='шаблон параметра"_BK_BK_"данные поля параметра не должны быть пустыми'>"_SH_"</a>"
 .//ФАЙЛЫ
f .i $P(var1,"~",3)=6 D  G TTE //файлы
 ..d RO(0)
 ..I BSLABEL["FIND1",MaxIndxfeild'<ny Q
 ..N BSS4,BSS8,BSS3,BSS1,x,FN1,FN2
 ..S BSLABEL="FILE^~BSCm4" D TmmP1
 ..I $ZU(140,7,Tmp1)<0 W "<A title='ошибка ! директории не существует :"_Tmp1_" '>!!!!</A>" Q
 ..S BS1=$TR(##class(%File).NormalizeDirectory(Tmp1)_$$ZCRC(PT_BSNODE_nf),":\","^~")
 ..S BS2=nf,BSS3=BSSES,BS3=MGWLIB,BSS8=$$BSADDVAR^%ZAPM.bs.BSC4(),BSS4=x
 ..W "<BUTTON title='прикрепить файл' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_BSPARENT_"file"",""toolbar=no,menubar=no,scrollbars=yes,width=500,height=200,status=1,resizable=1"");'><IMG SRC='"_BSDOMAIN_"/img/open.gif'></<BUTTON>"_BK
 ..I d'="" D  //Графика
 ...N GR,EX,BSGR1,BSLABEL,BS1,BS2,BS3,BS4,BSS4,BSS8,FN,TI
 ...D TmmP2
 ...S d1="<A target='showpic' "_BSGR1_" title='"_TI_"'><IMG border=0 "_IMG_" SRC='"_GR_"' ></A>"
 ...N BSGR1,BSNFLD S BSLABEL="DELFILE^~BSCm4",BSNFLD=nf,d1=d1_"<A target='showpic' href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' title='Удалить файл'><IMG border=0 "_IMG_" SRC='"_BSDOMAIN_"/img/del.gif'></A>"
k .i $P(var1,"~",3)=8 D  G TTE //Кодификаторы
 ..D RO(0)
 ..I BSLABEL["FIND1",MaxIndxfeild'<ny Q
 ..N Tmp1,GL1,GL2,GL,BSKO,BSGL,BSKOD,BSKO,BS3,BS4,res
 ..S BSLABEL="KOD^~BSCm4",(BSKO,GL,GL1,GL2,GL3)="",BS3=nf,BS4=$S(MaxIndxfeild'<ny:ny,1:0)
 ..S GL1=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"kS") I GL1'="" S GL=GL1,BSKO=1
 ..I $G(GL)="" S GL2=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"kD") I GL2'="" S GL=$P(PT,".")_"."_$P(GL2,".",1,2),BSKO=$P(GL2,".",3)
 ..I $G(GL)="" S GL3=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"kSQL") I GL3'="" D
 ...S BSKO=2,GL=$NA(@GTmp@(BSSES,"SQL",nf))
 ...I '$D(@GL) S res=$$SetSQL(GL,GL3,$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"kSQLns")) I 'res S ErrSave(xNAME)=res
 ..I $G(GL)=""  W "<A title='ошибка ! не определен словарь данных'>!!!!</A>" Q
 ..I '$$Data^%ZAPM.bs.BSF12(GL) W "<A title='Нет доступа к словарю данных `"_GL_"`'>!!!!</A>" Q
 ..S BSGL=$$%T^%ZAPM.bs.BSCh(GL),BSKOD=$$%T^%ZAPM.bs.BSCh(d),BSKO=$$%T^%ZAPM.bs.BSCh(BSKO)
 ..W "<BUTTON title='выбрать код из словаря данных' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_"&WEB=AAA#"_d_""","""_BSPARENT_"kod"",""toolbar=no,menubar=no,scrollbars=yes,width=500,height=600,status=1,resizable=1"");'><IMG SRC='"_BSDOMAIN_"/img/list.gif'></<BUTTON>"_BK
 ..I d'="" D
 ...I GL1'=""!(GL3'="") S d1=$G(@GL@(d),"код не определен")
 ...E  S d1=$G(@GL@(d,$P(GL2,".",3)),"код отсутствует")
 ...S d1="<A title='расшифровка кода'>"_d1_"</a>"
t .;простой показатель
 .D RO(0)
TTE .I d1=d S d1=""
 .W "</td><td class=s3>"_$G(d1)_BK 
 .i $d(ErrSave(xNAME)) W "</td><td class=s3> Ошибка "_$G(ErrSave(xNAME))_BK
 .w "</td></tr>"_BK
 I ny>20 D  //ПОВТОРЯТЬ ЕСЛИ МНОГО ПОЛЕЙ
 .S Q=$$TR^%ZAPM.bs.BSsFUNM($G(Q),"Au1","Ax1"),Q=$$TR^%ZAPM.bs.BSsFUNM($G(Q),"STEP1","STEPx1")
 .S Q=$$TR^%ZAPM.bs.BSsFUNM($G(Q),"Au2","Ax2"),Q=$$TR^%ZAPM.bs.BSsFUNM($G(Q),"STEP2","STEPx2")
 .W $$TR^%ZAPM.bs.BSsFUNM($G(Q),"MODE1","MODE2")
 W "</form>"_BK
 i $g(xxNAME)'="" D
 .D JS^%ZAPM.bs.BSCp
 .w "first1."_xxNAME_".focus();"_BK
 .D JSE^%ZAPM.bs.BSCp
 D SETVAR
 D END^%ZAPM.bs.BSC4
TTTT Q
TmmP1 S FN1=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"DF"),FN2=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"xSubDir"),Tmp1=FN1_FN2 I Tmp1="" S Tmp1="Z:/!!!/"
 Q
TmmP2 S Tmp1=##class(%File).NormalizeDirectory(Tmp1)_d
 I $ZU(140,4,Tmp1)'=0 S GR=BSDOMAIN_"/ext/error.gif",BSGR1="",TI="ошибка доступа к файлу"
 E  S GR=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"WF")_FN2_d,BSGR1="href='"_GR_"'",TI="загрузить файл",EX=$ZCVT($P(GR,".",$L(GR,".")),"L") I EX'="","jpg*bmp*gif*png"'[EX S GR=BSDOMAIN_"/ext/"_EX_".gif"
 S IMG=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"xSubIMG") I IMG="" S IMG="width=25"
 Q
SetSQL(TG,SQ,NS) //Сформирвать кодификатор
 N result,hhh,%msg,KOD,END,ONS
 S ONS=$ZU(5) I NS'="" I $ZU(5,NS)
 s result=$$DynSQLprep^%ZAPM.bs.BSC4r(SQ,.hhh)
 if +result'=1 S END=$G(%msg,result) G SetEnd
 n col,allcol,row2,COL,x,row1,STOP,row3
 s x=$$DynSQLColInfo^%ZAPM.bs.BSC4r(.COL,.hhh)
  for  Q:$$DynSQLfetch^%ZAPM.bs.BSC4r(.hhh,.row1,.STOP)=1  s row2=$G(row2)+1  D
  .if '$D(allcol) s allcol=$LISTLENGTH(row1) //for col=1:1:allcol W "<td bgcolor=#E4E4E4>",$LI($LI(COL,col),1),"</td>"  //цикл по колонкам
  .//for col=1:1:allcol W "<td>",$LI(row1,col),"</td>"
  .S KOD=$LI(row1,1) I KOD'="" S @TG@(KOD)=$LI(row1,2),row3=$G(row3)+1
 S END=$G(row3,"no rows")
SetEnd  I $$DynSQLclose^%ZAPM.bs.BSC4r(.hhh)
 I $ZU(5,ONS)
 Q END
fTRN(fTRN) ;ВЫПОЛНЕНИЕ ФУНКЦИИ ВИЗУАЛИЗАЦИИ
 S $ZT="fErrTRAN^%ZAPM.bs.BSCm4"
 X "S d1="_fTRN
 Q
fErrTRAN S d1=$ZE_"..."_fTRN,$ZT=""
 Q
KOD I $$VAR("Словарь данных")
 W $$B27
 I $G(FNDTXT)'="" W "Словарь данных по контексту '"_$$KO(FNDTXT)_"'<HR>"
 S GL=$$%^%ZAPM.bs.BSCh(BSGL),KOD=$$%^%ZAPM.bs.BSCh(BSKOD),BSKO=$$%^%ZAPM.bs.BSCh(BSKO)
 I '$$Data^%ZAPM.bs.BSF12(GL) W "Нет доступа к словарю данных '"_GL_"'" Q
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name='first1'>"
 S BSLABEL="KODFIND^~BSCm4"
 D ADDBSPOST^%ZAPM.bs.BSC4reg W "<INPUT name=bMODE TYPE='hidden' VALUE='0'>"
 S k="" W "<table width=100%>"_BK
 S Q="<TR><TD CLASS=s3>КОДЫ</TD>"
 S Q=Q_"<TD CLASS=s3>ТЕКСТ<INPUT name=FNDTXT title='Контекст поиска по расшифровке' size=20 TYPE='TEXT' VALUE=''> "
 S Q=Q_"<BUTTON name=Find1 onclick='bMODE.value=1;' type='submit' title='искать' ><IMG SRC='"_BSDOMAIN_"/img/find.gif'></BUTTON>"
 I BSKO'=2 D
 .S Q=Q_"<BUTTON name=VKS1 onclick='bMODE.value=2;' type='submit' title='вставить временно-кодированную сущность'><IMG SRC='"_BSDOMAIN_"/img/new.gif'></BUTTON>"
 .S Q=Q_"<INPUT name=VKSTXT title='текст временно-кодированной сущности' size=20 TYPE='TEXT' VALUE=''>"
 S Q=Q_"</td></tr>"_BK
 W Q
 I BSKO F  S k=$O(@GL@(k)) Q:k=""  D KOD1(k,@GL@(k))
 I 'BSKO F  S k=$O(@GL@(k)) Q:k=""  I $G(@GL@(k,BSKO))'="" D KOD1(k,@GL@(k,BSKO))
 S Q=$$TR^%ZAPM.bs.BSsFUNM($G(Q),"FNDTXT","FNDTXT1"),Q=$$TR^%ZAPM.bs.BSsFUNM($G(Q),"VKSTXT","VKSTXT1")
 W Q
 W "</table></FORM>"
 D JS^%ZAPM.bs.BSCp
 I $D(LOC) W LOC
 S BSLABEL="KOD2^~BSCm4"
 w "function ch1(K) {",BK
 w "location='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&CHO='+ K;",BK
 W "}"_BK
 D JSE^%ZAPM.bs.BSCp
 D END^%ZAPM.bs.BSC4
 Q
RO(T,ti)    I RO w "<input type='hidden' name='"_xNAME_"' value='"_d_"' >"_BK I $G(xxNAME)=xNAME S xxNAME=""
 //wrap=soft | hard | off
 I $G(T) W "<textarea wrap=off "_Ta_" title='"_nf_TIT_$g(ti)_"' name='"_xNAME_"' "_$S(RO:"DISABLED",1:"")_" >"_d_"</textarea>"_BK
 E  w "<input type='text' "_Tt_" title='"_nf_TIT_$g(ti)_"' name='"_xNAME_"' value='"_d_"' "_$S(RO:"DISABLED",1:"")_" >"_BK
 Q
KOD1(K,T) I $G(FNDTXT)'="",(K_T'[FNDTXT) Q
 N T1
 S T1="<TD CLASS=s"_$S(K=KOD:1,1:2)_"><A title='"_$S(K=KOD:"текущий",1:"выбрать")_"' href='javascript:ch1("""_K_""")'"
 W "<tr>"_T1_" name='#"_K_"' >"_$$KO(K)_"</a></td>"
 W T1_" >"_$$KO(T)_"</A></TD></tr>"_BK
 Q
KO(S) I $G(FNDTXT)'="",S[FNDTXT Q $$TR^%ZAPM.bs.BSsFUNM(S,FNDTXT,"<font color=WHITE>"_FNDTXT_"</FONT>")
 Q S
KOD2 D VAR1,VAR2
 N D S D=$G(CHO) I D="" Q
 D SETPAR(PT,BSNODE,BS3,BS4,D)
 Q               
KODFIND 
 I $G(bMODE)=1 S:$G(FNDTXT)="" FNDTXT=$G(FNDTXT1) G KOD
 I $G(bMODE)=2 S:$G(VKSTXT)="" VKSTXT=$G(VKSTXT1) D VKSADD(VKSTXT) S LOC="location='#"_NK_"';"_BK,BSKOD=NK G KOD
 Q
VKSADD(VTXT)
 S GL=$$%^%ZAPM.bs.BSCh(BSGL),KOD=$$%^%ZAPM.bs.BSCh(BSKOD)
 S GVKS=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""VKS"")")
 S GVKS1="^%ZAPM.bs.BSC4SNX.VKSKOD" //СЧЕТЧИК КОДОВ ДЛЯ VKS
 I '$D(@GVKS1) S @GVKS1="10"
 D VAR1^%ZAPM.bs.BSCm1 ;CS
 S NK=CS_"-"_$I(@GVKS1)
 S @GVKS@(NK,"NDIC")=$$%^%ZAPM.bs.BSCh(BSGL),@GVKS@(NK,"NFIELD")=$$%^%ZAPM.bs.BSCh(BSKO)
 I BSKO=1 S @GL@(NK)=VTXT
 I BSKO'=1 S @GL@(NK,BSKO)=VTXT
 Q
DEL D CLEAR(CurNode,PT)
 K @CurNode D SNX^%ZAPM.bs.BSChT1("K",$zr,PT)
 w "Запись удалена"
 Q
CLEAR(CurNode,PT) ;почистить узлы, где есть файлы
 N FN1,Mf,ny,P,T,var1,FN2
 S FN1=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"DF") I FN1="" Q
 S P=$QS(PT,0),T=$QS(PT,1)
 s Mf=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Count",1) //количество полей
 F ny=1:1:Mf s var1=$$GetField^%ZAPM.bs.BSC4rou(P,T,ny,1) i $P(var1,"~",3)=6 D
 .S nf=$P(var1,"~",1),d=$G(@CurNode@(nf)) I d="" Q
 .I $G(BSNFLD)'="" I nf'=$G(BSNFLD) Q
 .S FN2=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"xSubDir"),Tmp1=FN1_FN2_d I $ZU(140,4,Tmp1)'=0 Q
 .W "Удален файл "_Tmp1_BBK I $ZU(140,5,Tmp1)
 Q
DELFILE //УДАЛИТЬ ПРИКРЕПЛЕННЫЙ ФАЙЛ
 D VAR1,VAR2,VAR3
 D CLEAR(CurNode,PT)
 D SETPAR(PT,BSNODE,BSNFLD,0,"")
 ;D JS^%ZAPM.bs.BSCp
 ;W "alert('"_CurNode_"');"_BK
 ;W "window.close();"_BK
 ;D JSE^%ZAPM.bs.BSCp
 Q
ZCRC(S) I '$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("ParmsCell",nf)),"xSubRN") Q ""
 S S=$ZCRC(S,7)
 Q S_$TR($J("",13-$L(S))," ","0")_"_"
FILE S BSS1=""
 S BSS6="FILE1^~BSCm4"
 D UP^%ZAPM.bs.BSC4r3
 Q
TKFILE1 
 M Mas=@GL K @GL
 D Arr2File^%ZAPM.bs.BSCEXE(.Mas,path)
 K bytes,by S BSNamF=$P(path,"\",$L(path,"\")),MGWLIB=BS3,BSnf=BS2
 D JS^%ZAPM.bs.BSCp
 D OPEN($S($G(FILERR):"ERRCOPY^~BSCm4",1:"DUMMY^~BSCm4"))
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 D PRE
 Q
FILE1 D VAR^%ZAPM.bs.BSCh        //КОПИРОВАТЬ ФАЙЛ НА ДИСК СЕРВЕРА
 N I,bytes,path,FILERR
 D BSPARVAR^%ZAPM.bs.BSC4(BSS4,BSS8)
 s path=$TR(BS1,"^~",":\")_$TR($P(FiNa,"\",$L(FiNa,"\")),"'","")
 i $G(%("HOST:"))'="" G TKFILE1
 s filestream=##class(%File).%New(path)
 s status=filestream.Open("WN")
 I 'status G FILERR
 F I=0:30000:by D
 .S bytes=%request.GetMimeData("FileStream").Read(30000)
 .s status=filestream.Write(bytes)
 s status=filestream.%Close()
 I 'status G FILERR
FILE2 K bytes,by S BSNamF=$P(path,"\",$L(path,"\")),MGWLIB=BS3,BSnf=BS2
 D JS^%ZAPM.bs.BSCp
 D OPEN($S($G(FILERR):"ERRCOPY^~BSCm4",1:"DUMMY^~BSCm4"))
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 D PRE
 Q
OPEN(BSLABEL)
 W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""",""DUMMY"",""toolbar=no,menubar=no,scrollbars=no,width=300,height=100,status=1,resizable=1"");"_BK
 Q
Status(S) Q "window.defaultStatus = '"_S_"'"_BK   
B27(PA) Q "<BODY "_$$27_">"_BK_$$js^%ZAPM.bs.BSCp_$$Status("{Esc} - отмена, закрыть окно. {F5} - обновить окно")_$$jse^%ZAPM.bs.BSCp_BK
27() Q " onkeyPress='javascript: if (27 == event.keyCode) "_$G(PA)_"window.close();' "
ERRCOPY D ERR("Ошибка копирования файла") Q
ERR(S) D SAY1("ERROR",S),SAY2("OK") Q
SAY1(T,S) D BEG1^%ZAPM.bs.BSC4 W "<TITLE>"_T_"</TITLE>"_$$B27_"<CENTER>"_RED_"<BR><H3>"_S_"</H3>"_EF Q
SAY2(S) W "<BUTTON onclick='window.close();'>&nbsp;&nbsp;&nbsp;"_S_"&nbsp;&nbsp;&nbsp;</BUTTON><CENTER>"_BK  D END^%ZAPM.bs.BSC4 Q
DUMMY N BS1,BS2,BS3,BS4,BSS1,BSS2,BSS3,BSS4,BSS5,BSS6,BSS6,BSS7,BSS8,BSS9
 D VAR1,VAR2
 D SETPAR(PT,BSNODE,BSnf,0,BSNamF)
 Q
FILERR S FILERR=1 G FILE2
ip() I MaxIndxfeild<ny Q ""
 Q " обязательный (индексированный) показатель"  
CELL() //ДАННЫЕ КЛЕТКИ
 S $ZT="ERRCELL"
 I $D(@("BSocx"_nf)) q $G(@("BSocx"_nf)) //имя переменной совпадает с именем поля
 I MaxIndxfeild'<ny Q $P(BSNODE,",",ny)
 I CurNode=""!(nf="") Q ""
 Q $G(@CurNode@(nf),$g(dflt))
ERRCELL Q ""
Act D VAR1,VAR2 I $$VAR4
 F K=1:1:KY I $P(BSNODE,",",K)'=$G(%KEY("X"_K)) S $P(BSNODE,",",K)=$G(%KEY("X"_K))
 D VAR3
 I $D(Au1) D STEP(-BSNAPR,STEP1) I CurNode="" K Au1 S b1u1=1
 I $D(Ax1) D STEP(-BSNAPR,STEPx1) I CurNode="" K Ax1 S b1u1=1
 I $D(b1u1) S CurNode=$$O(BD,KY,BSNAPR) D Act1
 I $D(b2u1) S CurNode=$$O(CurNode,KY,-BSNAPR) D Act1
 I BSNODE'="",$G(bMODE)=2 D DEL K bDEL S b3u1=1
 I $D(b3u1) S CurNode=$$O(CurNode,KY,BSNAPR)  D Act1
 I $D(Au2) D STEP(BSNAPR,STEP2) I CurNode="" K Au2 S b4u1=1
 I $D(Ax2) D STEP(BSNAPR,STEPx2) I CurNode="" K Ax2 S b4u1=1
 I $D(b4u1) S CurNode=$$O(BD,KY,-BSNAPR) D Act1
 I $G(bMODE)=4 D INS D Act1
 ;I $G(bMODE)=3 D FND D Act1
 I BSNODE'="",$G(bMODE)=1 D SAVE
 I BSNODE'="",$D(bSAV) D SAVE
Act2 D SETVAR
 G TT
Act1 I CurNode'="" S BSNODE=$$Ke(CurNode) Q
 Q
DATE //ПРИНЯТЬ ДАТУ
 D VAR1,VAR2
 N D S D=$$RETURN^%ZAPM.bs.BSC4cal I D="" Q
 D SETPAR(PT,BSNODE,BS3,BS4,D)
 Q
SETPAR(PT,BSNODE,BS3,BS4,D)
 I $G(BS4) D  //
 .I BSNODE["," S $P(BSNODE,",",BS4)=D
 .E  S BSNODE=D
 D VAR3
 D SETVAR
 I '$G(BS4) S @CurNode@(BS3)=D D SNX^%ZAPM.bs.BSChT1("S",$ZR,PT,$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")")) 
 D JS^%ZAPM.bs.BSCp
 n BSLABEL,BS1,BS2,BS3,BS4 S BSLABEL="T^~BSCm4"
 W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_BSPARENT_""",""toolbar=no,menubar=no,scrollbars=no,width=800,height=600,status=1,resizable=1"");"_BK
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
FIND I $$VAR("Поиск")
FIND2 n BSLABEL S BSLABEL="FIND1^~BSCm4"
 W "<BODY "_$$27_">"_BK
 W "Определите искомые ключевые параметры"
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name='first1'>"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<table><tr>" D TTT W "</tr></table>"
 W "<INPUT name=bFIND title='найти и установить' TYPE='submit' VALUE='Поиск'>"_BK
 W " <INPUT name=bESC onclick='window.close();' title='отказ' TYPE='button' VALUE='Отказ'>"_BK
 D JS^%ZAPM.bs.BSCp
 w "first1."_xxNAME_".focus();"_BK
 D JSE^%ZAPM.bs.BSCp
 D END^%ZAPM.bs.BSC4
 Q
FIND1 I $$VAR("Результаты Поиска")
 s BSNODE=""
 f i=1:1 q:'$d(@("X"_i))  s BSNODE=BSNODE_@("X"_i)_","
 S BSNODE=$E(BSNODE,1,$L(BSNODE)-1)
 D VAR3
 I '$$Data^%ZAPM.bs.BSF12(CurNode) W BSNODE," Не существует."_BBK G FIND2
 D SETVAR
 D JS^%ZAPM.bs.BSCp
 n BSLABEL S BSLABEL="T^~BSCm4"
 W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_BSPARENT_""",""toolbar=no,menubar=no,scrollbars=no,width=500,height=200,status=1,resizable=1"");"_BK
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q            
STEP(BSNAPR,STEP) N I F I=1:1:STEP S CurNode=$$O(CurNode,KY,BSNAPR) Q:CurNode=""
 D Act1
 Q
SETKEY D VAR1
 D SetVar^%ZAPM.bs.BSC4(PT_" CurNode",BSNODE)
 G TT
 //G BACK^%ZAPM.bs.BSCh
 //W "<A target='"_BSPARENT_"' href='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>Жми...</A>"
PRE W "<PRE>"
 ZW  
 W "</PRE>"
 Q
 //
SETVAR //СОХРАНИТЬ УСТАНОВКИ
 I $$SetVar^%ZAPM.bs.BSC4(PT_" CurNode",BSNODE)
 Q
SAVE //СОХРАНИТЬ КОРРЕКЦИЮ
 N TB,CBD,KEY
 S KEY(0)="",TB=PT,CBD=CurNode
 d SAVE^%ZAPM.bs.BSChT1 //S ErrSave=1
 i $d(ErrSave) W "Ошибки контроля. В базу данных не записано" q
 W "В базу данных записано изменений= "_N3
 Q
INS S CurNode=$$O(BD,KY,BSNAPR) D Act1
 I BSNODE["," S BSNODE=$P(BSNODE,",",1,$L(BSNODE,",")-1)_","_($P(BSNODE,",",$L(BSNODE,","))+1)
 ;N C S C=$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"Count")
 ;I BSNODE["," S $P(BSNODE,",",KY)=$P(BSNODE,",",KY)+1
 E  S BSNODE=BSNODE+1
 ;D SETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"Count","V",C)
 D VAR3
 W "Вводите новую запись"
 Q
Ke(G) I G="" Q ""
 N I,N S N=""
 F I=1:1:$QL(G) S N=N_$QS(G,I) I I'=$QL(G) S N=N_","
 Q N     
VAR(SAY) //ПЕРЕМЕННЫЕ КОМПЛЕКСА
 W "<HTML><HEAD>"_BK_$$STYLE^%ZAPM.bs.BSC4
 D VAR1
 I '$$ZU^%ZAPM.bs.BSF4(NS) W "Недоступна область '"_NS_"'" Q 0
 W "<TITLE>"_$G(SAY1)_$G(SAY,$P($G(@PT),"@"))_" ____________________________________________________________________________________________________________________</TITLE>"_BK
 D VAR2
 Q $$VAR4
VAR4() I $G(BSNODEpredUs)'="" S BSNODE=BSNODEpredUs D SETVAR K BSNODEpredUs Q 1
 S BSNODE=$$GetVar^%ZAPM.bs.BSC4(PT_" CurNode","")
 Q 1
VAR1 S P=$$%^%ZAPM.bs.BSCh(BSPART),T=$$%^%ZAPM.bs.BSCh(BSTABL),NS=$$%^%ZAPM.bs.BSCh(BSNSP)
 I '$$ZU^%ZAPM.bs.BSF4(NS) W "Недоступна область '"_NS_"'" Q
 I $E(P,1)'="^" S P="^"_P
 S PT=$NA(@P@(T))
 S ArrOUT=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4SNX(""OUT"")")
 Q
VAR2 M BD=@PT@("KEY")
 S KY=$O(BD(""),-1) //КОЛИЧЕСТВО КЛЮЧЕЙ
 S GLO=BD
 Q
ERRDataSet Q ""
O(G,K,N) //$O
 N GG,A,I S $ZT="ERRDataSet"
 I G="" Q ""
 I G'["(" D  Q $$Q(GG)
 .I N=-1 S GG=$ZO(@(G_"("""")"),N)
 .E  S GG=$ZO(@G,N)
 .I GG="" Q
 .I $QL(GG)'<K Q
 .F  S GG=$ZO(@GG) Q:GG=""  I $QL(GG)'<K Q
 //A - ШАБЛОН
 I $QL(G)'<K S A=$P(G,"(") D  S A=$P(A,")")
 .F I=1:1:K S A=$NA(@A@($QS(G,I)))
 E  S A=G
 S GG=G F  S GG=$ZO(@GG,N) Q:GG=""  I $QL(GG)'<K,GG'[A Q
 Q $$Q(GG)
Q(GG) I GG="" Q ""
 N A,I S A=$P(GG,"(") F I=1:1:K S A=$NA(@A@($QS(GG,I)))
 Q A
]]></Routine>


<Routine name="%ZAPM.bs.BSCm41" type="MAC" languagemode="0"><![CDATA[
%BSCm41 //СПИСОК ДАННЫХ ТАБЛИЦЫ
 ;
 ;    Copyright (C) Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q       
 //i '$D(NoList),$$GETOPT^%ZAPM.bs.BSC4cfgP($NA(@PT@("Parms")),"CNavigList") G List
ListTab(CurNode,BSNODE,TX,St1,St2)
 N Q,I
 S Q="<tr>"
 f ny=1:1:Maxfeild D
 .N TRANS
 .s var1=$$GetField^%ZAPM.bs.BSC4rou(P,T,ny,1)
 .s nf=$P(var1,"~",1)
 .I $G(TX)'="" S Q=Q_"<td class=s3>"_nf_"</td>" Q
 .s Description=$P(var1,"~",2) //вычленить описание поля
 .S xClass="s"_St1 i MaxIndxfeild'<ny S xClass="s"_St2
 .S Q=Q_"<td class="_xClass_" title='Загрузить запись для коррекции'>"
 .S (d,d1,d0)=$$CELL^%ZAPM.bs.BSCm4 I d="" S d="&nbsp;"
 .I ny=1 S BSLABEL="Tn^~BSCm41",Q=Q_"<div class='u1' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_BSPARENT_""",""toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1"");'>"
 .S Q=Q_d
 .I ny=1 S Q=Q_"</div>"
 .S Q=Q_"</td>"
 S Q=Q_"</tr>"
 Q Q
Tn S BSList=2 d VAR1^%ZAPM.bs.BSCm4,SETVAR^%ZAPM.bs.BSCm4 G T^%ZAPM.bs.BSCm4      
List S BSList=1,SAY1="Список записей " G T^%ZAPM.bs.BSCm4
List0 //список данных
 //S DISABLE=0 I $$O(CurNode,KY,-BSNAPR)="" S DISABLE=1
 //S BSLABEL="SETKEY^~BSCm4"
 //S Q=Q_"<td><select name=MODE1 size=1 onclick=""javascript: { if (''!=MODE1.value & ('"_BSNODE_"'!=MODE1.value)) parent.location='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&STEP1="_$G(STEP1)_"&STEP2="_$G(STEP2)_"&BSNODE='+MODE1.value; } "" >"_BK
 S Tmp=BSPARENT N BSPARENT
 S BSPARENT=Tmp_"o"
 W "<table>" D VAR3^%ZAPM.bs.BSCm4
 s Maxfeild=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Count",1)
 s MaxIndxfeild=$$GetField^%ZAPM.bs.BSC4rou(P,T,"Index",1)
 S GLO=CurNode F ind=1:1:KL S GLO=$$O^%ZAPM.bs.BSCm4(GLO,KY,-BSNAPR) Q:GLO=""  S GLO1=$$Ke^%ZAPM.bs.BSCm4(GLO) S KL(ind)=$$ListTab(GLO,GLO1,,1,2)
 S KL(ind+1)=$$ListTab(1,1,1,1,2)        I ind=KL,GLO'="" S KL(ind+2)="<tr><td>...дальше</td></tr>"_BK
 S ind="" F  S ind=$O(KL(ind),-1) Q:ind=""  W KL(ind)_BK
 S GLO1=$$Ke^%ZAPM.bs.BSCm4(CurNode) W $$ListTab(CurNode,GLO1,,2,1)_BK
 S GLO=CurNode F ind=1:1:KL S GLO=$$O^%ZAPM.bs.BSCm4(GLO,KY,BSNAPR) Q:GLO=""  S GLO1=$$Ke^%ZAPM.bs.BSCm4(GLO) W $$ListTab(GLO,GLO1,,1,2)_BK
 W $$ListTab(1,1,1,1,2)
 I ind=KL,GLO'="" W "<tr><td>...дальше</td></tr>"_BK
 W "</table>"
 //S Q=Q_"</select></td>"_BK
 //I $$O(CurNode,KY,BSNAPR)="" S DISABLE=2
 D JS^%ZAPM.bs.BSCp
 w "window.defaultStatus = '{F5} - обновить окно'"_BK
 D JSE^%ZAPM.bs.BSCp
 D END^%ZAPM.bs.BSC4
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSCmBP" type="MAC" languagemode="0"><![CDATA[
%BSCmBP ;ПРОГРАММА ФУНКЦИЙ И МОДУЛЕЙ ДЛЯ БОЕВЫХ ПОТЕРЕЙ
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
1 //ВЫГРУЗКА КЛАССИФИКАТОРОВ
 I $ZU(5,"GLAVK")
 F KD1="KPPOT","BPRBD","k056" D KD(KD1)
 Q
KD(KD) N %FN,%DEV
 S PR1="L:\!\"_KD D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 U %DEV W "KOD|TEXT|",!
 S KOD="^"_KD,S="" F  S S=$O(@KOD@(1,S)) Q:S=""  W S,"|",$G(@KOD@(1,S)),"|",!
 C %DEV
 Q
2 	//ВЫГРУЗИМ В ФАЙЛ
	S N="L:\!\U"
	O N:("WNS"):3 U N W ^%CDUaf,!
	S S="" F  S S=$O(^%CDUaf(S)) Q:S=""  W S,$C(0),$G(^%CDUaf(S)),!
	C N
	Q
3 //В ДРУГОЙ СНОВА ЗАГРУЗИМ
 K ^%CDUaaaa
 S A=$$File2Arr^%ZAPM.bs.BSCEXE("L:\!\U",.M) ;ЗАГРУЗИМ ФАЙЛ В ЛОКАЛЬ
 D STR2MAS^%ZAPM.bs.BSCmail(.M,.AA,$C(13,10)) ;ЛОКАЛЬ ПРИЧЕШЕМ
 S S="" F  S S=$O(AA(S)) Q:S=""  D
 .I S=1 S ^%CDUaaaa=AA(S) Q
 .S S1=$P(AA(S),$C(0),1),S2=$P(AA(S),$C(0),2),^%CDUaaaa(S1)=S2
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCmBf" type="MAC" languagemode="0"><![CDATA[
rhBlowfish	;  ; Compiled January 31, 2005 23:39:40
	; Cache Object Script implementation of the Blowfish symmetric block cipher
	; Copyright (C) 2001 COD International BV
	; Naarden, The Netherlands <www.codgroep.nl>. All rights reserved.
	; You are free to use this code in your applications without liability
	; or compensation, but the courtesy of both notification of use and	
	; inclusion of due credit are requested. You must keep this copyright
	; notice intact.
	; It is PROHIBITED to distribute or reproduce this code for profit
	; or otherwise, on any web site, ftp server or BBS, or by any
	; other means, including CD-ROM or other physical media, without the
	; EXPRESS WRITTEN PERMISSION of the copyright holder.
	; Use at your own risk.
	; COD International BV offers no warranty of its fitness for any
	; purpose whatsoever, and accept no liability whatsoever for any
	; loss or damage incurred by its use.
	; If you use it, or found it useful, or can suggest an improvement
	; please let us know at <development@codgroep.nl>.
	; Author: Herman Slagman
	; Blowfish is a symmetric block cipher that can be used as a drop-in
	; replacement for DES or IDEA.
	; It takes a variable-length key, from 32 bits to 448 bits, making it
	; ideal for both domestic and exportable use.
	; Blowfish was designed in 1993 by Bruce Schneier as a fast, free
	; alternative to existing encryption algorithms.
	; Since then it has been analyzed considerably, and it is slowly gaining
	; acceptance as a strong encryption algorithm.
	; Blowfish is unpatented and license-free, and is available free for all uses. 
	; <www.counterpane.com/blowfish.html>
	; Restrictions.
	; This code relies heavily on macro preprocessor commands, it should
	; therefor be compiled as a Cache Object Script MAC routine.
	; It also uses the Cache 4.x and higher COS language enhancements, such
	; as multiline commands, and needs to be adjusted for use on earlier
	; Note.
	; Based on the Visual Basic implementation of David Ireland, DI Management Services Pty Ltd, Sydney Australia
	; <www.di-mgt.com.au>
EncryptString(sText,sKey)
	New i,nLen,nPad,sPad,nBlocks,sPlain,S,P,awData,sCipher,Bytes,j
	Do InitialiseKey(sKey)
	Set nLen = $Length(sText)
	Set nPad = ((nLen \ 8) + 1) * 8 - nLen
	Set sPad = $Translate($Justify("",nPad)," ",$Char(nPad))  ; Pad with # of pads (1-8)
	Set sPlain = sText_sPad
	Set nLen = $Length(sPlain)
	Set nBlocks = nLen \ 8
	; Split string into blocks of 2 x 32-bit words
	For i = 0:8:(nBlocks - 1*8) {
	    Set awData(i\8*2)=$Ascii(sPlain,i+1)*(16777216)+($Ascii(sPlain,i+2)*(65536))+($Ascii(sPlain,i+3)*256)+$Ascii(sPlain,i+4)
	    Set awData(i\8*2+1)=$Ascii(sPlain,i+5)*(16777216)+($Ascii(sPlain,i+6)*(65536))+($Ascii(sPlain,i+7)*256)+$Ascii(sPlain,i+8)
	}
	Do Enc(nBlocks * 2)
	; Put back into a string
	Set sCipher = ""
	For i = 0:1:nBlocks-1 {
	    Do WordSplit(awData(i * 2),.Bytes)
	    For j=0:1:3 Set sCipher = sCipher_$Char(Bytes(j))
	    Do WordSplit(awData(i * 2+1),.Bytes)
	    For j=0:1:3 Set sCipher = sCipher_$Char(Bytes(j))
	}
	Quit sCipher
Enc(nWords)
	New i,xL,xR
	For i = 0:2:nWords-1 {
	    Set xL = awData(i), xR = awData(i+1)
	    Do EncipherBlock(.xL,.xR)
	    Set awData(i) = xL, awData(i+1) = xR
	}
	Quit
EncryptFile(FileIn,FileOut,sKey)
	New i,nLen,nPad,sPad,nBlocks,sPlain,S,P,awData,sCipher,Bytes,j
	Open FileIn:"rs":0 If '$Test Quit
	Open FileOut:"wns":0 If '$Test Close FileIn Quit
	Do InitialiseKey(sKey)
	Set $Ztrap="EncEOF"
	For  {
	   Kill Bytes
	   For i=0:1:7 Use FileIn Read *Bytes(i)
	   Do EncryptBytes(.Bytes)
	   For i=0:1:7 Use FileOut Write $Char(Bytes(i))
	}
EncEOF
	If $ZE'["ENDOFFILE" Close FileIn,FileOut Write $ZE Quit
	Set nPad=8-$Order(Bytes(""),-1)
	For i=1:1:nPad Set Bytes(8-i)=nPad
	Do EncryptBytes(.Bytes)
	For i=0:1:7 Use FileOut Write $Char(Bytes(i))
	Close FileIn
	Close FileOut   
	Quit
EncryptBytes(Bytes)
	; Encrypt an array of 8 bytes
	New wordL,wordR
	; Convert to 2 x words
	Set wordL = Bytes(0)*(16777216)+(Bytes(1)*(65536))+(Bytes(2)*256)+Bytes(3)
	Set wordR = Bytes(4)*(16777216)+(Bytes(5)*(65536))+(Bytes(6)*256)+Bytes(7)
	; Encrypt it
	Do EncipherBlock(.wordL, .wordR)
	; Put back into bytes
	Set Bytes(0)=wordL#(4294967296)\(16777216)   
	Set Bytes(1)=wordL#(16777216)\(65536)
	Set Bytes(2)=wordL#(65536)\256   
	Set Bytes(3)=wordL#256
	Set Bytes(4)=wordR#(4294967296)\(16777216)   
	Set Bytes(5)=wordR#(16777216)\(65536)
	Set Bytes(6)=wordR#(65536)\256   
	Set Bytes(7)=wordR#256
	Quit
EncipherBlock(xL,xR)
	New i,temp
	For i = 0:1:15 {
	   Set xL = $$XOR(xL,P(i))
	   Set xR = $$XOR($$F(xL),xR)
	   Set temp = xL
	   Set xL = xR
	   Set xR = temp
	}
	Set temp = xL
	Set xL = xR
	Set xR = temp
	Set xR = $$XOR(xR,P(16))
	Set xL = $$XOR(xL,P(17))
	Quit
DecryptString(sCipher,sKey)
	New awData,D1,D2,i,j,sPlain,S,P,nPad
	New nLen,nBlocks,D,Bytes
	Do InitialiseKey(sKey)
	Set nLen = $Length(sCipher)
	Set nBlocks = nLen \ 8
	; Split string into blocks of 2 x 32-bit words
	For i = 0:8:(nBlocks - 1*8) {
	    Set awData(i\8*2) = $Ascii(sCipher,i+1)*(16777216)+($Ascii(sCipher,i+2)*(65536))+($Ascii(sCipher,i+3)*256)+$Ascii(sCipher,i+4)
	    Set awData(i\8*2+1) = $Ascii(sCipher,i+5)*(16777216)+($Ascii(sCipher,i+6)*(65536))+($Ascii(sCipher,i+7)*256)+$Ascii(sCipher,i+8)
	}
	; Decrypt it
	Do Dec(nBlocks * 2)
	; Put back into a string
	Set sPlain = ""
	For i = 0:1:nBlocks-1 {
	    Do WordSplit(awData(i * 2),.Bytes)
	    For j=0:1:3 Set sPlain = sPlain_$Char(Bytes(j))
	    Do WordSplit(awData(i * 2+1),.Bytes)
	    For j=0:1:3 Set sPlain = sPlain_$Char(Bytes(j))
	}
	; Strip padding
	Set nPad = $Ascii(sPlain,$Length(sPlain))
	Set sPlain = $Extract(sPlain,0, nLen - nPad)
	Quit sPlain
Dec(nWords)
	New i,xL,xR
	For i = 0:2:nWords-1 {
	   Set xL = awData(i),xR = awData(i+1)
	   Do DecipherBlock(.xL,.xR)
	   Set awData(i) = xL, awData(i+1) = xR
	}
	Quit
DecryptFile(FileIn,FileOut,Key)
	New i,nLen,nPad,sPad,nBlocks,sPlain,S,P,awData,sCipher,Bytes,j,InitByte
	Set $ZTrap=""
	Open FileIn:"rs":0 If '$Test Use 0 Write "Cannot open "_FileIn_" for input",! Quit
	Open FileOut:"wns":0 If '$Test Use 0 Write "Cannot open "_FileOut_" for output",! Close FileIn Quit
	Do InitialiseKey(Key)
	Set $ZTrap="DecEOF"
	; we need InitByte to detect EOF before writing the last 8 Bytes
	Use FileIn Read *InitByte
	For  {
	   Kill Bytes
	   Set Bytes(0)=InitByte
	   For i=1:1:7 Use FileIn Read *Bytes(i)
	   Do DecryptBytes(.Bytes)
	   ; we need to know if we are at EOF in order to remove padding
	   Use FileIn Read *InitByte
	   For i=0:1:7 Use FileOut Write $Char(Bytes(i))
	}
DecEOF	;
	If $ZE'["ENDOFFILE" Close FileIn,FileOut Use 0 Write "Error = "_$ZE,! Quit
	Set $ZTrap=""
	; Don't write pad bytes
	For i=0:1:7-Bytes(7) Use FileOut Write $Char(Bytes(i))
	Close FileIn
	Close FileOut   
	Quit
DecryptBytes(Bytes)
	; Decrypt an array of 8 bytes
	New wordL,wordR
	; Convert to 2 x words
	Set wordL = Bytes(0)*(16777216)+(Bytes(1)*(65536))+(Bytes(2)*256)+(Bytes(3))
	Set wordR = Bytes(4)*(16777216)+(Bytes(5)*(65536))+(Bytes(6)*256)+(Bytes(7))
	; Decrypt it
	Do DecipherBlock(.wordL, .wordR)
	; Put back into bytes
	Set Bytes(0)=wordL#(4294967296)\(16777216)   
	Set Bytes(1)=wordL#(16777216)\(65536)
	Set Bytes(2)=wordL#(65536)\256   
	Set Bytes(3)=wordL#256
	Set Bytes(4)=wordR#(4294967296)\(16777216)   
	Set Bytes(5)=wordR#(16777216)\(65536)
	Set Bytes(6)=wordR#(65536)\256   
	Set Bytes(7)=wordR#256
	Quit
DecipherBlock(xL,xR)
	New i,temp
	For i = 17:-1:2 {
	   Set xL = $$XOR(xL,P(i))
	   Set xR = $$XOR($$F(xL),xR)
	   Set temp = xL
	   Set xL = xR
	   Set xR = temp
	}
	Set temp = xL
	Set xL = xR
	Set xR = temp
	Set xR = $$XOR(xR,P(1))
	Set xL = $$XOR(xL,P(0))
	Quit
F(x)	
	New y,Bytes,B0,B1,B2,B3
	; x is a 4 byte word (32 bits)
	Set B0=x#(4294967296)\(16777216)   
	Set B1=x#(16777216)\(65536)
	Set B2=x#(65536)\256   
	Set B3=x#256
	Set y = $$WordAdd(S(0, B0), S(1, B1))
	Set y = $$XOR(y,S(2, B2))
	Set y = $$WordAdd(y, S(3, B3))
	Quit y
ShiftLeftBy8(wordX)
	New SL
	Set SL=wordX*256#4294967296
	If SL>2147483647 Set SL=SL-4294967296
	Quit SL
WordAdd(wordA,wordB)
	; Adds words A and B avoiding overflow
	New WA
	If wordA < 0 Set wordA = wordA + 4294967296
	If wordB < 0 Set wordB = wordB + 4294967296
	Set WA=wordA+wordB
	If WA > 2147483647 Set WA = WA - 4294967296
	Quit WA
WordSplit(Word,Bytes)
	;' Splits 32-bit word (long) into 4 x 8-bit bytes
	Set Bytes(0)=Word#(4294967296)\(16777216)   
	Set Bytes(1)=Word#(16777216)\(65536)
	Set Bytes(2)=Word#(65536)\256   
	Set Bytes(3)=Word#256
	Quit 
WordJoin(a,b,c,d)
	; Joins 4 x 8-bit bytes to form 32-bit word a.b.c.d
	Quit a*16777216+(b*65536)+(c*256)+d
UnsignedToLong(value)
	If value < 0 ! value '< 4294967296 Quit  ;Error 6 ' Overflow
	If value '> 2147483647 Quit value
	Quit value - 4294967296
LongToUnsigned(value)
	If value < 0 Quit value + 4294967296
	Quit value
AND(a,b)
	New r
	Set r=$ZBoolean(a,b,1)
	If r>2147483647 Set r=r-4294967296
	Quit r
XOR(a,b)
	New r   
	Set r = $ZBoolean(a,b,6)
	If r>2147483647 Set r=r-4294967296
	Quit r
OR(a,b)
	New r   
	Set r = $ZBoolean(a,b,7)
	If r>2147483647 Set r=r-4294967296
	Quit r
InitialiseKey(Key)
	New i,j,K,wData,wDataL,wDataR,Hash
	New S1,S2,P1
	; Because creating a key can take a while we save created keys in a global under an encrypted key
	Set Hash=$$Encrypt^%ZAPM.bs.BSCmd5(Key)
	If $Data(^rhBlowfish(Hash)) Do  Quit
	.   Set S1="" For  Set S1=$Order(^rhBlowfish(Hash,"S",S1)) Quit:S1=""  Do
	..      Set S2=""  For  Set S2=$Order(^rhBlowfish(Hash,"S",S1,S2)) Quit:S2=""  Set S(S1,S2)=^(S2)
	.   Set P1="" For  Set P1=$Order(^rhBlowfish(Hash,"P",P1)) Quit:P1=""  Set P(P1)=^(P1)
	Set NrBytes=$Length(Key)
	Do InitArrays
	Set j = 1
	For i = 0:1:17 {
	   Set wData = 0
	   For K = 0:1:3 {
	      Set wData = $$OR($$ShiftLeftBy8(wData),$Ascii(Key,j))
	      Set j = j + 1
	      If j>NrBytes Set j = 1
	   }
	   Set P(i) = $$XOR(P(i),wData)
	}
	Set wDataL = 0
	Set wDataR = 0
	For i = 0:2:17 {
	   Do EncipherBlock(.wDataL, .wDataR)
	   Set P(i) = wDataL
	   Set P(i + 1) = wDataR
	}
	For i = 0:1:3 {
	   For j = 0:2:255 {
	      Do EncipherBlock(.wDataL, .wDataR)
	      Set S(i, j) = wDataL
	      Set S(i, j + 1) = wDataR
	   }
	}
	; save the key for future use
	Set S1=""
	For  {
	   Set S1=$Order(S(S1))
	   If S1="" Quit
	   Set S2=""
	   For  {
	      Set S2=$Order(S(S1,S2))
	      If S2="" Quit
	      Set ^rhBlowfish(Hash,"S",S1,S2)=S(S1,S2)
	   }
	}
	Set P1=""
	For  {
	   Set P1=$Order(P(P1))
	   If P1="" Quit
	   Set ^rhBlowfish(Hash,"P",P1)=P(P1)
	}
	Quit
InitArrays	; Init arrays
	Kill S,P
	Set S(0,0)=3509652390,S(0,1)=2564797868,S(0,2)=805139163,S(0,3)=3491422135,S(0,4)=3101798381,S(0,5)=1780907670
	Set S(0,6)=3128725573,S(0,7)=4046225305,S(0,8)=614570311,S(0,9)=3012652279,S(0,10)=134345442,S(0,11)=2240740374
	Set S(0,12)=1667834072,S(0,13)=1901547113,S(0,14)=2757295779,S(0,15)=4103290238,S(0,16)=227898511,S(0,17)=1921955416
	Set S(0,18)=1904987480,S(0,19)=2182433518,S(0,20)=2069144605,S(0,21)=3260701109,S(0,22)=2620446009,S(0,23)=720527379
	Set S(0,24)=3318853667,S(0,25)=677414384,S(0,26)=3393288472,S(0,27)=3101374703,S(0,28)=2390351024,S(0,29)=1614419982
	Set S(0,30)=1822297739,S(0,31)=2954791486,S(0,32)=3608508353,S(0,33)=3174124327,S(0,34)=2024746970,S(0,35)=1432378464
	Set S(0,36)=3864339955,S(0,37)=2857741204,S(0,38)=1464375394,S(0,39)=1676153920,S(0,40)=1439316330,S(0,41)=715854006
	Set S(0,42)=3033291828,S(0,43)=289532110,S(0,44)=2706671279,S(0,45)=2087905683,S(0,46)=3018724369,S(0,47)=1668267050
	Set S(0,48)=732546397,S(0,49)=1947742710,S(0,50)=3462151702,S(0,51)=2609353502,S(0,52)=2950085171,S(0,53)=1814351708
	Set S(0,54)=2050118529,S(0,55)=680887927,S(0,56)=999245976,S(0,57)=1800124847,S(0,58)=3300911131,S(0,59)=1713906067
	Set S(0,60)=1641548236,S(0,61)=4213287313,S(0,62)=1216130144,S(0,63)=1575780402,S(0,64)=4018429277,S(0,65)=3917837745
	Set S(0,66)=3693486850,S(0,67)=3949271944,S(0,68)=596196993,S(0,69)=3549867205,S(0,70)=258830323,S(0,71)=2213823033
	Set S(0,72)=772490370,S(0,73)=2760122372,S(0,74)=1774776394,S(0,75)=2652871518,S(0,76)=566650946,S(0,77)=4142492826
	Set S(0,78)=1728879713,S(0,79)=2882767088,S(0,80)=1783734482,S(0,81)=3629395816,S(0,82)=2517608232,S(0,83)=2874225571
	Set S(0,84)=1861159788,S(0,85)=326777828,S(0,86)=3124490320,S(0,87)=2130389656,S(0,88)=2716951837,S(0,89)=967770486
	Set S(0,90)=1724537150,S(0,91)=2185432712,S(0,92)=2364442137,S(0,93)=1164943284,S(0,94)=2105845187,S(0,95)=998989502
	Set S(0,96)=3765401048,S(0,97)=2244026483,S(0,98)=1075463327,S(0,99)=1455516326,S(0,100)=1322494562,S(0,101)=910128902
	Set S(0,102)=469688178,S(0,103)=1117454909,S(0,104)=936433444,S(0,105)=3490320968,S(0,106)=3675253459,S(0,107)=1240580251
	Set S(0,108)=122909385,S(0,109)=2157517691,S(0,110)=634681816,S(0,111)=4142456567,S(0,112)=3825094682,S(0,113)=3061402683
	Set S(0,114)=2540495037,S(0,115)=79693498,S(0,116)=3249098678,S(0,117)=1084186820,S(0,118)=1583128258,S(0,119)=426386531
	Set S(0,120)=1761308591,S(0,121)=1047286709,S(0,122)=322548459,S(0,123)=995290223,S(0,124)=1845252383,S(0,125)=2603652396
	Set S(0,126)=3431023940,S(0,127)=2942221577,S(0,128)=3202600964,S(0,129)=3727903485,S(0,130)=1712269319,S(0,131)=422464435
	Set S(0,132)=3234572375,S(0,133)=1170764815,S(0,134)=3523960633,S(0,135)=3117677531,S(0,136)=1434042557,S(0,137)=442511882
	Set S(0,138)=3600875718,S(0,139)=1076654713,S(0,140)=1738483198,S(0,141)=4213154764,S(0,142)=2393238008,S(0,143)=3677496056
	Set S(0,144)=1014306527,S(0,145)=4251020053,S(0,146)=793779912,S(0,147)=2902807211,S(0,148)=842905082,S(0,149)=4246964064
	Set S(0,150)=1395751752,S(0,151)=1040244610,S(0,152)=2656851899,S(0,153)=3396308128,S(0,154)=445077038,S(0,155)=3742853595
	Set S(0,156)=3577915638,S(0,157)=679411651,S(0,158)=2892444358,S(0,159)=2354009459,S(0,160)=1767581616,S(0,161)=3150600392
	Set S(0,162)=3791627101,S(0,163)=3102740896,S(0,164)=284835224,S(0,165)=4246832056,S(0,166)=1258075500,S(0,167)=768725851
	Set S(0,168)=2589189241,S(0,169)=3069724005,S(0,170)=3532540348,S(0,171)=1274779536,S(0,172)=3789419226,S(0,173)=2764799539
	Set S(0,174)=1660621633,S(0,175)=3471099624,S(0,176)=4011903706,S(0,177)=913787905,S(0,178)=3497959166,S(0,179)=737222580
	Set S(0,180)=2514213453,S(0,181)=2928710040,S(0,182)=3937242737,S(0,183)=1804850592,S(0,184)=3499020752,S(0,185)=2949064160
	Set S(0,186)=2386320175,S(0,187)=2390070455,S(0,188)=2415321851,S(0,189)=4061277028,S(0,190)=2290661394,S(0,191)=2416832540
	Set S(0,192)=1336762016,S(0,193)=1754252060,S(0,194)=3520065937,S(0,195)=3014181293,S(0,196)=791618072,S(0,197)=3188594551
	Set S(0,198)=3933548030,S(0,199)=2332172193,S(0,200)=3852520463,S(0,201)=3043980520,S(0,202)=413987798,S(0,203)=3465142937
	Set S(0,204)=3030929376,S(0,205)=4245938359,S(0,206)=2093235073,S(0,207)=3534596313,S(0,208)=375366246,S(0,209)=2157278981
	Set S(0,210)=2479649556,S(0,211)=555357303,S(0,212)=3870105701,S(0,213)=2008414854,S(0,214)=3344188149,S(0,215)=4221384143
	Set S(0,216)=3956125452,S(0,217)=2067696032,S(0,218)=3594591187,S(0,219)=2921233993,S(0,220)=2428461,S(0,221)=544322398
	Set S(0,222)=577241275,S(0,223)=1471733935,S(0,224)=610547355,S(0,225)=4027169054,S(0,226)=1432588573,S(0,227)=1507829418
	Set S(0,228)=2025931657,S(0,229)=3646575487,S(0,230)=545086370,S(0,231)=48609733,S(0,232)=2200306550,S(0,233)=1653985193
	Set S(0,234)=298326376,S(0,235)=1316178497,S(0,236)=3007786442,S(0,237)=2064951626,S(0,238)=458293330,S(0,239)=2589141269
	Set S(0,240)=3591329599,S(0,241)=3164325604,S(0,242)=727753846,S(0,243)=2179363840,S(0,244)=146436021,S(0,245)=1461446943
	Set S(0,246)=4069977195,S(0,247)=705550613,S(0,248)=3059967265,S(0,249)=3887724982,S(0,250)=4281599278,S(0,251)=3313849956
	Set S(0,252)=1404054877,S(0,253)=2845806497,S(0,254)=146425753,S(0,255)=1854211946
	Set S(1,0)=1266315497,S(1,1)=3048417604,S(1,2)=3681880366,S(1,3)=3289982499,S(1,4)=2909710000,S(1,5)=1235738493
	Set S(1,6)=2632868024,S(1,7)=2414719590,S(1,8)=3970600049,S(1,9)=1771706367,S(1,10)=1449415276,S(1,11)=3266420449
	Set S(1,12)=422970021,S(1,13)=1963543593,S(1,14)=2690192192,S(1,15)=3826793022,S(1,16)=1062508698,S(1,17)=1531092325
	Set S(1,18)=1804592342,S(1,19)=2583117782,S(1,20)=2714934279,S(1,21)=4024971509,S(1,22)=1294809318,S(1,23)=4028980673
	Set S(1,24)=1289560198,S(1,25)=2221992742,S(1,26)=1669523910,S(1,27)=35572830,S(1,28)=157838143,S(1,29)=1052438473
	Set S(1,30)=1016535060,S(1,31)=1802137761,S(1,32)=1753167236,S(1,33)=1386275462,S(1,34)=3080475397,S(1,35)=2857371447
	Set S(1,36)=1040679964,S(1,37)=2145300060,S(1,38)=2390574316,S(1,39)=1461121720,S(1,40)=2956646967,S(1,41)=4031777805
	Set S(1,42)=4028374788,S(1,43)=33600511,S(1,44)=2920084762,S(1,45)=1018524850,S(1,46)=629373528,S(1,47)=3691585981
	Set S(1,48)=3515945977,S(1,49)=2091462646,S(1,50)=2486323059,S(1,51)=586499841,S(1,52)=988145025,S(1,53)=935516892
	Set S(1,54)=3367335476,S(1,55)=2599673255,S(1,56)=2839830854,S(1,57)=265290510,S(1,58)=3972581182,S(1,59)=2759138881
	Set S(1,60)=3795373465,S(1,61)=1005194799,S(1,62)=847297441,S(1,63)=406762289,S(1,64)=1314163512,S(1,65)=1332590856
	Set S(1,66)=1866599683,S(1,67)=4127851711,S(1,68)=750260880,S(1,69)=613907577,S(1,70)=1450815602,S(1,71)=3165620655
	Set S(1,72)=3734664991,S(1,73)=3650291728,S(1,74)=3012275730,S(1,75)=3704569646,S(1,76)=1427272223,S(1,77)=778793252
	Set S(1,78)=1343938022,S(1,79)=2676280711,S(1,80)=2052605720,S(1,81)=1946737175,S(1,82)=3164576444,S(1,83)=3914038668
	Set S(1,84)=3967478842,S(1,85)=3682934266,S(1,86)=1661551462,S(1,87)=3294938066,S(1,88)=4011595847,S(1,89)=840292616
	Set S(1,90)=3712170807,S(1,91)=616741398,S(1,92)=312560963,S(1,93)=711312465,S(1,94)=1351876610,S(1,95)=322626781
	Set S(1,96)=1910503582,S(1,97)=271666773,S(1,98)=2175563734,S(1,99)=1594956187,S(1,100)=70604529,S(1,101)=3617834859
	Set S(1,102)=1007753275,S(1,103)=1495573769,S(1,104)=4069517037,S(1,105)=2549218298,S(1,106)=2663038764,S(1,107)=504708206
	Set S(1,108)=2263041392,S(1,109)=3941167025,S(1,110)=2249088522,S(1,111)=1514023603,S(1,112)=1998579484,S(1,113)=1312622330
	Set S(1,114)=694541497,S(1,115)=2582060303,S(1,116)=2151582166,S(1,117)=1382467621,S(1,118)=776784248,S(1,119)=2618340202
	Set S(1,120)=3323268794,S(1,121)=2497899128,S(1,122)=2784771155,S(1,123)=503983604,S(1,124)=4076293799,S(1,125)=907881277
	Set S(1,126)=423175695,S(1,127)=432175456,S(1,128)=1378068232,S(1,129)=4145222326,S(1,130)=3954048622,S(1,131)=3938656102
	Set S(1,132)=3820766613,S(1,133)=2793130115,S(1,134)=2977904593,S(1,135)=26017576,S(1,136)=3274890735,S(1,137)=3194772133
	Set S(1,138)=1700274565,S(1,139)=1756076034,S(1,140)=4006520079,S(1,141)=3677328699,S(1,142)=720338349,S(1,143)=1533947780
	Set S(1,144)=354530856,S(1,145)=688349552,S(1,146)=3973924725,S(1,147)=1637815568,S(1,148)=332179504,S(1,149)=3949051286
	Set S(1,150)=53804574,S(1,151)=2852348879,S(1,152)=3044236432,S(1,153)=1282449977,S(1,154)=3583942155,S(1,155)=3416972820
	Set S(1,156)=4006381244,S(1,157)=1617046695,S(1,158)=2628476075,S(1,159)=3002303598,S(1,160)=1686838959,S(1,161)=431878346
	Set S(1,162)=2686675385,S(1,163)=1700445008,S(1,164)=1080580658,S(1,165)=1009431731,S(1,166)=832498133,S(1,167)=3223435511
	Set S(1,168)=2605976345,S(1,169)=2271191193,S(1,170)=2516031870,S(1,171)=1648197032,S(1,172)=4164389018,S(1,173)=2548247927
	Set S(1,174)=300782431,S(1,175)=375919233,S(1,176)=238389289,S(1,177)=3353747414,S(1,178)=2531188641,S(1,179)=2019080857
	Set S(1,180)=1475708069,S(1,181)=455242339,S(1,182)=2609103871,S(1,183)=448939670,S(1,184)=3451063019,S(1,185)=1395535956
	Set S(1,186)=2413381860,S(1,187)=1841049896,S(1,188)=1491858159,S(1,189)=885456874,S(1,190)=4264095073,S(1,191)=4001119347
	Set S(1,192)=1565136089,S(1,193)=3898914787,S(1,194)=1108368660,S(1,195)=540939232,S(1,196)=1173283510,S(1,197)=2745871338
	Set S(1,198)=3681308437,S(1,199)=4207628240,S(1,200)=3343053890,S(1,201)=4016749493,S(1,202)=1699691293,S(1,203)=1103962373
	Set S(1,204)=3625875870,S(1,205)=2256883143,S(1,206)=3830138730,S(1,207)=1031889488,S(1,208)=3479347698,S(1,209)=1535977030
	Set S(1,210)=4236805024,S(1,211)=3251091107,S(1,212)=2132092099,S(1,213)=1774941330,S(1,214)=1199868427,S(1,215)=1452454533
	Set S(1,216)=157007616,S(1,217)=2904115357,S(1,218)=342012276,S(1,219)=595725824,S(1,220)=1480756522,S(1,221)=206960106
	Set S(1,222)=497939518,S(1,223)=591360097,S(1,224)=863170706,S(1,225)=2375253569,S(1,226)=3596610801,S(1,227)=1814182875
	Set S(1,228)=2094937945,S(1,229)=3421402208,S(1,230)=1082520231,S(1,231)=3463918190,S(1,232)=2785509508,S(1,233)=435703966
	Set S(1,234)=3908032597,S(1,235)=1641649973,S(1,236)=2842273706,S(1,237)=3305899714,S(1,238)=1510255612,S(1,239)=2148256476
	Set S(1,240)=2655287854,S(1,241)=3276092548,S(1,242)=4258621189,S(1,243)=236887753,S(1,244)=3681803219,S(1,245)=274041037
	Set S(1,246)=1734335097,S(1,247)=3815195456,S(1,248)=3317970021,S(1,249)=1899903192,S(1,250)=1026095262,S(1,251)=4050517792
	Set S(1,252)=356393447,S(1,253)=2410691914,S(1,254)=3873677099,S(1,255)=3682840055
	Set S(2,0)=3913112168,S(2,1)=2491498743,S(2,2)=4132185628,S(2,3)=2489919796,S(2,4)=1091903735,S(2,5)=1979897079
	Set S(2,6)=3170134830,S(2,7)=3567386728,S(2,8)=3557303409,S(2,9)=857797738,S(2,10)=1136121015,S(2,11)=1342202287
	Set S(2,12)=507115054,S(2,13)=2535736646,S(2,14)=337727348,S(2,15)=3213592640,S(2,16)=1301675037,S(2,17)=2528481711
	Set S(2,18)=1895095763,S(2,19)=1721773893,S(2,20)=3216771564,S(2,21)=62756741,S(2,22)=2142006736,S(2,23)=835421444
	Set S(2,24)=2531993523,S(2,25)=1442658625,S(2,26)=3659876326,S(2,27)=2882144922,S(2,28)=676362277,S(2,29)=1392781812
	Set S(2,30)=170690266,S(2,31)=3921047035,S(2,32)=1759253602,S(2,33)=3611846912,S(2,34)=1745797284,S(2,35)=664899054
	Set S(2,36)=1329594018,S(2,37)=3901205900,S(2,38)=3045908486,S(2,39)=2062866102,S(2,40)=2865634940,S(2,41)=3543621612
	Set S(2,42)=3464012697,S(2,43)=1080764994,S(2,44)=553557557,S(2,45)=3656615353,S(2,46)=3996768171,S(2,47)=991055499
	Set S(2,48)=499776247,S(2,49)=1265440854,S(2,50)=648242737,S(2,51)=3940784050,S(2,52)=980351604,S(2,53)=3713745714
	Set S(2,54)=1749149687,S(2,55)=3396870395,S(2,56)=4211799374,S(2,57)=3640570775,S(2,58)=1161844396,S(2,59)=3125318951
	Set S(2,60)=1431517754,S(2,61)=545492359,S(2,62)=4268468663,S(2,63)=3499529547,S(2,64)=1437099964,S(2,65)=2702547544
	Set S(2,66)=3433638243,S(2,67)=2581715763,S(2,68)=2787789398,S(2,69)=1060185593,S(2,70)=1593081372,S(2,71)=2418618748
	Set S(2,72)=4260947970,S(2,73)=69676912,S(2,74)=2159744348,S(2,75)=86519011,S(2,76)=2512459080,S(2,77)=3838209314
	Set S(2,78)=1220612927,S(2,79)=3339683548,S(2,80)=133810670,S(2,81)=1090789135,S(2,82)=1078426020,S(2,83)=1569222167
	Set S(2,84)=845107691,S(2,85)=3583754449,S(2,86)=4072456591,S(2,87)=1091646820,S(2,88)=628848692,S(2,89)=1613405280
	Set S(2,90)=3757631651,S(2,91)=526609435,S(2,92)=236106946,S(2,93)=48312990,S(2,94)=2942717905,S(2,95)=3402727701
	Set S(2,96)=1797494240,S(2,97)=859738849,S(2,98)=992217954,S(2,99)=4005476642,S(2,100)=2243076622,S(2,101)=3870952857
	Set S(2,102)=3732016268,S(2,103)=765654824,S(2,104)=3490871365,S(2,105)=2511836413,S(2,106)=1685915746,S(2,107)=3888969200
	Set S(2,108)=1414112111,S(2,109)=2273134842,S(2,110)=3281911079,S(2,111)=4080962846,S(2,112)=172450625,S(2,113)=2569994100
	Set S(2,114)=980381355,S(2,115)=4109958455,S(2,116)=2819808352,S(2,117)=2716589560,S(2,118)=2568741196,S(2,119)=3681446669
	Set S(2,120)=3329971472,S(2,121)=1835478071,S(2,122)=660984891,S(2,123)=3704678404,S(2,124)=4045999559,S(2,125)=3422617507
	Set S(2,126)=3040415634,S(2,127)=1762651403,S(2,128)=1719377915,S(2,129)=3470491036,S(2,130)=2693910283,S(2,131)=3642056355
	Set S(2,132)=3138596744,S(2,133)=1364962596,S(2,134)=2073328063,S(2,135)=1983633131,S(2,136)=926494387,S(2,137)=3423689081
	Set S(2,138)=2150032023,S(2,139)=4096667949,S(2,140)=1749200295,S(2,141)=3328846651,S(2,142)=309677260,S(2,143)=2016342300
	Set S(2,144)=1779581495,S(2,145)=3079819751,S(2,146)=111262694,S(2,147)=1274766160,S(2,148)=443224088,S(2,149)=298511866
	Set S(2,150)=1025883608,S(2,151)=3806446537,S(2,152)=1145181785,S(2,153)=168956806,S(2,154)=3641502830,S(2,155)=3584813610
	Set S(2,156)=1689216846,S(2,157)=3666258015,S(2,158)=3200248200,S(2,159)=1692713982,S(2,160)=2646376535,S(2,161)=4042768518
	Set S(2,162)=1618508792,S(2,163)=1610833997,S(2,164)=3523052358,S(2,165)=4130873264,S(2,166)=2001055236,S(2,167)=3610705100
	Set S(2,168)=2202168115,S(2,169)=4028541809,S(2,170)=2961195399,S(2,171)=1006657119,S(2,172)=2006996926,S(2,173)=3186142756
	Set S(2,174)=1430667929,S(2,175)=3210227297,S(2,176)=1314452623,S(2,177)=4074634658,S(2,178)=4101304120,S(2,179)=2273951170
	Set S(2,180)=1399257539,S(2,181)=3367210612,S(2,182)=3027628629,S(2,183)=1190975929,S(2,184)=2062231137,S(2,185)=2333990788
	Set S(2,186)=2221543033,S(2,187)=2438960610,S(2,188)=1181637006,S(2,189)=548689776,S(2,190)=2362791313,S(2,191)=3372408396
	Set S(2,192)=3104550113,S(2,193)=3145860560,S(2,194)=296247880,S(2,195)=1970579870,S(2,196)=3078560182,S(2,197)=3769228297
	Set S(2,198)=1714227617,S(2,199)=3291629107,S(2,200)=3898220290,S(2,201)=166772364,S(2,202)=1251581989,S(2,203)=493813264
	Set S(2,204)=448347421,S(2,205)=195405023,S(2,206)=2709975567,S(2,207)=677966185,S(2,208)=3703036547,S(2,209)=1463355134
	Set S(2,210)=2715995803,S(2,211)=1338867538,S(2,212)=1343315457,S(2,213)=2802222074,S(2,214)=2684532164,S(2,215)=233230375
	Set S(2,216)=2599980071,S(2,217)=2000651841,S(2,218)=3277868038,S(2,219)=1638401717,S(2,220)=4028070440,S(2,221)=3237316320
	Set S(2,222)=6314154,S(2,223)=819756386,S(2,224)=300326615,S(2,225)=590932579,S(2,226)=1405279636,S(2,227)=3267499572
	Set S(2,228)=3150704214,S(2,229)=2428286686,S(2,230)=3959192993,S(2,231)=3461946742,S(2,232)=1862657033,S(2,233)=1266418056
	Set S(2,234)=963775037,S(2,235)=2089974820,S(2,236)=2263052895,S(2,237)=1917689273,S(2,238)=448879540,S(2,239)=3550394620
	Set S(2,240)=3981727096,S(2,241)=150775221,S(2,242)=3627908307,S(2,243)=1303187396,S(2,244)=508620638,S(2,245)=2975983352
	Set S(2,246)=2726630617,S(2,247)=1817252668,S(2,248)=1876281319,S(2,249)=1457606340,S(2,250)=908771278,S(2,251)=3720792119
	Set S(2,252)=3617206836,S(2,253)=2455994898,S(2,254)=1729034894,S(2,255)=1080033504
	Set S(3,0)=976866871,S(3,1)=3556439503,S(3,2)=2881648439,S(3,3)=1522871579,S(3,4)=1555064734,S(3,5)=1336096578
	Set S(3,6)=3548522304,S(3,7)=2579274686,S(3,8)=3574697629,S(3,9)=3205460757,S(3,10)=3593280638,S(3,11)=3338716283
	Set S(3,12)=3079412587,S(3,13)=564236357,S(3,14)=2993598910,S(3,15)=1781952180,S(3,16)=1464380207,S(3,17)=3163844217
	Set S(3,18)=3332601554,S(3,19)=1699332808,S(3,20)=1393555694,S(3,21)=1183702653,S(3,22)=3581086237,S(3,23)=1288719814
	Set S(3,24)=691649499,S(3,25)=2847557200,S(3,26)=2895455976,S(3,27)=3193889540,S(3,28)=2717570544,S(3,29)=1781354906
	Set S(3,30)=1676643554,S(3,31)=2592534050,S(3,32)=3230253752,S(3,33)=1126444790,S(3,34)=2770207658,S(3,35)=2633158820
	Set S(3,36)=2210423226,S(3,37)=2615765581,S(3,38)=2414155088,S(3,39)=3127139286,S(3,40)=673620729,S(3,41)=2805611233
	Set S(3,42)=1269405062,S(3,43)=4015350505,S(3,44)=3341807571,S(3,45)=4149409754,S(3,46)=1057255273,S(3,47)=2012875353
	Set S(3,48)=2162469141,S(3,49)=2276492801,S(3,50)=2601117357,S(3,51)=993977747,S(3,52)=3918593370,S(3,53)=2654263191
	Set S(3,54)=753973209,S(3,55)=36408145,S(3,56)=2530585658,S(3,57)=25011837,S(3,58)=3520020182,S(3,59)=2088578344
	Set S(3,60)=530523599,S(3,61)=2918365339,S(3,62)=1524020338,S(3,63)=1518925132,S(3,64)=3760827505,S(3,65)=3759777254
	Set S(3,66)=1202760957,S(3,67)=3985898139,S(3,68)=3906192525,S(3,69)=674977740,S(3,70)=4174734889,S(3,71)=2031300136
	Set S(3,72)=2019492241,S(3,73)=3983892565,S(3,74)=4153806404,S(3,75)=3822280332,S(3,76)=352677332,S(3,77)=2297720250
	Set S(3,78)=60907813,S(3,79)=90501309,S(3,80)=3286998549,S(3,81)=1016092578,S(3,82)=2535922412,S(3,83)=2839152426
	Set S(3,84)=457141659,S(3,85)=509813237,S(3,86)=4120667899,S(3,87)=652014361,S(3,88)=1966332200,S(3,89)=2975202805
	Set S(3,90)=55981186,S(3,91)=2327461051,S(3,92)=676427537,S(3,93)=3255491064,S(3,94)=2882294119,S(3,95)=3433927263
	Set S(3,96)=1307055953,S(3,97)=942726286,S(3,98)=933058658,S(3,99)=2468411793,S(3,100)=3933900994,S(3,101)=4215176142
	Set S(3,102)=1361170020,S(3,103)=2001714738,S(3,104)=2830558078,S(3,105)=3274259782,S(3,106)=1222529897,S(3,107)=1679025792
	Set S(3,108)=2729314320,S(3,109)=3714953764,S(3,110)=1770335741,S(3,111)=151462246,S(3,112)=3013232138,S(3,113)=1682292957
	Set S(3,114)=1483529935,S(3,115)=471910574,S(3,116)=1539241949,S(3,117)=458788160,S(3,118)=3436315007,S(3,119)=1807016891
	Set S(3,120)=3718408830,S(3,121)=978976581,S(3,122)=1043663428,S(3,123)=3165965781,S(3,124)=1927990952,S(3,125)=4200891579
	Set S(3,126)=2372276910,S(3,127)=3208408903,S(3,128)=3533431907,S(3,129)=1412390302,S(3,130)=2931980059,S(3,131)=4132332400
	Set S(3,132)=1947078029,S(3,133)=3881505623,S(3,134)=4168226417,S(3,135)=2941484381,S(3,136)=1077988104,S(3,137)=1320477388
	Set S(3,138)=886195818,S(3,139)=18198404,S(3,140)=3786409000,S(3,141)=2509781533,S(3,142)=112762804,S(3,143)=3463356488
	Set S(3,144)=1866414978,S(3,145)=891333506,S(3,146)=18488651,S(3,147)=661792760,S(3,148)=1628790961,S(3,149)=3885187036
	Set S(3,150)=3141171499,S(3,151)=876946877,S(3,152)=2693282273,S(3,153)=1372485963,S(3,154)=791857591,S(3,155)=2686433993
	Set S(3,156)=3759982718,S(3,157)=3167212022,S(3,158)=3472953795,S(3,159)=2716379847,S(3,160)=445679433,S(3,161)=3561995674
	Set S(3,162)=3504004811,S(3,163)=3574258232,S(3,164)=54117162,S(3,165)=3331405415,S(3,166)=2381918588,S(3,167)=3769707343
	Set S(3,168)=4154350007,S(3,169)=1140177722,S(3,170)=4074052095,S(3,171)=668550556,S(3,172)=3214352940,S(3,173)=367459370
	Set S(3,174)=261225585,S(3,175)=2610173221,S(3,176)=4209349473,S(3,177)=3468074219,S(3,178)=3265815641,S(3,179)=314222801
	Set S(3,180)=3066103646,S(3,181)=3808782860,S(3,182)=282218597,S(3,183)=3406013506,S(3,184)=3773591054,S(3,185)=379116347
	Set S(3,186)=1285071038,S(3,187)=846784868,S(3,188)=2669647154,S(3,189)=3771962079,S(3,190)=3550491691,S(3,191)=2305946142
	Set S(3,192)=453669953,S(3,193)=1268987020,S(3,194)=3317592352,S(3,195)=3279303384,S(3,196)=3744833421,S(3,197)=2610507566
	Set S(3,198)=3859509063,S(3,199)=266596637,S(3,200)=3847019092,S(3,201)=517658769,S(3,202)=3462560207,S(3,203)=3443424879
	Set S(3,204)=370717030,S(3,205)=4247526661,S(3,206)=2224018117,S(3,207)=4143653529,S(3,208)=4112773975,S(3,209)=2788324899
	Set S(3,210)=2477274417,S(3,211)=1456262402,S(3,212)=2901442914,S(3,213)=1517677493,S(3,214)=1846949527,S(3,215)=2295493580
	Set S(3,216)=3734397586,S(3,217)=2176403920,S(3,218)=1280348187,S(3,219)=1908823572,S(3,220)=3871786941,S(3,221)=846861322
	Set S(3,222)=1172426758,S(3,223)=3287448474,S(3,224)=3383383037,S(3,225)=1655181056,S(3,226)=3139813346,S(3,227)=901632758
	Set S(3,228)=1897031941,S(3,229)=2986607138,S(3,230)=3066810236,S(3,231)=3447102507,S(3,232)=1393639104,S(3,233)=373351379
	Set S(3,234)=950779232,S(3,235)=625454576,S(3,236)=3124240540,S(3,237)=4148612726,S(3,238)=2007998917,S(3,239)=544563296
	Set S(3,240)=2244738638,S(3,241)=2330496472,S(3,242)=2058025392,S(3,243)=1291430526,S(3,244)=424198748,S(3,245)=50039436
	Set S(3,246)=29584100,S(3,247)=3605783033,S(3,248)=2429876329,S(3,249)=2791104160,S(3,250)=1057563949,S(3,251)=3255363231
	Set S(3,252)=3075367218,S(3,253)=3463963227,S(3,254)=1469046755,S(3,255)=985887462
	For i=0:1:3 For j=0:1:255 If S(i,j)>2147483647 Set S(i,j)=S(i,j)-4294967296
	Set P(0)=608135816,P(1)=2242054355,P(2)=320440878,P(3)=57701188,P(4)=2752067618,P(5)=698298832
	Set P(6)=137296536,P(7)=3964562569,P(8)=1160258022,P(9)=953160567,P(10)=3193202383,P(11)=887688300
	Set P(12)=3232508343,P(13)=3380367581,P(14)=1065670069,P(15)=3041331479,P(16)=2450970073,P(17)=2306472731
	For i=0:1:17 If P(i)>2147483647 Set P(i)=P(i)-4294967296
	Quit
TestString(s)	
	New Key,String,t1,t2,t3,t4
	New E,D
	Set String=$Get(s)
	Set Key="Dog food is good for you, it makes you healthy and shiny too (Iggy Pop)"
	If $Get(String)="" {
	           Set String="Blowfish is a symmetric block cipher that can be used as a drop-in replacement for DES or IDEA. "
	              _"It takes a variable-length key, from 32 bits to 448 bits, making it ideal for both domestic and exportable use. "
	              _"Blowfish was designed in 1993 by Bruce Schneier as a fast, free alternative to existing encryption algorithms. "
	              _"Since then it has been analyzed considerably, and it is slowly gaining acceptance as a strong encryption algorithm. "
	              _"Blowfish is unpatented and license-free, and is available free for all uses."
	}
	Set t1=$zh
	Set E=$$EncryptString(String,Key)
	Set t2=$zh
	;Write "E=",E,!
	Set t3=$zh
	Set D=$$DecryptString(E,Key)
	Set t4=$zh
	;Write "D=",D,!
	If D'=String Write "*** ERROR ****",!,String,!,"E=",E,!,"D=",D,!
	Write "Encryption "_$Length(String)_" chars : ",t2-t1," s.",!
	Write "Decryption "_$Length(E)_" bytes : ",t4-t3," s.",!
	Quit
TestFile
	New Key,String,t1,t2,t3,t4
	New E,D,F1,F2,F3
	Set Key="Pecunia non olet"
	Set F1=$Piece($ZUtil(86),"*",1) ; Current configuration file
	Set F2=$Piece(F1,"\",1,$Length(F1,"\")-1)_"\md5.enc"
	Set F3=$Piece(F1,"\",1,$Length(F1,"\")-1)_"\md5.dec"
	Set t1=$zh
	Do EncryptFile(F1,F2,Key)
	Set t2=$zh
	Set t3=$zh
	Do DecryptFile(F2,F3,Key)
	Set t4=$zh
	Write "Encryption "_$ZUtil(140,1,F1)_" bytes : ",t2-t1," s.",!
	Write "Decryption "_$ZUtil(140,1,F2)_" bytes : ",t4-t3," s.",!
	;
	Quit
TestBytes
	New Key,String,t1,t2,t3,t4,S,P,Bytes,i
	New E,D,F1,F2,F3
	Set (E,D)=""
	Set Key="hebban olla uogala nestas bigunnan hinase hic enda thu"
	Do InitialiseKey(Key)
	Set String="ABCDEFGH"
	For i=0:1:7 Set Bytes(i)=$Ascii(String,i+1)
	Set t1=$zh
	Do EncryptBytes(.Bytes)
	Set t2=$zh
	For i=0:1:7 Set E=E_$Char(Bytes(i))
	Set t3=$zh
	Do DecryptBytes(.Bytes)
	Set t4=$zh
	For i=0:1:7 Set D=D_$Char(Bytes(i))
	If D'=String Write "**ERROR** String=",String," D=",D,!
	Write "Encryption: ",t2-t1," s.",!
	Write "Decryption: ",t4-t3," s.",!
	Quit
]]></Routine>


<Routine name="%ZAPM.bs.BSCmail" type="MAC" languagemode="0"><![CDATA[
%BSCmail ;ПОЧТОВЫЕ ОПЕРАЦИИ И СЕРВЕР FTP
 ;       
 ;  Copyright (C) Serge W. Mikhaylenko
 ;  All Rights Reserved
 Q
ADDNEWMAIL(BSLOGIN,OT,MSG,SUbg)
 S MDEAM=$$MainServerSMTP^%ZAPM.bs.BSvdaMAIL I MDEAM="" Q  //ПОЧТОВЫХ СЕРВЕРОВ НЕТ
 S otkogo=OT_"@"_MDEAM
 S komu=BSLOGIN_"@"_MDEAM
 I $$SMTP^%ZAPM.bs.BSvdaMAIL(MDEAM,MSG,otkogo,komu,$G(SUbg,"Администратор ИнфоПортала приветствует Вас !"))
 Q
FirstMail() Q "Добро пожаловать в ИП !!!!"
 
SMTP //  ; Compiled March 14, 2003 16:27:53 ; 10:23   17.03.2003
 // Instantiate a class
 S CUS=$I
 set s=##class(%Net.SMTP).%New()
 set s.smtpserver="ivcmsw"         // Specify SMTP server name.
 set s.timezone="-0400"  // Timezone by Grinwitch
 set m=##class(%Net.MailMessage).%New()
 set m.From="MSW@ivcmsw"        // From
 
         do m.To.Insert("SSS1@ivcmsw") // List of emails to send this mail
       ;  do m.To.Insert("IVCMSW@developer.ru")
 
 set m.Subject="!!!"     // Subject
 // Charset specification
 //set m.Charset="iso-8859-1"
 // Text
 
 do m.TextData.Write("Привет!!!.")
 do m.TextData.Write($char(13,10))
 do m.TextData.Write("!!!!!!!!!!!!!!!Ты что делаешь ?")
 do m.TextData.Write($char(13,10))
 
 // Attachments
 //set status=m.AttachFile("D:\!\","Onvv.t2e1")
 // Send letter
 
 set status=s.Send(m)
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),!
 do m.%Close()
 do s.%Close()
 U CUS I (status) W !,"OK"
 W !!!
 quit
 
POP3
 new mailserver,status,from,to,date,subject,messagesize,m,hdrs,key,mailMsg
 set mailserver=##class(%Net.POP3).%New()
 // Directory for attached documents
 set mailserver.AttachDir="d:\attach\"  ; need terminating \
 // if StoreAttachToFile=0 - then data attached will be saved in database
 set mailserver.StoreAttachToFile=1
 write !,"Calling Connect"
 // Connect("server","username","password")
 set status=mailserver.Connect("server","user1","pass1")
 write !,"Calling FetchMessage"
 // This method retrieves a single message. MessageNumber must be a valid message number and the message must not be currently marked for deletion.
 set status=mailserver.FetchMessage(MessageNumber,.from,.to,.date,.subject,.messagesize,.hdrs,.mailMsg,0)
 write !,"from="_from
 write !,"to="_to
 write !,"date="_date
 write !,"subject="_subject
 write !,"messagesize="_messagesize
 write !,"Closing mailserver="_mailserver.%Close()
 write !,"Closing mailMsg="_mailMsg.%Close()
 quit
 
 ; display mail but don't delete from mailbox
t6(MM) ;
 new mailserver,status,from,to,date,subject,messagesize,m,hdrs,key,mailMsg
 set mailserver=##class(%Net.POP3).%New()
 set mailserver.AttachDir="d:\!\1\"  ; need terminating \
 set mailserver.Debug=0
 set mailserver.StoreAttachToFile=1
 write !,"Calling Connect"
 set status=mailserver.Connect("IVCMSW","SSS1@IVCMSW","S")
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),!
 write !,"Calling FetchMessage"
 set status=mailserver.FetchMessage(MM,.from,.to,.date,.subject,.messagesize,.hdrs,.mailMsg,0)
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),! write "Closing p="_mailserver.%Close() quit
 write !,"from="_from
 write !,"to="_to
 write !,"date="_date
 write !,"subject="_subject
 write !,"messagesize="_messagesize
 do DumpMessage(mailMsg)
 write !,"Closing mailserver="_mailserver.%Close()
 write !,"Closing mailMsg="_mailMsg.%Close()
 quit
DumpMessage(msg)
 new i,index,value
 if msg.IsMultiPart do  quit
 . for i=1:1:msg.Parts.Count() w !,"Dumping part "_i do DumpMessage(msg.Parts.GetAt(i))
 s index=""  f  s value=msg.Headers.GetNext(.index) q:index=""  w !,"Headers("_index_")="_value
 if msg.IsBinary do
 . write !,"msg is binary, filename="_msg.FileName_" filename="_msg.GetAttribute("content-disposition","filename")
 else  do
 . w !,"Dumping text msg Filename="_msg.FileName_" filename="_msg.GetAttribute("content-disposition","filename"),!
 . set stream=msg.TextData
 . do stream.Rewind()
 . new len,line
 . for  set len=32763,line=stream.Read(.len) do  quit:stream.AtEnd
 . . write line
 quit
 
testmailsend3 ;
 ;  Replace information marked with [[ ]]
 set s=##class(%Net.SMTP).%New()
 set s.smtpserver="SMTP server name"
 set s.timezone="-0400" //  may remove this line to get Universal Time
 set m=##class(%Net.MailMessage).%New()
 set m.From="test@company.com"
 do m.To.Insert("receiver@another.com")
 write !,"s.port="_s.port
 write !,"s.localhost="_s.localhost
 set m.Subject="Sent by Cache' mail"
 do m.TextData.Write("This is the main body.")
 do m.TextData.Write($char(13,10))
 do m.TextData.Write("This is the second line.")
 do m.TextData.Write($char(13,10))
 set status=m.AttachFile("c:\winnt","notepad.exe")
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),! do m.%Close() do s.%Close() q
 set status=m.AttachFile("d:\temp","test.txt")
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),! do m.%Close() do s.%Close() q
 set nestedm=m.AttachNewMessage()
 set status=nestedm.AttachFile("c:\cachesys\bin","test.bin")
 do nestedm.%Close()
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),! do m.%Close() do s.%Close() q
 write !,"m.Parts.Count()="_m.Parts.Count()
 write !,"m.Parts.GetAt(3).Parts.GetAt(1).FileName="_m.Parts.GetAt(3).Parts.GetAt(1).FileName
 write !,"m.Parts.GetAt(3).Parts.Count()="_m.Parts.GetAt(3).Parts.Count()
 set status=s.Send(m)
 if ('status) do DecomposeStatus^%apiOBJ(status,.err) write !,err(err),! do m.%Close() do s.%Close() q
 do m.%Close()
 do s.%Close()
 q
FTP //СЕАНС ЗАГРУЗКИ ФАЙЛА
 Set ftp=##class(%Net.FtpSession).%New()
 //ftp.Connect("nameserver","name","pass","port")
 If 'ftp.Connect("127.0.0.1","sinxron","snx",22) Write "Not connected",! Quit
 Write "Ftp server messsage: ",ftp.ReturnMessage,!
 
 If 'ftp.System() W "No answer System" G FTPSTOP
 Write "Ftp server messsage: ",ftp.ReturnMessage,!
 
 If 'ftp.Binary() Write "Can not swap to binary mode",! G FTPSTOP
 Write "Mode now: ",ftp.Type,!
 /*/ ПРОЧИТАТЬ ДИРЕКТОРИЮ
 Set stream=##class(%GlobalCharacterStream).%New()
 W ! IF 'ftp.List("CLIeNT\*.F*",.stream) W !,"Error List" G FTPSTOP
 IF stream.Size>0 D
 .Write "-------- Length of file received: ",stream.Size," ------",!
 . new len,line
 . for  set len=32763,line=stream.Read(.len) do  quit:stream.AtEnd
 .. write line
 .Write !," -------- End of stream -----",!
 D stream.%Close() ;*/
 
 /*/ДОБАВИТЬ ФАЙЛ
 Set stream=##class(%GlobalCharacterStream).%New()
 for I=1:1:100 D stream.WriteLine(I_" ASASAS")
 If 'ftp.Append("CLIENT\AAA.TXT",stream) Write "Failed to PUT file",! G FTPSTOP
 D stream.%Close() ;*/
 
 /*/ВОЗВРАТИТЬ ФАЙЛ
 Set stream=##class(%GlobalCharacterStream).%New()
 If 'ftp.Retrieve("CLIENT\mAIN.FRM",stream) Write "Failed to get file",! G FTPSTOP
 IF stream.Size>0 D
 .Write "-------- Length of file received: ",stream.Size," ------",!
 . new len,line
 . for  set len=32763,line=stream.Read(.len) do  quit:stream.AtEnd
 .. write line
 .Write !," -------- End of stream -----",!!!!
 D stream.%Close() ;*/
FTPSTOP If 'ftp.Logout() S ER="Failed to logout"
 Do ftp.%Close()
 Q
LoginFtp(P0,P1) //ОТРАБОТКА ЗАПРОСОВ СЕРВЕРА
 N US,A
 I P0="ddr-adm",P1="shutdown_SERVER" S P4="EXIT" Q 0  //ОСТАНОВ СЕРВЕРА
 S P4="NO",P3=""  S $ZT="LoginError"
 I '$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aft") Q  //Cервер отключен!
 I P1="" Q P3
 I $P(P0,"-")="ddr" D  Q P3
 .S US=$P(P0,"-",2,99)      I US="" Q
 .S BDUSE=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")") I '$D(@BDUSE@(US)) Q
 . N GetAccLU I P1=$ZCRC(US,7),$$GetAcc^%ZAPM.bs.BSC4cfgP(US,"Aftpddr") S P4="YES",P3=$$DDDR^%ZAPM.bs.BSCmDDR_US   //ПОЛЬЗОВАТЕЛЬ ДОМАШНЕГО КАТАЛОГА
 .S BDSES=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")") I '$D(@BDSES@($P(P1,"-"))) Q
 .S BSSES=$P(P1,"-")
 .I $G(@BDSES@(BSSES,"NM"))=US,$G(@BDSES@(BSSES,"CHR"))="" S P4="YES",P3=$$GetVar^%ZAPM.bs.BSC4("RootDir-"_$P(P1,"-",2,99),"") //ОТДАТЬ ПРОИЗВОЛЬНЫЙ КАТАЛОГ
 S A=$P($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Aftpsinx"),"//",2)
 I P0=$P($P(A,"@"),":"),P1=$P($P(A,"@"),":",2) S P4="YES" Q $$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSC4SNX.Par","Rpool") //КАТАЛОГ СИНХРОНИЗАЦИИ
 Q P3
LoginError Q P3
STOPFTP() //СЕАНС ЗАКРЫТИЯ СЕРВЕРА - эмуляция спец-регистрации
 Set ftp=##class(%Net.FtpSession).%New(),$ZT="STOPERR"
 If 'ftp.Connect($$ipS^%ZAPM.bs.BSCp2,"ddr-adm","shutdown_SERVER",22) Write "Not connected",! Quit 0
STOPERR W !,"OK" Q 1
 ;
 ;
STR2MASold(MM,M,BK)  //```КАК СОБРАТЬ МАССИВ ИЗ ПОТОКА ///  //РАЗОБРАТЬ МАССИВ MM ПО РАЗДЕЛИТЕЛЮ BK. РЕЗУЛЬТАТ В M
 N I,L,II S I="",L=0 F  S I=$O(MM(I)) Q:I=""  D
 .I $G(M(L))'="" S MM(I)=$G(M(L))_MM(I) K M(L)
 .F II=1:1:$L(MM(I),BK) S L=L+1,M(L)=$P(MM(I),BK,II) I $G(M(L))="" K M(L)
 Q
STR2MAS(MM,M,BK)  //РАЗОБРАТЬ МАССИВ MM ПО РАЗДЕЛИТЕЛЮ BK. РЕЗУЛЬТАТ В M
 N I,L,II S I="",L=0 F  S I=$O(MM(I)) Q:I=""  D
 .I $G(M(L))'="" S MM(I)=$G(M(L))_MM(I) K M(L) S L=L-1
 .F II=1:1:$L(MM(I),BK) S L=L+1,M(L)=$P(MM(I),BK,II) I $G(M(L))="" K M(L)
 Q 
FtpGD(S,N,Pa,Po,D,M) //ПРОЧИТАТЬ ДИРЕКТОРИЮ D в массив M
 N I,line,len,MM,II,MST,L
 Set ftp=##class(%Net.FtpSession).%New(),ER=0,BK=$C(13,10),MST=32000
 If 'ftp.Connect(S,N,Pa,Po)  S ER="Not connected" Q
 Set stream=##class(%GlobalCharacterStream).%New()
 IF 'ftp.List(D,.stream) S ER="Error List" G FTPSTOP
 IF stream.Size>0 D
 .F I=0:MST:stream.Size D
 ..s len=MST,line=stream.Read(.len)
 ..s MM(I)=line
 ;S I="",L=0 F  S I=$O(MM(I)) Q:I=""  D  //```КАК СОБРАТЬ МАССИВ ИЗ ПОТОКА
 ;.I $G(M(L))'="" S MM(I)=$G(M(L))_MM(I) K M(L)
 ;.F II=1:1:$L(MM(I),BK) S L=L+1,M(L)=$P(MM(I),BK,II) I $G(M(L))="" K M(L)
 D STR2MAS(.MM,.M,BK)
 D stream.%Close()
 G FTPSTOP
FtpGF(S,N,Pa,Po,F,M) //ПРОЧИТАТЬ ФАЙЛ .F в массив .M
 N I,line,len,f,MST
 Set ftp=##class(%Net.FtpSession).%New(),ER=0,MST=32000
 If 'ftp.Connect(S,N,Pa,Po)  S ER="Not connected" Q
 s f="" F  S f=$O(F(f)) Q:f=""  D
 .Set stream=##class(%GlobalCharacterStream).%New()
 .If 'ftp.Retrieve(F(f),stream) S ER="Failed to GET file" G FTPSTOP
 .IF stream.Size>0 D
 ..F I=0:MST:stream.Size D
 ...s len=MST,line=stream.Read(.len)
 ...s M(F(f),I)=line
 .D stream.%Close()
 G FTPSTOP
FtpAF(S,N,Pa,Po,FN,DF,AP) //ДОБАВИТЬ ФАЙЛ FN в директорию DF  AP=1- добавлять  0-перезаписывать
 N I,line,len,Mas
 Set ftp=##class(%Net.FtpSession).%New(),ER=0
 If 'ftp.Connect(S,N,Pa,Po)  S ER="Not connected" Q
 Set stream=##class(%GlobalCharacterStream).%New()
 D File2Arr^%ZAPM.bs.BSCEXE(FN,.Mas)
 S I="" F  S I=$O(Mas(I)) Q:I=""  D stream.Write(Mas(I))
 I $G(AP)=0 If 'ftp.Delete(DF_"\"_$P(FN,"\",$L(FN,"\")))
 If 'ftp.Append(DF_"\"_$P(FN,"\",$L(FN,"\")),stream) S ER="Failed to APPEND file" G FTPSTOP
 D stream.%Close()
 G FTPSTOP
SERV4URL(U) Q $P($p(U,"://",2),"/",1)
HTTP(url,OK,OUT,ProxS,ProxP) //СОДЕРЖАНИЕ сетевого ресурса
 ; OK=1 возвратить только заголовок в OUT("Header"
 ; OK=2 возвратить заголовок и все данные в OUT("Data"
 S $ZT="HTTPER"
 N A,B,I,len,SZ,err,httprequest,Po,content Set httprequest=##class(%Net.HttpRequest).%New(),SZ=32000
 I $G(ProxS)'="" Set http.ProxyServer=ProxS,http.ProxyPort=ProxP
 S A=$P($p(url,"://",2),"/",1) I A="" Q "ERROR! SERVERNAME"
 I A[":" S Po=$P(A,":",2),A=$P(A,":",1) Set httprequest.Port=Po
 Set httprequest.Server=A
 S A="/"_$P($p(url,"://",2),"/",2,991)
 I A["?" D
 .S B=$P(A,"?",2,999)
 .F I=1:1 Q:$P(B,"&",I,I+1)=""   Do httprequest.InsertFormData($P($P(B,"&",I),"="),$P($P(B,"&",I),"=",2))
 .Do httprequest.Post($P(A,"?",1))
 E  Do httprequest.Get(A)
 S A=httprequest.HttpResponse.StatusLine
 I $P(A," ",2)'=200 G HTTPS
 ;Do httprequest.HttpResponse.OutputToDevice()
 I $G(OK)'="" S B="" F  S B=httprequest.HttpResponse.GetNextHeader(B) Q:B=""  S OUT("Header",B)=httprequest.HttpResponse.GetHeader(B)
 I $G(OK)=2 If httprequest.HttpResponse.Data.Size>0 D
 .F I=0:SZ:httprequest.HttpResponse.Data.Size D
 ..s len=SZ,B=httprequest.HttpResponse.Data.Read(.len)
 ..s OUT("Data",I)=B
HTTPS Do httprequest.%Close() ;ZW OUT
 q A
HTTPER I $ZE["<INVALID OREF>" Q "ERROR! SERVER NO ACCESS? "_$ZE
 do DecomposeStatus^%apiOBJ(%objlasterror,.err) 
 Q $G(err(err))
http1 ;ПРИМЕР КОГДА ТЫ ВОЗВРАЩАЕШЬ СТАТИКУ ИЗ  http://mswdell/iss/iss.htm
 Set httprequest=##class(%Net.HttpRequest).%New()
 Set httprequest.Server="MSWDELL"
 Do httprequest.Get("/iss/iss.htm")
 ;Do httprequest.HttpResponse.OutputToDevice()
 Write httprequest.HttpResponse.StatusLine,$C(13,10)
 If httprequest.HttpResponse.Data.Size>0 Write $C(13,10) Do httprequest.HttpResponse.Data.OutputToDevice()
 Write !
 Do httprequest.%Close()
 q
http2 ;ПРИМЕР КОГДА ТЫ ВОЗВРАЩАЕШЬ ДИНАМИКУ ИЗ  http://mswdell/scripts/mgwms32.dll?BSG=Phone&WEBPAGE=FRAMES
 S A="/scripts/mgwms32.dll?BSG=B4I&BSDOMAIN=/b4y&BSKNH=001&BSLABEL=LISTREGION^~BSCSVVT&BSROU=GKVV^%ZAPM.bs.BSCSVVT&BStyle=JEANS-"
 Set httprequest=##class(%Net.HttpRequest).%New()
 Set httprequest.Server="MSWDELL"
 ;Do httprequest.InsertFormData("BSG","Phone")
 ;Do httprequest.InsertFormData("WEBPAGE","FRAMES")
 ;Do httprequest.Post("/scripts/mgwms32.dll")
 D
 .S B=$P(A,"?",2,999)
 .F I=1:1 Q:$P(B,"&",I,I+1)=""   Do httprequest.InsertFormData($P($P(B,"&",I),"="),$P($P(B,"&",I),"=",2))
 .Do httprequest.Post($P(A,"?",1))
 S SZ=32000
 ;Do httprequest.HttpResponse.OutputToDevice()
  If httprequest.HttpResponse.Data.Size>0 D
 .F I=0:SZ:httprequest.HttpResponse.Data.Size D
 ..s len=SZ,B=httprequest.HttpResponse.Data.Read(.len)
 ..W !,B
 Do httprequest.%Close()
 q
http3
 Set http=##class(%Net.HttpRequest).%New()
 ;Set http.ProxyServer="192.168.6.1"
 ;Set http.ProxyPort=8080
 ;;;Set http.Server="www.intersystems.ru"
 ;S url="www.intersystems.ru"
 s url="http://WEBSERVER/iss/iss.htm"
 Do http.Get(url)
  S siz=http.HttpResponse.Data.Size
 S b=32000
 IF siz>0 D
 .F I=0:b:siz D
 ..s len=b,z=http.HttpResponse.Data.Read(.len)
 ..s MM(I)=z
 Do http.HttpResponse.OutputToDevice()
 Q
 ////////////////// ПОДРОБНЕЕ В ДОКУМЕНТАЦИИ ПО КЛАССАМ %Net.HttpRequest %Net.HttpResponse ////////////////////////////////////////////////
 ///////////// ЗАХОДИШЬ В ОБЪЕКТ-АРХИТЕКТОР В ОБЛАСТЬ %SYS, НАХОДИШЬ ЭТИ КЛАССЫ И ПРАВОЙ КНОПКОЙ ЗАГРУЖАЕШЬ - Показать документацию класса
 //ТЕСТЫ
1 K M D FtpGD^%ZAPM.bs.BSCmail("127.0.0.1","sinxron","snx",22,"\",.M) ZW M W !!! Q
2 K M S F(1)="home_20031004_160107.rar",F(2)="home_20031007_000004.rar"
  D FtpGF^%ZAPM.bs.BSCmail("127.0.0.1","sinxron","snx",22,.F,.M) ZW M W "OK",!!! Q
3 ;D File2Arr^%ZAPM.bs.BSCEXE("D:\_AUDIO\np\playlist.m3u",.Mas) ZW Mas
 D FtpAF^%ZAPM.bs.BSCmail("127.0.0.1","sinxron","snx",22,"G:\MSW\TheBatBackCopy\20031006.tbk","")
 W !!! Q
 ///////////////////////////////////////////////// http ////////////////////////////////// для ССС /////////////////////
 //тест для HTTP
4 N AA,A W $$HTTP^%ZAPM.bs.BSCmail("http://LOCALHOST/vv/u/REPORT/MOL/FULL/Spravka.xls",2,.AA) ;ПОЛУЧИТЬ ОТ СЕРВЕРА
 ;M A=AA("Data") W !,$$Arr2File^%ZAPM.bs.BSCEXE(.A,"C:\!\1.xls") ;И СОХРАНИТЬ НА ДИСКЕ
 ZW AA W !!!!
 q
5 K AA,A,AAA W $$HTTP^%ZAPM.bs.BSCmail("http://home:81/iportal/wakka.php?wakka=GCASUVV/files.xml&action=download&file=SEGAL04.zip",2,.AA),!! 
 ;K ^%ZZZ M ^%ZZZ=AA("Header")   ;M AAA=AA("Data") D STR2MAS(.AAA,.A,$C(13,10)) ZW A 
 q
51 K AA,A,AAA 
 W $$HTTP^%ZAPM.bs.BSCmail("http://home/scripts/mgwms32.dll?BSG=B4I&BSAA=_book-2\home\proverbs.zip&BSDOMAIN=/b4y&BSGRANT=DEMIURG&BSLABEL=RESBOOKA^~BSCbook&BSLNG=RUS&BSLOGIN=Styx&BSLOGINDFLT=Styx&BSNSP=~SYS&BSREF=1&BSSES=47.7997567&BSTOP=ПОИСК&BSaX=1&BSdebug=1&BSstr=ПАК&BStyle=GREEN&MGWSTO=300",2,.AA),!!
 ; K ^%ZZZ M ^%ZZZ=AA("Header")  ;D STR2MAS(.AAA,.A,$C(13,10)) ZW A 
 q
 ;http://mswdell/vv/gkvv-doc/img/iss.ico
6 K AA W !,$$HTTP^%ZAPM.bs.BSCmail("http://mswdell:82/vv/gkvv-doc/img/iss.ico",2,.AA),!!!! ZW AA 
 q
7 ;ТЕСТ
 W !,"ПРИВЕТ СЕРГЕЙ !!!!!!"
 W "<form action=""/scripts/mgwms32.dll"" method=""POST"">"
 W "<input type='hidden' name='BSG' value='ZZ1'>"
 W "<input type='hidden' name='BSLABEL' value='WWW1'>"
         W "кТО У АППАРАТА ? <input type=""text"" name=""T1"" size=""28"">"
 w "<input type=""submit"" name=""OK"" value=""ПОСЛАТЬ"">",$c(13,10)
 W "</FORM>"
 Q
AAA ;ДИСПЕТЧЕР
 D %KEY
 I $G(BSLABEL)'="" D @BSLABEL Q  
 Q
%KEY S I="" F  S I=$O(%KEY(I)) Q:I=""  S @I=%KEY(I)
 Q
WWW1 ;
 W "ПРИШЛА ПЕРЕМЕННАЯ ",T1
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCmd5" type="MAC" languagemode="0"><![CDATA[
rhMD5	; Implementation of RFC 1321 MD5 algorithm  ; Compiled January 31, 2005 23:37:32
	; Cache Object Script implementation of RFC 1321 MD5
	; Copyright (C) 2001 COD International BV
	; Naarden, The Netherlands <www.codgroep.nl>. All rights reserved.
	; You are free to use this code in your applications without liability
	; or compensation, but the courtesy of both notification of use and	
	; inclusion of due credit are requested. You must keep this copyright
	; notice intact.
	; It is PROHIBITED to distribute or reproduce this code for profit
	; or otherwise, on any web site, ftp server or BBS, or by any
	; other means, including CD-ROM or other physical media, without the
	; EXPRESS WRITTEN PERMISSION of the copyright holder.
	; Use at your own risk.
	; COD International BV offers no warranty of its fitness for any
	; purpose whatsoever, and accept no liability whatsoever for any
	; loss or damage incurred by its use.
	; If you use it, or found it useful, or can suggest an improvement
	; please let us know at <development@codgroep.nl>.
	; Authors: Gertjan Klein & Herman Slagman
	; RFC 1312 the MD5 message-digest algorithm.
	; The algorithm takes as input a message of arbitrary length and produces
	; as output a 128-bit "fingerprint" or "message digest" of the input.
	; It is conjectured that it is computationally infeasible to produce
	; two messages having the same message digest, or to produce any
	; message having a given prespecified target message digest. The MD5
	; algorithm is intended for digital signature applications, where a
	; large file must be "compressed" in a secure manner before being
	; encrypted with a private (secret) key under a public-key cryptosystem
	; such as RSA.
	; Note.
	; Theoretically it has been proven that MD5 has a collision risk, ie two different strings resulting in the same digest,
	; therefore SHA-1 (secure hash algorithm) is recommended for PKCS (RFC 2437 Public Key Cryptography Specification)
	; Restrictions.
	; This code relies heavily on macro preprocessor commands, it should
	; therefor be compiled as a Cache Object Script MAC routine.
	; Based on the RFC's reference implementation written in C
Encrypt(Message)	;
	New i,Result,Digest,Length,Pad,Byte,X,A,B,C,D,NrOfBlocks,j,StartPos,AA,BB,CC,DD,p,Powers
	Do Powers
	; Step 1.
	;   Pad the string until the length is a multiple of 64 bytes minus 8 bytes
	;   The first byte is a 10000000 byte (128) the rest are 00000000 bytes
	Set Length=$Length(Message)*8  ;(In bits)
	Set Digest=Message_$C(128)
	For  Quit:$Length(Digest)#64=56  Set Digest=Digest_$C(0)
	; Step 2.
	;   Append the original length as a 64 bits value
	Set Pad=""
	For i=1:1:8 Set Byte=Length#256,Length=Length\256,Pad=Pad_$Char(Byte)
	Set Digest=Digest_Pad
	; Step 3.
	;   Initialise the MD buffer
	Set A=1732584193 ;$ZHex("67452301")
	Set B=4023233417 ;$ZHex("efcdab89")
	Set C=2562383102 ;$Zhex("98badcfe")
	Set D=271733878 ;$Zhex("10325476")
	; MD5 uses 64 values calculated as followes:
	;   F i=1:1:64 Set T(i)=4294967296*$zabs($zsin(i))\1
	; Step 4.
	;   Process the Message in 16 word blocks (32 bytes)
	Set NrOfBlocks=$Length(Digest)-1\64+1
	For i=0:1:NrOfBlocks-1 Do
	.    ; Copy the Block in 16 X(0-15) words 
	.    Set StartPos=i*64+1
	.    For j=0:1:15 Do
	..        Set p=StartPos+(j*4)
	..        Set X(j)=$Ascii(Digest,p+3)*16777216+($Ascii(Digest,p+2)*65536)+($Ascii(Digest,p+1)*256)+$Ascii(Digest,p)
	.    Set AA=A
	.    Set BB=B
	.    Set CC=C
	.    Set DD=D
	.    ; Round 1
	.    ;    [ABCD  0  7  1]  [DABC  1 12  2]  [CDAB  2 17  3]  [BCDA  3 22  4]
	.    ;    [ABCD  4  7  5]  [DABC  5 12  6]  [CDAB  6 17  7]  [BCDA  7 22  8]
	.    ;    [ABCD  8  7  9]  [DABC  9 12 10]  [CDAB 10 17 11]  [BCDA 11 22 12]
	.    ;    [ABCD 12  7 13]  [DABC 13 12 14]  [CDAB 14 17 15]  [BCDA 15 22 16]
	. 
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(0)+3614090360)#4294967296)*Powers(7)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(0)+3614090360)#4294967296)\Powers(32-7),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(1)+3905402710)#4294967296)*Powers(12)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(1)+3905402710)#4294967296)\Powers(32-12),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(2)+606105819)#4294967296)*Powers(17)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(2)+606105819)#4294967296)\Powers(32-17),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(3)+3250441966)#4294967296)*Powers(22)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(3)+3250441966)#4294967296)\Powers(32-22),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(4)+4118548399)#4294967296)*Powers(7)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(4)+4118548399)#4294967296)\Powers(32-7),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(5)+1200080426)#4294967296)*Powers(12)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(5)+1200080426)#4294967296)\Powers(32-12),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(6)+2821735955)#4294967296)*Powers(17)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(6)+2821735955)#4294967296)\Powers(32-17),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(7)+4249261313)#4294967296)*Powers(22)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(7)+4249261313)#4294967296)\Powers(32-22),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(8)+1770035416)#4294967296)*Powers(7)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(8)+1770035416)#4294967296)\Powers(32-7),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(9)+2336552879)#4294967296)*Powers(12)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(9)+2336552879)#4294967296)\Powers(32-12),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(10)+4294925233)#4294967296)*Powers(17)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(10)+4294925233)#4294967296)\Powers(32-17),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(11)+2304563134)#4294967296)*Powers(22)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(11)+2304563134)#4294967296)\Powers(32-22),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(12)+1804603682)#4294967296)*Powers(7)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),1),$ZBoolean((B),(D),4),7))+X(12)+1804603682)#4294967296)\Powers(32-7),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(13)+4254626195)#4294967296)*Powers(12)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),1),$ZBoolean((A),(C),4),7))+X(13)+4254626195)#4294967296)\Powers(32-12),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(14)+2792965006)#4294967296)*Powers(17)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),1),$ZBoolean((D),(B),4),7))+X(14)+2792965006)#4294967296)\Powers(32-17),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(15)+1236535329)#4294967296)*Powers(22)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),1),$ZBoolean((C),(A),4),7))+X(15)+1236535329)#4294967296)\Powers(32-22),7))))#4294967296)
	. 
	.
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(1)+4129170786)#4294967296)*Powers(5)#4294967296,((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(1)+4129170786)#4294967296)\Powers(32-5),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(6)+3225465664)#4294967296)*Powers(9)#4294967296,((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(6)+3225465664)#4294967296)\Powers(32-9),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(11)+643717713)#4294967296)*Powers(14)#4294967296,((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(11)+643717713)#4294967296)\Powers(32-14),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(0)+3921069994)#4294967296)*Powers(20)#4294967296,((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(0)+3921069994)#4294967296)\Powers(32-20),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(5)+3593408605)#4294967296)*Powers(5)#4294967296,((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(5)+3593408605)#4294967296)\Powers(32-5),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(10)+38016083)#4294967296)*Powers(9)#4294967296,((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(10)+38016083)#4294967296)\Powers(32-9),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(15)+3634488961)#4294967296)*Powers(14)#4294967296,((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(15)+3634488961)#4294967296)\Powers(32-14),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(4)+3889429448)#4294967296)*Powers(20)#4294967296,((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(4)+3889429448)#4294967296)\Powers(32-20),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(9)+568446438)#4294967296)*Powers(5)#4294967296,((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(9)+568446438)#4294967296)\Powers(32-5),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(14)+3275163606)#4294967296)*Powers(9)#4294967296,((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(14)+3275163606)#4294967296)\Powers(32-9),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(3)+4107603335)#4294967296)*Powers(14)#4294967296,((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(3)+4107603335)#4294967296)\Powers(32-14),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(8)+1163531501)#4294967296)*Powers(20)#4294967296,((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(8)+1163531501)#4294967296)\Powers(32-20),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(13)+2850285829)#4294967296)*Powers(5)#4294967296,((A+($ZBoolean($ZBoolean((B),(D),1),$ZBoolean((C),(D),2),7))+X(13)+2850285829)#4294967296)\Powers(32-5),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(2)+4243563512)#4294967296)*Powers(9)#4294967296,((D+($ZBoolean($ZBoolean((A),(C),1),$ZBoolean((B),(C),2),7))+X(2)+4243563512)#4294967296)\Powers(32-9),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(7)+1735328473)#4294967296)*Powers(14)#4294967296,((C+($ZBoolean($ZBoolean((D),(B),1),$ZBoolean((A),(B),2),7))+X(7)+1735328473)#4294967296)\Powers(32-14),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(12)+2368359562)#4294967296)*Powers(20)#4294967296,((B+($ZBoolean($ZBoolean((C),(A),1),$ZBoolean((D),(A),2),7))+X(12)+2368359562)#4294967296)\Powers(32-20),7))))#4294967296)
	. 
	.     
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(5)+4294588738)#4294967296)*Powers(4)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(5)+4294588738)#4294967296)\Powers(32-4),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(8)+2272392833)#4294967296)*Powers(11)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(8)+2272392833)#4294967296)\Powers(32-11),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(11)+1839030562)#4294967296)*Powers(16)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(11)+1839030562)#4294967296)\Powers(32-16),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(14)+4259657740)#4294967296)*Powers(23)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(14)+4259657740)#4294967296)\Powers(32-23),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(1)+2763975236)#4294967296)*Powers(4)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(1)+2763975236)#4294967296)\Powers(32-4),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(4)+1272893353)#4294967296)*Powers(11)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(4)+1272893353)#4294967296)\Powers(32-11),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(7)+4139469664)#4294967296)*Powers(16)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(7)+4139469664)#4294967296)\Powers(32-16),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(10)+3200236656)#4294967296)*Powers(23)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(10)+3200236656)#4294967296)\Powers(32-23),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(13)+681279174)#4294967296)*Powers(4)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(13)+681279174)#4294967296)\Powers(32-4),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(0)+3936430074)#4294967296)*Powers(11)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(0)+3936430074)#4294967296)\Powers(32-11),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(3)+3572445317)#4294967296)*Powers(16)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(3)+3572445317)#4294967296)\Powers(32-16),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(6)+76029189)#4294967296)*Powers(23)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(6)+76029189)#4294967296)\Powers(32-23),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(9)+3654602809)#4294967296)*Powers(4)#4294967296,((A+($ZBoolean($ZBoolean((B),(C),6),(D),6))+X(9)+3654602809)#4294967296)\Powers(32-4),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(12)+3873151461)#4294967296)*Powers(11)#4294967296,((D+($ZBoolean($ZBoolean((A),(B),6),(C),6))+X(12)+3873151461)#4294967296)\Powers(32-11),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(15)+530742520)#4294967296)*Powers(16)#4294967296,((C+($ZBoolean($ZBoolean((D),(A),6),(B),6))+X(15)+530742520)#4294967296)\Powers(32-16),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(2)+3299628645)#4294967296)*Powers(23)#4294967296,((B+($ZBoolean($ZBoolean((C),(D),6),(A),6))+X(2)+3299628645)#4294967296)\Powers(32-23),7))))#4294967296)
	. 
	. 
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(0)+4096336452)#4294967296)*Powers(6)#4294967296,((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(0)+4096336452)#4294967296)\Powers(32-6),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(7)+1126891415)#4294967296)*Powers(10)#4294967296,((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(7)+1126891415)#4294967296)\Powers(32-10),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(14)+2878612391)#4294967296)*Powers(15)#4294967296,((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(14)+2878612391)#4294967296)\Powers(32-15),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(5)+4237533241)#4294967296)*Powers(21)#4294967296,((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(5)+4237533241)#4294967296)\Powers(32-21),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(12)+1700485571)#4294967296)*Powers(6)#4294967296,((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(12)+1700485571)#4294967296)\Powers(32-6),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(3)+2399980690)#4294967296)*Powers(10)#4294967296,((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(3)+2399980690)#4294967296)\Powers(32-10),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(10)+4293915773)#4294967296)*Powers(15)#4294967296,((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(10)+4293915773)#4294967296)\Powers(32-15),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(1)+2240044497)#4294967296)*Powers(21)#4294967296,((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(1)+2240044497)#4294967296)\Powers(32-21),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(8)+1873313359)#4294967296)*Powers(6)#4294967296,((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(8)+1873313359)#4294967296)\Powers(32-6),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(15)+4264355552)#4294967296)*Powers(10)#4294967296,((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(15)+4264355552)#4294967296)\Powers(32-10),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(6)+2734768916)#4294967296)*Powers(15)#4294967296,((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(6)+2734768916)#4294967296)\Powers(32-15),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(13)+1309151649)#4294967296)*Powers(21)#4294967296,((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(13)+1309151649)#4294967296)\Powers(32-21),7))))#4294967296)
	.   Set A=((B+(($ZBoolean(((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(4)+4149444226)#4294967296)*Powers(6)#4294967296,((A+($ZBoolean((C),$ZBoolean((B),(D),11),6))+X(4)+4149444226)#4294967296)\Powers(32-6),7))))#4294967296)
	.   Set D=((A+(($ZBoolean(((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(11)+3174756917)#4294967296)*Powers(10)#4294967296,((D+($ZBoolean((B),$ZBoolean((A),(C),11),6))+X(11)+3174756917)#4294967296)\Powers(32-10),7))))#4294967296)
	.   Set C=((D+(($ZBoolean(((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(2)+718787259)#4294967296)*Powers(15)#4294967296,((C+($ZBoolean((A),$ZBoolean((D),(B),11),6))+X(2)+718787259)#4294967296)\Powers(32-15),7))))#4294967296)
	.   Set B=((C+(($ZBoolean(((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(9)+3951481745)#4294967296)*Powers(21)#4294967296,((B+($ZBoolean((D),$ZBoolean((C),(A),11),6))+X(9)+3951481745)#4294967296)\Powers(32-21),7))))#4294967296)
	. 
	.   Set A=((A+AA)#4294967296)
	.   Set B=((B+BB)#4294967296)
	.   Set C=((C+CC)#4294967296)
	.   Set D=((D+DD)#4294967296)
	;// Step 5
	Set Result=$$Reverse(A)_$$Reverse(B)_$$Reverse(C)_$$Reverse(D)
	Quit Result
Reverse(S)	 ;
	Set S=$ZHex(S)
	Set S=$Extract("00000000",0,8-$Length(S))_S
	Quit $Extract(S,7,8)_$Extract(S,5,6)_$Extract(S,3,4)_$Extract(S,1,2)
Powers	; To avoid the extremely slow 2**x function 
	Set Powers(0)=1
	Set Powers(1)=2
	Set Powers(2)=4
	Set Powers(3)=8
	Set Powers(4)=16
	Set Powers(5)=32
	Set Powers(6)=64
	Set Powers(7)=128
	Set Powers(8)=256
	Set Powers(9)=512
	Set Powers(10)=1024
	Set Powers(11)=2048
	Set Powers(12)=4096
	Set Powers(13)=8192
	Set Powers(14)=16384
	Set Powers(15)=32768
	Set Powers(16)=65536
	Set Powers(17)=131072
	Set Powers(18)=262144
	Set Powers(19)=524288
	Set Powers(20)=1048576
	Set Powers(21)=2097152
	Set Powers(22)=4194304
	Set Powers(23)=8388608
	Set Powers(24)=16777216
	Set Powers(25)=33554432
	Set Powers(26)=67108864
	Set Powers(27)=134217728
	Set Powers(28)=268435456
	Set Powers(29)=536870912
	Set Powers(30)=1073741824
	Set Powers(31)=2147483648
	Set Powers(32)=4294967296                  
	Quit
Test	;MD5 test suite:
	;;d41d8cd98f00b204e9800998ecf8427e
	;a;0cc175b9c0f1b6a831c399e269772661
	;abc;900150983cd24fb0d6963f7d28e17f72
	;message digest;f96b697d7cb7938d525a2f31aaf161d0
	;abcdefghijklmnopqrstuvwxyz;c3fcd3d76192e4007dfb496cca67e13b
	;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789;d174ab98d277d9f5a5611c2c9f419d9f
	;12345678901234567890123456789012345678901234567890123456789012345678901234567890;57edf4a22be3c955ac49da2e2107b67a
	;
	New i,Test,Result,TestResult,Msg
	For i=1:1:7 Do
	.   Set Test=$Text(Test+i),Msg=$Piece(Test,";",2),TestResult=$Piece(Test,";",3)
	.   Set Result=$$Encrypt(Msg)
	.   Write $C(34),Msg,$C(34)," = ",TestResult," : "
	.   If $ZCVT(Result,"l")=TestResult Write "OK",! Quit
	.   Write " <> ",Result,!
	Quit
pwencrypt(pw) Q $$pwencrypt^%MLOGIN(pw) //ЕЩЕ ОДИН АЛГОРИТМ
]]></Routine>


<Routine name="%ZAPM.bs.BSCmdapi" type="MAC" languagemode="0"><![CDATA[
%BSCmdapi ;; MAPI v0.05 Copyright 2004 Maksim Merzhvinsky
 ;	Based on MDAPI v0.05 by Maksim Merzhvinsky
 ;	Модифицировано Евгением Колупаевым. cci.ocx
 Q 
start
  Set ^%ZAPM.bs.BSCmdapicfg("stopsig")=0
  Job server
  Write "MDAPI started..."_$ZTIME($PIECE($HOROLOG,",",2),1)
  Quit
stop
  Set ^%ZAPM.bs.BSCmdapicfg("stopsig")=1
  Write "MDAPI stoped..."_$ZTIME($PIECE($HOROLOG,",",2),1)  
  Quit
showstatus(St,ROU,DEV) S St=""
  New pid,name,ns,dev,user Set pid=""
  For  Set pid=$O(^$JOB(pid)) Quit:pid=""  Do
    .Set name=$ZU(67,5,pid),ns=$ZU(67,6,pid),dev=$ZU(67,7,pid),user=$ZU(67,11,pid)
    .If (name=$G(ROU,$ZN)) && ($JOB'=pid) && (dev=$G(DEV,dev)) S St=$G(St)+1,St(pid)="PID="_pid_", rtn="_name_", namespace="_ns_", device="_dev_", user="_user
    .;W !,St
  Quit $G(St) //КОЛИЧЕСТВО ПРОЦЕССОВ АКТИВНО 
clear
  Kill ^%ZAPM.bs.BSCmdapilog
  Quit
  // config set server port
setport(newport)
  Set ^%ZAPM.bs.BSCmdapicfg("port")=+$Get(newport,10001)
  Write "Setting up new port... ", newport
  Quit
  // If yes then use direct socket instead of spool
setnospool(yes)
  Set ^%ZAPM.bs.BSCmdapicfg("nospool")=$S($Get(yes,0)=0:0,1:1)
  Quit
  // add system user
adduser(user,pass)
  If ($G(user)="") || (user["*/?.,") Write "Bad user name!",! Quit
  If ($G(pass)="") Write "Bad password!",! Quit
  If ($L(pass)<6) Write "Password is less than 6 symbols !",! Quit
  Set ^%ZAPM.bs.BSCmdapicfg("users",user,"pass")=$$CRC^%ZAPM.bs.BSCp(user,pass)
  Quit
  // delete system user
deluser(user)
  If ($G(user)="") Write "Bad user name!",! Quit
  Kill ^%ZAPM.bs.BSCmdapicfg("users",user)
  Quit
  // 
setdefault(noauth)
  Set ^%ZAPM.bs.BSCmdapicfg("noauth")=$Get(noauth,0)
  Quit
  // Set default access rights: 0 - all deny, 1 - all allow
setdefrights(deny)
  Set ^%ZAPM.bs.BSCmdapicfg("dr")=$S($Get(deny,0)=0:0,1:1)
  Quit
  // set default command access rights
setdefcmdrights(cmdid,deny)
  If ($Get(cmdid)="") Write "Bad cmdid!",! Quit
  Set ^%ZAPM.bs.BSCmdapicfg("dr","cmd",+$Get(cmdid))=$S($Get(deny,0)=0:0,1:1)
  Quit 
  // set users command access rights
setusercmdrights(cmdid,user,deny)
  If ($Get(cmdid)="") Write "Bad cmdid!",! Quit
  If ($Get(user)="") Write "Bad user name!",! Quit
  Set ^%ZAPM.bs.BSCmdapicfg("users",user,"r","cmd",+cmdid)=$S($Get(deny,0)=0:0,1:1)  
  Quit
  // Function return true if command "cmdid" allowed
  // defr - default rights loaded by thread
  // user - user name
iscmdallowed(cmdid,defr,user)
  New res
  Set res=$S($G(defr,0)=0:+$Get(^%ZAPM.bs.BSCmdapicfg("dr","cmd",+$G(cmdid)),0),1:+$Get(^%ZAPM.bs.BSCmdapicfg("dr","cmd",+$G(cmdid)),1))
  If ($Get(user)'="") && ($D(^%ZAPM.bs.BSCmdapicfg("users",user,"r","cmd",+$G(cmdid)))) Do
	.Set res=$S($G(defr,0)=0:+$Get(^%ZAPM.bs.BSCmdapicfg("users",user,"r","cmd",+$G(cmdid)),0),1:+$Get(^%ZAPM.bs.BSCmdapicfg("users",user,"r","cmd",+$G(cmdid)),1))
  Quit res
isglobalallowed(globname,defr,user)
  New res Set res=+$Get(defr,0)
  If $Get(globname)="" Quit 0
  If $Get(user)="" Quit +res
  If $D(^%ZAPM.bs.BSCmdapicfg("users",user,"r","glb",globname)) Quit (+^%ZAPM.bs.BSCmdapicfg("users",user,"r","glb",globname)>0)
  If $D(^%ZAPM.bs.BSCmdapicfg("dr","glb",globname)) Quit (^%ZAPM.bs.BSCmdapicfg("dr","glb",globname)>0)
  Quit res
isprocallowed(procname,defr,user)
  New res Set res=+$Get(defr,0)
  If $Get(procname)="" Quit 0
  If $Get(user)="" Quit +res
  If $D(^%ZAPM.bs.BSCmdapicfg("users",user,"r","proc",procname)) Quit (+^%ZAPM.bs.BSCmdapicfg("users",user,"r","proc",procname)>0)
  If $D(^%ZAPM.bs.BSCmdapicfg("dr","proc",procname)) Quit (^%ZAPM.bs.BSCmdapicfg("dr","proc",procname)>0)
  Quit res
isuciallowed(uciname,defr,user)
  New res Set res=+$Get(defr,0)
  If $Get(uciname)="" Quit 0
  If $Get(user)="" Quit +res
  If $D(^%ZAPM.bs.BSCmdapicfg("users",user,"r","uci",uciname)) Quit (+^%ZAPM.bs.BSCmdapicfg("users",user,"r","uni",uniname)>0)
  If $D(^%ZAPM.bs.BSCmdapicfg("dr","uci",uciname)) Quit (^%ZAPM.bs.BSCmdapicfg("dr","uci",uniname)>0)
  Quit res
showusers()
  New u Set u=""
  W !,"Users ------ mdapi ------",!
  For i=1:1  Set u=$O(^%ZAPM.bs.BSCmdapicfg("users",u)) Quit:u=""  Write i,". User mdapi: ",u,!
  W !,"Users ------- ip -------- access grand",!
  N BDSES,P9,noPASS,WW,GC
  S GC=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")
  For i=1:1 Set u=$O(@GC@(u)) Quit:u=""  Write i,". User ip: ",$$JF^%ZAPM.bs.BSC4r4(u,20),"  ",$G(@GC@(u,"GRANT")),!
  Quit
  /*
    Server thread
  */
server
  New dev,port,cli,ip
  //Set P0=""
  //Set P1=""
  Set $ZTrap="serr"
  Set port=$Get(^%ZAPM.bs.BSCmdapicfg("port"),10001)
  L ^%ZAPM.bs.BSpgWEBC(port):0 E  H
  Set dev="|TCP|"_port
  Open dev:(:port:"A"):5
  If '$T Quit
  Set ^%ZAPM.bs.BSCmdapicfg("CurSrvPid")=$JOB
  Do log(0,"Server started (port="_port_")...")
  For  Use dev Read cli:1  Do:$T   Quit:$Get(^%ZAPM.bs.BSCmdapicfg("stopsig"),0)
 	.Set ip=$A($ZU(111,0),1)_"."_$A($ZU(111,0),2)_"."_$A($ZU(111,0),3)_"."_$A($ZU(111,0),4)_":"_($A($ZU(111,0),5)*256+$A($ZU(111,0),6))
	.Do log(3,"Server new connection IP="_ip)
    .Job thread:(:5:dev:dev) If $ZCHILD=0 Do log(1,"Server can't create new JOB!")	 
  Close dev
  Set ^%ZAPM.bs.BSCmdapicfg("CurSrvPid")=""
  Do log(0,"Server stopped.")
  Quit
serr
  Set $ZTrap=""
  If $D(dev) Close dev
  Do log(1,"Server error: $ZE="_$ZE_"; $ZC="_$ZC)
  Quit
 /*
   Client thread
   first - read sinchro signal, then read packet
   Packet format:    
    ofs | size | description
     0  |   1  | MAPI version
     1  |   1  | command ID
     2  |   1  | 0..99 
     3  |   1  | param count
     1
     ...
     N - params:
     size | description
       1  | type
      1..4| length
      0..N| param
 */
thread
  New s,mver,cmd,pktseq,pcount,auth,logout,seq,user,dr,nospool
  Do log(3,"Client thread started... "_$P)
  Set logout=0,seq=0,user=""  
  Set dr=+$Get(^%ZAPM.bs.BSCmdapicfg("dr"),0)  // Get default rights
  Set auth=+$Get(^%ZAPM.bs.BSCmdapicfg("noauth"),0)  // If ini noauth=1 then no ask login
  Set nospool=+$Get(^%ZAPM.bs.BSCmdapicfg("nospool"),0)  // Don't use spool but use socket direct
tnxt
  Set $ZTrap="terr"
  For  Do:$$twaitsinh(10)   Quit:(logout || ($Get(^%ZAPM.bs.BSCmdapicfg("stopsig"),0)))  W !
    .// read header		  
	.If $$tread(.s,4,1) Do  Quit
	  ..Set seq=seq+1
	  ..Set mver=$A(s,1),cmd=$A(s,2),pktseq=$A(s,3),pcount=$A(s,4)
	  ..Do log(3,"Client: cmd="_cmd_", pktseq="_pktseq_", params="_pcount)
	  ..Do $CASE(cmd,0:cmdnull,1:cmdlogin,2:cmdlogout,3:cmdget,4:cmdset,5:cmdkill,6:cmdorder,7:cmddata,8:cmddo,9:cmdxecute,10:cmdcversion,11:cmdlock,12:cmdunlock,14:cmdgetuci,13:cmdsetuci,20:cmdtstart,21:cmdtrollback,22:cmdtcommit,23:cmdinc,101:cmdFSend,102:cmdFRecv,103:cmdFListSend,104:cmdSetP,105:cmdGetP,:cmdunknown)	  
    .If (s'="") Do log(3,"len="_$L(s)_", hdr="_s)    
  Lock
  Close $P
  Quit
cmdlogin
  New pass
  Do log(3,"cmdlogin.")
  //If auth Do log($$$LogLvlInfo,"Already logged in") Quit
  //If (pcount<2) Do log($$$LogLvlInfo,"Too little params") Quit
  If auth Do sendanswear(3,"Already logged in") Quit
  If (pcount<2) Do sendanswear(5,"Too little params") Quit
  If '$$treadparam(.user,10) Do sendanswear(5,"Bad user name") Quit
  If '$$treadparam(.pass,1) Do sendanswear(5,"Bad password") Quit
  Do log(3,"cmdlogin: user="_user_", pass=******")
  Set auth=$$auth(user,pass),pass=""
  Do sendanswear($S(auth:0,1:4),$S(auth:"",1:"Bad user name or password"))
  Quit
cmdlogout
  Do log(3,"cmdlogout.")
  Set logout=1
  Do sendanswear(0,"Bye")
  Quit
  /*
---------------------------------------------------------------------
  */
cmdSetP
  New PNum, DataLen, DataBuf, act
  Do log(3, "cmdSetP")
  Do treadparam(.PNum, 1)
  Do treadparam(.DataLen, 1)
  if (DataLen>0) D
  	.Do sendanswear(13, "Ready to recieve.")
  	.Read DataBuf#DataLen:15
  	.Set act="P"_PNum
  	.Set @act=DataBuf
  Else  D
    .Set act="P"_PNum
    .Set @act=""
  Quit
cmdGetP
  New PNum, PEntry
  Do log(3, "cmdGetP")
  Do treadparam(.PNum, 1)
  Set PEntry="P"_PNum
  Do sendanswear(13, "Ready to send.")
   If ($G(@PEntry) = "") Write $ZLC(0)
   Else  Write $ZLC($L(@PEntry)),@PEntry
  Quit
cmdFRecv
  New FName, FLen, DataBuf, BlockLen
  Do log(3, "cmdFileReceive")
  Do treadparam(.FName, 10)
  Do treadparam(.FLen, 1)
  Do treadparam(.BlockLen, 1)
  Set DestFile = ##class(%File).%New(FName)
  Set ok = DestFile.Open("WSN")
  If 'ok Do sendanswear(14, "Can't open specified file.") Quit
  Do sendanswear(13, "Ready to receive.")
  For i=1:1 {
    If (FLen < BlockLen) Set BlockLen = FLen
  	Read DataBuf#BlockLen:15
  	Do DestFile.Write(DataBuf)
  	Set FLen = FLen - BlockLen
  	If (FLen '> 0) Quit
  }
  Do DestFile.Close()
  Do sendanswear(0, "Transfer successed: "_FName_", length: "_FLen)
  Quit
cmdFSend
  New FName, FLen, DataBuf, BlockLen
  Do log(3, "cmdFileSend")
  Do treadparam(.FName, 10)
  Do treadparam(.BlockLen, 1)
  Set SrcFile = ##class(%File).%New(FName)
  Set ok = SrcFile.Open("RU")
  If 'ok Do sendanswear(14,"Can't open specified file.") Quit
  Set FLen = SrcFile.SizeGet
  If (FLen > 0) {
    Do sendanswear(13,"Ready to send.")
    Write $ZLC(FLen)
  } Else {
	Do SrcFile.Close()
	Do sendanswear(14,"Zero-length file. Nothing to send.")
    Quit
  }
  For i=1:1 {
    If (FLen < BlockLen) Set BlockLen = FLen
    Set DataBuf = SrcFile.Read(BlockLen)
    Write DataBuf
    Set FLen = FLen - $Length(DataBuf)
    If (FLen '> 0) Quit
  }
  Do SrcFile.Close()
  Do sendanswear(0, "Transfer successed: "_FName_", length: "_FLen)
  Quit
cmdFListSend
  New Path, Wildcard, Mode, rset, ResultBuf
  Do log(3, "cmdFListSend")
  Do treadparam(.Path, 10)
  Do treadparam(.Wildcard, 10)
  Do treadparam(.Mode, 10)
  If ('##class(%File).DirectoryExists(Path)) {
    Do sendanswear(14, "Specified path did not exists.")
    Quit
  }
  Set rset = ##class(%ResultSet).%New("%Library.File:FileSet")
  Do rset.Execute(Path, Wildcard, "ItemName", 1)
  Set ResultBuf = ""
  While (rset.Next(.fEnt)) {
    If ($SYSTEM.Status.IsOK(fEnt)) {
	  If (Mode = "1") {
	  	Set ResultBuf = ResultBuf _ rset.Data("ItemName") _ ":" _ rset.Data("Type") _ ";"
	  } ElseIf (Mode = "0") {
		If (rset.Data("Type") = "F") {
	      Set ResultBuf = ResultBuf _ rset.Data("ItemName") _ ";"
		}
	  } ElseIf (Mode = "2") {
	    If (rset.Data("Type") = "D") {
	      Set ResultBuf = ResultBuf _ rset.Data("ItemName") _ ";"
	    }
	  }
    }
  }
  If ($SYSTEM.Status.IsError(fEnt)) {
    Do sendanswear(14, "Query error.")
    Quit
  } Else {
	  Do sendanswear(13, "Ready to send. Block length:"_$ZLC($Length(ResultBuf)))
	  Write $ZLC($Length(ResultBuf))
  }
  Do rset.Close()
  If ($Length(ResultBuf) > 0) {
  	Do sendanswear(13, "Ready to send. Folder content.")
  	Write ResultBuf
  } Else {
    Do sendanswear(0, "Nothing to send.")
  }
  Quit
  /*
---------------------------------------------------------------------
  */
cmdset
  New gname,keys,newval,flags,olduci
  Do log(3,"cmdset.")
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.gname,10)  
  Do treadparam(.keys,1)
  Do treadparam(.newval,1)
  Do treadparam(.flags,1)
  If (gname="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isglobalallowed(gname,dr,user) Do sendanswear(8,"") Quit
  Set gname="^"_gname_$S(keys="":"",1:"("_keys_")")
  Do log(3,"global -> "_gname)  
  Set @gname=newval  
  Do sendanswear(0,"New value assigned")
  Quit
cmdget
  New gname,keys,def,flags,res
  Do log(3,"cmdget.")  
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.gname,10)  
  Do treadparam(.keys,1)
  Do treadparam(.def,1)
  Do treadparam(.flags,1)
  If (gname="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isglobalallowed(gname,dr,user) Do sendanswear(8,"") Quit
  Set gname="^"_gname_$S(keys="":"",1:"("_keys_")")
  Do log(3,"global -> "_gname)
  Set res=$Get(@gname,def)
  Do sendanswear(0,res)
  Quit
cmdkill
  New gname,keys,flags
  Do log(3,"cmdkill.")
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.gname,10)  
  Do treadparam(.keys,1)
  Do treadparam(.flags,1)
  If (gname="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isglobalallowed(gname,dr,user) Do sendanswear(8,"") Quit  
  Set gname="^"_gname_$S(keys="":"",1:"("_keys_")")
  Do log(3,"global -> "_gname)
  Kill @gname
  Do sendanswear(0,"Global killed")    
  Quit
cmdorder
  New gname,keys,flags,res
  Do log(3,"cmdorder.")
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.gname,10)  
  Do treadparam(.keys,1)
  Do treadparam(.flags,1)
  If (gname="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isglobalallowed(gname,dr,user) Do sendanswear(8,"") Quit
  Set gname="^"_gname_$S(keys="":"",1:"("_keys_")")
  Do log(3,"global -> "_gname)
  Set res=$Order(@gname)
  Do sendanswear(0,res)
  Quit
cmddata
  New gname,keys,flags,res
  Do log(3,"cmddata.")
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.gname,10)  
  Do treadparam(.keys,1)
  Do treadparam(.flags,1)
  If (gname="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isglobalallowed(gname,dr,user) Do sendanswear(8,"") Quit
  Set gname="^"_gname_$S(keys="":"",1:"("_keys_")")
  Do log(3,"global -> "_gname)
  Set res=$Data(@gname)
  Do sendanswear(0,res)
  Quit
cmddo
  New proc,ofs,args,flags,i,j,res,v
  Do log(3,"cmddo.")
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.proc,10)
  Do treadparam(.ofs,1)
  Do treadparam(.args,1)
  Do treadparam(.flags,1)
  If (proc="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isprocallowed(proc,dr,user) Do sendanswear(8,"") Quit
  Set proc=ofs_"^"_proc_$S(args="":"",1:"("_args_")")
  Set j=$JOB
  Open 2:(j)
  Use 2 Do @proc
  Close 2
  Set i="",res=""
  For  Set i=$O(^SPOOL(j,i)) Quit:(i="")||(i'<2147483647)  Set v=$G(^SPOOL(j,i)) Quit:($L(res)+$L(v)>32000)  Set res=res_v      
  Kill ^SPOOL(j)
  Do sendanswear(0,res)
  Quit
cmdxecute
  New xstr,j,i,res,v
  Do log(3,"cmdxecute.")
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do treadparam(.xstr,10)
  If (xstr="") Do sendanswear(5,"More parameters needed") Quit
  Do log(3,"xstr=<"_xstr_">, job="_$JOB)
  Set j=$JOB
  Open 2:(j)
  Use 2 Xecute xstr
  Close 2
  Set i="",res=""
  For  Set i=$O(^SPOOL(j,i)) Quit:(i="")||(i'<2147483647)  Set v=$G(^SPOOL(j,i)) Quit:($L(res)+$L(v)>32000)  Set res=res_v    
  Kill ^SPOOL(j)  
  Do sendanswear(0,res)
  Quit
cmdcversion
  Do log(3,"cmdcversion.")
  Do sendanswear(0,$ZV)
  Quit
cmdlock
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  New gname,keys,flags Set (gname,keys)="",flags=0  
  Do log(3,"cmdLock")
  Do treadparam(.gname,1)
  Do treadparam(.keys,1)
  Do treadparam(.flags,1)
  If (gname="") || ($L(gname)>56) Do sendanswear(5,"Bad global name") Quit
  Set gname=$S(+flags:"",1:"^")_gname_$S(keys="":"",1:"("_keys_")")
  Do log(3,"cmdlock: global -> +"_gname)
  Lock +@gname
  Do sendanswear(0,"Locked")
  Quit
cmdunlock
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  New gname,keys,flags Set (gname,keys)="",flags=0
  Do log(3,"cmdUnlock")
  Do treadparam(.gname,1)
  Do treadparam(.keys,1)
  Do treadparam(.flags,1)
  Do log(3,"cmdunlock: global -> -"_gname)
  If ($L(gname)>56) Do sendanswear(5,"Bad global name") Quit
  If (gname'="") Set gname=$S(+flags:"",1:"^")_gname_$S(keys="":"",1:"("_keys_")")  
  Lock:(gname="")
  Lock:(gname'="") -@gname
  Do sendanswear(0,"Unlocked")
  Quit
cmdsetuci
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  New newuci Set newuci=""
  Do log(3,"cmdSetUCI")
  Do treadparam(.newuci,5)
  If (newuci="") Do sendanswear(5,"Bad UCI name") Quit
  If '$$isuciallowed(newuci,dr,user) Do sendanswear(8,"") Quit
  Do log(3,"cmdSetUCI: newuci="_newuci)
  If ($ZNSPACE=newuci) Do sendanswear(0,"Namespace already set") Quit
  If ($ZU(90,10,newuci)=1) Set $ZNSPACE=newuci Do sendanswear(0,"Namespace was set") Quit
  Do sendanswear(6,"Namespace not exist "_$ZNSPACE)
  Quit
cmdgetuci
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do log(3,"cmdGetUCI")
  Do sendanswear(0,$ZNSPACE)
  Quit
cmdtstart
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do log(3,"cmdTStart")
  TSTART
  Do sendanswear(0,$TLEVEL)
  Quit
cmdtrollback
  If 'auth {Do sendanswear(4,"") Quit}
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do log(3,"cmdTRollback")
  If ($TLEVEL=0) Do sendanswear(7,"Transaction not started") Quit
  TROLLBACK
  Do sendanswear(0,"Rollback complite")
  Quit
cmdtcommit
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do log(3,"cmdTCommit")
  If ($TLEVEL=0) Do sendanswear(7,"Transaction not started") Quit
  TCOMMIT
  Do sendanswear(0,"Transaction commited")
  Quit
cmdinc
  New gname,keys,flags,res
  If 'auth Do sendanswear(4,"") Quit
  If ('$$iscmdallowed(cmd,dr,user)) Do sendanswear(8,"") Quit
  Do log(3,"cmdInc")
  Do treadparam(.gname,10)  
  Do treadparam(.keys,1)
  Do treadparam(.flags,1)
  If (gname="") Do sendanswear(5,"More parameters needed") Quit
  If '$$isglobalallowed(gname,dr,user) Do sendanswear(8,"") Quit
  Set gname="^"_gname_$S(keys="":"",1:"("_keys_")")
  Set res=$Increment(@gname)
  Do sendanswear(0,+res)  
  Quit
cmdnull Quit  // Null command
cmdunknown
  Do log(2,"Unknown command ID <"_cmd_">")
  Do sendanswear(3,"Unknown command ID <"+cmd+">")
  Quit
auth(user,pass)  
  New upass
  Q 1 If ($G(user)="") Quit 0    
  i $d(^%ZAPM.bs.BSCmdapicfg("users",user)) Set upass=$Get(^%ZAPM.bs.BSCmdapicfg("users",user,"pass")) Quit (upass'="")&&(upass=($$CRC^%ZAPM.bs.BSCp(user,pass))) //inoaaei e noa?uo iiuciaaoaeae
  Q $$CHECK(user,pass)
CHECK(user,pass)  N BDSES,P9,noPASS,WW,GC
  S GC=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")
  S BDSES=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")")
  I $D(@GC@(user)),$$PROTECT^%ZAPM.bs.BSCp(user,pass) Q 1 //password is valid
  I $D(@BDSES@(pass)),'$D(@BDSES@(pass,"CHR")),$G(@BDSES@(pass,"NM"))=user Q 1 //id session as tempory key
  Q 0 
sendanswear(error,msg)
  New pkt
  Do tflush()
  Set pkt=$C(2)_$ZLC(+$Get(error))_$ZLC($L($Get(msg)))_$Get(msg)
  Write pkt,!
  Quit
treadparam(str,tout)
  New a,len,res Set str=""
  Read a#1:1 If '$T Quit 0  
  If ($A(a)=0) Quit 1
  If ($A(a)=1) Set res=$$tread(.len,1,5),res=$$tread(.str,$A(len),5) Quit res
  If ($A(a)=2) Set res=$$tread(.len,4,5),res=$$tread(.str,$ZLA(len),5) Quit res
  If ($A(a)=3) Set res=$$tread(.a,4,5),str=$ZLA(a) Quit res
  Quit 0
tread(str,len,tout)  
  Set len=$Get(len,0),tout=$Get(tout,1)
  If (len=0) Quit 0
  Read str#len:tout
  Quit $T &&($L(str)=len)
tflush()
  //New s Set s=""
  Read *a:0.5 Quit:(a=-1)||('$T)  //Set s=s_a
  //If ($L(s)>0) Do log($$$LogLvlInfo,"flush ("_$L(s)_")>"_s)
  Quit 1
twaitsinh(tout)
  New i,a,t1,za Set i=0,tout=$Get(tout,5),t1=$ZH
  For  Do   Quit:(i=4)||($Get(^%ZAPM.bs.BSCmdapicfg("stopsig"),0))||((tout>0)&&($ZH-t1>tout))
   .Read *a:1 Set za=$ZA,zh=$ZH
   .If (a>0) Set i=$S(a=254:i+1,1:0)   
  Quit (i=4)
terr
  Set $ZTrap=""
  Do log(1,"Thread error: $ZE="_$ZE_"; $ZC="_$ZC)
  Lock
  Close 2
  Kill ^SPOOL($JOB)  
  ;If (($F($ZE,"<SYNTAX>")'=0) || ($F($ZE,"<UNDEFINED>")'=0)) Do sendanswear($$$errSystem,$ze) Goto tnxt
  If $ZE'="" Do sendanswear(1,$ze) Goto tnxt
  Close $P  
  Quit
log(lvl,v)
  Do DISABLE^%NOJRN
  Set ^%ZAPM.bs.BSCmdapilog($I(^%ZAPM.bs.BSCmdapilog))=$ZDT($H,4,1)_"["_$G(lvl,0)_"]: "_$G(v)
  Do ENABLE^%NOJRN
  Quit
]]></Routine>


<Routine name="%ZAPM.bs.BSCnewF11" type="MAC" languagemode="0"><![CDATA[
%BSF11 ; ДОПОЛНИТЕЛЬНЫЕ ПРОВЕРКИ ; 11:45   04.05.2001
 Q
COP2L(si,st) ;КОПИРОВАНИЕ СТРОКИ si В ЛОКАЛЬ
 S bsr="BUF"
 I $D(@BSR@(BST,si,1)) F kj=1:1 Q:'$D(@BSR@(BST,si,kj))  S @bsr@(BSt,st,kj)=@$ZR D
 .I 'fo F f="FCL","FTR","COL" S $P(@bsr@(BSt,st,kj),"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))=""
 .I fo D
 ..I "2345"'[$P(@BSR@(BST,si,kj),"@",7),$D(@BSR@(BST,"FCL",si,kj)) S @bsr@(BSt,"FCL",st,kj)=@$ZR
 ..I $D(@BSR@(BST,"FTR",si,kj)) S @bsr@(BSt,"FTR",st,kj)=@$ZR
 ..I '$P(B,"@",27) I $D(@BSR@(BST,"COL",si,kj)) S @bsr@(BSt,"COL",st,kj)=@$ZR D
 ...I $D(@BSR@(BST,"COL",si,kj,1)) S @bsr@(BSt,"COL",st,kj,1)=@$ZR
 Q
COPY(si) ;КОПИРОВАНИЕ СТРОКИ si ИЗ ЛОКАЛИ
 S St=St+1 X WA F kj=1:1 Q:'$D(@bsr@(BSt,si,kj))  S @(BSr_"(BSt,St,kj)")=@bsr@(BSt,si,kj) D
 .I 'fo F f="FCL","FTR","COL" S $P(@$ZR,"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))=""
 .I fo D
 ..F f="FCL","FTR" I $D(@bsr@(BSt,f,si,kj)) S @(BSr_"(BSt,f,St,kj)")=@bsr@(BSt,f,si,kj)
 ..I '$P(B,"@",27) I $D(@bsr@(BSt,"COL",si,kj)) S @BSr@(BSt,"COL",St,kj)=@bsr@(BSt,"COL",si,kj) D
 ...I $D(@bsr@(BSt,"COL",si,kj,1)) S @BSr@(BSt,"COL",St,kj,1)=@bsr@(BSt,"COL",si,kj,1)
 Q
LASTHIS(key,ny) N %HIS D HIS^%ZAPM.bs.BSF1($$NHIS()) Q $D(@%HIS@(1))
INSERT(key,ny) N %HIS D HIS^%ZAPM.bs.BSF1($$NHIS()) Q $G(@%HIS@(1))
NHIS() Q "TabelKey"_key_"String"_ny
PREDTEMP ;ПРЕДОБРАБОТКА ВЫБОРКИ ДЛЯ КЛЮЧЕЙ
 Q:R1>332
 I R1=13 D  Q  ;ЗАПИСЬ В ИСТОРИЮ
 .I d'["#",key'=0 Q:ny>4
 .D AddHist($$NHIS(),d)
 I R1=27,R2=91,R3=68!(R3=67) D  ;ЗАСВЕТКА СПИСКА ИСТОРИЙ
 .N %HIS,TTT D HIS^%ZAPM.bs.BSF1($$NHIS()) S TTT=$P($P(%HIS,"(",2),$C(34),2)
 .s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB",TTT) I Tmp=""!(YES<1) S R1=-2 Q
 .S d=Tmp,R1=0,R2=18 Q
 I ny>4,R1>31,R2=-1,R3=-1 S R1=-4,li=$P($G(@BSR@(BST,ny,2)),"@",15)_"#"_$P($G(@BSR@(BST,"COL",ny,3)),"I ",2,99)
 Q
AddHist(f,d) Q:d=""  N %HIS D HIS^%ZAPM.bs.BSF1(f) D AddHist^%ZAPM.bs.BSXuse(%HIS,d)
 Q
SETEMP ;ВРЕМЕННАЯ ВЫБОРКА
 S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,3)="I "_$P(d,"#",2,999)
 S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,4)="TXTC#"_$P(d,"#")
 Q
CREA(F) ;ФОРМУЛА НА БОКОВИНУ
 N FF
 I F["LongString" S F=$$GLRET^%ZAPM.bs.BSF12(F)
 I F["$$TSV" X "S FF="_F
 I F'["$$TSV" S FF="I "_F
 Q FF
TSVV(kod) Q "I "_kod
CREAT(M,Y,X,RA,EN) D Wait^%ZAPM.bs.BSXfun("КОПИРОВАНИЕ М\ЗАПРОСОВ В СВОДКУ")
 G creat:$E(SVo,1)=0
 N si,MM,fo,MMM,bsr,BUF
 S MM="",MMM=Y,fo=1 K SP(5) D COP2L(Y,1) S fo=0 D COP2L(RA,2)
 F  S MM=$O(@M@(1,MM)) Q:MM=""  D  S MMM=MMM+2
 .S Tmp=$$GLRET^%ZAPM.bs.BSF12($NA(@M@(1,MM))),fo=1 D COPY(1) S @BSr@(BSt,St)=1,n(MMM)=n,n=n+1 D  F C=2:1:COMP D COPY(1) S @BSr@(BSt,St)=C,$P(@BSr@(BSt,St,TSVV),"@",15)=""
 ..S $P(@BSr@(BSt,St,TSVV),"@",15)=$P(Tmp,"@")
 ..S SP(5,MMM)=$$CREA($P(Tmp,"@",2,9999))
 .I $O(@M@(1,MM))'="" S fo=0 D COPY(2)
 S si=EN,fo=0 D COP^%ZAPM.bs.BSSV
 Q
creat ;КОПИРОВАНИЕ М\ЗАПРОСОВ В СВОДКУ (СТАРЫЙ ВАРИАНТ)
 N si,MM,fo,MMM
 S MM="",MMM=Y K SP(5)
 F  S MM=$O(@M@(1,MM)) Q:MM=""  D  S MMM=MMM+2
 .S si=Y,fo=1 D COP^%ZAPM.bs.BSSV S @BSr@(BSt,St)=1,n(MMM)=n,n=n+1 D  F C=2:1:COMP D COP^%ZAPM.bs.BSSV S @BSr@(BSt,St)=C,$P(@BSr@(BSt,St,TSVV),"@",15)=""
 ..S $P(@BSr@(BSt,St,TSVV),"@",15)=$P(@M@(1,MM),"@")
 ..S SP(5,MMM)=$$CREA($P(@M@(1,MM),"@",2,999))
 .I $O(@M@(1,MM))'="" S si=RA,fo=0 D COP^%ZAPM.bs.BSSV
 S si=EN,fo=0 D COP^%ZAPM.bs.BSSV
 Q
CHO(MM,NO,x,zz) ;ВЫБОР
 N M,BSr,BSt,Fk,se,Obraz
 S YES=1,%zT=$ZT,$ZT="ERMA^%ZAPM.bs.BSF11"
 D TempT^%ZAPM.bs.BSTT
 F M=1:1 Q:$P(MM,"@",M)=""  D TempTX^%ZAPM.bs.BSTT($P(MM,"@",M)_" "_$P($G(@$P(MM,"@",M)),"@",2))
 D TempTXT^%ZAPM.bs.BSTT("<<< Выберите БОКОВИНУ для сводки >>>",$G(@%BS(20)@("ErrorTXT")))
 d ^%ZAPM.bs.BSX("TEXT",BSr,BSt) Q:YES<1
 S M=YES I YES D Yes^%ZAPM.bs.BSXfun("Будем УТОЧНЯТЬ БОКОВИНУ ?",2) S Tmp=YES,YES=1 I Tmp D TEMPZAPR($P(MM,"@",M))
 S $P(@x,"#",9)=$P(MM,"@",M),$P(@x,"#",10)=NO
 ;```???```I $D(NZP),$D(@BSR@(BST,"ZPR",NZP,0)) S $P(@$ZR,"#",9)=$P(MM,"@",M),$P(@$ZR,"#",10)=NO
 Q
TEMPZAPR(GL) ;РАЗОВЫЕ М-ЗАПРОСЫ
 N TG,TT,BSR,BST,BSr,BSt,IntTmp,i,j,s1,s2,s6i,l1,l2,col,ke,Fk,tIT,IYI,txt,kod,%INV1,%INV2
 N k1,k2,k3,k4,k5,k6,k7,k8,k9,%INV,Tmp,Shab
 S TT=$$TMPG^%ZAPM.bs.BSF11,BSR=$P(TT,"("),BST=$P($P($P(TT,"(",2),")"),$C(34),2),IntTmp=1
 S Shab="^%ZAPM.bs.BSS(""OPout"")" I $D(zz),$$Data^%ZAPM.bs.BSF12(zz) S Shab=zz
 S @BSR@(BST)=@Shab
 S s1="dinamo",Fk="",Tmp=0
 D Int I $D(@Shab@("AF2")) S @BSR@(BST,"AF2")=@Shab@("AF2")
AGAIN S IYI=BSR_"("_BST D NE^%ZAPM.bs.BSN I R1=27 S YES=0 Q
 S %INV="TempZap"_$G(%BS(3),$P)_$J_"u",%INV=$$BSR^%ZAPM.bs.BSA($NA(^%ZAPM.bs.BSbufB(%INV))) K @%INV S %INV2=1,%INV1=2,s6=0,@%INV="%BS-dimamo-@Temporary"
 S do="D TEMPZ^%ZAPM.bs.BSF11(j)" D BLOK^%ZAPM.bs.BSF1 I YES<1!('s6) G AGAIN
 S YES=1,MM=%INV,M=1
 Q
TEMPZ(j) ;СОЗДАНИЕ TEMP.М\ЗАПРОСОВ
 Q:Tmp=i
 D DINA^%ZAPM.bs.BSS I YES<1 S i=999999 Q
 S Tmp=i Q
ERMA D ErrMsg^%ZAPM.bs.BSXfun($$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT),YES=0 Q
TS ;ПОИСК ДИНАМИЧЕСКОЙ БОКОВИНЫ
 N F S ls=1
 S F=$G(@BSR@(BST,"FCL",id,jd)) X "I "_F
 Q
TSVD(M,N,T,Z) I '$D(@BSR@(BST,N)) S ls="В ФУНКЦИИ $TSVD НЕТ СТРОКИ С НОМЕРОМ "_N Q 0
 I '$D(@BSR@(BST,T)) S ls="В ФУНКЦИИ $TSVD НЕТ СТРОКИ С НОМЕРОМ "_T Q 0
 S @BSR@(BST,"TSV",1,3)=$G(M),@BSR@(BST,"TSV",1,3,1)=+$G(N)_","_+$G(T)_","_id_","_jd
 I $D(Z) S @BSR@(BST,"TSV",1,3,2)=Z
 Q 1
INVTAB S s1="invert" G DINS ;ОБРАТНАЯ ОПЕРАЦИЯ
DINTAB S s1="dinamo"
DINS I BST'["@" D ErrMsg^%ZAPM.bs.BSXfun("ОПЕРАЦИЯ ВОЗМОЖНА В РЕЖИМЕ РЕДАКТИРОВАНИЯ ТАБЛИЦЫ <F4>") G D
 D Yes^%ZAPM.bs.BSXfun("ТЕКУЩАЯ ТАБЛИЦА СИЛЬНО ИЗМЕНИТСЯ ! ВЫ ГОТОВЫ К ЭТОМУ ?",2) I YES<1 G D
 S li="^" D GLO^%ZAPM.bs.BSF3 I $G(GL)="" G D
 I $P($G(@GL),"@")'[("%BS-"_s1_"-") D ErrMsg^%ZAPM.bs.BSXfun("НУ, ЭТО СОВСЕМ НЕ ТО !") G D
Int S s2=@BSR@(BST) K @BSR@(BST) S @BSR@(BST)=s2,$P(@$ZR,"@",29)=2,ke=2,s2=0
 S i="",BSr=BSR,BSt=BST
 I s1["mo" F  S i=$O(@GL@(1,i)) Q:i=""  D DINSM($P($G(^(i)),"@"))
 I s1'["mo" F  S i=$O(@GL@(1,i)) Q:i=""  D DINSM(i)
 S s2=s2+1 I s2>50 S s2=50
 S l1=s2,l2=75-l1,(col(1),col(2))=$P(%BS,"!",4) D DINSE(" КОДЫ"," "_$S(s1'["mo":"ТЕКСТЫ",1:"ФОРМУЛЫ (для включения в М\Запрсы их надо ПОМЕТИТЬ)"))
 S col(1)=$P(%BS,"!",5),col(2)=$P(%BS,"!",6),a=""
 I s1["mo" F  S a=$O(@GL@(1,a)) Q:a=""  D DINSE($P(@GL@(1,a),"@"),$P(@GL@(1,a),"@",2,999))
 I s1'["mo" F  S a=$O(@GL@(1,a)) Q:a=""  D DINSE(a,@GL@(1,a))
 D CREAT^%ZAPM.bs.BSN S $P(@BSr@(BSt),"@")=$P($G(@GL,"@???"),"@",2)
 Q:$D(IntTmp)
 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
DINSM(t1) I $L(t1)>s2 S s2=$L(t1)
 Q
DINSE(t1,t2) D CR^%ZAPM.bs.BSN Q
ERCMD ;ОШИБКИ В ФОРМУЛАХ СПИСКОВ И СВОДОК
 D TempT^%ZAPM.bs.BSTT
 D TempTX^%ZAPM.bs.BSTT($$ErrSay^%ZAPM.bs.BSF8($ZE)),TempTX^%ZAPM.bs.BSTT("")
 D TempTX^%ZAPM.bs.BSTT("    ВОЗМОЖНО ОШИБКА В ФОРМУЛАХ:"),TempTX^%ZAPM.bs.BSTT("")
 I $D(iii),$D(SP(2,iii)) D TempTX^%ZAPM.bs.BSTT("номер="_iii_" Логики на Шапку"),TempTX^%ZAPM.bs.BSTT(SP(2,iii))
 I $D(iii),$D(SP(4,iii)) D TempTX^%ZAPM.bs.BSTT("номер="_iii),TempTX^%ZAPM.bs.BSTT(SP(4,iii))
 I $G(iS),$D(SP(5,iS)) D TempTX^%ZAPM.bs.BSTT("номер="_iS_" Логики на Боковину"),TempTX^%ZAPM.bs.BSTT(SP(5,iS))
 I $D(i),$D(C),$D(CH(C,i,3)) D TempTX^%ZAPM.bs.BSTT(" Логика Выборки="_CH(C,i,3))
 D TempTXT^%ZAPM.bs.BSTT("ОШИБКА !!!",$G(@%BS(20)@("ErrorTXT")))
 D TempTXTE^%ZAPM.bs.BSTT
 Q
D G 0^%ZAPM.bs.BSTM
DIN ;МИКРОЗАПРОСЫ ИЗ СВОДКИ В МАССИВ
 S do="I j=%INV1 D DINASE^%ZAPM.bs.BSS($P(^(j),""@"",15),$G(@BSR@(BST,""FCL"",i,j)))"
 D SETKD^%ZAPM.bs.BSS S s6=0
 D BLOK^%ZAPM.bs.BSF1 G ENDIN^%ZAPM.bs.BSS
S(C) Q:C'["]" 0 N U,S
 S U=$P(C,$C(34),2),S=$P(C,$C(34),4) I $$ZU^%ZAPM.bs.BS3(U,S) Q 0
 Q 1
F(S) I $$S(S)=0 Q "НОВЫЙ ФОНОВЫЙ НАСЧЕТ"
 Q "НОВЫЙ ЛОКАЛЬНЫЙ ФОНОВЫЙ НАСЧЕТ"
H(S) I $$S(S)=0 Q "НОВЫЙ НАСЧЕТ"
 Q "НОВЫЙ ЛОКАЛЬНЫЙ НАСЧЕТ"
R(C) ;УДАЛЕННЫЕ НАСЧЕТЫ
 N %TAB,%TAA
 D UU(C) I '$D(UU) Q
 S %TAB=%OLDII I UU=$$BSR^%ZAPM.bs.BSA("^%ZAPM.bs.BSbufS") Q
 F  S %TAB=$O(@(UU_"(%TAB)")) Q:%TAB=""  Q:%TAB'[%OLDII  I %TAB'["@"&(%TAB'["&") S i=i+1 D
 .S @TS@(i,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$P(%TAB,"!",3)_$J("",13-$L($P(%TAB,"!",3)))_$S($P(@(UU_"(%TAB)"),"@",30)="":".....",1:$E($P(@$ZR,"@",30),1,5))_";REMOTE;1;"_$P(@$ZR,"@")
 ;```S (%TAB,%TAA)=%OLDII
 ;```F  S %TAB=$O(@(UU_"(%TAB)")) Q:%TAB=""  Q:%TAB'[%TAA  I %TAB'["@"&(%TAB'["&") S i=i+1 D
 ;```.S @TS@(i,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$P(%TAB,"!",3)_$J("",13-$L($P(%TAB,"!",3)))_$S($P(@(UU_"(%TAB)"),"@",30)="":".....",1:$E($P(@$ZR,"@",30),1,5))_";REMOTE;1;"_$P(@$ZR,"@")
 Q
UU(C) N U ;ОПРЕДЕЛЕНИЕ ССЫЛКИ СЕТЕВОГО РАЗДЕЛА
 S U="^["""_$P(C,$C(34),2)_""","""_$P(C,$C(34),4)_"""]BSdirddp",U=$P($G(@U),"@",2) I U="" G UUu
 S UU="^["""_$P(U,",")_""","""_$P(U,",",2)_"""]%BSbufS" I $$Data^%ZAPM.bs.BSF12(UU) Q
UUu S UU="^[""MGR"","""_$P($G(^%ZAPM.bs.BSETUP("SERVER",14,4)),"@",15)_"""]%BSbufS" I $$Data^%ZAPM.bs.BSF12(UU) Q
 S UU=$$BSR^%ZAPM.bs.BSA("^%ZAPM.bs.BSbufS") Q
DEL S %TAB=$P(d," ",2) S %OLDII1=$S(%OLDII'["^%":$E(%OLDII,4,6)_":"_$E(%OLDII,10,12)_":"_$P($P(%OLDII,"]",2),"!",1,9),1:%OLDII)
 I $D(%DIA) S do="S d=$P(^(j),""@"",15) K Temp D DE^%ZAPM.bs.BSF11(d) I $D(Temp) S %TAB=%OLDII1_$P($P($P(^(j),""@"",15),"" "",2),""."",2) D DEL^%ZAPM.bs.BS(Temp,$S($ZV[""Cach"":%OLDII_$P(%TAB,""."",2),1:%OLDII1_$P(%TAB,""."",2)))" D BLOK^%ZAPM.bs.BSF1 Q
 Q:ny<4  K Temp D DE(d) I $D(Temp) D DEL^%ZAPM.bs.BS(Temp,$S($ZV["Cach"||($ZV["IRIS"):%OLDII_$P(%TAB,".",2),1:%OLDII1_$P(%TAB,".",2)))
 Q
DE(d) I d[";REMOTE;" S Temp=UU Q
 I d[";LOCKAL;" S Temp=%nAM
 Q
OUTGLO(GLO,FN) ;КОПИРОВАНИЕ НОВОЙ ВЕРСИИ В СЕТЕВУЮ ГЛОБАЛЬ
 I GLO'["^" Q
 N DOS,I,II
 S %zT=$ZT,$ZT="OG^%ZAPM.bs.BSF11",YES=0,II=1
 F DOS=51:1:54 O DOS::0 Q:$T
 I $$Open^%ZAPM.bs.BSXdos(FN,"R")<0 Q
 D L^%ZAPM.bs.BS3(GLO)
 U 0 d Wait^%ZAPM.bs.BSXfun("Копирование в "_GLO) K @GLO@("LAST") S @GLO@("LAST")=0
 F  U DOS Q:$ZC'=0  R I S @GLO@("LAST",II)=I,II=II+1 I '(II#50) U 0 X $G(WA)
 S @GLO@("LAST")=^%ZAPM.bs.BS
 S YES=1 D U^%ZAPM.bs.BS3(GLO) C DOS
 Q
OG I $ZE["<ENDOFFILE" G OGO
 D ErrMsg^%ZAPM.bs.BSXfun($$ErrSay^%ZAPM.bs.BSF8($ZE))
OGO S $ZT=$G(%zT),YES=0 D U^%ZAPM.bs.BS3(GLO) C DOS
 Q
SCAN(%FN) ;СКАНИРОВАНИЕ
 C %FN K fT2
 N I,WRITE,DOS,FN,DOSO,FNO,FIRST,M,CU,v,ST,STOPSCAN,DOSIN,DOSOUT,say
 I $D(^%ZAPM.bs.BSDDR("DDRPARM")) F CU=2:2:16 S CU(CU)=$P(^%ZAPM.bs.BSDDR("DDRPARM",CU,4),"@",15)
 I %IN["%BS-SCANINIG" G SCA
 ;S FN=$$BaseDir^%ZAPM.bs.BSDOS_$$DIR^%ZAPM.bs.BSMSMF_$$TEMPFILE,FNO=%FN
 ;C %DEV 
 I $ZV["Cach"||($ZV["IRIS") D  G SCA1
 .S say="без перекодировки" S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1(%IN) D  S say="с перекодировкой" 
 ..N (S1,S2) D INIT^%ZAPM.bs.BSre(1)
 ;F %DEV=$G(%Dev,51):1:54 O %DEV::0 Q:$T
 ;S DOS=%DEV
 ;F %DEV=$G(DOS,51)+1:1:54 O %DEV::0 Q:$T
SCA1 ;I $$Open^%ZAPM.bs.BSXdos(FNO,"R")<0 G STOPSCAN
 ;S DOSO=DOS,DOS=%DEV I $$Open^%ZAPM.bs.BSXdos(FN,"W")<0 G STOPSCAN
 ;S DOSIN=DOSO,DOSOUT=DOS X $G(CU(16)) I $G(STOPSCAN) G STOPSCAN
 k fT2 d fT1(.fT1,.fT2) k fT1 m fT1=fT2 k fT2
 d Wait^%ZAPM.bs.BSXfun("освобождения от мусора и разрезка "_%FN)
 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSF11"
 ;U DOS W "%BS-SCANINIG ",$G(say),!
 D fT2("%BS-SCANINIG "_$G(say))
 ;S ST="" F v=1:1 U DOSO  R I D  D:I'="" CUT(I) //I '(v#10) U 0 X $G(WA) /////Q:$ZC'=0
 S ST="",i="" F v=1:1 S i=$O(fT1(i)) Q:i=""  S I=fT1(i) D  D:I'="" CUT(I)
 .S I=$TR(I,CU(2),CU(4))
 .I $P(CU(14),"/",3)="Y" S I=$$Cut^%ZAPM.bs.BSF10(I)
 .I $P(CU(14),"/",2)="Y" S I=$$Cut^%ZAPM.bs.BSF10(I,1)
 .I I[CU(6),I'[CU(8) S I=$$TR^%ZAPM.bs.BSsFUNM(I,CU(6),CU(8))
 .I I[CU(10),I'[CU(12) S I=$$TR^%ZAPM.bs.BSsFUNM(I,CU(10),CU(12))
 .I $P(CU(14),"/",1)="Y" F M=1:1 Q:$E(I,M)=""  I $A($E(I,M))<32 S I=$E(I,1,M-1)_$E(I,M+1,$L(I))
 .I '$D(FIRST),I'[CU(12) S I=""
 .I '$D(FIRST),I[CU(12) S FIRST=1
STOPSCAN ;I $P(CU(14),"/",4)'="Y" S %FN=FN C DOSO,DOS G SCA
 ;C DOSO,DOS W /CUP(22,1) D EXE^%ZAPM.bs.BSDOS("COPY "_FN_" "_FNO,1) 
 ;W /CUP(22,1) D EXE^%ZAPM.bs.BSDOS("DEL "_FN,1)
SCA ;I $ZV["Cach"||($ZV["IRIS") C FN,FNO S %DEV=%FN G SCA2
 ;C %DEV F %DEV=$G(%Dev,51):1:54 O %DEV::0 Q:$T
 ;S DOS=%DEV
SCA2 ;I $$Open^%ZAPM.bs.BSXdos(%FN,"R")
 ;U %DEV R %IN
 S fT2=$O(fT2("")),%IN=$G(fT2(fT2)) 
 Q
fT2(S) S fT2=$G(fT2)+1,fT2(fT2)=S //ЗАПИСЬ В НОВЫЙ МАССИВ
 Q
fT1(fT2,fT1) n i s i="" F  S i=$O(fT2(i)) Q:i=""  I $G(fT2(i))'="" D  S fT1(i)=fT2(i) I $G(fT1)="" S fT1=i
 .I $E(fT2(i),$L(fT2(i)))="="!(fT2(i)["+++") Q  //выравнивание по =
 .N A,ii,AA S AA=fT2(i),A=$P(fT2(i),"=",$L(fT2(i),"=")),fT2(i)=$P(fT2(i),"=",1,$L(fT2(i),"=")-1)_"="
 .S ii=$O(fT2(i)) I ii="" S fT2(i)=AA Q
 .S fT2(ii)=A_$G(fT2(ii))
 q
ERFILE S $ZT=$G(%zT) I $ZE["<ENDOFFILE" G STOPSCAN
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE))
 Q
CUT(I) ;РАЗРЕЗКА
 I $L(ST_I)>4000 D CU(ST)
 S ST=ST_I I ST["=++" D CU(ST) D fT2($TR(ST,S1,S2)) S ST="" //U DOS W $TR(ST,S1,S2),! S ST=""
 Q
CU(S) N SS
 S SS=""
 F M=1:1 Q:$P(S,"=",M,M+1)=""  S SS=SS_$P(S,"=",M)_"=" I $L(SS)>74 D fT2($TR(SS,S1,S2)) S SS="" //U DOS W $TR(SS,S1,S2),! S SS=""
 S ST=SS
 Q
UNMARK(U) N I,J ;СНЯТЬ ПОМЕТКУ С ТАБЛИЦЫ
 F I=1:1 Q:$G(@U@(I,1))=""  F J=1:1 Q:$G(@U@(I,J))=""  S $P(@U@(I,J),"@",12)=""
 S $P(@U,"@",3)="" Q
TEMPFILE() ;ВРЕМЕННЫЙ ФАЙЛ
 Q "%BSTEMP.TMP"
RANDFILE() ;СЛУЧАЙНОЕ ИМЯ ФАЙЛА
 Q $R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_".TMP"
TMPG() ;СЛУЧАЙНАЯ ССЫЛКА ВРЕМЕННОГО МАССИВА
TMR N T S T=$NA(@"^%ZAPM.bs.BSbufB"@("TMP"_$TR($$RANDFILE(),".","")_$G(%BS(3),$P)_$J_"u1")) I $D(@T) G TMR
 Q T
MARK(U,M) N I,J,P ;ПОМЕТИТЬ ТАБЛИЦУ ПО ДАННЫМ В КЛЕТКАХ -->M
 S P=0 F I=1:1 Q:$G(@U@(I,1))=""  F J=1:1 Q:$G(@U@(I,J))=""  I $P(@U@(I,J),"@",15)'="",$D(@M@($P(@U@(I,J),"@",15))) S $P(@U@(I,J),"@",12)=1,P=P+1
 I 'P S $P(@U,"@",3)="" K %DIA Q
 S %DIA=1,$P(@U,"@",3)=P Q
STAT ;СТАТИСТИКА -=АС НЕФЕДОВ=-
 N (%BS) D SA^%ZAPM.bs.BSsBUF,^%ZAPM.bs.BSTAT,RE^%ZAPM.bs.BSsBUF
 Q
MENU ;ОБНОВЛЕНИЕ ВРЕМЕНИ В МЕНЮ
 Q:R1>332  I '$D(%BS(2,1)),$ZV'["Cach"&&($ZV'["IRIS") S %BS(2,1)=%BS(2),%BS(2)="1-D MENU^%ZAPM.bs.BST" Q
 I R1=13,R2=-1,R3=-1 D UNDOMENU Q
 I R1=27,R2=-1,R3=-1 D UNDOMENU
 Q
UNDOMENU I $D(%BS(2,1)) S %BS(2)=%BS(2,1) K %BS(2,1) Q
 D CLr^%ZAPM.bs.BSF4 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSCocx" type="MAC" languagemode="0"><![CDATA[
%BSCocx ; пpогpамма связи с КОМПОНЕНТОЙ - КЛЮЧИ БАЗЫ ДАННЫХ ; 14:56   06.11.2001
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
ACCES(BSLOGIN,BSSES) D VARKEY1 //ОБЩИЕ ПРАВА ДОСТУПА
 Q aCC1
VARKEY  S BSPART=$$Normalize^%ZAPM.bs.BSCGIS($G(BSocxP0kD)),BSTABL=$G(BSocxP0kS),PT=$NA(@BSPART@(BSTABL))
 S BD=$$KBD^%ZAPM.bs.BSF12(PT),gB=$NA(@BDSES@(BSSES,"VAR","KEYS",PT))
 M K=@PT@("KEY")
 M KK=@gB
 S STEP=$G(STEP,2) //ШАГ ПРИ ДВИЖЕНИИ В КОЛОНКАХ
 S DEL=$C(1) //РАЗДЕЛИТЕЛЬ
 S DEL0=$C(0)
 S gBuf=$NA(@BDSES@(BSSES,"VAR","BUFF",BSPART,BSTABL))
 S gBuf1=$NA(@BDSES@(BSSES,"VAR","BUF1",BSPART,BSTABL))
 S gBufCurKey=$NA(@BDSES@(BSSES,"VAR","CurKey")) 
VARKEY1 S BDUSE=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")
 I '$D(BSLOGIN) S BSLOGIN=$G(@BDSES@(BSSES,"NM"),"?")
 D VARaCC^%ZAPM.bs.BSCAsIs
varBLOCK S BDBLOCK=$$KBD^%ZAPM.bs.BSF12("^[""FON""]AsI(""BLOCK"")") //БД БЛОКИРОВОК
 Q
HISTORY //ИСТОРИЯ КЛЮЧЕЙ
 n BSkeH,BSkeH1
 W "<div align='LEFT'><TABLE BORDER=0><TR>"_BK d  W "</TR></TABLE></div>"_BK_BK
 .n t,y,i,N S t="<TD>"_GREEN,y=EF_"</TD>",N=$O(KK(""),-1),BSLABEL="HKEY0^~BSCocx",BSkeH=$S(BSkeyN>0:$G(KK(0)),1:""),BSkeH1=0
 .w t_$$TITHIS_y_t_" <A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>"_BSkeH_"</A> \ "_y_BK                                                                                                                                                                                                     ;$S(i=N:" \ )",1:",")
 .I N'="" S BSLABEL="HKEY0^~BSCocx" F i=1:1:N  Q:i=""  Q:i>(BSkeyN-1)  I $G(KK(i))'=""  S BSkeH=KK(i),BSkeH1=i W t_"<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"'>"_KK(i)_"</A> \ "_y_BK
 Q
TITHIS() N A S A=$P(@PT,"@",1) I A'="" Q A 
 Q "Ключи базы данных "_BD
HKEY0 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("База Данных: раздела ("_$$Normalize^%ZAPM.bs.BSCGIS($G(BSocxP0kD))_") и таблицы ("_$G(BSocxP0kS)_")")
 W $$B27^%ZAPM.bs.BSCGIS S BSPART=$$Normalize^%ZAPM.bs.BSCGIS($G(BSocxP0kD)),BSTABL=$G(BSocxP0kS),PT=$NA(@BSPART@(BSTABL)),BSkeyN=BSkeH1
 ;w "<hr>"_$g(BSkeH,"?")_"<hr>"
 g KEYS  
BSkeyCu I '$D(@gBufCurKey@(BSkeyCu)) Q
 N BSkeyCu1
 S BSkeyCu1=$G(@gBufCurKey@(BSkeyCu))
 S BSkeyN=$L(BSkeyCu1,",")-1 D  //УЖЕ ВХОДИЛИ В КЛЮЧИ
 .K KK F i=1:1 Q:$P(BSkeyCu1,",",i,i+1)=""  S KK(i-1)=$P(BSkeyCu1,",",i),BSkeH=KK(i-1)
 Q
 //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
KEYS //ПОХОД ПО всем КЛЮЧАМ
 N K,KK,InsDel
 N BSTOP2,BSaX,BSLOGINDFLT
 D VARKEY i $O(K(""))="" W "Ключей нет" Q
 K @gBuf1
 I $G(BSkeyCu)'="",'$D(BSkeyN) D BSkeyCu
KEYS1 I $G(BSkeyN)="" D  //ПЕРВЫЙ ВХОД
 .I $D(K(0)) S BSkeyN=0 Q
 .E  S BSkeyN=1
 D HISTORY I '$D(K(BSkeyN)) Q
 I $G(BSFlagRecord)'="" w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">" S BSLABEL="Packet^~BSCocx" D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<TABLE BORDER=0>"_BK d  W "</TABLE>"
 .n t,y,i,N
 .W "<TR><TD class=s4>Значения</TD><TD class=s4>ОПИСАНИЕ</TD><TD class=s3></TD></TR>"_BK
 .D
 ..I '$$ACCE(2)!($G(BSFlagRecord)'="") Q  //ВСТАВЛЯТЬ НЕЛЬЗЯ
 ..S BSLABEL="KEYNE^~BSCocx" W "<TR><TD class=s3></TD><TD class=s3><IMG BORDER=0 SRC='/b4y/img/ins.gif'><A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' TARGET='NEWKEY' title='Ввести новый ключ'>"_GREEN_$$NewKey(BSkeyN)_EF_"</A></TD><TD class=s3></TD></TR>"_BK
 .I $D(K(BSkeyN)) D KEYN(BSkeyN)
 W InsDel
 I $G(BSFlagRecord)'="" w "</form>"
 q
KEYN(KEY)  n sT,blockc,aProk,aProk1
 S InsDel=BK_$$js^%ZAPM.bs.BSCp_$$InsDel_$$jse^%ZAPM.bs.BSCp_BK
 I KEY=2 S aProk=$$GETOPT^%ZAPM.bs.BSC4cfgP("^[""FON""]AsI.PAR.OPT","aProk") I aProk S aProk1=$$GETOPT^%ZAPM.bs.BSC4cfgP("^[""FON""]AsI.PAR.OPT","aProk","O")
 I KEY D  G kk  //ИНДЕКСНЫЙ КЛЮЧ
 .D key(1)
 .S BSkey="" F kk=1:1 S BSkey=$O(@%NAm@(BSkey)) Q:BSkey=""  D
 ..d sT  W "<TR><TD class="_sT_">"_$$CHECKFLAG(kk)_"<A " D  W " ><IMG BORDER=0 SRC='"_$S(KEY=$O(K(""),-1):"/iss/img/list.gif",1:"/b4y/logo/open0.gif")_"'> "_BSkey_"</A></TD>" D TRAN(BSkey) W $$erase(0)_"</TR>"_BK
 ...I KEY=$O(K(""),-1) D  Q
 ....I '$$ACCE^%ZAPM.bs.BSCocx(3) W " TITLE='Раскрыть нельзя'" Q  ;W "У ВАС НЕТ ПРАВ РЕДАКТИРОВАТЬ ЗАПИСЬ"
 ....W "HREF=""javascript:Ins1('"_BSkey_"');"" TITLE='Редактировать'"
 ...I $G(BSFlagRecord)'="",'$D(K(BSkeyN+2)) Q  //РАСКРЫВАТЬ ДАЛЬШЕ НЕКУДА
 ...W "HREF=""javascript:Ins1('"_BSkey_"');"" TITLE='Раскрыть'"
 N M,GLL D CLO^%ZAPM.bs.BSCp,OPO^%ZAPM.bs.BSCp //ИМЕННОЙ КЛЮЧ
 S GLL=$P(BD,"]",2) F kk=1:1 S GLL=$$O^%ZAPM.bs.BSCp(GLL) Q:GLL=""  S M="^"_GLL I M[("^"_$P(BD,"]",2)),$P($G(@M),"@")="BSD - MSW" D
 .S BSkey=$E(GLL,$L(GLL)-1,$L(GLL)) d sT
 .W "<TR><TD class="_sT_"><A HREF=""javascript:Ins1('"_BSkey_"');"" TITLE='Раскрыть'><IMG BORDER=0 SRC='/b4y/logo/open1.gif'> "_BSkey_"</A></TD>" D TRAN(BSkey) W $$erase(0)_"</TR>"_BK
kk S sT="s3" W "<TR><TD class=s4>Количество узлов</TD><TD class=s4>"_(kk-1)_"</TD>"_$$erase(1)_"</TR>"
 Q
BLOCK() N Q,CH,BSref1 //БЛОКИРОВАТЬ\РАЗБЛОКИРОВАТЬ ЗАПИСЬ
 I $G(BDBLOCK)="" Q ""
 I BSkeyN'=2 Q ""
 I '$$ACCE^%ZAPM.bs.BSCocx(5) Q ""
 S BSref=$P($NA(@%NAm@(BSkey)),"AsIs",2)
 S CH=$$block(BSref)
 S Q="<input type=checkbox onclick=""open('"_$$ADDBSGET^%ZAPM.bs.BSC4(,"BLOCKON^~BSCocx")_"','','width=1,height=1');"" name=BLOCK "_$S(+CH:"CHECKED",1:"")_" title='БЛОКИРОВАТЬ\РАЗБЛОКИРОВАТЬ ЗАПИСЬ от РЕДАКТИРОВАНИЯ"_(BK_BK_$$BLOCKH($P(CH,"*",1)))_"'>"
 S BSref1=1,Q=Q_"<A HREF='' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"BLOCKON^~BSCocx")_""",""Hist"",""toolbar=no,menubar=no,scrollbars=no,width=800,height=500,status=1,resizable=1"");' TITLE='история блокировок'>?</A>"
 Q Q
BLOCKH(CH) Q "BLOCK"_$P(CH,",",1,2)_","_$$TD^%ZAPM.bs.BSC4base($P(CH,",",3,4))
BLOCKON D VARKEY S CH=$$block(BSref)
 I '$G(BSref1) D  Q  //переключатель
 .S @BDBLOCK@($P(BSref,"."),$P($P(BSref,".",2),"("),$P($P(BSref,",",1),"(",2),$P($P(BSref,",",2),")",1),"BLK")=$S(+CH:"0",1:1)_","_BSLOGIN_","_$H_"*"_$E($G(@BDBLOCK@($P(BSref,"."),$P($P(BSref,".",2),"("),$P($P(BSref,",",1),"(",2),$P($P(BSref,",",2),")",1),"BLK")),1,32000)
 .W $$js^%ZAPM.bs.BSCp W "window.close();"_BK W $$jse^%ZAPM.bs.BSCp_BK
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("история блокировок для узла "_BSref),$$B27^%ZAPM.bs.BSCGIS(1)
 W "<H4>Блокировки действуют только для Excel-интерфейса и потокового ввода</H4>"
 F I=1:1 Q:$P(CH,"*",I,I+1)=""  W "<LI>"_$$BLOCKH($P(CH,"*",I))
 W "<HR>" D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 Q
sT s sT="s"_$S(BSkey=$G(BSkeH):"2",1:"1")
 q
stdflt() Q $g(sT,"s1")
R2L(S) Q $TR(S,"Б","B")
L2R(S) Q $TR(S,"B","Б")
CHECKFLAG(i) i $G(BSFlagRecord)="" Q ""
 N Q S Q="<input type=SUBMIT name=BSx"_$$R2L(BSkey)_" value='пакет' title='Запустить формирование пакета'>"
 i $G(aProk) S Q=Q_"<input type=SUBMIT name=BSprok value='прокачка' title='"_aProk1_"'>" ;K aProk
 S Q=Q_"<input type=checkbox name=BSz"_$$R2L(BSkey)_" value='' title='Включить в формирование пакета'>"
 Q Q
PaRec(G) //РЕКУРСИВ ПО УЗЛАМ
 N K1,GG S K1="" F  S K1=$O(@G@(K1)) Q:K1=""  S GG=$NA(@G@(K1)) D  ;W BBK_GG_"--"_$QL(GG) D
 .I KEYS=($QL(GG)+1) D BD2BUF1(GG,zip,KEYS) Q
 .D PaRec(GG)
 Q
ZIP() q $s($g(BSFlagRecord,2)=2:0,1:1) //НАДО ЛИ ПОДЖИМАТЬ СТРОКИ
Packet D VARKEY ;ФОРМИРОВАНИЕ ПАКЕТА
 N I,II,Y,X,i,ii,KEYS,%NAm1,PACKET,zip S Y=0,PACKET=1,zip=$$ZIP()
 N KKK
 D KODSET K @gBuf1
 ;I U1=3 
 S DEL=$C(9)
 S I="" F  S I=$O(%KEY(I)) Q:I=""  I $E(I,1,3)="BSx"!($E(I,1,3)="BSz") S KKK($$L2R($E(I,4,99)))=""
 I $G(BSprok)'=""  D Prok^%ZAPM.bs.BSCAsIs5(BD,.KKK) Q
 S I="" F  S I=$O(KKK(I)) Q:I=""  S KK(BSkeyN)=I D key(0) D
 .I KEYS>(BSkeyN+1) D PaRec(%NAm) Q
 .I KEYS=(BSkeyN+1) D BD2BUF1(%NAm,zip,KEYS) Q
 S $P(@gBuf1,DEL0,6)=U1 //ВИД КОДИФИКАТОРА В БОКОВИНЕ 3-4
 S $P(@gBuf1,DEL0,3)=Y //КОЛ-ВО СТРОК ВСЕГО В КОДИФИКАТОРЕ ИЛИ ВСЕЙ МАТРИЦЕ
 S $P(@gBuf1,DEL0,1)=DEL
 S $P(@gBuf1,DEL0,2)="...Пакет"
 I $G(BSkeyCu)'="" D
 .S @gBufCurKey@(BSkeyCu)=CKey //МАССИВ В БД СЕССИЙ ^BSSES(ActiveSheet.Name)=CurentKey
 .I $$EditCount(gBufCurKey,BSkeyCu,0) //ОБНУЛИТЬ СЧЕТЧИК РЕДАКТИРВАНИЙ
 W $$js^%ZAPM.bs.BSCp_BK
 W "status='Status :CloseWin:Report:"_$G(BSSES)_":"_$G(PT)_":"_$G(%NAm)_"'"_BK
 W $$jse^%ZAPM.bs.BSCp_BK
 ;D locvar^%ZAPM.bs.BSCh0("")
 Q
key(N) S %NAm=BD_$G(KK(0)),CKey=$G(KK(0))
 F ii=1:1:BSkeyN-N Q:'$D(KK(ii))  D
 .S %NAm=$NA(@%NAm@(KK(ii)))
 .S CKey=CKey_","_$G(KK(ii))
 Q
erase(BSocxM) //КНОПКА ДЛЯ УДАЛЕНИЯ УЗЛОВ
 I BSocxM=1,$G(blockc) G ee
 I BSkeyN=0&(BSocxM=1) G ee
 I '$$ACCE(BSocxM)!($G(BSFlagRecord)'="") G ee  //ЕСЛИ НЕ ПОЛОЖЕНО ТО НЕЛЬЗЯ
 I $$blockIS($NA(@%NAm@(BSkey))) S blockc=$G(blockc)+1 G ee  //ЗАБЛОКИРОВАН
 I '$D(aCC1) D VARKEY1
 i aCC1<4 g ee //удалять узлы нельзя
 N Q,BSLABEL 
 S Q="<TD class="_$$stdflt_"><A HREF=""javascript:Del1('"_$G(BSkey)_"','"_BSocxM_"','"_BSkeyN_"');"" title='"_$S(BSocxM=1:$$erase1,1:$$erase2)_"'><IMG SRC='"_BSDOMAIN_"/img/kill"_$S(BSocxM=1:"1",1:"")_".gif' BORDER=0></A>"
 q Q_"</TD>"
ee Q "<TD></TD>"
erase1() q "Удалить все ключи текущего уровня"
erase2() q "Удалить ключ со всеми потомками"
ERA //УДАЛИТЬ
 N K,KK  D VARKEY
 S KK(BSkeyN)=BSkey
 D key(BSocxM) 
 ;проверим на блокировку
 i $$block^%ZAPM.bs.BSCocx($P(%NAm,"AsIs",2))  W BLUE_"Узел блокирован !!!"_%NAm_EF_BBK I 1
 E  K @%NAm W RED_"Удалили узел "_%NAm_EF_BBK
 G HKEY0
 Q
InsDel() //МОДУЛИ - ВСТАВИТЬ-УДАЛИТЬ
 S BSLABEL="KEYNA^~BSCocx"
 N Q S Q="function Ins1(K) {"_BK D
 .N BSkey
 .S Q=Q_"location='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&BSkey='+ K;"_BK
 S Q=Q_"}"_BK
 S BSLABEL="ERA^~BSCocx"
 S Q=Q_"function Del1(K,KK,KKK) {"_BK D
 .N BSkey,BSkeH1
 .S Q=Q_"var s='"_$$erase2_"';"_BK
 .S Q=Q_"if (KK=='1') { s='"_$$erase1_"'; }"_BK
 .S Q=Q_"var a=prompt(s+' `'+K+'`! Удалить? Да=1, Нет=0','1');"_BK
 .S Q=Q_"if (a=='1') { location='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"&BSkey='+ K + '&BSocxM='+ KK + '&BSkeH1='+ KKK; }"_BK
 S Q=Q_"}"_BK
 Q Q
ACCE(KOD) //ПРАВА ДОСТУПА
 ;KOD=1 - УДАЛЕНИЕ ВСЕХ УЗЛОВ НА УРОВНЕ
 ;KOD=0 - УДАЛЕНИЕ ОДНОГО УЗЛА
 ;KOD=2 - ВСТАВКА НОВЫХ УЗЛОВ
 ;KOD=3 - РЕДАКТИРОВАТЬ ЗАПИСЬ
 ;KOD=4 - РЕДАКТИРОВАТЬ КОНКРЕТНУЮ ЗАПИСЬ
 ;KOD=5 - РЕДАКТИРОВАТЬ ТОБД
 ;Может потом попозже сделать матрицу параметров с CHECKbox-ами в перекрестиях
 I '$D(aCC1) D VARKEY1
 i KOD=5,aCC1>4 Q 1
 i KOD=5,aCC1'>4 Q 0
 I aCC1<3 Q 0
 Q 1
NewKey(KEY) N A S A=$P(K(KEY),"@",5) I A'="" Q A
 Q "Ввести "_$S(BSkeyN:"",1:"Именной")_" новый ключ"
TRAN(D) W "<TD class="_$$stdflt_">" D  W $$BLOCK_"</TD>"
 .I D="" W ".." 
 .W $$TRANKEY(KEY,D)
 Q
TRANKEY(Ke,KDa) N d,d0,d1,nx,ny
 S (d,d1,d0)=KDa //ТРАНСФОРМАЦИЯ ДАННЫХ КЛЮЧЕЙ
 I 'Ke Q "Год"
 I $G(K(Ke,3))'="" S $ZT="ERTRA" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .S ny=1,nx=1 X K(Ke,3)
 Q d1 
KEYNA //РЕДАКТИРОВАТЬ
 N K,KK  D VARKEY
 I $D(BSkey) D
 .S KK(BSkeyN)=BSkey
 .M @gB=KK
 S BSkeyN=BSkeyN+1
 I '$D(K(BSkeyN+1)) D  Q:$G(BSnoTABEL)=""  //КЛЮЧИ КОНЧИЛИСЬ
 .I $G(BSnoTABEL)'="" Q  //ЭТО НЕ ТАБЕЛЬ
 .D key(1),BD2BUF ;D locvar^%ZAPM.bs.BSCh0("",1) Q
 .S $P(@gBuf1,DEL0,1)=DEL
 .S $P(@gBuf1,DEL0,2)=CKey
 .I $G(BSkeyCu)'="" D
 ..S @gBufCurKey@(BSkeyCu)=CKey //МАССИВ В БД СЕССИЙ ^BSSES(ActiveSheet.Name)=CurentKey
 ..I $$EditCount(gBufCurKey,BSkeyCu,0) //ОБНУЛИТЬ СЧЕТЧИК РЕДАКТИРВАНИЙ
 .W $$js^%ZAPM.bs.BSCp_BK
 .W "status='Status :CloseWin:Report:"_$G(BSSES)_":"_$G(PT)_":"_$G(%NAm)_"'"_BK
 .W $$jse^%ZAPM.bs.BSCp_BK
 I $G(BSnoTABEL)'="",'$D(K(BSkeyN)) D EDIT^%ZAPM.bs.BSC4news S BSkeyN=BSkeyN-1 
 D VAR^%ZAPM.bs.BSCGIS //ЭТО НЕ ТАБЕЛЬ---ПРОДОЛЖЕНИЕ
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Редактирование БД : раздела ("_$$Normalize^%ZAPM.bs.BSCGIS($G(BSocxP0kD))_") и таблицы ("_$G(BSocxP0kS)_")")
 W $$B27^%ZAPM.bs.BSCGIS
 D KEYS1 I $G(BSkeyCC)'="" D BUTT^%ZAPM.bs.BSCGIS
 Q
RETURNGR(BSSES,BSocxP0kD,BSocxP0kS) D MAINVAR^%ZAPM.bs.BSC4 //ВОЗВРАТИТЬ ССЫЛКУ НА МАТРИЦУ ЗНАЧЕНИЙ КЛЮЧЕЙ
 D VARKEY I '$D(@gBuf1) Q ""
 ZN P6
 f i=1:1:3 s P=$g(@PT@("KEYexcel",i)) D  //НОМЕРА СТРОК,КОЛОНОК...
 .s @("P"_(5+i))="" i $p(P,"-",3),($p(P,"-",2)[",") s @("P"_(5+i))=$p(P,"-",2)
 Q gBuf1
 //////////////////////////////////////////////////////////////////////////////////////////
BD2BUF //собрать данные из БД в буфер
 D KODSET K @gBuf1 ; D locvar^%ZAPM.bs.BSCh0("ky") Q
 I '$D(U1) Q
 I U1=3 S DEL=$C(9)
 S Y=0 
 D BD2BUF1(%NAm,$$ZIP(),BSkeyN)
 S $P(@gBuf1,DEL0,6)=U1 //ВИД КОДИФИКАТОРА В БОКОВИНЕ 3-4
 S $P(@gBuf1,DEL0,3)=Y //КОЛ-ВО СТРОК ВСЕГО В КОДИФИКАТОРЕ ИЛИ ВСЕЙ МАТРИЦЕ
 S $P(@gBuf1,DEL0,4)=ky(BSkeyN,1) //КОЛОНКА ГДЕ ЛЕЖИТ TXT
 S $P(@gBuf1,DEL0,7)=$$blockIS(%NAm) //заблокированна ли эта ссылка от коррекции
 Q
block(BSref) i '$d(BDBLOCK) D varBLOCK
 q:$P(BSref,".")="" "" q:$P($P(BSref,".",2),"(")="" "" q:$P($P(BSref,",",1),"(",2)="" "" q:$P($P(BSref,",",2),")",1)="" ""
 Q $G(@BDBLOCK@($P(BSref,"."),$P($P(BSref,".",2),"("),$P($P(BSref,",",1),"(",2),$P($P(BSref,",",2),")",1),"BLK"))
blockIS(G) N BSref,I,STOP I $G(BDBLOCK)="" Q 0
 I $QS(G,2)'="" S BSref=$P($P(G,"AsIs",2),"(")_"("_$QS(G,1)_","_$QS(G,2)_")" Q +$$block(BSref)
 I $QL(G)=1,$QS(G,1)'="" S I="" F  S I=$O(@G@(I)) Q:I=""  S BSref=$P($P(G,"AsIs",2),"(")_"("_$QS(G,1)_","_I_")" I +$$block(BSref) S STOP=1 Q
 Q +$g(STOP)
BD2BUF1(%NAm,ZIP,BSkeyN) N I,II,X,i,ii,d1
 S I="" F  S I=$O(@KODS@(U1,I)) Q:I=""  S Y=Y+1 D
 .S ID1=$S(U1=1:I,1:$P(@KODS@(U1,I),DEL0,1))
 .D  ;I U1=3 d  //U1=3 КОДИФИКАТОР    U1=4 ЭТО ПРЕДМЕТНАЯ БОКОВИНА
 ..f i=1:1:BSkeyN-1 i $d(ky(i)) S $P(@gBuf1@(Y),DEL,ky(i))=$QS(%NAm,i) ;$p(CKey,",",i+1)
 ..//А ЭТО РАСШИФРОВКА КОДА
 ..;I U1=3,$G(ky(BSkeyN,1)) S $P(@gBuf1@(Y),DEL,ky(BSkeyN,1))=$s(KODS["]AsIKodNVC":$P($G(@KODS@(1,ID1)),"~",1)_" "_$P($G(@KODS@(1,ID1)),"~",2),1:$G(@KODS@(1,ID1))) //TXT
 ..D
 ...I '$D(PACKET),U1=4 Q
 ...I $G(ky(BSkeyN,1)) S $P(@gBuf1@(Y),DEL,ky(BSkeyN,1))=$s(KODS["]AsIKodNVC":$P($G(@KODS@(1,ID1)),"~",1)_" "_$P($G(@KODS@(1,ID1)),"~",2),1:$G(@KODS@(1,ID1))) //TXT
 ...S $P(@gBuf1@(Y),DEL,ky(BSkeyN))=ID1 //КОД
 .;S X=$S(U1'=3:2,1:$p(BSkeyCC,",",2)-1)
 . S X=$p(BSkeyCC,",",2)-1
 .S II="",d1=0 F  S II=$O(@KODL@(U2,II)) Q:II=""   D
 ..S ID2=$S(U2=4:$P(@KODL@(U2,II),DEL0,1),1:II),X=X+1
 ..S d=$G(@%NAm@(ID1,ID2)) I d'="" S d1=d1+1
 ..S $P(@gBuf1@(Y),DEL,X)=d
 .I ZIP i 'd1 K @gBuf1@(Y) S Y=Y-1 //ЕСЛИ ВКЛ ПОДЖАТИЕ И ПУСТАЯ СТРОКА
 ;.s $P(@gBuf1@(Y),DEL,10)=ZIP
 S $P(@gBuf1,DEL0,4)=ky(BSkeyN,1) //КОЛОНКА ГДЕ ЛЕЖИТ TXT
 Q
KODSET S KEYS=$O(K(""),-1) I '$D(@PT@("KEYexcel")) Q
 S KODS=@PT@("KEYexcel",KEYS,1) //КОДИФИКАТОРЫ
 S KODL=@PT@("KEYexcel",KEYS+1,1)
 f U1=4,3,1 I $D(@KODS@(U1)) Q
 f U2=4,3,1 I $D(@KODL@(U2)) Q
 N i,ii //ky(i,1) ГДЕ И КАК ВЫВОДИТЬ КЛЮЧИ
 K ky F i=1:1:KEYS S ii=@PT@("KEYexcel",i),ky(i)=$P($P(ii,"^",2),",",2) D
 .I $P($P(ii,"^",2),",",1)=1,$P(ii,"-",2)'["," D
 ..S ky(i,1)=$P($P(ii,"-",2),":",1) I ky(i,1)="" S ky(i,1)=ky(i)
 Q
EditCount(GB,ASName,C)
 I $D(C) D
 .I C=0 S @GB@(ASName,"EditCount")=C Q
 .S @GB@(ASName,"EditCount")=$G(@GB@(ASName,"EditCount"))+C
 Q $G(@GB@(ASName,"EditCount"))
INV(KD,%2,%3) //ИНВЕРТИРОВАННЫЕ МАССИВЫ
	N i2 I $D(@KD@(1)) D  Q 1
	.S i2="" 
	.i '$d(@KD@(3)) F  S i2=$O(@KD@(1,i2)) Q:i2=""  W "<OPTION VALUE="_i2_">"_i2_" ==="_$P($G(@KD@(1,i2)),"~",1,2)_"</OPTION>"
	.i $d(@KD@(3)) s DEL=$g(@KD@(3),$c(0)) F  S i2=$O(@KD@(3,i2)) Q:i2=""  W "<OPTION VALUE="_$P($G(@KD@(3,i2)),DEL,1)_">"_$P($G(@KD@(3,i2)),DEL,1)_" ==="_$P($G(@KD@(3,i2)),DEL,2,99)_"</OPTION>"
	Q KD
inv S $ZT="inverr"	X "S i1="_i2	Q
inverr W "<OPTION VALUE=''>Error="_$ZE_"</OPTION>" Q
LISTKEY //СПИСОК КЛЮЧЕЙ
	N i1,i2
	;W "<BUTTON onclick='alert(11);' title='Выбрать из списка'><IMG SRC='"_BSDOMAIN_"/img/tabl.gif'></BUTTON>"
	W "<SELECT NAME=BSKeY"_ii_" " d  w "><OPTION></OPTION>"_BK
	.;w "size=1 onclick=""javascript: {if (''!=BSKeY"_ii_".value & 'undefined'!=BSKeY"_ii_".value) NK"_ii_".value=BSKeY"_ii_".value;}"" "
	I ii=0,$P(K(ii),"@",5)["ГОД" F i1=1:1:6 S i2="0"_i1 W "<OPTION VALUE="_i2_">"_i2_"</OPTION>"
	I ii=1,$P(K(ii),"@",5)["ДАТ" S i2=20040128 W "<OPTION VALUE="_i2_">"_i2_"</OPTION>"
	S i2=$G(K(ii,2)) I i2["$$INV" D inv I '$G(i1) W "<OPTION VALUE=''>NoMass="_i1_"</OPTION>"
	W "</SELECT>"_BK
	Q
KEYNE //НОВЫЙ КЛЮЧ
 N K,KK D VARKEY,BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Ввод новых ключей. Для Раздела ("_$$Normalize^%ZAPM.bs.BSCGIS($G(BSocxP0kD))_") и таблицы ("_$G(BSocxP0kS)_")") W $$B27^%ZAPM.bs.BSCm4
 W "<form name='NEWK1' action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 N BSLABEL,BSTOP,BSNSP1,FirstNam
 S BSLABEL="SAVEKEY^~BSCocx"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W BK_"<TABLE BORDER=0>"_BK d  W "</TABLE>"
 .F ii=0:1:BSkeyN-1 I $G(KK(ii))'="" W "<TR><TD class=s3>"_ii_"</TD><TD class=s3>"_$P(K(ii),"@",9)_"</TD><TD class=s3>"_GREEN_$G(KK(ii))_EF_"</TD></TR>"_BK
 .N x1 S x1=$S($G(BSnoTABEL)="":1,1:0)
 .F ii=BSkeyN:1:($O(K(""),-1)-x1) D  //I $P(K(ii),"@",6)'="HiddenLastKey" d
 ..W "<TR><TD class=s3>"_ii_"</TD><TD class=s3>"_$P(K(ii),"@",5)_"</A></TD><TD class=s3><input type=text size=20 maxlength=48 name='NK"_ii_"' value=''>"
 ..D LISTKEY
 ..W "</TD></TR>"_BK
 W "</TABLE>"
 W "<HR>" D BU2^%ZAPM.bs.BSC4cfgP W "</FORM>"_BK
 Q
SAVEKEY //СОХРАНИТЬ НОВЫЕ КЛЮЧИ
 N K,KK,NKK D VARKEY
 M NNK=KK ;D locvar^%ZAPM.bs.BSCh0("KK,NNK")
 F ii=0:1:$O(K(""),-1) d
 .I $G(@("BSKeY"_ii))'="" S NNK(ii)=$G(@("BSKeY"_ii))
 .I $G(@("NK"_ii))'="" S NNK(ii)=$G(@("NK"_ii))
 s A=$$CHECKEY(.NNK) I A'="" D   G KEYNE
 .w RED_A_EF
 I '$D(@%NAm) S @%NAm=$$h^%ZAPM.bs.BS3()_","_$G(BSLOGIN)_",#,"_$$h^%ZAPM.bs.BS3(),A=$QS(%NAm,0) I $P($G(@A),"@")'["BSD - MSW" S @A="BSD - MSW"
 S BSkeH1=BSkeyN,BSkeH=NNK(BSkeH1) ;W BSkeH1,NNK(BSkeH1) G KEYNE
 N BSkeyN
 d  ;ОБНОВИТЬ РОДИТЕЛЬСКИЙ ФРЭЙМ 
 .W $$js^%ZAPM.bs.BSCp_BK s BSLABEL="HKEY0^~BSCocx"
 .W "opener.location='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"';"_BK
 .W "window.close();"_BK
 .W $$jse^%ZAPM.bs.BSCp_BK
 Q
CHECKEY(KK) N Q S Q=""  //ПРОВЕКА КЛЮЧЕЙ НА ВАЛИДНОСТЬ
 N N,ii,BSkeyN,GOD S BSkeyN=$O(K(""),-1) 
 F ii=0:1:BSkeyN D
 .Q:'$D(KK(ii))  I $G(KK(ii))="" S Q=Q_BBK_ii_" Ключ. Пустое значение у ключа" Q
 .I ii=1,KK(ii)'="" S GOD=KK(ii)
 .N ls,%0,YES
 .S %0=$$CHECKEYRTR(ii,KK(ii)) 
 .I 'YES S Q=ii_" Ключ. Ошибка : "_$G(ls) Q //СИНТАКСИЧЕСКИЙ КОНТРОЛЬ
 .I $G(BSnoTABEL)="",ii=2,$E(%0,1,4)'=GOD S Q=ii_" Ключ. Ошибка НЕСООТВЕТВИЕ ДАТЫ ГОДУ "
 .S KK(ii)=%0
 I Q="" D key(0)
 Q Q
CHECKEYRTR(Ke,KDa) N d,d0,d1,nx,ny S (d,d1,d0)=KDa,ls="",YES=1 //ТРАНСФОРМАЦИЯ ДАННЫХ КЛЮЧЕЙ
 I $G(K(Ke,1))="" Q d
 S $ZT="ERTRA"
 I d0="" S d0=0
 S ny=1,nx=1 X K(Ke,1) I YES S ls=""
 Q d1
 /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
FCount N A,ny,nx,L,FErr,Log //ВЫЧИСЛЕНИЯ
 D SETL("FCL")
 S ny=R1-1,FErr=0  F  S ny=$O(@G@(ny)) Q:ny=""  D
 .N A F nx=1:1:C2-C1+1 I $P($G(@G@(ny)),DEL0,nx)'="" S A=1
 .I $G(A) S nx="" F  S nx=$O(L(nx)) Q:nx=""  D FCouD(ny,nx)
 I FErr,$D(Log) M @BDSES@(BSSES,"VAR","ERR","COU")=Log s P5=P5+FErr
 Q
FCouD(ny,nx) N d1 S $ZT="FCountE^%ZAPM.bs.BSCocx"
 X L(nx)  S:d1["." d1=$TR($FN(d1,"P",2)," ","") S $P(@G@(ny),DEL0,nx-C1+1)=d1
 Q
FCountE ;I $ZE["<DIVIDE>" Q  //МОЖЕТ ПОКА ТАК!
 N A,AA S FErr=FErr+1,Log(ny,nx,"ER")=$$TRa^%ZAPM.bs.BSCh0($ZE)
 I $ZE["<DIVIDE>" S Log(ny,nx,"ER")=Log(ny,nx,"ER")_" !!! Деление на нуль !!!" D
 .S Log(ny,nx,1)=L(nx,1) ;,Log(ny,nx,2)=L(nx,2)
 .S A="S AA="""_$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(L(nx,2),"{","{""_$$A^%ZAPM.bs.BSCocx("),"}",")_""}")_""""  //ПОДСТАВИТЬ ТЕКУЩИЕ ЗНАЧЕНИЯ
 .X A I AA["{}/{}"!(AA["{0}/{0}")!(AA["{0}/{}")!(AA["{}/{0}") K Log(ny,nx) S FErr=FErr-1 Q  //НЕ СЧИТАЕТСЯ ОШИБКОЙ
 .S Log(ny,nx,2)=AA
 Q
 ////////////////////////////////////////////////////////////////////////////////////////////
FLogE S FErr=FErr+1,Log(ny,nx,"ER")=$$TRa^%ZAPM.bs.BSCh0($ZE)  //ЛОГ КОНТРОЛЬ
 Q
FLogD(ny,nx) N A,AA S $ZT="FLogE^%ZAPM.bs.BSCocx"
 X L(nx) E  S FErr=FErr+1 D
 .S Log(ny,nx,1)=L(nx,1)
 .S A="S AA="""_$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(L(nx,2),"{","{""_$$A^%ZAPM.bs.BSCocx("),"}",")_""}")_""""  //ПОДСТАВИТЬ ТЕКУЩИЕ ЗНАЧЕНИЯ
 .X A S Log(ny,nx,2)=AA
 Q
FLogErr() N A,ny,nx,L,FErr,Log S Log="Ошибки ЛОГИЧЕСКОГО КОНТРОЛЯ"_BK_BK,FLogErr=0
 D SETL("COL")
 S ny=R1-1,FErr=0  F  S ny=$O(@G@(ny)) Q:ny=""  D
 .N A F nx=1:1:C2-C1+1 I $P($G(@G@(ny)),DEL0,nx)'="" S A=1
 .I $G(A) S nx="" F  S nx=$O(L(nx)) Q:nx=""  D FLogD(ny,nx)
 I FErr M @BDSES@(BSSES,"VAR","ERR","LOG")=Log
 Q FErr
SETL(F)  S ny="",UGX=$P($P(RCYXSS,"-",2),",",2),UGY=$P($P(RCYXSS,"-",2),",",1)
  F  S ny=$O(@BSR@(BST,F,ny)) Q:ny=""  S nx=""  D  Q
  .F  S nx=$O(@BSR@(BST,F,ny,nx)) Q:nx=""  D
  ..I $G(@BSR@(BST,F,ny,nx,5)) D
  ...N XX S XX=@BSR@(BST,F,ny,nx,5)
  ...S L(XX)=$$TR^%ZAPM.bs.BSsFUNM($G(@BSR@(BST,F,ny,nx,3)),"$$A^%ZAPM.bs.BSA(","$$A^%ZAPM.bs.BSCocx(") //ФОРМУЛЫ НА ЛЮБУЮ СТРОКУ
  ...S L(XX,1)=$G(@BSR@(BST,F,ny,nx,1))
  ...S L(XX,2)=$G(@BSR@(BST,F,ny,nx,4))
 Q
A(ny,nx) Q $TR($P($G(@G@(ny)),DEL0,nx-C1+1),",",".") //ДЛЯ ПЕРЕВЫЧИСЛЕНИЯ
Buf2bd(BSSES,BSLOGIN,G,BSocxP0kD,BSocxP0kS,DEL0,RCYXSS,BSkeyCu,BSNSP,LOGFLAG) //СОХРАНИТЬ ИЗ БУФЕРА В БД
 D MAINVAR^%ZAPM.bs.BSC4
 D VARKEY 
 K @gBuf1,@gBuf,KK D BSkeyCu I '$D(KK) Q "НЕТ БУФЕРА ТЕКУЩИХ КЛЮЧЕЙ!"
 S BSR=BSPART,BST=BSTABL
 S C1=$P($P(RCYXSS,"-",1),",",2),C2=$P($P(RCYXSS,"-",1),",",4),R1=$P($P(RCYXSS,"-",1),",",1),R2=$P($P(RCYXSS,"-",1),",",3)
 S BSkeyN=BSkeyN+1,Korr=0
 D key(1) D KODSET K @BDSES@(BSSES,"VAR","ERR")
 S P5=0 I $D(@BSR@(BST,"FCL")) D FCount ;I P5 Q P5 //ВЫЧ
 I LOGFLAG I $D(@BSR@(BST,"COL")) S ErrLog=$$FLogErr I ErrLog S P5=ErrLog Q "Всего ошибок "_ErrLog //ЛОГ
 S I="",R=R1 F  S I=$O(@KODS@(U1,I)) Q:I=""  D
 .S ID1=$S(U1=1:I,1:$P(@KODS@(U1,I),DEL0,1))
 .S C=0
 .S II="" F  S II=$O(@KODL@(U2,II)) Q:II=""   D
 ..S ID2=$S(U2=4:$P(@KODL@(U2,II),DEL0,1),1:II),C=C+1
 ..S d=$P($G(@G@(R)),DEL0,C)
 ..I d'="",$G(@%NAm@(ID1,ID2))'=d S @%NAm@(ID1,ID2)=d,Korr=Korr+1 
 ..I d="",$G(@%NAm@(ID1,ID2))'="" K @$ZR S Korr=Korr+1
 .S R=R+1
 D FLAG^%ZAPM.bs.BSF(%NAm,"?",BSLOGIN)
 I $$EditCount(gBufCurKey,BSkeyCu,0) //ОБНУЛИТЬ СЧЕТЧИК РЕДАКТИРВАНИЙ
 Q "Записано. "_Korr_" Испавлений."
OLDVALUE(r1,c1) //ВОЗВРАТИТЬ СТАРОЕ ЗНАЧЕНИЕ
 K @gBuf1,@gBuf,KK S BSkeyCu=ASName
 D BSkeyCu I '$D(KK) Q "НЕТ БУФЕРА ТЕКУЩИХ КЛЮЧЕЙ!"
 S C1=$P($P(RCYXSS,"-",1),",",2),C2=$P($P(RCYXSS,"-",1),",",4),R1=$P($P(RCYXSS,"-",1),",",1),R2=$P($P(RCYXSS,"-",1),",",3)
 S BSkeyN=BSkeyN+1,BD=$$KBD^%ZAPM.bs.BSF12(PT) ;Q BD ;+1 ;Q KK(3)
 D key(1) M K=@PT@("KEY") ;Q ","_K_","
 D KODSET K d ;Q %NAm ;"?"  ;U1","_U2
 S I="",R=R1 F  S I=$O(@KODS@(U1,I)) Q:I=""  D  Q:$D(d)
 .S ID1=$S(U1=1:I,1:$P(@KODS@(U1,I),DEL0,1))
 .S C=C1-1
 .S II="" F  S II=$O(@KODL@(U2,II)) Q:II=""   D  Q:$D(d)
 ..S ID2=$S(U2=4:$P(@KODL@(U2,II),DEL0,1),1:II),C=C+1
 ..I R=r1,C=c1 S d=$G(@%NAm@(ID1,ID2)) Q  ;,d=ID1_","_ID2 Q
 .Q:$D(d)
 .S R=R+1 
 Q $G(d)
Y1(r1) ;Q (r1-$P($P(RCYXSS,"-",1),",",1))*$P(RCYXSS,"-",4)+$P($P(RCYXSS,"-",2),",",1)
 Q $P($P(RCYXSS,"-",2),",",1)
X1(c1) Q (c1-$P($P(RCYXSS,"-",1),",",2))*$P(RCYXSS,"-",3)+$P($P(RCYXSS,"-",2),",",2)
 // СИНТАКСИЧЕСКИЙ КОНТРОЛЬ
ReturnSNX(BSSES,BSocxP0kD,BSocxP0kS,BSNSP,r1,c1,RCYXSS,li,ASName,BSLOGIN) //СИНТАКСИЧЕСКИЙ КОНТРОЛЬ
 D MAINVAR^%ZAPM.bs.BSC4
 D VARKEY S BSR=BSPART,BST=BSTABL
 I $$ZU^%ZAPM.bs.BSF4(BSNSP)="" Q "Ошибка доступа к рабочей области "_BSNSP 
 I aCC1<3 S P2=$$OLDVALUE(r1,c1) Q "Пользователь `"_BSLOGIN_"` редактировать не имеет право"
 S nx=$$X1(c1)
 S ny=$$Y1(r1) ;Q ny_","_nx
 I '$D(@BSR@(BST,ny,nx)) Q "Нет узла "_$ZR
 I $P(@BSR@(BST,ny,nx),"@",9)<2 Q 1
 I $$EditCount(gBufCurKey,ASName,1)
 S BS=$G(@BSR@(BST,ny,nx)),YES=$$RTR(BS,BSR,BST,.li,ny,nx) I 'YES S P2=$$OLDVALUE(r1,c1) ;СТАРОЕ ЗНАЧЕНИЕ
 S P9=li //А ЭТО НОВОЕ ТРАНСФОРМИРОВАННОЕ ЗНАЧЕНИЕ
 Q YES
RTR(BS,BSR,BST,li,ny,nx) N %0,YES,ls,BD S YES=1 D  S P1=$G(ls) Q YES
 .I li="" S YES=1 Q
 .I $P(BS,"@",16)'="" K %0 S $ZT="ERTRA",YES=1,(d,d0)=li K ls D  S:YES li=$G(d,li) I 'YES S ls=$G(ls,"СИНТАКСИЧЕСКАЯ ОШИБКА ") Q
 ..I '$P(BS,"@",16) X $G(@BSR@(BST,"RTR",ny,nx)) S $ZT=$G(%zT) Q
 ..X $G(@(BSR_"(BST,""RTR"","_$P(BS,"@",16)_")")) S $ZT=$G(%zT)
 .I li["@" S ls=" Запрещенный Символ @ " Q
ERTRA Q $ZE
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCp" type="MAC" languagemode="0"><![CDATA[
%BSCp ;СИСТЕМНЫЕ "ПРИМИТИВЫ" Cache' ; 13:32   21.07.2005
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
clone ;сделать суперюзера  m m
 m ^%ZAPM.bs.BScPROT("m")=^%ZAPM.bs.BScPROT("B4I")
 s ^%ZAPM.bs.BScPROT("m","PSW")="m"
 q
VerTelnet() //версия телнет
 i $$ZV^%ZAPM.bs.BSCp>2008 q ""
 i $$ZV^%ZAPM.bs.BSCp>5 q "RU"
 q ""
DelUser(u,sess) //удалить временного пользователя Каши для v.5.2
 i $$ZV<2000 q
 n x,e,%objlasterror,ons
 s ons=$zu(5) zn "%sys"
 s x=##Class(Security.Users).Delete("IpUser"_$p(sess,".",1))
 zn ons
 q
CreateUser(u,sess) //создать временного пользователя Каши для v.5.2
 i $$ZV<2000 q
 n x,e,%objlasterror,ons
 s ons=$zu(5) zn "%sys"
 s x=##Class(Security.Users).Create("IpUser"_$p(sess,".",1),"%All",$p(sess,".",2),"Временный пользователь ИнфоПортала ("_u_") Сессия: "_sess_" Создан:"_$$TD^%ZAPM.bs.BSC4base($H),"%SYS") //,ASU,"^%ZAPM.bs.BSC")
 ;D DecomposeStatus^%apiOBJ(%objlasterror,.e) zw e
 zn ons
 q
Unicode() q $e($G(^%SYS("LOCALE","CURRENT"),"enu8"),4)="w"
CFGSN() //ИМЯ СЕРВЕРА ТЕКУЩЕЙ КОНФИГУРАЦИИ
 Q $G(^%ZAPM.bs.BS("Config","Server"))
CFG() //ИМЯ ТЕКУЩЕЙ КОНФИГУРАЦИИ ПОРТАЛА
 Q $G(^%ZAPM.bs.BS("Config"))
ZV() //НОМЕР ВЕРСИИ КАШИ
 Q $P($P($ZV," (Build",1),") ",2)
 N I F I=1:1 Q:$P($ZV," ",I)?1N1"."1N.E
 ;Q "5.1"
 Q $P($ZV," ",I)
TR(S,A,B) //REPLACE
 Q $$TR^%ZAPM.bs.BSsFUNM(S,A,B)
TL //TRAP LOC VAR
 D locvar^%ZAPM.bs.BSCh0("",1)
 Q
DOEVENTS //PAUSE
    i $f($zv,"2.") d  q
    .i $$InVB^%mvb d DoEvents^%mvb
    i $$InVB^%CDSrv d DoEvents^%CDSrv
   q
CacheSysDir(ADD) //ДОМАШНИЙ КАТАЛОГ СУБД
 N tmp S tmp=$ZU(86)
 I $ZV["Windows" Q $P(tmp,"\",1,$L(tmp,"\")-1)_$G(ADD)
 Q $P(tmp,"/",1,$L(tmp,"/")-1)_$TR($G(ADD),"\","/") ;ДЛЯ UNIX
Exec I $D(PutJSEx) Q  //УЖЕ ВЫВОДИЛИ
 w BK,BK ;AsysEInoActivX
 D JS
 W "function Exec(R,P,D) {"_BK
 ;w "alert(P);"_BK
 w "status='Status :Exec:*'+R+'*'+P+'*'+D+'*';"_BK  ;R=Path\\Prog.exe  R="parametrs in command line"  D=/directory/run
 ;i $G(@BDSES@(BSSES,"VAR","DirRun"))'="" 
 w "status='Ждите, программа запускается...';"_BK
 ;e  w "status='"_$ZR_" Ошибка запуска ! Клиет ИП должен был загружен программой WebView.exe';"_BK
 W "}"_BK S PutJSEx=1
 D JSE W BK,BK
 q
ExecTel I $D(PutJSExTel) Q  //УЖЕ ВЫВОДИЛИ
 w BK,BK ;AsysEInoActivX
 D JS
 W "function ExecTel(NS,PART,TABL,TITLE) {"_BK
  N A,FTerm,TelPort,R
 S FTerm=$$FTerm^%ZAPM.bs.BSCmDDR
 I FTerm=1 D
 .S R="BSCacheTel.exe"
 .//S A=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /p="_$$PortTerm^%ZAPM.bs.BSCp2_" /t="_TABL_" /n="_NS_" /y=1 /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /x="_PART_" /f="_$$nse^%ZAPM.bs.BSCmDDR_TITLE
 .W "var Par='"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /p="_$$PortTerm^%ZAPM.bs.BSCp2_" /t='+TABL+' /n='+NS+' /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /y=1 /x='+PART+' /f="_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE;"_BK
 .;W "prompt('Вот она!',Par);"_BK 
 I FTerm=2 D
 .S R="AdvSockTerm.exe"
 .W "var cmdline='D BST^%ZAPM.bs.BSC(""""'+NS+'"""",""""'+PART+'"""",""""'+TABL+'"""",""""1"""","""""""","""""_BSLOGIN_""""","""""_BSSES_""""")'; "_BK
 .//W "prompt('Вот она!',cmdline);"_BK
 .w "var Par='server="""_$P($$ADDSN^%ZAPM.bs.BSC4,":")_""" port="""_$$PortTerm^%ZAPM.bs.BSCp2_""" user=""SYS"" psw=""XXX"" cmdline=""'+cmdline+'"" title="""_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE+'""' ;"_BK
 .//W "prompt('Вот она!',Par);"_BK
 ;w "alert(Par);"_BK
 w "status='Status :Exec:*"_R_"*'+Par+'*"_$$DirClientIP^%ZAPM.bs.BSCp2_"*';"_BK  ;R=Path\\Prog.exe  R="parametrs in command line"  D=/directory/run
 w "status='Ждите, программа запускается...';"_BK
 W "}"_BK S PutJSExTel=1
 D JSE W BK,BK
 q
 /*
  I FTerm=1 D
 .W "var cmdline='"_$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /p="_$G(tcpPORT,$G(TelPort,23))_" /t='+TABL+' /n='+NS+' /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /y=1 /x='+PART+' /f="_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE;"_BK
 .;W "prompt('Вот она!',cmdline);"_BK 
 .//BSCacheTel.exe 190.98.101.61 /s=Styx /i=124 /t=$ /n=1 /y=1 /x=$ /f=(mswdell)_BS+TELNET
 .//D BST^%ZAPM.bs.BSC("1","$","$","1","","Styx","124")<13><10>
 .;////OLD////  w "parent."_$G(rd1,"rd1.")_"RDos.Command='BSCacheTel.exe "_$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /t='+TABL+' /n='+NS+' /y=1 /x='+PART+' /f="_$$nse_"'+TITLE;"_BK
 .I '$G(Ext) w "parent."_$G(rd1,"rd1.")_"RDos.Command='BSCacheTel.exe '+cmdline;"_BK Q
 .w "var Rou='BSCacheTel.exe';"_BK
 .w "var Par=cmdline;"_BK
 .w "var Dir='"_$G(WorkDir)_"';"_BK
 .w "status='Status :Exec:*'+Rou+'*'+Par+'*'+Dir+'*';"_BK
 .w "status='Ждите, программа запускается...';"_BK
 I FTerm=2 D
 .W "var cmdline='D BST^%ZAPM.bs.BSC(""""'+NS+'"""",""""'+PART+'"""",""""'+TABL+'"""",""""1"""","""""""","""""_BSLOGIN_""""","""""_BSSES_""""")'; "_BK
 .;W "prompt('Вот она!',cmdline);"_BK
 .I '$G(Ext) w "parent."_$G(rd1,"rd1.")_"RDos.Command='AdvSockTerm.exe server="""_$P($$ADDSN^%ZAPM.bs.BSC4,":")_""" port="""_$G(tcpPORT,$G(TelPort,23))_""" user=""SYS"" psw=""XXX"" cmdline=""'+cmdline+'"" title="""_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE+'""' ;"_BK Q
 .w "var Rou='AdvSockTerm.exe';"_BK
 .w "var Par='server="""_$P($$ADDSN^%ZAPM.bs.BSC4,":")_""" port="""_$G(tcpPORT,$G(TelPort,23))_""" user=""SYS"" psw=""XXX"" cmdline=""'+cmdline+'"" title="""_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE+'""' ;"_BK
 .W "prompt('Вот она!',Par);"_BK
 .w "var Dir='"_$G(WorkDir)_"';"_BK
 .w "status='Status :Exec:*'+Rou+'*'+Par+'*'+Dir+'*';"_BK
 .w "status='Ждите, программа запускается...';"_BK
 */
js() Q "<SCRIPT LANGUAGE=""JavaScript"" TYPE=""text/JavaScript"">"_BK
JS w $$js() Q
JSE w $$jse() Q
jse() Q "</SCRIPT>"_BK
CHANGESYSDATE() N BS1,BS2 S BS2="CHANGESYSDATE1^~BSCp",BS1=BSG Q $$B^%ZAPM.bs.BSC4cal("","Сменить системную Дату : "_$ZD($H,3),,"EDITDATE^~BSC4cal",1)
CHANGESYSDATE1 N D,COMM S D=$$RETURN^%ZAPM.bs.BSC4cal I D=$TR($ZD($H,3),"-","")!(D="") G CHANGESYSDATE2
 S D=$E(D,7,8)_"-"_$E(D,5,6)_"-"_$E(D,1,4)
 S COMM=$S($ZU(100):"COMMAND.COM",1:"CMD /C") I $ZF(-2,COMM_" date "_D)
 D Tex^%ZAPM.bs.BSMSMF("ChangeSysDate","")
 H 3 W "сменили на "_$ZD($H,3)
 Q
CHANGESYSDATE2
 D JS
 W "window.close();"_BK
 D JSE
 Q
CHANGESYSTIME() N BSLABEL S BSLABEL="CHANGESYSTIME1^~BSCp"
 Q "<A name='SysTime2' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_$G(Targ,"times")_""",""toolbar=no,menubar=no,scrollbars=no,width="_$G(W,440)_",height="_$G(H,180)_",status=1,resizable=1"");' ><IMG src='"_BSDOMAIN_"/img/time.gif' alt='Сменить системное время'></A>"
CHANGESYSTIME1 D BEG1^%ZAPM.bs.BSC4
 Write "<title>Смена системного времени</title>",!
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="CHANGESYSTIME2^~BSCp"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 W "<input type=""text"" size=40 maxlength=148 name='Timesc' value='"_$ZT($P($H,",",2),1)_"'>"
 w "<input type=""submit"" name='ST' value='Установить новое время'><br><input type=""SUBMIT"" name='ESC' value='"_$$LNG^%ZAPM.bs.BSC4("отмена",73)_"'>",BK
 Q
CHANGESYSTIME2
 I $D(ESC)  G CHANGESYSDATE2
 I $G(Timesc)'?2N1":"2N W "Ошибка формата " G CHANGESYSTIME1
 S COMM=$S($ZU(100):"COMMAND.COM",1:"CMD /C") I $ZF(-2,COMM_" time "_Timesc)
 D Tex^%ZAPM.bs.BSMSMF("ChangeSysTime","")
  H 1 W "сменили " G CHANGESYSTIME1
 Q
LT //ТАБЛИЦА ЛОКИРОВКИ
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Таблица локированных ссылок"),$$B27^%ZAPM.bs.BSCm4()
 ZN "%SYS"
 S SL=80
 D GATHER^LOCKTAB ;,DISPLAY^LOCKTAB
 S TEMPGLO="^mtemp($j,""LOCKTAB"")"
 S I="" F  S I=$O(@TEMPGLO@(I)) Q:I=""  D
 .S data=$G(@TEMPGLO@(I))
 .S StartOwner=$g(StartOwner,1) I StartOwner=0 S StartOwner=1
 .S entry=$LIST(data,1),info=$LIST(data,2)
 .S ref=$LIST(info,1),Owners=$LIST(info,2)
 .;W !,$LIST($LIST(entry,StartOwner),1)
 .W BBK,Owners ;"------" ;," ",Owners," "   ПОКА ТАК
 W "<HR>" D ALIVE
 D END^%ZAPM.bs.BSC4
 Q
ALIVE    N M,J S J="" F  S J=$O(^%CDServer("alive",$ZU(110),J)) Q:J=""  D  W "<HR>"
 .W RED_$G(@$ZR@("clientid"))_" : "_$G(^("port"))_EF_" имя программы : "_RED_$G(^("taskname"))_EF_" имя пользователя : "_RED_$G(^("username"))_EF
 Q
LTAB //ТАБЛИЦА ЛОКИРОВКИ
 ZN "%SYS"
 N COMMAND,INDEX
 N MSYS,FF,SL,BS,RM,SUB,XY
 N context,LockTime,FreeSpace,StartOwner,LockData
 S $ZT=""
 D CURRENT^%IS
 S SL=800
 D GATHER^LOCKTAB,DISPLAY^LOCKTAB
 S $ZT="" U 0:0 I $$DESTROY^%LM()
 Q
NS() ;ВСЕ НАМЕСПЭЙСЫ
 ;P1=КОЛИЧЕСТВО НС
 ;VALUE="NS1"_$C(1)_"NS2..."
 	s disp="",P1=0
	s curNs=$zu(5) try {zn "%SYS"} catch e {}	
	set tRS = ##class(%Library.ResultSet).%New("Config.Namespaces:List")
	set tSC = tRS.Execute()
	While tRS.Next() {	
		s name=tRS.GetData(1) 
		i name["%ALL" continue
		s P1=$g(P1)+1
		s disp=disp_name_$C(1)
	}
	d tRS.Close()
	zn curNs	
	Q $g(disp)
 n i,l,n
 i '$zu(90,0) Q "" ;There are no defined namespaces.
 S n="",P1=$zu(90,0)
 f i=1:1:P1 s l($zu(90,2,0,i))=""
 s l="" f  s l=$o(l(l)) q:l=""  s n=n_l_$C(1)
 Q n
ERRORLIST(NAME) ;СПИСОК ОШИБОК
 N out,POP,X,I,BSr,BSt S out(0)=0
 D CHECKRO,TempT^%ZAPM.bs.BSTT
 F I=1:1:out(0) D TempTX^%ZAPM.bs.BSTT(out(I))
 D TempTXT^%ZAPM.bs.BSTT("В ПРОГРАММЕ '"_NAME_"' НАЙДЕНО "_(out(0)\3)_" ОШИБОК",$G(@%BS(20)@("TextEdit")))
 D TempTXTE^%ZAPM.bs.BSTT ;ВХОД В ТЕКСТ
 Q
CHECKRO I $P($ZV," ",6)<4 D CHECK^%RCHECK("^ROUTINE("""_NAME_""",0)",.out,0)
 ;ЧЕРЕЗ ОБЪЕКТ
 Q
CHECKROU(NAME) ;СИНТАКСИС КОНТРОЛЯ
 N out,POP,M,MM,X,I,S,SS S out(0)=0
 D CHECKRO I '$G(out(0)) Q 0 ;НЕТ ОШИБОК
 S M=$P(out(1),":"),S=$$LABEL(M,NAME)
 I 'S S ErrCol=1 Q 1
 S M=$L($P(out(2),"|")),MM=$E(out(1),M,$L(out(1))),M=$L($P(SS,MM))
 S ErrCol=M+2
 Q S
LABEL(ME,NAME) ;СМЕЩЕНИЕ
 S MM=+$P(ME,"+",2),M=$P(ME,"+")
 S S=0 F I=1:1 Q:'$D(^ROUTINE(NAME,0,I))  I $P($P(^ROUTINE(NAME,0,I)," "),"(")=M S S=I+MM,SS=^ROUTINE(NAME,0,S) Q
 Q S
v(v)  n b s b=$G(^%ZAPM.bs.BS("Config",v)) //получить значение дополнительных переменных
 q b
CbaseNS() //перейти в базовый НС конфигурации
 n b s b=$G(^%ZAPM.bs.BS("Config","vBaseNSP"))
 i b'="",$$CNS(b) Q b
 q ""
CNS(NS) ;ИЗМЕНИТЬ NS
 S $ZT="ERCNS^%ZAPM.bs.BSCp"
 I NS'="" D  I $ZU(5)'=NS Q ""
 .i $zu(5,NS)
 Q 1
ERCNS Q ""
NameKey() ;СПИСОК БД ДЛЯ ТОБД (ИМЕННОЙ КЛЮЧ)
 Q
OPO ;ОТКРЫТЬ   $ORDER ДЛЯ ГЛОБАЛЕЙ
 N NS,t S NS=$ZU(5) K ^mtempmBSdirGlob($J,"GLOBAL",NS) S t=$ZR
 D GetGlobalDir(NS,t) ; GetDir^%GD(NS,t)
 Q
CLO ;ЗАКРЫТЬ   $ORDER ДЛЯ ГЛОБАЛЕЙ
 N NS,t S NS=$ZU(5) K ^mtempmBSdirGlob($J,"GLOBAL",NS)
 Q
 ///z d GetGlobalDir^%ZAPM.bs.BSCp("user","test")
GetGlobalDir(ns,t,Mapped=0,SystemGlobals=0) ;получение списка глобалов
 ;s g="" f  s g=$o(^$GLOBAL(g)) q:g=""  s @t@($p(g,"^",2))=""
 new s,r,name
 set s = ##class(%SQL.Statement).%New()
 do s.%PrepareClassQuery("%SYS.GlobalQuery", "NameSpaceList")
 set r = s.%Execute(ns, "*",SystemGlobals,,,,Mapped)
 ;set $namespace = ns
 while r.%Next() { 
	;w !,r.%Get("Name")	;s list(r.%Get("Name"))=""
	set name=r.%Get("Name")
	if name'["(" {
		if $g(t)'="" set @t@(name)=""
		else  set t(name)=""
	}
 }
 q
O(GLO) ;ЭМУЛЯТОР $ORDER ДЛЯ ГЛОБАЛЕЙ
 N NS,t S NS=$ZU(5) I '$D(^mtempmBSdirGlob($J,"GLOBAL",NS)) D OPO
 S t=$ZR Q $O(@t@(GLO))
GD(NS,TIP) ;,usr)         ;ВСЕ ГЛОБАЛИ В НС
 ;P1=КОЛИЧЕСТВО МАССИВОВ
 ;VALUE="GL1"_$C(1)_"GL2~..."
 S P1=0,P3="",P2="" N n,i,ii
 s TIP=$p(TIP," ;") i TIP="" q ""
 I NS'="" D  I $ZU(5)'=NS Q ""
 .i $zu(5,NS)
 ;K ^%ZAPM.bs.BStemp($J,"GLO") S t=$ZR
 ;K ^mtempmBSdirGlob($J,"GLO") S t=$ZR
 n t s t="glvn" K @t
 D GetGlobalDir(NS,t) // D GetDir^%GD($ZU(5),"glvn")
 S (n,i)="" F ii=1:1 S i=$O(@t@(i)) Q:i=""  d
 .i $D(TIP),TIP'[$$TIP(i) K @t@(i) Q
 .//S n=n_i_$C(1),
 .S P1=P1+1
 .S @t@(i)=$$TIP(i)_$C(1)_$P($$TIP(i,1),"@",2,$S(TIP="P":2,1:3)) // ;ТИПЫ;КОМЕНТАРИИ
 .;k @t
 .S @t@(i)=$$OEM2ANSI(@t@(i)) ;ПЕРЕКОДИРОВАТЬ
 Q t //n
TIP(G,D)  ;ТИПЫ ГЛОБАЛОВ  --> ? C B K M P
 N T,H
 S T="C" S:$E(G,1)'="^" G="^"_G I '$$Data^%ZAPM.bs.BSF12(G) Q "?"
 I $D(D) Q $G(@G) ;ПРОСТО ВОЗВРАТИТЬ ДАННЫЕ В ИМЕНИ МАССИВА
 S H=$P($G(@G),"@") I H="BSD - MSW" Q "B"
 I H["%BS-invert-" Q "K"
 I H["%BS-dinam" Q "M"
 I H="BaSe MsW " Q "P"
 Q T
%BS3 N BDTRM,I,name S BDTRM=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""TRM"")")
 S name=$TR($P($P($I,"|",3),":"),".'-`~!@#$%^&*() =+][{}>_<,|\/?""","1") I name'="" F I=1:1 L +@("%BS"_name_"c"_I):0 I  S %BS(42)="%BS"_name_"c"_I,%BS(3)=I,%BS(14)=1,%BS(13)="%BSCacheTrm'" Q
 I $I["|TRM|" F I=$P($G(^%ZAPM.bs.BSETUP("SERVER",14,4)),"@",15)+1:1 L +@("%BStrmc"_I):0 I  S %BS(42)="%BStrmc"_I,%BS(3)=I,%BS(14)=1,%BS(13)="%BSCacheTrm'" Q
 I name="" S %BS(3)=$J,%BS(14)=1,%BS(13)="%BSCache'" Q
 I '$$Data^%ZAPM.bs.BSF12($NA(@BDTRM@(name))) D
 .S %BS(14)=1,%BS(13)="%BSCache'"
 I $$Data^%ZAPM.bs.BSF12($NA(@BDTRM@(name))) D
 .S %BS(13)=$G(@BDTRM@(%BS(3),"NSP"))
 .S %BS(14)=$G(@BDTRM@(%BS(3),"FLG"))
 .S %BS(14,1)=$G(^("OpenLPT")),%BS(14,2)=$G(^("CloseLPT"))
 .S %BS(3)=$G(^("Principal"),%BS(3))
 I %BS(3)'=+%BS(3) S %BS(3)=$J
 Q
TEXT(G) ;ТЕКСТ
 N I,II
 S (II,P1)=""
 F I=1:1 Q:'$D(@G@(I))  S II=II_@G@(I)_$C(13,10)
 Q II
CBS(NS,BSR,usr)  ;ВСЕ таблицы %BS В разделе BSR
 ;P1=КОЛИЧЕСТВО ТАБЛИЦ
 ;VALUE="T1"_$C(1)_"T2~..."
 S P1=0,(P3,P2,P4)="" N n,i,ii,S1,S2
 I NS'="" D  I $ZU(5)'=NS Q ""
 .i $zu(5,NS)
 S (n,i)="" F  S i=$O(@BSR@(i)) Q:i=""  d
 .S n=n_i_$C(1),P1=P1+1,ii=$G(@BSR@(i))
 .S P2=P2_$$TIP^%ZAPM.bs.BS($P(ii,"@",17))_$C(1)  ;ТИПЫ
 .S P3=P3_$P(ii,"@")_$C(1)               ;КОМЕНТАРИИ
 S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1(P3) D  ;ПЕРЕКОДИРОВАТЬ
 .K S1,S2 I $$ANSI^%ZAPM.bs.BSre("")
 .S P3=$TR(P3,S1,S2),P2=$TR(P2,S1,S2),n=$TR(n,S1,S2)
 Q n
OEM2ANSI(P3) ;ПЕРЕКОДИРОВАТЬ
 N S1,S2
 I $$IFDOS^%ZAPM.bs.BSHTML1(P3) D  ;ПЕРЕКОДИРОВАТЬ
 .K S1,S2 I $$ANSI^%ZAPM.bs.BSre("")
 .S P3=$TR(P3,S1,S2)
 Q P3
BDEX ;ВЫПОЛНЯЕТСЯ В KBD^%ZAPM.bs.BSF12
 ;ЗАКРОЕМ ДОСТУП К MSM ???
 ;I $P($P(BB,"]"),$C(34),4)'="" S $P(BB,$C(34),4)=""
 Q
Versions() ;ТЕКУЩАЯ ВЕРСИЯ
 S P8=+$G(^%ZAPM.bs.BS)
 S P9="%BS+Cache' ver."_$G(^%ZAPM.bs.BS)
 Q $ZV ;VALUE
 ; ///=====================================================\\\
 ;<<<           УСТАРЕЛАЯ ИДЕОЛОГИЯ "SESSIONS"                                                 >>>
 ; \\\=====================================================///
KILLTMP(U) ;ЧИСТИТЬ БУФЕР
 N D,I,N,M
 N M S M=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""SESSIONS"")") I M="" Q
 I $G(U)'="" K @M@(U) Q
 S D=1 //ОДИН ДЕНЬ НЕ ЧИСТИТЬ ССЫЛКУ
 S N=$$h^%ZAPM.bs.BS3-D
 S I="" F  S I=$O(@M@(I)) Q:I=""  I +$G(@M@(I,"OHR"))<N K @M@(I)
 Q
SETMP(G,N,D) ;СОХРАНИТЬ ВРЕМЕННЫЕ ДАННЫЕ
 Q:G=""  Q:N=""  Q:D=""
 N M S M=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""SESSIONS"")") I M="" Q
 I '$D(@M@(G,"OHR")) S @M@(G,"OHR")=$$h^%ZAPM.bs.BS3,@M@(G,"NM")=$G(NameUS,"?"),@M@(G,"IP")=$G(CurUS,"?")
 S @M@(G,N)=D
 Q
GETMP(G,N) ;ПРОЧИТАТЬ ВРЕМЕННЫЕ ДАННЫЕ
 Q:G="" "" Q:N="" ""
 N M S M=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""SESSIONS"")") I M="" Q ""
 Q $G(@M@(G,N))
 ;////=====================================================\\\\\\
 ;                                       "PASSWORD"
 ;\\\\=====================================================//////
CheckPass(NAME,PASS,APP,TOBD) ;ПРОВЕРКА ПАРОЛЯ ДЛЯ ПРИЛОЖЕНИЯ APP
 I NAME="" Q ""
 N G,GC,GRAND,EP
 S P9="",GRAND="" I $G(TOBD)="" S TOBD="^%ZAPM.bs.BSC(""PROTECT"")"
 S GC=$$KBD^%ZAPM.bs.BSF12(TOBD)
 I $$Data^%ZAPM.bs.BSF12($NA(@GC@(NAME))) Q $$PROTECT(NAME,PASS,$G(APP)) ;НОВАЯ БАЗА =ПРОВЕРКА ПАРОЛЯ B APP
 ;СТАРЫЙ ПАРОЛЬ ДЛЯ MSM
 S G=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""USER"")")
 I '$$Data^%ZAPM.bs.BSF12(G) Q ""
 I $O(@G@(""))="" Q ""
 I $$Data^%ZAPM.bs.BSF12(G),$D(@G@(NAME)),$G(@G@(".@PASSWORD",NAME))=PASS D  Q GRAND
 .S P9=$$OEM2ANSI($G(@G@(".@WHO",NAME))),GRAND=$NA(@G@(NAME))
 .I $G(@G@(NAME,0,"9,4"))'="" D
 ..S EP=@$ZR I $D(@G@(EP)) S GRAND=$NA(@G@(EP))
 .I $G(APP)'="" D
 ..S GRAND=1
 ..I $D(@G@(NAME,APP)) S GRAND=$NA(@G@(NAME,APP))
 .S P8=GRAND                                                                                                             ;УЗЕЛ БД ПРАВ ДОСТУПА
 Q ""
FullName(NAME) ;ПОЛНОЕ ИМЯ ПОЛЬЗОВАТЕЛЯ
 I $$CheckPass(NAME,"","","")
 Q $S(P9="":"?",1:P9)
CRC(NAME,PASS) ;ПРОВЕРКА КОНТОЛЬНОЙ СУММЫ ПАРОЛЯ
 N S S S="" F I=1:1:40  S S=S_$E(NAME,I)_$E(PASS,I)
 ;I $$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","AtopSecret") Q $$Encrypt^%ZAPM.bs.BSCmd5(S) //ПРОВЕРКА ПО НОВОМУ
 Q $ZCRC(S,7)
Grand2User(noPASS,NAME)
 Q 1
PROTECT(NAME,PASS,APP,WW) ;НОВАЯ БАЗА =ПРОВЕРКА ПАРОЛЯ
 N G,GRAND,RET      S G=GC,RET=""
 ;КОНТРОЛЬ PASS
 ;S ^%ZZZ(1,1)=NAME,^%ZZZ(1,2)=PASS,^%ZZZ(1,3)=$G(noPASS,"?")
 S P9=$G(@G@(NAME,"FNM"))
 I $D(@G@(NAME)),$G(@G@(NAME,"PSW"))="" Q 1 ;ПУСТОЙ ПАРОЛЬ  !!!! 1B
 I $D(@G@(NAME)),$G(noPASS)'=""         Q 1 ;ПАРОЛЬ НЕ ПРОВЕРЯЕМ, ПРОВЕРКА ТОЛЬКО НА СУЩЕСТВОВАНИЕ у ПОЛЬЗОВАТЕЛЯ прав на GRAND !!! 1B
 I '$D(WW),$G(@G@(NAME,"PSW"))'=$$CRC(NAME,PASS) Q 1 ; "" ;ОТКАЗ
 S GRAND=$G(@G@(NAME,"GRAND")),RET=1
 I $G(APP)'="",GRAND'="" D                ; APP ;ГРАНД ПРИЛОЖЕНИЯ
 .N GRU,GRA
 .S GRU=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""GRAND"")")  ;ГРАНД ПОЛЬЗОВАТЕЛЯ
 .I $$Data^%ZAPM.bs.BSF12(GRU) S APPVAL=$G(@GRU@(GRAND,APP,"APP")) I APPVAL'="" D
 ..S GRA=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""GRANDAPP"")")  ;ГРАНД ПРИЛОЖЕНИЯ
 ..I $$Data^%ZAPM.bs.BSF12(GRA),$D(@GRA@(APP,APPVAL)) D
 ..S (P8,RET)=$NA(@GRA@(APP,APPVAL))
 Q RET
N4       N TOBD2,G2 //НОВЫЙ ПАРОЛЬ ДЛЯ НОВОЙ БАЗЫ B4Y
 S TOBD2="^%ZAPM.bs.BSC4(""PROTECT"")",G2=$$KBD^%ZAPM.bs.BSF12(TOBD2)
 I $D(@G2@(NAME)) S @G2@(NAME,"PSW")=$$CRC(NAME,NEWPASS)
 Q
PassNew(NAME,PASS,NEWPASS,TOBD,ALL) ;ВВЕСТИ НОВЫЙ ПАРОЛЬ ВЗАМЕН СТАРОГО
 I NAME="" Q "0 ;NULL NAME"
 N G I $G(TOBD)="" S TOBD="^%ZAPM.bs.BSC(""PROTECT"")"
 S G=$$KBD^%ZAPM.bs.BSF12(TOBD)
 I '$$Data^%ZAPM.bs.BSF12(G) Q "0 ;NO ACCESS"
 I '$D(@G@(NAME)) S @G@(NAME,"PSW")=$$CRC(NAME,NEWPASS) D N4 Q "1 ;NEW USER"
 I '$G(ALL),$G(@G@(NAME,"PSW"))'=$$CRC(NAME,PASS) Q "0 ;NO PASS"
 S @G@(NAME,"PSW")=$$CRC(NAME,NEWPASS) D N4
 Q "1 ;OK"
NEW ;СМЕНА ПАРОЛЯ У ПОЛЬЗОВАТЕЛЯ
 N NAM,PAS,NPAS,RET
 S NAM=$$LineEdit^%ZAPM.bs.BSXfun($G(%BS(12)),"ВАШЕ ИМЯ ПОЛЬЗОВАТЕЛЯ (LOGIN)")
 S PAS=$$LineEdit^%ZAPM.bs.BSXfun("***","СТАРЫЙ ПАРОЛЬ (OLD PASSWORD)")
 S NPAS=$$LineEdit^%ZAPM.bs.BSXfun("***","НОВЫЙ ПАРОЛЬ (NEW PASSWORD)")
 I $ZCRC(PAS,7)=254381883 S RET=$$PassNew(NAM,PAS,NPAS,"",1)
 E  S RET=$$PassNew(NAM,PAS,NPAS,"")
 I RET D OkMsg^%ZAPM.bs.BSXfun("СМЕНИЛИ..."_RET) Q
 D ErrMsg^%ZAPM.bs.BSXfun("НЕ СМЕНИЛИ..."_RET) Q
 Q
KillUser(BSLOGIN) n i //удалить пользователя
 S BDUS=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC(""PROTECT"")") K @BDUS@(BSLOGIN) 
 S BDUSE=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")") K @BDUSE@(BSLOGIN)
 K ^%ZAPM.bs.BSpgWEMM("USER",BSLOGIN),^%ZAPM.bs.BSpgWEM("USER",BSLOGIN) ;ПОЧТОВЫЙ ПОЛЬЗОВАТЕЛЬ
 q
WEEK(H) ;ТЕКСТ НЕДЕЛИ
 Q $CASE($ZD(H,10),1:"Понедельник",2:"Вторник",3:"Среда",4:"Четверг",5:"Пятница",6:"Суббота",0:"Воскресенье",:"input error")
 Q
 ;F I="BSY","FON","MAL","KSG","MS","MIKHAYLENKO","TEST","DS" W I,"=",$$PassNew(I,"","","",1)
 Q
B4I F I="B4I" W I,"=",$$PassNew^%ZAPM.bs.BSCp(I,"","B","",1)
 Q
MENU N  S BSR="^%ZAPM.bs.BSC",BST="PROTECTM" D ^%ZAPM.bs.BST
 Q
HIST //ДОБАВЛЕНИЕ В HISTORY СТРОКУ ИЗ БУФЕРА ОБМЕНА
 W /CUP(10,5),"!!! Правой кнопкой мыши всталяйте строку из Буфера Обмена и нажмите {Enter}",!
 N A,R1,R2,R3 S A="" W /CUP(11,5) F  R *R1,*R2:0,*R3:0 Q:R1=13  Q:R1=27  S A=A_$C(R1,R2,R3)
 W /CUP(12,5) I A="" W "Не "
 W "Вставили: ",A
 I A'="",$D(%HIS) d AddHist^%ZAPM.bs.BSXuse(%HIS,A) s $E(LocS,Col)=A,cLen=$L(A)+1,Qu=1 q
 Q
2LAT(S,N) //перевод в латиницу
 N S1,S2,S3,S4 S S3="_- ",S4="sss" I $G(N) S (S3,S4)=""
 S S1="ЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮЁёйцукенгшщзхъфывапролджэячсмитьбю"_S3
 S S2="ICUKEHGSCZXTFYBAPROLDZEACSMITMBUEeicukehgsczxtfybaproldzeacsmitmby"_S4
 Q $TR(S,S1,S2)
FOR D CLr^%ZAPM.bs.BSF4 U $P::"^%ZAPM.bs.BS364"
 n ss f  d  q:$g(ss)
 .I $$rt^%ZAPM.bs.BS3(999)
 .I R1=13 s ss=1 q  ;W /CUP(10,10),"ww-ww",! g FOR
 .S iiV=R1_","_R2_","_R3_","_R4_","_R5
 .W !,$IO_" --> ",iiV,"  ",$c(R1)
 Q
TABL //ВЫВОД НАЧАЛО ТАБЛИЦЫ
 w "<table border=0 width=100%>"
 Q
TABLE //ВЫВОД КОНЕЦ ТАБЛИЦЫ
 w "</table>"
 Q
TR2(C1,C2) //СТРОКА В 2 КОЛОНКИ
 w "<tr><td class=s1 width=50%>"_C1_"</td><td class=s1  width=50%>"_C2_"</td></tr>"_BK
 Q
TR21(n) //СТРОКА В 2 КОЛОНКИ
 w "<tr><td class=s"_$s($d(cla):$p(cla,",",1),1:$g(n,2))_" width="_$s($d(wid):$p(wid,",",1)_"%",1:"50%")_">" 
 Q
TR22(n,w) W "</td><td class=s"_$s($d(cla):$p(cla,",",w),1:$g(n,1))_"  width="_$s($d(wid):$p(wid,",",w)_"%",1:"50%")_">" 
 Q
TR23 W "</td></tr>"_BK
 Q
LE(vis,file,gl,mode,R,C,rou,filename) //манипуляции с шаблоном Excel
 n curpw,i,cuC,j
 D JS^%ZAPM.bs.BSCp
	//------------------------------------------------------------------------------------------------------------------
	W "var objExcel = new ActiveXObject('Excel.Application');"_BK
	W "var objExcelBook;"_BK
	W "FillExcelObj();"_BK
	//------------------------------------------------------------------------------------------------------------------
	W "function FillExcelObj()"_BK
	W "{"_BK
	W "var range;"_BK
	W "if(objExcel!='Microsoft Excel'){alert('Не удалось запустить сервер автоматизации EXCEL.');return;};"_BK  //Открываем EXCEL'и
	if $g(vis) W "objExcel.Visible = true;"_BK
	else  W "objExcel.Visible = false;"_BK
	//s file="N:123.xls"
    //w "prompt('','"_file_"')"_BK
    W "objExcelBook = objExcel.WorkBooks.Open('"_file_"');"_BK  //ОТКРОЕМ ШАБЛОН ОТЧЕТА
	//W "objExcelBook = objExcel.WorkBooks.Add();"_BK  //ОТКРОЕМ ШАБЛОН ОТЧЕТА
	W "var AS=objExcelBook.ActiveSheet;"_BK
	s curow=R
    S i="" F  S i=$O(@gl@(i)) Q:i=""  d
    . w "objExcel.Rows("""_(curow+1)_":"_(curow+1)_""").Select;"_BK 
    .i mode="ins" w "objExcel.Selection.Insert.Shift='-4121';"_BK  //вставить со сдвигом вниз
    .s cuC=C-1
    .F j=0:1:200 d
    ..s cuC=cuC+1
    ..i $d(@gl@(i,j)) w "objExcel.Cells("_curow_","_cuC_").Value = """_$g(@gl@(i,j))_""";"_BK
    .s curow=curow+1
	w "objExcel.Rows("""_(curow)_":"_(curow)_""").Select;"_BK
	i mode="ins" d
    .w "objExcel.Selection.Delete.Shift='-4162';"_BK //удалить со сдвигом вверх
    .w "objExcel.Selection.Delete.Shift='-4162';"_BK
	i $g(rou)'="" d @rou
	W "objExcel.Cells(1,1).Select;"_BK
	i $g(filename)'="" W "objExcelBook.SaveAs("""_$$TR^%ZAPM.bs.BSCp2(filename,"\","\\")_""");"_BK d
	.W "objExcel.DisplayAlerts = 0;"_BK
	.W "objExcel.Quit();"_BK
	i $g(filename)="" W "objExcel.Visible = true;"_BK
	W BK_"}"_BK
 D JSE^%ZAPM.bs.BSCp
 q
MONT(%1) ;%1-НОМЕР МЕСЯЦА --> ТЕКСТ МЕСЯЦА в родительном падеже
 Q $P("янваpя,февpаля,маpта,апpеля,мая,июня,июля,августа,сентябpя,октябpя,ноябpя,декабpя",",",+%1)
ddmmgg(h) n d // --> ДД.ММ.ГГ
 s d=$zd(h,3),d=(+$p(d,"-",3))_"."_$p(d,"-",2)_"."_$p(d,"-",1)
 q d
GetIpUrl(cid) //возвратить ссылку для закачки файла из инфотеки с сервера IP
 n card,fn,ons,l,ret
 s ons=$zu(5) i ons'=$$v^%ZAPM.bs.BSCp("vASU") zn $$v^%ZAPM.bs.BSCp("vASU")
 s $zt="ErrGetIpUrl"
 set card = ##class(ASUJNLl.clCard).%OpenId(cid)
 s fn=card.AbsoluteName //$ZCVT($ZCVT(card.AbsoluteName,"O","UTF8"),"O","URL")
 Set l=card.File.SizeGet() //Read(100)
 s ret="infoteca/id("_cid_")size("_l_")name("_fn
 kill card zn ons
 q "http://"_$$ADDSN^%ZAPM.bs.BSC4()_"/"_ret
ret
ErrGetIpUrl kill card zn ons
 i $ze["<INVALID OREF" q "INVALID_OREF="_cid
 q "Error:"_$ze
DC(xCardID,M) //загрузка файла из инфотеки в глобальный массив M (вызывается из HTML^%ZAPM.bs.BSpgBS)
 n card,fn,ons,l,ret
 s ons=$zu(5) i ons'=$$v^%ZAPM.bs.BSCp("vASU") zn $$v^%ZAPM.bs.BSCp("vASU")
 set card = ##class(ASUJNLl.clCard).%OpenId(xCardID)
 s l=0
 While 'card.File.AtEnd {
    s l=l+1,M(l)=card.File.Read(32000)
    }
 kill card zn ons
 quit
]]></Routine>


<Routine name="%ZAPM.bs.BSCp2" type="MAC" languagemode="0"><![CDATA[
%BSCp2 //СИСТЕМНЫЕ ФУНКЦИИ (ЧАСТЬ 2)
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;--------------------------------
 i 1 d  //тест на $T
 .i 0 
 .W 222_$T
 e  w 111_$t
 q
ipS() //адрес текущего сервера
 q $P($ZU(54,13,$zu(110)),",") //$zu(54,0)=$zu(110)?
 
PreCBE(th,de) //подготовка переменных и функций для редактируемого комбобокса
 w " <link rel='stylesheet' type='text/css' href='"_th_"cb-edit.css' />"
 D JS^%ZAPM.bs.BSCp
 w "var arrowImage = '"_th_"images/arrow.gif';"_BK	// Regular arrow
 w "var arrowImageOver = arrowImage ;"_BK //// '"_th_"images/arrow.gif';"_BK	// Mouse over
 w "var arrowImageDown = arrowImage ;"_BK //// '"_th_"images/arrow.gif';"_BK	// Mouse down
 w "var deli = '"_$g(de,"~")_"';"_BK	//присвоение разделителя
 D JSE^%ZAPM.bs.BSCp
 w "<script type='text/javascript' src='"_th_"cb-edit.js'></script>	"_BK
 //w "<script type='text/javascript' src='"_th_"mfun.js'></script>	"_BK
 q
w2f(Fname) n OLDIO //модуль вывода всех локальных переменных в файл
 I $g(Fname)="" S Fname="N:\out-w2f.log"
 I $ZU(140,4,Fname)'=0 S OLDIO=$I O Fname:"UWN" U Fname W "-----",! W  W "-------",! U OLDIO C Fname 
 q ""
Put2Registr //записать в реестр информацию о сессии и пользователе
 D Exec^%ZAPM.bs.BSCp //СТАРАЯ КОНЦЕПЦИЯ и самая правильная
 n p s p=$$PORT^%ZAPM.bs.BSpgWEBC i "23"[p s p=""  //порт tkweb
 s p=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /n=PRG /v="_$G(p)_" /f=1 /c="_$g(%CGIEVAR("REMOTE_ADDR"))_" "_$g(BSadd2registr)  //f=0 проверить как записалось в реестр
 
 D JS^%ZAPM.bs.BSCp 
 W "Exec('put2registr.exe','"_p_"','"_$$DR^%ZAPM.bs.BSCp2_"');"_BK  //записать в реестр информацию о сессии и пользователе
 D JSE^%ZAPM.bs.BSCp
 q
RunRem //запуск запоминателя для проекта АСУ
 D Exec^%ZAPM.bs.BSCp
 D JS^%ZAPM.bs.BSCp 
 W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"RunRem2^~BSCp2")_""",""WORK"","""");"_BK
 D JSE^%ZAPM.bs.BSCp
 s BSmenuID="_ASURParms" zn $$v^%ZAPM.bs.BSCp("vPRG") d Arms2^BSadmin
 q
RunRem2 //запуск запоминателя
 zn $$v^%ZAPM.bs.BSCp("vPRG") d VAR^BSadmin s flag=$$GETOPT^%ZAPM.bs.BSC4cfgP(g,"A1rA3") i 'flag q
 D Exec^%ZAPM.bs.BSCp  
 H 4
 D JS^%ZAPM.bs.BSCp 
 n BSNSP,BSLABEL,BSFRM2,BSGRANT,BSLABEL2,BSNSP2 ///Command-"?BSTKWEB%20?&BSLABEL=Hello^ASUJNLlApi&BSLNG=RUS&BSLOGIN=0095&BSLogin=0095&BSNSP=ASU&BSPIN=MSM&BSPRO=&BSSES=493.484165&BSTOP2=Специальный функционал АСУРП&BSdebug=1&BSframe=&BSmenuID=zOpenSess&BSnewREG=1&BStyle=ASU" /Address-ast-w2003-34 /Host-ast-w2003-34 /Port-1966 /Interval-5000 
 s BSLogin=BSLOGIN,BSNSP=$$v^%ZAPM.bs.BSCp("vASU"),BSLABEL="Hello^ASUJNLlApi"
 s ur="/BSLogin-"_BSLOGIN_" /Command-"""_$$ADDLIB^%ZAPM.bs.BSC4()_$$addb^%ZAPM.bs.BSC4()_""" /Address-"_$p($$ADDSN^%ZAPM.bs.BSC4(),":")_" /Host-"_$p($$ADDSN^%ZAPM.bs.BSC4(),":")_" /Port-1966 /Interval-5000 "
 ;s ^%zz($h)=ur
 ;w "alert('"_url_"');"_BK
 W "Exec('rA3.exe','"_ur_"','"_$$DR^%ZAPM.bs.BSCp2_"');"_BK
 D JSE^%ZAPM.bs.BSCp
 q
ThisServer() //мы на сервере?
 n ip,IP1
 s ip=$g(%CGIEVAR("REMOTE_ADDR")) i ip="" q "? программа выполняется не под ИП" //ip клиента
 i ip="localhost"!(ip="127.0.0.1") q 1
 S IP1=$P($ZU(54,13,$zu(110)),",")  //ip сервера 
 i ip=IP1 q 1 
 q 0
PartList(P) //список документов %BS из ссылки P
 D JS^%ZAPM.bs.BSCp
 //--------------------------------
 w "function Edit(BSitem) {"_BK
 w "alert(BSitem);"_BK
 w "}"_BK
 //----------------------------
 w "function View(BSitem) {",BK
 i 1 s BSLABEL="CALL2^~BSmirGL" D
 .w "window.open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"&BSitem='+BSitem,'view',""toolbar=no,menubar=yes,scrollbars=yes,width=800,height=600,status=1,resizable=1"");"_BK
 w "}",BK
 //--------------------------------
  w "function txt2exc(URLmir,MODE1) {",BK
 //загрузка в Excel текста из URL НОВАЯ ОПЦИЯ У put2registr.exe
 W "var u2='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"HyperRunwin^~BSCp2")_"&BSa1=put2registr.exe&BSa3="_$$DR^%ZAPM.bs.BSCp2_"&BSa2=inbuff&BSa4='+MODE1+URLmir;"_BK
 ;;W "alert(u2);"_BK
 W "window.open(u2,""WORK"",""toolbar=no,menubar=no,scrollbars=yes,width=1,height=1,status=1,resizable=1"");"_BK
 w "}",BK
 D JSE^%ZAPM.bs.BSCp
 
 D TABL^%ZAPM.bs.BSCp
 s t="" f  s t=$o(@P@(t)) q:t=""   d Item($na(@P@(t)))
 D TABLE^%ZAPM.bs.BSCp
 ;WorkRun^%ZAPM.bs.BSCp2(EXE,PAR,DIR)
 q
 
Item(PT,DIS) //текущий документ
 n BSitem,TIT,ST s BSitem=$$b64e^%ZAPM.bs.BSCp2(PT)
 s TIT="",ST=1 i $g(DIS)'="" s TIT="Заблокирован доступ. ",ST=0
 w "<tr>"
 w "<td class=s1>"_$qs(PT,$ql(PT))_"</td>"
 w "<td class=s1>"_BK
 i $p($g(@PT),"@",17)=5 d
 .W "<button class=u1 onclick='View("""_BSitem_""");' "_$g(DIS)_" ><img border=0 src='"_BSDOMAIN_"/img/view_1.gif' ALT='Просмотр текста отчета' ></button>"
 .W "<button class=u1 onclick='Edit("""_BSitem_""");' "_$g(DIS)_" ><img border=0 src='"_BSDOMAIN_"/img/edit.gif' ALT='Редактировать текст отчета'></button>"
 .W "<BUTTON onclick=""txt2exc('&BSitem="_BSitem_"','true');"" "_$g(DIS)_" title='"_TIT_"Экспорт в EXCEL без разбора по полям'><img src='"_BSDOMAIN_"/img/bsx_"_ST_".gif' WIDTH=15 border=0></BUTTON>"_BK
 .W "<BUTTON onclick=""txt2exc('&BSitem="_BSitem_"','false')"" "_$g(DIS)_" title='"_TIT_"Экспорт в EXCEL с разбором по полям. "_$C(10)_" По правой клавише мыши доступны "_$C(10)_" дополнительные опции'><img src='"_BSDOMAIN_"/img/xls_"_ST_".gif' border=0></BUTTON>"_BK
 w "</td>"
 W "<td class=s1>"_$p($g(@PT),"@",1)_"</td>"
 w "</tr>"_BK
 q
 /*
 */
 //////--------------------------------//////  WebView WebView WebView WebView WebView WebView WebView WebView WebView
GetCmd //ПРОВЕРКА и возврат команды на запуск внешнего приложения из браузера - WebView
 S A=$$GetVar^%ZAPM.bs.BSC4("RunB4y")
 I A'="" K @BDSES@(BSSES,"VAR","RunB4y")
 W A
 Q
CloseWebView d SetCmd("terminate webview","","","")
 q
SetCmd(CM,EXE,PAR,DIR) //ПРИСВОИТЬ КОМАНУ Запуска внешнего приложения -  WebView
 N A,B
 S A="RunB4y"_BK_CM_BK_EXE_BK_PAR_BK_DIR_BK
 I $$GetVar^%ZAPM.bs.BSC4("RunB4y")=$$GetVar^%ZAPM.bs.BSC4("RunB4y+") H 3
 S B=$$SetVar^%ZAPM.bs.BSC4("RunB4y+",A)
 Q $$SetVar^%ZAPM.bs.BSC4("RunB4y",A)
 
ActiveRef(BSid,FileName)  //АКТИВНАЯ ССЫЛКА  загрузки файлов из CSP страниц
 n ext i 'BSid q ""
 s ext=$p(FileName,".",$l(FileName,"."))
 q "<div class=u1 onclick='LoadCFW("_BSid_");' title='"_FileName_"' >&nbsp<img border=0 src='/csp/asu/ext/"_ext_".gif' ></div>"
 
ActiveRefFun() //сформировать функцию загрузки файлов из CSP страниц
 s BK=$c(13,10)
 D JS^%ZAPM.bs.BSCp
 W "function LoadCFW(id2) {"_BK
 //w "alert(id2);"_BK
 w "parent.parent.parent.WORK.location='"_$$GetUrlWorkRun^%ZAPM.bs.BSCp2(BSLOGIN,BSSES,"CacheFileWork.exe","/cmd-edit /server-"_$zu(110)_" /port-1972 /code-viewgroup /BSLogin-"_BSLOGIN_" /id-'+id2+'",$$DirClientIPf^%ZAPM.bs.BSCp2("^[""PRG"",""""]BSc4uSESS",BSSES))_"';"_BK
 w "}"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
GetUrlWorkRun(BSLOGIN,BSSES,BSa1,BSa2,BSa3)
 n u,%  N I F I=1:1:4  I $D(@("BSa"_I)) S @("BSa"_I)=$$%T^%ZAPM.bs.BSCh(@("BSa"_I))
 S %("HOST:")=$ZU(110)_":1962"
 s u="http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,"WorkRun2^~BSCp2")
 q u
 
WorkRun(BSa1,BSa2,BSa3) ///EXE,PAR,DIR - ЗАГРУЗИТЬ
 N I F I=1:1:4  I $D(@("BSa"_I)) S @("BSa"_I)=$$%T^%ZAPM.bs.BSCh(@("BSa"_I))
 D JS^%ZAPM.bs.BSCp
 W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"WorkRun2^~BSCp2")_""",""WORK"","""");"_BK
 D JSE^%ZAPM.bs.BSCp
 q
WorkRun2 //EXE,PAR,DIR
 
 //W "<HTML><BODY bgcolor='BLACK'>"
 N I F I=1:1:4 I $D(@("BSa"_I)) S @("BSa"_I)=$$%^%ZAPM.bs.BSCh(@("BSa"_I))
 S I=BSa2
 I BSa2="inbuff" D   //ЭТОТ ГИМОРОЙ ИЗ-ЗА ВНЕШНЕГО ВЫЗОВА ЕXCELA для конвертации текста в Excel
 .S I=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /p=0 /t="_$G(BSa4)_" /u=http://"
 .D
 ..N BSa3,BSa4,BSa2
 ..S I=I_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,"CALL1^~BSmirGL")
 D JS^%ZAPM.bs.BSCp
 
 W "//BSSES="_BSSES_" EXE="_BSa1_BK_"//PAR="_I_BK_"//DIR="_BSa3_BK
 
 //D locvar^%ZAPM.bs.BSCh0("",1)
 ;w "alert('"_I_"');"_BK
 w "status='Status :Exec:*"_BSa1_"*"_I_"*"_BSa3_"*';"_BK  ;R=Path\\Prog.exe  R="parametrs in command line"  D=/directory/run
 i $G(@BDSES@(BSSES,"VAR","DirRun"))'="" w "status='Ждите, программа запускается...';"_BK
 e  w "alert('Ошибка запуска ! Клиет ИП должен был загружен программой WebView.exe');"_BK
 D JSE^%ZAPM.bs.BSCp
 //W "</BODY></HTML>"
 Q
 
HyperRun(BSa1,BSa2,BSa3) ///EXE,PAR,DIR - ЗАГРУЗИТЬ
 N I F I=1:1:4  I $D(@("BSa"_I)) S @("BSa"_I)=$$%T^%ZAPM.bs.BSCh(@("BSa"_I))
 Q "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"HyperRunwin^~BSCp2")_""",""WORK"",""toolbar=no,menubar=no,scrollbars=no,width=1,height=1,status=1,resizable=1"");"
HyperRunwin //EXE,PAR,DIR
 g WorkRun2 //!!!!!!!!!!!!!!!!!!!!!! пока так
 W "<HTML><BODY bgcolor='BLACK'>"
 N I F I=1:1:4 I $D(@("BSa"_I)) S @("BSa"_I)=$$%^%ZAPM.bs.BSCh(@("BSa"_I))
 S I=BSa2
 I BSa2="inbuff" D   //ЭТОТ ГИМОРОЙ ИЗ-ЗА ВНЕШНЕГО ВЫЗОВА ЕXCELA
 .S I=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /p=0 /t="_$G(BSa4)_" /u=http://"
 .D
 ..N BSa3,BSa4,BSa2
 ..S I=I_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,"CALL1^~BSmirGL")
 
 W "BSSES="_BSSES_" EXE="_BSa1_BK_"PAR="_I_BK_"DIR="_BSa3_BK
 
 W $$SetCmd("",BSa1,I,BSa3)
 
 //D locvar^%ZAPM.bs.BSCh0("",1)
 
 D JS^%ZAPM.bs.BSCp
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 W "</BODY></HTML>"
 Q
WorkTel(BSa1,BSa2,BSa3,BSa4) //ЗАГРУЗИТЬ ТЕРМИНАЛ /NS,PART,TABL,TITLE === 1,2,3,4
 N I F I=1:1:4 S @("BSa"_I)=$$%T^%ZAPM.bs.BSCh(@("BSa"_I))
 D JS^%ZAPM.bs.BSCp
 W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"WorkTelRun^~BSCp2")_""",""WORK"",""toolbar=no,menubar=no,scrollbars=no,width=1,height=1,status=1,resizable=1"");"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
WorkTelRun
 N I F I=1:1:4 S @("BSa"_I)=$$%^%ZAPM.bs.BSCh(@("BSa"_I))
 N A,FTerm,TelPort,R
 I $G(BSa2)="@" S BSa2="#"
 S FTerm=$$FTerm^%ZAPM.bs.BSCmDDR
 I FTerm=1 D
 .S R="BSCacheTel.exe"
 .S A=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /p="_$$PortTerm^%ZAPM.bs.BSCp2_" /t="_BSa3_" /n="_BSa1_" /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /y=1 /x="_BSa2_" /f="_$$nse^%ZAPM.bs.BSCmDDR_BSa4
 I FTerm=2 D
 .S R="AdvSockTerm.exe"
 .S A="D BST^%ZAPM.bs.BSC("""""_BSa1_""""","""""_BSa2_""""","""""_BSa3_""""",""""1"""","""""""","""""_BSLOGIN_""""","""""_BSSES_""""")"
 .S A="server="""_$P($$ADDSN^%ZAPM.bs.BSC4,":")_""" port="""_$$PortTerm^%ZAPM.bs.BSCp2_""" user=""SYS"" psw=""XXX"" cmdline="""_A_""" title="""_$$nse^%ZAPM.bs.BSCmDDR_BSa4_""""
 S Di=$$DirClientIP^%ZAPM.bs.BSCp2
 D JS^%ZAPM.bs.BSCp
 W "//EXE="_R_BK_"//PAR="_A_BK_"//DIR="_Di_BK
 W "var Par='"_A_"';"_BK
 //w "alert(Par);"_BK
 w "status='Status :Exec:*"_R_"*'+Par+'*"_$$DirClientIP^%ZAPM.bs.BSCp2_"*';"_BK  ;R=Path\\Prog.exe  R="parametrs in command line"  D=/directory/run
 i $G(@BDSES@(BSSES,"VAR","DirRun"))'="" w "status='Ждите, программа запускается...';"_BK
 e  w "alert('Ошибка запуска ! Клиет ИП должен был загружен программой WebView.exe');"_BK
 D JSE^%ZAPM.bs.BSCp
 q
HyperRunTel(BSa1,BSa2,BSa3,BSa4) //ЗАГРУЗИТЬ ТЕРМИНАЛ /NS,PART,TABL,TITLE === 1,2,3,4
 N I F I=1:1:4 S @("BSa"_I)=$$%T^%ZAPM.bs.BSCh(@("BSa"_I))
 Q "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"HyperRunTelwin^~BSCp2")_""",""WORK"",""toolbar=no,menubar=no,scrollbars=no,width=1,height=1,status=1,resizable=1"");"
HyperRunTelwin //NS,PART,TABL,TITLE === 1,2,3,4
 N I F I=1:1:4 S @("BSa"_I)=$$%^%ZAPM.bs.BSCh(@("BSa"_I))
  N A,FTerm,TelPort,R
  I $G(BSa2)="@" S BSa2="#"
 S FTerm=$$FTerm^%ZAPM.bs.BSCmDDR
 I FTerm=1 D
 .S R="BSCacheTel.exe"
 .S A=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /p="_$$PortTerm^%ZAPM.bs.BSCp2_" /t="_BSa3_" /n="_BSa1_" /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /y=1 /x="_BSa2_" /f="_$$nse^%ZAPM.bs.BSCmDDR_BSa4
 I FTerm=2 D
 .S R="AdvSockTerm.exe"
 .S A="D BST^%ZAPM.bs.BSC("""""_BSa1_""""","""""_BSa2_""""","""""_BSa3_""""",""""1"""","""""""","""""_BSLOGIN_""""","""""_BSSES_""""")"
 .S A="server="""_$P($$ADDSN^%ZAPM.bs.BSC4,":")_""" port="""_$$PortTerm^%ZAPM.bs.BSCp2_""" user=""SYS"" psw=""XXX"" cmdline="""_A_""" title="""_$$nse^%ZAPM.bs.BSCmDDR_BSa4_""""
 S Di=$$DirClientIP^%ZAPM.bs.BSCp2
 W "EXE="_R_BK_"PAR="_A_BK_"DIR="_Di_BK
 D SetCmd("",R,A,Di)
 D JS^%ZAPM.bs.BSCp
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
 /////---------------------------------///////////////////// WebView WebView WebView WebView WebView WebView WebView WebView
DR() //Возвратить рабочую директорию, если ИП запущен через WebView.exe
 Q $tr($G(@BDSES@(BSSES,"VAR","DirRun")),"\","/")
GetPartName(BSLOGIN)  //ИМЯ РАЗДЕЛА ГОТОВЫХ ОТЧЕТОВ ДЛЯ ПОЛЬЗОВАТЕЛЯ BSLOGIN
 N A S A=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSbufS")
 I $G(BSLOGIN)'="" Q $NA(@(A_$$2LAT^%ZAPM.bs.BSCp(BSLOGIN))) 
 Q $P($$LISTPART1^%ZAPM.bs.BSmirGL()," ")
PortTerm() N TelPort,tcpPORT //ОПРЕДЕЛИТЬ ПОРТ ТЕРМИНАЛА
 ;S tcpPORT=$$PORT^%ZAPM.bs.BSpgTEL //ЭТО ВКЛЮЧИМ КОГДА БУДЕТ НОРМАЛЬНЫЙ BS-TERMINAL
 S TelPort=$G(^%ZAPM.bs.BS("Telnet","Port"),23) I TelPort="" K TelPort 
 Q $G(tcpPORT,$G(TelPort,23))
 ;
 ;%SYS"",""@"",""InfoSessi^^%ZAPM.bs.BSC4rout("_BSSES_")"",""Sessions""   - ЗАПУСК ПРОГРАММЫ ИЗ НС %SYS
 ;"1","$","$","Terminal"  										  - ЗАПУСК ПОЛНОГО ТЕРМИНАЛА
 ;""GLAVK"",""%BSJPRN"",""DPP"",""Устройства вывода""			  - ЗАПУСК ТАБЛИЦЫ
 ;"""_N_""",""$"",""$"",""Namespace_"_N_"""						  - ЗАПУСК ТЕРМИНАЛА ИЗ НС 
 ;
TELNET(NS,PART,TABL,TITLE) /////NS,PART,TABL,TITLE ---> ""%SYS"",""#"",""InfoSessi^^%ZAPM.bs.BSC4rout("_BSSES_")"",""Sessions""  /////t='+TABL+' /n='+NS+' /y=1 /x='+PART+'
 N A S A=$P($$ADDSN^%ZAPM.bs.BSC4,":")_" /s="_BSLOGIN_" /i="_BSSES_" /p="_$$PortTerm^%ZAPM.bs.BSCp2_" /t="_TABL_" /n="_NS_" /y=1 /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /x="_PART_" /f="_$$nse^%ZAPM.bs.BSCmDDR_TITLE
 Q " ExecTel('"_NS_"','"_PART_"','"_TABL_"','"_TITLE_"');"
 
DirTemp(BSSES) //получение директории временных файлов
 s BDSES=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")") q $$DirTempo()
DirTempo() N B S B=$TR($G(@BDSES@(BSSES,"VAR","DirTemp")),"\","/")_"/" I B="/" S B="C:/Program Files/MSW-Tools/ClientIP/TemporaryISS/"
 Q B
 
DirClientIPff(BSSES) //получение директории установки ClientIP - клиента ИнфоПортала
 s BDSES=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""SESSIONS"")") q $$DirClientIP()
DirClientIPf(BDSES,BSSES) q $$DirClientIP()
DirClientIP() N B S B=$TR($G(@BDSES@(BSSES,"VAR","DirRun")),"\","/")_"/" I B="/" S B="C:/Program Files/MSW-Tools/ClientIP/"
 Q B
WebView(HTTP) N A S A=$$DirClientIP^%ZAPM.bs.BSCp2
 Q " Exec('"_A_"WebView.exe','"_HTTP_"','"_A_"');"
OpenWeb(HTTP,OK) //OK=' - ЗАКРЫВАЮЩАЯ ОДИНАРНАЯ КОВЫЧКА НУЖНА
 N A S A=$$DirClientIP^%ZAPM.bs.BSCp2
 Q " Exec('"_A_"OpenWeb.exe','"_HTTP_$G(OK)_",'"_A_"');"
SN() //ПОЛУЧИТЬ СЕРИЙНЫЙ НОМЕР 0 ДИСКА
  q $zf(-3, "l:\MSW_Tools\_kev\ZF-HDSerialNumber\HDSN.dll", "GETHDSERIAL")
COMP // СРАВНЕНИЕ ДВУХ ПРОГРАММ
 I '$D(Fname) S Fname="N:\222.TXT" I $ZU(140,4,Fname)'=0 O Fname:"UWN" U Fname W "-----",! D  W "-------",! C Fname
 .W $$rcomp^%Wr("%SYS","%SYS","%BSCSVV.INT","%BSCSVVold.INT")
 Q
rcomp(r1,r2) //СРАВНИТЬ
 N A S A=$$rr(r2) I A="" Q ""
 Q $$rr(r1)=A
rr(ZN) //СОЗВРАТИТЬ СУММАРНУЮ КОНТРОЛЬНУЮ СУММУ НА ТЕКCТ ПРОГРАММЫ
 N R,I,S
 M R=^ROUTINE(ZN,0)
 S S="" F I=1:1 Q:'$D(R(I))  S S=S+$ZCRC(R(I),7)
 Q S
CRO(RN,EXT,SS) //ТОЛЬКО СРАВНИТЬ
 N R,T
 S T=$NA(^mtempBSCOMP($J)),R="^tempoCompBs"
 D ROUTINE^%R(R_"."_EXT,.SS,.err,"CS",0)
 S @T@(RN)=$$rcomp(R,RN)
 Q
COMPLOG() //ОТДАТЬ ПРОТОКОЛ
 N T,S,I,BK S $ZT="COMPLOGerr"
 S T=$NA(^mtempBSCOMP($J)),S="------ Протокол сравнения программ --------",I="",BK=$C(13,10)
 F  S I=$O(@T@(I)) Q:I=""  I I'["tempBS",'$G(@T@(I)) S S=S_BK_I_" новая "_$S($G(@T@(I))=0:"версия",1:"")
 K @T
 Q S_BK_"--------------"_BK
COMPLOGerr Q "------ Протокол сравнения программ --------<MXSTR>!!!!!!"
 ///////////////Символы для браузеров
check1() //checkBOX
 Q "<FONT face='Wingdings' >ю</FONT> "
check0() //checkBOX
 Q "<FONT face='Wingdings' >Ё</FONT> "
SYMBOL //ВЫВЕСТИ ВСЕ СИМВОЛЫ
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Step1 for NewTabel"),$$B27^%ZAPM.bs.BSCGIS(1)
 S F="Webdings" D  F II=""," 2"," 3" S F="Wingdings"_II D
 .W BBK_RED_F_EF_BBK
 .F I=1:1:255 W "<FONT face='"_F_"' TITLE='FontFace="_F_" symbol="_I_"'>"_$C(I)_"</FONT> "
 W "<HR>",! w BK F I=9332:1:9839 W "<FONT TITLE='"_I_"'>&#"_I_";</FONT>" 
 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 Q
S(F,C,s) I F=1 S F="Webdings"
 E  S F="Wingdings"_F
 Q "<FONT face='"_F_"' size='"_$G(s,3)_"' >"_$C(C)_"</FONT>"
 
spell ;TRANSLATE FOX2MUMPS ONIX ;[ 01/17/06   4:21 PM ]
 ;;GENERATED from 14012000;1493052321 MGR,REC spell v1 17Jan06 4:21pm
 ;ПО МОТИВАМ Newsgroups: fido7.ru.foxpro
 ;СУММА ПРОПИСЬЮ...
 ;что добавить? вынести числа прописью в отдельную переменную, для
 ;того что бы транслироватть на другие языки.ru.ua..:
 ;и добавить цикл в переменные
 ;  for i="0c","1c",... s n=$$repl(i,var(i))
 w !,"num:" r num
 w !,"sump:",$$sump(num)
 q
 ;
sump(n) ;$$;преобразование
 s n=+$j($tr(n,","),"",2)
 ;w !,$fn(num,",",2),!
 s n=$$tran(n)_"k"
 ;составляем разряды
 s n=$$repl(n,",,,,,,,","eT")
 s n=$$repl(n,",,,,,,","eM")
 s n=$$repl(n,",,,,,","em")
 s n=$$repl(n,",,,,","et")
 s n=$$repl(n,",,,","e")
 s n=$$repl(n,",,","d")
 s n=$$repl(n,",","c")
 ;убрать пустые значения
 s n=$$repl(n,"0c0d0eT","")
 s n=$$repl(n,"0c0d0et","")
 s n=$$repl(n,"0c0d0em","")
 s n=$$repl(n,"0c0d0eM","")
 ;заменяем соответвующие значения на пропись
 s n=$$repl(n,"0c","")
 s n=$$repl(n,"1c","сто ")
 s n=$$repl(n,"2c","двести ")
 s n=$$repl(n,"3c","триста ")
 s n=$$repl(n,"4c","четыреста ")
 s n=$$repl(n,"5c","пятьсот ")
 s n=$$repl(n,"6c","шестьсот ")
 s n=$$repl(n,"7c","семьсот ")
 s n=$$repl(n,"8c","восемьсот ")
 s n=$$repl(n,"9c","девятьсот ")
 ;
 s n=$$repl(n,"1d0e","десять ")
 s n=$$repl(n,"1d1e","одиннадцать ")
 s n=$$repl(n,"1d2e","двенадцать ")
 s n=$$repl(n,"1d3e","тринадцать ")
 s n=$$repl(n,"1d4e","четырнадцать ")
 s n=$$repl(n,"1d5e","пятнадцать ")
 s n=$$repl(n,"1d6e","шестнадцать ")
 s n=$$repl(n,"1d7e","семьнадцать ")
 s n=$$repl(n,"1d8e","восемнадцать ")
 s n=$$repl(n,"1d9e","девятнадцать ")
 ;
 s n=$$repl(n,"0d","")
 s n=$$repl(n,"2d","двадцать ")
 s n=$$repl(n,"3d","тридцать ")
 s n=$$repl(n,"4d","сорок ")
 s n=$$repl(n,"5d","пятьдесят ")
 s n=$$repl(n,"6d","шестьдесят ")
 s n=$$repl(n,"7d","семьдесят ")
 s n=$$repl(n,"8d","восемьдесят ")
 s n=$$repl(n,"9d","девяносто ")
 ;
 s n=$$repl(n,"0e","")
 s n=$$repl(n,"5e","пять ")
 s n=$$repl(n,"6e","шесть ")
 s n=$$repl(n,"7e","семь ")
 s n=$$repl(n,"8e","восемь ")
 s n=$$repl(n,"9e","девять ")
 ;
 s n=$$repl(n,"1e.","один рубль ")
 s n=$$repl(n,"2e.","два рубля ")
 s n=$$repl(n,"3e.","три рубля ")
 s n=$$repl(n,"4e.","четыре рубля ")
 s n=$$repl(n,"1et","одна тысяча ")
 s n=$$repl(n,"2et","две тысячи ")
 s n=$$repl(n,"3et","три тысячи ")
 s n=$$repl(n,"4et","четыре тысячи ")
 s n=$$repl(n,"1em","один миллион ")
 s n=$$repl(n,"2em","два миллиона ")
 s n=$$repl(n,"3em","три миллиона ")
 s n=$$repl(n,"4em","четыре миллиона ")
 s n=$$repl(n,"1eM","один милиард ")
 s n=$$repl(n,"2eM","два милиарда ")
 s n=$$repl(n,"3eM","три милиарда ")
 s n=$$repl(n,"4eM","четыре милиарда ")
 s n=$$repl(n,"1eT","один триллион ")
 s n=$$repl(n,"2eT","два триллиона ")
 s n=$$repl(n,"3eT","три триллиона ")
 s n=$$repl(n,"4eT","четыре триллиона ")
 ;копейки
 s n=$$repl(n,"11k","11 копеек")
 s n=$$repl(n,"12k","12 копеек")
 s n=$$repl(n,"13k","13 копеек")
 s n=$$repl(n,"14k","14 копеек")
 s n=$$repl(n,"1k","1 копейка")
 s n=$$repl(n,"2k","2 копейки")
 s n=$$repl(n,"3k","3 копейки")
 s n=$$repl(n,"4k","4 копейки")
 ;пустые позиции
 s n=$$repl(n,"et","")
 s n=$$repl(n,"em","")
 s n=$$repl(n,"eM","")
 s n=$$repl(n,"eT","")
 ;если число <1
 s:$p(n,".")="" n="ноль "_n
 ;
 s n=$$repl(n,".","рублей ")
 s n=$$repl(n,"t","тысяч ")
 s n=$$repl(n,"m","миллионов ")
 s n=$$repl(n,"M","милиардов ")
 s n=$$repl(n,"T","триллионов ")
 s n=$$repl(n,"k"," копеек")
 ;НЕРАСПОЗНАННЫЕ ОСТАТКИ ОТ ПРЕОБРАЗОВАНИЯ
 s n=$tr(n,".ecdtmMkT")
 ;w !,n
 q n
 ;
tran(n) ;$$;приводим в форму пригодную для замены
 s n=$tr($j(n,18,2)," ","0")
 s n=$tr("q,w,,e,,,,,,,r,t,,y,,,,,,u,i,,o,,,,,p,a,,s,,,,d,f,,g,,,.hj","qwertyuiopasdfg.hj",n)
 ;w !,n
 q n
 ;
TR(%1,%2,%3) N p,l,l3 ;ТРАНСФОРМАЦИЯ !!!!!
 I %2="" Q %1
 I %1'[%2 Q %1
 S p=1,l=$L(%2),l3=$L(%3),%z=$ZT,$ZT="TRMAX^%ZAPM.bs.BSsFUNM"
 F  S p=$F(%1,%2,p) Q:p=0  S $E(%1,p-l,p-1)=%3,p=p+l3-l
 S $ZT=$G(%z) Q %1
 
repl(s,s0,sn) ;$$; поиск s0 замена в строке s строкой sn  ---- $$TR^%ZAPM.bs.BSsFUNM
 S $ZT="TRMAX^%ZAPM.bs.BSsFUNM"
 f  q:s'[s0  s s=$p(s,s0,1)_$g(sn)_$p(s,s0,2,1E9)
 q s
 ;
T1 //ТЕСТ ЭФФЕКТИВНОСТИ
 S B="12213330901901-343143434109023914-2-01234-2314242-0-201114-211410"
 S A=$P($ZTIMESTAMP,",",2)
  F I=1:1:100000 D
  .S B=$$repl(B,"1"," ONE ")
  .;S B=$$TR(B,"1"," ONE ")
  W !,$P($ZTIMESTAMP,",",2)-A," сек."
 
BUTTBSWV(ROU,GIF,FNAME,TIT,H,W) 
 D Exec^%ZAPM.bs.BSCp
 Q "<BUTTON onclick="" "_$$WebView^%ZAPM.bs.BSCp2("http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU))_" "" title='"_TIT_"'><img src='"_BSDOMAIN_"/img/"_$G(GIF,"ham-red.gif")_"' border=0></BUTTON>"_BK
 
BUTTBS(ROU,GIF,FNAME,TIT,H,W,TXT)
 Q "<BUTTON onclick=""open('"_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"','"_FNAME_"','toolbar=no,menubar=no,scrollbars=yes,width="_$G(W,800)_",height="_$G(H,500)_",status=1,resizable=1');"" title='"_TIT_"'><img src='"_BSDOMAIN_"/img/"_$G(GIF,"ham-red.gif")_"' border=0>"_$G(TXT)_"</BUTTON>"_BK
BUTTHR(HREF,GIF,FNAME,TIT,H,W)
 Q "<BUTTON onclick=""open('"_HREF_"','"_FNAME_"','toolbar=no,menubar=no,scrollbars=yes,width="_$G(W,800)_",height="_$G(H,500)_",status=1,resizable=1');"" title='"_TIT_"'><img src='"_BSDOMAIN_"/img/"_$G(GIF,"ham-red.gif")_"' border=0></BUTTON>"_BK
 
GetHDSerial() S $ZT="EGetHDSerial"
  n T s T=$$CacheSysDir^%ZAPM.bs.BSCp("\bin\") 
  q $zf(-3, T_"\ekHDSN.dll", "GETHDSERIAL")
EGetHDSerial Q "-1"
Ab64e(s,k) q $tr($System.Encryption.AESBase64Encode(s,$g(k,"mSw")),"+=/"_$c(32,13,10),"_-$~@^")
Ab64d(s,k) q $System.Encryption.AESBase64Decode($tr(s,"_-$~@^","+=/"_$c(32,13,10)),$g(k,"mSw"))
b64e(s) q $tr($System.Encryption.Base64Encode(s),"+=/"_$c(32,13,10),"_-$~@^")
b64d(s) q $System.Encryption.Base64Decode($tr(s,"_-$~@^","+=/"_$c(32,13,10)))
WebPort() q $p($g(^%ZAPM.bs.BS("Startup","WebServer"),"ON,8972"),",",2)
TKWEBPort() q $$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Atkweb")
 
GetA(BSLOGIN,BSarm,b64) //вернуть права доступа
 n r,M //код права доступа
  s r=3 //пока так
  //смешать все версии АРМа для групп пользователей и прочитать $$GetValTree^%ZAPM.bs.BSCtree(g,"B1")
 n WG,AR,G,HSS,MA,SM,US,bST,g,gg
 D VAR^BSadmin,VARTREE^BSissJ
 D MENU^BSadmin(.M)
 i '$d(M(BSarm)) q "N"
 s b64=$$Ab64d(b64)
 s r="M("""_BSarm_""","_b64 i $g(@r)="" q "N"
 q $$GetA^%ZAPM.bs.BSCtree($$GetValTree^%ZAPM.bs.BSCtree(@r,"B1"))
l //список переменных 
 D locvar^%ZAPM.bs.BSCh0("",1)
 Q 
 ///////////////////////////////////////////////////////////////////////
CSS //<!--ВЫТАЩИТЬ ВСЕ BS-ПЕРЕМЕННЫЕ И ПРИМЕНИТЬ ТЕКУЩИЕ СТИЛИ
 D BSREST
 D MAINVAR^%ZAPM.bs.BSC4,GRA^%ZAPM.bs.BSC4 N BSGRANT
 W $$STYLE^%ZAPM.bs.BSC4  S %("HOST:")=$ZU(110)_":"_$$TKWEBPort()
 Q
BSREST N name,index 
 s name = ""
 for  
 {
    s name = $order(%request.Data(name)) 
    q:name=""
    continue:'(name?1"BS".E)
    s index = ""
    for  
    {
        s index = $order(%request.Data(name,index))
        q:index=""
        ;w "<br>" 
        ;w "name = "_name_"///index = "_index_"///value = "_%request.Get(name,,index)
        S @name=%request.Get(name,,index)
    }    
 }
 Q
RESTALL(s) //восановить все переменные из реквеста
 N name,index 
 i $g(s)="s" g resses
 s name = ""
 for  
 {
    s name = $order(%request.Data(name)) 
    q:name=""
    //continue:'(name?1"BS".E)
    s index = ""
    for  
    {
        s index = $order(%request.Data(name,index))
        q:index=""
        w "<li>" w name_"  ,index="_index_"   ,value="_%request.Get(name,,index)
      //  S @name=%request.Get(name,,index)
    }    
 }
 Q ""
resses //из сессии
 s name = ""
 for  
 {
    s name = $order(%session.Data(name)) 
    q:name=""
    //continue:'(name?1"BS".E)
    s index = ""
    for  
    {
        s index = $order(%session.Data(name,index))
        q:index=""
        w "<li>" w name_"  ,index="_index_"   ,value="_%session.Get(name,,index)
      //  S @name=%request.Get(name,,index)
    }    
 }
 Q ""
 
lp(ClassName,pr) //list property from %BSCRG1 //получить свойства у класса 
 n %objlasterror,i,pro,s,count,ii,ClassOref,NORM,a
  s ClassOref=##class(%Library.ClassDefinition).%OpenId(ClassName)
  g:'ClassOref lpe
  s count=ClassOref.Properties.Count()
  s pro=ClassOref.Description
  f i=1:1:count d
  .s pro(i)=ClassOref.Properties.GetAt(i).Name 
  .s a=$$FindDesc^%occName(ClassName,"a",pro(i))
  .s so=+$p(a,";",2) 
  .s pro(i,"filt")=$p(a,";",3) //это фильтр для формы редактирования
  .s pro(i,"spec")=$p(a,";",4)
  .s pro(i,"w")=$p(a,";",5)
  .s pro(i,"prof")=$tr($p(a,";",6),"()")
  .s s=$$NORM^%ZAPM.bs.BSCrr(so,3)_$$NORM^%ZAPM.bs.BSCrr(i,3),s(s)=i,a=$p(a,";")
  .s pro(i,"desc")=a
  .s pro(i,"type")=ClassOref.Properties.GetAt(i).Type
 d ClassOref.%Close()
  S i="",pr=pro F  S i=$O(s(i)) Q:i=""  s pr(i)=pro(s(i)) f ii="desc","type","filt","spec","w","prof" i $g(pro(s(i),ii))'="" s pr(i,ii)=pro(s(i),ii)
lpe i $g(%objlasterror)'="" w !,"Ошибка! :"_$System.Status.GetErrorText(%objlasterror)
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSCpool" type="MAC" languagemode="0"><![CDATA[
%BSCpool ;работа со спулером
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
COPY2BSSES(US,ID,BST) Q:US'=2  Q:$G(%BS(40))=""  
 N BSSES
 S BSSES=%BS(40)
 D MAINVAR^%ZAPM.bs.BSC4 
 I $D(^SPOOL(ID)) D Spool2BSSES(ID,BST)
 Q
Spool2BSSES(ID,BST) //Копировать из спулера в переменную окружения сессии
 N last
 s last=$O(^SPOOL(ID,""),-1) I last="" Q
 I ^SPOOL(ID,last)="" k ^SPOOL(ID,last)
 I $G(BSSES)="" Q
 M @BDSES@(BSSES,"VAR","SPOOL",BST)=^SPOOL(ID)
 K ^SPOOL(ID)
 Q
Spool2Mass(ID,GL) //Копировать из спулера в переменную окружения сессии
 N last
 s last=$O(^SPOOL(ID,""),-1)
 I ^SPOOL(ID,last)="" k ^SPOOL(ID,last)
 M @GL=^SPOOL(ID)
 K ^SPOOL(ID)
 Q
Test(a) w !!,a,! q a  //это тест
OutSpool(What)  //вывод в спулер
 n io,file,start,last
     s io=$IO,$ZT="OutErr"
     s file=+$J
     s start=1
     k ^SPOOL(file)
     o 2:(file:start)
     u 2
     x What
     u io
     c 2
     s last=$O(^SPOOL(file,""),-1)
     k ^SPOOL(file,last)
     Quit $na(^SPOOL(file))
OutErr U io C 2
 Q $na(^SPOOL(file))
TT S A="W $$rcomp^%Wr1(""%SYS"",""%SYS"",""%BSCSVV.INT"",""%BSCSVVold.INT"")"
 S B=$$OutSpool(A)
 D ^%ZAPM.bs.BSMSMG(B)
 Q
 
T //TEST
 S A="ZL %BSTM P  "
 S B=$$OutSpool(A)
 D ^%ZAPM.bs.BSMSMG(B)
 Q
 /* ------------------------------------------------------------------
 Message: 6         
   Date: Thu, 09 Dec 2004 15:12:31 +0300
   From: Eugene Karataev <ekarataev@mail.ru>
Subject: Re[2]: "Memory" Cache I/O Device
 
Добрый день.
 
> > Не поможете со следующей ситуацией:
> > Вызывается некоторый метод класса, пишущий в
> > Current I/O device.
> > Необходимо перехватить данный вывод (затем обработь
> > как целое).
 
Нужно сделать 
1) отдельную рутину, в которой будет делаться такой перехват
2) указать девайсу эту рутину в команде use
3) включить это перенаправление
 
Делается это так.
rstr(len,to)
 D $ZU(82,12,0)
 if $D(len)&&$D(to) d
 . R data#len:to
 e  i $D(len) d
 . R data#len
 e  i $D(to) d
 . R data:to
 e  d
 . R data 
 D $ZU(82,12,1)
 Q $G(data)
rchr(to)
 D $ZU(82,12,0)
 R *data 
 D $ZU(82,12,1)
 Q data
 // W expr
wstr(expr) 
 D $ZU(82,12,0)
 W $$Перекодируем(expr)
 D $ZU(82,12,1)
 Q
 // W *expr      
wchr(expr) 
 D $ZU(82,12,0)
 W *expr
 D $ZU(82,12,1)
 Q
 // W ?expr
wtab(expr)
 D $ZU(82,12,0)
 W ?expr
 D $ZU(82,12,1)
 Q
 // W !
wnl
 D $ZU(82,12,0)
 W ! 
 D $ZU(82,12,1)
 Q
 // W #
wff
 D $ZU(82,12,0)
 W # 
 D $ZU(82,12,1)
 Q  
 
И используем так.
 
        u dev::"^ПЕРЕХВАТЧИК" ; указываем какую мнемонику использовать
        D $ZU(82,12,1)   ; реально включаем флаг использования
        d normal() ; что будет писать в текущий девайс
        D $ZU(82,12,0)   ; перед закрытием девайса возвращаем флажок
        c dev
 
У себя мы такое использовали для выдачи csp страниц
в кодировке ISO8859-5, хотя вся разработка велась
в win1251. В каше 5 такие трюки используются например в ^%XDTM2.
 
Хотя, если неохота связываться с подозрительными $zu,
то можно включить вывод в спулер, и потом поднять из него.
Будет примерно то же самое что сначала в файл, потом из него,
только через глобаль.
 
С уважением,
Евгений Каратаев.
Фирма Эскейп
 
 
________________________________________________________________________
_______________
 */ 
]]></Routine>


<Routine name="%ZAPM.bs.BSCrr" type="MAC" languagemode="0"><![CDATA[
%BSCrr ; пpогpамма работы с Rational Rose
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 w "пpогpамма управления программами"
 Q
RR D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Import from Rational Rose"),$$B27^%ZAPM.bs.BSCGIS(1)
 ;I $$File2Arr^%ZAPM.bs.BSCEXE("N:\InfoPortal\WebNodes\b4y\docs\ReadmePTL2BS.htm",.Mas1) S f1="" F  S f1=$O(Mas1(f1)) Q:f1=""  W Mas1(f1)
 I $P($$HTTP^%ZAPM.bs.BSCmail("http://"_$$ADDSN^%ZAPM.bs.BSC4_"/b4y/docs/RotionalRose2BS-Portal.htm",2,.OUT)," ",2)=200  D
 .S f1="" F  S f1=$O(OUT("Data",f1)) Q:f1=""  W $G(OUT("Data",f1))
 
  //UPLOAD FILE TO SERVER
 S BSS1=""
 S BSS6="FILE1^~BSCrr" //ПРОГРАММА КОТОРАЯ ИСПОЛНЯЕТСЯ ПОСЛЕ ЗАГУЗКИ ФАЙЛА
 S BS1="" ;$TR(##class(%File).NormalizeDirectory(Tmp1)_$$ZCRC(PT_BSNODE_nf),":\","^~")
 S BS2="" ;nf,
 S BSS3=BSSES,BS3=MGWLIB,BSS8=$$BSADDVAR^%ZAPM.bs.BSC4(),BSS4="" ;x
 D UP^%ZAPM.bs.BSC4r3
 Q
END D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 Q
FILE1 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Import from Rational Rose. Step 2"),$$B27^%ZAPM.bs.BSCGIS(1)
 W RED_$G(FiNa)_EF_BBK
 ;N Mas,M,STOP,OC,O,OCC,GU,S,SS
 M Mas=@GL K @GL //МАССИВ В КОТОРОМ ЛЕЖИТ ЗАГРУЖЕННЫЙ ФАЙЛ
 S NoCloseWin=1 //ФЛАГ=НЕ ЗАКРЫВАТЬ ОКНО
 //ИМПОРТИРОВАТЬ СТРУКТУРУ ИЗ root_usecase_package 	(object Class_Category "Use Case View"
 //РАБОЧИХ ГРУПП=ACTORS, 
 //СОСТАВНЫХ ГРАНДОВ=PACKAGE
 //АТОМАРНЫХ ГРАНДОВ=USE_CASE
 S N1="root_usecase_package 	(object Class_Category ""Use Case View""" //НАЧАЛО
 S N2="(object Class_Category ""Logical View""" //КОНЕЦ
 S OC="(object Class ",OCC="(object Class_Category "
 S I="",S="" F i=1:1 S I=$O(Mas(I)) Q:I=""  D  Q:$G(STOP)
 .I i>1&(i<6) S S=S_Mas(I)
 .I Mas(I)[N1 S M(I)="" Q  ;Mas(I)
 .I $D(M) S M(I)=Mas(I) ;W "<LI>"_M(I)
 .I Mas(I)[N2 S STOP=1 Q
  I '$D(M) G DENID
 
 S I="",STOP=0 F  S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)  //ОСНОВНЫЕ ПАРАМЕТРЫ USE CACE VIEW
 .I M(I)["("  S STOP=1 Q
 .S II=$P($TR(M(I),$C(13,10,9))," ") I II="" Q
 .I II="documentation",M(I)'[$C(34) D  S I=III Q
 ..S III=I F ii=1:1 S III=$O(M(III)) Q:III=""  Q:M(III)'["|"  S SS(III)=$P(M(III),"|",2,99) S:ii=1 SS=$P(M(III),"|",2,99)
 .I II="documentation" S SS=$P(M(I),$C(34),2) 
 S TIT=$$TIT(SS) I TIT="" W RED_"Не определен имя ГРАНДА!!!"_EF G DENID
 
 W GREEN_S_EF_BBK W "Обнаружены следующие объекты"
 K STOP S I="",STOP=0 F  S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 .I M(I)["root_category" S STOP=1 Q
 .D REC(0,OC,"O(1)")
 .D REC(1,OCC,"O(0)")
 
 N V,VV
 K STOP S I="",STOP=0 F  S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 .I M(I)["root_category" S STOP=1 Q
 .D REC1("(object DependencyView ","V")
  K STOP S I="",STOP=0 F  S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 .I M(I)["root_category" S STOP=1 Q
 .D REC1("(object ClassView ""Class"" ","VV")
  K STOP S I="",STOP=0 F  S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 .I M(I)["root_category" S STOP=1 Q
 .D REC1("(object CategoryView ","VV")
 D GPAR(.V),GPAR(.VV)
 
 S G="" F  S G=$O(O(0,G)) Q:G=""  K M M M=O(0,G) K O(0,G) S O(0,G)="" D
 .K STOP S I="",STOP=0 F i=1:1 S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 ..I i=1 Q  //ПРОПУСТИМ ПЕРВУЮ СТРОКУ
 ..D REC(0,OCC,$NA(O(0,G)))
 S GG="" F  S GG=$O(O(0,GG)) Q:GG=""  S G="" F  S G=$O(O(0,GG,G)) Q:G=""  K M M M=O(0,GG,G) K O(0,GG,G) S O(0,GG,G)="" D
 .K STOP S I="",STOP=0 F i=1:1 S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 ..I i=1 Q  //ПРОПУСТИМ ЕЩЕ ПЕРВУЮ СТРОКУ
 ..D REC(0,OCC,$NA(O(0,GG,G)))
 W BBK_GREEN_"Cтруктура ГРАНДОВ И ПУНКТОВ МЕНЮ:"_EF_BBK
 D STR(0)
 S G="" F  S G=$O(O(1,G)) Q:G=""  D  I '$G(OK) K O(1,G)
 .S s="",OK=0  F  S s=$O(O(1,G,s)) Q:s=""  I O(1,G,s)["stereotype",O(1,G,s)["Actor" S OK=1 Q
 S OCC="(object Dependency_Relationship"
  S G="" F  S G=$O(O(1,G)) Q:G=""  K M M M=O(1,G) K O(1,G) S O(1,G)="" D
 .K STOP S I="",STOP=0 F i=1:1 S I=$O(M(I)) Q:I=""  D  Q:$G(STOP)
 ..I i=1 Q  //ПРОПУСТИМ ПЕРВУЮ СТРОКУ
 ..D REC(0,OCC,$NA(O(1,G)))
 S G="" F  S G=$O(GU(G)) Q:G=""  D  //РАЗОБРАТЬ ПАРАМЕТРЫ У ОБЪЕКТОВ
 .S I=0,STOP=0 F i=1:1 S I=$O(GU(G,I)) Q:I=""  D  Q:STOP
 ..I i=1 S nOC=$P($P(GU(G,I),"object ",2)," ") S GU(G,0,0)=nOC Q
 ..I GU(G,I)["("  S STOP=1 Q
 ..S II=$P($TR(GU(G,I),$C(13,10,9))," ") I II="" Q
 ..I II="documentation",GU(G,I)'[$C(34) D  S I=III Q
 ...S III=I F ii=1:1 S III=$O(GU(G,III)) Q:III=""  Q:GU(G,III)'["|"  S GU(G,0,II,III)=$P(GU(G,III),"|",2,99) S:ii=1 GU(G,0,II)=$P(GU(G,III),"|",2,99)
 ..S GU(G,0,II)=$P(GU(G,I),$C(34),2) 
 
  S I="" F  S I=$O(V(I)) Q:I=""  D  //ПОСТРОИЛИ ПОДЧИНЕННОСТЬ ПО ДИАГРАММЕ
 .S G=$TR($G(V(I,0,"client")),"@") I G="" Q
 .S GG=$G(VV(G,0,"quidu")) Q:GG=""  I $G(GU(GG,0,"stereotype"))'="Actor" Q
 .S G=$TR($G(V(I,0,"supplier")),"@") I G="" Q
 .S G=$G(VV(G,0,"quidu")) I G="" Q
 .S O(8,GG,G)=$TR($G(GU($G(V(I,0,"quidu")),0,"documentation")),$C(13,10,9,32,34)) //ПРАВА ЗАВИСИМОСТИ
 K O(1) M O(1)=O(8) K O(8)
 M O(10)=VV S O(10)="ДИАГРАММА - КЛАССЫ И КАТЕГОРИИ"
 M O(9)=V  S O(9)="ДИАГРАММА - ЗАВИСИМОСТИ"
 
 W BBK_GREEN_"Cтруктура ПОЛЬЗОВАТЕЛЕЙ И ИХ ПРАВ ДОСТУПА К ПУНКТАМ МЕНЮ:"_EF_BBK
 D STR1  I STOP G DENID
 S BSSES=BSS3,BSLOGIN=$P(BSS8,"@",10),O(4)=FiNa,O(2)=S M O(3)=SS
 K @BDSES@(BSSES,"VAR","RRObj") M @BDSES@(BSSES,"VAR","RRObj")=O   ;K ^XXX M ^XXX=O ;ДЕРЕВО ПОДЧИНЕННОСТИ
 K @BDSES@(BSSES,"VAR","RRGuid") M @BDSES@(BSSES,"VAR","RRGuid")=GU ;  K ^XXG M ^XXG=GU ;ПАРАМЕТРЫ GUID
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="Form^~BSCrr"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 w "<input type=submit name=sDUB value='Создать профили рабочих групп, Гранды и пункты меню' title=''>"_BK
 w "</form>"
 W "<HR>" G END
STR1  S I="",STOP=0 F  S I=$O(O(1,I)) Q:I=""  W "<LI>"_$$WG(I)_"</LI>"_BK D
 .S AA=$$Par($$WG(I,,"documentation"),"ShortName:") w " ("_GREEN_AA_EF_")" I AA="" W RED_"Неправильно Определен параметр ShortName:(НЕ ДОЛЖЕН БЫТЬ ПУСТОЙ)"_EF S STOP=1
 .W "<UL>"_BK S II="" F  S II=$O(O(1,I,II)) Q:II=""  W "<LI>"_$G(GU(II))_"</LI>"_BK 
 .W "</UL>"_BK
 Q 
GPAR(GU) N STOP,G,I,II,III,i,ii,nOC S G="" F  S G=$O(GU(G)) Q:G=""  D  //РАЗОБРАТЬ ПАРАМЕТРЫ У ОБЪЕКТОВ ДИАГРАММЫ
 .S I=0,STOP=0 F i=1:1 S I=$O(GU(G,I)) Q:I=""  D  Q:STOP
 ..S II=$P($TR(GU(G,I),$C(13,10,9))," ") I II="" Q
 ..F ii="quidu","client","supplier" I II=ii S GU(G,0,II)=$TR($P(GU(G,I),ii,2,3),$C(32,34,10,13,9))
 Q
REC1(OCC,R) N nOC,OS,ZS,GUID //РАЗБОР ДИАГРАММЫ
 I M(I)[OCC D  Q
 .S II=I,nOC=$TR($P(M(I)," ",$L(M(I)," ")),"@"_$C(13,10,9,34)),(OS,ZS)=0
 .;S GUID=$$GUID(M(I+1)) .W "<LI>"_nOC_" "_GUID_BBK
 .;S @R@(GUID)=nOC 
 .D  F  S II=$O(M(II)) Q:II=""  D  I ((OS-ZS)<1)  Q  ;W "<LI>"_nOC_"---"_OS_" "_ZS_BBK Q
 ..S @R@(nOC,II)=M(II),OS=OS+$L(M(II),"(")-1,ZS=ZS+$L(M(II),")")-1 ;W GREEN_II_EF_"."
 .;M GU(GUID)=@R@(GUID) S GU(GUID)=nOC 
 .Q:II=""  S I=II ;W RED_I_EF
 Q 
VO(TIT)  M O=@GB@(TIT,"O") M GU=@GB@(TIT,"G")
 Q
VAR  S GB=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSCRrose")
 S BDG=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""GRAND"")")
 S BDP=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""Profile"")")
 Q 
Form D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Import from Rational Rose. Step 3"),$$B27^%ZAPM.bs.BSCGIS(1)
 M O=@BDSES@(BSSES,"VAR","RRObj") S O="ДЕРЕВО ПОДЧИНЕННОСТИ",O(1)="ПОЛЬЗОВАТЕЛИ" 
 M GU=@BDSES@(BSSES,"VAR","RRGuid") S GU="ПАРАМЕТРЫ GUID",O(0)="КАТЕГОРИИ"
 D VAR 
 S TIT=$$TIT(O(3)) W TIT
 S O(11)="СООТВЕТСТВИЕ КОРОТКОГО ИМЕНИ И ЕГО GUID"
 S PR="_"
 S I="" F  S I=$O(O(1,I)) Q:I=""  D
 .S A=$$WG(I),A1=$$Par($$WG(I,,"documentation"),"ShortName:"),AA=PR_A1 
 .S O(11,A1)=I
 .W "<LI>Для новых пользователей группы "_RED_A_EF
 .K @BDP@(AA) S @BDP@(AA,"SOS")="MSM,"_AA_",ISS-???,NAV-ADM,EXC-ADMIN,DFLTMSM"
 .K @BDG@(AA) S @BDG@(AA,"REM")=A,@BDG@(AA,"Z1")="zOpenSess,xMAIL,"_PR_AA
 .S AA=PR_AA 
 .D CreateAtom(AA,A,A1)
 .W " создан профиль "_RED_PR_A1_EF_". Создан составной гранд "_RED_PR_A1_EF_", который включает в себя созданный атомарный гранд "_RED_PR_PR_A1_EF_"."
 S SU="__super"_ShortName
 D CreateAtom(SU,"Администратор","") 
 S SUP="SUPERVISOR"
 W "<HR>Дополнительно создан атомарный гранд "_RED_SU_EF_" и включен в составной гранд "_RED_SUP_EF
 S A=@BDG@(SUP,"Z1") I A'[SU S @BDG@(SUP,"Z1")=$$TR^%ZAPM.bs.BSsFUNM(A,",zProject,",",zProject,"_SU_",")
 W "<HR>Можете редактировать профили и гранды"
  D STY^%ZAPM.bs.BSCm2(0),DIV^%ZAPM.bs.BSCm2(0,"Редактивать системные БД","ОБЩИЕ ПАРАМЕТРЫ КОМПЛЕКСА")
 D   D DI^%ZAPM.bs.BSCm2 
 .N ta
 .s ta=1,ta("GRAND")=1,ta("Profile")=1 //ТОЛЬКО УКАЗАННЫЕ
 .D PARTS^%ZAPM.bs.BSCm("^%ZAPM.bs.BSC4","|",1,.ta)
 W "<HR>Можете создавать нового пользователя: "_$$NEWUSERS^%ZAPM.bs.BSC4rout
 K @GB@(TIT) S @GB@(TIT)=ShortName M @GB@(TIT,"O")=O M @GB@(TIT,"G")=GU
 W "<HR>" G END
 Q
CreateAtom(AA,A,A1)
 K @BDG@(AA) S @BDG@(AA,"REM")=TIT
 S @BDG@(AA,"MENU")="menu^%ZAPM.bs.BSC4b"
 S (@BDG@(AA,"TOPIC1"),@BDG@(AA,"TITLE"))=TIT_" ("_A_")"
 S @BDG@(AA,"PROG")="RRUN^~BSCrr("""_TIT_""","""_A1_""")"
 S @BDG@(AA,"NSP")=$P($P(O(3),"Namespace:",2)," ")
 S @BDG@(AA,"TOPIC")=$P(@BDG@("xTELNET","TOPIC"),">")_">"_TIT
 Q 
Par(TIT,N)  S TIT=$P(TIT,N,2) I TIT[$C(34) S TIT=$P(TIT,$C(34),2)
 E  S TIT=$P(TIT," ",1)
 Q TIT
TIT(TIT) S ShortName=$TR($P($P(TIT,"ShortName:",2)," "),$C(10,13,9))
 S TIT=$P(TIT,"Name:",2) I TIT[$C(34) S TIT=$P(TIT,$C(34),2)
 E  S TIT=$P(TIT," ",1)
 I TIT="" S TIT=$P($P(O(4),"."),"\",$L(O(4),"\"))
 Q TIT
STR(N)  S I="",STOP=0 F  S I=$O(O(N,I)) Q:I=""  W "<LI>"_$$WG(I)_"</LI>"_BK D
 .I N S AA=$$Par($$WG(I,,"documentation"),"ShortName:") w " ("_GREEN_AA_EF_")" I AA="" W RED_"Неправильно Определен параметр ShortName:(НЕ ДОЛЖЕН БЫТЬ ПУСТОЙ)"_EF S STOP=1
 .W "<UL>"_BK S II="" F  S II=$O(O(N,I,II)) Q:II=""  W "<LI>"_$$WG(II,1)_"</LI>"_BK D:'N
 ..W "<UL>"_BK D
 ...S III="" F  S III=$O(O(N,I,II,III)) Q:III=""  W "<LI>"_$$WG(III)_"</LI>"_BK 
 ..W "</UL>"
 .W "</UL>"_BK
 Q
WG(G,GG,PAR) I $G(PAR)'="" Q $G(GU(G,0,PAR))
 I $G(N),$G(GG) Q $G(GU(G,0,"supplier"))
 Q $G(GU(G))
REC(T,OCC,R) N nOC,OS,ZS,GUID
 I M(I)[OCC D  D:$G(T) TEA($NA(@R@(GUID))) Q  //CLASS_CATEGORY ДО UseCaseDiagram ""Main
 .S II=I,nOC=$TR($P(M(I),OCC,2),$C(13,10,9,34)),(OS,ZS)=0,GUID=$$GUID(M(I+1)) ;W "<LI>"_nOC_" "_GUID_BBK
 .S @R@(GUID)=nOC 
 .D  F  S II=$O(M(II)) Q:II=""  D  I ((OS-ZS)<1)  Q  ;W "<LI>"_nOC_"---"_OS_" "_ZS_BBK Q
 ..S @R@(GUID,II)=M(II),OS=OS+$L(M(II),"(")-1,ZS=ZS+$L(M(II),")")-1 ;W GREEN_II_EF_"."
 .M GU(GUID)=@R@(GUID) S GU(GUID)=nOC Q:II=""  S I=II ;W RED_I_EF
 Q 
DENID W RED_"НЕВЕРНЫЙ ФОРМАТ ФАЙЛА!!"_EF
 G END 
GUID(S) I S'["quid " Q "???"
 Q $P(S,$C(34),2) 
TEA(R) N RR W "<TEXTAREA COLS=80 ROWS=6>"
 S RR=R F  S RR=$ZO(@RR) Q:RR'[$E(R,1,$L(R)-1)   W @RR
 W "</TEXTAREA>"
 Q
BUTCLOSE //КНОПКА О ЗАКРЫТИИ ОКНА ДЛЯ OpenWeb.exe при $$B27^%ZAPM.bs.BSCGIS(0)
 N BSocxP0kD S BSocxP0kD=1 D BUTT^%ZAPM.bs.BSCGIS
 Q 
 ///////////////////////////////////////////////////////////////////////////
Tree1 ; D locvar^%ZAPM.bs.BSCh0("",1)
 D VAR,VO(BSTIT) 
 S RO=$$Par($$WG(TrID,,"documentation"),"Routine:") 
 I $G(RO)="" W $$js^%ZAPM.bs.BSCp_BK_"status='Status :CloseWin:'"_BK_$$jse^%ZAPM.bs.BSCp_BK Q
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS($g(GU(TrID))),$$B27^%ZAPM.bs.BSCGIS(0)
 S MR=$E($$Par($$WG(TrID,,"documentation"),"Mode:"),1) I MR="" S MR="T"
 S NS=$$Par($$WG(TrID,,"documentation"),"Namespace:") I NS="" S NS=BSNSP
 S RI=$G(@BDSES@(BSSES,"VAR","Rights",TrID),"N")
 S RO=$ZCVT(RO,"U") //ВСЕГДА БОЛЬШИМИ БУКВАМИ
 I RO["^" S ROU=$P(RO,"^",2)
 ;S NS="PRG" //?
 W "<li>Routine: "_ROU_"<li>Mode: "_MR_"<li>Namespace: "_NS_"<li>"_RI_BBK
 I $$EXIST^%R(ROU_".INT",NS) d
 .I MR="T" D  Q  //ЗАПУСК В ТЕРМИНАЛЬНОМ РЕЖИМЕ
 ..;I RO["^",$P(RO,"^")="" ;S ROU="^^ULARX5" //_ROU ////? IntRun^???
 ..;E  
 ..S ROU=$$TR^%ZAPM.bs.BSsFUNM(RO,"^","^^")
 ..W BBK_"Запускаем "_ROU
 ..D Exec^%ZAPM.bs.BSCp
 ..W $$js^%ZAPM.bs.BSCp_BK
 ..W $$TELNET^%ZAPM.bs.BSCp2(NS,"#",ROU,$G(GU(TrID)))_BK
 ..W "status='Status :CloseWin:';"_BK
 ..W $$jse^%ZAPM.bs.BSCp_BK
 .I MR="O" D @ROU
 E  W RED_"Программы в рабочей области нет !!!"
 D BUTCLOSE,END^%ZAPM.bs.BSC4
 Q
RRUN(BSTIT,SN)  //УНИВЕРСАЛЬЫЙ ЗАПУСК ПРОГРАММ RR
 N BSLABEL,BSTOP3,BSTOP,BSTOP2
 D BEG1^%ZAPM.bs.BSC4
 D VAR,VO(BSTIT)
 I SN="" W RED_"Включены привелегии Администратора!"_EF
 D Tree
 D END^%ZAPM.bs.BSC4
 Q
Tree
 ;W RED_"<li>Выберите ЗАКАЗЧИКА, тему и раздел темы кликая на + и -"_EF
 ;W RED_"<li>Для отправки сообщения в заказ нужно правой кнопкой мыши выбрать требуемый режим"_EF
 ;D Var^siMSW 
 D TreeStyle,TreeJS
 D CMenuJS("Tree1^~BSCrr",1),ContextMenuGO("ALLTXT")
 D END^%ZAPM.bs.BSC4
 Q
TreeStyle
  Write "",!
	Write "<STYLE>",!
	Write ".button_light {",!
	Write "        BORDER-RIGHT: #bfcfde 1px solid; BORDER-TOP: #bfcfde 1px solid; FONT-SIZE: 12px; BORDER-LEFT: #bfcfde 1px solid; COLOR: #000000; BORDER-BOTTOM: #bfcfde 1px solid;",!
	Write "}",!
	Write ".text_light {",!
	Write "        FONT-SIZE: 14px; COLOR: #000000;",!
	Write "}",!
	Write ".body_grey {",!
	Write "        BACKGROUND-COLOR: #85C0F2; FONT-SIZE: 14px; COLOR: #000000;",!
	Write "}",!
	Write ".tbl_list_user_uti1l {",!
	Write "        FONT-SIZE: 8pt; COLOR: #000000;",!
	Write "}",!
	Write ".body_grey1 {",!
	Write "        BACKGROUND-COLOR: #85C0F2; FONT-SIZE: 8px; COLOR: #000000;",!
	Write "}",!
	Write ".text {",!
	Write "        FONT-SIZE: 9pt; COLOR: #5679af; FONT-FAMILY: Verdana, arial",!
	Write "}",!
	Write ".tariftext {",!
	Write "        FONT-SIZE: 9px; FONT-FAMILY: Verdana, arial; BACKGROUND-COLOR: #f1f1f1",!
	Write "}",!
	Write ".tarif {",!
	Write "        FONT-SIZE: 9px",!
	Write "}",!
	Write ".cmstarif {",!
	Write "        FONT-SIZE: 9px; BACKGROUND-COLOR: #f1f1f1",!
	Write "}",!
	Write ".cmstarif2 {",!
	Write "        FONT-SIZE: 9px; BACKGROUND-COLOR: #e1e1e1",!
	Write "}",!
	Write ".as {",!
	Write "        PADDING-RIGHT: 10px; PADDING-LEFT: 10px; FONT-SIZE: 8pt; PADDING-BOTTOM: 10px; COLOR: #5679af; PADDING-TOP: 10px; FONT-FAMILY: Verdana, arial; align: justify",!
	Write "}",!
	Write "BODY {",!
	Write "        BACKGROUND-IMAGE: url(images/bg2.gif); BACKGROUND-REPEAT: repeat-x",!
	Write "}",!
	Write "A {",!
	Write "        COLOR: #26497f; TEXT-DECORATION: none",!
	Write "}",!
	Write "A:visited {",!
	Write "        COLOR: #26497f; TEXT-DECORATION: none",!
	Write "}",!
	Write "A:hover {",!
	Write "        COLOR: #7699cf; TEXT-DECORATION: none",!
	Write "}",!
	Write "A:active {",!
	Write "        COLOR: #7699cf; TEXT-DECORATION: none",!
	Write "}",!
	Write ".off {",!
	Write "        DISPLAY: none",!
	Write "}",!
	Write ".menu {",!
	Write "        FONT-WEIGHT: bold; FONT-SIZE: 12px; COLOR: #494949; FONT-FAMILY: Tahoma; valign: top",!
	Write "}",!
	Write ".menu:visited {",!
	Write "        COLOR: #494949",!
	Write "}",!
	Write ".menu:hover {",!
	Write "        COLOR: #494949",!
	Write "}",!
	Write ".menu:active {",!
	Write "        COLOR: #494949",!
	Write "}",!
	Write "IMG.blackBorder {",!
	Write "        BORDER-RIGHT: #000 1px solid; BORDER-TOP: #000 1px solid; BORDER-LEFT: #000 1px solid; BORDER-BOTTOM: #000 1px solid",!
	Write "}",!
	Write ".linkator_td {",!
	Write "        FONT-SIZE: 10px; FONT-FAMILY: Verdana",!
	Write "}",!
	Write ".linkator_a {",!
	Write "        FONT-SIZE: 12px; FONT-FAMILY: Verdana",!
	Write "}",!
	Write ".linkator_url {",!
	Write "        FONT-SIZE: 12px; FONT-FAMILY: Verdana",!
	Write "}",!
	Write ".linkator_table {",!
	Write "        BORDER-TOP: #000000 1px solid",!
	Write "}",!
	Write "</STYLE>",!
 
 ;	Write "</HEAD>",!
 ;	Write "<BODY marginwidth='0'   class='body_grey' >",!
	Write "<TABLE id='list' border='0'>",!
	Write "<TR><TD></TD></TR>",!
	Write "</TABLE>",!
    Write "<!-- SSSSSSSSSSSSSSSSSSSS ->",!
    Q
CMenuJS(ROU,ON)
	Write "<STYLE>",!
	Write "#ie5menu{",!
	Write "position:absolute;",!
	Write "border:2px solid black;",!
	Write "background-color:#BBBBBB;",!
	Write "font-family:Courier New;",!
	Write "font-size:15px;",!
	Write "line-height:18px;",!
	Write "cursor:default;",!
	Write "visibility:hidden;",!
	Write "}",!
	Write ".menuitems{",!
	Write "padding-left:15px;",!
	Write "padding-right:15px;",!
	Write "}",!
	Write "</STYLE>",!
  D Exec^%ZAPM.bs.BSCp
	Write "<SCRIPT language=JavaScript1.2>",!
	Write "var display_url=1;",!
	Write "function showmenuie5(){",!
	Write "var rightedge=document.body.clientWidth-event.clientX;",!
	Write "var bottomedge=document.body.clientHeight-event.clientY;",!
	Write "if (rightedge<ie5menu.offsetWidth)",!
	Write "ie5menu.style.left=document.body.scrollLeft+event.clientX-ie5menu.offsetWidth;",!
	Write "if (rightedge >= ie5menu.offsetWidth)",!
	Write "ie5menu.style.left=document.body.scrollLeft+event.clientX;",!
	Write "if (bottomedge<ie5menu.offsetHeight)",!
	Write "ie5menu.style.top=document.body.scrollTop+event.clientY-ie5menu.offsetHeight;",!
	Write "else",!
	Write "ie5menu.style.top=document.body.scrollTop+event.clientY;",!
	Write "ie5menu.style.visibility='visible';",!
	Write "return false;",!
	Write "}",!
	Write "function hidemenuie5(){",!
	Write "ie5menu.style.visibility='hidden';",!
	Write "}",!
	Write "function ReturnFalse(){",!
	Write "return false;",!
	Write "}",!
	Write "function highlightie5(){",!
	Write "if (event.srcElement.className=='menuitems'){",!
	Write "event.srcElement.style.backgroundColor='highlight';",!
	Write "event.srcElement.style.color='white';",!
	Write "if (display_url==1)",!
	Write "window.status=event.srcElement.url;",!
	Write "}",!
	Write "}",!
	Write "function lowlightie5(){",!
	Write "if (event.srcElement.className=='menuitems'){",!
	Write "event.srcElement.style.backgroundColor='';",!
	Write "event.srcElement.style.color='black';",!
	Write "window.status='';",!
	Write "}",!
	Write "}",!
	Write "function jumptoie5(){",!
	Write "if (event.srcElement.className=='menuitems')",!
	Write "window.location=event.srcElement.url;",!
	Write "}",!
  
	Write "function DO(param)",!
	Write "    {",!  
	;Write "    window.open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"""+param"_$S($G(ON):"+""&TrID=""+CurrentElementOfTree",1:"")_","""","""");",!
	W " "_$$OpenWeb^%ZAPM.bs.BSCp2("http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"'+param"_$S($G(ON):"+'&TrID='+CurrentElementOfTree",1:""))
	Write "    };",!
	Write "</SCRIPT>",!
	Q
ContextMenuGO(LAB)
	Write "<DIV id=ie5menu onmouseover=highlightie5() style='LEFT: 207px; VISIBILITY: hidden; TOP: 78px' onmouseout=lowlightie5()>",!
	D @LAB
	Write "</DIV>",!
	Write "<SCRIPT language=JavaScript1.2>",!
	Write "document.body.onclick=hidemenuie5;",!
	Write "</SCRIPT>",!
	Write "",!
 Q
ALLPG 	Write "<DIV width='100%' class=menuitems style='COLOR: black' onclick='DO(""&Mode=Check"");' >Помеченные записи в заказ...</DIV>",!
	;Write "<DIV class=menuitems style='COLOR: black' onclick='if(confirm(""Вы уверены?"")){location=""?LBL_=INDEX_tree_editor*tree_editor&TBL_=oldtree&OPEN_=1=0;2=0;3=0;4=0;5=0;6=0;7=0;8=0;9=0;10=0;11=0;12=0;13=0;14=0;15=0;21=0;19=0;20=0;28=0;29=0;30=0;31=0;92=0;81=0;79=0;91=0;90=0;86=0;74=0;88=0;89=0;83=0;93=0;85=0;94=0;95=0;96=0;97=0;98=0;99=0;100=0;101=0;102=0;103=0;104=1;105=0;&SESS=1144240589*41985476&OPENER_RELOAD_=1&TBL_=oldtree&SPEC=DELROW&ID_=""+CurrentElementOfTree+""&OPEN_=""+GetOpen();}' >Удалить</DIV>",!
	Write "<DIV class=menuitems style='COLOR: black' onclick='DO(""&Mode=ALLPG"");' >Все записи страницы в заказ...</DIV>",!
	;I $D(%fmin) Write "<DIV class=menuitems style='COLOR: black' onclick='DO(""&Mode=ALL"");' >Все записи фильтра в заказ...</DIV>",!
	Write "<DIV>-------------</DIV>",!
	Write "<DIV class=menuitems style='COLOR: black' onclick='if(confirm(""Удалить! Вы уверены?"")){DO(""&Mode=KILLALLPG"");}' >Удалить помеченные записи</DIV>",!
	Q 
ALLTXT 	Write "<DIV width='100%' class=menuitems style='COLOR: black' onclick='DO(""&Mode=ANONS"");' >Анонс</DIV>",!
	Write "<DIV class=menuitems style='COLOR: black' onclick='DO(""&Mode=ALLTXT"");' >Весь текст</DIV>",!
	Q 
TreeJS
	Write " <SCRIPT>",!
	Write " var Tree = '';var widgetWidth = 12;var widgetHeight = 12;var CurrentElementOfTree=-1;",!
	Write "var fillerImg = new Image(1,1);fillerImg.src = '"_BSDOMAIN_"/img/ico/filler.gif';minus = new Image(widgetWidth,widgetHeight);minus.src = '"_BSDOMAIN_"/img/ico/minus.gif';var plus = new Image(widgetWidth,widgetHeight);plus.src = '"_BSDOMAIN_"/img/ico/plus.gif';var end = new Image(widgetWidth,widgetHeight);end.src = '"_BSDOMAIN_"/img/ico/end.gif';var pCell=document.getElementById('list').rows[0].cells[0];var BR='';",!
	Write "var db = new Array();",!
	Write "function GetOpen()",!
	Write "{",!
	Write "    var open=';';",!
	Write "    for(var i=0;i<countRow;i++)",!
	Write "              {",!
	Write "                  open+=db[i].id+'='+db[i].open+';';",!
	Write "              }",!
	Write "    open=open.substr(1);",!
	Write "    return open;",!
	Write "};",!
	Write "function SetVisible(i)",!
	Write "{",!
	Write "    db[i].open==0?db[i].open=1*1:db[i].open=0*1;Tree='';GetChild(0,0);pCell.innerHTML=Tree;",!
	Write "};",!
	Write "function dbRecord(id,name,parent,open,tit)",!
	Write "{",!
	Write "    this.id = id;",!
	Write "    this.name = name;",!
	Write "    this.parent = parent;",!
	Write "    this.open = open*1;",!
	Write "    this.tit = tit;",!
	Write "    return this;",!
	Write "};",!
	Write "function GetChild(id,level)",!
	Write "{",!
	Write "   var onclk;",!
	Write "   for(var i=0;i<countRow;i++)",!
	Write "          {",!
	Write "                 if(db[i].parent==id)",!
	Write "      {",!
	Write "      isHaveChild(db[i].id)?(db[i].open==1?ico='minus':ico='plus'):ico='end';",!
	Write "      ico=='end'?onclk='':onclk='SetVisible('+i+');';",!
	Write "      Tree+=(""<IMG SRC='"_BSDOMAIN_"/img/ico/filler.gif' HEIGHT='1' WIDTH='""+level*15+""'>"");",!
	;Write "      Tree+=(""<IMG style='cursor:hand;' onclick='""+onclk+""hidemenuie5();' oncontextmenu='hidemenuie5();return false;' SRC='"_BSDOMAIN_"/img/ico/""+ico+"".gif' HEIGHT='12' WIDTH='12' BORDER='0'>"");",!
	Write "      Tree+=(""<IMG style='cursor:hand;' onclick='""+onclk+""hidemenuie5();' SRC='"_BSDOMAIN_"/img/ico/""+ico+"".gif' HEIGHT='12' WIDTH='12' BORDER='0'>"");",!
	Write "      Tree+=(""<IMG SRC='"_BSDOMAIN_"/img/ico/filler.gif' HEIGHT='1' WIDTH='5'>"");",!
	;Write "      Tree+=""<SPAN  style='cursor:hand;' ONCLICK='alert(CurrentElementOfTree=""+db[i].id+"");' oncontextmenu='CurrentElementOfTree=""+db[i].id+"";showmenuie5();return false;'>""+db[i].name+'</SPAN><BR>'+'\r\n';",!
	Write "      Tree+=""<SPAN title='""+db[i].tit+""' style='cursor:hand; text-decoration:underline;' ONCLICK='DO(CurrentElementOfTree=""+db[i].id+"");' >""+db[i].name+'</SPAN><BR>'+'\r\n';",!
	Write "      if(db[i].open==1){GetChild(db[i].id,level+1)};",!
	Write "      }",!
	Write "    }",!
	Write "    return 0;",!
	Write "};",!
	Write "function isHaveChild(id)",!
	Write "{",!
	Write "   for(var i=0;i<countRow;i++)",!
	Write "          {",!
	Write "                 if(db[i].parent==id){return 1;}",!
	Write "          }",!
	Write "return 0;",!
	Write "}",!
 N SO,OO S NORM=9000 
 I SN'="" D  //КАСТРИРУЕМ ПОЛНОЕ ДЕРЕВО ПОД КАЖДОГО ПОЛЬЗОВАТЕЛЯ
 .K OO(0) S SNG=O(11,SN)
 .S I="" F  S I=$O(O(1,SNG,I)) Q:I=""  D
 ..I $D(O(0,I)) M OO(0,I)=O(0,I)
 ..S OO(0,I)=$g(O(1,SNG,I)) //присвоим права доступа
 .K O(0) M O(0)=OO(0)  
 E  S I="" F  S I=$O(O(0,I)) Q:I=""  S O(0,I)="Rights:RWD"
 K OO
 S I="" F  S I=$O(O(0,I)) Q:I=""  S T=$$NORM($$Par($$WG(I,,"documentation"),"Tag:"),5) S SO(T)=I
 S T="" F  S T=$O(SO(T)) Q:T=""  S I=SO(T) D
 .S (OO(I),RI)=$G(O(0,I))
 .Write "db[db.length] = new dbRecord('"""_I_"""', '"_$g(GU(I))_"', '0', 0,'"_$TR(RI_" "_$$WG(I,,"documentation"),$C(34,10,13))_" id="_I_"');",!
 .S II="" F  S II=$O(O(0,I,II)) Q:II=""  S T2=$$NORM($$Par($$WG(II,,"documentation"),"Tag:"),5) S SO(T,T2)=II
 .S T2="" F  S T2=$O(SO(T,T2)) Q:T2=""  S II=SO(T,T2) D
 ..S RI1=$G(O(0,I,II)) I RI1="" S (OO(II),O(0,I,II),RI1)=RI
 ..Write "db[db.length] = new dbRecord('"""_II_"""', '"_$g(GU(II))_"', '"""_I_"""', 1,'"_$TR(RI1_" "_$$WG(II,,"documentation"),$C(34,10,13))_" id="_II_"');",!
 ..S I2="" F  S I2=$O(O(0,I,II,I2)) Q:I2=""  S T3=$$NORM($$Par($$WG(I2,,"documentation"),"Tag:"),5) S SO(T,T2,T3)=I2
 ..S T3="" F  S T3=$O(SO(T,T2,T3)) Q:T3=""  S I2=SO(T,T2,T3) D
 ...S RI2=$G(O(0,I,II,I2)) I RI2="" S (OO(I2),RI2,O(0,I,II,I2))=RI1
 ...Write "db[db.length] = new dbRecord('"""_ID2_"""', '"_$g(GU(I2))_"', '"""_ID_"""', 1,'"_$TR(RI2_" "_$$WG(I2,,"documentation"),$C(34,10,13))_" id="_I2_"');",!
 K @BDSES@(BSSES,"VAR","Rights") M @BDSES@(BSSES,"VAR","Rights")=OO
	Write "countRow=db.length;",!
	Write "GetChild(0,0);pCell.innerHTML=Tree;</SCRIPT>",!
 Q
NORM(S,N) I S="" S NORM=$G(NORM,9000)+1,S=NORM
 Q $TR($J(S,N)," ","0")
]]></Routine>


<Routine name="%ZAPM.bs.BSCsss" type="MAC" languagemode="0"><![CDATA[
%BSCsss ;for SavchukSergeySergeevich
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
 /* 
sr - проги (%RI)
sg - массивы (%GIF)
 
Закачал кусочек инфы с интерент (пара десятков каналов за один проход)
модуль закачки siWEB
модуль аналитика siM
пароль SSS пользователь SSS
В siWEB по F2 отражаены последние изменения и планы
 
Что хотелось бы.
 
Получить, хотя бы схематично, удаленное место аналитика с возможностью работы мышкой. Чтобы можно было и из дома подключаться к серверу и открыть/закрыть доступ любому желающему. Например, тебе.
Можно дождаться нового терминала (если поделишся) или через твой вебсервер.
Я так и не понял толком как его запустить и как с ним работать.
Если можно, инструкцию для полного идиота по шагам.
(шаг первый: воткнуть вилку в розетку. Да не пищевую, дурак, а компьюерную. Вроде этого и еще подробнее)
 
Я и сам горю желанием разобраться как делать красивые интерфейсы, но нужно 
а) добиться чтобы он заработал
б) понять как он работает с каше
 
Полностью копировать интерфейс siM не совсем будет правильно т.к. он все же расчитан на терминал с его ограничениями, и потом я постоянно чего-то туда добавляю. (Дурная голова рукам покоя не дает)
 
Самое оптимальное - это получить механизм (конструктор) создания окошек, диалогов, сообщений и т.д. с привязкой к каше базам.
 */
siM  //модуль аналитика siM (ВЕБ - ИНТЕРФЕЙС)
 ZN "USER" d ^siMSW
 q 
 //////// МОДУЛЬ ДИСПЕТЧЕРА ДЛЯ WaitinGhost.exe /////////////////////////////////
RETURN //ВОЗВРАТИТЬ КОМАНДУ ДЛЯ WaitinGhost.exe
 S BK=$C(13,10)
 s GLO="^[""USER""]SSSCMD"
 S ID=$G(%KEY("TRM")) I ID="" W "0"_BK_"ПУСТОЙ ID" Q
 I '$D(@GLO@(ID)) W "0"_BK_"ID="_ID_" несуществует" Q
 
 I $G(%KEY("BSLABEL"))'="" G @$G(%KEY("BSLABEL")) //ПОСЫЛАЕМ НА ДРУГУЮ ПРОГРАММУ
 
 S CMD=$G(@GLO@(ID,"cmd")) //КОМАНДЫ МОЖЕШЬ ШИФРОВАТЬ, А В ПРОГРАММЕ WaitinGhost.exe ДЕШИФРОВАТЬ И ВЫПОЛНЯТЬ
 I CMD="" W "0"_BK_"ПУСТАЯ КОМАНДА" Q
 W "1"_BK_CMD
 Q
CLEAR //ОЧИСТКА ПОСЛЕ Terminate WaitinGhost
 S @GLO@(ID,"cmd")=""
 Q
INIT //ИНИЦИАЛИЗАЦИЯ УЗЛА SSS1 WEBLINKA
 X "ZL %BSChMGW zs %ZMGW2"
 S ^%ZAPM.bs.BScARM("SSS1","ROU")="RETURN^%ZAPM.bs.BSCsss"
 S ^%ZAPM.bs.BScARM("SSS1","NSP")="USER"
 Q
TEST1 S ^["USER"]SSSCMD(123,"cmd")="CALC" //ЗАПУСТИТЬ КАЛЬКУЛЯТОР НА КЛИЕНТЕ 123
 Q
TEST2 S ^["USER"]SSSCMD(123,"cmd")="NOTEPAD D:\MSW\n.bat" //ЗАГРУЗИТЬ НА КЛИЕНТЕ ТЕКСТ 123
 Q
TEST3 S ^["USER"]SSSCMD(123,"cmd")="Terminate WaitinGhost" //ОТДАТЬ КОМАНДУ ВЫГРУЗИТСЯ WaitinGhost.exe 
 Q       
]]></Routine>


<Routine name="%ZAPM.bs.BSCsys" type="MAC" languagemode="0"><![CDATA[
%BSCsys ; пpогpамма управления программами ; 11:12   12.09.2002
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
S() N BSLABEL
 Q "<A name='SS2' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,"SS^%ZAPM.bs.BSCsys")_""",""RESULT3"",""toolbar=no,menubar=no,scrollbars=yes,width=800,height=400,status=1,resizable=1"");' ><IMG src='"_BSDOMAIN_"/img/ham-red.gif' alt='Статус системы'></A>"
SS N CK,I,II,AK,Fname,CKK,DD
 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Сервер: "_$ZU(110)_". Cостояние системы"),$$B27^%ZAPM.bs.BSCGIS(1)
 w "<BODY>"
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="Form^~BSCsys",DD=$$TEMPDIR^%ZAPM.bs.BSpgBS
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 I $G(BSSES)="" W "надо зарегистрироваться!"
 E  D
 . zn "%sys" ;D OutSpool^%ZAPM.bs.BSCpool("D ALL^%SS"),Spool2BSSES^%ZAPM.bs.BSCpool(+$J,"^%SS") M CK=@BDSES@(BSSES,"VAR","SPOOL","^%SS")
 .S Fname=DD_"SS"_$J_".log" S OLDIO=$I O Fname:"UWN" U Fname D ALL^%SS U OLDIO C Fname 
 .d File2Arr^%ZAPM.bs.BSCEXE(Fname,.CKK),DelFile^%ZAPM.bs.BSCEXE(Fname)
 .D STR2MAS^%ZAPM.bs.BSCmail(.CKK,.CK,BK)
 .W "<table border=0 width=100%>" D  W "</table><HR>"
 ..S I="" F II=1:1 S I=$O(CK(I)) Q:I=""  I II'=1 W "<tr>" D  W "</tr>" 
 ...W "<td class=s1><PRE>"_$$SSS(II,CK(I))_"</PRE></td>"
 w "<input type=submit name=sDUB value='Завершить помеченные процессы' title='Завершить помеченные процессы'>"_BK
 D BUTT^%ZAPM.bs.BSCGIS 
 w "</form>"
 D END^%ZAPM.bs.BSC4
 Q
Form N PID zn "%sys"
 S I="" F  S I=$O(%KEY(I)) Q:I=""  I $E(I,1,3)="PID" D
 .S PID=$E(I,4,99)
 .I $$INT^RESJOB(PID) W GREEN_BBK_"процесс "_PID_" cнят"_EF Q
 .W RED_BBK_"процесс "_PID_" не может быт cнят"_EF
 G SS
SSS(N,S) N C1,C2,PID,ROU,WAR S (C1,C2)="",WAR=""
 I N>3,$E(S,1)=" " D
 .S PID=$$CutS^%ZAPM.bs.BSF10($E(S,1,6))
 .I PID D
 ..I $D(^%ZAPM.bs.BSlog(PID)) S C1=MAROON,C2=EF
 ..E   S C1=GREEN,C2=EF
 ..S ROU=$P($E(S,41,83)," ")
 ..I $E(ROU,1,3)="%BS" S S=$$Cut^%ZAPM.bs.BSF10(S)_" <input type=checkbox "_$$SSSS(PID,ROU)_" name=PID"_PID_" value='' title='Пометить процесс для завершения'> "_WAR
 Q C1_S_C2
SSSS(P,R) N H I R="%BSpgWEBC" Q "DISABLED"
 I $$exists^%ZAPM.bs.BSCEXE(DD_"Scra"_P) S H=$ZU(140,3,DD_"Scra"_P) I +H=+$H,($P($H,",",2)-$P(H,",",2))>180 D  Q "CHECKED"
 .S C1=RED,C2=EF,WAR="Процесс порожден BSTKWEB. Работает "_(($P($H,",",2)-$P(H,",",2))\60)_" мин."
 Q "" 
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCt" type="MAC" languagemode="0"><![CDATA[
%BSCt ;ФУНКЦИИ ТАБЛИЦ И ТЕКСТОВ ; 0:20   22.01.2000
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 Q
TEXT(G) ;ТЕКСТ
 N I,II
 S (II,P1)=""
 F I=1:1 Q:'$D(@G@(I))  S II=II_@G@(I)_$C(13,10)
 Q II
TabColSize(T,D) ;РАЗМЕР КОЛОНОК В ТАБЛИЦЕ T
 I +$G(D)=0 S D=$P(@T,"@",29)
 S II="" F I=1:1:D S II=II_$P(@T@(1,I),"@",4)_","
 S P1=D
 Q II
TabRowSize(T,D) ;РАЗМЕР СТРОК В ТАБЛИЦЕ T
 I +$G(D)=0 S D=$P(@T,"@",28)
 S II="" F I=1:1:D S II=II_$P(@T@(I,1),"@",3)_","
 S P1=D
 Q II
TabShab(T) ;ШАПКА В ТАБЛИЦЕ T
 N D,TS,K,S
 I +$G(D)=0 S D=$P(@T,"@",29) ;КОЛИЕСТВО КОЛОНОК
 S TS=+$P($P(@T,"@",19),",") I TS<2 Q "" ;ШАПКИ НЕТ
 S II="" F S=1:1:TS-1 D  S II=II_$C(2) ;КОНЕЦ СТРОКИ
 .F K=1:1:D S II=II_$$DATACELL(T,S,K)_$C(1)
 Q II
TabCell(T,OT,DO) ;ДАННЫЕ В ТАБЛИЦЕ T
 N D,TS,K,S
 I +$G(D)=0 S D=$P(@T,"@",29) ;КОЛИЕСТВО КОЛОНОК
 S II="" F S=OT:1:DO D  S II=II_$C(2) ;КОНЕЦ СТРОКИ
 .F K=1:1:D S II=II_$$DATACELL(T,S,K)_$C(1)
 Q II
DATACELL(T,S,K) ;ДАННЫЕ КЛЕТКИ РАЗБИТЫЕ _$C(13,10)
 N D,W,I,II,H,J
 S D=$$CELL(T,S,K),II=""
 I $P(@T@(S,K),"@",3)=1 Q D
 S H=$P(@T@(S,K),"@",3),W=$P(@T@(S,K),"@",4)
 F I=1:1:H S II=II_$E(D,(I*W)-W+1,W+(W*(I-1)))_$C(13,10)
 Q II
CELL(T,ny,nx) ;ДАННЫЕ КЛЕТКИ
 N BSR,BST,BS,B,d,d1,d0,st,ke,se
 S se=+$O(@T@(" "),-1),ke=+$O(@T@(1,""),-1)
 ;S BSR=$P(T,"("),BST=$O(@T),BST=$O(@BSR@(BST),-1)
 S BSR=$P(T,"("),BST=$QS(T,1)
 I '$D(@BSR@(BST,ny,nx)) Q ""
 S BS=@BSR@(BST,ny,nx),B=@BSR@(BST)
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$J_"u1",ny,nx)) ;ДЛЯ БАЗ ДАННЫХ БУДЕТ ПО ДРУГОМУ
 I d0="" S d0=" " ;????
 I $P(BS,"@",8)'="" D
 .I $P(BS,"@",8)=0 X $G(@(BSR_"(BST,""FTR"","_ny_","_nx_")")) S d0=d1 Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")")) S d0=d1
 Q d1
]]></Routine>


<Routine name="%ZAPM.bs.BSCtemplate" type="MAC" languagemode="0"><![CDATA[
%BSCtemplate ; Портал B4I ; 14:50 12.01.2003
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 Q
OP1()
 N Q S Q="<option value='BegEnd'  >M; Начало и конец станицы портала</option>"
 S Q=Q_"<option value='OpenWIN'   >S; Начало и конец страницы для окна </option>"
 S Q=Q_"<option value='HIDDEN'    >S; Скрываемый(Раскрываемый) элемент DHTML</option>"
 S Q=Q_"<option value='Form'      >S; Form форма страницы портала</option>"
 S Q=Q_"<option value='aGet'      >F; Anchor...Get  //Anker c BSGET </option>"
 S Q=Q_"<option value='bGet'      >F; Button...Get  //Button c BSGET </option>"
 S Q=Q_"<option value='CHECKBOX'  >F; Вывести CHECKBOX</option>"
 S Q=Q_"<option value='select'       >M; Вывести Select</option>"
 S Q=Q_"<option value='FRAMES'       >M; FRAMES //FRAMESet</option>"
 S Q=Q_"<option value='Table3'       >S; Table //таблицу со стилями на 3 колонки</option>"
 S Q=Q_"<option value='aParam'       >M; Кнопка с параметрами и получить параметр с конструктором</option>"
 S Q=Q_"<option value='LocVar'    >S; Вывести переменные текущей сессии в Брузер в виде таблицы</option>"
 S Q=Q_"<option value='ctrl'      >F; Удалить управляющие символы</option>"
 S Q=Q_"<option value='bd'        >F; Имя массива БД %BS</option>"
 S Q=Q_"<option value='Data'      >F; Существование массива $$Data</option>"
 S Q=Q_"<option value='GetV'      >F; Cохранить, Возвратить данные в БД текущей сессии</option>"
 S Q=Q_"<option value='TR'     >S; Замена подстоки в строке $$TR^%ZAPM.bs.BSsFUNM</option>"
 S Q=Q_"<option value='TRA'    >S; Замена %'' в строке на ~| и обратно для URL</option>"
 S Q=Q_"<option value='TRE'    >F; Замена угловых скобок в строке на &lt для HTML</option>"
 S Q=Q_"<option value='WEB'    >M; создать переменные В4Y интерфейса</option>"
 S Q=Q_"<option value='SYSLOG' >M; Записать в %BS-системмный протокол</option>"
 S Q=Q_"<option value='info'   >M; Информация о %BS-Portale</option>"
 S Q=Q_"<option value='JSE'    >S; Добавить скобки JavaScript ... JSE</option>"
 S Q=Q_"<option value='ASN'    >F; Добавить имя сервера с именем библиотеки</option>"
 S Q=Q_"<option value='BSLOG'    >F; %BS-СИСТЕМНЫЙ ПРОТОКОЛ</option>"
 S Q=Q_"<option value='EXE'      >M; ЗАГРУЗКА ТЕРМИНАЛОВ,EXE ФАЙЛОВ,КОНВЕРТЕРА в EXCELL из-под ИП (пример Гранда)</option>"
 S Q=Q_"<option value='GUCI'     >F; ФУНКЦИЯ ПЕРЕХОДА В РАБОЧУЮ ОБЛАСТЬ</option>"
 S Q=Q_"<option value='TD'       >F; ДАТА \ ВРЕМЯ</option>"
 S Q=Q_"<option value='WOUT'     >M; Выгрузить в файл буфер локальных переменных</option>"
 S Q=Q_"<option value='bssyslog' >F; программа протоколирования действий пользователей BS</option>"
 S Q=Q_"<option value='TmpDir'   >F; Каталог для временных файлов</option>"
 S Q=Q_"<option value='open1'    >F; Открыть окно браузера</option>"
 S Q=Q_"<option value='CutS'     >S; Удалить начальные и коцевые пробелы</option>"
 S Q=Q_"<option value='VERBS'    >F; Версия bs-portala</option>"
 S Q=Q_"<option value='CHISLO'   >F; Число прописью</option>"
 S Q=Q_"<option value='KBD'      >F; Тригерное имя БД, или Глобала</option>"
 S Q=Q_"<option value='JF'       >S; JUSTIFY пробелы в конце</option>"
 S Q=Q_"<option value='UPLOAD'   >M; UPLOAD FILES TO SERVER</option>"
 S Q=Q_"<option value='File2Arr' >F; Читать Файл в массив и разбор массива по контексту</option>"
 Q Q
OP3()
 N Q S Q="<option value='USER' >M; Добавить\Удалить Прямого И терминального пользователя (Cache5.0.x)</option>"
 S Q=Q_"<option value='DNS' >F; Имя сервера и\или IP-адрес</option>"
 S Q=Q_"<option value='ODBC' >M; Получить список источников DNS ODBC (%BS SQL-менеджер)</option>"
 S Q=Q_"<option value='conv' >F; $ZCNVT() - конверировать в большие и маленькие буквы</option>"
 S Q=Q_"<option value='ini' >M; РАЗБОР ФАЙЛА .INI</option>"
 S Q=Q_"<option value='LIC' >M; Информация о Лицензии Cache'</option>"
 S Q=Q_"<option value='md5' >F; криптокодирование Blow Fish и MD5</option>"
 S Q=Q_"<option value='ExRou' >F; Существует ли программа</option>"
 S Q=Q_"<option value='DecomposeStatus' >F; Сообщение об ошибке</option>"
 S Q=Q_"<option value='REACT' >M; Реактивация конфигурации СУБД</option>"
 S Q=Q_"<option value='RESTART' >M; Рестарт СУБД</option>"
 Q Q
 //----------------------------------------------%bs МОДУЛИ
1(A,type1,RN,NS,PR,ST,US)
 //I $$CTRL^%ZAPM.bs.BSChT(ST)'=ST S ST="ControlSymbol???!!!"
 //I $$2LAT^%ZAPM.bs.BSCp(ST,1)'=ST S ST="CyrilicSymbol!!!"
 I ST="" S ST="ST"
 ;I $G(NewTop)'="" W $G(NewTop) Q 
 if A=1,(type1="select") {   
 w "  W ""<SELECT name=base1 onchange=""""open('""_$$ADDBSGET^%ZAPM.bs.BSC4(,""onchange^"_$P($TR(RN,"%","~"),".")_""")_""&Base2='+base1.value,'','toolbar=no,menubar=no,width=1,height=1');"""">""  D  W ""</SELECT>"" ",!
 w "  .N I W ""<OPTION value='' selected >--</OPTION>"" ",!
 }
 ;M; 
 if A=1,(type1="UPLOAD") {   
 w "  //UPLOAD FILE TO SERVER",!
 w " S BSS1=""""",!
 w " S BSS6=""FILE1^"_$P($TR(RN,"%","~"),".")_""" //ПРОГРАММА КОТОРАЯ ИСПОЛНЯЕТСЯ ПОСЛЕ ЗАГУЗКИ ФАЙЛА",!
 w " S BS1="""" ",!
 w " S BS2=""""  I $$SetVar^%ZAPM.bs.BSC4(""NSpace"",BSNSP) ",!
 w " S BSS3=BSSES,BS3=MGWLIB,BSS8=$$BSADDVAR^%ZAPM.bs.BSC4(),BSS4="""" ",!
 w " D UP^%ZAPM.bs.BSC4r3",!
 w " Q ",!
 w "FILE1 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS(""UPLOAD. Step 2""),$$B27^%ZAPM.bs.BSCGIS(1) ",!
 w " W RED_$G(FiNa)_EF_BBK //ИМЯ ФАЙЛА",!
 w " S NoCloseWin=1 //ФЛАГ НЕ ЗАКРЫВАТЬ ОКНА",!
 W " M Mas=@GL K @GL //МАССИВ В КОТОРОМ ЛЕЖИТ ЗАГРУЖЕННЫЙ ФАЙЛ",!
 W " //TO DO",!
 w " D END^%ZAPM.bs.BSC4",!
 }
 ;M; 
 if A=1,(type1="File2Arr") {   
 w " K fT1,fT2 D File2Arr^%ZAPM.bs.BSCEXE(FN,.fT1),STR2MAS^%ZAPM.bs.BSCmail(.fT1,.fT2,$C(13,10)) K fT1 S i="""" F  S i=$O(fT2(i)) Q:i=""""  I $G(fT2(i))'="""" //TODO",!
 }
 
 if A=1,(type1="JF") {   
 w " W ""$$JF^%ZAPM.bs.BSC4r4("_ST_",45)"" //ADD 45 SPACE TO END",!
 w " W ""$TR($J("""",9),"" "",""*"")"" //WRITE 9 *",!
 }
 
 if A=1,(type1="CHISLO") {   
 w " W ""$$sump^%ZAPM.bs.BSCp2("_ST_")"" //",!
 }
 
 if A=1,(type1="KBD") {   
 w " S GL=$$KBD^%ZAPM.bs.BSF12(""^PART(""""TAB"""")"") //TRIGGERED BD",!
 w " S GL=$$SW^%ZAPM.bs.BSF12(""^GLO"") //SWITHER GLOBAL, USE zBS4cfg=Currently configuration portal",!
 }
 
 if A=1,(type1="VERBS") {   
 w " W ""$$ver^%ZAPM.bs.BSC()""",!
 }
 
 if A=1,(type1="CutS") {   
 w " W ""$$CutS^%ZAPM.bs.BSF10("_ST_")""",!
 }
 
 if A=1,(type1="open1") {   
 w " W ""open(""""""_$$ADDBSGET^%ZAPM.bs.BSC4(,""Lab^"_$P($TR(RN,"%","~"),".")_""")_"""""",""""xxx"""",""""toolbar=no,menubar=no,scrollbars=no,width=500,height=200,status=1,resizable=1"""");""_BK",!
 }
 
 if A=1,(type1="bssyslog") {   
 w " D Tex^%ZAPM.bs.BSMSMF(""UpdateVersion"",V),SYSMSG^%ZAPM.bs.BSCek(""UpdateVersion ""_V,""W"")",!
 }
 
 if A=1,(type1="TmpDir") {   
 w " s T=$$CacheSysDir^%ZAPM.bs.BSCp(""\dev\"")",!
 }
 //
 if A=1,(type1="EXE") {
 w "KID //SAMPLE ^%ZAPM.bs.BSCprivOVV",!
  w " D BEG1^%ZAPM.bs.BSC4",!
 w " ; D locvar^%ZAPM.bs.BSCh0("""",1)",!
 
 w "  N HREF,TA,BSTOP,BSTOP2,BSLABELt",!
  w " S BSPGM=""KID"",BSLAB1=""KID3"" ",!
  w " W ""<HR><BUTTON onclick=""""open('""_$$ADDBSGET^%ZAPM.bs.BSC4(,""KID2^KID"")_""','','width=1,height=1');"""" title='Загрузить в терминале KID' VALUE='' ><IMG SRC='""_BSDOMAIN_""/img/term.gif'> КОМПЛЕКС КИД</BUTTON>""_BK",!
  w " W ""<HR><BUTTON onclick=""""open('""_$$ADDBSGET^%ZAPM.bs.BSC4(,""KID4^KID"")_""','','width=1,height=1');"""" title='Загрузить в терминале KID' VALUE='' ><IMG SRC='""_BSDOMAIN_""/img/term.gif'> КОМПЛЕКС КИД</BUTTON>""_BK",!
  w " D END^%ZAPM.bs.BSC4",!
  w " ;D Read^%ZAPM.bs.BSCG(""URO"",""SELECT * FROM FeniaNorm"",1,,""^mtemple"")",!
  w " ;W !,$G(^mtemle(0),""?"")",!
 w "  Q",!
 w "KID2 D RunProSess^%ZAPM.bs.BSC4rout(""TELNETP(""""KID"""",""""#"""",""""""_BSLAB1_""""^^""_BSPGM_"""""",""""--КИД--"""");"") Q",!
  w " Q",!
 w "KID3 ;ZW %BS",!
  w "   S BSR=""^Kmen"",BST=""M0"" D ^%ZAPM.bs.BST",!
 w "  Q   ",!
 w "KID4 ;D RunProSess^%ZAPM.bs.BSC4rout(""ExeRun2("""""""",""""ExT2E.exe"""",""""*fn:http://urovv2:1962/vv/struct/111.txt *c:1 *d:, *s:3""""); "",""ExeRun1"") Q",!
 w " D RunProSess^%ZAPM.bs.BSC4rout(""ExeRun2("""""""",""""ExT2E.exe"""",""""*fn:http://urovv2:1962/vv/struct/111.txt *c:0 *alls""""); "",""ExeRun1"") Q",!
 w " Q",! 
 }
 
 if A=1,(type1="JSE") {
 w " D JS^%ZAPM.bs.BSCp",!
 w " w ""var=parent.location;""_BK",!
 w " D JSE^%ZAPM.bs.BSCp",!
 }
 
 if A=1,(type1="TD") {
 w " W $$TD^%ZAPM.bs.BSC4base($H)",!
 }
 
 if A=1,(type1="WOUT") {
 w " I '$D(Fname) S Fname=""N:\123.TXT"" I $ZU(140,4,Fname)'=0 S OLDIO=$I O Fname:""UWN"" U Fname W ""-----"",! W  W ""-------"",! U OLDIO C Fname ",!
 w " //или w $$w2f^%ZAPM.bs.BSCp2(Fname)",!
 }
 
 if A=1,(type1="BSLOG") {
 w " D Tex^%ZAPM.bs.BSMSMF(""TEXT"",MODE)",!
 }
 
 if A=1,(type1="GUCI") {
 w " I $$ZU^%ZAPM.bs.BSF4(""FON"") //OK",!
 }
 
 if A=1,(type1="ASN") {
 w "$$ADDSN^%ZAPM.bs.BSC4()_$$ADDLIB^%ZAPM.bs.BSC4()",!
 }
 
 if A=1,(type1="CHECKBOX") {
 w " W ""<input type=checkbox name=SubMitPop value='' title='...'>""",!
 }
 
 if A=1,(type1="HIDDEN") {
 w " D STY^%ZAPM.bs.BSCm2(2),DIV^%ZAPM.bs.BSCm2(2,""TEXT"",""TEXT2222"")",!
 w " ",ST,!
 w " D DI^%ZAPM.bs.BSCm2",!
 }
 
 if A=1,(type1="LocVar") {
 W " D locvar^%ZAPM.bs.BSCh0("""_ST_""",1)",!
 }
 
 if A=1,(type1="OpenWIN") {
 W " D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS(""Step1 for NewTabel""),$$B27^%ZAPM.bs.BSCGIS(1)",!
    //W " "_ST_" //TODO",!
 W " D BACK^%ZAPM.bs.BSCh,END^%ZAPM.bs.BSC4",!
 }
 
 if A=1,(type1="Table3") {
 W " w ""<table border=0 width=100%>""",!
 W " w ""<tr><td class=s1 width=5%></td><td class=s1  width=75%><strong><strong></td><td class=s1 width=20%></td></tr>"",BK",!
    w " ",ST,!
 W " w ""</table>""",!
 }
 
 if A=1,(type1="FRAMES") {
 W " w ""<FRAMESET rows='0%,*'  framespacing=0 border=false frameborder=0 >""_BK",!
 W " w ""<FRAME SRC='/iss/RD/RunDos.htm' name='rd1' frameborder=0 >""_BK",! 
 w " S BSLABEL=""ROU^~BSCAsIs""",!
 W " w ""<FRAME SRC='""_$$ADDBSGET^%ZAPM.bs.BSC4_""' NAME='LIST' frameborder=0 >""_BK",!
    W " ",ST,!     
 W " w ""</FRAMESET>""",!
 Q
 }
 
 if A=1,(type1="BegEnd") {
	w " D BEG1^%ZAPM.bs.BSC4",!
	w " D BACK^%ZAPM.bs.BSCh,END^%ZAPM.bs.BSC4",!
 }
 
 if A=1,(type1="Form") {
 W " w ""<BODY>""",!
 W " w ""<form action=""""""_$$ADDLIB^%ZAPM.bs.BSC4()_"""""" method=""""POST"""">""",!
 w " S BSLABEL=""Form^"_$P($TR(RN,"%","~"),".")_"""",!
 w " D ADDBSPOST^%ZAPM.bs.BSC4reg",!
 w " ",ST,!
 W " w ""<input type=submit name=sDUB value='Copy' title='copy...'>""_BK",!
 W " w ""</form>""",!
 w " G BACK^%ZAPM.bs.BSCh ",!
 }
 
 if A=1,(type1="bGet") {
    w " w ""<BUTTON onclick='messages.DE.value=1; submit();' title='save currently setting' ><IMG SRC='""_BSDOMAIN_""/img/save.gif'>save</BUTTON>""_BK",!
    w " //OR"
    W " $$BUTTBS^%ZAPM.bs.BSCp2(ROU,GIF,FNAME,TIT,H,W) ",!
 }
 
 if A=1,(type1="aGet") { w " q ""<a href='""_$$ADDBSGET^%ZAPM.bs.BSC4(,""aGET^"_$P($TR(RN,"%","~"),".")_""")_""' target=new TITLE='""_dt_""'>""_t_""</a>""",!
 }
 
 if A=1,(type1="aParam") {
 w " s g=""^AsI.PAR.OPT""",!
 w " w $$BP^%ZAPM.bs.BSC4cfgP(""Main option"",""Main option2"",g,g,1)_$$Param3()",!
 w " w $$GETOPT^%ZAPM.bs.BSC4cfgP(g,""aTamplete"")_""<hr>""",!
 w "Param3() N pin,N S pin=$P(g,""."",1,2),N=$P(g,""."",3)",!
 w " Q "" Construction Options ""_$$PAframe^%ZAPM.bs.BSCm()",!
 }
 
 if A=1,(type1="TR") {
 W " A=$$TR^%ZAPM.bs.BSsFUNM("_ST_",REPL,TO)",!
 }
 
 if A=1,(type1="TRA") {
 W " S BSPART=$$%T^%ZAPM.bs.BSCh("_ST_") //%-->~",!
 W " S BSTABL=$$%^%ZAPM.bs.BSCh(BSTABL) //~-->%",!
 }
 
 if A=1,(type1="TRE") {
 W " W $$TRa^%ZAPM.bs.BSCh0($ZE)",!
 }
 
 if A=1,(type1="info") {
 W " d InfoSess^%ZAPM.bs.BSC4rout",!  
 }
 
 if A=1,(type1="WEB") {
 W " I '$D(GREEN) D VAR^%ZAPM.bs.BSCh  ",!  
 }
 
 if A=1,(type1="ctrl") { W "$$CTRL^%ZAPM.bs.BSChT("_ST_")"
 }
 
 if A=1,(type1="bd") {
 w " S BD=$$KBD^%ZAPM.bs.BSF12(""^%ZAPM.bs.BSC4(""""PROTECT"""")"")",!
 }
 
 if A=1,(type1="Data") {
 W " I $$Data^%ZAPM.bs.BSF12(G)",! 
 }
 
 if A=1,(type1="GetV") {
 W " S BSMODE=$$GetVar^%ZAPM.bs.BSC4(""STR_MODE"")",! 
 W " S A=$$SetVar^%ZAPM.bs.BSC4(""STR_MODE"",BSMODE)",!
 }
 
 //------------------------------------------------------------... ФУНКЦИИ
 if A=3,(type1="USER") {
 W " D RegSave^%ZAPM.bs.BSCm2 //SAVE",!
 }
 
 //	Error Message
 if A=3,(type1="DecomposeStatus") {
 W " Do DecomposeStatus^%apiOBJ(status,.err,""-d"")  ",!  
 }
 
 ;	Reactivation
 if A=3,(type1="REACT") {
  W " D cpf^%ZAPM.bs.BSCm2 ",!  
 }
 
 ;	Restarted
 if A=3,(type1="RESTART") {
 W " D RESTART^%ZAPM.bs.BSCm2  ",!  
 }
 
 if A=3,(type1="ODBC") {
  W " N LD,svc,I D DSNLIST1^%ZAPM.bs.BSCGH S I="""" F  S I=$O(LD(I)) Q:I=""""  ",!  
 }
 
 if A=3,(type1="DNS") {
  w "$$ipS^%ZAPM.bs.BSCp2 //W "" S IP1=$P($ZU(54,13,NAME1),"","")   S NAME2=$P($zu(54,14,$zu(54,1,IP2)),"","",2) ",!  
 }
 
 if A=3,(type1="conv") {
 W " s a=$ZCONVERT(a,""U"")),b=$ZCONVERT(b ,""L"")   ",!  
 }
 
 if A=3,(type1="SYSLOG") {
 W " D Tex^%ZAPM.bs.BSMSMF(""OpenSess"",$G(U)_"",""_$G(BSR)_"",""_$G(BST)_"",""_$G(EDIT)_"",""_$G(MODE)_"",""_$G(BSLOGIN)_"",""_$G(BSSES))",!  
 }
 
 if A=3,(type1="ini") {
 W " d INI^%ZAPM.bs.BSCindx(FNINI,.MS) //N O D parseCfg^%DMCONFIG(FNINI,.O) //Sample parse file .INI  ",!  
 }
 
 if A=3,(type1="LIC") {
 W " d $SYSTEM.License.CKEY()",!  
 }
 
 if A=3,(type1="md5") {
 W " d TestString^%ZAPM.bs.BSCBlowfish(""TEST"")",!  
 }
 
 if A=3,(type1="ExRou") {
 W " I '$$EXIST^%R(""%GKDOC.INT"") Q  //No exist",!  
 }
 
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCtemplate2" type="MAC" languagemode="0"><![CDATA[
%BSCtemplate2 ; Портал B4I ; 14:50 12.01.2003
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 Q
rou(ns,rou) i $g(ns)'="" ZN ns
 D 1(rou) 
 Q
ROU(ns,rou,RN) ;ПОДГОТОВКА ПУНКТОВ ПРИМЕРОВ
 I '$D(GREEN) D VAR^%ZAPM.bs.BSCh  D Gen^%ZAPM.bs.BSCtemplate3($g(RN))
 N S,L,I,i,ii,X 
 w "<hr>" d BSDOC w "<hr>" D rou($g(ns),$g(rou))
 w "<h3>Примеры из программы : "_BLUE_$g(rou,"%BSCtemplate2")_EF_" Рабочей области : "_RED_$g(ns,"%SYS")_EF_"</H3>"
 S I="" F  S I=$O(X(2,I)) Q:I=""  S L=X(2,I) D
 .I L[";;" W "<HR>"_MAROON_$P(L,";;",2)_EF_"<HR>" Q
 .W "<LI><INPUT NAME='NewTop' TYPE=Submit TITLE='"_$ZCVT($$RES(L),"O","HTML")_"' VALUE='"_L_"'>"_L(L) 
 Q ""
1(R) i $g(R)="" k R
 X "ZL "_$G(R,"%BSCtemplate2")_" F I=1:1 S S(I)=$T(+I) Q:S(I)="""" "
 F i=1:1:I-1 D
 .I S(i)[";;" S L=$P(S(i)," ;;") S:L="" X(2,i)=S(i) I L'[" ",L'="" S L(L)=$P(S(i)," ;;",2,99) D
 ..F ii=i+2:1 q:S(ii)["*///"!(S(ii)[";>>;")  S L(L,ii)=S(ii)
 ..S X(2,i)=L,i=ii,X(1,L)=$S(S(ii)[";>>;":1,1:0)
 Q
RES(A) N Q S Q="",i="" F  S i=$O(L(A,i)) Q:i=""  S Q=Q_L(A,i)_$C(13,10)
 Q Q
Result(R,RN,NS,PR,ST,US,ns,rou,Clname,ModeSel,fn,proF) N S,L,I,i,ii,X //ВЫВОД ПРИМЕРОВ В ПРОРАММУ
 i R="Генерить!" d rn^%ZAPM.bs.BSCtemplate3(Clname,ModeSel,proF) q  //генерация класса редактирования по его свойствам
 i R="Генерить из CSV" d fn^%ZAPM.bs.BSCtemplate3(fn) q  //генерация класса из текстового файла
 D rou($g(ns),$g(rou)) I 'X(1,R) W $$RES(R)
 E  S i="" F  S i=$O(L(R,i)) Q:i=""  X $P(L(R,i),$C(13,10))
 Q 
Result2(R,RN,NS,PR,ST,US,ns,rou,fn) N S,L,I,i,ii,X
 i R="Генерить" d fn^%ZAPM.bs.BSCtemplate3(fn) q  //генерация класса из текстового файла
 q
BSDOC D VAR^%ZAPM.bs.BSCh S %("HOST:")=1,HTT="http://"_$$ipS^%ZAPM.bs.BSCp2_":1962"_$$ADDBSGET^%ZAPM.bs.BSC4(,"BSDOC^~BSC4r3")
 W "<A TITLE='Зарузить в новом окне документаию по порталу' Href='"_HTT_"'>Документация по порталу B4Y</A>"
 Q
 ///////////////////////////////////////////////////ПОКА НЕ ВСТАВЛЯТЬ КИРИЛИЦУ В ТЕКСТ ПРИМЕРОВ!!!///////////////////////////////////////
 ;;Слова и заготовки
FOR ;;M; Классическое начало FOR
 /*
  S i="" F  S i=$O(@a@(i)) Q:i=""
 *///
 Q  
Kz ;;M; Ловушка через глобал
 /*
  k ^%z m ^%z=M
 *///
 Q  
LOCAL ;;M; Посмотреть все локальные переменные
 /*
   D l^%ZAPM.bs.BSCp2
 *///
 Q  
NewClass ;;M; Заготовка под новый класс
 /*
/// имя параметра;1;f;;160
Property NameOpt As %String [ Required ];
 
/// описание параметра;2;f;
Property DescOpt As %String(MAXLEN = 1000);
 
/// значение параметра;2;f;
Property ValOpt As %String(MAXLEN = 1000);
 
Index NameOptIndex On NameOpt [ Unique ];
 *///
 Q  
ANY ;;M; Приглашение ввести любую клавишу
 /*
 D ANY^%ZAPM.bs.BSC4r4
 *///
 Q  
align ;;W; Слово - Выравнивание
 /*
  align
 *///
 Q
width ;;W; Слово - Длина
 /*
  width
 *///
 Q
height ;;W; Слово - Высота
 /*
  height
 *///
 Q
 //////////////////////////////////////////////////////
Write2File ;;F; вывести все локальные переменные в файл
 /*
 $$w2f(Fname)
 *///
 q
 ;;Функции
ZV ;;F; Номер версии Каши
 /*
 $$ZV^%ZAPM.bs.BSCp
 *///
 q
CbaseNS ;;F; Перейти в базовую рабочую область конфигурации
 /*
 $$CbaseNS^%ZAPM.bs.BSCp
 *///
 q
BDSES ;;F; Обращение к бд СЕССИИ и запись в неё данных
 /*
 k @BDSES@(BSSES,"VAR","CheckDocs")
 *///
 q
TRansLIT ;;F; транслитерация  (кирилицу переводим в латиницу)
 /*
 $$2LAT^%ZAPM.bs.BSCp(S,N)
 *///
 q
 
base64 ;;F; Обратимая функция Base64
 /*
 $$b64e^%ZAPM.bs.BSCp2(s)
 *///
 q
GetOpt ;;Sv; Функция получения значения параметра АРМ
 /*
 $$GetOpt^%ZAPM.bs.BSCtree(Packet,.sc,NameOpt) 
 *///
 q
SetOpt ;;Sv; Функция присвоения значения параметра АРМ
 /*
 $$SetOpt^%ZAPM.bs.BSCtree(Packet,.sc,NameOpt) 
 *///
 q
 
GetASUOpt ;;Sv; Функция получения значения параметра ИП и пользователя, если они совпадают  
 /*
 $$GetASUOpt^%ZAPM.bs.BSCtree("A2fileMaxSize",BSLOGIN)
 *///
 q
GetVal ;;Sv; Функция получения значения параметра для узла дерева  
 /*
 $$GetValTree^%ZAPM.bs.BSCtree(ValNODe,NameVal)
 *///
 q
SetVal ;;Sv; Функция изменения значения параметра для узла дерева  
 /*
 $$SetValTree^%ZAPM.bs.BSCtree(ValNODe,NameVal,NewVal)
 *///
 q
GetSQL ;;Sv; Функция выполнения SQL запроса
 /*
 s r=$$GetSQL^%ZAPM.bs.BSCtree("select AnsKod, AnsMess from ASUNACm.Answer where AnswerUser='"_user_"' and LogID='"_BSoSel_"'",кол-во колонок2,.R,"ASU") //r=количество найденных строк
 *///
 q
GetField ;;Sv; Функция получения значения поля из записи таблицы  
 /*
 $$GetF^%ZAPM.bs.BSCtree(T,F1,D1,F,ns) //возвратить значение поля F для первой найденной записи из таблицы T при условии F1=D1
 //например :$$GetF^%ZAPM.bs.BSCtree("ASUEHGm","NameOpt","NarXlsTemplate","ValOpt","ASU")
 ;$$GetOpt^%ZAPM.bs.BSCtree(Packet,status,NameOpt) //функция, специально для получения значений опции для ИП
 ;$$SetOpt^%ZAPM.bs.BSCtree(Packet,status,NameOpt,ValOpt) //функция, специально для присвоения значения опции для ИП
 *///
 q
 
GetA ;;Sv; Функция получения прав доступа на элемент доступа 
 ;>;
 w " S BSac=$$GetA^%ZAPM.bs.BSCtree($$GetValTree^%ZAPM.bs.BSCtree("_ST_",""B1""))",!
 ;>>;
 q
ZCVRT ;;Ss; Функция конвертирования тегов HTML в специальные коды
 ;>;
 W " S str=$ZCVT("""_ST_""",""O"",""HTML"")",!
 ;>>;
 Q 
norm ;;F; Добавить ведущие нули в число S. N=количество знаков
 /*
 s $$NORM^%ZAPM.bs.BSCrr(S,N)
 *///
 q
RESALL ;;Sv; Восстановить все переменные %session, %request
 /*
 w $$RESTALL^%ZAPM.bs.BSCp2("s")_"<hr>"_$$RESTALL^%ZAPM.bs.BSCp2()
 *///
 q
 ////////////////////////////////////////////////////
 ;;Модули
innerHTML ;;M; Управление динамическими html портала
  /*
 D JS^%ZAPM.bs.BSCp
  W " parent.parent.logo.Ugol.innerHTML='...';",!
  W " parent.parent.L1.BodyL1.innerHTML='...';",!
 D JSE^%ZAPM.bs.BSCp
 *///
ComboBoxEdit ;;M; Пример применения редактируемого ComboBox
  /*
 D BEG1^%ZAPM.bs.BSC4
 w "<head>"
 d PreCBE^%ZAPM.bs.BSCp2("http://"_$$ADDSN^%ZAPM.bs.BSC4()_"/b4y/js/cb-edit/")
 w "</head><body>"
 w "<input type=text name=myText value='Norway' selectBoxOptions='Canada~Denmark~Finland~Mexico~Nor way~United States'>"_BK
 w "<input type=text name=myText2 value='' selectBoxOptions='Amy;Andrew'>"_BK
 D JS^%ZAPM.bs.BSCp
 w "createEditableSelect(document.getElementById('myText'));"_BK
 w "document.getElementById('myText2').selectBoxOptions='ZZZZZ~QQQQ~EEE             E       E    EEEEEE';"_BK
 w "createEditableSelect(document.getElementById('myText2'));"_BK
 D JSE^%ZAPM.bs.BSCp
 D END^%ZAPM.bs.BSC4
 *///
 q
IMG ;;M; Картинка портала
  /*
  W "<img border=0 src='"_BSDOMAIN_"/img/person.gif' ALT='Insert...'>"
 *///
IFRAME ;;M; Пример строки URL для B4Y портала и  IFRAME
 /*
 w "<IFRAME HEIGHT='98%' width='98%' SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"stub^~BSCrep")_"' name='RECEIVE' SCROLLING='auto'></IFRAME><BR>"
 *///
 Q
TREE ;;M; Универсальный модуль организации редактирования массива как дерева
 /*
 D BEG1^%ZAPM.bs.BSC4
 D TreeStyle^%ZAPM.bs.BSCtree("Create^%ZAPM.bs.BSCtree",GLO,"LClick^BSissJ","IDISS")
 D CMenuJS^%ZAPM.bs.BSCtree("PClick^~BSCtree","FRAMETREE","TREE^BSissJ") 
 d Context^%ZAPM.bs.BSCtree("EDITGLO^%ZAPM.bs.BSCtree")
 D END^%ZAPM.bs.BSC4
 Q  
 *///
Table2 ;;M; Обрамление элементов в таблицу (2 колонки) со текущими стилями
 /*
 D TABL^%ZAPM.bs.BSCp
 D TR21^%ZAPM.bs.BSCp
 D TR22^%ZAPM.bs.BSCp 
 D TR23^%ZAPM.bs.BSCp
 D TRHR
 D TABLE^%ZAPM.bs.BSCp
 Q
TRHR W "<tr><td></td><td></td></tr>" Q 
 *///
WorkTel ;;M; ЗАГРУЗИТЬ ТЕРМИНАЛ
 /*
 ;%SYS"",""@"",""InfoSessi^^%ZAPM.bs.BSC4rout("_BSSES_")"",""Sessions""   - ЗАПУСК ПРОГРАММЫ ИЗ НС %SYS
 ;"1","$","$","Terminal"  										  - ЗАПУСК ПОЛНОГО ТЕРМИНАЛА
 ;""GLAVK"",""%BSJPRN"",""DPP"",""Устройства вывода""			  - ЗАПУСК ТАБЛИЦЫ
 ;"""_N_""",""$"",""$"",""Namespace_"_N_"""						  - ЗАПУСК ТЕРМИНАЛА ИЗ НС 
 d WorkTel^%ZAPM.bs.BSCp2(NS,PART,TABL,TITLE)
 *///
 
DirClientIPff ;;F; получение директории установки ClientIP - клиента ИнфоПортала
 /*
 =$$DirClientIPff(BSSES) //получение директории установки ClientIP - клиента ИнфоПортала
 *///
CacheSysDir ;;F;  получение директории установки Cache'
 /*
 $$CacheSysDir^%ZAPM.bs.BSCp("\Cache.cpf")
 *///
WorkRun ;;M; ЗАГРУЗИТЬ EXE программу
 /*
 d WorkRun^%ZAPM.bs.BSCp2("notepad.exe",$$CacheSysDir^%ZAPM.bs.BSCp("\Cache.cpf"),$$CacheSysDir^%ZAPM.bs.BSCp(""))
 *///
GetIpUrl ;;F; возвратить ссылку для закачки файла из инфотеки с сервера IP
 /* 
 s url=$$GetIpUrl^%ZAPM.bs.BSCp(gl)
 */// 
CspUrl ;;F; Правильно сформированный URL csp страницы с вызовом через IP адрес
 /*
 s url="http://"_$$ipS^%ZAPM.bs.BSCp2_":"_$$WebPort^%ZAPM.bs.BSCp2_"/"_Csp_"?"_$$addb^%ZAPM.bs.BSC4()
 *///
HttpUrl ;;F; Правильно сформированный URL с именем сервера ИП
 /*
 s url="http://"_$$ADDSN^%ZAPM.bs.BSC4()_$$ADDLIB^%ZAPM.bs.BSC4()
 *///
LoadExcel ;;M; Загрузка шаблона Excel и манипуляция с ним
 /*
  d LE^%ZAPM.bs.BSCp("1-видим шаблон сразу",$ZU(110)_":"_$$WebPort^%ZAPM.bs.BSCp2_"/csp/asu/html/asurp/docum/arm/24/xls/шаблон_наряда.xls","^mas",R,C,rou)
 *///
RecompileZen ;;M; Рекомпиляция всего пакета %ZEN
 /*
  Do $system.OBJ.CompilePackage("%ZEN") 
 *///
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCtemplate3" type="MAC" languagemode="0"><![CDATA[
%BSCtemplate3 ; Портал B4I ; 14:50 12.01.2003
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 Q
Gen(rn)
 i rn="" q
 i $zconvert($p(rn,".",$l(rn,".")),"L")'="cls" q
 w "<hr> " s clna=$p(rn,".",1,$l(rn,".")-1) i $e(clna,$l(clna))?1n s prof=$e(clna,$l(clna))
 w "<INPUT NAME='NewTop' TYPE=Submit TITLE='Генерить страницу для экземплятов класса ' VALUE='Генерить!'>"
 W "<input type=text name=Clname value='"_$p(clna,"Edit")_"' title='введите имя класса без расширения :NamePacket.NameClass для которого будем генерить пользовательский интерфейс' size=50>"
 W "<input type=text name='Profile3' value='"_$g(prof)_"' title='введите номер профиля (шестое поле по ; в коментариях полей класса' size=2>"
 w "<select name='ModeSel' >"
 w "<option value='1'>Режим редактирования с фильтрами на колонки</option>",!
 w "<option value='2'>Режим редактирования без фильтра, но с параметром</option>",!
 w "<option value='3'>Режим просмотра</option>",!
 w "</select>",!
 w "<hr>"
 w "<INPUT NAME='NewDef' TYPE=Submit TITLE='Генерить описание класса из CSV файла' VALUE='Генерить из CSV'>"
 W "<input type=file name=Cfile value='"_$p(rn,".",1,$l(rn,".")-1)_"' title='введите имя файла'>"
 q
fn(fn) ;генерация класса из текстового файла
 n ccn,m,i,ii,da
 s ccn=$p(RN,".",1,$l(RN,".")-1)
 w "///  Это описание класса автоматически сгенерено из файл "_fn,!
 w " Class "_ccn_" Extends %Persistent",!
 w "{",!!
 n fT1,fT2 D File2Arr^%ZAPM.bs.BSCEXE(fn,.fT1),STR2MAS^%ZAPM.bs.BSCmail(.fT1,.fT2,$C(13,10)) K fT1
 S i="" F  S i=$O(fT2(i)) Q:i=""  I $G(fT2(i))'="" s m=$G(fT2(i)) q
 F i=1:1 q:$p(m,",",i,i+1)=""  S ii=$tr($p(m,",",i),$c(34)) d
 .w !," /// "_ii_";"_i_";1;"_$s(ii["DATE":"date",1:"")_";" i ii["DATE" s da(i)=""
 .w !,"Property "_$tr(ii,"_","p")_" As %String(MAXLEN = 1000);",!
 
 w !!,"/// Импорт данных из текстового файла "_fn
 w !,"/// W ##CLASS("_ccn_").Import("""")"
 w !,"ClassMethod Import(fn as %String) As %String"
 w !,"{"
 w !," if $g(fn)="""" s fn="""_fn_""""
 w !," s sc=##class("_ccn_").%KillExtent()"
 w !," i 'sc w sc q"
 w !," D File2Arr^%ZAPM.bs.BSCEXE(fn,.fT1),STR2MAS^%ZAPM.bs.BSCmail(.fT1,.fT2,$C(13,10)) K fT1 s S1=$$s1^%ZAPM.bs.BSre(0),S2=$$s2^%ZAPM.bs.BSre(0)"
 w !," S i="""" F i2=1:1 S i=$O(fT2(i)) Q:i=""""  I i2>1 s m=$G(fT2(i)) d  w i2_"" "" "
 w !," .s ii="""" F i1=1:1 q:$p(m,""@"",i1,i1+1)=""""  s da=$tr($p(m,""@"",i1),S1,S2) d  S ii=ii_da_"","" "
 S i="" F  S i=$O(da(i)) Q:i=""  w !," ..i i1="_i_" s da=$c(34)_$tr($p(da,""."",3),$c(34))_""-""_$p(da,""."",2)_""-""_$tr($p(da,""."",1),$c(34))_$c(34)" 
 w !," ..s da=$c(34)_$tr($e(da,2,$l(da)-1),$c(34),""`"")_$c(34)" 
 w !," .s ii=$e(ii,1,$l(ii)-1)"
 w !," .x ""i ##class("_ccn_"Edit).Add(""_ii_"")"" "
 w !," q 1"
 w !,"}",!
 g GenEnd 
 
rn(cn,Mode,proFile) ;генерация класса редактирования по его свойствам
 n pr,i,ccn
 s ccn=$p(RN,".",1,$l(RN,".")-1)
 d lp^%ZAPM.bs.BSCp2(cn,.pr)
 i $O(pr(""))=""  w "Нет свойств!" q
 w "///Эта %Zen страница предназначена для редактирования класса :"_cn_" на основе",!
 w "/// класса Template.TableEditor                                        (c) D.Krytenev",!
 w "///Она автоматически сгенерена программой %BSCtemiate3 шаблона BsLIB   (c) S.Mikhaylenko",!
 w !
 w "///коментарии у класса "_cn_" используются следующим образом:",!
  w "/// ////Текст коментария;K;O",!
  w "///Текст коментария применяем как заголовок таблицы",!
  w "///K - кол-во строк выводимых на страницу",!
  w "///O - имя поля по которому упорядочиваем строки",!
 w !
 w "///коментарии у свойств класса "_cn_" используются следующим образом:",!
 w "/// ////Текст коментария;x;f;date;w;(1,2,7)",!
 w "///    1   Текст коментария - заголовок колонки и коментарий в поле редактирования",!
 w "///    2   x - код сортировки поля при формирования таблицы просмотра",!
 w "///    3   f - нужен ли фильтр для этого поля",!
 w "///    4   date - свойство имеет тип %String, но там лежит дата в формате ГГГГММДД",!
 w "///    5   w - значение параметра width при формировании панели навигации",!
 w "///    6   ("_proF_") - номера профилей по которым программа будет включать это поле при формировании панели навигации. Если пусто, то включается во все профили",!
 w "///",!
 w " Class "_ccn_" Extends Template.TableEditor",!
 w "{",!!
 
 w "///Параметр - заголовок таблицы",!
 w "Parameter PAGENAME = """_$p(pr,";",1)_""";",!!
 
 w "/// Свойство - заоловок таблицы",!
 w "Property PageTitle As %ZEN.Datatype.string [ InitialExpression = {..#PAGENAME} ];",!!
 
 w "/// Свойство - панель таблицы",!
 w "Property TablePaneId As %ZEN.Datatype.string [ InitialExpression = ""table"", ReadOnly ];",!!
 
 i Mode=2 {
 w " /// cgi-переменная CgiPar2 - должна быть в URL",!
 w "Property CgiPar1 As %String(ZENEXPRESSION = 1, ZENURL = ""CgiPar2"") [ InitialExpression = ""table"" ];",!!
 }
 
 s PageSise=$p(pr,";",2) //количество строк в странице
 i PageSise="" s PageSise=5
 
 w " /// переопределение таблицы",!
 w "XData tablePane [ XMLNamespace = ""http://www.intersystems.com/zen"" ]",!
 w "{",!
 w "<pane xmlns=""http://www.intersystems.com/zen"">",!
 w "<tablePane id=""table""",!
 
  //упорядочивание по умолчанию
 s order="" i $p(pr,";",3)'="" s order=" orderByClause="""_$p(pr,";",3)_""" "
 	 
 	 w "onupdate=""zenPage.getTableHeight()"" ",!
 i Mode=3 {
	 w "bodyHeight=""100%"" ",!
	 w "autoExecute=""true"" ",!
	 w "width=""100%"" ",!
	 w order,!
	 w "useSnapshot=""true"" ",!
	 w "maxRows="""" ",!
	 w "pageSize="""_PageSise_""" ",!
	 w "tableName="""_cn_""" ",!
	 w "valueColumn=""ID"" ",!
	 w "showQuery=""false"" ",!
	 w "showZebra=""true"" ",!
	 w "useKeys=""false"" ",!
	 w "fixedHeaders=""true"" ",!
	 w "headerLayout=""headersOnTop"" ",!
	 w "nowrap=""false"" ",!
 
  }
  i Mode'=3 {  i Mode=2 s sq="sql=""select Id As ID" d
 	.S i="" F  S i=$O(pr(i)) Q:i=""   s sq=sq_","_pr(i) 
 	.s sq=sq_" from "_cn_" where CgiPar1 = ?"" " w sq,!
 	i Mode=1 w "tableName="""_cn_""" ",!
 	w "dataSource=""columns"" ",!
	 w order,!
 	w "valueColumn=""ID"" ",!
 	w "showRowNumbers=""0""",!
 	w "showRowSelector=""0""",!
 	w "useSnapshot=""true""",!
 	w "nowrap=""false""",!
 	w "maxRows="""" ",!
 	w "fixedHeaders=""true"" ",!
 	w "autoExecute=""true"" ",!
 	w "pageSize="""_PageSise_""" ",!
 	w "onselectrow=""zenPage.rowSelected();"" ",!
  }
 
 w ">",!
 w "<column colName=""ID"" hidden=""true""/>",!
 S i="" F  S i=$O(pr(i)) Q:i=""  i $g(pr(i,"prof"))[proFile w "<column colName="""_pr(i)_""" cellTitle="""_pr(i)_""" " d  w " header="""_$g(pr(i,"desc"),"?"_pr(i))_"""/>",!
 .i $g(pr(i,"w"))'="" w "width="""_pr(i,"w")_""""
 .i "13"[Mode,$g(pr(i,"filt"))'="" d
 ..s ii="контекст" i pr(i,"type")="%Date"!($g(pr(i,"spec"))="date") w " filterType=""date"" " s ii="дату"
 ..e  w " filterType=""text"" "
 ..w " filterTitle=""введите "_ii_" фильтра"" "
 i Mode=2 w "<parameter id=""p1"" value=""#(%page.CgiPar1)#"" />",!
 w "</tablePane>",!
 w "<tableNavigator tablePaneId=""table""/>",!
 w "</pane>",!
 w "}",!
 
 
 
 
 w "/// переопределение формы редактирования полей",!
 w "XData formPane [ XMLNamespace = ""http://www.intersystems.com/zen"" ]",!
 w "{",!
 w "<pane xmlns=""http://www.intersystems.com/zen"">",!
  i Mode=3 g Gen2
 w "<!--<vgroup >-->",!
  S i="" F  S i=$O(pr(i)) Q:i=""  i $g(pr(i,"prof"))[proFile  d
 .i pr(i,"type")="%Date"!($g(pr(i,"spec"))="date") w "<dateText id="""_pr(i)_""" label="""_$g(pr(i,"desc"),"?"_pr(i))_""" size=""10"" />",! q
 .w "<text id="""_pr(i)_""" label="""_$g(pr(i,"desc"),"?"_pr(i))_""" size=""140"" />",! q
 w "<!--</vgroup>-->",!
Gen2 w "</pane>",!
 w "}",!
  i Mode=3 d ModeView g GenEnd
  
  
  
 w "/// заполнение полей формы редактирования записи  - должно быть переопределено в подклассах",!
 w "/// Id - ид объекта",!
 w "/// Form - форма редактирования полей",!
 w "ClassMethod openObject(Id, Form As %ZEN.Component.form) As %Status [ ZenMethod ]",!
 w "{",!
 w "	s cur = ##class("_cn_").%OpenId(Id)",!
 S i="" F  S i=$O(pr(i)) Q:i=""  i $g(pr(i,"prof"))[proFile  d
 .i pr(i,"type")="%Date" w "	d Form.%page.%SetValueById("""_pr(i)_""",$zdt(cur."_pr(i)_",3))",! q
 .w "	d Form.%page.%SetValueById("""_pr(i)_""",cur."_pr(i)_")",!
 w "	q $$$OK",!
 w "}",!
 
 
 
 
 w "/// добавление/редактирование записи(сервер) - должно быть переопределено в подклассах",!
 w "ClassMethod addRowS(Id = 0, Form As %ZEN.Component.form) As %String [ ZenMethod ]",!
 w "{",!
 w "	i 'Id s cur = ##class("_cn_").%New()",!
 w "	else  s cur = ##class("_cn_").%OpenId(Id)",!
 w "	 //запись		",!
 w "	//	s cur.XXX = Form.%page.CgiPar1",!
 S i="" F  S i=$O(pr(i)) Q:i=""  i $g(pr(i,"prof"))[proFile  d
 .I pr(i,"type")="%Date" w "		s cur."_pr(i)_" = $zdh(Form.%page.%GetValueById("""_pr(i)_"""),3)",! q
 .w "		s cur."_pr(i)_" = Form.%page.%GetValueById("""_pr(i)_""")",!
 w "		s sc = cur.%Save()",!
	w !	
 w "	i 'sc ",!
 w "	{ ",!
 w "		s mes = $System.Status.GetErrorText(sc)",!
 w "			&js<alert('#(""Ошибка занесения информации! :""_$zcvt(mes,""O"",""JS""))#');>",!
 w "		s Id = 0",!
 w "	} ",!
 w "	else ",!
 w "	{",!
 w "		s Id = cur.%Id()",!
 w "	}",!
 w "	q Id",!
 w "}",!
 w !
 w "/// удаление записи(сервер) - должно быть переопределено в подклассах",!
 w "ClassMethod delRowS(Id) As %Boolean [ ZenMethod ]",!
 w "{",!
 w "	s sc = ##class("_cn_").%DeleteId(Id)",!
 w "	i 'sc ",!
 w "	{ ",!
 w "   			s mes = $tr($System.Status.GetErrorText(sc),""'"",""`"")",!
 w " 			&js<alert('#(""Ошибка занесения информации! :""_$zcvt(mes,""O"",""JS""))#');>",!
 w " 			q 0",!
 w " 	}",!
 w "	q 1",!
 w "}",!!
 //
 w "///В этом методе присваиваем значения по умолчанию",!
 w "Method %OnAfterCreatePage() As %Status",!
 w "{",!
 S i="" F  S i=$O(pr(i)) Q:i=""  i $g(pr(i,"prof"))[proFile  d
 .w "	d ..%SetValueById("""_pr(i)_""","""")",!
 w "	Quit $$$OK",!
 w "}",!!
 //
 
   d Add(""),Add("RecId") 
 
 //
 
 w "/// показать статус или ошибку",!
 w "ClassMethod ShowStatus(s As %String, sc As %String) As %String",!
 w "{",! 
 w " W s,+sc,! ",!
 w " I $$$ISERR(sc) D",!
 w " .D DecomposeStatus^%apiOBJ(sc,.err)",!
 w " .F i=1:1:err W err(i),!",!
 w " Q sc",!
 w "}",!
GenEnd 
 ;w "///Это конец, а где же пистолет? (c) M.Shtirlich",!
 w "}",!!!
 q
Add(m)
 w " /// Добавить запись в базу данных"  i m'="" w " и возвратить новый ID в переменной newId"
 w ".",!
 w " ///Пример > w ##class("_ccn_").Add"_m_"(" i m'="" w ".newId,"
 s sq=""
 S i="" F  S i=$O(pr(i)) Q:i=""   d  s sq=sq_","
 .i pr(i,"type")="%Date" s sq=sq_"+$h" q
 .s sq=sq_""""_pr(i)_"2""" 
 s sq=$e(sq,1,$l(sq)-1) w sq_")",!
 
 s sq="ClassMethod Add"_m_"(" i m'="" s sq=sq_"newID As %String,"
 S i="" F  S i=$O(pr(i)) Q:i=""   d  s sq=sq_","
 .s sq=sq_pr(i)_" As "
 .i pr(i,"type")="%Date" s sq=sq_"%Date"
 .e  s sq=sq_"%String = """" "
 s sq=$e(sq,1,$l(sq)-1)
 w sq_") As %String",!
 w "{",!
 w " S o=##class("_cn_").%New()",!
 S i="" F  S i=$O(pr(i)) Q:i=""   d 
 .w " s o."_pr(i)_"="_pr(i),!
 w " S sc=o.%Save()",!
 i m'="" w " s newID=o.%Id()",!
 w " i sc'=1 d ..ShowStatus(""Ошибка :"",sc)",!
 w " D o.%Close()",!
 w " q sc",!
 w "}",!
 
 q
ModeView 
 w " /// This Style block contains page-specific CSS style definitions.",!
 w "XData Style",!
 w "{",!
 w "<style type='text/css'>",!
 
 w "<!-- стиль для таблицы, цепляется по ид компонента -->",!
 w "#table {",!
 w "	height: 100%;",!
 w "	width: 900px;",!
 w "	overflow: auto;",!
 w "	border: 1px solid darkblue;",!
 w "}",!
 w "</style>",!
 w "}",!
 
 w "XData mainPane [ XMLNamespace = ""http://www.intersystems.com/zen"" ]",!
 w "{",!
 w "<pane xmlns=""http://www.intersystems.com/zen"">",!
 
 w "<vgroup width=""100%"" height=""100%"">",!
 w "<pane paneName=""tablePane"" width=""100%""/>",!
 w "</vgroup>",!
 
 w "</pane>",!
 w "}",!
 
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSCtree" type="MAC" languagemode="0"><![CDATA[
%BSCtree ; пpогpамма работы с деревом
 ;
 ;    Copyright Serge W. Mikhaylenko
 ;    All Rights Reserved
 ;
 Q
TreeStyle(LAB,GLO,ROU,frn,ico,open) //ВЫВЕСТИ СТИЛИ
  //LAB - программа формирования дерева
  //GLO - массив который будем редактировать
  //ROU - программа вызываемая по левому клику
  //frn - имя фрэйма куда выводить результат
  //ico - поддиректория иконок для узлов дерева
  i $G(ico)="" s ico="ico_plus"
  Write "",!
	Write "<STYLE>",!
	Write ".button_light {",!
	Write "        BORDER-RIGHT: #bfcfde 1px solid; BORDER-TOP: #bfcfde 1px solid; FONT-SIZE: 12px; BORDER-LEFT: #bfcfde 1px solid; COLOR: #000000; BORDER-BOTTOM: #bfcfde 1px solid;",!
	Write "}",!
	Write ".text_light {",!
	Write "        FONT-SIZE: 14px; COLOR: #000000;",!
	Write "}",!
	Write ".body_grey {",!
	Write "        BACKGROUND-COLOR: #85C0F2; FONT-SIZE: 14px; COLOR: #000000;",!
	Write "}",!
	Write ".tbl_list_user_uti1l {",!
	Write "        FONT-SIZE: 8pt; COLOR: #000000;",!
	Write "}",!
	Write ".body_grey1 {",!
	Write "        BACKGROUND-COLOR: #85C0F2; FONT-SIZE: 8px; COLOR: #000000;",!
	Write "}",!
	Write ".text {",!
	Write "        FONT-SIZE: 9pt; COLOR: #5679af; FONT-FAMILY: Verdana, arial",!
	Write "}",!
	Write ".tariftext {",!
	Write "        FONT-SIZE: 9px; FONT-FAMILY: Verdana, arial; BACKGROUND-COLOR: #f1f1f1",!
	Write "}",!
	Write ".tarif {",!
	Write "        FONT-SIZE: 9px",!
	Write "}",!
	Write ".cmstarif {",!
	Write "        FONT-SIZE: 9px; BACKGROUND-COLOR: #f1f1f1",!
	Write "}",!
	Write ".cmstarif2 {",!
	Write "        FONT-SIZE: 9px; BACKGROUND-COLOR: #e1e1e1",!
	Write "}",!
	Write ".as {",!
	Write "        PADDING-RIGHT: 10px; PADDING-LEFT: 10px; FONT-SIZE: 8pt; PADDING-BOTTOM: 10px; COLOR: #5679af; PADDING-TOP: 10px; FONT-FAMILY: Verdana, arial; align: justify",!
	Write "}",!
	//Write "BODY {",!
	//Write "        BACKGROUND-IMAGE: url(images/bg2.gif); BACKGROUND-REPEAT: repeat-x",!
	//Write "}",!
	Write "A {",!
	Write "        COLOR: #26497f; TEXT-DECORATION: none",!
	Write "}",!
	Write "A:visited {",!
	Write "        COLOR: #26497f; TEXT-DECORATION: none",!
	Write "}",!
	Write "A:hover {",!
	Write "        COLOR: #7699cf; TEXT-DECORATION: none",!
	Write "}",!
	Write "A:active {",!
	Write "        COLOR: #7699cf; TEXT-DECORATION: none",!
	Write "}",!
	Write ".off {",!
	Write "        DISPLAY: none",!
	Write "}",!
	Write ".menu {",!
	Write "        FONT-WEIGHT: bold; FONT-SIZE: 12px; COLOR: #494949; FONT-FAMILY: Tahoma; valign: top",!
	Write "}",!
	Write ".menu:visited {",!
	Write "        COLOR: #494949",!
	Write "}",!
	Write ".menu:hover {",!
	Write "        COLOR: #494949",!
	Write "}",!
	Write ".menu:active {",!
	Write "        COLOR: #494949",!
	Write "}",!
	Write "IMG.blackBorder {",!
	Write "        BORDER-RIGHT: #000 1px solid; BORDER-TOP: #000 1px solid; BORDER-LEFT: #000 1px solid; BORDER-BOTTOM: #000 1px solid",!
	Write "}",!
	Write ".linkator_td {",!
	Write "        FONT-SIZE: 10px; FONT-FAMILY: Verdana",!
	Write "}",!
	Write ".linkator_a {",!
	Write "        FONT-SIZE: 12px; FONT-FAMILY: Verdana",!
	Write "}",!
	Write ".linkator_url {",!
	Write "        FONT-SIZE: 12px; FONT-FAMILY: Verdana",!
	Write "}",!
	Write ".linkator_table {",!
	Write "        BORDER-TOP: #000000 1px solid",!
	Write "}",!
	Write "</STYLE>",!
 
 	Write "<TABLE id='list' border='0'>",!
	Write "<TR><TD></TD></TR>",!
	Write "</TABLE>",!
    //////////////////////////////////////////////////////////////////////
	Write " <SCRIPT>",!
	Write " var Tree = '';var widgetWidth = 12;var widgetHeight = 12;var CurrentElementOfTree=-1; var Prev1='1';",!
	Write "var fillerImg = new Image(1,1);fillerImg.src = '"_BSDOMAIN_"/img/"_ico_"/filler.gif';minus = new Image(widgetWidth,widgetHeight);minus.src = '"_BSDOMAIN_"/img/"_ico_"/minus.gif';var plus = new Image(widgetWidth,widgetHeight);plus.src = '"_BSDOMAIN_"/img/"_ico_"/plus.gif';",!
 
	w "var end = new Image(widgetWidth,widgetHeight);end.src = '"_BSDOMAIN_"/img/"_ico_"/end.gif';var pCell=document.getElementById('list').rows[0].cells[0];var BR='';",!
	Write "var db = new Array();",!
	
	Write "function GetOpen()",!
	Write "{",!
	Write "    var open=';';",!
	Write "    for(var i=0;i<countRow;i++)",!
	Write "              {",!
	Write "                  open+=db[i].id+'='+db[i].open+';';",!
	Write "              }",!
	Write "    open=open.substr(1);",!
	Write "    return open;",!
	Write "};",!
	
	Write "function SetVisible(i)",!
	Write "{",!
	Write "    db[i].open==0?db[i].open=1*1:db[i].open=0*1;Tree='';GetChild(0,0);pCell.innerHTML=Tree;",!
	Write "};",!
	
	Write "function dbRecord(id,name,parent,open,tit)",!
	Write "{",!
		W "    this.id = id;",!
	Write "    this.name = name;",!
	Write "    this.parent = parent;",!
	Write "    this.open = open*1;",!
	Write "    this.tit = tit;",!
	//Write "     if (this.tit==undefined) {this.tit='id узла:'+id;} ",!  
	Write "     if (this.tit==undefined) {this.tit='Выберите требуемый режим';} ",!  
	//Write "     if (this.tit==undefined) {this.tit='Правой кнопкой мыши выберите требуемый режим';} ",!  
	Write "    return this;",!
	Write "};",!
 
	Write "function DOclick()",!
	Write "    {",!  
	//w "alert(' ='+CurrentElementOfTree+' ='+CurrentI+' ='+db[CurrentI].name);",!
	W " window.open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"&TrID=""+CurrentElementOfTree,"""_$g(frn)_""","""");",!
	Write "    };",!
 
	Write "function Cur(tt)",!
	Write "    {",!  
	W "        if (Prev1=='2') {Prev.style.fontWeight='normal';}"_BK
	W "        tt.style.fontWeight='800';"_BK
	W "        Prev=tt; Prev1='2';",!
	Write "    };",!
	
	Write "function GetChild(id,level)",!
	Write "{",!
	Write "   var onclk;",!
	Write "   for(var i=0;i<countRow;i++)",!
	Write "          {",!
	Write "                 if(db[i].parent==id)",!
	Write "      {",!
	Write "      isHaveChild(db[i].id)?(db[i].open==1?ico='minus':ico='plus'):ico='end';",!
	Write "      ico=='end'?onclk='':onclk='SetVisible('+i+');';",!
	Write "      Tree+=(""<IMG SRC='"_BSDOMAIN_"/img/"_ico_"/filler.gif' HEIGHT='1' WIDTH='""+level*15+""'>"");",! //картинка отступа
	             //картинка ветки дерева
	W "    if (ico=='plus')  {tle='Раскрыть узел';}",!
	W "    if (ico=='minus')  {tle='Закрыть узел';}",!
		W "    if (ico=='end')  {tle='';}",!
	w "          Tree+=(""<IMG style='cursor:hand;' onclick='""+onclk+""hidemenuie5();' oncontextmenu='hidemenuie5();return false;' SRC='"_BSDOMAIN_"/img/"_ico_"/""+ico+"".gif' HEIGHT='18' WIDTH='18' BORDER='0' title='""+tle+""'>"");",! //12
	
	//Write "      Tree+=(""<IMG style='cursor:hand;' onclick='""+onclk+""hidemenuie5();' SRC='"_BSDOMAIN_"/img/"_ico_"/""+ico+"".gif' HEIGHT='12' WIDTH='12' BORDER='0'>"");",!
                 //снова отступ	
	Write "      Tree+=(""<IMG SRC='"_BSDOMAIN_"/img/"_ico_"/filler.gif' HEIGHT='1' WIDTH='5'>"");",!
	             //узел дерева
	//Write "      Tree+=""<SPAN title='""+db[i].tit+""'  style='cursor:hand;' ONCLICK='alert(CurrentElementOfTree=""+db[i].id+"");' oncontextmenu='CurrentElementOfTree=""+db[i].id+"";showmenuie5();return false;'>""+db[i].name+'</SPAN><BR>'+'\r\n';",!
	Write "      Tree+=""<SPAN title='""+db[i].tit+""' style='cursor:hand; text-decoration:underline;' ONCLICK='Cur(this); CurrentI=""+i+""; CurrentElementOfTree=""+db[i].id+""; DOclick();' oncontextmenu='Cur(this); CurrentI=""+i+""; CurrentElementOfTree=""+db[i].id+""; DOclick(); showmenuie5(); return false;'>""+db[i].name+'</SPAN><BR>'+'\r\n';",!
	
	Write "      if(db[i].open==1){GetChild(db[i].id,level+1)};",!
	Write "      }",!
	Write "    }",!
	Write "    return 0;",!
	Write "};",!
	
	Write "function isHaveChild(id)",!
	Write "{",!
	Write "   for(var i=0;i<countRow;i++)",!
	Write "          {",!
	Write "                 if(db[i].parent==id){return 1;}",!
	Write "          }",!
	Write "return 0;",!
	Write "}",!
  D @LAB //А ЗДЕcЬ СФОРМИРУМЕМ ДЕРЕВО, КАК ПРАВИЛО ПО МАССИВУ GLO
	Write "countRow=db.length;",!
	Write "GetChild(0,0);",!
	//W "alert(Tree);",!
	W "pCell.innerHTML=Tree;</SCRIPT>",!
    Q
CMenuJS(ROU,frn,BSrouLoop) //ROU - программа вызываемая по правому клику
    //ON - флаг...
    //frn - имя фрэйма куда отправить результат
	Write "<STYLE>",! //СТИЛИ КОНТЕКСТНОГО МЕНЮ
	Write "#ie5menu{",!
	Write "position:absolute;",!
	Write "border:1px solid black;",!
	Write "background-color:#BBBBBB;",!
	Write "font-family:Arial;",!
	Write "font-size:10px;",!
	Write "line-height:10px;",!
	//Write "cursor:default;",!
	Write "cursor:hand;",!
	Write "visibility:hidden;",!
	Write "}",!
	Write ".menuitems{",!
	Write "padding-left:10px;",!
	Write "padding-right:10px;",!
	Write "}",!
	Write "</STYLE>",!
   
   // D Exec^%ZAPM.bs.BSCp
	
	Write "<SCRIPT language=JavaScript1.2>",!
	Write "var display_url=1;",!
	
	Write "function showmenuie5(){",!
	/* MSW
	Write "var rightedge=document.body.clientWidth-event.clientX;",!
	Write "var bottomedge=document.body.clientHeight-event.clientY;",!
	;W "alert(document.body.clientWidth+'W-X'+event.clientX+'--'+document.body.clientHeight+'H-Y'+event.clientY);",!
	Write "if (rightedge<ie5menu.offsetWidth)",!
	Write "ie5menu.style.left=document.body.scrollLeft+event.clientX-ie5menu.offsetWidth;",!
	Write "if (rightedge >= ie5menu.offsetWidth)",!
	Write "ie5menu.style.left=document.body.scrollLeft+event.clientX;",!
	Write "if (bottomedge<ie5menu.offsetHeight)",!
	Write "ie5menu.style.top=document.body.scrollTop+event.clientY-ie5menu.offsetHeight;",!
	Write "else",!
	Write "ie5menu.style.top=document.body.scrollTop+event.clientY;",!
	*/
	Write "ie5menu.style.top=document.body.scrollTop+event.clientY;",!
	Write "ie5menu.style.left=document.body.scrollLeft+event.clientX;",!
	
	Write "ie5menu.style.visibility='visible';",!
	Write "return false;",!
	Write "}",!
	
	Write "function hidemenuie5(){",!
	Write "ie5menu.style.visibility='hidden';",!
	Write "}",!
	
	Write "function ReturnFalse(){",!
	Write "return false;",!
	Write "}",!
	
	Write "function highlightie5(){",!
	Write " if (event.srcElement.className=='menuitems'){",!
	Write " event.srcElement.style.backgroundColor='highlight';",!
	Write " event.srcElement.style.color='white';",!
	Write " if (display_url==1)",!
	Write " window.status=event.srcElement.url;",!
	Write " }",!
	Write "}",!
	
	Write "function lowlightie5(){",!
	Write " if (event.srcElement.className=='menuitems'){",!
	Write " event.srcElement.style.backgroundColor='';",!
	Write " event.srcElement.style.color='black';",!
	Write " window.status='';",!
	Write " }",!
	Write "}",!
	
	Write "function jumptoie5(){",!
	Write " if (event.srcElement.className=='menuitems')",!
	Write " window.location=event.srcElement.url;",!
	Write "}",!
  
	Write "function DO(param)",!
	Write "    {",!  
	//w "alert(param+' '+CurrentElementOfTree);",!
	Write "    window.open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"""+param+""&TrID=""+CurrentElementOfTree,"""_$g(frn)_""","""");",!
	//W " "_$$OpenWeb^%ZAPM.bs.BSCp2("http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"'+param"_$S($G(ON):"+'&TrID='+CurrentElementOfTree",1:""))
	Write "    };",!
	
	Write "</SCRIPT>",!
	Q
Context(LAB) //ПУНКТЫ КОНТЕКСТНОГО МЕНЮ
	Write "<DIV id=ie5menu onmouseover=highlightie5() style='LEFT:207px; VISIBILITY:hidden; TOP:78px' onmouseout=lowlightie5()>",!
	D @LAB //РЕЖИМЫ КОНТЕКСТНОГО МЕНЮ (см.пример в ^%ZAPM.bs.BSCrr)
	Write "</DIV>",!
	Write "<SCRIPT language=JavaScript1.2>",!
	Write "document.body.onclick=hidemenuie5;",!
	Write "</SCRIPT>",!
	Write "",!
 Q
RESTGLO  I $G(BSnumber)="" Q
 s GLO=$G(@BDSES@(BSSES,"VAR","IDNumber",BSnumber))
 I $G(GLO)="" Q
 S GB=$NA(@BDSES@(BSSES,"VAR","ID",GLO))
 Q  //
PClick ////РЕЖИМЫ РЕДАКТИРОВАНИЯ ДЕРЕВА; D locvar^%ZAPM.bs.BSCh0("",1)
 I $G(TrID)="" W "идентификатор массива пустой" Q
 I $G(Mode)="" W "имя режима пусто" Q
 D RESTGLO
 S GL=@GB@(TrID) 
 D @Mode 
 G @BSrouLoop
Copy D A S @BDSES@(BSSES,"VAR","IDExpand",GLO)=GL K @BDSES@(BSSES,"VAR","TreeCopy") M @BDSES@(BSSES,"VAR","TreeCopy")=@GL //,$QS(GL,$QL(GL)))=@GL 
 Q
Paste D A M @GL=@BDSES@(BSSES,"VAR","TreeCopy") 
 Q
KILL D A K @GL q 
Edit D A
 M @A@(Node)=@GL K @GL
 Q
A S A=$P(GL,"(") F I=1:1:$QL(GL)-1 S A=$NA(@A@($QS(GL,I)))
 S @BDSES@(BSSES,"VAR","IDExpand",GLO)=A //УСТАНОВИМ УКАЗАТЕЛЬ ДЛЯ РАСКРЫТИЯ ДЕРЕВА, НА РОДИТЕЛЬСКИЙ УЗЕЛ 
 Q
Ins D A
 S @A@(Node)=""
 q
InsC D A
 S @GL@(Node)=""
 q
EDITGLO 
    //CurrentI - текущий номер массива db
    W $$i(),!
    W $$mi("Изменить","var Node=prompt(""Введите имя узла"",db[CurrentI].name); if (Node!=""""&&Node!=null) {DO(""&Mode=Edit&Node=""+Node);}","Изменить текст текущего узла"),!
	;Write "<DIV class=menuitems style='COLOR: black' onclick='if(confirm(""Вы уверены?"")){location=""?LBL_=INDEX_tree_editor*tree_editor&TBL_=oldtree&OPEN_=1=0;2=0;3=0;4=0;5=0;6=0;7=0;8=0;9=0;10=0;11=0;12=0;13=0;14=0;15=0;21=0;19=0;20=0;28=0;29=0;30=0;31=0;92=0;81=0;79=0;91=0;90=0;86=0;74=0;88=0;89=0;83=0;93=0;85=0;94=0;95=0;96=0;97=0;98=0;99=0;100=0;101=0;102=0;103=0;104=1;105=0;&SESS=1144240589*41985476&OPENER_RELOAD_=1&TBL_=oldtree&SPEC=DELROW&ID_=""+CurrentElementOfTree+""&OPEN_=""+GetOpen();}' >Удалить</DIV>",!
	W $$i(1),!
	W $$mi("Добавить узел","var Node=prompt(""Введите имя узла"",""""); if (Node!=""""&&Node!=null) {DO(""&Mode=Ins&Node=""+Node);}","Добавить новый узел"),!
	W $$i(1),!
	W $$mi("Добавить уровень","var Node=prompt(""Введите имя узла для нового уровня"",""""); if (Node!=""""&&Node!=null) {DO(""&Mode=InsC&Node=""+Node);}","Добавить новый уровень"),!
	W $$i(3),!
	W $$mi("Копировать","DO(""&Mode=Copy"");","Копировать ветку в буфер обмена"),!
	W $$i(1),!
	W $$mi("Вставить","DO(""&Mode=Paste"");","Вставить ветку из буфера обмена"),!
	W $$i(3),!
	W $$mi("Удалить","if(confirm(""Удалить узел со всеми потомками! `""+db[CurrentI].name+""` Вы уверены?"")){DO(""&Mode=KILL"");}","Удалить текущий узел"),!
	W $$i(),!
	Q
i(S) N HR I $G(S)'="" S HR="<HR size="_$G(S,1)_" color=BLACK>" 
 Q "<DIV>"_$G(HR,"&nbsp;")_"</DIV>"
mi(TEXT,JSonCLICK,TIT)
 Q "<DIV title='"_$G(TIT)_"' class=menuitems style='COLOR: black' onclick='"_JSonCLICK_"' >"_TEXT_"</DIV>"
 
Exp(id) i $g(open) q 1 //открыто все дерево сразу 
 Q $S($G(@BDSES@(BSSES,"VAR","IDExpand",GLO))[$P($G(@GL@(id)),")"):1,1:0)
Create //Формируем дерево по массиву GLO (Ограничено 9 уровнями) 
 N ID,GL,I,I1,I2,I3,I4,I5,I6,I7,I8,I9
 I '$D(@GLO) Q
 K @BDSES@(BSSES,"VAR","ID",GLO) S GL=$ZR,@GL=10 
 S I1="" F  S I1=$O(@GLO@(I1)) Q:I1=""  D
 .S ID1=$I(@GL),@GL@(ID1)=$NA(@GLO@(I1))
 .W "db[db.length] = new dbRecord('"_ID1_"', '"_I1_"', '0', "_$$Exp(ID1)_");",!
 .S I2="" F  S I2=$O(@GLO@(I1,I2)) Q:I2=""  D
 ..S ID2=$I(@GL),@GL@(ID2)=$NA(@GLO@(I1,I2))
 ..W "db[db.length] = new dbRecord('"_ID2_"', '"_I2_"', '"_ID1_"', "_$$Exp(ID2)_");",!
 ..S I3="" F  S I3=$O(@GLO@(I1,I2,I3)) Q:I3=""  D
 ...S ID3=$I(@GL),@GL@(ID3)=$NA(@GLO@(I1,I2,I3))
 ...W "db[db.length] = new dbRecord('"_ID3_"', '"_I3_"', '"_ID2_"', "_$$Exp(ID3)_");",!
 ...S I4="" F  S I4=$O(@GLO@(I1,I2,I3,I4)) Q:I4=""  D
 ....S ID4=$I(@GL),@GL@(ID4)=$NA(@GLO@(I1,I2,I3,I4))
 ....W "db[db.length] = new dbRecord('"_ID4_"', '"_I4_"', '"_ID3_"', "_$$Exp(ID4)_");",!
 ....S I5="" F  S I5=$O(@GLO@(I1,I2,I3,I4,I5)) Q:I5=""  D
 .....S ID5=$I(@GL),@GL@(ID5)=$NA(@GLO@(I1,I2,I3,I4,I5))
 .....W "db[db.length] = new dbRecord('"_ID5_"', '"_I5_"', '"_ID4_"', "_$$Exp(ID5)_");",!
 .....S I6="" F  S I6=$O(@GLO@(I1,I2,I3,I4,I5,I6)) Q:I6=""  D
 ......S ID6=$I(@GL),@GL@(ID6)=$NA(@GLO@(I1,I2,I3,I4,I5,I6))
 ......W "db[db.length] = new dbRecord('"_ID6_"', '"_I6_"', '"_ID5_"', "_$$Exp(ID6)_");",!
 ......S I7="" F  S I7=$O(@GLO@(I1,I2,I3,I4,I5,I6,I7)) Q:I7=""  D
 .......S ID7=$I(@GL),@GL@(ID7)=$NA(@GLO@(I1,I2,I3,I4,I5,I6,I7))
 .......W "db[db.length] = new dbRecord('"_ID7_"', '"_I7_"', '"_ID6_"', "_$$Exp(ID7)_");",!
 .......S I8="" F  S I8=$O(@GLO@(I1,I2,I3,I4,I5,I6,I7,I8)) Q:I8=""  D
 ........S ID8=$I(@GL),@GL@(ID8)=$NA(@GLO@(I1,I2,I3,I4,I5,I6,I7,I8))
 ........W "db[db.length] = new dbRecord('"_ID8_"', '"_I8_"', '"_ID7_"', "_$$Exp(ID8)_");",!
 ........S I9="" F  S I9=$O(@GLO@(I1,I2,I3,I4,I5,I6,I7,I8,I9)) Q:I9=""  D
 .........S ID9=$I(@GL),@GL@(ID9)=$NA(@GLO@(I1,I2,I3,I4,I5,I6,I7,I8,I9))
 .........W "db[db.length] = new dbRecord('"_ID9_"', '"_I9_"', '"_ID8_"', "_$$Exp(ID9)_");",!
 Q
SavePost2Tree //СОХРАНИТЬ ДАННЫЕ ПО ШАБЛОНУ ТАБЛИЦЫ-ПАРАМЕТРОВ (OO) В В УЗЕЛ ДЕРЕВА (GL)
 S StopSave=2,val=""
 N STOP,mp s mp=$g(aMp,"&")
 S I="" F  S I=$O(@OO@(I)) Q:I=""   S val=val_I_"="_$G(@OO@(I,"V"))_mp I $G(@OO@(I,"V"))[mp S STOP(I)="Ошибка! Запрещенный символ "_mp
 I $D(STOP) W RED ZW STOP W EF Q 
 D RESTGLO^%ZAPM.bs.BSCtree
 S GL=@GB@(BSTrID)
 S @GL=TBL_mp_val_"zDataSave="_$tr($ZD($H,3),"-")_" "_$ZT($P($H,",",2),1)_" "_$g(BSLOGIN,"?")
 
 W GREEN_"Сохранено"_EF
 Q
PreOpen
PreOpn  //ПОДГОТОВКА ПАРАМЕТРОВ
 N G,I,V,D
  F I=2:1 Q:$P(val,"&",I,I+1)=""  i $P(val,"&",I)'="" S V=$P($P(val,"&",I),"="),D=$P($P(val,"&",I),"=",2,999) D
  .S @BSBD1@(V,"V")=D
 Q
PreOpnAmpFree(w)  //ПОДГОТОВКА ПАРАМЕТРОВ, амперсант разрешен
 N G,I,V,D
  F I=2:1 Q:$P(val,w,I,I+1)=""  i $P(val,w,I)'="" S V=$P($P(val,w,I),"="),D=$P($P(val,w,I),"=",2,999) D
  .S @BSBD1@(V,"V")=D
 Q
 
PreSaveAmpFree(aMp) //ЛОГИКА ПРОВЕРОК
 D BEG1^%ZAPM.bs.BSC4
 D SavePost2Tree^%ZAPM.bs.BSCtree
 D END^%ZAPM.bs.BSC4
 q
PreSave //ЛОГИКА ПРОВЕРОК
 D BEG1^%ZAPM.bs.BSC4
 D SavePost2Tree^%ZAPM.bs.BSCtree
 D END^%ZAPM.bs.BSC4
 q
GetValTree(NOD,V,w) Q $P($P(NOD,$g(w,"&")_V_"=",2),$g(w,"&")) //получить значение показателя из узла дерева
SetValTree(val,V1,NewVal,w) //Присвоить новое значение
 n a,I,V,D 
 F I=2:1 Q:$P(val,$g(w,"&"),I,I+1)=""  i $P(val,$g(w,"&"),I)'="" S V=$P($P(val,$g(w,"&"),I),"="),D=$P($P(val,$g(w,"&"),I),"=",2,999) s V(V)=$tr(D,$g(w,"&"))
 s V(V1)=NewVal
 s a=$p(val,$g(w,"&"))_$g(w,"&") S I="" F  S I=$O(V(I)) Q:I=""   S a=a_I_"="_$G(V(I))_$g(w,"&") 
 Q a //и возвратить значение всего узла
GetA(R) I R="" S R=2 //ПОКА ТАК
 Q $S(+R<2:"N",R=2:"R",R=3:"W",1:"X")
 ////////////////////////////////////////////////////////////////
GetSQL(sql,Col,R,ns) //возвратить sql утверждения и положить его в лок.массив по ссылке
 n curns,ErrOR,Res,Sc,COL,i,j,J,ret,%ROWCOUNT,SQLCODE,%ROWID
 s ns=$g(ns,"ASU") s curns=$zu(5)
 i $zu(5)'=ns zn ns
 S Res=##Class(%ResultSet).%New()
 s Sc=Res.Prepare(sql) I 'Sc S ErrOR=$$Status^%ZAPM.bs.BSCtree(Sc) G DSNend31
 I 'Res.QueryIsValid() S ErrOR="Недопустимый Запрос" G DSNend31
 s Sc=Res.Execute()
 I 'Sc S ErrOR=$$Status^%ZAPM.bs.BSCtree(Sc) G DSNend31
 f i=1:1 q:'Res.Next()  f j=1:1:Col s R(i,j)=Res.GetData(j)
DSNend31 ;zw ErrOR
 k Res ;d Res.%Close()
 i curns'=$zu(5) zn curns
 i $d(ErrOR) q $g(ErrOR)
 q $g(i) //количкство найденных строк
GetF(T,F1,D1,F,ns) //возвратить значение поля F для первой найденной записи из таблицы T при условии F1=D1
 n curns,ErrOR,Res,Sc,sql,COL,i,J,ret,%ROWCOUNT,SQLCODE,%ROWID
 s ns=$g(ns,"ASU") s curns=$zu(5)
 i $zu(5)'=ns zn ns
 S Res=##Class(%ResultSet).%New()
 s sql="select "_F_" from "_T_" where "_F1_"='"_D1_"'" ;s ^%zz=sql
 s Sc=Res.Prepare(sql) I 'Sc S ErrOR=$$Status^%ZAPM.bs.BSCtree(Sc) G DSNend3
 I 'Res.QueryIsValid() S ErrOR="Недопустимый Запрос" G DSNend3
 s Sc=Res.Execute()
 I 'Sc S ErrOR=$$Status^%ZAPM.bs.BSCtree(Sc) G DSNend3
 f i=1:1 q:'Res.Next()  s ret=Res.GetData(1) q 
DSNend3 ;zw ErrOR
 k Res ;d Res.%Close()
 i curns'=$zu(5) zn curns
 i $d(ErrOR) q $g(ErrOR)
 q $g(ret,"?.")
Status(sc) ;СТАТУС
 N err,i,st1
 I ('sc) D  Q st1
 .D DecomposeStatus^%apiOBJ(sc,.err)
 .S st1="" F i=1:1:err S st1=st1_err(i)_". "
 Q ""  
GetASUOpt(name,BSLOGIN) //параметры ИП и пользователя, если они совпадают
 n u
 s u=$$GETOPT^%ZAPM.bs.BSC4cfgP($na(@"^[""PRG""]BSc4uSERS"@(BSLOGIN,"FNM","ASU")),name,,"^[""PRG""]MSM.ASURP.OPTuser")
 i u="" q $$GETOPT^%ZAPM.bs.BSC4cfgP("^[""PRG""]MSM.ASURP.OPTOIN",name)
 q u
 //"ASUEHGm.opt","NameOpt","NarIdDir","ValOpt","ASU"
GetOpt(Packet,sc,NameOpt) //функция, специально для получения значений опции для ИП
 n r,%objlasterror,%msg
 s r=$$GetF(Packet_".opt","NameOpt",NameOpt,"ValOpt","ASU")
 i $d(%objlasterror) m sc=%objlasterror s r=""
 e  s sc="1 ок"
 i r="?." s sc="2 undef",r=""
 q r
SetOpt(Packet,sc,NameOpt,ValOpt) //функция, специально для присвоения значения опции для ИП
 n id,cur,ns,curns
 s id=$$GetF(Packet_".opt","NameOpt",NameOpt,"ID","ASU")
  s ns=$g(ns,"ASU") s curns=$zu(5)
 i $zu(5)'=ns zn ns
  x "s cur = ##class("_Packet_".opt).%OpenId(id)"
	s cur.ValOpt = ValOpt
	s sc = cur.%Save()
	k cur
	i curns'=$zu(5) zn curns
	 i 'sc q sc
 q id
 ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
WebTreeEdit(BSns,BSgl,BSglMode) //редактор массивов в виде дерева
 i $g(ns)'="" s ns=$$%^%ZAPM.bs.BSCh(ns)
 e  s ns=$zu(5)
 n BSNSP i ns'=$zu(5) zn ns
 s BSNSP=$zu(5)
 D BEG1^%ZAPM.bs.BSC4
 w "<table border=0>"_BK
 w "<tr>"_BK
 w "<td ><DIV class=s3 id='span1'>Рабочая область/Глобал/Индексы:"_BLUE_ns_EF_"</DIV></td>"_BK
 w "<td ><DIV class=s3 id='span2'>Характеристики</DIV></td>"_BK
 w "</tr><tr>"_BK
 W "<td valign=top >"_$$Tree1("Str","Tree12^%ZAPM.bs.BSCtree",450,400)
 w "</td>"
 W "<td valign=top >"_$$Tree1("Atr","Tree0^%ZAPM.bs.BSCtree",450,400)
 W "<td valign=top >"_$$Tree1("Wrk","Tree0^%ZAPM.bs.BSCtree",450,400)
 w "</td>"
 W "</tr>"_BK
 W "</table>"
 w "<DIV class=s3 id='spanStaus' >...</DIV>"
 D END^%ZAPM.bs.BSC4 
 q
Tree1(IDIF,ROU,H,W) //ВЫВОД ИФРЭЙМА
 Q BK_"<IFRAME HEIGHT='"_H_"px' "_$s($g(W):"width='"_W_"px'",1:"")_" SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,ROU)_"' name='"_IDIF_"' SCROLLING='auto'></IFRAME><BR>"_BK 
Tree0
 D BEG1^%ZAPM.bs.BSC4 D END^%ZAPM.bs.BSC4
 q
bb  i $d(BDSES) s bb=$na(@BDSES@(BSSES,"VAR","str"_$g(BSns)_$g(BSgl))) //буферный массив идентификаций узлов дерева
 q
Tree12 //первый уровень редактора глобала
 D BEG1^%ZAPM.bs.BSC4 
 n LIST,noSay,mm,i,ii
 d bb s mm=1
 i $g(BSgl)="" s noSay=1 d addGlo^%ZAPM.bs.BSC4r4("*")  S i="" F ii=1:1 S i=$O(LIST(i)) Q:i=""  d AddGl(ii,"^"_$p(i,".GBL"))
 i $g(BSgl)'=""  d AddGl(1,BSgl)
 d Lev1^%ZAPM.bs.BSCtree(.mm,"Level^%ZAPM.bs.BSCtree(2)","","ClickImg2^%ZAPM.bs.BSCtree","ClickTxt^%ZAPM.bs.BSCtree("_$g(BSglMode)_")")
 q
AddGl(ii,g) s mm(ii)=BLUE_g_EF,mm(ii,1)=g i $o(@g@(""))="" s mm(ii,0)=1
 q
ClickTxt(Mode) d bb s s=@bb@(id)
 D BEG1^%ZAPM.bs.BSC4 
 w RED_@bb@(id,1)_EF_"="_MAROON_$g(@@bb@(id,1))_EF
 i $g(Mode,0)=0 g ClickTxtEnd
 //Редактировать
 s gg=@bb@(id,1),i=$p(gg,$qs(gg,0)_"(",2)
 w "<hr>" w "<BODY>" w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="SaveEditGlo^~BSCtree" D ADDBSPOST^%ZAPM.bs.BSC4reg
 D TABL^%ZAPM.bs.BSCp
 D TR21^%ZAPM.bs.BSCp W "Рабочая область" D TR22^%ZAPM.bs.BSCp w " <input size=33 type=textbox name=nameGln value='"_$zu(5)_"' title='Редактируйте'>"  D TR23^%ZAPM.bs.BSCp
 D TR21^%ZAPM.bs.BSCp W "Имя массива" D TR22^%ZAPM.bs.BSCp w " <input size=33 type=textbox name=nameGl value='"_$p($qs(gg,0),"^",2)_"' title='Редактируйте имя массива'>"  D TR23^%ZAPM.bs.BSCp
 D TR21^%ZAPM.bs.BSCp W "Индексы " D TR22^%ZAPM.bs.BSCp w " <input  size=33 type=textbox name=nameGli value='"_$e(i,1,$l(i)-1)_"' title='Редактируйте индексы'>" D TR23^%ZAPM.bs.BSCp
 s i=$$Quote^%cspQuote($g(@gg,"<undef>"))
 D TR21^%ZAPM.bs.BSCp W "Данные в узле " D TR22^%ZAPM.bs.BSCp w " <input  size=43  type=textbox name=nameGld value='"_$e(i,1,$l(i)-1)_"' title='Редактируйте индексы'>" D TR23^%ZAPM.bs.BSCp
 D TABLE^%ZAPM.bs.BSCp
 w "<input type=submit name=sDUB value='Copy' title='copy...'>"_BK
 w "</form>"
ClickTxtEnd D END^%ZAPM.bs.BSC4
 q
SaveEditGlo //сохранение изменений
 D BEG1^%ZAPM.bs.BSC4
 w 1,nameGld,1
 W "записано" 
 D END^%ZAPM.bs.BSC4
 q
ClickImg2 //раскрытие\закрытие любого уровня
  D bb d ClickImg^%ZAPM.bs.BSCtree
  q
Level(l)  n i,mm,g
  S mm=l,g=@bb@(id,1)
  s i="" F  S i=$O(@g@(i)) Q:i=""  d
  .s mm(i)=$tr(i,"'"_$c(34),"``")  //текст узла
  .s mm(i,1)=$na(@g@(i)) 
  .s mm(i,2)=$tr($na(@g@(i)),"'"_$c(34),"``") //всплывающий текст ссылки на узел
  .i $o(@g@(i,""))="" s mm(i,0)=1 //если дальше нет, то заглушим
  d Lev2^%ZAPM.bs.BSCtree(l-1,.mm,"Level^%ZAPM.bs.BSCtree("_(l+1)_")",(l-1)_" индекс масива")
  q
 ////////////////////////////новое правильное дерево
Lev1(mm,L2,Tit,RouImg,RouTxt) //%%%%%%%%%%%%цикл по первому уровню
 //bb - буфер от сессии
 D BEG1^%ZAPM.bs.BSC4 k @bb
  S i="" F i1=1:1 S i=$O(mm(i)) Q:i=""  d
  .s id=$i(@bb) s @bb@(id)=$g(mm)_"&"_i_"&"_1_"&"_L2_"&0&"
  .i $d(mm(i,1)) s @bb@(id,1)=mm(i,1)
  .w "<div id='s"_id_"'>" s ico="plus",tit="Раскрыть узел",on="onclick=""ClickImg("_id_");"" "
  .i $d(mm(i,0)) s ico="end",tit="Узел не имеет потомков",on=""
  .i $d(mm(i,2)) s Tit=$TR(mm(i,2),"'"_$C(34),"``")
  .s ti="title='"_Tit_"'>"_mm(i)
  .s $p(@bb@(id),"&",8)=ti 
  .w "<img border=0 src='"_BSDOMAIN_"/img/ico_plus/"_ico_".gif' ALT='"_tit_"' "_on_" >" 
  .w " <SPAN  class=u1 onclick=""Cur(this); ClickTxt("_id_");"" "_ti_"</SPAN>"
  .w "</div>"_BK
 w BK
 D JS^%ZAPM.bs.BSCp
  W "function ClickImg(id) {"_BK
  w "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,RouImg)_"&id=""+id,""Wrk"","""");"_BK
  w "}"_BK
  W "function ClickTxt(id) {"_BK
  w "open("""_$$ADDBSGET^%ZAPM.bs.BSC4(,RouTxt)_"&id=""+id,""Atr"","""");"_BK
  w "}"_BK
    w "var Prev1='1';"_BK
  	Write "function Cur(tt)"_BK
	Write "    {"_BK
	W "        if (Prev1=='2') {Prev.style.fontWeight='normal';}"_BK
	W "        tt.style.fontWeight='800';"_BK
	W "        //alert(Prev1);"_BK
	w "        Prev=tt; Prev1='2';"_BK
	Write "    };"_BK
	
 D JSE^%ZAPM.bs.BSCp
 D END^%ZAPM.bs.BSC4
 q
ClickImg //%%%%%%%%%%% раскрытие\закрытие любого уровня
 n s,rou,i
 s s=$g(@bb@(id)) i s="" w "!!!!!!" q
 D JS^%ZAPM.bs.BSCp
 w "var s1="""_$$sp($p(s,"&",5))_"<img border=0 src='"_BSDOMAIN_"/img/ico_plus/"_$$icon_".gif' onclick='ClickImg("_id_");'  >""; "_BK 
 w " s1=s1+"" <SPAN class=u1 onclick='Cur(this); ClickTxt("_id_");' "_$p(s,"&",8)_"</SPAN>"";"_BK
 i '$p(s,"&",3) s $p(@bb@(id),"&",3)=1 g CC //вкл\выкл
 s rou=$p(s,"&",4) i rou'="" d @rou //подключается программа добавления узлов ноовго уровня
 s $p(@bb@(id),"&",3)=0
CC W "parent.Str.s"_id_".innerHTML=s1;"_BK
 D JSE^%ZAPM.bs.BSCp
 q 
 //&#160;
sp(n) n i,s s s="" i 'n q ""  //%%%%%% n-номер уровня
 f i=1:1:n  s s=s_"<img border=0 src='"_BSDOMAIN_"/img/ico_plus/empty.gif' >"
 q s
icon() i '$p(s,"&",3) q "plus" //%%%% имя картинки
  i $p(s,"&",3) q "minus"
 q "end"
 
Lev2(Lev,mm,L3,Tit) //%%%%% второй, и все последующие уровени
 i '$d(mm) w " s1=s1+""<div>"_$$sp(1)_"...пусто</div>"";"_BK q
 n id,i,q
  S i="" F  S i=$O(mm(i)) Q:i=""  d
  .s id=$i(@bb) 
  .s @bb@(id)=$g(mm)_"&"_i_"&"_1_"&"_L3_"&"_Lev_"&"
  .i $g(mm(i))="" s mm(i)="_"
  .i $d(mm(i,1)) s @bb@(id,1)=mm(i,1)
  .i $d(mm(i,2)) s Tit=$TR(mm(i,2),"'"_$C(34),"``")
  .s ti="title='"_Tit_"'>"_mm(i)_" "
  .s $p(@bb@(id),"&",8)=ti
  .s q="<div id='s"_id_"'>" s ico="plus",tit="Раскрыть узел",on="onclick='ClickImg("_id_");' "
  .i $d(mm(i,0)) s ico="end",tit="Узел не имеет потомков",on="" 
  .s q=q_$$sp(Lev)_"<img border=0 src='"_BSDOMAIN_"/img/ico_plus/"_ico_".gif' ALT='"_tit_"' "_on_" >" 
  .s q=q_" <SPAN  class=u1 onclick='Cur(this); ClickTxt("_id_");' "_ti_"</SPAN>"
  .w " s1=s1+"" "_q_"</div> "";"_BK
 q
GetTemplateUrl(pack,ParName) //получить ТК-WEB url шаблона из Инфотеки из параметра
 n gl,url,err
 ZN $$v^%ZAPM.bs.BSCp("vASU")
 s gl=$$GetOpt^%ZAPM.bs.BSCtree(pack,.err,ParName) //шаблон
 i +err'=1 w RED_err_EF  q ""
 n BSDOMAIN,BSFRM2,BSGRANT,BSLABEL,BSLABEL2,BSNSP,BSNSP2,BSac,BSarm,BSdebug,BStyle,BSpath
 s BSNSP="ASU"
 s url=$$GetIpUrl^%ZAPM.bs.BSCp(gl)
 i url["size(0)" w RED_"В Инфотеке в карточке №"_gl_" расположен пустой файл!"_EF g GetTemplateUrl2
 i url["Error:" w RED_"Ошибка загрузки файла из Инфотеки в карточке №"_gl_".<b>"_BBK_$ZCVT(url,"O","HTML")_"</b>"_EF g GetTemplateUrl2
 W "Формируем ... и выводим его в MS-Excel - шаблон :"_RED_url_EF_"<hr>" 
 q url
GetTemplateUrl2
 q "" 
 
 
]]></Routine>


<Routine name="%ZAPM.bs.BSCtrm" type="MAC" languagemode="0"><![CDATA[
%BSCtrm ;ДЛЯ CACHE' - Terminal ; 11:04   24.01.2002
 ;
 ; Copyright (c) Serge W. Mikhaylenko
 ; All Rights Reserved
 ;
 D ^%ZAPM.bs.BSC
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSD" type="MAC" languagemode="0"><![CDATA[
%BSD ;КАТАЛОГИ %BS ; 14:00   02.04.99
 N NUM,IntBSD,BSR,BST
 D SI^%ZAPM.bs.BSN S NUM=%BS(15)
 D NNN^%ZAPM.bs.BSN(",NUM") S %BS(15)=999,IntBSD=%BS,$P(%BS,"!",4)=$P(%BS,"!",11),$P(%BS,"!",5)=$P(%BS,"!",12)
 D MGR^%ZAPM.bs.BS I $ZV["MSM" D UCI^%ZAPM.bs.BS
 I $ZV["Cach"||($ZV["IRIS") D DIR^%ZAPM.bs.BSCF2
 S %BS=IntBSD,%BS(15)=NUM
 I $D(BSR),$D(BST) S %BsR=BSR,%BsT=BST D
 .I %BsR["]" S %File=%BsT_","_$P(%BsR,"]",2)_","_$P(%BsR,$C(34),2)_","_$P(%BsR,$C(34),4)
 .E  S %File=%BsT_","_$P(%BsR,"^",2)_","_$P($$ZU^%ZAPM.bs.BS3(0),",")_","_$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 K ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("BUF"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("uCI"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 D QQQ^%ZAPM.bs.BSN("")
 Q
 ;СТАРАЯ
 D SI^%ZAPM.bs.BSN D NNN^%ZAPM.bs.BSN("")
0 D CLr^%ZAPM.bs.BSF4 U $I::%BS(32) U 0:(0::::#10080)
 D WAIT^%ZAPM.bs.BSF2 G UCI:$$ZU^%ZAPM.bs.BS3(0)=$$ZU^%ZAPM.bs.BS3(1,0),RAZD
MGR G MGR^%ZAPM.bs.BS
UCI S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(6),"" <Enter>-РАСКРЫТЬ КИП !!! РЕЖИМ ВЫБОРА ТАБЛИЦЫ !!! <Esc>-ОТМЕНА  """
 S %uCI=$V(2,$J,2) D MGR
 S BSR="^%ZAPM.bs.BSbufB",BST="ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G UCIE
 K ^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S i=-1,YES=1
 F I=0:1:7 I $$ZU^%ZAPM.bs.BS3(1,I)'="" S i=i+1,(%BS(8,i),^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),i))=$P($$ZU^%ZAPM.bs.BS3(1,I),",",2) D VOL^%ZAPM.bs.BSH(@$ZR,i) G EXIT:'YES F J=1:1 Q:$$ZU^%ZAPM.bs.BS3(J,I)=""  S ^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,J)=$P($$ZU^%ZAPM.bs.BS3(J,I),",")
 S j=0,(se,ke)=0 F I=0:1 Q:'$D(^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I))  S sys=^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I) D
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),sys)) Q
 .S j=j+1,^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,j)="@@1@11@@@@"_$S(I=0:0,1:"1,1")_"@1@"_$P(%BS,"!",4)_"@@@@@"_I,i=2,^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)="@@1@11@@@@@1@@@@@@ -----------"
 .F J=1:1 Q:'$D(^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I,J))  D  ;
 ..I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),sys,"*")),'$D(@%BS(18)@(%BS(37),sys,^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),I,J))) Q
 ..S i=i+1,^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)="@@1@11@@@@"_$S(J=1&(I=0):0,1:"3,1")_"@1@"_$P(%BS,"!",5)_"@@@@@"_I_","_J
 ..S:se<i se=i S:ke<j ke=j
 I se=0 S ls=" НЕТ ДОСТУПНЫХ КИПов ! " D O^%ZAPM.bs.BSF7 G EXIT
 S ^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@@1@1@@3,1@@@@@@1"
 S ^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",1,1)="S d1="" ±­· ""_^%ZAPM.bs.BSbufB(""utCI""_$G(%BS(3),$P)_$J_""u""_%BS(15),d)"
 S ^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",3,1)="S d1="" ±­· ""_^%ZAPM.bs.BSbufB(""utCI""_$G(%BS(3),$P)_$J_""u""_%BS(15),$P(d,"",""),$P(d,"","",2))"
 D RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
UCIE I $D(%BS(8,+d)) D UCI^%ZAPM.bs.BSH(%BS(8,+d),+d) G EXIT:'YES S %VGI=+d ;D CKD^%ZAPM.bs.BSF5(+d)
 I $D(TABLfind) G TAB
 I $D(NEWVOLUM) K NEWVOLUM,^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G UCI
 I R1=27!(ny<3)!(d="") G EXIT
 S BSbufR="@@1@77@@@@@1@"_$P(%BS,"!",4)_"@@@@@·­±.. "_^%ZAPM.bs.BSbufB("utCI"_$G(%BS(3),$P)_$J_"u"_%BS(15),$P(d,","),$P(d,",",2))_"         ;   Комментарии к разделам"
 V 2:$J:+$P(d,",")*32+$P(d,",",2):2 K ^%ZAPM.bs.BSbufB("Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15))
RAZD ;ВЫБОР РАЗДЕЛА
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(6),"" <Enter>-ВЫБОР РАЗДЕЛА !!! РЕЖИМ ВЫБОРА ТАБЛИЦЫ !!! <Esc>-ОТМЕНА """
 S BSR="^%ZAPM.bs.BSbufB",BST="Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G RAZDE
 S %NAM="^",i=1,^%ZAPM.bs.BSbufB("Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)=$G(BSbufR,"@@1@77@@@@@1@1;6;80;45@@@@@·­±.. "_$$ZU^%ZAPM.bs.BS3(0)_"        ;   Комментарии к разделам")
 S %zT=$ZT,$ZT="PRO^%ZAPM.bs.BS"
 W /CUP(1,1),%BS(12)
RAZPR F  S %NAM=$O(@%NAM) Q:%NAM=""  S %NAM="^"_%NAM X $G(WA) D
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),$P($$ZU^%ZAPM.bs.BS3(0),",",2),"*")),'$D(@%BS(18)@(%BS(37),$P($$ZU^%ZAPM.bs.BS3(0),",",2),$P($$ZU^%ZAPM.bs.BS3(0),","),"*")),'$D(@%BS(18)@(%BS(37),$P($$ZU^%ZAPM.bs.BS3(0),",",2),$P($$ZU^%ZAPM.bs.BS3(0),","),$P(%NAM,"^",2))) Q
 .S i=i+1,^%ZAPM.bs.BSbufB("Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@1@77@@@@@1@"_$P(%BS,"!",5)_"@@@@@"_$$PPP(%NAM)_" "_%NAM_$J("",14-$L(%NAM))_";"_$$HEADGLO^%ZAPM.bs.BSMSM(%NAM)
 S $ZT=%zT,^%ZAPM.bs.BSbufB("Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@@1@1@@@@@@@@1",se=i,ke=1
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
RAZDE I $D(%BS(8)),$D(%VGI),$D(%BS(8,%VGI)) D UCI^%ZAPM.bs.BSH(%BS(8,%VGI),%VGI) G EXIT:'YES
 I $D(TABLfind) G TAB
 I R1=27!(ny=1) K ^%ZAPM.bs.BSbufB("Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S R1=27 G UCIE:$D(BSMGR) G UCI
 I d'["%BS-Раздел ;" S %BsR=$P(d," ",2),%BsT="<???>" G EX
 S %NAM=$P(d," ",2) K HIDDR
TAB K %BS(9) ;ВЫБОР ТАБЛИЦЫ
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(6),"" <Enter>-ВЫБОР ТАБЛИЦЫ !!! РЕЖИМ ВЫБОРА ТАБЛИЦЫ !!! <Esc>-ОТМЕНА """
 K EXITout,TABLfind S Ii=$S(%NAM="^%ZAPM.bs.BSbufS":79,1:77)
 S BSR="^%ZAPM.bs.BSbufB",BST="Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G TABE
 S %TAB="",i=1 K ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15)),SPSV S ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)="@@1@"_Ii_"@@@@@1@"_$P(%BS,"!",4)_"@@@@@·­±.. "_%NAM_$J("",9-$L(%NAM)+Ii-77)_"        ; ТИП  ;   Комментарии к таблицам"
 S:Ii'=79 ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)="@@1@"_Ii_"@@@@@1@"_$P(%BS,"!",5)_"@@@@@·­± ~новая Таблица    "_$J("",Ii-77)_" ;      ;",i=i+1 S i=i+1,^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@0@"_Ii_"@@@@0@1@@@@@@"
 S ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",i,1)="S m=$P($P(d,""~"",2),"" ""),d1=$S($P($G(@(%NAM_""(m)"")),""@"",30)="""":d,1:$P(d,"".."")_$P($G(@(%NAM_""(m)"")),""@"",30)_$J("""",7-$L($P($G(@$ZR),""@"",30)))_"";""_$P(d,"";"",2,99))"
 S Iii=i I Ii=79 S @$ZR=$P(@$ZR,",d1")_",m=""^[""""""_$P(m,"":"")_"""""":""""""_$P(m,"":"",2)_""""""]""_$P(m,"":"",3),d1"_$P(@$ZR,",d1",2,99)
 S sys=$P($$ZU^%ZAPM.bs.BS3(0),",",2),uc=$P($$ZU^%ZAPM.bs.BS3(0),",") F  S %TAB=$O(@(%NAM_"(%TAB)")) Q:%TAB=""  X $G(WA) I %TAB'["@"&(%TAB'[$G(HIDD,"&")) D  ;
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),sys,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,$P(%NAM,"^",2),"*")),'$D(@%BS(18)@(%BS(37),sys,uc,$P(%NAM,"^",2),%TAB)) Q
 .I Ii=79 D  S i=i+1,^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@1@"_Ii_"@@@@"_Iii_",1@1@"_$P(%BS,"!",5)_"@@@@@·­± ~"_IIi_$J("",18-$L(IIi)-7+Ii-55)_".......;"_%3_";"_$P(^(%TAB),"@") Q
 ..S IIi=$E(%TAB,4,6)_":"_$E(%TAB,10,12)_":"_$P(%TAB,"]",2,99),%3=$S($P(@(%NAM_"(%TAB)"),"@",24)="S":"СписоК",$P(@$ZR,"@")["ГОТОВ":"СводкА",1:"      ")
 .Q:%TAB["."  S %3=$$TIP^%ZAPM.bs.BS($P(@(%NAM_"(%TAB)"),"@",17)),i=i+1,^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)="@@1@"_Ii_"@@@@3,1@1@"_$P(%BS,"!",5)_"@@@@@·­± ~"_%TAB_$J("",18-$L(%TAB)-7+Ii-77)_".......;"_%3_";"_$P(^(%TAB),"@")
 K HIDD,IIi,Ii,Iii K:$D(^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",i)) @$ZR,^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15),i) S ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@@1@1@@@@@@@@1",se=i,ke=1
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
TABE I $D(%BS(8)),$D(%VGI),$D(%BS(8,%VGI)) D UCI^%ZAPM.bs.BSH(%BS(8,%VGI),%VGI) G EXIT:'YES
 I $D(TABLfind) G TAB
 I R1=27!(ny=1) K ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G RAZD
 S %BsR=%NAM,(BST,%BsT)=$P($P(d,"~",2)," ")
 I %NAM="^%ZAPM.bs.BSbufS" S %BsT="^["""_$P(BST,":")_""":"""_$P(BST,":",2)_"""]"_$P(BST,":",3,99)
EX I $D(%BsR),$D(%BsT) S %File=%BsT_","_$P(%BsR,"^",2)_","_$P($$ZU^%ZAPM.bs.BS3(0),",")_","_$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 K ^%ZAPM.bs.BSbufB("Tt"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("Rt"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("ftT"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G EXIT
PRO I $ZE["<PROT" S $ZT="PRO^%ZAPM.bs.BS" G RAZPR
 S ls=$ZE D O^%ZAPM.bs.BSF7 G RAZPR
D G 0^%ZAPM.bs.BSTM
EXIT D QQQ^%ZAPM.bs.BSN("") Q
e Q
PPP(%NAM) I $P($G(@%NAM),"@")="BaSe MsW " Q "par"
 Q "·­±"
]]></Routine>


<Routine name="%ZAPM.bs.BSD1" type="MAC" languagemode="0"><![CDATA[
%BSD1 ;DDP идеология ; 11:11   29.04.99
 Q
O(%NAM) ;СЛЕДЮЩИЙ РАЗДЕЛ
 S %zT=$ZT,$ZT="OOER^%ZAPM.bs.BSD1" X $G(WA)
 I $ZV["Cach"||($ZV["IRIS") F  S %NAM=$$O^%ZAPM.bs.BSCp(%NAM) G:%NAM="" OQ I $P($G(@%NAM),"@")="BaSe MsW ",$P($G(@$ZR),"@",3)="",$$OU($P(%NAM,"^",2)) G OQ
 I '$D(%BS("Tmp",4)) F  S %NAM=$O(@%NAM) G:%NAM="" OQ S %NAM="^"_%NAM I $P($G(@%NAM),"@")="BaSe MsW ",$P($G(@$ZR),"@",3)="",$$OU($P(%NAM,"^",2)) G OQ
 I $D(%BS("Tmp",4)) F  S %NAM=$O(@%BS("Tmp",6)@(%NAM)) G:%NAM="" OQ I $$OOO(%NAM) G OQ
OQ Q %NAM
OQUIT Q ""
OOER S $ZT=$G(%zT) Q ""
OOO(%NAM) S %zT=$ZT,$ZT="OOER^%ZAPM.bs.BSD1"
 I $P($G(@%NAM),"@")="BaSe MsW ",$P($G(@$ZR),"@",3)="",$$OU($P(%NAM,$E(%BS("Tmp",5),2),+%BS("Tmp",5))) Q 1
 Q 0
OU(N) I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),"*")),'$D(@%BS(18)@(%BS(37),%BS("Tmp",1),%BS("Tmp",2),N)) Q 0
 Q 1
OBD(%NAM) ;СЛЕДЮЩИЙ ИМЕННОЙ КЛЮЧ
 S %zT=$ZT,$ZT="OOER^%ZAPM.bs.BSD1" X $G(WA)
 I $ZV["Cach"||($ZV["IRIS") N GLL S GLL=$P(%NAM,"]",2,999) F  S GLL=$$O^%ZAPM.bs.BSCp(GLL) G:GLL="" OQUIT S %NAM="^"_GLL I %NAM[("^"_$P(BSD,"]",2)),$P($G(@%NAM),"@")="BSD - MSW" D OBDDP(%NAM)
 I '$D(%BS("Tmp",4)) F  S %NAM=$O(@%NAM) G:%NAM="" OQ S %NAM="^"_%NAM I %NAM[("^"_$P(BSD,$$ver^%ZAPM.bs.BSF9(2),2)),$P($G(@%NAM),"@")="BSD - MSW" D OBDDP(%NAM)
 I $D(%BS("Tmp",4)) F  S %NAM=$O(@($P(BSD,"]")_"]BSdirddp")@(%NAM)) G:%NAM="" OQ I %NAM[BSD,$P($G(@%NAM),"@")="BSD - MSW" D OBDDP(%NAM)
OBDQ Q %NAM
OBDDP(%NAm) S i=i+1,ii=$P(%NAm,$P(BSD,$$ver^%ZAPM.bs.BSF9(2),2),2)
 S ^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)=LineT_ii_"@@@@"_$P(@%NAm,"@",4),ii3=1
 Q
TAB(K,T) ;ТАБЛИЦА ИЗ ОПИСАНИЯ КЛЮЧЕЙ
 I '$$Data^%ZAPM.bs.BSF12(T) Q 0
 N Ui S @K=@T,$P(@K,"@",17)=1,$P(@K,"@",16)=1,@K@(1,1)=@T@(1,1)
 S @K@(2,1)=@T@(2,1),@K@(3,1)=$G(@T@(3,1),$G(@T@(2,1),@T@(1,1))),$P(@$ZR,"@",3)="",$P(@$ZR,"@",8)=0
 S LineT=$P(@T@(1,1),"@",1,15),$P(LineT,"@",15)=""
 S k14=$P(@K@(2,1),"@",14),$P(@K@(2,1),"@",14)=""
 I $D(@T@("FTR",3,1)) S @K@("FTR",3,1)=@T@("FTR",3,1),$P(LineT,"@",8)="3,1" I kd1 S @K@("FTR",3,1)=@K@("FTR",3,1)_" I $P(BS,""@"",19)'="""" S d1=d1_$$KeyTime^%ZAPM.bs.BSsFUNR(BS)"
 I $D(@T@("RTR",3,1)) S @K@("RTR",3,1)=@T@("RTR",3,1)
 N Ui I $P(@K,"@",12)'="" S $P(@K,"@",12)="X MRMR"
 I $D(@T@("AF2")) S @K@("AF2")=@T@("AF2")
 I $P(@K,"@",13)'="" S $P(@K,"@",13)=1
 I $P(@K,"@",15)'="" S $P(@K,"@",15)="%FKR^%ZAPM.bs.BST1"
 S $P(@$ZR,"@",25)=1,$P(@$ZR,"@",39)=$S(k20="":"^%ZAPM.bs.BSHLP(KEY_BD",1:k20)
 S Ui=$P($$IYI^%ZAPM.bs.BSF10(IMQ),"@",41) I Ui["TreeCopy^%ZAPM.bs.BSF10" Q 1
 S $P(@K,"@",41)="TreeCopy^%ZAPM.bs.BSF10"_$S(Ui'="":","_Ui,1:"") Q 1
KW K @$NA(@"^%ZAPM.bs.BSbufB"@("Video"_$G(%BS(3),$P)_$J_"u1",IMQ)) Q
SW(key) ;СОХРАНИТЬ ЭКРАН ДЛЯ КЛЮЧА
 d SaveWinV^%ZAPM.bs.BSXfun(1,1,25,80,$NA(@"^%ZAPM.bs.BSbufB"@("Video"_$G(%BS(3),$P)_$J_"u1",IMQ,key)),1) Q
LW(key) ;ВОССТАНОВИТЬ ЭКРАН ДЛЯ КЛЮЧА
 I $D(@$NA(@"^%ZAPM.bs.BSbufB"@("Video"_$G(%BS(3),$P)_$J_"u1",IMQ,key))) d LoadWinV^%ZAPM.bs.BSXfun($NA(@"^%ZAPM.bs.BSbufB"@("Video"_$G(%BS(3),$P)_$J_"u1",IMQ,key)),1)
 Q
DDPVOL ;ТОМА
 Q:'$D(@%BS(18)@(%BS(37),1))  N d1,d2,d3
 S d1=""
 F  S d1=$O(@%BS(18)@(%BS(37),1,d1)) Q:d1=""  D UCIDDP(d1)
 Q:'$D(d2)  S d1=""
 F  S d1=$O(d2(d1)) Q:d1=""  D SYS(d1) S d3="" F  S d3=$O(d2(d1,d3)) Q:d3=""  D UCI(d3)
 Q
UCIDDP(us) ;ПОИСК ^BSdirddp
 N bsd
 Q:$$ZU^%ZAPM.bs.BS3($P(us,","),$P(us,",",2))
 S %zT=$ZT,$ZT="ER1^%ZAPM.bs.BSD1"
 S bsd=$$DDPGLO(us) I '$D(@bsd) G UCIQ
 S d2($P(us,",",2),$P(us,","))=bsd
UCIQ S $ZT=$G(%zT) Q
DDPGLO(us) Q $$DDPGL(us)_"BSdirddp"
DDPGL(us) Q "^["""_$P(us,",")_""","""_$P(us,",",2)_"""]"
SYS(I) N B ;ТОМ
 S j=j+1,^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,j)="@@1@9@@@@2,1@1@"_$P(%BS,"!",4)_"@@@@@"_I
 S i=2,B="???" I $O(d2(d1,""))'="" S B=d2(d1,$O(d2(d1,""))),B=$P($P($G(@B),"@",2),",",2)
 S ^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,j)="@@1@9@@@@@1@@@@@@ ddp-"_B
 Q
UCI(J) ;КИП
 S i=i+1,^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)="@@1@9@@@@2,1@1@"_$P(%BS,"!",5)_"@@@@@"_d3
 S:se<i se=i S:ke<j ke=j
 Q
ER1 G UCIQ
NEWDIR ;НОВЫЙ DDP КАТАЛОГ
 N PRO,%NAM,WA,COMD I '$$RP^%ZAPM.bs.BSGCH("^BSdirddp") Q  ;МЫ В RVG
 Q:'$G(%BS(23))  D L^%ZAPM.bs.BS3("^BSdirddp")
 S COMD=$P($G(^BSdirddp,"..."),"@") K ^BSdirddp
 S %NAM="^",^BSdirddp=COMD_"@"_$$ZU^%ZAPM.bs.BS3(1,0) D Wait^%ZAPM.bs.BSXfun("Создаю DDP каталог")
 F  S %NAM=$O(@%NAM) Q:%NAM=""  S %NAM="^"_%NAM X $G(WA) D NEWDI
 D CP^%ZAPM.bs.BSGCH("^BSdirddp","4334")
NEWQ S $ZT=$G(%zt) D U^%ZAPM.bs.BS3("^BSdirddp") Q
NEWDI S %zt=$ZT,$ZT="ER2^%ZAPM.bs.BSD1"
 S PRO=$$RP^%ZAPM.bs.BSGCH(%NAM) I +PRO>1,$E(PRO,2)>1 S ^BSdirddp($$DDPGL($$ZU^%ZAPM.bs.BS3(0))_$P(%NAM,"^",2))=""
NEWDQ Q
ER2 G NEWQ
PST(P) N uc,Pddp
 I P["%BSbufB" S %w(6,1)="%BSbufB",%w(6,2)=$P($$ZU^%ZAPM.bs.BS3(1,0),","),%w(6,3)=$P($$ZU^%ZAPM.bs.BS3(1,0),",",2) Q
 D PS(P) S %w(6,1)=Pddp,%w(6,2)=%BS("Tmp",2),%w(6,3)=%BS("Tmp",1) Q
PS(P) ;РАСЩЕПЛЕНИЕ ССЫЛОК
 I P'[$$ver^%ZAPM.bs.BSF9(2) S %BS("Tmp",1)=$P($$ZU^%ZAPM.bs.BS3(0),",",2),(uc,%BS("Tmp",2))=$P($$ZU^%ZAPM.bs.BS3(0),","),Pddp=$P(P,"^",2) G PSQ
 ;4.;I P["|" D  G PSQ
 .I $P(P,"|",2)["," S %BS("Tmp",1)=$P(P,$C(34),4),(uc,%BS("Tmp",2))=$P(P,$C(34),2),Pddp=$P(P,"|",3) Q
 .E  S (uc,%BS("Tmp",2))=$P(P,$C(34),2),Pddp=$P(P,"|",3),%BS("Tmp",1)=$P($$ZU^%ZAPM.bs.BS3(0),",",2) Q
 I $P(P,"]")["," S %BS("Tmp",1)=$P(P,$C(34),4),(uc,%BS("Tmp",2))=$P(P,$C(34),2),Pddp=$P(P,"]",2)
 E  S (uc,%BS("Tmp",2))=$P(P,$C(34),2),Pddp=$P(P,"]",2),%BS("Tmp",1)=$P($$ZU^%ZAPM.bs.BS3(0),",",2)
PSQ I '$$ZU^%ZAPM.bs.BS3(%BS("Tmp",2),%BS("Tmp",1)) S %BS("Tmp",2)=%BS("Tmp",2)_","_%BS("Tmp",1),%BS("Tmp",1)=1
 Q
GDE(us) ;us="[""UCI"",""SYS""]"
 N UC,SY,d2
 S us=$TR(us,"[]""|",""),UC=$P(us,","),SY=$P(us,",",2)
 Q:$$ZU^%ZAPM.bs.BS3(UC,SY) $$ZU^%ZAPM.bs.BS3(UC,SY) ;СМОНТИРОВАН us
 D UCIDDP(us) I $D(d2) Q "DDP"
 Q ""
]]></Routine>


<Routine name="%ZAPM.bs.BSD2" type="MAC" languagemode="0"><![CDATA[
%BSD2 ; СТОППОР %BS  ; 10:18   15.02.2000
 Q
S D M,BUY S (%BSssdO,AUTO)=2 G SSD ;ОСТАНОВ БЕЗУСЛОВНЫЙ
SS D M,BUY S (%BSssdO,AUTO)=1 G SSD ;ОСТАНОВ ЕСЛИ НЕТ АКТИВНЫХ ЛИНИЙ DDP
M G MGR^%ZAPM.bs.BS
SSD I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 D M N YYY
 S YYY=$P($P($G(^%ZAPM.bs.BSETUP("SERVER",6,4)),"@",15),"\",4) I YYY'="N" D CLEAR
 I $D(%BS)["0" D LV^%ZAPM.bs.BSF4 ;ОСТАНОВ СО ВСЕМИ ОСТАНОВКАМИ
 I $G(^%ZAPM.bs.BSS("XECUTE","KEY"))'="" D XEC^%ZAPM.bs.BSF10($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""XECUTE"")"),9)
 D Int^%ZAPM.bs.BSERV("D KILLS^%ZAPM.bs.BSERVER(G,S)") G:$G(%BSssdO)=2 SSSD
 U 0::%BS(32) D CHECK W $$atr^%ZAPM.bs.BS3(0) I YES<1 S Tmp="" Q
 D OP^%ZAPM.bs.BSF4 D CHEKPRN^%ZAPM.bs.BSJPRN I YES<1 S Tmp="" Q
SSSD D ERASER^%ZAPM.bs.BSJPRN(1),ALLKILLB^%ZAPM.bs.BS1
 I $$4() D CONTINUE^SSD
 G ^SSD
BUY W !!!!!!!!!!!!,"До Свидания.. ",$G(%BS(38)) Q
4() Q $P($ZV,"Version ",2)'<4
CHECK 
 N CIR,CIRNAME,CIRSTA,EADR,I,ID,J,LCB,LNK,LNKSTA,PROTN,RTYTM,SV,UPDATE,VG,X
 D VERIFDDP
 S YES=1 I $G(VG)="" Q
 D CHECKDDP("ALL") Q
CHECKDDP(V) ;V-НОМЕР ГРУППЫ ТОМОВ
 Q:'%BS(23)  D EnterP^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""SSD"",""BUT"")") S YES=$S(d=1&(R1=13):1,1:0)
 I YES,$E(%BS(1),6)=1 S YES=0 D EnterP^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""MSM-SERVER"",""BUT"")") S YES=$S(d=1&(R1=13):1,1:0) I YES D PASCHECK^%ZAPM.bs.BS1("^%ZAPM.bs.BSETUP","SETUP",2,"Введите пароль Администратора Системы","Tmp") I YES W # Q
 Q
PA D DosRead^%ZAPM.bs.BSS1(51,$$AddFile^%ZAPM.bs.BSDOS2($$DIR^%ZAPM.bs.BSMSMF_"%BS-FULL.XXX")) Q:'$D(%FN)
 X "U %DEV R R X R H  "
 Q
VERIFDDP ;ПРОВЕРКА АКТИВНОСТИ DDP
 W #,$$clr^%ZAPM.bs.BS3(10)
 I $$4() N (VG) S ID=2,UPDATE=1 D CIRSTA^DDPCIR Q
 N (VG) S UPDATE=1,ID=1,SV=33566904 D CIRSTA^DDPCIR
 Q
CLEAR ;ЗАЧИСТКА ДО DKFUL
 I $ZV["Cach"||($ZV["IRIS") Q
 G CLE:YYY="A" I "Y"[YYY D Yes^%ZAPM.bs.BSXfun("Будем затирать мусор на томе "_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_" ?",2) I YES>0 G CLE
 Q
CLE N zS,zJ,zM
 I $ZV["Cach"||($ZV["IRIS") Q
 S $ZT="END^%ZAPM.bs.BSD2",zM="^cccccccc" W !,"WipeInfo in "_$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 S zS=$TR($J("",$$LNG^%ZAPM.bs.BSF12)," ","c") F zJ=1:1 S @zM@(zJ)=zS I '(zJ#100) W "."
 Q
END K @zM
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSDIA" type="MAC" languagemode="0"><![CDATA[
%BSDIA ;ОБРАБОТКА ДИАЛОГОВОЙ ПАНЕЛИ ```(А.Нефедов) ; 16:56 10-JUN-98
DoDIAL ;ВХОД В ДИАЛОГОВУЮ ПАНЕЛЬ
 ;N CVVCVVXCVXCVNM,CVMXCVNM, !!!!
 D ^%ZAPM.bs.BSDIAL ; Регистрация стандартных классов.
 I $D(@BSR@(BST,"Dial"))
 D ExecDlg^%ZAPM.bs.BSDIAL($ZR,"DialTmp")
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSDIAL" type="MAC" languagemode="0"><![CDATA[
%BSDIAL ;``` (А.Нефедов) ; 16:57 10-JUN-98
 ;
 S SystemMSG=0,UserMSG=1000
 S MSGCreate=SystemMSG+1
 S MSGDestroy=SystemMSG+2
 S MSGPaint=SystemMSG+3
 S MSGKeyPress=SystemMSG+4
 S MSGChFocus=SystemMSG+5
 S MSGSetCursor=SystemMSG+6
 S MSGUnCheck=SystemMSG+7
 S MSGIdle=SystemMSG+8
 S MSGDelCtrl=SystemMSG+9
 S MSGCrFcs=SystemMSG+10
 S MSGAddCtrl=SystemMSG+11
 S MSGGetCtrl=SystemMSG+12
 S ControlFunc("TDialog")="DialogFunc"
 S ControlFunc("TControl")="CtrlFunc"
 S ControlFunc("TLabel")="LabelFunc"
 S ControlFunc("TButton")="ButtonFunc"
 S ControlFunc("TCheck")="CheckBut"
 S ControlFunc("TRadio")="RadioBut"
 S ControlFunc("TEdit")="EditFunc"
 S ControlFunc("TClock")="ClockFunc"
 ;
 ; Now, we have to declare basic class
 ;
 ; ClassName@Left@Top@Width@Height@Text@Enable@Visible@Color@Hint@HintColor@
 ; 1         2    3   4     5      6    7      8       9     10   11
 ; Alight@Focused@TabStop@TabOrder@CursorDef@EmptyChar@ForeColor@BackColor@
 ; 12     13      14      15       16           17        18        19
 ; FocusColor@ShadowColor1@ShadowColor2@Control1@Command@GroupNum@CanClose
 ; 20         21           22           23       24      25       26
 ; CursorDef1@CommitKey@ExMode@Control2@BackUpText
 ; 27         28        29     30       31
 ;
 D ^%ZAPM.bs.BSDIAL1
 Q
 
ExecDlg(DlgName,Name) 
 N R1,R2,R3,ComKey,Flag
 N Temp
 S R2=-1,R3=-1
 S ExecName=Name
 D Copy^%ZAPM.bs.BSF8(DlgName,Name)
 S $P(@Name,"@",7)=1
 D SendMessage(Name,MSGCreate)
 D SendMessage(Name,MSGPaint)
WHILE 
 S ComKey=$P(@Name,"@",28) S:ComKey="" ComKey=13
 D CL^%ZAPM.bs.BSF4
 F  R *R1:1 R:R1=27 *R2:0,*R3:0 D:(R1=-1) SendMessage(Name,MSGIdle) Q:(R1'=-1)!($P(Name,"@",7)=0)
 I ($P(@Name,"@",29)=1)&(R1=153) D
 .S ls="Read pattern again ?" D YES^%ZAPM.bs.BSF
 .D:YES=1
 ..D Copy^%ZAPM.bs.BSF8(DlgName,Name)
 ..S $P(@Name,"@",7)=1
 ..S $P(@Name,"@",29)=1
 ..D SendMessage(Name,MSGDestroy)
 ..D SendMessage(Name,MSGCreate)
 ..D SendMessage(Name,MSGPaint)
 ..Q
 .Q
 I ($P(@Name,"@",29)=1)&(R1=161) D
 .S ls="Write pattern ?" D YES^%ZAPM.bs.BSF D:YES=1
 ..D Copy^%ZAPM.bs.BSF8(Name,DlgName)
 ..Q
 .Q
 D:(R1'=-1) SendMessage(Name,MSGKeyPress,R1,R2,R3)
 S:$P(@Name,"@",7)=0 R1=ComKey
 G:R1'=ComKey&((R1'=27)!((R2'=-1)!(R3'=-1))) WHILE
 S Flag=1
 I (R1=ComKey) D
 .S Temp=$P(@Name,"@",26)
 .I (Temp'="")  I @(Temp_"=0") S Flag=0,$P(@Name,"@",7)=1 Q
 .S Temp=$P(@Name,"@",24)
 .X:Temp'="" Temp
 .Q
 G:Flag=0 WHILE
 D SendMessage(Name,MSGDestroy)
 K Temp
 K R1,R2,R3,ComKey,Flag
 D OP^%ZAPM.bs.BSF4
 Q
 
DoneDlg ;
 S $P(@ExecName,"@",7)=0
 Q
 
SendChil(Name,Message,Param1,Param2,Param3) 
 N Child,Name1
 S:$D(Param1)=0 Param1=""
 S:$D(Param2)=0 Param2=""
 S:$D(Param3)=0 Param3=""
 S Child=$O(@Name@(""))
 F  Q:Child=""  D
 .I $F(Name,")")=0 S Name1=Name_"("
 .S:'$T Name1=$E(Name,1,$L(Name)-1)_","
 .S Name1=Name1_""""_Child_""""_")"
 .D SendMessage(Name1,Message,.Param1,.Param2,.Param3)
 .S Child=$O(@Name@(Child))
 .Q
 K Child,Name1
 Q
 
SendGrou(Name,Message,Param1,Param2,Param3) 
 Q:$F(Name,"(")=0
 N Child,Name1,Temp1,Temp2
 S:$D(Param1)=0 Param1=""
 S:$D(Param2)=0 Param2=""
 S:$D(Param3)=0 Param3=""
 S Temp1=0,Temp2=1
 F  S Temp1=Temp2,Temp2=$F(Name,",",Temp2) Q:Temp2=0
 I Temp1'=1 S Name=$E(Name,1,Temp1-2)_")"
 S:'$T Name=$E(Name,1,$F(Name,"(")-2)
 S Child=$O(@Name@(""))
 F  Q:Child=""  D
 .I $F(Name,")")=0 S Name1=Name_"("
 .S:'$T Name1=$E(Name,1,$L(Name)-1)_","
 .S Name1=Name1_""""_Child_""""_")"
 .D SendMessage(Name1,Message,.Param1,.Param2,.Param3)
 .S Child=$O(@Name@(Child))
 .Q
 K Child,Name1,Temp1,Temp2
 Q
 
SendMess(Name,Message,Param1,Param2,Param3) 
 N ClassName,FuncName
 S:$D(Param1)=0 Param1=""
 S:$D(Param2)=0 Param2=""
 S:$D(Param3)=0 Param3=""
 S ClassName=$P(@Name,"@")
 S FuncName=$G(ControlFunc(ClassName))
 D:FuncName'="" @(FuncName)(Name,Message,.Param1,.Param2,.Param3)
 K ClassName,FuncName
 Q
 
ParentCo(Parent,Name,Message,Param1,Param2,Param3) 
 N ClassName,FuncName
 S:$D(Param1)=0 Param1=""
 S:$D(Param2)=0 Param2=""
 S:$D(Param3)=0 Param3=""
 S ClassName=Parent
 S FuncName=$G(ControlFunc(ClassName))
 D:FuncName'="" @(FuncName)(Name,Message,.Param1,.Param2,.Param3)
 K ClassName,FuncName
 Q
 
DialogFu(Name,Message,Param1,Param2,Param3) 
 N X,Y,StartX,StartY,EndX,EndY,Char,Z,Temp
 I Message=MSGCreate D
 .D SA^%ZAPM.bs.BSsBUF W $$atr^%ZAPM.bs.BS3(0)
 .S $P(@Name,"@",29)=0
 .D SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .S Param1=1
 .D SendChildren(Name,MSGCrFcs,.Param1,0)
 .S $P(@Name,"@",30)=Param1
 .D SendChildren(Name,MSGChFocus,1,0)
 .Q
 I Message=MSGDestroy D
 .D SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .S $P(@DlgName,"@",29)=0
 .D RE^%ZAPM.bs.BSsBUF W $$atr^%ZAPM.bs.BS3(0)
 .Q
 I $P(@Name,"@",8)=1&(Message=MSGPaint) D
 .D RE^%ZAPM.bs.BSsBUF W $$atr^%ZAPM.bs.BS3(0)
 .D SA^%ZAPM.bs.BSsBUF W $$atr^%ZAPM.bs.BS3(0)
 .S StartX=$P(@Name,"@",2),StartY=$P(@Name,"@",3)
 .S EndX=StartX+$P(@Name,"@",4),EndY=StartY+$P(@Name,"@",5)
 .S Char=$P(@Name,"@",17)
 .W $$Color($P(@Name,"@",18),$P(@Name,"@",19)),/CUP(StartY,StartX),"-"
 .F X=StartX+1:1:EndX-1 W "-"
 .W "-" ;$$Color($P(@Name,"@",21),$P(@Name,"@",22)),"_"
 .F Y=StartY+1:1:EndY-1 D
 .. W /CUP(Y,StartX),$$Color($P(@Name,"@",18),$P(@Name,"@",19)),"|"
 ..F X=StartX+1:1:EndX-1 W Char
 ..W "|",$$Color($P(@Name,"@",21),$P(@Name,"@",22)),"¶"
 ..Q
 .W /CUP(EndY,StartX),$$Color($P(@Name,"@",18),$P(@Name,"@",19)),"-"
 .F X=StartX+1:1:EndX-1 W "-"
 .W "-",$$Color($P(@Name,"@",21),$P(@Name,"@",22)),"¶",/CUP(EndY+1,StartX+1)
 .F X=StartX:1:EndX W "®"
 .W $$Color($P(@Name,"@",18),$P(@Name,"@",19))
 .S Char=" "_$P(@Name,"@",6)_" ";
 .S:$P(@Name,"@",29)'=0 Char=Char_"[EditMode]"
 .S X=EndX-StartX,Y=$L(Char)
 .I Y>X S Char=$E(Char,1,X-1),Y=X-1
 . W /CUP(StartY,StartX+((X-Y)\2)),Char
 .D SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .D SendChildren(Name,MSGSetCursor)
 .Q
 I Message=MSGKeyPress D
 .D SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .D:$P(@Name,"@",29)=0 SendChildren(Name,MSGSetCursor)
 .Q
 I (Message=MSGKeyPress)&($P(@Name,"@",29)'=0) D EditMode^%ZAPM.bs.BSDIAL1(Name,.Param1,.Param2,.Param3)
 I (Message=MSGKeyPress)&((Param1=9)!(Param1=15)!((Param1=27)&(Param2=91)&(Param3>64)&(Param3<69))) D
 .I (Param1=9)!(Param3=67)!(Param3=66) S Y=1
 .S:'$T Y=-1
 .S Z=$P(@Name,"@",15),X=$P(@Name,"@",15)+Y
 .S:X<0 X=$P(@Name,"@",30)-1
 .S:X=$P(@Name,"@",30) X=0
 .S $P(@Name,"@",15)=X
 .D SendChildren(Name,MSGChFocus,X,$P(@Name,"@",29))
 .D:X=0
 ..S Char=$P(@Name,"@",10),X=$L(Char)
 ..F Y=1:1:(80-X)/2 S Char=" "_Char_" "
 ..W /CUP(24,1),$$Color($P(@Name,"@",11)),Char
 ..Q
 .D:(Z=0)!($P(@Name,"@",15)=0)
 ..S StartX=$P(@Name,"@",2),StartY=$P(@Name,"@",3)
 ..S EndX=StartX+$P(@Name,"@",4),EndY=StartY+$P(@Name,"@",5)
 ..W:X=0 $$Color($P(@Name,"@",20),$P(@Name,"@",19))
 ..W:X'=0 $$Color($P(@Name,"@",18),$P(@Name,"@",19))
 ..S Char=" "_$P(@Name,"@",6)_" "
 ..S:$P(@Name,"@",29)'=0 Char=Char_"[EditMode]"
 ..S X=EndX-StartX,Y=$L(Char)
 ..I Y>X S Char=$E(Char,1,X-1),Y=X-1
 ..W /CUP(StartY,StartX+((X-Y)\2)),Char
 ..Q
 .D SendChildren(Name,MSGSetCursor)
 .Q
 I (Message=MSGKeyPress)&(Param1=33) D
 .S $P(@Name,"@",29)=1-$P(@Name,"@",29)
 .S Param1=1
 .D SendChildren(Name,MSGCrFcs,.Param1,$P(@Name,"@",29))
 .S $P(@Name,"@",30)=Param1
 .S $P(@Name,"@",15)=1
 .D SendChildren(Name,MSGChFocus,1,$P(@Name,"@",29))
 .D SendMessage(Name,MSGPaint)
 .Q
 I Message=MSGIdle D
 .D SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .Q
 I Message=MSGDelCtrl D
 .D SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .S Param1=1
 .D SendChildren(Name,MSGCrFcs,.Param1,1)
 .S $P(@Name,"@",30)=Param1
 .S $P(@Name,"@",15)=1
 .D SendChildren(Name,MSGChFocus,1,$P(@Name,"@",29))
 .D SendMessage(Name,MSGPaint)
 .Q
 I Message=MSGAddCtrl D
 .S Temp=Param1
 .F X=1:1:20 Q:$D(@Name@(Temp_X))=0
 .;M @Name@(Temp_X)=@Param2
 .D Copy^%ZAPM.bs.BSF8(Param2,$NA(@Name@(Temp_X)))
 .S Param1=1
 .D SendChildren(Name,MSGCrFcs,.Param1,1)
 .S $P(@Name,"@",30)=Param1
 .S $P(@Name,"@",15)=1
 .D SendChildren(Name,MSGChFocus,1,$P(@Name,"@",29))
 .D SendMessage(Name,MSGPaint)
 .Q
 I Message=MSGGetCtrl D
 .I $P(@Name,"@",15)=0 S Param1=Name
 .D:'$T SendChildren(Name,Message,.Param1,.Param2,.Param3)
 .Q
 K X,Y,StartX,StartY,EndX,EndY,Char,Z,Temp
 Q
 
LabelFun(Name,Message,Param1,Param2,Param3) 
 D ParentControl("TControl",Name,Message,.Param1,.Param2,.Param3)
 Q:Message=MSGDelCtrl
 N StartX,StartY,Char,AType,Temp
 I $P(@Name,"@",8)=1&(Message=MSGPaint) D
 .S StartX=$P(@Name,"@",2),StartY=$P(@Name,"@",3)
 .S Char=$P(@Name,"@",6)
 .S Temp=0
 .S AType=$P(@Name,"@",12)
 .D:AType=3
 ..S Temp=($P(@Name,"@",4)-$L(Char))\2 S:Temp<0 Temp=0
 ..Q
 .D:AType=1
 ..S Temp=0
 ..Q
 .D:AType=2
 ..S Temp=$P(@Name,"@",4)-$L(Char) S:Temp<0 Temp=0
 ..Q
 .S StartX=StartX+Temp
 .S $P(@Name,"@",16)=StartX
 .W /CUP(StartY,StartX),Char
 .S $P(@Name,"@",27)=$X
 .Q
 I (Message=MSGSetCursor)&($P(@Name,"@",13)=1) D
 .W /CUP($P(@Name,"@",3),$P(@Name,"@",16))
 .Q
 K StartX,StartY,Char,AType,Temp
 Q
 
ButtonFu(Name,Message,Param1,Param2,Param3) 
 D ParentControl("TLabel",Name,Message,.Param1,.Param2,.Param3)
 Q:Message=MSGDelCtrl
 N Temp,StartX,StartY,EndX,EndY,IsPress,ComKey
 I Message=MSGPaint D
 .S IsPress=$P(@Name,"@",23),Temp=" "
 .S:IsPress'=1 Temp="®"
 .S StartX=$P(@Name,"@",2),StartY=$P(@Name,"@",3)
 .S EndX=StartX+$P(@Name,"@",4),EndY=StartY+$P(@Name,"@",5)
 .W /CUP(EndY-1,EndX),$$Color($P(@Name,"@",21),$P(@Name,"@",22))
 .W:IsPress'=1 "_"
 .W /CUP(StartY+1,StartX+1),$TR($J("",$P(@Name,"@",4))," ",Temp)
 .W:IsPress=1 /CUP(StartY,StartX-1)," ",/CUP(StartY+1,StartX)," "
 .Q
 S ComKey=$P(@DlgName,"@",28) S:ComKey="" ComKey=32
 I $P(@Name,"@",13)=1&(Message=MSGKeyPress)&(Param1=ComKey) D
 .S $P(@Name,"@",23)=1
 .S StartX=$P(@Name,"@",2),$P(@Name,"@",2)=StartX+1
 .D SendMessage(Name,MSGPaint)
 .W $$rt^%ZAPM.bs.BS3(0.7)
 .S $P(@Name,"@",2)=StartX
 .S $P(@Name,"@",23)=0
 .D SendMessage(Name,MSGPaint)
 .S Temp=$P(@Name,"@",24)
 .X:Temp'=0 Temp
 .Q
 I (Message=MSGSetCursor)&($P(@Name,"@",13)=1) D
 .W /CUP($P(@Name,"@",3),$P(@Name,"@",16))
 .Q
 K Temp,StartX,StartY,EndX,EndY,IsPress,ComKey
 Q
 
CheckBut(Name,Message,Param1,Param2,Param3) 
 D ParentControl("TLabel",Name,Message,.Param1,.Param2,.Param3)
 Q:Message=MSGDelCtrl
 N Temp,StartX,StartY,EndX,EndY,IsChecked,ComKey,Char
 I Message=MSGCreate D
 .S Temp=" "
 .S:$P(@Name,"@",23)=1 Temp="X"
 .S Char=$P(@Name,"@",6)
 .S $P(@Name,"@",6)=$E(Char,1,$F(Char,"[")-1)_Temp_$E(Char,$F(Char,"]")-1,$L(Char))
 .Q
 S ComKey=$P(@DlgName,"@",28) S:ComKey="" ComKey=32
 I $P(@Name,"@",13)=1&(Message=MSGKeyPress)&(Param1=ComKey) D
 .S IsChecked=$P(@Name,"@",23)
 .S:IsChecked="" IsChecked=0
 .S IsChecked=1-IsChecked
 .S $P(@Name,"@",23)=IsChecked
 .S Temp=" "
 .S:IsChecked Temp="X"
 .S Char=$P(@Name,"@",6)
 .S $P(@Name,"@",6)=$E(Char,1,$F(Char,"[")-1)_Temp_$E(Char,$F(Char,"]")-1,$L(Char))
 .D SendMessage(Name,MSGPaint)
 .Q
 I (Message=MSGSetCursor)&($P(@Name,"@",13)=1) D
 .W /CUP($P(@Name,"@",3),$P(@Name,"@",16)+$F($P(@Name,"@",6),"[")-1)
 .Q
 K Temp,StartX,StartY,EndX,EndY,IsChecked,ComKey,Char
 Q
 
RadioBut(Name,Message,Param1,Param2,Param3) 
 D ParentControl("TLabel",Name,Message,.Param1,.Param2,.Param3)
 Q:Message=MSGDelCtrl
 N Temp,StartX,StartY,EndX,EndY,IsChecked,ComKey,Char
 I Message=MSGCreate D
 .S Temp=" "
 .S:$P(@Name,"@",23)=1 Temp="*"
 .S Char=$P(@Name,"@",6)
 .S $P(@Name,"@",6)=$E(Char,1,$F(Char,"(")-1)_Temp_$E(Char,$F(Char,")")-1,$L(Char))
 .Q
 S ComKey=$P(@DlgName,"@",28) S:ComKey="" ComKey=32
 I $P(@Name,"@",13)=1&(Message=MSGKeyPress)&(Param1=ComKey) D
 .S IsChecked=1 ;This is a radiobutton
 .S $P(@Name,"@",23)=IsChecked
 .S Temp="*"
 .S Char=$P(@Name,"@",6)
 .S $P(@Name,"@",6)=$E(Char,1,$F(Char,"(")-1)_Temp_$E(Char,$F(Char,")")-1,$L(Char))
 .D SendMessage(Name,MSGPaint)
 .D SendGroup(Name,MSGUnCheck,$P(@Name,"@",25));
 .Q
 I $P(@Name,"@",25)=Param1&(Message=MSGUnCheck)&($P(@Name,"@",13)'=1) D
 .S IsChecked=0 ;This is a radiobutton
 .S $P(@Name,"@",23)=IsChecked
 .S Temp=" "
 .S Char=$P(@Name,"@",6)
 .S $P(@Name,"@",6)=$E(Char,1,$F(Char,"(")-1)_Temp_$E(Char,$F(Char,")")-1,$L(Char))
 .D SendMessage(Name,MSGPaint)
 .Q
 I (Message=MSGSetCursor)&($P(@Name,"@",13)=1) D
 .W /CUP($P(@Name,"@",3),$P(@Name,"@",16)+$F($P(@Name,"@",6),"(")-1)
 .Q
 K Temp,StartX,StartY,EndX,EndY,IsChecked,ComKey,Char
 Q
 
EditFunc(Name,Message,Param1,Param2,Param3) 
 D ParentControl("TLabel",Name,Message,.Param1,.Param2,.Param3)
 Q:Message=MSGDelCtrl
 N Temp,StartX,StartY,EndX,EndY
 I $P(@Name,"@",13)=1&(Message=MSGKeyPress)&((Param1>31)!(Param1=8)) D
 .S Temp=$P(@Name,"@",6)
 .I Param1=8 S:$L(Temp)>0 Temp=$E(Temp,1,$L(Temp)-1)
 .S:('$T)&($L(Temp)<$P(@Name,"@",4)) Temp=Temp_$C(Param1)
 .S $P(@Name,"@",6)=Temp
 .D SendMessage(Name,MSGPaint)
 .Q
  I (Message=MSGSetCursor)&($P(@Name,"@",13)=1) D
 .W /CUP($P(@Name,"@",3),$P(@Name,"@",27)+1)
 .Q
 K Temp,StartX,StartY,EndX,EndY
 Q
 
ClockFun(Name,Message,Param1,Param2,Param3) 
 N X,Y
 S X=$X,Y=$Y
 D ParentControl("TLabel",Name,Message,.Param1,.Param2,.Param3)
 ;I Message=MSGPaint D SendGroup(Name,MSGSetCursor)
 I Message=MSGPaint W /CUP(Y+1,X+1)
 I Message=MSGIdle D
 .S $P(@Name,"@",6)=$P($$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3())," ")
 .D SendMessage(Name,MSGPaint)
 .Q
 K X,Y
 Q
 
CtrlFunc(Name,Message,Param1,Param2,Param3) 
 Q:$P(@Name,"@",7)=0
 N Focus,Char,X,Y,StartX,StartY,Char1,F1
 I Message=MSGCreate D
 .Q
 I Message=MSGDestroy D
 .Q
 I $P(@Name,"@",8)=1&(Message=MSGPaint) D
 .S StartX=$P(@Name,"@",2),StartY=$P(@Name,"@",3)
 .S Char1=$TR($J("",$P(@Name,"@",4))," ",$P(@Name,"@",17))
 .I $P(@Name,"@",13)=1 D
 ..S Char=$P(@Name,"@",10),X=$L(Char)
 ..F Y=1:1:(80-X)/2 S Char=" "_Char_" "
 ..W /CUP(24,1),$$Color($P(@Name,"@",11)),Char
 ..W /CUP(StartY,StartX),$$Color($P(@Name,"@",20),$P(@Name,"@",19)),Char1
 ..Q
 .W:$P(@Name,"@",13)'=1 /CUP(StartY,StartX),$$Color($P(@Name,"@",18),$P(@Name,"@",19)),Char1
 .Q
 I (($P(@Name,"@",14)=1)!(Param2=1))&(Message=MSGChFocus) D
 .S Focus=0
 .I $P(@Name,"@",15)=Param1 S Focus=1
 .S F1=$P(@Name,"@",13)
 .S $P(@Name,"@",13)=Focus
 .D:F1'=Focus SendMessage(Name,MSGPaint)
 .Q
 I (($P(@Name,"@",14)=1)!(Param2=1))&(Message=MSGCrFcs) D
 .S $P(@Name,"@",15)=Param1
 .S Param1=Param1+1
 .Q
 I ($P(@Name,"@",13)=1)&(Message=MSGGetCtrl) D
 .S Param1=Name
 .Q
 I ($P(@Name,"@",13)=1)&(Message=MSGDelCtrl) D
 .K @Name
 .Q
 K Focus,Char,X,Y,StartX,StartY,Char1,F1
 Q
 
Color(ByteF,ByteB) 
 N Temp
 S Temp=0,Result=""
 S:ByteF>7 Temp=1,ByteF=ByteF-8
 S ByteF=ByteF+30
 S Result="$$atr^%ZAPM.bs.BS3("""_Temp_";"_ByteF_""")"
 D:$D(ByteB)'=0
 .S ByteB=ByteB+40
 .S Result=Result_",$$atr^%ZAPM.bs.BS3("""_ByteB_""")"
 .Q
 K Temp
 S Result="W "_Result
 X Result
 Q ""
]]></Routine>


<Routine name="%ZAPM.bs.BSDIAL1" type="MAC" languagemode="0"><![CDATA[
%BSDIAL1 ;Edit Mode for Dialog ```(А.Нефедов) ; 16:57 10-JUN-98
 
 ; Now, we have to declare basic class
 ;
 ; ClassName@Left@Top@Width@Height@Text@Enable@Visible@Color@Hint@HintColor@
 ; 1         2    3   4     5      6    7      8       9     10   11
 ; Alight@Focused@TabStop@TabOrder@CursorDef@EmptyChar@ForeColor@BackColor@
 ; 12     13      14      15       16           17        18        19
 ; FocusColor@ShadowColor1@ShadowColor2@Control1@Command@GroupNum@CanClose
 ; 20         21           22           23       24      25       26
 ; CursorDef1@CommitKey@ExMode@Control2
 ; 27         28        29     30
 ;
 K ^BSCOMMON
 ;
 S ^BSCOMMON("EMPTY")="TDialog@5@5@50@13@Dialog@1@1@0@@7@0@@@@@ @0@7@8"
 ;
 S ^BSCOMMON("PATTERNS")="TDialog@5@5@50@13@Dialog@1@1@0@@7@0@@@@@ @0@7@8"
 S ^BSCOMMON("PATTERNS","Label")="TLabel@7@7@7@1@Label@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("PATTERNS","Button")="TButton@7@9@8@1@Button@1@1@8@@7@3@@1@1@@ @7@4@15@0@7"
 S ^BSCOMMON("PATTERNS","Check")="TCheck@7@11@11@1@[ ] Check Button@1@1@8@@7@3@@1@7@@ @0@7@15@0@7@@"
 S ^BSCOMMON("PATTERNS","Radio")="TRadio@7@13@8@1@( ) Alternativ Button@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@1@@1"
 S ^BSCOMMON("PATTERNS","Edit")="TEdit@7@15@15@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("PATTERNS","Clock")="TClock@7@17@8@15@000@1@1@8@@7@1@@0@0@@ @0@7"
 ;
 S ^BSCOMMON("NEWCTRL")="TDialog@25@7@16@9@Новый элемент@1@1@0@@7@0@@@@@ @0@7@8@@@@@@"
 S ^BSCOMMON("NEWCTRL","Radio1")="TRadio@26@9@8@1@( ) Label@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@1@@1"
 S ^BSCOMMON("NEWCTRL","Radio2")="TRadio@26@10@8@1@( ) Edit@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 S ^BSCOMMON("NEWCTRL","Radio3")="TRadio@26@11@8@1@( ) Button@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 S ^BSCOMMON("NEWCTRL","Radio4")="TRadio@26@12@8@1@( ) Radio@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 S ^BSCOMMON("NEWCTRL","Radio5")="TRadio@26@13@8@1@( ) Check@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 S ^BSCOMMON("NEWCTRL","Radio6")="TRadio@26@14@8@1@( ) Clock@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 ;
 S ^BSCOMMON("EDITCTRL")="TDialog@24@6@17@12@@1@1@0@@7@0@@@@@ @0@7@8@@@@@@"
 S ^BSCOMMON("EDITCTRL","Button1")="TButton@26@8@13@1@Placement@1@1@8@@7@3@@1@1@@ @7@4@15@0@7@@D DoPlace^%ZAPM.bs.BSDIAL1"
 S ^BSCOMMON("EDITCTRL","Button2")="TButton@26@10@13@1@Text@1@1@8@@7@3@@1@1@@ @7@4@15@0@7@@D DoText^%ZAPM.bs.BSDIAL1"
 S ^BSCOMMON("EDITCTRL","Button3")="TButton@26@12@13@1@Hints@1@1@8@@7@3@@1@1@@ @7@4@15@0@7@@D DoHint^%ZAPM.bs.BSDIAL1"
 S ^BSCOMMON("EDITCTRL","Button4")="TButton@26@14@13@1@Advanced@1@1@8@@7@3@@1@1@@ @7@4@15@0@7@@D DoAdvanc^%ZAPM.bs.BSDIAL1"
 S ^BSCOMMON("EDITCTRL","Button5")="TButton@26@16@13@1@Commands@1@1@8@@7@3@@1@1@@ @7@4@15@0@7@@D DoCommand^%ZAPM.bs.BSDIAL1"
 ;
 S ^BSCOMMON("ECPLACE")="TDialog@30@6@12@5@Placement@1@1@0@@7@0@@@@@ @0@7@8@@@@@@"
 S ^BSCOMMON("ECPLACE","Label1")="TLabel@31@7@7@5@Left:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECPLACE","Label2")="TLabel@31@8@7@5@Top:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECPLACE","Label3")="TLabel@31@9@7@5@Right:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECPLACE","Label4")="TLabel@31@10@7@5@Bottom:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECPLACE","Edit1")="TEdit@39@7@2@1@F@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECPLACE","Edit2")="TEdit@39@8@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECPLACE","Edit3")="TEdit@39@9@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECPLACE","Edit4")="TEdit@39@10@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 ;
 S ^BSCOMMON("ECTEXT")="TDialog@20@6@50@5@Text@1@1@0@@7@0@@@@@ @0@7@8@@@@@@"
 S ^BSCOMMON("ECTEXT","Label1")="TLabel@21@7@11@5@Enter text:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECTEXT","Edit1")="TEdit@34@7@34@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECTEXT","Label2")="TLabel@21@9@11@5@Alingment:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECTEXT","Radio1")="TRadio@24@10@7@1@( ) at left@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 S ^BSCOMMON("ECTEXT","Radio3")="TRadio@54@10@7@1@( ) at center@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 S ^BSCOMMON("ECTEXT","Radio2")="TRadio@38@10@7@1@( ) at right@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@0@@1"
 ;
 S ^BSCOMMON("ECHINT")="TDialog@25@10@50@5@Hint@1@1@0@@7@0@@@@@ @0@7@8@@@@@@"
 S ^BSCOMMON("ECHINT","Label1")="TLabel@26@11@11@1@Enter hint:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECHINT","Edit1")="TEdit@38@11@34@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECHINT","Label2")="TLabel@26@13@11@1@Hint color:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECHINT","Edit2")="TEdit@38@13@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 ;
 S ^BSCOMMON("ECADVAC")="TDialog@15@5@50@6@Advanced@1@1@0@@7@0@@@@@ @0@7@8"
 S ^BSCOMMON("ECADVAC","Label1")="TLabel@18@6@17@1@Foregraund color:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit1")="TEdit@37@6@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECADVAC","Label2")="TLabel@18@7@17@1@Backgraund color:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit2")="TEdit@37@7@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECADVAC","Label3")="TLabel@18@8@17@1@Focused color:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit3")="TEdit@37@8@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECADVAC","Label4")="TLabel@43@6@17@1@Background char:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit4")="TEdit@60@6@1@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECADVAC","Label5")="TLabel@43@7@17@1@Shadow color1:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit5")="TEdit@60@7@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECADVAC","Label6")="TLabel@43@8@17@1@Shadow color2:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit6")="TEdit@60@8@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECADVAC","Check1")="TCheck@18@10@11@1@[ ] Tabstop@1@1@8@@7@3@@1@7@@ @0@7@15@0@7@@"
 S ^BSCOMMON("ECADVAC","Label7")="TLabel@43@10@17@1@Group number:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECADVAC","Edit7")="TEdit@60@10@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 ;
 S ^BSCOMMON("ECCOMMAND")="TDialog@20@15@50@4@Commands@1@1@0@@7@0@@@@@ @0@7@8@@@@@@"
 S ^BSCOMMON("ECCOMMAND","Label1")="TLabel@22@16@11@5@Commit key:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECCOMMAND","Edit1")="TEdit@34@16@2@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECCOMMAND","Label2")="TLabel@22@17@11@5@CanClose:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECCOMMAND","Edit2")="TEdit@34@17@35@1@@1@1@8@@7@1@@1@9@@­@0@7"
 S ^BSCOMMON("ECCOMMAND","Label3")="TLabel@22@18@11@5@Command:@1@1@8@@7@0@@0@0@@ @0@7"
 S ^BSCOMMON("ECCOMMAND","Edit3")="TEdit@34@18@35@1@@1@1@8@@7@1@@1@9@@­@0@7"
 ;
 ;
 ;  N ddd
 ;  S ddd=$$TMPG^%ZAPM.bs.BSF11
 ;  D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""ECCOMMAND"")",ddd)
 ;  K @ddd
 
 Q
EditMode(Name,Param1,Param2,Param3,Param4) 
 N X,Y,Temp,I,Edit
 S Param4=0
 I (Param1=27)&(Param2=91)&(Param3>64)&(Param3<69) D
 .I Param3=65 W:$Y>0 /CUP($Y,$X+1)
 .I Param3=66 W:$Y<23 /CUP($Y+2,$X+1)
 .I Param3=68 W:$X>0 /CUP($Y+1,$X)
 .I Param3=67 W:$X<78 /CUP($Y+1,$X+2)
 .S Param1=-1
 .Q
 if Param1=162 D
 .S X=$X,Y=$Y
 .S Temp=$$TMPG^%ZAPM.bs.BSF11
 .D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""NEWCTRL"")",Temp)
 .F I=1:1:6 Q:$P(@Temp@("Radio"_I),"@",23)=1
 .K @Temp
 .S Temp=$P(^BSCOMMON("NEWCTRL","Radio"_I),"@",6)
 .S Temp=$E(Temp,5,$L(Temp));
 .S $P(^BSCOMMON("PATTERNS",Temp),"@",2)=X+1
 .S $P(^BSCOMMON("PATTERNS",Temp),"@",3)=Y+1
 .D SendMessage^%ZAPM.bs.BSDIAL(Name,MSGAddCtrl,Temp,"^BSCOMMON(""PATTERNS"","""_Temp_""")")
 .Q
 if Param1=163 D
 .D SendMessage^%ZAPM.bs.BSDIAL(Name,MSGDelCtrl)
 .S Param4=1
 .Q
 if Param1=28 D
 .D SendMessage^%ZAPM.bs.BSDIAL(Name,MSGGetCtrl,.Edit)
 .S Temp=$$TMPG^%ZAPM.bs.BSF11
 .S $P(^BSCOMMON("EDITCTRL"),"@",6)=$P(@Edit,"@",1)
 .D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""EDITCTRL"")",Temp)
 .K @Temp
 .D SendMessage^%ZAPM.bs.BSDIAL(Name,MSGPaint)
 .Q
 K X,Y,Temp,I,Edit
 Q
 
DoPlace 
 N Temp
 S Temp=$$TMPG^%ZAPM.bs.BSF11
 S $P(^BSCOMMON("ECPLACE","Edit1"),"@",6)=$P(@Edit,"@",2)
 S $P(^BSCOMMON("ECPLACE","Edit2"),"@",6)=$P(@Edit,"@",3)
 S $P(^BSCOMMON("ECPLACE","Edit3"),"@",6)=$P(@Edit,"@",4)
 S $P(^BSCOMMON("ECPLACE","Edit4"),"@",6)=$P(@Edit,"@",5)
 D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""ECPLACE"")",Temp)
 S $P(@Edit,"@",2)=$P(@Temp@("Edit1"),"@",6)
 S $P(@Edit,"@",3)=$P(@Temp@("Edit2"),"@",6)
 S $P(@Edit,"@",4)=$P(@Temp@("Edit3"),"@",6)
 S $P(@Edit,"@",5)=$P(@Temp@("Edit4"),"@",6)
 K @Temp
 K Temp
 Q
 
DoText 
 N Temp,I
 S Temp=$$TMPG^%ZAPM.bs.BSF11
 S $P(^BSCOMMON("ECTEXT","Edit1"),"@",6)=$P(@Edit,"@",6)
 S I=$P(@Edit,"@",12)
 S:(I=0)!(I="") $P(@Edit,"@",12)=1
 S $P(^BSCOMMON("ECTEXT","Radio"_$P(@Edit,"@",12)),"@",23)=1
 D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""ECTEXT"")",Temp)
 S $P(@Edit,"@",6)=$P(@Temp@("Edit1"),"@",6)
 F I=1:1:3 Q:$P(@Temp@("Radio"_I),"@",23)=1
 S $P(@Edit,"@",12)=I
 K @Temp
 K Temp,I
 Q
 
DoHint 
 N Temp,I
 S Temp=$$TMPG^%ZAPM.bs.BSF11
 S $P(^BSCOMMON("ECHINT","Edit1"),"@",6)=$P(@Edit,"@",10)
 S $P(^BSCOMMON("ECHINT","Edit2"),"@",6)=$P(@Edit,"@",11)
 D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""ECHINT"")",Temp)
 S $P(@Edit,"@",10)=$P(@Temp@("Edit1"),"@",6)
 S $P(@Edit,"@",11)=$P(@Temp@("Edit2"),"@",6)
 K @Temp
 K Temp,I
 Q
 
DoAdvanc 
 N Temp,I
 S Temp=$$TMPG^%ZAPM.bs.BSF11
 S $P(^BSCOMMON("ECADVAC","Edit1"),"@",6)=$P(@Edit,"@",18)
 S $P(^BSCOMMON("ECADVAC","Edit2"),"@",6)=$P(@Edit,"@",19)
 S $P(^BSCOMMON("ECADVAC","Edit3"),"@",6)=$P(@Edit,"@",20)
 S $P(^BSCOMMON("ECADVAC","Edit4"),"@",6)=$P(@Edit,"@",27)
 S $P(^BSCOMMON("ECADVAC","Edit5"),"@",6)=$P(@Edit,"@",21)
 S $P(^BSCOMMON("ECADVAC","Edit6"),"@",6)=$P(@Edit,"@",22)
 S $P(^BSCOMMON("ECADVAC","Edit7"),"@",6)=$P(@Edit,"@",25)
 S $P(^BSCOMMON("ECADVAC","Check1"),"@",23)=$P(@Edit,"@",14)
 D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""ECADVAC"")",Temp)
 S $P(@Edit,"@",18)=$P(@Temp@("Edit1"),"@",6)
 S $P(@Edit,"@",19)=$P(@Temp@("Edit2"),"@",6)
 S $P(@Edit,"@",20)=$P(@Temp@("Edit3"),"@",6)
 S $P(@Edit,"@",27)=$P(@Temp@("Edit4"),"@",6)
 S $P(@Edit,"@",21)=$P(@Temp@("Edit5"),"@",6)
 S $P(@Edit,"@",22)=$P(@Temp@("Edit6"),"@",6)
 S $P(@Edit,"@",25)=$P(@Temp@("Edit7"),"@",6)
 S $P(@Edit,"@",14)=$P(@Temp@("Check1"),"@",23)
 K @Temp
 K Temp,I
 Q
 
DoComman 
 N Temp,I
 S Temp=$$TMPG^%ZAPM.bs.BSF11
 S $P(^BSCOMMON("ECCOMMAND","Edit1"),"@",6)=$P(@Edit,"@",28)
 S $P(^BSCOMMON("ECCOMMAND","Edit2"),"@",6)=$P(@Edit,"@",26)
 S $P(^BSCOMMON("ECCOMMAND","Edit3"),"@",6)=$P(@Edit,"@",24)
 D ExecDlg^%ZAPM.bs.BSDIAL("^BSCOMMON(""ECCOMMAND"")",Temp)
 S $P(@Edit,"@",28)=$P(@Temp@("Edit1"),"@",6)
 S $P(@Edit,"@",26)=$P(@Temp@("Edit2"),"@",6)
 S $P(@Edit,"@",24)=$P(@Temp@("Edit3"),"@",6)
 K @Temp
 K Temp,I
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSDIR" type="MAC" languagemode="0"><![CDATA[
%BSDIR ;КАТАЛОГИЗАТОР ; 13:37 18-DEC-98
D(ot,do,fi,co,fo,r,t,com,new,cmdl,Fk,comnew,PrEd) ;d-cквозная локаль
 ;new=1 СТРОКА НОВОГО ОБ'ЕКТА ОБЯЗАТЕЛЬНА
 ;new=2 СТРОКА НОВОГО ОБ'ЕКТА ТОЛЬКО ПРИ ОТСУТСТВИИ ОБ'ЕКТОВ
 ;new="" СТРОКА НОВОГО ОБ'ЕКТА НЕ НУЖНА
 ;cmdl КОМАНДА СПЕЦ-ПОДСКАЗКИ
 ;PrEd - ПРОГРАММА ПРЕДОБРАБОТКИ
 S d=ot,v=1,l1=78,ke=1,BSr=r,BSt=t,cl=$P(%BS,"!",4),t1=" .. "_com_" в "_$$ZU^%ZAPM.bs.BS3(0) D CR^%ZAPM.bs.BSN
 I $G(new)=1 D NEWLINE
 K LINEDIR S ls=com D WAITS^%ZAPM.bs.BSF2
 S cl=$P(%BS,"!",5) F  X co Q:do[d  X WA I @fi X fo D CR^%ZAPM.bs.BSN S LINEDIR=1
 I $G(new)=2,'$D(LINEDIR) D NEWLINE
 D CREAT^%ZAPM.bs.BSN I $G(cmdl)'="" S $P(@(BSR_"(BST)"),"@",13)=cmdl
e Q
NEWLINE S cl=$P(%BS,"!",5),t1=" ..  "_comnew D CR^%ZAPM.bs.BSN Q
 
]]></Routine>


<Routine name="%ZAPM.bs.BSDOS" type="MAC" languagemode="0"><![CDATA[
%BSDOS ;ДОС-ИНТЕРФЕЙС ; 15:29   15.04.2003
 D 0 G D
0 I %BS(12)'="" G PROT^%ZAPM.bs.BSMSM:'$$SizeFile^%ZAPM.bs.BSDOS2(1)
 S OO=31,OOO="^%ZAPM.bs.BS" K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF Q:R1=27  I %B=3 S ls=$$ZOS4() D O^%ZAPM.bs.BSF7 W $$r^%ZAPM.bs.BS3 G 0
 I %B=2 D DRV D:$D(%DRV) DSPACE G 0
 I %B=1 D DOS
 G 0
D D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST Q
EXE(EXE,O,S) ;ВЫЗОВ НА ВЫПОЛНЕНИЕ ДОС-ПРОЦЕССА
 I $ZV["Cach"||($ZV["IRIS") D EXE^%ZAPM.bs.BSCEXE(EXE) Q
 I $P($ZV,"Version ",2)<4 Q
 I '$G(O),$V($V(44)+392) Q:$G(S)=""  D ErrMsg^%ZAPM.bs.BSXfun(S) Q
 I $E(%BS(1),6) W $$bel^%ZAPM.bs.BS3 Q  ;```D ErrMsg^%ZAPM.bs.BSXfun("Для М-Сервера запрещено ! "_$G(S)) Q
 S EXE=$$JOB^%HOSTCMD(EXE)
 Q
ZOS1(D) ;Set Current Drive
 I $ZV["MSM" Q $ZOS(1,D)
 Q $$SCDrive^%ZAPM.bs.BSCEXE(D)
ZOS2(D) ;Delete a File
 I $ZV["MSM" Q $ZOS(2,D)
 I $$DelFile^%ZAPM.bs.BSCEXE(D) Q ""
 Q 1
ZOS3(S,D) ;Rename a File
 I $ZV["MSM" Q $ZOS(3,S,D)
 Q $$RenFile^%ZAPM.bs.BSCEXE(S,D)
ZOS4() ;Get MS-DOS Version Number
 I $ZV["MSM" Q "MS-DOS "_$ZOS(4)
 Q $$Ver^%ZAPM.bs.BSCEXE()
ZOS5(F) ;Set File Attributes
 I $ZV["MSM" Q $ZOS(5,F)
 Q $$AtrFile^%ZAPM.bs.BSCEXE(F)
ZOS6(D) ;Create a New Directory
 I $ZV["MSM" Q $ZOS(6,D)
 Q $$CNDir^%ZAPM.bs.BSCEXE(D)
ZOS7(D) ;Remove an Existing Directory
 I $ZV["MSM" Q $ZOS(7,D)
 Q $$DelDir^%ZAPM.bs.BSCEXE(D)
ZOS8(D) ;Change Current Directory
 I $ZV["MSM" Q $ZOS(8,D)
 Q $$CCDir^%ZAPM.bs.BSCEXE(D)
ZOS9(D) ;Get Drive Parameters
 I $ZV["MSM" Q $ZOS(9,D)
 Q $$GetDPar^%ZAPM.bs.BSCEXE(D)
ZOS10(D) ;Get File Attributes
 I $ZV["MSM" Q $ZOS(10,D)
 Q $$ExsFile^%ZAPM.bs.BSCEXE(D)
ZOS11(D) ;Get Current Directory for Drive
 I $ZV["MSM" Q $ZOS(11,D)
 Q $$GCDir^%ZAPM.bs.BSCEXE(D)
ZOS12(D,V) ;Begin Directory Search
 I $ZV["MSM" Q $ZOS(12,D,V)
 Q $$BegDir^%ZAPM.bs.BSCEXE(D,V)
ZOS13(D) ;Continue Directory Search
 I $ZV["MSM" Q $ZOS(13,D)
 Q $$ContDir^%ZAPM.bs.BSCEXE(D)
ZOS14() ;Get Current Drive
 I $ZV["MSM" Q $ZOS(14)
 Q $$CurDisk^%ZAPM.bs.BSCEXE()
BaseDir() ;БАЗОВАЯ ДИРЕКТОИЯ
 N D S D=$P($G(^%ZAPM.bs.BSETUP("PATH",12,4)),"@",15)
 Q D
CurDisk() ;ТЕКУЩИЙ ДИСК
 N D S D=$P($P($G(^%ZAPM.bs.BSETUP("PATH",12,4)),"@",15),":")
 I $ZV["MSM" Q $S(D'="":D,1:$ZOS(14))
 Q $S(D'="":D,1:$$CurDisk^%ZAPM.bs.BSCEXE()) ;Cach
CurDir(Disk) ;ТЕКУЩАЯ ПОДДИРЕКТОРИЯ
 N D S D=$P($P($G(^%ZAPM.bs.BSETUP("PATH",12,4)),"@",15),":",2,999)
 I $ZV["MSM" Q $S(D'="":D,1:$ZOS(11,Disk))
 Q $S(D'="":D,1:$$GCDir^%ZAPM.bs.BSCEXE(Disk)) ;Cach
DRV N %B K M,DR S M=" A: B: ",i="CDEFGHIJKLMNOPQRSTUVWXYZ",T=$$ZOS14() F ii=1:1:$L(i) S %ER=$$ZOS1($E(i,ii)) I %ER>0 S %ER=$$ZOS11($E(i,ii)) I '(%ER<0) S M=M_$E(i,ii)_": "
 I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 S M(1,1)=M_"@6@ @0",OO=1,OOO="M",%B=$L($P(M,T)," ")-1,%ER=$$ZOS1(T) D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G DR:R1=27 S %DRV=$P($P(M," ",%B+1),":")
 K M,EXITout Q
DR W $$bel^%ZAPM.bs.BS3 K %DRV,EXITout Q
DSPACE D SPACE^%ZAPM.bs.BSERV
e Q
DOS I $ZV["Cach"||($ZV["IRIS") D DirDDR^%ZAPM.bs.BSCmDDR Q  ;```
 D DRV G:'$D(%DRV) DIREXIT
 D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,%DRV) D SI^%ZAPM.bs.BSN,SA^%ZAPM.bs.BSsBUF,DIR,RE^%ZAPM.bs.BSsBUF Q
DIR ;ДИРЕКТОРИЯ
 S %D=%DRV,%ER=$$ZOS11(%D),%D=$S(%ER<0:"^",1:%D_":"_%ER_$S(%ER="\":"",1:"\")_"*.*")
 S BL="ABCDEFGHIJKLMNOPQRSTUVWXYZАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧЬЪШЩЭЮЯ"
 S LL="abcdefghijklmnopqrstuvwxyzабвгдеежзийклмнопpстуфхцчьъшщэюя"
DIRNEW S ls="Сканиpование "_%D D WAITS^%ZAPM.bs.BSF2
 S %X=%D,%A=$L(%X,"\"),%B=$P(%X,"\",%A) I %B'="",%B'["*",%B'["." I $ZB(+$$ZOS10(%X),16,1) S %X=%X_"\*.*"
 I $E(%X,$L(%X))=":"!($E(%X,$L(%X))="\") S %X=%X_"*.*"
 S %ER=$$ZOS12(%X,32+16+4+1) I %ER<0 D ^%ZAPM.bs.BSDOS1 G DIREXIT
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВХОД <F3>-СМОТР.<F4>-РЕДАКТ <F6>-AKT <F8>-УДАЛИТЬ <F10>-ВЫБОР И ВЫХОД """
DIRO S BSR="^%ZAPM.bs.BSbufB",BST=%X_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G DIRE
 S i=1,(kod,kof,kb)=0,STR="@@1@55@@@@1,1@1@"_$P(%BS,"!",5)_"@@@@@",%Y=%ER,^%ZAPM.bs.BSbufB(BST,"FTR",1,1)="I d'["" <DIR> "" S d1=$TR(d,BL,LL)"
DI S %I=$P(%Y,"^"),%J=$P(%Y,"^",2,999)
 S %K=$A(%J,22)
 I $ZB(%K,16,1) G:$E(%I)="." DIREC S ST=" "_$P(%I,".")_$J("",8-$L($P(%I,".")))_$S(%I[".":".",1:" ")_$J($P(%I,".",2),3)_" <DIR> ",kod=kod+1
 E  S %A=$A(%J,27),%B=$A(%J,28),%C=$A(%J,29),%D=$A(%J,30) S ST=" "_$P(%I,".")_$J("",8-$L($P(%I,".")))_$S(%I[".":".",1:" ")_$J($P(%I,".",2),3)_" "_$J("-"_(%A+(%B*256)+(%C*256*256)+(%D*256*256*256))_"-",11) D  ;
 .S kof=kof+1,kb=kb+(%A+(%B*256)+(%C*256*256)+(%D*256*256*256))
 S ST=ST_$J("",23-$L(ST)) S %A=$A(%J,25),%B=$A(%J,26),%C=256*%B+%A,%D=%C#32,%C=%C\32,%E=%C#16,%C=%C\16,%C=%C+1980
 S ST=ST_"  "_$E("  ",1,2-$L(%E))_%E_"-"_$E("00",1,2-$L(%D))_%D_"-"_%C_"  " ;ДАТА
 S %A=$A(%J,23),%B=$A(%J,24),%C=%B*256+%A,%D=%C#32*2,%C=%C\32,%E=%C#64,%C=%C\64,%A=%C\12,%B=%C#12 S:%B=0 %B=12
 S ST=ST_$E("  ",1,2-$L(%B))_%B_":"_$E("00",1,2-$L(%E))_%E_$S(%A:"p",1:"a") ;ВРЕМЯ
 S i=i+1,^%ZAPM.bs.BSbufB(BST,i,1)=STR_ST
DIREC S %Y=$$ZOS13(%Y) G:%Y'<0&($P(%Y,"^")'="") DI S ^%ZAPM.bs.BSbufB(BST,1,1)="@@1@55@@@@@1@"_$P(%BS,"!",4)_"@@@@@ .. "_$P(%X,"*")_"  "_$FN(kb,",")_" bytes  files-"_kof_" dir-"_kod
 S ^%ZAPM.bs.BSbufB(BST)="@@@@@@@1@1@22@80@@X MRMR@@%FK^%ZAPM.bs.BSDOS2@1@1@@@@@@@@1@@@@@@@@@@@@@@@@DelF8^%ZAPM.bs.BSDOS",se=i,ke=1,$P(@$ZR,"@",36)="2,1" D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
DIRE I $D(EXITout) G DIREXIT
 D Kdf^%ZAPM.bs.BSDOS2
 I R1=27!(ny=1) D Kdf^%ZAPM.bs.BSDOS2 K @(BSR_"(BST)") S R1=27,%D=$P(%X,"\",1,$L(%X,"\")-2)_"\" D DIF G DIRD:%D="\",DIRNEW
 I d[" <DIR> " D Kdf^%ZAPM.bs.BSDOS2 S %D=$P(%X,"*")_$TR($E(d,2,13)," ","")_"\" D DIF G DIRO:%D["\\",DIRNEW
 D DIF I %File[".%BS" D VIEW^%ZAPM.bs.BSDOS2("View*.*") G DIRO ;???ЗАЧЕМ Я НЕ ПОМНЮ
 I R1=13 S EXITout=1,R1=13 D DIA,DIF,GLKL^%ZAPM.bs.BSDOS2 G DIREXIT
 G DIRO
DIRD D DRV G:$G(R1)=27 DIREXIT I '$D(%DRV) G DIRD
 G DIR
DIA N FF,F Q:'$P(@BSR@(BST),"@",3)  F FF=1:1 Q:'$D(@BSR@(BST,FF))  I $D(@BSR@(BST,FF,1)),$P(@BSR@(BST,FF,1),"@",12),$P(@BSR@(BST,FF,1),"@",15)'[" <DIR>" S F=$$FULLNAME($P(@BSR@(BST,FF,1),"@",15)) I F'="" S %BS("Tmp","DosFiles",F)=$P($P(@BSR@(BST,FF,1),"@",15),"-",2)
 Q
DelF8 I $E(%BS(1),17),R1=127 S R1=27,R2=79,R3=87 Q
 Q
DIREXIT K kod,kof,kb Q
DIF S %File=$$FULLNAME(d) Q
FULLNAME(d) Q $P(%X,"*")_$S($E(d,2,3)'="..":$TR($E(d,2,13)," ",""),1:"")
FILE(%X,M) ;M=1 - РАЗМЕР ФАЙЛА
         ;M=2 - ДАТА
         ;M=3 - ВРЕМЯ
 I $ZV["Cach"||($ZV["IRIS") Q $$FileAtr^%ZAPM.bs.BSCEXE(%X,M)
 N %ER,%J,%I,%A,%B,%C,%D,%Y,%K
 S %ER=$$ZOS12(%X,32+16+4+1) I %ER<0 Q ""
 S %Y=%ER,%I=$P(%Y,"^"),%J=$P(%Y,"^",2,999),%K=$A(%J,22)
 I $ZB(%K,16,1) Q:$E(%I)="." ""  I M=1 Q "<DIR>"
 E  S %A=$A(%J,27),%B=$A(%J,28),%C=$A(%J,29),%D=$A(%J,30) I M=1 Q (%A+(%B*256)+(%C*256*256)+(%D*256*256*256))
 S %A=$A(%J,25),%B=$A(%J,26),%C=256*%B+%A,%D=%C#32,%C=%C\32,%E=%C#16,%C=%C\16,%C=%C+1980
 I M=2 Q %E_"-"_$E("00",1,2-$L(%D))_%D_"-"_%C
 S %A=$A(%J,23),%B=$A(%J,24),%C=%B*256+%A,%D=%C#32*2,%C=%C\32,%E=%C#64,%C=%C\64,%A=%C\12,%B=%C#12 S:%B=0 %B=12
 Q %B_":"_$E("00",1,2-$L(%E))_%E_$S(%A:"p",1:"a") ;ВРЕМЯ
]]></Routine>


<Routine name="%ZAPM.bs.BSDOS1" type="MAC" languagemode="0"><![CDATA[
%BSDOS1 ;ФОРМИРОВАНИЕ ОШИБОК DOSа
 ;MICRONETICS DESIGN CORP. (C) 1986
 S %ER=+$G(%ER,0),T=$T(@($S(%ER>-1:%ER,1:-%ER))) S ls="DOS ОШИБКА - "_$S(T'="":$P(T,";",2,999),1:"НЕЗНАКОМЫЙ ТИП ОШИБКИ:"_%ER)_" " D O^%ZAPM.bs.BSF7
e Q
1 ;НЕДОПУСТИМЫ НОМЕР ФУНКЦИИ
2 ;ФАЙЛ НЕ НАЙДЕН
3 ;ПУТЬ НЕ НАЙДЕН
4 ;СЛИШКОМ МНОГО ФАЙЛОВ ОТКРЫТО
5 ;В ДОСТУПЕ ОТКАЗАНО
6 ;ВРУЧНУЮ НЕДОПУСТИМО
7 ;БЛОКИ УПРАВЛЕНИЯ ПАМЯТИ РАЗРУШЕНЫ
8 ;НЕДОСТАТОЧНО ПАМЯТИ
9 ;АДРЕС БЛОКА ПАМЯТИ НЕВЕРЕН
10 ;НЕДОПУСТИМАЯ ОПЕРАЦИОННАЯ СРЕДА
11 ;НЕДОПУСТИМЫЙ ФОРМАТ
12 ;НЕДОПУСТИМЫЙ КОД ДОСТУПА
13 ;ОШИБКА ДАННЫХ
15 ;ОШИБКА ДИСКОВОДА
16 ;ПОПЫТКА ПЕРЕНОСА ТЕКУЩЕЙ ДИРЕКТОРИИ
17 ;НЕ ПОДХОДЯЩЕГО УСТРОЙСТВА
18 ;НЕТ БОЛЬШЕ ФАЙЛОВ
19 ;ЗАПИСЬ НА ДИСК ЗАЩИЩЕНА
20 ;НЕИЗВЕСТНЫЙ ЭЛЕМЕНТ
21 ;ДИСКОВОД НЕ ГОТОВ
22 ;НЕЗНАКОМАЯ КОМАНДА
23 ;ОШИБКА ДАННЫХ (CRC)
24 ;НЕПРАВИЛЬНЫЙ ЗАПРОС СТРУКТУРНОЙ ДЛИНЫ
25 ;ОШИБКА УСТАНОВКИ ГОЛОВОК
26 ;НЕИЗВЕСТНЫЙ ТИП НОСИТЕЛЯ
27 ;СЕКТОР НЕ НАЙДЕН
28 ;ПРИНТЕР БЕЗ БУМАГИ
29 ;ОШИБКА ЗАПИСИ
30 ;ОШИБКА ЧТЕНИЯ
31 ;ОБЩИЙ ПРОВАЛ
32 ;ЧАСТИЧНОЕ РАЗРУШЕНИЕ
33 ;БЛОКИРОВКА РАЗРУШЕНИЯ
34 ;СМЕНА ДИСКА ОШИБОЧНА
35 ;FCB НЕГОДНО
80 ;ФАЙЛ УЖЕ СУЩЕСТВУЕТ
82 ;НЕ МОЖЕМ СОЗДАТЬ ДИРЕКТОРИЮ
83 ;fail on int 24H (critical error interupt)
256 ;ОШИБКА ЗАЩИТЫ ЗАПИСИ
257 ;НЕЗНАКОМЫЙ МОДУЛЬ
258 ;ДИСКОВОД НЕ ГОТОВ
259 ;НЕЗНАКОМАЯ КОМАНДА
260 ;ОШИБКА ДАННЫХ (bad CRC)
261 ;ПЛОХОЙ ЗАПРОС СТРУКТУРНОЙ ДЛИНЫ
262 ;ОШИБКА УСТАНОВКИ ГОЛОВОК
263 ;НЕЗНАКОМЫЙ ТИП НОСИТЕЛЯ
264 ;СЕКТОР НЕ НАЙДЕН
265 ;ПРИНТЕР БЕЗ БУМАГИ
266 ;ОШИБКА ЗАПИСИ
267 ;ОШИБКА ЧТЕНИЯ
268 ;ОБЩИЙ ПРОВАЛ
]]></Routine>


<Routine name="%ZAPM.bs.BSDOS2" type="MAC" languagemode="0"><![CDATA[
%BSDOS2 ;ФУНКЦИАНАЛЬНЫЕ КЛАВИШИ DOS-ИНТЕРФЕЙСА ; 13:22   16.05.2000
%FK I R3=89 S EXITout=1,R1=13 D DIA^%ZAPM.bs.BSDOS,DIF^%ZAPM.bs.BSDOS,GLKL Q
 I R3=82,d'[" <DIR> " D DIF^%ZAPM.bs.BSDOS,VIEW("View*.*") G D
 I R3=87 D DIA^%ZAPM.bs.BSDOS,DIF^%ZAPM.bs.BSDOS,DEL S R1=27 Q  ;УДАЛЕНИЕ
 I R3=85,d'[" <DIR> " D DIA^%ZAPM.bs.BSDOS,DIF^%ZAPM.bs.BSDOS,ACTF6,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM ;ГРУППОВЫЕ РАБОТЫ
 I R3=83,d'[" <DIR> " D DIF^%ZAPM.bs.BSDOS,VIEW("Edit*.*"),OVER G D
 G D
D G 0^%ZAPM.bs.BSTM
ACT6(SIZE,FILE,CMD) ;ДЕЙСТВИЯ НАД ФАЙЛОМ
 D Wait^%ZAPM.bs.BSXfun(FILE) X CMD
 Q
ACTF6 ;ГРУППОВЫЕ ДЕЙСТВИЯ НАД ФАЙЛАМИ
 N CMD,UZ,X,XX I '$$SizeFile(3) D ErrMsg^%ZAPM.bs.BSXfun("Эта команда для вас запрещена %BS-Системными установками") Q
 S UZ=$$UZEL^%ZAPM.bs.BSVOL("ACTFILE","%BSVOL","","","ВЫБЕРИТЕ УЗЕЛ ДЛЯ ДЕЙСТВИЙ С ФАЙЛАМИ") Q:UZ=""
 S CMD=@UZ@("NSP")
 S %zT=$ZT,$ZT="ACTER^%ZAPM.bs.BSDOS2"
 I $D(%DIA) S X="" D  G ACTF
 .F  S X=$O(%BS("Tmp","DosFiles",X)) Q:X=""  S XX=%BS("Tmp","DosFiles",X) I XX'="" D ACT6(XX,X,CMD)
 I '$D(%DIA) S X=$P(d,"-",2) I X'="" D ACT6(X,%File,CMD)
ACTF D OkMsg^%ZAPM.bs.BSXfun("Групповая Операция Закончена Успешно")
 G Kdf
ACTER D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
DEL ;УДАЛЕНИЕ
 N X,XX I '$$SizeFile(3) D ErrDe Q
 I $D(%DIA) S X="" Q:$$YYY("Помеченные файлы")<1  D  G Kdf
 .F  S X=$O(%BS("Tmp","DosFiles",X)) Q:X=""  S XX=$$ZOS(%BS("Tmp","DosFiles",X),X) I XX'="" D ErrDel(XX,X)
 I '$D(%DIA) Q:$$YYY(" файл "_%File)<1  S X=$$ZOS($P(d,"-",2),%File) I X'="" D ErrDel(X,%File)
Kdf K %BS("Tmp","DosFiles")
 Q
YYY(S) D Yes^%ZAPM.bs.BSXfun("Киляем "_S_", Вы уверены ?") Q YES
ZOS(K,N) ;удаление файла
 Q:($$SizeFile(3)<K) -1
 I $ZV["Cach"||($ZV["IRIS") Q $$DelFile^%ZAPM.bs.BSCEXE(N)
 Q $ZOS(2,N)
 
AccesMSM(P) I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 I %BS(12)'="",$D(@%BS(18)@(%BS(37),0,"3,4")) Q ($P($G(@%BS(18)@(%BS(37),0,"3,4")),"/",P)="Y")
 Q $P($G(%BS(34)),"/",P)="Y"
 
SizeFile(P) I %BS(12)'="",$D(@%BS(18)@(%BS(37),0,"5,4")) Q ($P($G(@%BS(18)@(%BS(37),0,"5,4")),"/",P)*1024)
 Q $P($G(%BS(33)),"/",P)*1024
 
ErrDel(XX,X) I XX'=-1 D ErrMsg^%ZAPM.bs.BSXfun($S(XX=-2:"Не найден",XX=-3:"Не найден путь к",XX=-5:"Отказано в доступе к",1:"")_" "_X) Q
ErrDe D ErrMsg^%ZAPM.bs.BSXfun("Удаление "_X_" для вас запрещено %BS-Системными установками") Q
OVER ;ПЕРЕЗАПИСЬ ФАЙЛА
 N U,X,S,%FN,%DEV,ls
 S ls="Учтите,если в файле были управляющие символы, то они пропадут. Перезаписываем ?" D YES^%ZAPM.bs.BSF I 'YES Q
 D DosOpn^%ZAPM.bs.BSBL1(51,%File) Q:'$D(%FN)  S U=$NA(@BSr@(BSt)),X="I g'=Head U %DEV W @g,! U 0"
 D XGlob^%ZAPM.bs.BSF9(U,X,1) C %DEV Q
VIEW(V) S BSr="^%ZAPM.bs.BSbufB",BSt=V_$G(%BS(3),$P)_$J_"u"_%BS(15) Q:'$$View(%File,BSr,BSt)  I V["Edit*" d ^%ZAPM.bs.BSX("EDIT",BSr,BSt) Q
 S IYI=BSr_","_BSt D NE^%ZAPM.bs.BSN Q
GLKL S II="" F  S II=$O(^%ZAPM.bs.BSbufB(II)) Q:II=""  I $P($P(II,"*.*",2),"u")=$I K ^%ZAPM.bs.BSbufB(II)
e Q
AddFile(%File) I %File'[":\" S %File=$$CurDisk^%ZAPM.bs.BSDOS()_":"_$$CurDir^%ZAPM.bs.BSDOS($$CurDisk^%ZAPM.bs.BSDOS())_$S($E(%File,1)="\":"",1:"\")_%File Q %File
 Q %File
ON D O^%ZAPM.bs.BSF7 Q
FILE Q:'$D(%IN)  D SI^%ZAPM.bs.BSN N (%BS,vl,%FN,%IN) S %SDEV="HISTORY" D  S:'$D(%FN) %FN="" D OP^%ZAPM.bs.BSF4 Q
 .I %IN=0 D DOSOPN^%ZAPM.bs.BSBL1 Q
 .I %IN=1 D DOSREAD^%ZAPM.bs.BSS1 Q
View(%File,BSr,BSt,P,OT,DO) N %DEV,%FN,i,UP,t1,ii ;ФАЙЛ В МАССИВ
 S %File=$$AddFile(%File)
 I '$G(P),BSt["View*",($P(d,"-",2)>$$SizeFile(1)) D ErrMsg^%ZAPM.bs.BSXfun("ФАЙЛ "_%File_" ДЛЯ ПРОСМОТРА СЛИШКОМ ВЕЛИК !") Q 0
 I '$G(P),BSt["Edit*",($P(d,"-",2)>$$SizeFile(2)) D ErrMsg^%ZAPM.bs.BSXfun("ФАЙЛ "_%File_" ДЛЯ РЕДАКТИРОВАНИЯ СЛИШКОМ ВЕЛИК !") Q 0
 S %FN=%File I $ZV["Cach"||($ZV["IRIS") Q:$$Open^%ZAPM.bs.BSCF1(%FN,"R")<0 0 S %DEV=DOS G Vi
 F %DEV=51:1:54 O %DEV::0 Q:$T
 I '$T S ls=" Все файловые устpойства ДОС заняты " D ON Q 0
 O %DEV:%FN U %DEV I $ZA=-1 U 0 S ls=" Файл "_%FN_" не найден " D ON Q 0
 O %DEV:(%FN:"R") U %DEV I $ZA<0 U 0 S ls=" Ошибка откpытия файла "_%FN D ON Q 0
Vi S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSDOS2"
 U 0 S UP="" F i=0:1:8,10:1:31 S UP=UP_$C(i)
 K @(BSr_"(BSt)") S $P(@$ZR,"@")=%File,$P(@$ZR,"@",17)=5
 S ls="ЗАГРУЗКА "_%FN D WAITS^%ZAPM.bs.BSF2 S:'$D(OT) OT=1 S:'$D(DO) DO=9999999
 S i=0 F ii=1:1:DO U %DEV R %LINE#509 Q:$ZC  I ii'<OT D ViewIn(%LINE,UP,BSr,BSt)
ViEND I %LINE'="" D ViewIn(%LINE,UP,BSr,BSt)
 U 0 C %DEV S $P(@(BSr_"(BSt)"),"@",28)=i
 Q 1
ERFILE U 0 I $ZE["<INRP" S ls=" ПРЕРВАНО..." G EREFILE
 I $ZE["<ENDOFFILE" G ViEND
 I $ZE["<MXSTR" S ls=" Слишком длинная строка считана " G EREFILE
EREFILE D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q 0
 
ViewIn(%LINE,UP,BSr,BSt) I '$D(i) S i=0
 U 0 S i=i+1,t1=$TR(%LINE,UP,$TR($J("",$L(UP))," ","¬")) D  S @(BSr_"(BSt,i)")=t1 X $G(WA)
 .i t1[$C(9) S t1=$E($$TR^%ZAPM.bs.BSsFUNM(t1,$C(9),"         "),1,509)
 .I '$D(S1),$$IFDOS^%ZAPM.bs.BSHTML1(t1) D INIT^%ZAPM.bs.BSre(1)
 .s t1=$TR(t1,$G(S1),$G(S2))
 Q
INITHELP ;ИНИЦИАЛИЗАЦИЯ СПРАВОЧНОЙ СИСТЕМЫ
 Q:$D(^%ZAPM.bs.BSGER("MSMHELP"))  Q:'$D(^%ZAPM.bs.BSHLP("MSMDOC"))  N I
 S I="" F  S I=$O(^%ZAPM.bs.BSHLP("MSMDOC",I)) Q:I=""  S ^%ZAPM.bs.BSGER("MSMHELP",$P(^%ZAPM.bs.BSHLP("MSMDOC",I)," "))=$P(^%ZAPM.bs.BSHLP("MSMDOC",I)," ",2,4)
 S ^%ZAPM.bs.BSGER("MSMHELP")=$P($P($G(^%ZAPM.bs.BSHLP("MSMDOC")),"@"),":",2,99)
 Q
MSMHELP(S) ;СПРАВОЧНАЯ СИСТЕМА ПО MSM
 Q:'$D(^%ZAPM.bs.BSGER("MSMHELP"))
 N SS,FN,DOS,OT,DO,SSS
 S FN=^%ZAPM.bs.BSGER("MSMHELP") Q:FN=""  S SS=S
 I '$D(^%ZAPM.bs.BSGER("MSMHELP",S)) S (SSS,SS)=$O(^%ZAPM.bs.BSGER("MSMHELP",S)) I ("@"_SS)'[("@"_S) D ErrMsg^%ZAPM.bs.BSXfun("СПРАВКИ ПО ?"_S_" НЕТ") Q
 S OT=$P(^%ZAPM.bs.BSGER("MSMHELP",SS)," "),DO=$P(^%ZAPM.bs.BSGER("MSMHELP",SS)," ",2)
 I '$$View(FN,"^%ZAPM.bs.BSbufB","MsmHelp%BS*.*"_$G(%BS(3),$P),1,OT,DO) Q
 S IYI="^%ZAPM.bs.BSbufB,MsmHelp%BS*.*"_$P D NE^%ZAPM.bs.BSN Q
 Q
DOSTXT(FN) I '$$View(FN,"^%ZAPM.bs.BSbufB","View%BS*.*"_$G(%BS(3),$P),1) Q
 S IYI="^%ZAPM.bs.BSbufB,View%BS*.*"_$P D NE^%ZAPM.bs.BSN Q
DOCBS(BS,ST) I '$$View($P($G(^%ZAPM.bs.BSETUP("PATH",ST,4),$G(^%ZAPM.bs.BSS("PATH",ST,4))),"@",15)_BS,"^%ZAPM.bs.BSbufB","Help%BS*.*"_$G(%BS(3),$P)_$J_"u1",1) Q
 S IYI="^%ZAPM.bs.BSbufB,Help%BS*.*"_$G(%BS(3),$P)_$J_"u1" D NE^%ZAPM.bs.BSN Q
HELPP(N) D DOCBS("BSP"_N,8) Q  ;ПОМОЩЬ ПО ОПИСАНИЮ %BS ПРИЛОЖЕНИЯ
HELP(N) D DOCBS("BS"_$S(N?.N:"C",1:"")_N,8) Q  ;ПОМОЩЬ ПО ОПИСАНИЮ %BS
NEW(N) D DOCBS("BS_Release_notes.txt",2) Q  ;ЧТО НОВОГО ?
]]></Routine>


<Routine name="%ZAPM.bs.BSER" type="MAC" languagemode="0"><![CDATA[
%BSER ;RTM;MSM ПАКЕТНОЕ РЕДАКТИРОВАНИЕ ПРОГРАММ ; 13:39   31.05.99
 S IYI="^%ZAPM.bs.BSS(EditRou" D NE^%ZAPM.bs.BSN Q
%RSEL() ;ФУНКЦИЯ ВЫБОРА ПРОГРАММ
 I $ZV["MSM" K QUIT D  I $D(QUIT) I '%FLG Q 0
 .D INT^%RSEL S %Jo=$J
 I $ZV["Cach"||($ZV["IRIS") D  I %R=0 Q 0
 .D ^%RSET S %Jo=%JO
 Q 1
E(No) ;1=МЕТКА     2-ПОИСК    3-ПОИСК И ЗАМЕНА    4-ПОИСК И РЕДАКТИРОВАНИЕ
 S %FLG=0 W /ED(2),/CUP(1,1)
ASK1 U 0 I '$$%RSEL() D ErrMsg^%ZAPM.bs.BSXfun("Программы не выбраны") G EXIT
 G @No
3 S %FLG=1,%ST=0 S $ZT="ERROR^%ZAPM.bs.BSER"
ASK2 U 0 s %X=$$LineEdit^%ZAPM.bs.BSXfun("","Что Замещать") d Echo^%ZAPM.bs.BSXfun(1) I %X="" S %FLG=0 G ASK1
 S %ST=%X
 s %RP=$$LineEdit^%ZAPM.bs.BSXfun("","На что    : ") d Echo^%ZAPM.bs.BSXfun(1)
VER R !!,"С подтверждением ? <N> ",%V G ASK2:%V="^",EXIT:%V="^Q"
 S %V=$S(%V?1"Y".E:1,%V?1"N".E:0,%V="":0,1:-1) I %V<0 W "  ??",*7 G VER
 S BSr="^%ZAPM.bs.BSbufB",BSt="%RSEBUF3",Obraz(12)=1,Obraz(21)=1,CR="S t=t+1,t(t)=%CC_""+""_%I_"": ""_%T"
 S t0="-  Поиск И Замена строк в программах. Введите <Enter> для входа в редактор " D CR^%ZAPM.bs.BSTT
 S CRT1="X CRT K t S t=0",CRT="S t=0 F  S t=$O(t(t)) Q:'t  S t0=t(t) D CR^%ZAPM.bs.BSTT",t=0
 S t0="-  "_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3()) D CR^%ZAPM.bs.BSTT
 S t0="-  Заменяем :<"_%ST_"> На    :<"_%RP_">" D CR^%ZAPM.bs.BSTT
 W !! U 0
 W !,?22,"Изменения В программах "
 I $ZV["MSM" D ^%GUCI
 I $ZV["Cach"||($ZV["IRIS") D ^%DIR
 W !!,t0 K END
LK S %LK="F %I=1:1 S %T=$T(+%I) Q:%T=""""  S %K=$L(%T,%ST) I %K>1 X %LM I '%ER S %F=1 X %LL X %LN Q:$D(END)  I %UF ZI %M:+(%I) ZR +%I U 0 I '%V U 0 W !,%CC,""+"",%I-1,"": "",%M X CR"
LL S %LL="S %M="""" F %J=1:1:%K S %M=%M_$P(%T,%ST,%J) S:%J'=%K %M=%M_%RP"
 I $ZV["MSM" ;S %X=$S($ZB($V(140,$J,2),#800,1):1000,1:255)
 I $ZV["Cach"||($ZV["IRIS") S %X=1000 ;?
LM S %LM="S %ER=$S(($L(%T)-(%K-1*$L(%ST))+(%K-1*$L(%RP)))>"_%X_":1,1:0) I %ER W !,%CC,""+"",%I-1,"": Not changed - New line is greater than "_%X_" characters"""
LN S %LN="S %UF=1 Q:'%V  U 0 X CR W !!,%CC,""+"",%I-1,!,""OLD: "",%T,!,""NEW: "",%M F %VN=1:1 R !!,""Замещаем <Y> "",%VA,! S:%VA=""^"" END=1 Q:$D(END)  S %UF=$S(%VA=""N"":0,%VA=""Y"":1,%VA="""":1,1:-1) Q:%UF'<0  W ""  ??"",*7"
RSEL ;
 S $ZT="RSEL2^%ZAPM.bs.BSER",%CC=-1,%PCT=0,%FND=0,%F=0
RSEL1 ;
 F %I=1:0 S %CC=$N(^UTILITY(%Jo,%CC)) Q:%CC<0  I %CC'=0 X "ZL @%CC U 0 X:0'=$I ""W %CC,""""  """""" U 0 X %LK Q:$D(END)  ZS:%F @%CC" S %PCT=%PCT+1 S:%F %FND=%FND+1,%F=0 X CRT1
 D OkMsg^%ZAPM.bs.BSXfun("Обработано "_%PCT_" Программ(а)")
 S %ST=0
 S Coment="Список Замен в программах.Состояние до Редактирования" K t,t0
 D CREAT^%ZAPM.bs.BSTT S %FLG=0 W /CUP(1,1),/ED(2)
 G ASK2
RSEL2 ;
 U 0 I $F($ZE,"<NOPGM>") S $ZT="RSEL2^%ZAPM.bs.BSER" W !,"Routine: ",%CC," not found." G RSEL1
 G ERROR
EXIT ;
 U 0 I $D(%DEV),%DEV'=$I,+%DEV C %DEV
 K %,%BLK,%CC,%DEV,%ER,%F,%FLG,%FND,%J,%K,%LK,%LL,%LM,%M,%PCT,%RP,%ST,%T,%UCI,%UCN,%X,%I,%LN,%UF,%V,%VA,%VN,QUIT
 Q
ERROR ;
 I $F($ZE,"<INRPT>") U 0 W !!,"...Aborted." D EXIT ZQ:$ZV["Wind"!($ZV["Cach"||($ZV["IRIS"))  ;V 0:$J:$ZB($V(0,$J,2),#0400,7):2
 ZQ
REDIT ;ВХОД В РЕДАКТОР ПО ТОЧКЕ ПРЕРЫВАНИЯ
 Q:$ZE=""  I $ZV["MSM" d ^%ZAPM.bs.BSX("PROG",$P($P($ZE,"^",2),":"),$P($P($ZE,"+",2),"^")) Q
 d ^%ZAPM.bs.BSX("PROG",$P($P($ZE,"^",2),":"),$$LABEL^%ZAPM.bs.BSCp($P($P($ZE,">",2),"^"),$P($P($ZE,">",2),"^",2))) ;ДЛЯ CACHE'
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSER1" type="MAC" languagemode="0"><![CDATA[
%BSER1 ;ПАКЕТНЫЕ ОПЕРАЦИИ С ПРОГРАММАМИ ; 13:01   02.06.99
4 S Txx=4,Tx="Строки поиска для редактирования" G GO
1 S Txx=1,Tx="Метки поиска" G GO
2 S Txx=2,Tx="Строки поиска"
GO S %FLG=1,%ST=0 K %SE S $ZT="ERROR^%ZAPM.bs.BSER1"
ASK2 U 0
ASK3 D OP^%ZAPM.bs.BSF4 s %X=$$LineEdit^%ZAPM.bs.BSXfun("","Введите "_Tx,"","","",$$HISFIND^%ZAPM.bs.BSS()) D Echo^%ZAPM.bs.BSXfun(1) I %X="",'$D(%SE(1)) S %FLG=0 W /ED(2) G ASK1^%ZAPM.bs.BSER
 I %X'="" S %ST=%ST+1,%SE(%ST)=%X G ASK3
 W !! U 0
 W !,?22,"Поиск в программах  " W !
 S BSr="^%ZAPM.bs.BSbufB",BSt="%RSEBUF"_Txx,Obraz(12)=1,Obraz(21)=1,CR="S t=t+1,t(t)=%CC_""+""_%I_"": ""_%T"
 S t0="-  "_Tx_" в программах. Введите <Enter> для входа в редактор " D CR^%ZAPM.bs.BSTT
 S CRT1="X CRT K t S t=0",CRT="S t=0 F  S t=$O(t(t)) Q:'t  S t0=t(t) D CR^%ZAPM.bs.BSTT",t=0
 S t0="-  "_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3()) D CR^%ZAPM.bs.BSTT
 F %I=1:1:%ST W ?(33-($L(%SE(%I))\2)),%SE(%I),! S t0="- "_%SE(%I) D CR^%ZAPM.bs.BSTT
 I Txx=4 D
 .S %LK="F %I=1:1 S %T=$T(+%I) Q:%T=""""  F %J=1:1:%ST I %T[%SE(%J) W /CUP(1,1),/ED(2),!,%CC,""+"",%I S li=%T,YES=0 X NNNN ZL @%CC S %F=1 I YES X NNN,CR"
 .S NNN="ZI li:+(%I) ZR +%I ZS @%CC",NNNN="N (li,%BS,YES) S li=$$Edit^%ZAPM.bs.BSXuse(li,3,1,7,79,""@"") Q  "
 I Txx=2 S %LK="F %I=1:1 S %T=$T(+%I) Q:%T=""""  F %J=1:1:%ST I %T[%SE(%J) W !,%CC,""+"",%I,"": "",%T S %F=1 X CR Q  "
 I Txx=1 S %LK="F %I=1:1 S %T=$T(+%I) Q:%T=""""  F %J=1:1:%ST I $P(%T,"" "")[%SE(%J) W !,%CC,""+"",%I,"": "",%T S %F=1 X CR Q  "
RSEL ;
 S %CC=-1,%PCT=0,%FND=0,%F=0
RSEL1 ;
 S $ZT="RSEL2^%ZAPM.bs.BSER1"
 F %K=1:1 S %CC=$N(^UTILITY(%Jo,%CC)) Q:%CC<0  I %CC'=0 X "ZL @%CC U 0 X:0'=$I ""W:'(%K-1#8) ! W ?(%K-1)#8*10,%CC,""""  """""" U 0 X %LK" X CRT1 S %PCT=%PCT+1 S:%F %FND=%FND+1,%F=0
 D OkMsg^%ZAPM.bs.BSXfun(%PCT_" Программ обработано.")
 U 0
 S Coment="Программы."_Tx_$S(Txx=4:".Состояние до Редактирования",1:"") K t,t0
 D CREAT^%ZAPM.bs.BSTT
 K %SE S %ST=0 W /CUP(1,1),/ED(2) G ASK2
RSEL2 ;
 I $F($ZE,"<NOPGM>") W !,"Routine: ",%CC," not found." G RSEL1
 G ERROR
EXIT ;
 U 0
 K %,%BLK,%CC,%DEV,%F,%FLG,%FND,%LK,%I,%J,%K,%PCT,%SE,%ST,%T,%X,QUIT Q
ERROR ;
 I $F($ZE,"<INRPT>") U 0 W !!,"...Aborted." D EXIT ZQ:$ZV["Wind"!($ZV["Cach"||($ZV["IRIS"))  V 0:$J:$ZB($V(0,$J,2),#0400,7):2
 ZQ
]]></Routine>


<Routine name="%ZAPM.bs.BSERV" type="MAC" languagemode="0"><![CDATA[
%BSERV ;пpогpамма FOR-SERVER ; 12:20   21.03.99
 Q
JOB N T,G,S,LIST I '$$LO Q
 I $$ACTIV(G,T,S,0)=1 Q
 J JOB^%ZAPM.bs.BSERVER(G,T,S):20:1 E  W $$bel^%ZAPM.bs.BS3
 Q
JOBING(PR,XP) N T,G,S,LIST I '$$LO Q 0
 S @G@("OTK",S)="J?" N I,II
 S @G@("CMD",S)="J "_PR_"(XP)::1 S:$T @G@(""OTK"",S)=""JOB!OK""" F I=1:1:T+2 H 1 I $G(@G@("OTK",S))="JOB!OK" S II=1 Q
 Q +$G(II)
ACTIV(G,T,S,N) N WA,ls,li I $G(N) D Wait^%ZAPM.bs.BSXfun("Проверка Активности %BS-Сервера системы "_S)
 S @G@("OTK",S)="?" N I,II
 S @G@("CMD",S)="D ACT^%ZAPM.bs.BSERVER" F I=1:1:T*2 H 1 X:$G(N) WA I $G(@G@("OTK",S))="!" S II=1 Q
 Q +$G(II)
LIST W #,"                 Активны следующие М-Сервера" K LIST
 S I="" F II=1:1 S I=$O(@G@("STA",I)) Q:I=""  D
 .I $$ACTIV(G,T,I,1) W /CUP(II+2,1),II,".",I," Time ",($P($$h^%ZAPM.bs.BS3(),",")-$P(@G@("STA",I),",")),"\ ",$$Time^%ZAPM.bs.BSsFUNR($P($$h^%ZAPM.bs.BS3(),",",2)-$P(@G@("STA",I),",",2)) D  S LIST(II)=I Q
 ..W " "_$E($G(@G@("CMT",I)),1,59)
 .S II=II-1
 I II=1 D ErrMsg^%ZAPM.bs.BSXfun("Нет активных Серверов")
 Q
NUM I $D(LIST(S)) S S=LIST(S)
 I S=0 S S="All"
 Q
COCO(I) ;ВНУТРЕННИЕ КОМАНДЫ КОМАНДЕРУ
 S I=$P(I," ;") I I="LIST" D LIST Q 1
 I I="LAST" D LastMsg^%ZAPM.bs.BSERVF Q 1
 I I="GO" D JOB^%ZAPM.bs.BSERV Q 1
 I $E(I,1,3)'?3U X I Q 1
 Q 0
SEND ;ПОСЛАТЬ СООБЩЕНИЕ
 N T,G,S,I,II,MS I '$$LO Q
 K I
SEN S I=$$LineEdit^%ZAPM.bs.BSXfun($G(I),"Посылайте Текст сообщения в формате: SYS Сам текст... Циркулярно,то All",$C(34),"","","^%ZAPM.bs.BSbufB(""HISTMSGSRV"")") q:YES<1
 I $$COCO(I) G SEN
 S S=$P(I," ") Q:S=""  S MS=$P(I," ",2,999) I S?.N D NUM
 I S'="All",'$D(@G@("STA",S)) D ErrMsg^%ZAPM.bs.BSXfun("Система "_S_" Не активна") G SEN
 I $D(@G@("STA",S)) D MSG(G,T,S,MS) Q
 I S="All" S I="" F II=1:1 S I=$O(@G@("STA",I)) Q:I=""  D MSG(G,T,I,MS)
 Q
MSG(G,T,S,M) ;ПОСЛАТЬ СООБЩЕНИЕ БЕЗ ОЖИДАНИЯ ПОДТВЕРЖЕНИЯ
 S M="Сообщение "_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"-->"_S_" :"_M
 S @G@("CMD",S)="D MSG^%ZAPM.bs.BSERVER("""_$TR(M,$C(34),"")_""")"
 Q
CTRL ;КОНТРОЛЬ
 I '$$AccesMSM^%ZAPM.bs.BSDOS2(4) Q
 N T,G,S,I,II,MS I '$$LO Q
 K I
CTR S I=$$LineEdit^%ZAPM.bs.BSXfun($G(I),"Посылайте Команду %BS-Серверам: SYS Команда... Циркулярно,то All","","","^%ZAPM.bs.BSHLP,CMDSRV","^%ZAPM.bs.BSbufB(""HISTCMDSRV"")") q:YES<1
 I $$COCO(I) G CTR
 S S=$P(I," ") Q:S=""  S MS=$P(I," ",2,999) I S?.N D NUM
 I S'="All",'$D(@G@("STA",S)) D ErrMsg^%ZAPM.bs.BSXfun("Система "_S_" Не активна") G CTR
 I $D(@G@("STA",S)) D CMD(G,T,S,MS) Q
 I S="All" S I="" F II=1:1 S I=$O(@G@("STA",I)) Q:I=""  D CMD(G,T,I,MS)
 Q
CMD(G,T,S,C) ;ПОСЛАТЬ КОМАНДУ
 S @G@("CMD",S)=C
 Q
IntCMD(C) ;ВНУТРЕННЯЯ ТОЧКА КОМАНД М-СЕРВЕРУ
 N T,G,S,I,II,MS I '$$LO Q
 D CMD(G,T,S,C)
 Q
Int(C) ;ВНУТРЕННЯЯ ТОЧКА КОМАНД
 N T,G,S,I,II,MS I '$$LO Q
 X C
 Q
LO() S G=$P($G(^%ZAPM.bs.BSETUP("SERVER",4,4)),"@",15)
 S T=+$P(G,"\") Q:'T 0
 I '$$Data^%ZAPM.bs.BSF12($NA(@$P(G,"\",2))) Q 0
 S S=$P($$ZU^%ZAPM.bs.BS3(1,0),",",2),G=$ZR
 D CLr^%ZAPM.bs.BSF4
 Q 1
SPACE ;ПРОСТРАНСТО ДИСКОВ
 D TempT^%ZAPM.bs.BSTT N B D TempTX^%ZAPM.bs.BSTT("")
 F I="C","D","E","F" S B=$$ZOS9^%ZAPM.bs.BSDOS(I) I +B>0 D SPA(I,B)
 D TempTXT^%ZAPM.bs.BSTT("Распределение Дискового пространства",$G(@%BS(20)@("ErrorTXT")))
 D TempTXTE^%ZAPM.bs.BSTT
 Q
SPA(D,B) N I,C
 F I=1:1:4 S C(I)=$P(B,"^",I)
 D TempTX^%ZAPM.bs.BSTT(" Total space on drive "_D_$J("("_$FN(C(1)*C(3)*C(4),",")_" bytes)",25))
 D TempTX^%ZAPM.bs.BSTT("                 Free "_D_$J("("_$FN(C(1)*C(2)*C(3),",")_" bytes)",25))
 Q
 
DSP N %X,%Y,%A,%B,%C,%I S %X=%DRV Q:%X=-1  S %Y=$$ZOS9^%ZAPM.bs.BSDOS(%X) F %I=1:1:4 S @("%"_$C(64+%I))=$P(%Y,"^",%I)
 S i1=" Free  space on drive "_%X_" "_$J(%A*%B*%C,10)_" bytes  ("_(%A*%B*%C\104857.6/10)_" Megabytes)"
 S i2=" Total space on drive "_%X_" "_$J(%A*%C*%D,10)_" bytes  ("_(%A*%C*%D\104857.6/10)_" Megabytes)" Q
]]></Routine>


<Routine name="%ZAPM.bs.BSERVER" type="MAC" languagemode="0"><![CDATA[
%BSERVER ;%BS-SERVER ; 17:01 10-JUN-98
JOB(G,T,S) ;ЗАПУСК
 D MGR^%ZAPM.bs.BS S @G@("STA",S)=$$h^%ZAPM.bs.BS3(),@G@("CMT",S)="MSM v."_$P($ZV,"Version ",2)_" §"
 F  H T D
 .I $$Data^%ZAPM.bs.BSF12($NA(@G@("EVENT",S))) S CMD=@$ZR D EVE(CMD) I $G(STOP) D KILLS(G,S) H
 .I $$Data^%ZAPM.bs.BSF12($NA(@G@("CMD",S))) S CMD=@$ZR D CMD(CMD) I $G(STOP) D KILLS(G,S) H
 Q
ACT ;АКТИВНЫЙ
 S @G@("OTK",S)="!"
 Q
STOP ;ОСТАНОВ СЕРВЕРА
 S STOP=1 Q
CMD(C) ;КОМАНДЕР СЕРВЕРА
 S %zT=$ZT,$ZT="ERC^%ZAPM.bs.BSERVER"
 X C S @G@("$T",S)=$T,@G@("ERR",S)="OK" K @G@("CMD",S) Q
 Q
EVE(C) ;ПРОВЕРКА СОВЕРШЕНИЯ СОБЫТИЯ
 S %zT=$ZT,$ZT="EVER^%ZAPM.bs.BSERVER"
 X C
 Q
EVER S @G@("EVER",S)=$$ErrSay^%ZAPM.bs.BSF8($ZE) G ER
ERC S @G@("ERR",S)=$$ErrSay^%ZAPM.bs.BSF8($ZE),@G@("$T",S)=0 K @G@("CMD",S)
ER S $ZT=$G(%zT)
 Q
MSMSTOP ;ОСТАНОВ M
 Q
SEND(S,M) ;ПОСЛАТЬ СООБЩЕНИЕ БЕЗ ОЖИДАНИЯ ПОДТВЕРЖЕНИЯ
 D MSG^%ZAPM.bs.BSERV(G,T,S,M) ;ПОСЛАТЬ СООБЩЕНИЕ БЕЗ ОЖИДАНИЯ ПОДТВЕРЖЕНИЯ
 Q
MSG(M) N I,II ;ТОБЕ ПАКЕТ !
 S II=$E(M,1,79) ZU 0 W *27,"[1;1H" ZU 0 W *27,"[1;6;33;41m" ZU 0 W *27,"[K" F I=1:1:$L(II) ZU 0 W $E(II,I),*7
 S @G@("LastMsg",S)=$E($$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3())_"\"_M,1,$$LNG^%ZAPM.bs.BSF12)
 Q
KILLS(G,S) K @G@("STA",S),@G@("$T",S),@G@("ERR",S),@G@("OTK",S),@G@("CMT",S) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSERVF" type="MAC" languagemode="0"><![CDATA[
%BSERVF ; ФУНКЦИИ FOR-%BS-SERVER ; 12:55   17.10.2003
 Q
LastMsg N T,G,S,LIST I '$$LO^%ZAPM.bs.BSERV Q
 D OkMsg^%ZAPM.bs.BSXfun($G(@G@("LastMsg",S),"СООБЩЕНИЙ НЕ БЫЛО !")) Q
EXIT(ku,Sec) ;ОСТАНОВ MSM-СТАНЦИИ БЕЗУСЛОВНЫЙ
 D MSG^%ZAPM.bs.BSERVER("!!! ВАШЕМУ %BS-СЕРВЕРУ ДАЛИ КОМАНДУ СРОЧНО ОСТАНОВИТЬСЯ !!!")
 H +$G(Sec,5)
 I ku=2 D S^%ZAPM.bs.BSD2
 I ku=1 D SS^%ZAPM.bs.BSD2
 Q
UPG(U)
 D MSG^%ZAPM.bs.BSERVER("!!! ВАШ ПРОЦЕСС ОСТАНОВЯТ ДЛЯ ПРИНУДИТЕЛЬНОГО ПОВЫШЕНИЯ ВЕРСИИ %BS !!!") H 5
 D %BSKJ J IntSELF^%ZAPM.bs.BSMENU(U):20:1 ;АВТОМАТИЧЕСКОЕ ПОВЫШЕНИЕ ВЕРСИИ %BS
 Q
%BSKJ N I ;ТОРМОЗ ЗАДАНИЯ ОСНОВНОГО ПРОЦЕССА %BS
 S I=$$%BSJ I I D KJ(I)
 Q
%BSJ() N I,II ;НОМЕР ЗАДАНИЯ ОСНОВНОГО ПРОЦЕССА %BS
 S II=0 F I=1:1:20 D  Q:II
 .L +@("%BSj"_I):1 E  S II=I
 .L -@("%BSj"_I)
 Q II
KJ(J) D MGR^%ZAPM.bs.BS,KILL^KILLJOB(J,1)
 Q
EXE(EXE,N) ;ДОС-ПРОЦЕСС ДАЖЕ НА М-СЕРВЕРЕ
 I N=1 S EXE=$$JOB^%HOSTCMD(EXE) Q
 D LV^%ZAPM.bs.BSF4 D EXE^%ZAPM.bs.BSDOS(EXE,1)
 Q
PEEK(SYS,H) ;ПОДГЛЯДЕТЬ ЭКРАН, СКОЛЬКО СЕКУНД ОЖИДАТЬ ОТКЛИКА
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 N I
 I '$$LO^%ZAPM.bs.BSERV Q
 K @G@("SCR",SYS) S @G@("CMD",SYS)="D SCRSAVE^%ZAPM.bs.BSERVF" F I=1:1:H H 1 I $D(@G@("SCR",SYS)) S I=$ZR D LoadWinV^%ZAPM.bs.BSXfun($NA(@G@("SCR",SYS)),1) W $$bel^%ZAPM.bs.BS3,$$bel^%ZAPM.bs.BS3,$$bel^%ZAPM.bs.BS3,$$r^%ZAPM.bs.BS3 K @I Q
 Q
SCRSAVE ;D SaveWinV^%ZAPM.bs.BSXfun(1,1,25,80,$NA(@G@("SCR",S)),1)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF" type="MAC" languagemode="0"><![CDATA[
%BSF ;КОМАНДЫ И РЕЖИМЫ F-КЛАВИШ ; 13:42   13.01.2003
 S LAB=$TR(%JB(%JB),",","")_%B G @LAB
10 D 333 D d G:$D(NAZAD) 0^%ZAPM.bs.BSTM
100 S %zT=$ZT,$ZT="P^%ZAPM.bs.BSF" S:'$P(@(BSR_"(BST)"),"@",23) (@(BSR_"(BST,""STA"")"),%BS("Tmp","LastTabl"))=ny_","_nx_"@"_BSY(BS0)_"@"_BSX(BS0)_"@"_R1_"@"_R2_"@"_R3_"@"_MY_"@"_MX_"@"_$P(BS,"@",15)
1000 S $P(@(BSR_"(BST)"),"@",30)="" D  D d I BSR'="^%ZAPM.bs.BSbufB",$D(^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1")) K @$ZR
 .I $E(BST)="@" S I=$E(BST,2,99),$P(@(BSR_"(I)"),"@",30)=""
END S $ZT=$G(%zT) I $D(BSR) D U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
 I $P($G(@BSR@(BST)),"@",41)'="" D  ;ПРЕДОБР.ПЕРЕД ВЫХОДОМ
 .N R1 S R1=999 D Pred^%ZAPM.bs.BSF12($P($G(@BSR@(BST)),"@",41)) Q
 K S,STATUS,VYC,BS0,BSX,BSY,B,BX,BY,x,t,zr,t1,%VDB,%CAL,%X1,%X2,%Y1,%Y2,%TIT,MR,%w(2),M1,BS,%w(4),%w(5),%DIA,%DI,%ZAP,%FK,i,j,ii,jj,se,ke,j1,j2,j3,MX,MY,M,BS1,BS2,BSF,BSX1,BSX2,BSY1,BSY2,CLR,ENDLI,BSI,BSII,NAZAD,li,ls,lo
 ;K MR23,MR24,MR25,%Cu
 K ColrMenu,ObOi,RA,PREDMOV,MxX,MyY,My,Mx,COLOR,EXITout,%FN,%DEV,es,ek,h,hi,hl,%INV,%INV1,%INV2,v,vv,vvv
 K Ukaz,GGG,Na,POSt,PredOb,Sel,TmP,Tmp,Sort,Ny,%BSTM,AllWAY,KsP,%BStree
 Q
 ;ЗАПИСЬ В Б.Д.
3333 Q:$P(@(BSR_"(BST,ny,nx)"),"@",9)<2  I $D(@gBuf@(ny,nx)) S zr=@$ZR D  Q
 .I $D(Hid) D  Q  ;HiddenLastKey
 ..Q:$P($P(@BSR@(BST,ny,nx),"@",18),"#",2)=""  S nynx=$P($P(^(nx),"@",18),"#",2)
 ..Q:'$D(@Hid@(ny))  I $$BSDAT(%NAm,@Hid@(ny))
 ..I zr="" K @$ZR@(nynx) Q
 ..S @$ZR@(nynx)=zr
 .I $P($P(@(BSR_"(BST,ny,nx)"),"@",18),"#")'="" S nynx=$P($P(^(nx),"@",18),"#")
 .E  S nynx=ny_","_nx
 .I zr="" K @(%NAm_"nynx)") Q
 .S @(%NAm_"nynx)")=zr ;ЗАПИСЬ В Б.Д.
 Q
BSDAT(N,H) S N=$E(N,1,$L(N)-1)_")" I $D(@N@(H))
 Q $T
 ;
22 D BLout^%ZAPM.bs.BSout G D   ;ВЫВОД БЛОКА
21111 D Kout^%ZAPM.bs.BSout0(1) K in G D   ;ВЫВОД НА ПРИНТ. (ВСЕ)
21121 D Kout^%ZAPM.bs.BSout0(2) K in G D   ;ВЫВОД В ФАЙЛ (ВСЕ)
21131 D Kout^%ZAPM.bs.BSout0(3) K in G D   ;ВЫВОД В ТЕКСТ (ВСЕ)
21141 D Kout^%ZAPM.bs.BSout0(4) K in G D   ;ВЫВОД НА РТА (ВСЕ)
2115 D OUTHTML^%ZAPM.bs.BSre G D
2116 D OUTJAVA^%ZAPM.bs.BSHTML1 G D
2117 D OUTHTMLT^%ZAPM.bs.BSre G D
2121 D DTout^%ZAPM.bs.BSout3(1) G D   ;ВЫВОД ДАННЫХ НА ПРИНТ.(ВСЕ)
2122 D DTout^%ZAPM.bs.BSout3(2) G D   ;ВЫВОД ДАННЫХ В ФАЙЛ (ВСЕ)
2123 D DTout^%ZAPM.bs.BSout3(3) G D   ;ВЫВОД ДАННЫХ В ТЕКСТ (ВСЕ)
2124 D DTout^%ZAPM.bs.BSout3(4) G D   ;ВЫВОД ДАННЫХ НА РТА (ВСЕ)
 G D
R Q
41 S li=d G LE^%ZAPM.bs.BSTM
42 I $E($G(%BS(14)),3) S ls=" С УСТРОЙСТВА "_$G(%BS(3),$P)_"  КОРРЕКЦИЯ ЗАПРЕЩЕНА " D O^%ZAPM.bs.BSF7 G D
 I $P(@(BSR_"(BST)"),"@",22) S ls=" ТАБЛИЦА ОПТИМИЗИРОВАНА, КОРРЕКЦИЯ ЗАПРЕЩЕНА " D O^%ZAPM.bs.BSF7 G D
 I '$D(%w(4)) D PASE^%ZAPM.bs.BST1 E  H 1 G D
 D PASE^%ZAPM.bs.BST1 E  G D
 S LOC=1,YES=1 D EDCOPY,0 G D:'LOC,D:BST'["@" K Ukaz S OO=2,OOO="^%ZAPM.bs.BS" K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA,MEO G D:R1=27 S LAB="E"_$TR(%JB(%JB),",","")_%B_"^%ZAPM.bs.BSF",LAB=LAB_$S(LAB["E15":4,1:1)
 D  G:'$D(%GO) @LAB D @%GO S ls="готово" D WAITS^%ZAPM.bs.BSF2 H 1 G D:'$D(Quit)
 .;D OkMsg^%ZAPM.bs.BSXfun("LAB="_LAB_",%GO="_$G(%GO))
 G B^%ZAPM.bs.BSTM:$G(Quit)'=2 Q
E3 S li=$P(BS,"@",6) W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),"K Вводите / Корректируйте символьное имя Клетки (До 4 символов)" D 24^%ZAPM.bs.BSTM,LINE^%ZAPM.bs.BSF1 I  S $P(@(BSR_"(BST,ny,nx)"),"@",6)=$E(li,1,4) D 24^%ZAPM.bs.BSTM Q
 Q
43 I '$D(%DIA) S ls=" Блок не определен " D O^%ZAPM.bs.BSF7 G D
 ;ЭКРАННОЕ РЕДАКТИРОВАНИЕ ВИДИМОЙ ЧАСТИ БЛОКА !!!!
 D SCREEN^%ZAPM.bs.BSTT G D
44 G D:$D(%ZAP) I '$D(%w(5)) D PASD^%ZAPM.bs.BST1 E  G D
 S ls=" ВЫ УВЕРЕНЫ ? ЧТО ХОТИТЕ ДАННЫЕ КЛЕТКИ КОПИРОВАТЬ В БЛОК ? " D YESp^%ZAPM.bs.BSF G D:'YES S li=d,do="D SET" D BLOK^%ZAPM.bs.BSF1 I  D W^%ZAPM.bs.BST
 G D
51 S bf=1 K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf) S i=ny,j=nx D  G D
 .S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i,j)=@(BSR_"(BST,i,j)") F f="FTR","FCL","COL","RTR","CMD" I $D(@(BSR_"(BST,f,i,j)")) S z=$ZR,z1=$G(^(j,1)),^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,f,i,j)=@z I z1'="" S ^(j,1)=z1
52 S bf=2 K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf) S do="D BUF" D BLOK^%ZAPM.bs.BSF1 G D
53 S bf=3 I $D(@(BSR_"(BST)")) S TRe1=$P($ZR,")"),TRe2="^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",3" K NOKILLER D TREE^%ZAPM.bs.BSTK
 G D
541 G SAVED^%ZAPM.bs.BSF3
542 G RESTO^%ZAPM.bs.BSF3
551 D TXTSAVB^%ZAPM.bs.BSTT G D
552 D TXTSAVA^%ZAPM.bs.BSTT G D
651 G CONT^%ZAPM.bs.BSS
652 G CONTAB^%ZAPM.bs.BSS
66 D ^%ZAPM.bs.BSMSM G D
67 D ^%ZAPM.bs.BSDOS G D
68 S lo=0 D:'$D(%CAL) CALC^%ZAPM.bs.BSF3 D CALOGIC^%ZAPM.bs.BSF3 G D
69 ;АВТОФОРМАТИРОВАНИЕ
 I $G(@BSR@(BST,"sp"))="S" D ErrMsg^%ZAPM.bs.BSXfun("РЕЖИМ ПРОВЕРКИ ФОРМАТА ДЛЯ СПИСКОВ И СВОДОК НАДО ВЫСТАВИТЬ В РЕЖИМЕ РЕДАКТИРОВАНИЯ ОПИСАНИЯ") G D
 S Tmp=$S(TIP=2:3,1:1) I $P(@BSR@(BST),"@",47) S Tmp=$P(@BSR@(BST),"@",47)
 D CHECKF^%ZAPM.bs.BSF10(Tmp) ;АВТОФОРМАТ
 G D
61 D CALC^%ZAPM.bs.BSF3 G D
610 G TITUL^%ZAPM.bs.BSF12
71 S fi=nx G FIND^%ZAPM.bs.BSS
72 S fi=0 G FIND^%ZAPM.bs.BSS
73 G FIDD^%ZAPM.bs.BSS
74 S fi=0,Tmp="Mark" G FIND^%ZAPM.bs.BSS
62 G ^%ZAPM.bs.BSS
6311 G INV^%ZAPM.bs.BSS
6312 G INVTAB^%ZAPM.bs.BSF11
6321 G DIN^%ZAPM.bs.BSS
6322 G DINTAB^%ZAPM.bs.BSF11
633 G AF2^%ZAPM.bs.BSN
634 D ButtPan^%ZAPM.bs.BSF8 G 0^%ZAPM.bs.BSTM
64 G REM^%ZAPM.bs.BSF5
ZA D CL^%ZAPM.bs.BSF4 Q
81 S i=ny,j=nx I $D(@(BSR_"(BST,i,j)")) D DEL^%ZAPM.bs.BSF1 D:$D(%CAL) CALC^%ZAPM.bs.BSF3 G D
82 S do="D DEL" D BLOK^%ZAPM.bs.BSF1 I  D W^%ZAPM.bs.BST D:$D(%CAL) CALC^%ZAPM.bs.BSF3
 G D
9 D INFO^%ZAPM.bs.BSF6 G D
1 S IYI="^%ZAPM.bs.BSHLP(GUIDE" D NE^%ZAPM.bs.BSN
D G 0^%ZAPM.bs.BSTM
d Q
P I $ZE'["<PRO" S ls=$ZE D O^%ZAPM.bs.BSF7
 S $ZT=$G(%zT) G END
0 W $$atr^%ZAPM.bs.BS3(0) Q
YESp D YES2(ls) Q
YES2(ls) N col,co S col=7,M(1,1)="  ДА  ",M(1,2)="  НЕТ  " G OK1 //OK
ER(ls) N col,co S col=9,co=8 G OKp //ERROR
OK(ls) N col,co S col=7 G OKp //OK
OKp N M,GLZ 
 S M(1,1)="  OK  "
OK1 S GLZ=$ZR,M(0,1)=$E(ls,1,70),M(0,2)=$E(ls,71,140),M(0,3)=$E(ls,141,210),Refresh=1
 S M="/"_$P(%BS,"!",col),M(0)=$P(%BS,"!",col),M(1)=$P(%BS,"!",col)_"/"_$P(%BS,"!",$G(co,3))
 S %B=$$TxtPanel^%ZAPM.bs.BSXfun1("M",0,0,$G(%B,1)) I YES=0 S R1=27
 S YES=$S(R1=27!(%B=2):0,1:1) I GLZ'[$C(34),$D(@GLZ)
 Q
YES ;ВЫБОР
 I %BS(13)'="%BS-PC" G YES1
 N M,GLZ S GLZ=$ZR,M(0,1)=$E(ls,1,70),M(0,2)=$E(ls,71,140),M(0,3)=$E(ls,141,210),M(1,1)="  ДА  ",M(1,2)="  НЕТ  "
 S M="/"_$P(%BS,"!",8),M(0)=$P(%BS,"!",8),M(1)=$P(%BS,"!",8)_"/"_$P(%BS,"!",3)
 S %B=$$TxtPanel^%ZAPM.bs.BSXfun1("M",0,0,$G(%B,1)) I YES=0 S R1=27
 S YES=$S(R1=27!(%B=2):0,1:1) I GLZ'[$C(34),$D(@GLZ)
 Q
YES1 N OO,OOO,M,%JB
 W /CUP(25,1) D 0 W /EL(0),$$clr^%ZAPM.bs.BS3(8),$E(ls,1,79) S OOO="M",OO=1,M(1,1)=" .ДА. .НЕТ. @6@ @0" 
 D 0,24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB S YES=$S(R1=27!(%B=2):0,1:1) W /CUP(25,1),/EL(0) 
 Q
EDCOPY Q:$E(BST,1)="@"  S i="@"_BST D L^%ZAPM.bs.BS3($NA(@BSR@(i))) Q:'LOC  D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) I 'LOC Q
 I $D(@(BSR_"(i)")) S ls=" Существуют результаты предидущей коррекции описания таблицы. Игнорируем их ? " D YESp G:'YES EDC I YES K @(BSR_"(i)") D EDCO Q
EDCO S (BSr1,BSr2)=BSR,BSt1=BST,BSt2="@"_BST,YES=1 D COPY^%ZAPM.bs.BSTK I 'YES Q
EDC S BST="@"_BST K ^%ZAPM.bs.BSbufB("I"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D W^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM,W^%ZAPM.bs.BSTM Q
MEO S $P(@(BSR_"(BST)"),"@",7)=1 Q  ;МЕТКА О КОРРЕКЦИИ О.T.
MED S $P(@(BSR_"(BST)"),"@",6)=1 Q  ;МЕТКА О КОРРЕКЦИИ ДАННЫХ
3 D 333 G D
333 I BST["@" K NAZAD D  Q:$D(NAZAD)  K ^%ZAPM.bs.BSbufB("I"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 .S ls=" Описание таблицы корректировалось ! Cохраним новое описание ? ",%B=1 D YESp S:R1=27 NAZAD=1 Q:$D(NAZAD)  I 'YES G KILL
 .I $P(@(BSR_"(BST)"),"@",17)=3!($P(@$ZR,"@",17)=4) S NOKEY=1 D TEST^%ZAPM.bs.BST3,CL^%ZAPM.bs.BSF4 G:YES Z3 D ZZ3 Q
 .I $P(@(BSR_"(BST)"),"@",17)=2 D Free^%ZAPM.bs.BSF12
 .I $P(@(BSR_"(BST)"),"@",17)=7 D SETMENU^%ZAPM.bs.BSF4($ZR)
Z3 .S @BSR@(BST,"LST")=$$h^%ZAPM.bs.BS3()_","_$G(%BS(12)) D SNX("S",$NA(@BSR@($P(BST,"@",2,99))),"TAB")
 .S ls="ПЕРЕЗАПИСЬ" D WAITS^%ZAPM.bs.BSF2 ;!!!I LONG ??????
 .I $D(@(BSR_"(BST)")) S i=$E(BST,2,99),(jj,j)=$ZR K vv,@(BSR_"(i)") S @(BSR_"(i)")=@j F  S j=$ZO(@j) Q:j=""!(j'[($P(jj,")")_","))  X WA D  S @(BSR_"(i,"_$P($P(j,"(",2),",",2,999))=g
 ..S g=@j I g["^[""" F v=2:1 Q:$P(g,"^[""",v)=""  I $P($P($P(g,"^[""",v),"""]"),",""",2)'=""  S vv($P($P($P(g,"^[""",v),"""]"),",""",2))=""
 ..Q:"""FCL""COL""RTR""KEY""FTR"""'[$P($P(j,"(",2),",",2)  Q:g'[BST  S g=@j F  S g=$P(g,BST)_$E(BST,2,99)_$P(g,BST,2,255) Q:g'[BST
 .I $ZV["MSM" I $D(vv) S v="" K vvv F  S v=$O(vv(v)) Q:v=""  F %VGI=0:1 Q:$$ZU^%ZAPM.bs.BS3(1,%VGI)=""  I v=$P($$ZU^%ZAPM.bs.BS3(1,%VGI),",",2) D INT^%SP I $G(%BS(4),"!")[$P($S($$ver^%ZAPM.bs.BSF7()="]":%SPDBNA,1:VOLDBNA),"/") S vvv(v)=$S($$ver^%ZAPM.bs.BSF7()="]":%SPDBNA,1:VOLDBNA)
KILL .K @(BSR_"(BST)") S BST=$E(BST,2,99) I '$D(vvv) K @(BSR_"(BST,""HVL"")") S $P(@(BSR_"(BST)"),"@",37)=""
 .I $D(vvv) S $P(@(BSR_"(BST)"),"@",37)=1,v="" F  S v=$O(vvv(v)) Q:v=""  S @(BSR_"(BST,""HVL"",v)")=vvv(v)
 .D U^%ZAPM.bs.BS3($NA(@BSR@("@"_BST))),U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
33 K NAZAD Q:$D(NOKEY)!($D(%ZAP))  ;СОХР БД
 ;```S lo=0,$P(B,"@",48)="" D:"1"[$G(%CAL)  D COL^%ZAPM.bs.BSF3 S B=@BSR@(BST)
 S lo=$P(B,"@",48),$E(lo,1)=0,$P(B,"@",48)=lo,lo=0,gBuf=$NA(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)))
 D:"1"[$G(%CAL)  D COL^%ZAPM.bs.BSF3 S B=@BSR@(BST)
 .D CALC^%ZAPM.bs.BSF3
 I lo S ls=" ВНИМАНИЕ !!! Есть ОШИБКИ ДАННЫХ ! Снова будем редактировать ? " D YESp I YES S NAZAD=1 Q
 Q:TIP'=2  I '$P($G(@gBuf),"@",2) D %NAm^%ZAPM.bs.BST1,U^%ZAPM.bs.BS3(%NAm) Q  ;```,FLAG(%NAm,lo) Q
 G:$P(@BSR@(BST),"@",45) ZAPIS S ls=$S($P(@BSR@(BST),"@",49):$P(@BSR@(BST),"@")_" РЕДАКТИРОВАЛСЯ.",1:"")_" Записываем в Базу Данных результаты коррекции ? "_$S(lo:"С ОШИБКАМИ !?! ",1:"") S %B=$S(lo:2,1:1) W:lo $$bel^%ZAPM.bs.BS3 D YESp I 'YES S $P(@gBuf,"@",2)=1 Q
 I lo S ls=" ЗАПИШЕМ КАРТУ БАЗЫ ДАННЫХ С "_lo_" ОШИБКАМИ ! ВЫ УВЕРЕНЫ ? ",%B=2 W $$bel^%ZAPM.bs.BS3 D YESp I 'YES S $P(@gBuf,"@",2)=1 Q
ZAPIS D %NAm^%ZAPM.bs.BST1,FOR^%ZAPM.bs.BSF3,L^%ZAPM.bs.BS3(%NAm) I 'LOC Q  //BUF 2 BD
 S %zT=$ZT,$ZT="ER333^%ZAPM.bs.BSF"
 N zapi
 I $P(B,"@",41)'="" N R1 S R1=777 D Pred^%ZAPM.bs.BSF12($P(B,"@",41)) ;ПРЕДОБР.ДО ЗАПИСИ
 X I_" D 3333" D FLAG(%NAm,lo)
 S $P(@gBuf,"@",2)=""
 I $P(B,"@",41)'="" N R1 S R1=888 D Pred^%ZAPM.bs.BSF12($P(B,"@",41)) ;ПРЕДОБР.ПОСЛЕ ЗАПИСИ
 S $ZT=$G(%zT) Q
 ;```!!!!K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15))
FLAG(%NAm,lo,II) N I,III,BSLOGIN D U^%ZAPM.bs.BS3(%NAm)
 I $D(@($E(%NAm,1,$L(%NAm)-1)_")"))["0" S I=$$h^%ZAPM.bs.BS3() I 1
 E  S I=$P($G(@$ZR),",",5,6) I $G(I)="" S I="?,?"
 S III=$P($G(@($E(%NAm,1,$L(%NAm)-1)_")")),",",3)
 S BSLOGIN=$S($G(II):III,1:$G(%BS(12)))
 S @($E(%NAm,1,$L(%NAm)-1)_")")=$$h^%ZAPM.bs.BS3()_","_BSLOGIN_","_$S(lo:3,1:1)_","_I
 D SNX("S",$ZR,"DAT")
 Q
SNX(A,R,T) I $ZV["Cach"||($ZV["IRIS") D SNX^%ZAPM.bs.BSChT1(A,R,T)
 Q
ZZ3 S ls=" ВНИМАНИЕ !!! ОШИБКИ ТРАНСЛЯЦИИ ФОРМУЛ ! Снова будем редактировать ? " D YESp S:YES NAZAD=1 Q
ER333 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) S NAZAD=1 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF1" type="MAC" languagemode="0"><![CDATA[
%BSF1 ;КОРРЕКЦИЯ ОПИСАНИЯ ТАБЛИЦЫ ; 8:39   31.10.2001
BLOK N EndLoop D WAIT^%ZAPM.bs.BSF2 I '$P(@(BSR_"(BST)"),"@",3) S ls=" Блок не определен " D O^%ZAPM.bs.BSF7 X "I 0" Q
 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  X $G(WA) F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  I $P(^(j),"@",12) X do G:$D(EndLoop) Blo
Blo I 1 Q
DEL I $P(^(j),"@",5)!($D(%ZAP)) Q
 I $P(^(j),"@",9)=1 S Tmp=$ZR D AHI("DAT",$P(^(j),"@",15)) S $P(@Tmp,"@",15)="" Q
 S $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1 I $D(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) S Tmp1=$ZR,Tmp=@Tmp1,@Tmp1="" D:Tmp'="" AHI("DAT",Tmp)
 Q
SET I $P(^(j),"@",5)!($D(%ZAP)) Q
 I $P(^(j),"@",9)=1 S $P(^(j),"@",15)=li Q
 S $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1 S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=li Q
BUF S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i,j)=^(j) F f="FTR","FCL","COL","RTR" I $D(@(BSR_"(BST,f,i,j)")) S z=$G(@$ZR),z1=$G(@$ZR@(1)),z2=$G(^(2)) I z'="" S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,f,i,j)=z,^(j,1)=z1 I z2'="" S ^(2)=z2
 I $D(@(BSR_"(BST,""CMD"",i,j)")) S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,"CMD",i,j)=@$ZR
 Q
E111 S nOy=ny,nOx=nx D CLR20E S:COLORS'="" $P(@(BSR_"(BST,nOy,nOx)"),"@",10)=COLORS K nOx,nOy G D
CLR2 Q:R1=27  S $P(@(BSR_"(BST)"),"@",31)=COLORS,COLOR=COLORS Q
E112 D CLR20E,CLR1 G E111E
E114 D CLR20E,CLR2 G E111E
CLR1 Q:R1=27  S do="S $P(^(j),""@"",10)=COLORS" D BLOK Q
Color(Color) N COLORS,i,j ;Вызов палитры
 D CLR20E Q $G(COLORS)
CLR20E D SA^%ZAPM.bs.BSsBUF D  D RE^%ZAPM.bs.BSsBUF Q
 .D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,COLORS,R1,Color)
 .I '$D(^%ZAPM.bs.BSbufB("CLR")) S BSr1="^%ZAPM.bs.BSS",(BSt2,BSt1)="CLR",BSr2="^%ZAPM.bs.BSbufB" D COPY^%ZAPM.bs.BSTK
 .I $D(Color) F i=1:1:8 F j=1:1:16 I $P(^%ZAPM.bs.BSbufB("CLR",i,j),"@",10)=Color S $P(^%ZAPM.bs.BSbufB("CLR","STA"),"@",7)=i+9,$P(^%ZAPM.bs.BSbufB("CLR","STA"),"@",8)=j*4+6 Q
 .S BSR="^%ZAPM.bs.BSbufB",BST="CLR" D STA^%ZAPM.bs.BST S COLORS=$S(R1=27:"",1:$P(@(BSR_"(BST,ny,nx)"),"@",10)) Q:R1=27  S ls=" Мерцание нужно ? ",%B=2 D YES^%ZAPM.bs.BSF I YES S $P(COLORS,";",2)=5 Q
E113 S d=$P(BS,"@",10),do="S $P(^(j),""@"",10)=d" D BLOK
E111E D CL^%ZAPM.bs.BSF4 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G D
E72 S do="I '$D(^%ZAPM.bs.BSbufB(""f""_$G(%BS(3),$P)_$J_""u""_%BS(15),i)) S ^(i)=1" K ^%ZAPM.bs.BSbufB("f"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D BLOK G D:'$T D E710 S s=0 F  S s=$O(^%ZAPM.bs.BSbufB("f"_$G(%BS(3),$P)_$J_"u"_%BS(15),s)) Q:s=""  D HSTR
 K ^%ZAPM.bs.BSbufB("f"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D TAB,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
E710 S s=ny,(ii,li)=$P(BS,"@",3)
 S ls=" Корректируйте высоту строки" D LINE,E711 G E710:$D(ERRO) Q
A25 W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) Q
E71 ;ВЫСОТА КЛЕТКИ
 D E710 G D:'YES I ii'=li D HSTR,TAB,W^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 G D
HSTR ;s- СТРОКА li- НОВАЯ ВЫСОТА
 I $D(@(BSR_"(BST,s,1)")) F ii=1:1 Q:'$D(^(ii))  S $P(^(ii),"@",3)=li
 Q
WinL(L) Q ($P(@BSR@(BST),"@",L)-$P(@BSR@(BST),"@",L-2)+1)
ErrWin S ERRO=1 D O^%ZAPM.bs.BSF7 Q
E711 K ERRO S li=+li I $$WinL(10)<li S ls=" Высота строки БОЛЬШЕ высоты окна" G ErrWin
 I li<1!(li>20) S ls=" Нарушение диапазона 1:20 " G ErrWin
e Q
E811 K ERRO S list=li,li=+li I $$WinL(11)<li S ls=" Длина колонки БОЛЬШЕ длины окна" G ErrWin
 I li<1!(li>77) S ls=" Нарушение диапазона 1:77 " G ErrWin
 Q
E810 S k=nx,s=ny,(ii,li)=$P(BS,"@",4)
 S ls="Корректируйте длину колонки (раздвижка: N>-справа N<-слева N<>-центрир)" D LINE,E811 G E810:$D(ERRO) Q
E82 S do="I '$D(^%ZAPM.bs.BSbufB(""f""_$G(%BS(3),$P)_$J_""u""_%BS(15),j)) S ^(j)=1" K ^%ZAPM.bs.BSbufB("f"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D BLOK G D:'$T D E810 S k=0 F  S k=$O(^%ZAPM.bs.BSbufB("f"_$G(%BS(3),$P)_$J_"u"_%BS(15),k)) Q:k=""  D LSTR
 K ^%ZAPM.bs.BSbufB("f"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D TAB,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
E81 ;ДЛИНА КОЛОНКИ
 D E810 G D:'YES I ii'=li D LSTR,TAB,W^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 G D
LSTR ;k- КОЛОНКА li- НОВАЯ ДЛИНА
 F ii=1:1 Q:'$D(@(BSR_"(BST,ii,k)"))  D
 .I list[">"!(list["<")!(list["<>") D RAZ($P(^(k),"@",4),$P(^(k),"@",3),list,$P(^(k),"@",15))
 .I '(list[">"!(list["<")!(list["<>")),$E(%BS(1),10) D RAZ($P(^(k),"@",4),$P(^(k),"@",3),list_$S($E(%BS(1),10)=1:">",$E(%BS(1),10)=2:"<",1:"<>"),$P(^(k),"@",15))
 .S $P(^(k),"@",4)=li
 Q
RAZ(LO,H,LST,D) ;РАЗДВИЖКА
 N L,M,I
 Q:D=""  I $D(AFORM),$P(^(k),"@",12) Q
 F I=1:1:H S M(I)=$E(D,I*LO-LO+1,LO+(LO*(I-1)))
 I (LST-LO)>0 S L=LST-LO D  G RAZSET
 .I LST["<>" D  Q
 ..F I=1:1:H S M(I)=$$RA($$RAZS(L,1),$E(M(I),1))_M(I)_$$RA($$RAZS(L,2),$E(M(I),$L(M(I))))
 .I LST[">" F I=1:1:H S M(I)=M(I)_$$RA(L,$E(M(I),$L(M(I))))
 .I LST["<" F I=1:1:H S M(I)=$$RA(L,$E(M(I),1))_M(I)
 I (LST-LO)<0 S L=LO-LST D  G RAZSET
 .I LST["<>" D  Q
 ..F I=1:1:H S M(I)=$E(M(I),$$RAZS(L,1)+1,$L(M(I))-$$RAZS(L,2))
 .I LST[">" F I=1:1:H S M(I)=$E(M(I),1,$L(M(I))-L)
 .I LST["<" F I=1:1:H S M(I)=$E(M(I),L+1,$L(M(I)))
RAZSET S M="" F I=1:1:H S M=M_M(I)
 S $P(^(k),"@",15)=$$Cut^%ZAPM.bs.BSF10(M) Q
RAZS(W,N) ;ПОПАЛАМ
 I '(W#2) Q (W\2)
 I N=1 Q (W\2)+1
 Q (W\2)
RA(L,S) ;ПОВТОР
 I '($A(S)>178&($A(S)<220)) S S=" "
 Q $TR($J("",L)," ",S)
TAB D Wait^%ZAPM.bs.BSXfun("ФормированиеТаблицы")
TABM G:$P($ZV,"Version ",2)<4&($ZV'["Cach"&&($ZV'["IRIS")) TABm ;АВТОФОРМАТИРОВАНИЕ
 N i,j,x,y,h,l,L,H S ke=$O(@BSR@(BST,1,"&"),-1) X WA G:ke>4092 TABm
 F j=1:1:ke S $E(L,j)=$C($P(@BSR@(BST,1,j),"@",4))
 S se=$O(@BSR@(BST,"&"),-1) G:se>4092 TABm X WA F i=1:1:se S $E(H,i)=$C($P(@BSR@(BST,i,1),"@",3))
 F i=1:1:se S y=$S('$D(y):1,1:y+h),h=$A($E(H,i)) D  K x I '(i#50) X WA
 .F j=1:1:ke S x=$S('$D(x):1,1:x+l),l=$A($E(L,j)),$P(@BSR@(BST,i,j),"@",1,2)=y_"@"_x
 S $P(@BSR@(BST),"@",28)=se,$P(@$ZR,"@",29)=ke
SaveM I $G(@BSR@(BST,"SVM"))'="" D XM^%ZAPM.bs.BSre(@$ZR)
 Q
TABm ;```СТАРЫЙ МОДУЛЬ
 N x,y,h,l F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  S y=$S('$D(y):1,1:y+h),h=$P(@(BSR_"(BST,i,1)"),"@",3) D  K x I '(i#50) X $G(WA)
 .F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  S Tmp=@$ZR,x=$S('$D(x):1,1:x+l),$P(Tmp,"@",2)=x,$P(Tmp,"@")=y,l=$P(Tmp,"@",4) S:$D(TSV)&($P(Tmp,"@",15)=0) $P(Tmp,"@",15)="" S ^(j)=Tmp
 K x,y,l,h S $P(@(BSR_"(BST)"),"@",28)=i-1,$P(@$ZR,"@",29)=j-1
 G SaveM
 Q
LINE ;КОРРЕКЦИЯ СТРОКИ
 S ll="@# " D LE^%ZAPM.bs.BSTT I YES
 Q  ;I 1 Q
LIF X "I 0" Q
LINF N say1,say2 S say1=ls,say2=%hlp ;КОРРЕКЦИЯ ФУНКЦИЙ *
LINEFUN S ll="" D LE^%ZAPM.bs.BSTT I YES D E1F I 'YES S ls=say1,%hlp=say2 G LINEFUN
 Q  ;I 1 Q
E41 S i=$P(BS,"@",9),k=$S(i=1:2,1:1) D:k=2 BDCN I YES S $P(@(BSR_"(BST,ny,nx)"),"@",9)=k G D
 G D
E421 S k=1 G E4
E422 S k=2 D BDCN I 'YES G D
E4 S do="S $P(^(j),""@"",9)=k" D BLOK I  D W^%ZAPM.bs.BST
D G 0^%ZAPM.bs.BSTM
BDCN I '$D(BSCN) S YES=0 I $G(@(BSR_"(BST,""KEY"")"))'["^" S ls=" ВАША ТАБЛИЦА БУДЕТ ПРИКРЕПЛЯТЬСЯ К КАКОЙ-НИБУДЬ БАЗЕ ДАННЫХ ? " D YES^%ZAPM.bs.BSF I 'YES Q
 S YES=1,BDCN=1 Q
E61 S i=$P(BS,"@",5),$P(@(BSR_"(BST,ny,nx)"),"@",5)=$S(i=1:"",1:1) G D
E621 S k="" G E6
E622 S k=1
E6 S do="S $P(^(j),""@"",5)=k" D BLOK G D
E631 S k="" G E6A
HIS(f) S %HIS=$NA(^%ZAPM.bs.BSbufB("HIStory"_f_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")))
 Q
AHI(f,d) Q:d=""  N %HIS D HIS(f) D AddHist^%ZAPM.bs.BSXuse(%HIS,"Удалено{"_ny_","_nx_","_BST_"}="_d)
 Q
E632 S k=1
E6A S do="S $P(^(j),""@"",5)=k" D ALLT^%ZAPM.bs.BSS1 G D
EE11 S li1=$G(@(BSR_"(BST,f,ny,nx)")),li=$G(^(nx,1)) I li="" S li=$P($G(@BSR@(BST,ny,nx)),"@",$S(f="FCL":7,f="FTR":8,f="COL":13,1:16)) Q
 Q
E11 S f="FCL" D EE11,HIS(f) S YES=0,%hlp="^%ZAPM.bs.BSHLP(200",ls=" Вводите / Корректируйте формулу вычисления в клетке {"_ny_","_nx_"}. Помощь-F1" D LINF I YES S i=ny,j=nx D E1Z D:$D(%CAL) CALC^%ZAPM.bs.BSF3
 G D
E141 S f="COL" D EE11,HIS(f) S YES=0,%hlp="^%ZAPM.bs.BSHLP(203",ls=" Вводите / Корректируйте формулу логического контроля (F1)" D LINF I YES S i=ny,j=nx D E1Z
 G D
E142 S f="COL",do="D E1Z" D EE11,BLOK I  D W^%ZAPM.bs.BST
 G D
E143 D TXTLOG^%ZAPM.bs.BSF8 G D
E12 S f="FCL",do="D E1Z",ft=$P(BS,"@",7) D EE11 I li1'="" D Yes^%ZAPM.bs.BSXfun("Формулу ТРАНСЛИРОВАТЬ ?",2) I YES D CalcTran^%ZAPM.bs.BSF10(li)
 D BLOK I  D W^%ZAPM.bs.BST
 G D
E1zz S ny=i,nx=j,Oli=li,Oli1=li1 X "S Tmp="_TAR S li=$$TR^%ZAPM.bs.BSsFUNM(li,SOU,Tmp),li1=$$TR^%ZAPM.bs.BSsFUNM(li1,SOU,Tmp) D E1Z S li=Oli,li1=Oli1 Q
E1Z I li'="" S:li'?.N1",".N @(BSR_"(BST,f,i,j)")=li1,^(j,1)=li,$P(@(BSR_"(BST,i,j)"),"@",$S(f="FCL":7,f="FTR":8,f="COL":13,1:16))=$S(f="FCL":$G(ft,1),1:0) D:li?.N1",".N  G 23
 .K @(BSR_"(BST,f,i,j)") S $P(@(BSR_"(BST,i,j)"),"@",$S(f="FCL":7,f="FTR":8,f="COL":13,1:16))=li S:"FCLCOL"[f $P(@(BSR_"(BST)"),"@",$S(f="FCL":32,1:33))=1 D C11 Q
 E  K @(BSR_"(BST,f,i,j)") S $P(@(BSR_"(BST,i,j)"),"@",$S(f="FCL":7,f="FTR":8,f="COL":13,f="RTR":16,1:7))="" D C11
23 D 24^%ZAPM.bs.BSTM Q
C11 Q:f'="COL"  S $P(@(BSR_"(BST,i,j)"),"@",11)="" Q
E1F ;СИНТ & ЛОГ КОНТРОЛЬ ФОРМУЛ И ФУНКЦИИ ЛОГИКИ
 S YES=1 Q:li=""  Q:li&($P(li,","))&($P(li,",",2))&('$P(li,",",3))  G ^%ZAPM.bs.BSFTF ;!!!
E21 S f="FTR" D EE11,HIS(f) S YES=0,%hlp="^%ZAPM.bs.BSHLP(201",ls=" Вводите / Корректируйте функцию трансформации (F1)" D LINF I YES S i=ny,j=nx D E1Z
 G D
E22 S f="FTR",do="D E1Z" D EE11,BLOK I  D W^%ZAPM.bs.BST
 G D
E17 D POST^%ZAPM.bs.BSF9 G D
E161 S f="RTR" D EE11,HIS(f) S YES=0,%hlp="^%ZAPM.bs.BSHLP(204",ls=" Корректируйте функцию синтаксического контроля на ввод данных (F1)" D LINF I YES S i=ny,j=nx D E1Z
 G D
E162 S f="RTR",do="D E1Z" D EE11,BLOK I  D W^%ZAPM.bs.BST
 G D
E91 G E91^%ZAPM.bs.BSF2
E52 G EXPORT^%ZAPM.bs.BSBL1
E531 s YES=$$Dbf2Tab^%ZAPM.bs.BSXdbf1()
 i YES=0 d CopySons^%ZAPM.bs.BSXfun1(BSR,BST,$E(BST,2,$L(BST))) s YES=-4
 i YES=-4 g 100^%ZAPM.bs.BSF k @(BSR_"(BST)")
 G D
E532 D In^%ZAPM.bs.BSXdbf1($NA(@BSR@(BST)),0) G D
E533 D In^%ZAPM.bs.BSXdbf1($NA(@BSR@(BST)),1) G D
E54 G EXPORTXT^%ZAPM.bs.BSBL1
  G 10^%ZAPM.bs.BSF
E92 G E92^%ZAPM.bs.BSF2
E10 G E10^%ZAPM.bs.BSTK ;КЛЮЧИ
E131 G E131^%ZAPM.bs.BSF2
E132 G E132^%ZAPM.bs.BSF2
E133 G E133^%ZAPM.bs.BSS2
E134 G E134^%ZAPM.bs.BSS2
E1351 G E1351^%ZAPM.bs.BSS2
E1352 G E1352^%ZAPM.bs.BSS2
E1353 G E1353^%ZAPM.bs.BSS2
E1354 G E1354^%ZAPM.bs.BSS2
E136 K @(BSR_"(BST,""DBF"")") G D
E137 S do="S ls=$P(^(j),""@"",15),li=$$ClearSpc^%ZAPM.bs.BSF7(ls) I li'=ls S $P(^(j),""@"",15)=li" D BLOK G D
E138 G D:TIP'=8 K @BSR@(BST,"BUT") S TIP=1,$P(@BSR@(BST),"@",17)=1 G D
E311 D XBD^%ZAPM.bs.BSS1 G D
E312 D PRI^%ZAPM.bs.BSS1 G D
E321 D OUT^%ZAPM.bs.BSS1 G D
E322 D BLK^%ZAPM.bs.BSS1 G D
E323 D SSS^%ZAPM.bs.BSS1 G D
E34 D EDIT^%ZAPM.bs.BSIND G D
E121 D TAB^%ZAPM.bs.BSF3 G D
E122 D CMD^%ZAPM.bs.BSF3 G D
E123 D COPYCMD^%ZAPM.bs.BSF8 G D
E171 S sr=1 G E170 ;?
E172 S sr=2 G E170
E173 S sr=3
E170 G SHR^%ZAPM.bs.BSSR
]]></Routine>


<Routine name="%ZAPM.bs.BSF10" type="MAC" languagemode="0"><![CDATA[
%BSF10 ; РАБОТА С КЛЮЧАМИ И etc ; 14:57   13.01.2003
 Q
CHECKF(Fo) D Yes^%ZAPM.bs.BSXfun("Формат ДАННЫХ В ТАБЛИЦЕ проверять ?",2) Q:YES<1
 N i,j,A,K D Wait^%ZAPM.bs.BSXfun("ПРОВЕРКА ФОРМАТА ДАННЫХ В ТАБЛИЦЕ")
 S i="",K=0,A=","_$$GLRET^%ZAPM.bs.BSF12($NA(@BSR@(BST,"AFO")))
 F  S i=$O(@BSR@(BST,i)) Q:'i  F j=1:1 S j=$O(@BSR@(BST,i,j)) Q:'j  D
 .I Fo="3",$P(@BSR@(BST,i,j),"@",9)=2 D CHEC($G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j))) Q
 .I Fo["1",$P(@BSR@(BST,i,j),"@",7) D CHEC($P(@BSR@(BST,i,j),"@",15))
 .I Fo["2",(A[(","_j_",")),$G(@BSR@(BST,i)) D CHEC($P(@BSR@(BST,i,j),"@",15))
 I K D Yes^%ZAPM.bs.BSXfun("Найдено "_K_" нарушений формата ! Делаем АвтоРаздвижку колонок ?",2) I YES D AFOR Q
 Q
CHEC(d) X WA
 I $L(d)>($P(@BSR@(BST,i,j),"@",3)*$P(@BSR@(BST,i,j),"@",4)) S $P(@BSR@(BST,i,j),"@",12)=1,K=K+1
 Q
AFOR ;АВТОФОРМАТ
 N S,K,k,li,list,do,AFORM
 S k="",do="S S=$L($P(^(j),""@"",15)) S:S>$G(K(j),0) K(j)=S",$P(@BSR@(BST),"@",3)=1
 I Fo["3" S do="S S=$L($G(^%ZAPM.bs.BSbufB(""BB""_$G(%BS(3),$P)_$J_""u""_%BS(15),i,j))) S:S>$G(K(j),0) K(j)=S"
 D BLOK^%ZAPM.bs.BSF1 S AFORM=1
 F  S k=$O(K(k)) Q:'k  S li=K(k),list=li_">" D LSTR^%ZAPM.bs.BSF1
 D TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST
 Q
XEC(BD,EV) ;ВЫПОЛНЕНИЕ М-ПРОЦЕССОВ
 N i,ii
 S %zT=$ZT,$ZT="ERXEC^%ZAPM.bs.BSF10"
 I '$$Data^%ZAPM.bs.BSF12(BD) Q
 S i="",ii=$ZR F  S i=$O(@ii@(i)) Q:i=""  I $G(@ii@(i,"5,4"))=EV,$G(@ii@(i,"7,4"))'="" D XEC^%ZAPM.bs.BSTT(@ii@(i,"7,4"))
 Q
ERXEC ;I $ZE'["NO" D ErrMsg^%ZAPM.bs.BSXfun($$ErrSay^%ZAPM.bs.BSF8($ZE))
 W $$bel^%ZAPM.bs.BS3 S $ZT=$G(%zT) Q
DEL(G,T) ;УДАЛЕНИЕ СЕКРЕТНОЕ
 N ZR
 I $D(@G)=0 Q
 S A=$P($G(^%ZAPM.bs.BSETUP("SERVER",6,4)),"@",15)       I $P(A,"\",+T)="Y" D Copy^%ZAPM.bs.BSF8(254,G,1,"затираем перед удалением "_G)
 ;ПРОТОКОЛИРОВАНИЕ УДАЛЕНИЯ УЗЛОВ
 D Tex^%ZAPM.bs.BSMSMF("KillNode :"_G,$G(@G@("LST")))
 K @G D SNX^%ZAPM.bs.BSF("K",G,"DAT")
 Q
SPIS ;ВХОД В СПИСОК
 Q:TIP'=3  Q:$P(@$ZR,"@")["ПУСТО"
 ;```СТАРОЕ```I $D(ZPN),ZPN'="",$D(BSrz),$P($G(@BSrz@(BStz,"ZPR",ZPN)),"@",5) S nx=$P($G(@BSrz@(BStz,"ZPR",ZPN)),"@",5) S B=@BSR@(BST),IntSort=1 D CALC^%ZAPM.bs.BSF3,^%ZAPM.bs.BSS K IntSort
SPI D ^%ZAPM.bs.BST
 Q
CalcTran(FO) ;ТРАНСЛЯЦИЯ ФОРМУЛ
 N ls,li,li1
 S YES=1,ls="Какой контекст в формуле транслировать ?",li=FO D LE^%ZAPM.bs.BSTT Q:'YES  Q:li=""  I FO'[li D ErrMsg^%ZAPM.bs.BSXfun("ВАШ КОНТЕКСТ НЕ ВХОДИТ В ФОРМУЛУ !") S YES=0 Q
 S SOU=li,ls="Введите формулу трансляции (ny,nx- ТЕКУЩИЕ НОМЕРА КЛЕТОК)",li="" D LE^%ZAPM.bs.BSTT Q:'YES  Q:li=""  I '(li["ny"!(li["nx")) D ErrMsg^%ZAPM.bs.BSXfun("В ФОРМУЛУ НЕ ВХОДИТ ny nx ???!!!") S YES=0 Q
 S TAR=li X "S Tmp="_TAR S do="D E1zz" Q
LOG ;ЛОГИЧЕСКИЙ КОНТРОЛЬ
 I key=0 S ls=" ИМЕННОЙ КЛЮЧ КОНТРОЛИРОВАТЬ НЕЛЬЗЯ " G O
 I key'=endkey S ls=" ВЫ ХОТИТЕ КОНТРОЛИРОВАТЬ КЛЮЧИ НЕ ПОСЛЕДНЕГО УРОВНЯ !" G O
 I '$D(%DIA) S ls=" НЕ ПОМЕЧЕНЫ КОНТРОЛИРУЕМЫЕ КЛЮЧИ " G O
 K ^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1"),^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1")
 S do="D:i>3 LO^%ZAPM.bs.BSF10(i)" D BLOK^%ZAPM.bs.BSF1
 I '$D(^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1")) D OkMsg^%ZAPM.bs.BSXfun("ОШИБОК НЕ НАЙДЕНО") G ENDD
 S I="LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1",IYI="^%ZAPM.bs.BSbufB,"_I D NE^%ZAPM.bs.BSN K ^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1"),^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1")
ENDD K l,j,TRe1,TRe2,ii,%iii,NOKILLER,KILLER S R1=27 Q
SUU(%iii) S %NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 I key=0 S %NAm=BSD_%iii Q
 S %NAm=%NAm_$S(%iii=+%iii:%iii,1:$C(34)_%iii_$C(34))_","
 Q
LO(uzel) ;МОДУЛЬ КОНТРОЛЯ
 S uzel=$P(@BSR@(BST,uzel,1),"@",15)
 N (IMQ,uzel,%BS,vl,BSD,%KEYS,key)
 S BST=$P(IMQ,",",$L(IMQ,",")),BSR=$P(IMQ,",",1,$L(IMQ,",")-1)
 D TIP^%ZAPM.bs.BST,SUU(uzel)
 D BSDv^%ZAPM.bs.BST1 ;БУФЕР
 D COL^%ZAPM.bs.BSF3 I $G(lo) D FLAG^%ZAPM.bs.BSF(%NAm,lo,1)
 Q
O D O^%ZAPM.bs.BSF7
D K KILLER G 0^%ZAPM.bs.BSTM
STRUKT ;ПРЕДОБРАБОТКА ДЛЯ СТРУКТУРИРОВАННОГО КОДИФИКАТОРА
 I R1=27,R2=79,R3=89,$D(IMQ) D  ;F10
 .S (date,%BS("Tmp","EXIToutBD",IMQ))=$S(ny<3:"",1:d)
 .S R1=27,(R3,R2)=-1
 Q
IYI(IYI) N BSR,BST
 S BSR=$P(IYI,",",1,$L(IYI,",")-1),BST=$P(IYI,",",$L(IYI,",")) S:BSR'["^" BSR="^"_BSR
 Q $G(@BSR@(BST))
ChP(I) Q:$ZV["Cach"||($ZV["IRIS")
 N ChP S %zT=$ZT,$ZT="CP^%ZAPM.bs.BSF10" ;ПЕРЕОПРЕДЕЛЕНИЕ ТЕКУЩЕГО КАТАЛОГА
 I $D(%BS("Tmp","ChPath")) D  K %BS("Tmp","ChPath") Q
 .I $$ZOS1^%ZAPM.bs.BSDOS($P(%BS("Tmp","ChPath"),":"))
 .I $$ZOS8^%ZAPM.bs.BSDOS(%BS("Tmp","ChPath"))
 I $D(@$P(^%ZAPM.bs.BSS("USER","KEY"),"@")) S ChP=$NA(@$ZR@($S($G(%BS(12))="":"?",1:%BS(12)),2,$S(I=1:"IN",1:"OUT"))) S ChP=$O(@ChP@("")) D
 .I $$ZOS1^%ZAPM.bs.BSDOS($P(ChP,":"))
 .I $$ZOS8^%ZAPM.bs.BSDOS(ChP)
 Q
CP S $ZT=$G(%zT) Q
CutS(S) Q $$Cut($$Cut(S,0),1)
Cut(s,N) N i I $G(N) f i=1:1:$L(s) I $E(s,i)'=" "  S N=$L(s) Q
 I '$G(N) f i=$L(s):-1:0 I $E(s,i)'=" "  S N=i,i=1 Q
 Q $E(s,i,N)
TreeCopy ;ПРЕДОБРАБОТКА ДЛЯ УЗЛОВ БД
 N dd,N,NN
 I $E(%BS(1),17),R1=127 S R1=27,R2=79,R3=87 Q  ;DEL=F8
 I R1=0,R2=23 N EndINDi S EndINDi=1 D B1^%ZAPM.bs.BSBD S R1=-2 Q  ;ALT-I
 I R1=0,R2=98,R3=-1,ny>2 D  S R1=-2 Q  ;КОПИ В БУФЕР   SH-F5
 .K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),11)
 .D %NAm S TRe1=$NA(@(N_$S(d=+d:d,1:$C(34)_d_$C(34))_")")),TRe2=$NA(@("^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),11)")) D Copy^%ZAPM.bs.BSF8(TRe1,TRe2,1,1)
 .S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),12)=key_","_endkey,^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),12,1)=d
 .D OkMsg^%ZAPM.bs.BSXfun("Узел "_TRe1_" скопирован в Буфер") Q
 ;
 I R1=0,R2=99,R3=-1,ny>2 D  S R1=-2 Q  ;КОПИ ИЗ БУФЕРА    SH-F6
 .I '$D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),11)) D ErrMsg^%ZAPM.bs.BSXfun("Буфер Пуст") Q
 .I key'=($P(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),12),",")-1) D ErrMsg^%ZAPM.bs.BSXfun("Команду можно выполнить на "_($P(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),12),",")-1)_" Уровне") Q
 .D %NAm S dd=$G(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),12,1)) I dd="" D ErrMsg^%ZAPM.bs.BSXfun("Буфер Пуст") Q
 .S NN=$NA(@(N_$S(d=+d:d,1:$C(34)_d_$C(34))_","_$S(dd=+dd:dd,1:$C(34)_dd_$C(34))_")"))
 .I $D(@NN) D Yes^%ZAPM.bs.BSXfun("Узел ("_$P(NN,"(",2,99)_") Уже существует !!! Перезапишем ?",2) Q:'YES  K @NN
 .D Copy^%ZAPM.bs.BSF8($NA(@("^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),11)")),NN)
 .D OkMsg^%ZAPM.bs.BSXfun("Перезаписали...,"_d_")") Q
 Q
%NAm S N=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) I '$D(%KEYS) Q
 F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S N=N_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 Q
OB ;ОБОИ ТАБЛИЦЫ
 S l4=19,Xx=nx,Yy=ny,$P(@(BSR_"(BST,ny,nx)"),"@",19)=$P(@(BSR_"(BST)"),"@",46) D TAB2^%ZAPM.bs.BSF3 S l4=$P(@(BSR_"(BST,Yy,Xx)"),"@",19),$P(@$ZR,"@",19)="" D R^%ZAPM.bs.BSF4(46,l4) K l4,Xx,Yy Q
OBWRITE ;ЗАВСЕТКА ОБОЕВ
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSF10"
 N T,C,I S T=$P(B,"@",46),ObOi=$P($P(@T,"@",31),"/",5),C=$P(@T,"@",8,11) W $$atr^%ZAPM.bs.BS3(ObOi)
 F I=$P(C,"@",1):1:$P(C,"@",4) W /CUP(I,$P(C,"@",2)),$G(@T@(I-$P(C,"@",1)+1)),$J("",$P(C,"@",4)-$P(C,"@",2)+1-$L($G(@T@(I-$P(C,"@",1)+1))))
 Q
ERR W $$bel^%ZAPM.bs.BS3 S $ZT=$G(%zT) Q
PDM(U) ;МОДУЛЬ МЕНЮ 1 УРОВЕНЬ
 Q:R1>332
 G PD2:U=2
 I $G(%BS("Tmp","PallDown"))=2 D  S %BS(2)=%BS("Tmp","PallDown",2) K %BS("Tmp","PallDown") Q
 .S R1=13,(R2,R3)=-1
 I $G(%BS("Tmp","PallDown"))=1 D  S %BS("Tmp","PallDown")=2 ;Q
 .I $D(%BS("Tmp","PallDown",1)) S R1=27,R2=91,R3=%BS("Tmp","PallDown",1) Q
 I R1=27,R2=91,R3=66 S R1=13,(R2,R3)=-1 Q  ;DOWN
 I R1=27,R2=91,R3=68,nx=1 K %EN S R1=0,R2=79 Q
 I R1=27,R2=91,R3=67,nx=ke K %HO S R1=0,R2=71 Q
 Q
PD2 ;  2 УРОВЕНЬ
 I R1=27,R2=91,R3=67 D PD1(R3) S R1=27,(R2,R3)=-1 Q  ;--->
 I R1=27,R2=91,R3=68 D PD1(R3) S R1=27,(R2,R3)=-1 Q  ;<---
 Q
PD1(R) S %BS("Tmp","PallDown")=1,%BS("Tmp","PallDown",1)=R
 S %BS("Tmp","PallDown",2)=%BS(2),%BS(2)=0 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF11" type="MAC" languagemode="0"><![CDATA[
%BSF11 ; ДОПОЛНИТЕЛЬНЫЕ ПРОВЕРКИ ; 11:45   04.05.2001
 Q
COP2L(si,st) ;КОПИРОВАНИЕ СТРОКИ si В ЛОКАЛЬ
 S bsr="BUF"
 I $D(@BSR@(BST,si,1)) F kj=1:1 Q:'$D(@BSR@(BST,si,kj))  S @bsr@(BSt,st,kj)=@$ZR D
 .I 'fo F f="FCL","FTR","COL" S $P(@bsr@(BSt,st,kj),"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))=""
 .I fo D
 ..I "2345"'[$P(@BSR@(BST,si,kj),"@",7),$D(@BSR@(BST,"FCL",si,kj)) S @bsr@(BSt,"FCL",st,kj)=@$ZR
 ..I $D(@BSR@(BST,"FTR",si,kj)) S @bsr@(BSt,"FTR",st,kj)=@$ZR
 ..I '$P(B,"@",27) I $D(@BSR@(BST,"COL",si,kj)) S @bsr@(BSt,"COL",st,kj)=@$ZR D
 ...I $D(@BSR@(BST,"COL",si,kj,1)) S @bsr@(BSt,"COL",st,kj,1)=@$ZR
 Q
COPY(si) ;КОПИРОВАНИЕ СТРОКИ si ИЗ ЛОКАЛИ
 S St=St+1 X WA F kj=1:1 Q:'$D(@bsr@(BSt,si,kj))  S @(BSr_"(BSt,St,kj)")=@bsr@(BSt,si,kj) D
 .I 'fo F f="FCL","FTR","COL" S $P(@$ZR,"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))=""
 .I fo D
 ..F f="FCL","FTR" I $D(@bsr@(BSt,f,si,kj)) S @(BSr_"(BSt,f,St,kj)")=@bsr@(BSt,f,si,kj)
 ..I '$P(B,"@",27) I $D(@bsr@(BSt,"COL",si,kj)) S @BSr@(BSt,"COL",St,kj)=@bsr@(BSt,"COL",si,kj) D
 ...I $D(@bsr@(BSt,"COL",si,kj,1)) S @BSr@(BSt,"COL",St,kj,1)=@bsr@(BSt,"COL",si,kj,1)
 Q
LASTHIS(key,ny) N %HIS D HIS^%ZAPM.bs.BSF1($$NHIS()) Q $D(@%HIS@(1))
INSERT(key,ny) N %HIS D HIS^%ZAPM.bs.BSF1($$NHIS()) Q $G(@%HIS@(1))
NHIS() Q "TabelKey"_key_"String"_ny
PREDTEMP ;ПРЕДОБРАБОТКА ВЫБОРКИ ДЛЯ КЛЮЧЕЙ
 Q:R1>332
 I R1=13 D  Q  ;ЗАПИСЬ В ИСТОРИЮ
 .I d'["#",key'=0 Q:ny>4
 .D AddHist($$NHIS(),d)
 I R1=27,R2=91,R3=68!(R3=67) D  ;ЗАСВЕТКА СПИСКА ИСТОРИЙ
 .N %HIS,TTT D HIS^%ZAPM.bs.BSF1($$NHIS()) S TTT=$P($P(%HIS,"(",2),$C(34),2)
 .s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB",TTT) I Tmp=""!(YES<1) S R1=-2 Q
 .S d=Tmp,R1=0,R2=18 Q
 I ny>4,R1>31,R2=-1,R3=-1 S R1=-4,li=$P($G(@BSR@(BST,ny,2)),"@",15)_"#"_$P($G(@BSR@(BST,"COL",ny,3)),"I ",2,99)
 Q
AddHist(f,d) Q:d=""  N %HIS D HIS^%ZAPM.bs.BSF1(f) D AddHist^%ZAPM.bs.BSXuse(%HIS,d)
 Q
SETEMP ;ВРЕМЕННАЯ ВЫБОРКА
 S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,3)="I "_$P(d,"#",2,999)
 S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,4)="TXTC#"_$P(d,"#")
 Q
CREA(F) ;ФОРМУЛА НА БОКОВИНУ
 N FF
 I F["LongString" S F=$$GLRET^%ZAPM.bs.BSF12(F)
 I F["$$TSV" X "S FF="_F
 I F'["$$TSV" S FF="I "_F
 Q FF
TSVV(kod) Q "I "_kod
CREAT(M,Y,X,RA,EN) D Wait^%ZAPM.bs.BSXfun("КОПИРОВАНИЕ М\ЗАПРОСОВ В СВОДКУ")
 G creat:$E(SVo,1)=0
 N si,MM,fo,MMM,bsr,BUF
 S MM="",MMM=Y,fo=1 K SP(5) D COP2L(Y,1) S fo=0 D COP2L(RA,2)
 F  S MM=$O(@M@(1,MM)) Q:MM=""  D  S MMM=MMM+2
 .S Tmp=$$GLRET^%ZAPM.bs.BSF12($NA(@M@(1,MM))),fo=1 D COPY(1) S @BSr@(BSt,St)=1,n(MMM)=n,n=n+1 D  F C=2:1:COMP D COPY(1) S @BSr@(BSt,St)=C,$P(@BSr@(BSt,St,TSVV),"@",15)=""
 ..S $P(@BSr@(BSt,St,TSVV),"@",15)=$P(Tmp,"@")
 ..S SP(5,MMM)=$$CREA($P(Tmp,"@",2,9999))
 .I $O(@M@(1,MM))'="" S fo=0 D COPY(2)
 S si=EN,fo=0 D COP^%ZAPM.bs.BSSV
 Q
creat ;КОПИРОВАНИЕ М\ЗАПРОСОВ В СВОДКУ (СТАРЫЙ ВАРИАНТ)
 N si,MM,fo,MMM
 S MM="",MMM=Y K SP(5)
 F  S MM=$O(@M@(1,MM)) Q:MM=""  D  S MMM=MMM+2
 .S si=Y,fo=1 D COP^%ZAPM.bs.BSSV S @BSr@(BSt,St)=1,n(MMM)=n,n=n+1 D  F C=2:1:COMP D COP^%ZAPM.bs.BSSV S @BSr@(BSt,St)=C,$P(@BSr@(BSt,St,TSVV),"@",15)=""
 ..S $P(@BSr@(BSt,St,TSVV),"@",15)=$P(@M@(1,MM),"@")
 ..S SP(5,MMM)=$$CREA($P(@M@(1,MM),"@",2,999))
 .I $O(@M@(1,MM))'="" S si=RA,fo=0 D COP^%ZAPM.bs.BSSV
 S si=EN,fo=0 D COP^%ZAPM.bs.BSSV
 Q
CHO(MM,NO,x,zz) ;ВЫБОР
 N M,BSr,BSt,Fk,se,Obraz
 S YES=1,%zT=$ZT,$ZT="ERMA^%ZAPM.bs.BSF11"
 D TempT^%ZAPM.bs.BSTT
 F M=1:1 Q:$P(MM,"@",M)=""  D TempTX^%ZAPM.bs.BSTT($P(MM,"@",M)_" "_$P($G(@$P(MM,"@",M)),"@",2))
 D TempTXT^%ZAPM.bs.BSTT("<<< Выберите БОКОВИНУ для сводки >>>",$G(@%BS(20)@("ErrorTXT")))
 d ^%ZAPM.bs.BSX("TEXT",BSr,BSt) Q:YES<1
 S M=YES I YES D Yes^%ZAPM.bs.BSXfun("Будем УТОЧНЯТЬ БОКОВИНУ ?",2) S Tmp=YES,YES=1 I Tmp D TEMPZAPR($P(MM,"@",M))
 S $P(@x,"#",9)=$P(MM,"@",M),$P(@x,"#",10)=NO
 ;```???```I $D(NZP),$D(@BSR@(BST,"ZPR",NZP,0)) S $P(@$ZR,"#",9)=$P(MM,"@",M),$P(@$ZR,"#",10)=NO
 Q
TEMPZAPR(GL) ;РАЗОВЫЕ М-ЗАПРОСЫ
 N TG,TT,BSR,BST,BSr,BSt,IntTmp,i,j,s1,s2,s6i,l1,l2,col,ke,Fk,tIT,IYI,txt,kod,%INV1,%INV2
 N k1,k2,k3,k4,k5,k6,k7,k8,k9,%INV,Tmp,Shab
 S TT=$$TMPG^%ZAPM.bs.BSF11,BSR=$P(TT,"("),BST=$P($P($P(TT,"(",2),")"),$C(34),2),IntTmp=1
 S Shab="^%ZAPM.bs.BSS(""OPout"")" I $D(zz),$$Data^%ZAPM.bs.BSF12(zz) S Shab=zz
 S @BSR@(BST)=@Shab
 S s1="dinamo",Fk="",Tmp=0
 D Int I $D(@Shab@("AF2")) S @BSR@(BST,"AF2")=@Shab@("AF2")
AGAIN S IYI=BSR_"("_BST D NE^%ZAPM.bs.BSN I R1=27 S YES=0 Q
 S %INV="TempZap"_$G(%BS(3),$P)_$J_"u",%INV=$$BSR^%ZAPM.bs.BSA($NA(^%ZAPM.bs.BSbufB(%INV))) K @%INV S %INV2=1,%INV1=2,s6=0,@%INV="%BS-dimamo-@Temporary"
 S do="D TEMPZ^%ZAPM.bs.BSF11(j)" D BLOK^%ZAPM.bs.BSF1 I YES<1!('s6) G AGAIN
 S YES=1,MM=%INV,M=1
 Q
TEMPZ(j) ;СОЗДАНИЕ TEMP.М\ЗАПРОСОВ
 Q:Tmp=i
 D DINA^%ZAPM.bs.BSS I YES<1 S i=999999 Q
 S Tmp=i Q
ERMA D ErrMsg^%ZAPM.bs.BSXfun($$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT),YES=0 Q
TS ;ПОИСК ДИНАМИЧЕСКОЙ БОКОВИНЫ
 N F S ls=1
 S F=$G(@BSR@(BST,"FCL",id,jd)) X "I "_F
 Q
TSVD(M,N,T,Z) I '$D(@BSR@(BST,N)) S ls="В ФУНКЦИИ $TSVD НЕТ СТРОКИ С НОМЕРОМ "_N Q 0
 I '$D(@BSR@(BST,T)) S ls="В ФУНКЦИИ $TSVD НЕТ СТРОКИ С НОМЕРОМ "_T Q 0
 S @BSR@(BST,"TSV",1,3)=$G(M),@BSR@(BST,"TSV",1,3,1)=+$G(N)_","_+$G(T)_","_id_","_jd
 I $D(Z) S @BSR@(BST,"TSV",1,3,2)=Z
 Q 1
INVTAB S s1="invert" G DINS ;ОБРАТНАЯ ОПЕРАЦИЯ
DINTAB S s1="dinamo"
DINS I BST'["@" D ErrMsg^%ZAPM.bs.BSXfun("ОПЕРАЦИЯ ВОЗМОЖНА В РЕЖИМЕ РЕДАКТИРОВАНИЯ ТАБЛИЦЫ <F4>") G D
 D Yes^%ZAPM.bs.BSXfun("ТЕКУЩАЯ ТАБЛИЦА СИЛЬНО ИЗМЕНИТСЯ ! ВЫ ГОТОВЫ К ЭТОМУ ?",2) I YES<1 G D
 S li="^" D GLO^%ZAPM.bs.BSF3 I $G(GL)="" G D
 I $P($G(@GL),"@")'[("%BS-"_s1_"-") D ErrMsg^%ZAPM.bs.BSXfun("НУ, ЭТО СОВСЕМ НЕ ТО !") G D
Int S s2=@BSR@(BST) K @BSR@(BST) S @BSR@(BST)=s2,$P(@$ZR,"@",29)=2,ke=2,s2=0
 S i="",BSr=BSR,BSt=BST
 I s1["mo" F  S i=$O(@GL@(1,i)) Q:i=""  D DINSM($P($G(^(i)),"@"))
 I s1'["mo" F  S i=$O(@GL@(1,i)) Q:i=""  D DINSM(i)
 S s2=s2+1 I s2>50 S s2=50
 S l1=s2,l2=75-l1,(col(1),col(2))=$P(%BS,"!",4) D DINSE(" КОДЫ"," "_$S(s1'["mo":"ТЕКСТЫ",1:"ФОРМУЛЫ (для включения в М\Запрсы их надо ПОМЕТИТЬ)"))
 S col(1)=$P(%BS,"!",5),col(2)=$P(%BS,"!",6),a=""
 I s1["mo" F  S a=$O(@GL@(1,a)) Q:a=""  D DINSE($P(@GL@(1,a),"@"),$P(@GL@(1,a),"@",2,999))
 I s1'["mo" F  S a=$O(@GL@(1,a)) Q:a=""  D DINSE(a,@GL@(1,a))
 D CREAT^%ZAPM.bs.BSN S $P(@BSr@(BSt),"@")=$P($G(@GL,"@???"),"@",2)
 Q:$D(IntTmp)
 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
DINSM(t1) I $L(t1)>s2 S s2=$L(t1)
 Q
DINSE(t1,t2) D CR^%ZAPM.bs.BSN Q
ERCMD ;ОШИБКИ В ФОРМУЛАХ СПИСКОВ И СВОДОК
 D TempT^%ZAPM.bs.BSTT
 D TempTX^%ZAPM.bs.BSTT($$ErrSay^%ZAPM.bs.BSF8($ZE)),TempTX^%ZAPM.bs.BSTT("")
 D TempTX^%ZAPM.bs.BSTT("    ВОЗМОЖНО ОШИБКА В ФОРМУЛАХ:"),TempTX^%ZAPM.bs.BSTT("")
 I $D(iii),$D(SP(2,iii)) D TempTX^%ZAPM.bs.BSTT("номер="_iii_" Логики на Шапку"),TempTX^%ZAPM.bs.BSTT(SP(2,iii))
 I $D(iii),$D(SP(4,iii)) D TempTX^%ZAPM.bs.BSTT("номер="_iii),TempTX^%ZAPM.bs.BSTT(SP(4,iii))
 I $G(iS),$D(SP(5,iS)) D TempTX^%ZAPM.bs.BSTT("номер="_iS_" Логики на Боковину"),TempTX^%ZAPM.bs.BSTT(SP(5,iS))
 I $D(i),$D(C),$D(CH(C,i,3)) D TempTX^%ZAPM.bs.BSTT(" Логика Выборки="_CH(C,i,3))
 D TempTXT^%ZAPM.bs.BSTT("ОШИБКА !!!",$G(@%BS(20)@("ErrorTXT")))
 D TempTXTE^%ZAPM.bs.BSTT
 Q
D G 0^%ZAPM.bs.BSTM
DIN ;МИКРОЗАПРОСЫ ИЗ СВОДКИ В МАССИВ
 S do="I j=%INV1 D DINASE^%ZAPM.bs.BSS($P(^(j),""@"",15),$G(@BSR@(BST,""FCL"",i,j)))"
 D SETKD^%ZAPM.bs.BSS S s6=0
 D BLOK^%ZAPM.bs.BSF1 G ENDIN^%ZAPM.bs.BSS
S(C) Q:C'["]" 0 N U,S
 S U=$P(C,$C(34),2),S=$P(C,$C(34),4) I $$ZU^%ZAPM.bs.BS3(U,S) Q 0
 Q 1
F(S) I $$S(S)=0 Q "НОВЫЙ ФОНОВЫЙ НАСЧЕТ"
 Q "НОВЫЙ ЛОКАЛЬНЫЙ ФОНОВЫЙ НАСЧЕТ"
H(S) I $$S(S)=0 Q "НОВЫЙ НАСЧЕТ"
 Q "НОВЫЙ ЛОКАЛЬНЫЙ НАСЧЕТ"
R(C) ;УДАЛЕННЫЕ НАСЧЕТЫ
 N %TAB,%TAA
 D UU(C) I '$D(UU) Q
 S %TAB=%OLDII I UU=$$BSR^%ZAPM.bs.BSA("^%ZAPM.bs.BSbufS") Q
 F  S %TAB=$O(@(UU_"(%TAB)")) Q:%TAB=""  Q:%TAB'[%OLDII  I %TAB'["@"&(%TAB'["&") S i=i+1 D
 .S @TS@(i,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$P(%TAB,"!",3)_$J("",13-$L($P(%TAB,"!",3)))_$S($P(@(UU_"(%TAB)"),"@",30)="":".....",1:$E($P(@$ZR,"@",30),1,5))_";REMOTE;1;"_$P(@$ZR,"@")
 ;```S (%TAB,%TAA)=%OLDII
 ;```F  S %TAB=$O(@(UU_"(%TAB)")) Q:%TAB=""  Q:%TAB'[%TAA  I %TAB'["@"&(%TAB'["&") S i=i+1 D
 ;```.S @TS@(i,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$P(%TAB,"!",3)_$J("",13-$L($P(%TAB,"!",3)))_$S($P(@(UU_"(%TAB)"),"@",30)="":".....",1:$E($P(@$ZR,"@",30),1,5))_";REMOTE;1;"_$P(@$ZR,"@")
 Q
UU(C) N U ;ОПРЕДЕЛЕНИЕ ССЫЛКИ СЕТЕВОГО РАЗДЕЛА
 S U="^["""_$P(C,$C(34),2)_""","""_$P(C,$C(34),4)_"""]BSdirddp",U=$P($G(@U),"@",2) I U="" G UUu
 S UU="^["""_$P(U,",")_""","""_$P(U,",",2)_"""]%BSbufS" I $$Data^%ZAPM.bs.BSF12(UU) Q
UUu S UU="^[""MGR"","""_$P($G(^%ZAPM.bs.BSETUP("SERVER",14,4)),"@",15)_"""]%BSbufS" I $$Data^%ZAPM.bs.BSF12(UU) Q
 S UU=$$BSR^%ZAPM.bs.BSA("^%ZAPM.bs.BSbufS") Q
DEL S %TAB=$P(d," ",2) S %OLDII1=$S(%OLDII'["^%":$E(%OLDII,4,6)_":"_$E(%OLDII,10,12)_":"_$P($P(%OLDII,"]",2),"!",1,9),1:%OLDII)
 I $D(%DIA) S do="S d=$P(^(j),""@"",15) K Temp D DE^%ZAPM.bs.BSF11(d) I $D(Temp) S %TAB=%OLDII1_$P($P($P(^(j),""@"",15),"" "",2),""."",2) D DEL^%ZAPM.bs.BS(Temp,$S($ZV[""Cach"":%OLDII_$P(%TAB,""."",2),1:%OLDII1_$P(%TAB,""."",2)))" D BLOK^%ZAPM.bs.BSF1 Q
 Q:ny<4  K Temp D DE(d) I $D(Temp) D DEL^%ZAPM.bs.BS(Temp,$S($ZV["Cach"||($ZV["IRIS"):%OLDII_$P(%TAB,".",2),1:%OLDII1_$P(%TAB,".",2)))
 Q
DE(d) I d[";REMOTE;" S Temp=UU Q
 I d[";LOCKAL;" S Temp=%nAM
 Q
OUTGLO(GLO,FN) ;КОПИРОВАНИЕ НОВОЙ ВЕРСИИ В СЕТЕВУЮ ГЛОБАЛЬ
 I GLO'["^" Q
 N DOS,I,II
 S %zT=$ZT,$ZT="OG^%ZAPM.bs.BSF11",YES=0,II=1
 F DOS=51:1:54 O DOS::0 Q:$T
 I $$Open^%ZAPM.bs.BSXdos(FN,"R")<0 Q
 D L^%ZAPM.bs.BS3(GLO)
 U 0 d Wait^%ZAPM.bs.BSXfun("Копирование в "_GLO) K @GLO@("LAST") S @GLO@("LAST")=0
 F  U DOS Q:$ZC'=0  R I S @GLO@("LAST",II)=I,II=II+1 I '(II#50) U 0 X $G(WA)
 S @GLO@("LAST")=^%ZAPM.bs.BS
 S YES=1 D U^%ZAPM.bs.BS3(GLO) C DOS
 Q
OG I $ZE["<ENDOFFILE" G OGO
 D ErrMsg^%ZAPM.bs.BSXfun($$ErrSay^%ZAPM.bs.BSF8($ZE))
OGO S $ZT=$G(%zT),YES=0 D U^%ZAPM.bs.BS3(GLO) C DOS
 Q
SCAN(%FN) ;СКАНИРОВАНИЕ
 C %FN K fT2
 N I,WRITE,DOS,FN,DOSO,FNO,FIRST,M,CU,v,ST,STOPSCAN,DOSIN,DOSOUT,say
 I $D(^%ZAPM.bs.BSDDR("DDRPARM")) F CU=2:2:16 S CU(CU)=$P(^%ZAPM.bs.BSDDR("DDRPARM",CU,4),"@",15)
 I %IN["%BS-SCANINIG" G SCA
 ;S FN=$$BaseDir^%ZAPM.bs.BSDOS_$$DIR^%ZAPM.bs.BSMSMF_$$TEMPFILE,FNO=%FN
 ;C %DEV 
 I $ZV["Cach"||($ZV["IRIS") D  G SCA1
 .S say="без перекодировки" S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1(%IN) D  S say="с перекодировкой" 
 ..N (S1,S2) D INIT^%ZAPM.bs.BSre(1)
 ;F %DEV=$G(%Dev,51):1:54 O %DEV::0 Q:$T
 ;S DOS=%DEV
 ;F %DEV=$G(DOS,51)+1:1:54 O %DEV::0 Q:$T
SCA1 ;I $$Open^%ZAPM.bs.BSXdos(FNO,"R")<0 G STOPSCAN
 ;S DOSO=DOS,DOS=%DEV I $$Open^%ZAPM.bs.BSXdos(FN,"W")<0 G STOPSCAN
 ;S DOSIN=DOSO,DOSOUT=DOS X $G(CU(16)) I $G(STOPSCAN) G STOPSCAN
 k fT2 d fT1(.fT1,.fT2) k fT1 m fT1=fT2 k fT2
 d Wait^%ZAPM.bs.BSXfun("освобождения от мусора и разрезка "_%FN)
 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSF11"
 ;U DOS W "%BS-SCANINIG ",$G(say),!
 D fT2("%BS-SCANINIG "_$G(say))
 ;S ST="" F v=1:1 U DOSO  R I D  D:I'="" CUT(I) //I '(v#10) U 0 X $G(WA) /////Q:$ZC'=0
 S ST="",i="" F v=1:1 S i=$O(fT1(i)) Q:i=""  S I=fT1(i) D  D:I'="" CUT(I)
 .S I=$TR(I,CU(2),CU(4))
 .I $P(CU(14),"/",3)="Y" S I=$$Cut^%ZAPM.bs.BSF10(I)
 .I $P(CU(14),"/",2)="Y" S I=$$Cut^%ZAPM.bs.BSF10(I,1)
 .I I[CU(6),I'[CU(8) S I=$$TR^%ZAPM.bs.BSsFUNM(I,CU(6),CU(8))
 .I I[CU(10),I'[CU(12) S I=$$TR^%ZAPM.bs.BSsFUNM(I,CU(10),CU(12))
 .I $P(CU(14),"/",1)="Y" F M=1:1 Q:$E(I,M)=""  I $A($E(I,M))<32 S I=$E(I,1,M-1)_$E(I,M+1,$L(I))
 .I '$D(FIRST),I'[CU(12) S I=""
 .I '$D(FIRST),I[CU(12) S FIRST=1
STOPSCAN ;I $P(CU(14),"/",4)'="Y" S %FN=FN C DOSO,DOS G SCA
 ;C DOSO,DOS W /CUP(22,1) D EXE^%ZAPM.bs.BSDOS("COPY "_FN_" "_FNO,1) 
 ;W /CUP(22,1) D EXE^%ZAPM.bs.BSDOS("DEL "_FN,1)
SCA ;I $ZV["Cach"||($ZV["IRIS") C FN,FNO S %DEV=%FN G SCA2
 ;C %DEV F %DEV=$G(%Dev,51):1:54 O %DEV::0 Q:$T
 ;S DOS=%DEV
SCA2 ;I $$Open^%ZAPM.bs.BSXdos(%FN,"R")
 ;U %DEV R %IN
 S fT2=$O(fT2("")),%IN=$G(fT2(fT2)) 
 Q
fT2(S) S fT2=$G(fT2)+1,fT2(fT2)=S //ЗАПИСЬ В НОВЫЙ МАССИВ
 Q
fT1(fT2,fT1) n i s i="" F  S i=$O(fT2(i)) Q:i=""  I $G(fT2(i))'="" D  S fT1(i)=fT2(i) I $G(fT1)="" S fT1=i
 .I $E(fT2(i),$L(fT2(i)))="="!(fT2(i)["+++") Q  //выравнивание по =
 .N A,ii,AA S AA=fT2(i),A=$P(fT2(i),"=",$L(fT2(i),"=")),fT2(i)=$P(fT2(i),"=",1,$L(fT2(i),"=")-1)_"="
 .S ii=$O(fT2(i)) I ii="" S fT2(i)=AA Q
 .S fT2(ii)=A_$G(fT2(ii))
 q
ERFILE S $ZT=$G(%zT) I $ZE["<ENDOFFILE" G STOPSCAN
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE))
 Q
CUT(I) ;РАЗРЕЗКА
 I $L(ST_I)>4000 D CU(ST)
 S ST=ST_I I ST["=++" D CU(ST) D fT2($TR(ST,S1,S2)) S ST="" //U DOS W $TR(ST,S1,S2),! S ST=""
 Q
CU(S) N SS
 S SS=""
 F M=1:1 Q:$P(S,"=",M,M+1)=""  S SS=SS_$P(S,"=",M)_"=" I $L(SS)>74 D fT2($TR(SS,S1,S2)) S SS="" //U DOS W $TR(SS,S1,S2),! S SS=""
 S ST=SS
 Q
UNMARK(U) N I,J ;СНЯТЬ ПОМЕТКУ С ТАБЛИЦЫ
 F I=1:1 Q:$G(@U@(I,1))=""  F J=1:1 Q:$G(@U@(I,J))=""  S $P(@U@(I,J),"@",12)=""
 S $P(@U,"@",3)="" Q
TEMPFILE() ;ВРЕМЕННЫЙ ФАЙЛ
 Q "%BSTEMP.TMP"
RANDFILE() ;СЛУЧАЙНОЕ ИМЯ ФАЙЛА
 Q $R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_$R(10)_".TMP"
TMPG() ;СЛУЧАЙНАЯ ССЫЛКА ВРЕМЕННОГО МАССИВА
TMR N T S T=$NA(@"^%ZAPM.bs.BSbufB"@("TMP"_$TR($$RANDFILE(),".","")_$G(%BS(3),$P)_$J_"u1")) I $D(@T) G TMR
 Q T
MARK(U,M) N I,J,P ;ПОМЕТИТЬ ТАБЛИЦУ ПО ДАННЫМ В КЛЕТКАХ -->M
 S P=0 F I=1:1 Q:$G(@U@(I,1))=""  F J=1:1 Q:$G(@U@(I,J))=""  I $P(@U@(I,J),"@",15)'="",$D(@M@($P(@U@(I,J),"@",15))) S $P(@U@(I,J),"@",12)=1,P=P+1
 I 'P S $P(@U,"@",3)="" K %DIA Q
 S %DIA=1,$P(@U,"@",3)=P Q
STAT ;СТАТИСТИКА -=АС НЕФЕДОВ=-
 N (%BS) D SA^%ZAPM.bs.BSsBUF,^%ZAPM.bs.BSTAT,RE^%ZAPM.bs.BSsBUF
 Q
MENU ;ОБНОВЛЕНИЕ ВРЕМЕНИ В МЕНЮ
 Q:R1>332  I '$D(%BS(2,1)),$ZV'["Cach"&&($ZV'["IRIS") S %BS(2,1)=%BS(2),%BS(2)="1-D MENU^%ZAPM.bs.BST" Q
 I R1=13,R2=-1,R3=-1 D UNDOMENU Q
 I R1=27,R2=-1,R3=-1 D UNDOMENU
 Q
UNDOMENU I $D(%BS(2,1)) S %BS(2)=%BS(2,1) K %BS(2,1) Q
 D CLr^%ZAPM.bs.BSF4 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF12" type="MAC" languagemode="0"><![CDATA[
%BSF12 ;Функции общего назначения; 16:28  5-DEC-97 ; 16:41   28.12.2001
 Q
KillTab ;ПРОТОКОЛИРОВАНИЕ УДАЛЕНИЯ ТАБЛИЦ
 N G Q:%NAM["%BSbuf"  S G=$NA(@%NAM@(%TAB)) Q:"15"[$P($G(@G),"@",17)
 D Tex^%ZAPM.bs.BSMSMF("In "_$$ZU^%ZAPM.bs.BS3(0)_" KillTab :"_G)
 Q
TITUL I $G(%TIT) G TT0^%ZAPM.bs.BSF2
 D Yes^%ZAPM.bs.BSXfun("Устанавливаем Титул на таблицу ?") I YES<1 G D^%ZAPM.bs.BS
 G TT1^%ZAPM.bs.BSF2
PEREXOD(%NAM) I %NAM["^[" N I1,I2,I3 S I1=$P($P(%NAM,"[",2),"]",1),I2=$P(I1,$C(34),2),I3=$P(I1,$C(34),4) I $$ZU^%ZAPM.bs.BSF4(I2,I3)
 Q
PARTIT(%NAM) ;ВХОД В РАЗДЕЛ
 N ucI S ucI=$$ZU^%ZAPM.bs.BS3(0)
 D PEREXOD(%NAM) D
 .N Pddp,IntBS,ucI S IntBS=1 D TAB^%ZAPM.bs.BS
 I $$ZU^%ZAPM.bs.BSF4($P(ucI,","),$P(ucI,",",2)) 
 Q
SHIFTF5 S $P(@BSR@(BST,1,4),"@",15)=$TR(KKK,".]:[^""","___")
LISTBUF ;СПИСОК ГЛОБАЛЬНЫХ БУФЕРОВ
 S I="",II=4 F  S I=$O(BUFG(I)) Q:I=""  I BUFG(I)'="",$$Data(BUFG(I)) D
 .S $P(@BSR@(BST,II,4),"@",15)=BUFG(I),$P(@BSR@(BST,II,2),"@",15)=$P($G(@BUFG(I),"@Без Комментария"),"@",2)
 .S II=II+2
 Q
SELBUF(R) ;ВЫБОР ГЛОБАЛЬНОГО БУФЕРА
 N (R,KKK,Refresh,%BS) I $ZV["Cach"||($ZV["IRIS") S Refresh=1
 F I=1:1 S BUFG(I)=$$BUFG(I) I $G(BUFG(I))="" K BUFG(I) Q
 I '$D(BUFG) D ErrMsg^%ZAPM.bs.BSXfun("РАЗДЕЛЫ НЕОПРЕДЕЛЕНЫ ИЛИ НЕДОСТУПНЫ") Q ""
 S I=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSVOL("_R_")","4#1#12",2,"~",R_"^%ZAPM.bs.BSF12") I $P(%BS("Tmp","LastTabl"),"@",4)=27 Q ""
 S BUFG=$P(%BS("Tmp","LastTabl"),"@",9) I '$$Data(BUFG) W $$bel^%ZAPM.bs.BS3 Q ""
 S KKK=$P(I,"~",1)
 Q BUFG
BUFENTER N BUFG S BUFG=$$SELBUF("LISTBUF")
 I '$$Data(BUFG) W $$bel^%ZAPM.bs.BS3 Q
 N Pddp,%NAM,IntBS S %NAM=BUFG,IntBS=1 D TAB^%ZAPM.bs.BS
 Q
BUFG(P) Q $P($P($G(^%ZAPM.bs.BSETUP("SERVER",8,4)),"@",15)," ",$G(P,1)) ;БУФЕРА
Buf ;КОПИРОВАТЬ В БУФЕР ПОТОК ТАБЛИЦ
 N i,j,KK,KKK,BUFG,R1,IntPoint
 D
 .N BSR,BST,KK,KKK,IntPoint
 .S BSR="Tmp",BST="Tmp",IntPoint=1 D BUFAGA
 I $D(%DIA) S do="I i>2 S %TAB=$P($P($P(^(j),""@"",15),""~"",2),"" "") D COPY^%ZAPM.bs.BSF12(%NAM,%TAB,BUFG)" D BLOK^%ZAPM.bs.BSF1
 I '$D(%DIA) D COPY^%ZAPM.bs.BSF12(%NAM,%TAB,BUFG)
 D OkMsg^%ZAPM.bs.BSXfun("Копия закончена")
 Q
COPY(BSR,BST,BUF) ;КОПИРОВАНИЕ
 D Copy^%ZAPM.bs.BSF8($NA(@BSR@(BST)),$NA(@BUFG@(BST)),"",1)
 S @BUFG@(BST,"LST")=$H_","_$G(%BS(12))_",BuffCopy"
 Q
BUFCOPY N KK,KKK,BUFG
 I $E(BST,1)="@" D ErrMsg^%ZAPM.bs.BSXfun("СНАЧАЛО НЕ ПЛОХО БЫ ВЫЙТИ ИЗ РЕЖИМА РЕДАКТИРОВАНИЯ") Q
 I BSR["%BSbufB" Q:$P($G(@BSR@(BST)),"@",17)'=5
BUFAGA S KKK=BST,BUFG=$$SELBUF("SHIFTF5") I BUFG="" Q
BUFAGAIN G:KKK="" BUFAGA I $D(@BUFG@(KKK)) S KK=$ZR D Yes^%ZAPM.bs.BSXfun("ТАБЛИЦА "_KK_" УЖЕ СУЩЕСТВУЕТ ЗАМЕЩАЕМ ?",2) D  Q:YES<1  G BUFAGAIN
 .I YES<1 S KKK=$$LineEdit^%ZAPM.bs.BSXfun(KKK,"ВВЕДИТЕ НОВОЕ ИМЯ, ПОД КОТОРЫМ ЗАПИШЕМ В БУФЕР") Q
 .K @KK S YES=1
BUFCO Q:$D(IntPoint)
 D Copy^%ZAPM.bs.BSF8($NA(@BSR@(BST)),$NA(@BUFG@(KKK)),"",1),OkMsg^%ZAPM.bs.BSXfun("Копия закончена")
 S R1=-99 Q
T S TmpTime=+$P($$h^%ZAPM.bs.BS3(),",",2) Q  ;НАЧАЛО
Ti D OkMsg^%ZAPM.bs.BSXfun("Работало "_($P($$h^%ZAPM.bs.BS3(),",",2)-TmpTime)_" сек.")
 Q
LNG() ;ДЛИНА ГЛОБАЛА/ОГРАНИЧЕНИЕ СТРОКИ В РЕДАКТОРЕ
 I $G(%maxLen) Q %maxLen
 I $ZV["Cach"||($ZV["IRIS") Q 32767
 I $P($P($ZV," ",3),".",2)>0 Q 7000
 E  Q 511
GLSET(G,S) ;ПРИСВОИТЬ ДЛИННУЮ СТРОКУ В ГЛОБАЛЬ
 N I,LNG
 S LNG=$$LNG() S @G=$E(S,1,LNG) F I=1:1:17 K @G@("&"_I)
 Q:$E(S,LNG+1)=""  S @G@("&1")=$E(S,LNG+1,LNG+LNG) ;K @G@("&2")
 Q:$E(S,LNG*2+1)=""  S @G@("&2")=$E(S,LNG*2+1,LNG*3) ;K @G@("&3")
 F I=3:1 Q:$E(S,LNG*I+1)=""  S @G@("&"_I)=$E(S,LNG*I+1,LNG*(I+1)) ;K @G@("&"_(I+1))
 Q
GLRET(G) N Tmp ;ВЕРНУТЬ ДЛИННУЮ СТРОКУ
 S Tmp=$G(@G) Q:'$D(@G@("&1")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&2")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&3")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&4")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&5")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&6")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&7")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&8")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&9")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&10")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&11")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&12")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&13")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&14")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&15")) Tmp S Tmp=Tmp_@$ZR
 Q:'$D(@G@("&16")) Tmp S Tmp=Tmp_@$ZR Q:'$D(@G@("&17")) Tmp S Tmp=Tmp_@$ZR
 Q Tmp
%BSPIC I $D(^%ZAPM.bs.BSR(1,0))
 F I=1:1:23 W $TR(^(I),">",""),!
 Q
REC I %BS(13)'="%BS-PC" W /CUP(22,1),$ZV,"  ",$$WEEKEND^%ZAPM.bs.BSsFUNR(1,$$h^%ZAPM.bs.BS3()),"  ",$$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3()),"  %BS Version ",^%ZAPM.bs.BS Q
 N I W $$clear^%ZAPM.bs.BS3,/ED(2),$$atr^%ZAPM.bs.BS3("1;6;33;46") D %BSPIC
 W /CUP(16,4),$ZV D LICEN(17,4),SAY^%ZAPM.bs.BS3(16,38) W $$atr^%ZAPM.bs.BS3(0)
 Q
LICEN(y,x) I $P($ZV,"Version ",2)'<4 D
 .N B,LN,S,X,LC S X=$$LICINFO^%MSMOPS,(B,LN,S)="" S:$ZB(+$P(X,"^",2),32,1) EXP=1
 .W /CUP(y,x),"Serial #..: ",+X
 .W /CUP(y+1,x)
 .I $P(X,"^",3)>1 W "Users.....: ",$P(X,"^",3)
 .E  W "Single User" W:$P(X,"^",3) " Multi-job"
 .W:$P(X,"^",2)#2 ",Runtime"
 .W:$P(X,"^",2)\2#2 ",Demo"
 .I $P(X,"^",5)<($$h^%ZAPM.bs.BS3()+365) W " (Expires ",$ZHL(1,"Month d, yyyy",$P(X,"^",5)),")"
 .W /CUP(y+2,x),"Supplier..: ",$P(X,"^",10)
 .W /CUP(y+3,x),"End-User..: ",$P(X,"^",11)
 .I $P(X,"^",2)>3 W /CUP(y+4,x),"Options...: " S X=+$P(X,"^",2) DO
 ..I $ZB(X,4,1) W "NET"
 ..I $ZB(X,8,1) W ", LAT"
 ..I $ZB(X,16,1) W:$ZB(X,4+8+16,1)>16 ", " W "SECURITY"
 ..I $ZB(X,32,1) W:$ZB(X,4+8+16+32,1)>32 ", " W "EXP"
 ..I $ZB(X,64,1) W:$ZB(X,4+8+16+32+64,1)>64 ", " W "GUI"
 .W /CUP(y+5,x),"NameSystem: ",$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 Q
CHANGE(X) ;СМЕНА ПАРОЛЯ ИЛИ КОМЕНТАРИЯ
 N BSD,d
 S BSD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""USER"")"),d=%BS(12) I d="" Q
 I X=1 G CHCM
CHPW Q:d[" "  N PO,PN,US
 S PO=$G(@BSD@(".@PASSWORD",d)),US=d
 S PN=$$LineEdit^%ZAPM.bs.BSXfun(PO,"Вводите новый пароль для пользователя "_US) I YES<0 Q
 I PN=PO D ErrMsg^%ZAPM.bs.BSXfun(" Не сменили... ") Q
 S @BSD@(".@PASSWORD",US)=PN G CHok
 Q
CHCM Q:d[" "  N PO,PN,US
 S PO=$G(@BSD@(".@WHO",d)),US=d
 S PN=$$LineEdit^%ZAPM.bs.BSXfun(PO,"Вводите новый коментарий для пользователя "_US) I YES<0 Q
 I PN=PO D ErrMsg^%ZAPM.bs.BSXfun(" Не сменили... ") Q
 S @BSD@(".@WHO",US)=PN
CHok D OkMsg^%ZAPM.bs.BSXfun("  сменили... ")
 Q
SETCOL(T,N) S $P(^%ZAPM.bs.BSHLP(T),"@",31)=$P(^%ZAPM.bs.BSHLP(N),"@",31) Q
AF10 ;ПРЕДОБРАБОТКА ДЛЯ БС-ИНТЕРФЕЙСА
 ;I R1=90 D SETCOL($E($P(d," ",2),2,99),0) Q  Z  ...ТАК НАДО БЫЛО....
 ;I R1=67 D SETCOL($E($P(d," ",2),2,99),1) Q  C
 I MRMR'["EXCEL" S MRMR=$TR(MRMR,"><","")_","" B-EXCEL """
 I R1=43!(R1=45) Q
 I $E(%BS(1),17),R1=127 S R1=27,R2=79,R3=87 Q  //ЗАМЕНА BACKSPACE НА ESC
 I R1=66!(R1=98),R2=-1 G EXCEL^%ZAPM.bs.BSCAsIs2
 I R1<332,$E(%BS(1),3)=2,'$E($G(%BS(14)),4),R1>31,R1'=127 D CM^%ZAPM.bs.BSF6 S (R1,R2,R3)=0
 Q
TR ;ТРАНСЛЯЦИЯ ПСЕВДОГРАФИКИ НА ПЕЧАТЬ
 S tr(1)=$P($G(^%ZAPM.bs.BSETUP("PARPRN",8,2)),"@",15),tr(1)=$S(tr(1)="":"||||||--|+||==||=-==-=--==-====-=---==-",1:tr(1))
 S tr(2)=$P($G(^%ZAPM.bs.BSETUP("PARPRN",9,2)),"@",15),tr(2)=$S(tr(2)="":"||||||--|+||==##=--=-=--==-====-=---==-",1:tr(2))
 Q
GETDDP(G) S %zT=$ZT,$ZT="GETERR^%ZAPM.bs.BSF12"
 I $D(@G) S $ZT=$G(%zT) Q 1
 S $ZT=$G(%zT) Q 0
GETERR I '$D(CALCFON),$ZE["PROT>" D ErrMsg^%ZAPM.bs.BSXfun("МАССИВ "_G_" НЕДОСТУПЕН ИЛИ НЕСУЩЕСТВУЕТ")
 S $ZT=$G(%zT) Q 0
KBD(B) ;B-TOBD ПЕРЕАДРЕСАЦИЯ МАССИВОВ БАЗЫ ДАННЫХ
 S %zT=$ZT,$ZT="ERGETBD^%ZAPM.bs.BSF12" ;S ^%ZZZ($I(^%ZZZ))=B 
 N NB,NI,zr,BB,AccKBD
 S BB=$P(@B@("KEY"),"@") 
 ;I $E(B,14,15)="]%" S B="^%"_$E(B,16,999) ;|||||
 I B["]%" S B="^%"_$P(B,"]%",2)
 
 ;I $ZV["Cach"||($ZV["IRIS") D BDEX^%ZAPM.bs.BSCp
 ;;;I "%SYS"'[$G(BSworkNSP),"/OPTIONs/PROTECT/BSG/GRAND/"[("/"_$QS(B,1)_"/") S BB="^["""_BSworkNSP_"""]BSC."_$QS(B,1)
 ;W !,BB R R
 I BB="^%ZAPM.bs.BStree" Q $G(%BS("Tmp","Tree"),"^%ZAPM.bs.BStree") ;ДЛЯ F5 РЕДАКТОРА Массивов
 D zr(1)
 ;D x^%ZAPM.bs.BS3(B)
 I $G(%BS(12))'="",$G(%BS(18))'="" I $D(@%BS(18)@(%BS(37),4,$$TIL(B))) D
 .S NB=$$TIL(B),NI=$O(@%BS(18)@(%BS(37),4,NB,"")) I NI=1 D  Q
 ..S NI=$O(@%BS(18)@(%BS(37),4,NB,1,"")) I NI'="" S:NI="*" NI="RWD" S AccKBD=NI
 .I NI'="" S BB=$$TILL(NI) ;ПЕРЕАДРЕСАЦИЯ ИМЕНИ БАЗЫ ДАННЫХ ДЛЯ ПОЛЬЗОВАТЕЛЕЙ
 I $G(%BS("TRIGGER"))'="",$D(^%ZAPM.bs.BSS("TRIGGER","KEY")) S NB=@$ZR I $$Data^%ZAPM.bs.BSF12(NB),$G(@NB@(%BS("TRIGGER"),$$TIL(BB),0))'="" S BB=@$ZR
 S %BS("Tmp","AKBD",$$TILL(BB))=$G(AccKBD,"RWD") ;ПРАВА ДОСТУПА НА БД
 ;D x^%ZAPM.bs.BS3($G(AccKBD,"?RWD"))
 I $D(^%ZAPM.bs.BSCiP.TREEGER($$TIL(B))) D  //ПЕРЕКЛЮЧАТЕЛЬ НАХОДИТСЯ ^%ZAPM.bs.BSCiP("TREEGER")
 .S g=BB X "I "_$G(^%ZAPM.bs.BSCiP.TREEGER($$TIL(B),"IF"),1)_" "_$G(^%ZAPM.bs.BSCiP.TREEGER($$TIL(B),"SET")) S BB=g
 
 S BB=$$SW(BB)
 ;S ^%ZZ=BB
 D zr(0)
 Q $$TILL(BB)
SW(G) //Глобальный переключатель
 D zr(1)
 I '$D(zBS4cfg) S zBS4cfg=$G(^%ZAPM.bs.BS("Config")) 
 I zBS4cfg="" D zr(0) Q G 
 N A S A=$G(^%ZAPM.bs.BSCiP.Switch(zBS4cfg,G,"NEW")) I A="" D zr(0) Q G
 D zr(0) Q A
TILL(NI) Q $TR(NI,"~",$C(34))
TIL(NI) Q $TR(NI,$C(34),"~")
ERGETBD S $ZT=$G(%zT) Q $G(BB)
zr(N) I N=1 S zr=$ZR Q  ;СОХРАНИТЬ
 S $ZT="Erzr"
 I $D(zr),$D(@zr) ;ВОССТАНОВИТЬ
 Q
Erzr Q 
Pred(R) S %zT=$ZT,$ZT="ERPred^%ZAPM.bs.BSF12" ;ПРЕДОБРАБОТКА
 D @R S $ZT=$G(%zT) Q
ERPred W $$bel^%ZAPM.bs.BS3 D Wait^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE))
 S $ZT=$G(%zT) Q
Data(G) S %zT=$ZT,$ZT="ERGETGLB^%ZAPM.bs.BSF12" ;СУЩЕСТВОВАНИЕ УЗЛА
 I $D(@G) S $ZT=$G(%zT) Q 1
 S $ZT=$G(%zT) Q 0
ERGETGLB S $ZT=$G(%zT) Q "00"
Free N NoFree
 S do="I $P(^(j),""@"",7),$P(^(j),""@"",9)=1 S NoFree=1" D ALLT^%ZAPM.bs.BSS1
 I '$D(NoFree) S @BSR@(BST,"Free")=$$h^%ZAPM.bs.BS3()
 Q
%(bsr) I $E(bsr,1,2)'="^[" Q "^["""_$P($$ZU^%ZAPM.bs.BS3(1,0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"""]"_$P(bsr,"^",2,99)
 I $P($P(bsr,"]"),"[",2)'["," N bs S bs=$P($P($P(bsr,"]"),"[",2),$C(34),2) Q "^["""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"""]"_$P(bsr,"]",2,99)
 Q bsr
SS() ;ПОЛНАЯ ССЫЛКА КЛЕТКИ
 N W S W="{"_ny_","_nx_","""_BST_""","""_%w(6,1)_""","""_%w(6,2)_""","""_$S(%w(6,3):"",1:%w(6,3))_""""
 I TIP=2,$P(BS,"@",9)'=1 D  ;
 .I $D(NOKEY) S W=W_",...???" Q
 .S W=W_","_$S($D(%KEYS(0)):%KEYS(0),1:"""""")
 .F pi=1:1:9 I $D(%KEYS(pi)) S W=W_","_$S(%KEYS(pi)=+%KEYS(pi):%KEYS(pi),1:$C(34)_%KEYS(pi)_$C(34))
 I $D(Hid),$D(@Hid),$D(@Hid@(ny)) S W=W_","_$S(@$ZR=+@$ZR:@$ZR,1:$C(34)_@$ZR_$C(34))
 S W=W_"}" Q W
SSS D AddHist^%ZAPM.bs.BSXuse("^%ZAPM.bs.BSbufB(""HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")",$$SS())
 Q
D G 0^%ZAPM.bs.BSTM
 ; МИФИЧЕСКАЯ_КЛЕТКА @6@ @0@@@;;MIFB^%ZAPM.bs.BSF12
ADRESS S li=$$LineEdit^%ZAPM.bs.BSXfun("1,0?","Вводите адрес Мифической клетки: например 1,07 или 1,009") Q:YES<1  I li'?1"1,0".N D ErrMsg^%ZAPM.bs.BSXfun("НЕ ПРАВИЛЬНЫЙ ФОРМАТ МИФ.КЛЕТКИ") G ADRESS
 S ny=1,nx=$P(li,",",2) Q
MIFT D ADRESS G D:YES<1 G E21^%ZAPM.bs.BSF1
MIFB D ADRESS G D:YES<1 G E11^%ZAPM.bs.BSF1
 ;
]]></Routine>


<Routine name="%ZAPM.bs.BSF13" type="MAC" languagemode="0"><![CDATA[
%BSF13 ; пpогpамма ДОПОЛНИТЕЛЬНЫХ ФУНКЦИЙ КОМПЛЕКСА ; 13:49   15.04.2003
 Q
%PopTAB(BSr,BSt,KY,ke,v,LX) ;СОЗДАТЬ ТЕСТОВУЮ ТАБЛИЦУ
 N se,i,l,TmpTime
 ;ke-КОЛ-ВО КОЛОНОК
 ;v- ВЫСОТА ТЕКУЩЕЙ СТРОКИ
 D %Pop
 F i=1:1:KY D
 .S se=se+1 F j=1:1:ke S @BSr@(BSt,se,j)="@@"_$G(v,1)_"@"_LX_"@@@@@1@@@@@@ Line="_i_", Colomn="_j
 S @BSr@(BSt)="ТЕСТОВАЯ ТАБЛИЦА ("_KY_"x"_ke_")@@@@@@@1@1@22@80@1@@1@1@@1@@@1@"
 S BSR=BSr,BST=BSt
 S:$D(Fk) $P(@$ZR,"@",15)=Fk S:$D(PrEd) $P(@$ZR,"@",41)=PrEd
 D RESZER^%ZAPM.bs.BSF2,TABm^%ZAPM.bs.BSF1
 D %PopE
 Q
%PopE S TmpTime=$P($H,",",2)-TmpTime,$P(@BSr@(BSt),"@")=$P(@BSr@(BSt),"@")_" Создавалась "_(TmpTime/60)_" Мин."
 Q
%Pop S:$D(@BSr)["0" $P(@BSr,"@")="BaSe MsW @ТЕСТОВЫЙ РАЗДЕЛ"
 S se=0 K @BSr@(BSt) S TmpTime=$P($H,",",2) ;НАЧАЛО
 Q
%PopTXT(BSr,BSt,KY,LX) ;СОЗДАТЬ ТЕКСТ
 N i
 D %Pop
 S @BSr@(BSt)="ТЕСТОВЫЙ ТЕКСТ ("_KY_"x"_LX_")@@@@@@@1@1@22@80@1@@1@1@@1@@@1@"
 F i=1:1:KY S @BSr@(BSt,i)="Строка="_i_$J(" Line="_i,LX-8-$L(i))
 S $P(@BSr@(BSt),"@",17)=5,$P(@$ZR,"@",28)=KY,$P(@$ZR,"@",29)=""
 D %PopE
 Q
DoLINK ;ВХОД В ТИП ТАБЛИЦЫ LINK
 N P1,T1,S1
 I $P(@BSR@(BST,3,2),"@",15)="" D Yes^%ZAPM.bs.BSXfun("ЗАГРУЖАЕМ ТАБЛИЦУ ?",1) I YES<1 G GOO^%ZAPM.bs.BST
 S P1=$P(@BSR@(BST,1,2),"@",15),T1=$P(@BSR@(BST,2,2),"@",15) G GOO^%ZAPM.bs.BST:P1=""!(T1="")
 S S1=$NA(@P1@(T1)) I $$Data^%ZAPM.bs.BSF12(S1),$P(@S1,"@",17)'=6 S BSR=P1,BST=T1 G ^%ZAPM.bs.BST
 G GOO^%ZAPM.bs.BST
TNAME(BSR,BST) ;ТРАНСЛИРОВАТЬ ИМЯ ОТЧЕТА
 N A I $ZV["Cach"||($ZV["IRIS") D  Q A
 .S A=$TR($$BSR^%ZAPM.bs.BSA(BSR),",^""",":")_"!1!"_BST
 .I A[":""""]" S A=$$TR^%ZAPM.bs.BSsFUNM(A,":""""]",":""MSW""]")
 Q $TR($$BSR^%ZAPM.bs.BSA(BSR),",",":")_"!1!"_BST
SetTBD(N) ;ПЕРЕКЛЮЧИТЬ
 N NB
 S NB=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSS("TRIGGER"))) I $$Data^%ZAPM.bs.BSF12(NB),$D(@NB@(N)) S %BS("TRIGGER")=N Q 1
 Q 0
ClearTBD ;ОЧИСТИТЬ ПЕРЕКЛЮЧАТЕЛЬ БАЗ ДАННЫХ
 K %BS("TRIGGER")
 Q
ShowTBD() Q $G(%BS("TRIGGER"),"UNDEFINED")
USERSBAS ;ПРОГА ЧИСТКИ КОМЕНТАРИЕВ И ПАРОЛЕЙ В БАЗЕ ДАННЫХ ПОЛЬЗОВАТЕЛЕЙ ^%ZAPM.bs.BSS("USER")
 I R1=999 D  Q
 .N I,II,III
 .S I="" F  S I=$O(@BSD@(I)) Q:I=""  Q:I'[".@"  S II="" F  S II=$O(@BSD@(I,II)) Q:II=""  I '$D(@BSD@(II)) K @BSD@(I,II)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF2" type="MAC" languagemode="0"><![CDATA[
%BSF2 ;КОРРЕКЦИЯ ОПИСАНИЯ ТАБЛИЦЫ II ; 21:19 24-FEB-99
LI D LE^%ZAPM.bs.BSTT Q
A24 W /CUP(24,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) Q
RES I '$D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf)) S ls=" Буфера нет " D O^%ZAPM.bs.BSF7 G D
 S (mj,mi)=0,ls=" Восстанавливаем "_$S(bf=1:"КЛЕТКУ",bf=2:"БЛОК",bf=3:"ТАБЛИЦУ",1:"ТЕКСТ")_" ,Вы уверены ? " D YES^%ZAPM.bs.BSF I 'YES G D
 I bf=4 D TXTREST^%ZAPM.bs.BSTT S $P(B,"@",23)=1 D 10^%ZAPM.bs.BSF S Quit=2 Q
 S %zT=$ZT,$ZT="ERV^%ZAPM.bs.BSF2" D REND,DEND I bf=1 S i=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,"")),j=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i,"")),si=ny-i,sj=nx-j,ii=si+i,jj=sj+j D RESKL,RESB G RESEND
 I bf=3 S TRe1="^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",3" G:'$D(@(BSR_"(BST)")) D S TRe2=$P($ZR,")"),BSr=BSR,BSt=BST D TREE^%ZAPM.bs.BSTK,TRANS^%ZAPM.bs.BSS1 G RESEND
 D RESHOME K ^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S si=ny-hi,sj=nx-hj S i="" F  S i=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i)) Q:'i  S j="" F  S j=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i,j)) Q:'j  D RESKL
 I mi>se!(mj>ke) S:mi>se se=mi S:mj>ke ke=mj D RESZER,RESB G RESEND
 D RESB
RESEND K ^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15)),z,z1,mi,mj,ii,jj,si,sj,se,ke,hi,hj,i,h
 K BSr1,BSr2,BSt2,BSt1
 S Quit=1 G E92E
RESZER F i=1:1:se F j=1:1:ke I '$D(@(BSR_"(BST,i,j)")) S @(BSR_"(BST,i,j)")="@@"_$P($G(@(BSR_"(BST,i,1)"),"@@1"),"@",3)_"@"_$P($G(@(BSR_"(BST,1,j)"),"@@@5"),"@",4)_"@@@@@1@@@@@@"
e Q
RESB S i="" F  S i=$O(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  S l=$P(^(j),",",2),h=$P(^(j),",") D
 .I j=1 F jj=1:1:ke I $D(@(BSR_"(BST,i,jj)")) S $P(@$ZR,"@",3)=h
 .I i=1 F ii=1:1:se I $D(@(BSR_"(BST,ii,j)")) S $P(@$ZR,"@",4)=l
 Q
RESKL S h=$P(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i,j),"@",3),l=$P(^(j),"@",4),@(BSR_"(BST,i+si,j+sj)")=^(j) S:(i+si)>mi mi=i+si S:(j+sj)>mj mj=j+sj I (i+si)'=1,'$D(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+si,1)) S $P(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+si,1),",")=h
 I (j+sj)'=1,'$D(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,j+sj)) S $P(@$ZR,",",2)=l
 F f="FTR","FCL","COL","RTR","CMD" I $D(@(BSR_"(BST,f,si+i,sj+j)")) K @$ZR
RESKL1 F f="FTR","FCL","COL","RTR" I $D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,f,i,j)) D  I YES S @(BSR_"(BST,f,si+i,sj+j)")=li1,^(sj+j,1)=li
 .D  I 'YES S $P(@(BSR_"(BST,si+i,sj+j)"),"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))=""
 ..S li=^(j,1) D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,TIP,li,li1,BSB,BSR,BST,YES,f,se,ke,k0,k1,k2,k3,k4,k5,k6,k7,k8,k9)
 ..D ^%ZAPM.bs.BSFT Q
 I $D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,"CMD",i,j)) S @(BSR_"(BST,""CMD"",si+i,sj+j)")=@$ZR,$P(@(BSR_"(BST,si+i,sj+j)"),"@",14)=(si+i)_","_(sj+j)
 Q
RESHOME S hi=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,"")),hj=9999999,i="" F  S i=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i)) Q:'i  S j=$O(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),bf,i,"")) I j<hj S hj=j
 Q
E91 S s=ny D E999 G D:'YES D WAIT,DEND
 F i=se:-1:s+1  F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  D E99,EE91
 F i=s+1:1:s+li F j=1:1 Q:'$D(@(BSR_"(BST,s,j)"))  D E99I,EE91Z
 G E92E
EE91Z S @(BSR_"(BST,i,j)")=i1 Q
EE91 S @(BSR_"(BST,i+li,j)")=i1 F f="FTR","FCL","COL","RTR" I f(f)'="" S @(BSR_"(BST,f,i+li,j)")=f(f),^(j,1)=f(f,1)
 Q
E92 S k=nx D E999 G D:'YES D WAIT,REND
 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  D  ;
 .F j=ke:-1:k+1 I $D(@(BSR_"(BST,i,j)")) D E99,EE92
 .F j=k+1:1:k+li I $D(@(BSR_"(BST,i,k)")) D E99I,EE91Z
 K Quit
E92E D TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST,TIP^%ZAPM.bs.BST,W^%ZAPM.bs.BST,MEO^%ZAPM.bs.BSF S $ZT=$G(%zT) Q:$G(Quit)  G B^%ZAPM.bs.BSTM
EE92 S @(BSR_"(BST,i,j+li)")=i1 F f="FTR","FCL","COL","RTR" I f(f)'="" S @(BSR_"(BST,f,i,j+li)")=f(f),^(j+li,1)=f(f,1)
 Q
E999 S li=1,ls=" Сколько Строк / Колонок" D LI Q
D G 0^%ZAPM.bs.BSTM
WAIT S ls="ЖДИТЕ"
WAITS S WA="" I $D(GuiCall) W "<P>"_BLUE_ls_EF_"</P>" Q
 Q:$G(TIP)=7&($G(BST)'["@")  Q:$D(%BS)["0"  Q:$G(CALCFON)
 ;U $I:(0::::#10080)
 W /CUP(24,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),$$clr^%ZAPM.bs.BS3(12),"...",$E(ls,1,67),"...",$$atr^%ZAPM.bs.BS3(0)
WAI S WAI=0,WA="S WAI=WAI+1 I '(WAI#2) W $$atr^%ZAPM.bs.BS3(0),/CUP(24,"_($L($E($G(ls),1,67))+7)_"),WAI" W /CUP(25,1),/EL(0)
 Q
E99 S i1=@$ZR F f=15,7,6,8,13 S $P(@$ZR,"@",f)=""
 K f F f="RTR","FTR","FCL","COL" S f(f)=$G(@(BSR_"(BST,f,i,j)")),z=$ZR,f(f,1)=$G(^(j,1)) K @z
 Q
E99I S i1=@$ZR,$P(i1,"@",15)="",$P(i1,"@",7)="",$P(i1,"@",5)="",$P(i1,"@",8)="",$P(i1,"@",13)="",$P(i1,"@",16)="" Q
E131 S s=ny D E999 G D:'YES D WAIT,DEND I li>(se-s) S li=se-s
 F i=s+li+1:1:se  F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  D E99,E13S1
 F i=se-li+1:1:se F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  D E13K
 K Quit G E92E
E13S1 S @(BSR_"(BST,i-li,j)")=i1 F f="FTR","FCL","COL","RTR" I f(f)'="" S @(BSR_"(BST,f,i-li,j)")=f(f),^(j,1)=f(f,1)
 Q
E13S2 S @(BSR_"(BST,i,j-li)")=i1 F f="FTR","FCL","COL","RTR" I f(f)'="" S @(BSR_"(BST,f,i,j-li)")=f(f),^(j-li,1)=f(f,1)
 Q
E13K K @(BSR_"(BST,i,j)"),@(BSR_"(BST,""FTR"",i,j)"),@(BSR_"(BST,""FCL"",i,j)"),@(BSR_"(BST,""COL"",i,j)"),@(BSR_"(BST,""RTR"",i,j)") Q
E132 S k=nx D E999 G D:'YES D WAIT,REND I li>(ke-k) S li=ke-k
 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  D  ;
 .F j=k+li+1:1:ke I $D(@(BSR_"(BST,i,j)")) D E99,E13S2
 .F j=ke-li+1:1:ke I $D(@(BSR_"(BST,i,j)")) D E13K
 G E92E
ColMax S ColM=0
REND ;ke-ПОСЛЕДНЯЯ КОЛОНКА
 F j=1:1 Q:'$D(@(BSR_"(BST,1,j)"))  I $D(ColM),$P(@BSR@(BST,1,j),"@",4)>ColM S ColM=$P(@BSR@(BST,1,j),"@",4)
 S ke=j-1 Q
StrMax S StrM=0
DEND ;se-ПОСЛЕДНЯЯ СТРОКА
 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  I $D(StrM),$P(@BSR@(BST,i,1),"@",3)>StrM S StrM=$P(@BSR@(BST,i,1),"@",3)
 S se=i-1 Q
BS I $D(%TIT) S ls=" Сначало снимите титул !!! " D O^%ZAPM.bs.BSF7 Q
 S li=$P(@(BSR_"(BST)"),"@",8,11),li=$TR(li,"@",",") D  D LI Q:'YES  I $P(li,",")<1&($P(li,",")>22)!($P(li,",")>$P(li,",",3))!($P(li,",",2)>$P(li,",",4)) S ls=" Некорректные границы " D O^%ZAPM.bs.BSF7 G BS
 .S ls=" Корректируйте :Y1,X1,Y2,X2"
 D ColMax,StrMax I ($P(li,",",3)-$P(li,",")+1)<StrM D ErrMsg^%ZAPM.bs.BSXfun(" Высота окна меньше Максимальной высоты строки в Таблице") G BS
 I ($P(li,",",4)-$P(li,",",2)+1)<ColM D ErrMsg^%ZAPM.bs.BSXfun(" Ширина окна меньше Максимальной длины колонки в Таблице") G BS
 S li=$TR(li,",","@"),$P(@(BSR_"(BST)"),"@",8,11)=li D TIT^%ZAPM.bs.BST
BSSS W /ED(2) D W^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM,W^%ZAPM.bs.BSTM Q
I1 S $P(@(BSR_"(BST)"),"@",12)=1,$P(^(BST),"@",14)=1,$P(^(BST),"@",13)="" G II
I2 S $P(@(BSR_"(BST)"),"@",12)="",$P(^(BST),"@",14)="",$P(^(BST),"@",13)=1 G II
I3 S $P(@(BSR_"(BST)"),"@",12)="",$P(^(BST),"@",14)="",$P(^(BST),"@",13)=""
II S B=@$ZR D MR^%ZAPM.bs.BST Q
FK1 D R^%ZAPM.bs.BSF4(15,1) G II
FK2 D R^%ZAPM.bs.BSF4(15,"") G II
Z0 D R^%ZAPM.bs.BSF4(16,"") G II
Z1 D R^%ZAPM.bs.BSF4(16,1) G II
TT0 S $P(@(BSR_"(BST)"),"@",19)="" D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST K MY,MX D KLE^%ZAPM.bs.BSTM G D
TT1 I $D(%TIT) W $$bel^%ZAPM.bs.BS3 G D
 I '(BSX(0)=1&(BSY(0)=1)) S ls=" УСТАНОВИТЕ ТАБЛИЦУ НА НАЧАЛО:<Home><Home><Home> " D O^%ZAPM.bs.BSF7 G D
 ;I '$$CHECKTIT ;КОНТРОЛЬ НА РАЗМЕРЫ ОСТАВШЕГОСЯ ОКНА
 S $P(@BSR@(BST),"@",19)=ny_","_nx,B=@$ZR D TIT^%ZAPM.bs.BST S BSY(BS0)=$P($G(%TIT,1),","),BSX(BS0)=$P($G(%TIT,"1,1"),",",2) D TW^%ZAPM.bs.BST
 D KLE^%ZAPM.bs.BSTM G D
V1 S i=1 G V
V2 S i=2 G V
V3 S i=3 G V
V4 S i=4
V D R^%ZAPM.bs.BSF4(18,i) Q
ERV S ls=$ZE D O^%ZAPM.bs.BSF7 W $$r^%ZAPM.bs.BS3 K:$E(BST,1)="@" @(BSR_"(BST)") S R1=27 G END^%ZAPM.bs.BSF
]]></Routine>


<Routine name="%ZAPM.bs.BSF3" type="MAC" languagemode="0"><![CDATA[
%BSF3 ;ПЕРЕНАСЧЕТ,ЛОГИЧЕСКИЙ КОНТРОЛЬ,ОКНА,ТАБ&КОМ ; 13:19   09.08.2000
 Q
FOR S VYC=$P($G(@BSR@(BST)),"@",18) I VYC="" S VYC=1
 S se=$P(@$ZR,"@",28),ke=$P(@$ZR,"@",29)
 S I=$S(VYC=1:"F ny=1:1:se F nx=1:1:ke",VYC=2:"F ny=se:-1:1 F nx=1:1:ke",VYC=3:"F ny=1:1:se F nx=ke:-1:1",1:"F ny=se:-1:1 F nx=ke:-1:1")
 Q
 ;ВЫЧИСЛЕНИЯ
CALC Q:'$D(@BSR@(BST,"FCL"))
 D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) I 'LOC Q
 D FOR S WA="",ls="ВычислениЯ" D WAITS^%ZAPM.bs.BSF2
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSF3" N BsD
 I '$P(@BSR@(BST),"@",32),VYC=1 S ny="",nx="" F  S ny=$O(@(BSR_"(BST,""FCL"",ny)")) G:ny="" 6666 F  S nx=$O(@(BSR_"(BST,""FCL"",ny,nx)")) Q:nx=""  D CAL
 X I_" D CAL"
6666 S $ZT=$G(%zT) I '$D(BX) D U^%ZAPM.bs.BS3($NA(@BSR@(BST))) Q
 I WAI D MED^%ZAPM.bs.BSF S:$D(BsD) $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1
666 S do="I ""23""'[$P(@$ZR,""@"",7) D W^%ZAPM.bs.BSTM" D U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
66 I '$D(BX) D U^%ZAPM.bs.BS3($NA(@BSR@(BST))) Q
 S iy=MY,ix=MX,MR=0,MY="" F  S MY=$O(BY(MY)) Q:MY=""  S MX="" F  S MX=$O(BX(MX)) Q:MX=""  I $D(@(BSR_"(BST,"_BY(MY)_","_BX(MX)_")")) X do
 S MY=iy,MX=ix,MR=1 K iy,ix
 Q
CAL S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSF3" //добавил ловушку
 Q:"2345"[$P(@(BSR_"(BST,ny,nx)"),"@",7)  X $G(WA) K d1 I $P(@$ZR,"@",7)?.N1",".N Q:'$D(@(BSR_"(BST,""FCL"","_$P(@$ZR,"@",7)_")"))  X $$TR(@$ZR,"^%ZAPM.bs.BSA","") G CAL1
 X $$TR($G(@BSR@(BST,"FCL",ny,nx)),"^%ZAPM.bs.BSA","")
CAL1 I $P($G(@BSR@(BST,ny,nx),"@@@@@@@@1"),"@",9)=1 S $P(^(nx),"@",15)=$S(d1["@":"<!.!ERROR!.!>",1:d1) Q
 E  S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx)=$G(d1),BsD=1
 Q
ERRO S ls=" Ошибка В вызванной Таблице " D O^%ZAPM.bs.BSF7 S ls=$ZE D O^%ZAPM.bs.BSF7 R *i:0,*i,*i S $ZT=$G(%zT) Q
ERR S d1=" Ошибка: "_$S($ZE["<DIV":"DIVIDE",1:$ZE) W $$bel^%ZAPM.bs.BS3 Q:'$D(@(BSR_"(BST,ny,nx)"))
 I $P(@$ZR,"@",9)=1,$D(d1) S $P(@$ZR,"@",15)=d1 K d1 Q
 E  S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx)=d1 K d1
 Q
 ;
 ;ЛОГИКА
COL Q:$P(B,"@",27)
CALOGIC Q:'$D(@(BSR_"(BST,""COL"")"))  S ls="ЛОГИЧЕСКИЙ КОНТРОЛЬ "_$G(uzel)
 D FOR,WAITS^%ZAPM.bs.BSF2 S lo=0,YES=0,Ny=ny,Nx=nx,%zT=$ZT,$ZT="PRO^%ZAPM.bs.BSF3"
 I '$P(@(BSR_"(BST)"),"@",33) S ny="",nx="" F  S ny=$O(@(BSR_"(BST,""COL"",ny)")) G:ny="" LLLL F  S nx=$O(@(BSR_"(BST,""COL"",ny,nx)")) Q:nx=""  D LOG
 X I_" D LOG"
LLLL S $ZT=$G(%zT) I $D(uzel) D:lo LOGS^%ZAPM.bs.BSLOG Q  ;```D:lo LOGS^%ZAPM.bs.BSF6 Q
 K ^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1")
 I lo I '$E($P(B,"@",48),2) D LOB I YES D LOGS^%ZAPM.bs.BSLOG ;```D LOGS^%ZAPM.bs.BSF6
 S do="I $P(@$ZR,""@"",12) D W^%ZAPM.bs.BSTM" G 66
PRO I $ZE'["<PRO" S ls=$ZE D O^%ZAPM.bs.BSF7
 S $ZT=$G(%zT) Q
LOG Q:$P(@BSR@(BST,ny,nx),"@",13)=""  X WA S (d0,d,d1)=$S($P(@(BSR_"(BST,ny,nx)"),"@",9)=1:$P(^(nx),"@",15),1:$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx)))
 ;```I $P(@(BSR_"(BST,ny,nx)"),"@",13) X $G(@(BSR_"(BST,""COL"","_$P(^(nx),"@",13)_")")) S:'$T lo=lo+1 S $P(@BSR@(BST,ny,nx),"@",11)=$S($T:"",1:1) Q:'$P(B,"@",48)  D:'$T VLOG($NA(@(BSR_"(BST,""COL"","_$P(^(nx),"@",13)_")"))) Q
 ;```I $P(@(BSR_"(BST,ny,nx)"),"@",13)=0 X $G(@(BSR_"(BST,""COL"",ny,nx)")) S:'$T lo=lo+1 S $P(@BSR@(BST,ny,nx),"@",11)=$S($T:"",1:1) Q:'$P(B,"@",48)  D:'$T VLOG($NA(@(BSR_"(BST,""COL"",ny,nx)"))) Q
 I $P(@(BSR_"(BST,ny,nx)"),"@",13) X $$TR($G(@(BSR_"(BST,""COL"","_$P(^(nx),"@",13)_")")),"^%ZAPM.bs.BSA","") S:'$T lo=lo+1 S $P(@BSR@(BST,ny,nx),"@",11)=$S($T:"",1:1) Q:'$E($P(B,"@",48),1)  D:'$T VLOG($NA(@(BSR_"(BST,""COL"","_$P(^(nx),"@",13)_")"))) Q
 I $P(@(BSR_"(BST,ny,nx)"),"@",13)=0 X $$TR($G(@(BSR_"(BST,""COL"",ny,nx)")),"^%ZAPM.bs.BSA","") S:'$T lo=lo+1 S $P(@BSR@(BST,ny,nx),"@",11)=$S($T:"",1:1) Q:'$E($P(B,"@",48),1)  D:'$T VLOG($NA(@(BSR_"(BST,""COL"",ny,nx)"))) Q
 Q
LOB S ls=" Найдено "_lo_" ОШИБОК ! Будем СМОТРЕТЬ СПИСОК ЛОГИЧЕСКИХ НЕСООТВЕТСТВИЙ ? " W $$bel^%ZAPM.bs.BS3 D YESp^%ZAPM.bs.BSF Q
VLOG(FL) ;ВЫЧИСЛЕНИЕ ДАННЫХ В КЛЕТКАХ
 Q:'$D(@FL@(1))  N i,ii,iii,vi
 S (iii,FL)=@$ZR
 I FL["{" F i=2:1 Q:$P(FL,"{",i,i+1)=""  S ii=$P($P(FL,"{",i),"}") X "S vi=$$A^%ZAPM.bs.BSA("_ii_")" S iii=$$TR^%ZAPM.bs.BSsFUNM(iii,"{"_ii_"}",+vi)
 I FL'=iii S ^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1",$NA(@BSR@(BST,ny,nx)))=iii,$P(@BSR@(BST,ny,nx),"@",11)=1
 Q
O S ls=" РЕЖИМ В ПРОЦЕССЕ ОТЛАДКИ " D O^%ZAPM.bs.BSF7 Q
C R *R,*RR:0,*RR:0
CW D RE^%ZAPM.bs.BSsBUF W $$atr^%ZAPM.bs.BS3(0) K COLO Q
WIN1 ;ОТКРЫТИЕ ПСЕВДО-ОКНА
WIND D SA^%ZAPM.bs.BSsBUF
 W $$clr^%ZAPM.bs.BS3($G(COLO,3)),/ED(2) Q
GLO S:$E($G(li))'="^" li="^" S ll="",ls=" Вводите ИМЯ Глобального МАССИВА :",%HIS="^%ZAPM.bs.BSbufB(""HISARREY"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")" D LE^%ZAPM.bs.BSTT I 'YES Q
 I li="^" S YES=0 Q
GL I li["~D" S GL="~D",YES=1 Q
 S %zT=$ZT,$ZT="NGLO^%ZAPM.bs.BSF3" I '$D(@li)
 S $ZT=$G(%zT),GL=li,YES=1 Q
BUF D BU Q
BU D ErrMsg^%ZAPM.bs.BSXfun("РЕЖИМ ОТМЕНЕН !!!")
 Q
SAVE S %Y1=1,%X1=1,%Y2=25,%X2=80 G 3^%ZAPM.bs.BSsBUF
VB0 S $P(@(BSR_"(BST)"),"@",21)="",B=@$ZR K @(BSR_"(BST,""VST"")") Q
VB1 D BU Q
VS0 S $P(@(BSR_"(BST)"),"@",23)=1,B=@$ZR K @(BSR_"(BST,""STA"")") Q
VS1 S $P(@(BSR_"(BST)"),"@",23)="",B=@$ZR Q
 ;
CMD S li="" I $P(BS,"@",14)=(ny_","_nx) S li=ny_","_nx,li=$G(@(BSR_"(BST,""CMD"","_li_")"),"???")
 S ls=" Вводите / Корректируйте команду MSM (F1-Помощь)",ll="",%hlp="^%ZAPM.bs.BSHLP(H_CMD" D LE^%ZAPM.bs.BSTT I 'YES G QUIT
 I li="" S $P(@(BSR_"(BST,ny,nx)"),"@",14)="" K @(BSR_"(BST,""CMD"",ny,nx)") G QUIT
 E  S $P(@(BSR_"(BST,ny,nx)"),"@",14)=ny_","_nx,@(BSR_"(BST,""CMD"",ny,nx)")=li
 S XEC=li I li?.N1",".N S XEC=@(BSR_"(BST,""CMD"","_li_")")
 D command S $ZT=$G(%zT)
QUIT Q
XEC S XEC=$G(@(BSR_"(BST,""CMD"","_IYI_")")) D command S li=$G(li) Q
command S r=$G(BSR),t=$G(BST) D SA^%ZAPM.bs.BSsBUF,ZR,OP^%ZAPM.bs.BSF4,UCIS,comm,UCIR,RE^%ZAPM.bs.BSsBUF,CL^%ZAPM.bs.BSF4 Q
comm D SI^%ZAPM.bs.BSN,NNN^%ZAPM.bs.BSN(",r,t,nx,ny,XEC,d") S %zT=$ZT,$ZT="ERCMD" X XEC U $I::%BS(32)
ECMD S $ZT=$G(%zT) G REBUF
REBUF D QQQ^%ZAPM.bs.BSN(",r,t,nx,ny,li,R1") Q
UCIS S uci=$$ZU^%ZAPM.bs.BS3(0) Q
UCIR Q:$G(uci)=$$ZU^%ZAPM.bs.BS3(0)   q:'$d(uci)  //$G(
  D %GU^%ZAPM.bs.BSF4 H:uci'=$$ZU^%ZAPM.bs.BS3(0)  
  Q
ZR Q:r=""!(t="")!('$D(ny))!('$D(nx))  I $D(@(BSR_"(BST,ny,nx)"))
 Q
C3 S (i,%CAL)=2 G CA
C1 S (i,%CAL)=1 G CA
C2 S i="" K %CAL
CA D R^%ZAPM.bs.BSF4(20,i) Q
TAB S l4=14
TAB2 S li=$P(@(BSR_"(BST,ny,nx)"),"@",l4) S:li?.N1",".N li="" D TIR^%ZAPM.bs.BST4
TAB1 D RIT I 'YES Q
 I li="" S $P(@(BSR_"(BST,ny,nx)"),"@",l4)="" Q
 I BSr=BSR,BSt=BST S ls=" ОСТОРОЖНО !!! Рекурсив !!! " D O^%ZAPM.bs.BSF7 G TAB1
 S TmP=$S($D(PBD):PBD,1:$$GLOBAL^%ZAPM.bs.BSF9(BSr_","_BSt)) K PBD S $ZT=$G(%zT)
 ;;;S $P(@(BSR_"(BST,ny,nx)"),"@",l4)=$S(BSr'["]%":BSr,1:"^"_$P(BSr,"]",2,99))_","_BSt D:$D(PBD)  K PBD S $ZT=$G(%zT) D NEW^%ZAPM.bs.BSN ;!!!I $D(%CAL) D CALC
 ;;;.S $P(@(BSR_"(BST,ny,nx)"),"@",l4)=PBD
 S $P(@(BSR_"(BST,ny,nx)"),"@",l4)=TmP
 D NEW^%ZAPM.bs.BSN
 Q
G G D^%ZAPM.bs.BS
SE D SA^%ZAPM.bs.BSsBUF Q
RE D RE^%ZAPM.bs.BSsBUF Q
RIT ;РАЗДЕЛ И ТАБЛИЦА --> BSr,BSt   NoCheck=1 - НЕ ПРОВЕРЯТЬ СУЩЕСТВОВАНИЕ
 S YES=1,%hlp="^%ZAPM.bs.BSHLP(RIT",ls=" ВВОДИТЕ ссылку на таблицу:(TABL,PART,UCI,SYS) <F3>-КАТАЛОГ <F1>-ПОМОЩЬ",ll=" @",%KAT="D DIR^%ZAPM.bs.BSF6" D LE^%ZAPM.bs.BSTT Q:li=""  I 'YES S li="" Q
RII S BSr=$P(li,",",2),BSt=$P(li,","),BSu=$P(li,",",3),BSs=$P(li,",",4),%zT=$ZT,$ZT="NOFILE^%ZAPM.bs.BSF3" G:$E(BSr,1,2)["%" %RIT S:BSu="" BSu=$P($$ZU^%ZAPM.bs.BS3(0),",") S:BSs="" BSs=$P($$ZU^%ZAPM.bs.BS3(0),",",2) S:BSr="" BSr=$S(BSR["]":$P(BSR,"]",2),1:$P(BSR,"^",2))
 I '$D(@("^["""_BSu_""","""_BSs_"""]"_BSr)) G NOR
RI S TmP=$$BSR^%ZAPM.bs.BSA($ZR) I BSt="<INV>",$G(@$ZR)["%BS-invert-" S ls=" ВЫ ХОТИТЕ ВЫЗЫВАТЬ ФОРМИРУЕМУЮ ТАБЛИЦУ КОДИФИКАТОРА ? " D YES^%ZAPM.bs.BSF G:'YES RIT S BSr=$P(TmP,"(") Q
 I '$G(NoCheck),'$D(@TmP@(BSt)) S ls=" Таблицы "_$ZR_" не существует " D O^%ZAPM.bs.BSF7 S YES=0 Q:$D(MaS)  G RIT
 I li["<>",$P(@$ZR,"@",17)=2 S ls=" ВЫ ХОТИТЕ ВЫЗЫВАТЬ ФОРМИРУЕМУЮ ТАБЛИЦУ ЗНАЧЕНИЙ КЛЮЧЕЙ БАЗЫ ДАННЫХ ? ",PBD=li D YES^%ZAPM.bs.BSF G:'YES RIT S BSr=$P(TmP,"(") Q
 S BSr=$P(TmP,"("),YES=1 Q
%RIT S:BSr'["^" BSr="^"_BSr G NOR:'$D(@BSr),RI
NOR S ls=" Раздела "_$ZR_" не существует " D O^%ZAPM.bs.BSF7 S YES=0 Q:$D(MaS)  G RIT
NOFILE S ls=" Ошибка В Cсылке на Раздел и Таблицу "_$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT),YES=0 G RIT
ERCMD S ls=" Ошибка:"_$ZE_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 G ECMD
ERROR ;S ls=" Ошибка В Команде "_$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) D REBUF,UCIR,RE^%ZAPM.bs.BSsBUF,CL^%ZAPM.bs.BSF4 G G
 W $$bel^%ZAPM.bs.BS3 D REBUF,UCIR,RE^%ZAPM.bs.BSsBUF,CL^%ZAPM.bs.BSF4 G G
CMDERR ;S ls=" Ошибка В Команде "_$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) D REBUF G CMD
 W $$bel^%ZAPM.bs.BS3 D REBUF G CMD
NOGLO S ls=" Ошибка В Cсылке НА МАССИВ "_$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) G BU
NGLO S ls=" Ошибка В Cсылке НА МАССИВ "_$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT),YES=0 Q
SAVED ;СОХР ДАННЫХ В БУФЕРE
 K ^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),3) S do="S li=$S($P(^(j),""@"",9)=1:$P(^(j),""@"",15),1:$G(^%ZAPM.bs.BSbufB(""BB""_$G(%BS(3),$P)_$J_""u""_%BS(15),i,j))) S:li'="""" ^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),3,i,j)=li",ls="СОХРАНЯЕТСЯ" D WAITS^%ZAPM.bs.BSF2,BLOK^%ZAPM.bs.BSF1 G G
RESTO ;ВОССТ ДАННЫХ ИЗ БУФЕРА
 S i="",ls="ВОССТАНОВЛЕНИЕ" D WAITS^%ZAPM.bs.BSF2 F  S i=$O(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),3,i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),3,i,j)) Q:j=""  S li=^(j) I $D(@(BSR_"(BST,i,j)")) D
 .I $P(^(j),"@",5)!($D(%ZAP)) Q
 .I $P(^(j),"@",9)=1 S $P(^(j),"@",15)=li Q
 .S $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1 S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=li Q
 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G G
 ;
 ;МОДУЛЬ ИЗ %BSA
 ;
A(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16) S pp=$P($G(BSR),"^",2),ps=$S(pp'[",":$P($$ZU^%ZAPM.bs.BS3(0),",",2),1:$P(pp,$C(34),4))
 S pu=$S(pp'["[":$P($$ZU^%ZAPM.bs.BS3(0),","),1:$P(pp,$C(34),2)),pt=$G(BST) I $E(pp,1)="[" S pp=$P(pp,"]",2)
 S %zT=$ZT,$ZT="TRAP^%ZAPM.bs.BSA"
 I $D(p4) S pp=p4 I pp["^" S pp=$P(pp,"^",2)
 I $G(p3)'="" S pt=p3
 I $G(p5)'="" S pu=$TR(p5,"[]|""","") I pu["," S ps=$P(pu,",",2),pu=$P(pu,",")
 I $G(p6)'="" S ps=$TR(p6,"[]|""","") I ps["," S pu=$P(ps,","),ps=$P(ps,",",2)
 ;I $E(pp,1)="%" S pp="^"_pp ;`BSA
 S pp="^["""_pu_""","""_ps_"""]"_pp
 I $D(@(pp_"(pt,p1,p2)"))
 S bS=$ZR I $P(@pp@(pt,p1,p2),"@",9)=1 Q $P($G(@$ZR),"@",15)
 I '$D(p8),BST=pt,$$BSR(BSR)=pp Q $G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),p1,p2))
 S pb=$$KBD^%ZAPM.bs.BSF12($NA(@pp@(pt))),pb=$$BSD(pb,$G(p7))
 F pi=1:1:9 Q:'$D(^(pi))  Q:'$D(@("p"_(pi+7)))  S pb=pb_$S(@("p"_(pi+7))=+@("p"_(pi+7)):@("p"_(pi+7)),1:$C(34)_@("p"_(pi+7))_$C(34))_","
 S pij=p1_","_p2 I $P($G(@pp@(pt,"KEY",pi-1)),"@",6)="HiddenLastKey",$P($P(@(pp_"(pt,p1,p2)"),"@",18),"#",2)'="" D  Q $G(@$ZR,"<NO_VALUE>")
 .S pij=$P($P(@$ZR,"@",18),"#",2) I $D(@(pb_$C(34)_pij_""")"))
 I $P($P(@(pp_"(pt,p1,p2)"),"@",18),"#")'="" S pij=$P($P(@$ZR,"@",18),"#")
 I $D(@(pb_$C(34)_pij_""")")) Q @$ZR
 Q "<NO_VAL>"  ;$ZR
BSD(BSD,%NAm) ;ССЫЛКА НА УЗЕЛ БАЗЫ ДАННЫХ
 S %NAm=BSD_$G(%NAm)_$S(BSD["(":"",1:"(") I $E(%NAm,$L(%NAm))=")" S %NAm=$E(%NAm,1,$L(%NAm)-1)_","
 Q %NAm
BSR(bsr) N bs ;ПОЛНАЯ ССЫЛКА
 I $E(bsr,1,2)="^%" Q $$%^%ZAPM.bs.BSF12(bsr)
 ;4.;I $P($ZV,"Version ",2)'<4,bsr'["|" Q "^|"""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""|"_$P(bsr,"^",2)
 ;4.;I $P($ZV,"Version ",2)'<4,$P(bsr,"|",2)'["," S bs=$P($P(bsr,"|",2),$C(34),2) Q "^|"""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""|"_$P(bsr,"|",2)
 I bsr'["]" Q "^["""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(bsr,"^",2)
 I $P($P(bsr,"]"),"[",2)'["," S bs=$P($P($P(bsr,"]"),"[",2),$C(34),2) Q "^["""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(bsr,"]",2)
 Q bsr
TR(%1,%2,%3) N p,l,l3 ;ТРАНСФОРМАЦИЯ !!!!!ИЗ %BSsFUNM
 I %2="" Q %1
 I %1'[%2 Q %1
 S p=1,l=$L(%2),l3=$L(%3),%z=$ZT,$ZT="TRMAX^%ZAPM.bs.BSsFUNM"
 F  S p=$F(%1,%2,p) Q:p=0  S $E(%1,p-l,p-1)=%3,p=p+l3-l
 S $ZT=$G(%z) Q %1
TRMAX W $$bel^%ZAPM.bs.BS3 S $ZT=$G(%z) Q %1
]]></Routine>


<Routine name="%ZAPM.bs.BSF4" type="MAC" languagemode="0"><![CDATA[
%BSF4 ;РЕДАКТИРОВАНИЕ ОПЦИЙ ТАБЛИЦЫ ; 10:34   05.07.2001
D G 0^%ZAPM.bs.BSTM
E1561 G TT0^%ZAPM.bs.BSF2
E1562 G TT1^%ZAPM.bs.BSF2
E15103 D ErrMsg^%ZAPM.bs.BSXfun("ЭТО УЖЕ РУДИМЕНТ !") G D
E151011 G USM
E151012 S $P(@(BSR_"(BST)"),"@",17)=1 K @(BSR_"(BST,""USM"")") D TIP^%ZAPM.bs.BST G D
USM I TIP'=7,TIP>1 S ls=" ПОЛЬЗОВАТЕЛЬСКИМ МЕНЮ МОЖЕТ БЫТЬ ТОЛЬКО ПРОСТАЯ ТАБЛИЦА " D O^%ZAPM.bs.BSF7 G D
 I $D(%TIT) S ls=" СНИМИТЕ ТИТУЛ С ТАБЛИЦЫ " D O^%ZAPM.bs.BSF7 G D
 D LONG S i1=$S(LY'<17:6,1:5+((17-LY)\2)),i2=(80-LX)\2-1,i3=i1+LY-1 S:i2<2 i2=2 S i4=i2+LX-1 S:i3>22 i3=22 S:i4>78 i4=78 I $D(@(BSR_"(BST)")) F i=1:1:4 S $P(@$ZR,"@",7+i)=@("i"_i)
 F i=12,13,14,15,18,21 S $P(@$ZR,"@",i)=""
 F i=16,25,34 S $P(@$ZR,"@",i)=1
 S $P(@(BSR_"(BST)"),"@",17)=7,TIP=7
 D SETMENU($ZR)
 K CCC,LY,LX,i1,i2,i3,i4,BFL,%ZAP G 10^%ZAPM.bs.BSF
SETMENU(G) N A S A=$P(@G,"@",41) S A=$$TR^%ZAPM.bs.BSsFUNM(A,",MENU^%ZAPM.bs.BSF11","")
 I A["MENU^%ZAPM.bs.BSF11" S $P(@G,"@",41)=A Q
 S $P(@G,"@",41)="MENU^%ZAPM.bs.BSF11"_$S(A'="":","_A,1:"")
 Q
LONG D DEND^%ZAPM.bs.BSF2,REND^%ZAPM.bs.BSF2 S LY=$P(@(BSR_"(BST,se,1)"),"@")+$P(^(1),"@",3)-1,LX=$P(@(BSR_"(BST,1,ke)"),"@",2)+$P(^(ke),"@",4)-1 Q
E15102 S ls=" ВЫ ХОТИТЕ ЧТОБЫ ВАША ТАБЛИЦА СТАЛА ТЕКСТОМ ? " D YES^%ZAPM.bs.BSF I 'YES G D ;TEXT
 D OOO G D:'YES D TXT^%ZAPM.bs.BSTT,R(17,5) K %ZAP S $P(B,"@",23)=1 G 10^%ZAPM.bs.BSF
E15111 D R(25,"") Q
E15112 D R(25,1) Q
E15151 D R(34,"") Q
E15152 D R(34,1) Q
E15121 D R(26,1) Q
E15122 D R(26,"") Q
E15131 D R(27,"") Q  ;ЛОГИКА
E15132 D R(27,1) Q
E151621 D R(35,"") Q  ;СПИСКИ
E151622 S li=$P(B,"@",35),li=$S("1"[li:2,1:li),ls="'ДЛИНА#X1,X2,...,Xn' ,где Xi - колонки ,данные которых должны быть в списке"
 D LE^%ZAPM.bs.BSTT I YES D R(35,li)
 Q
R(i,ii) S $P(@(BSR_"(BST)"),"@",i)=ii S B=@$ZR Q
E151641 S Fi=$P(@(BSR_"(BST)"),"@",40)
 S li=$P(Fi,","),ls="По КАКОЙ КОЛОНКЕ ПОИСК ? (ALL-ПО ВСЕЙ ТАБЛИЦЕ)" D LE^%ZAPM.bs.BSTT Q:'YES  S $P(Fi,",")=li
 S li=$P(Fi,",",2),ls="С КАКОЙ СТРОКИ ВСЕГДА НАЧИНАТЬ ПОИСК ? (DFLT-С ТЕКУЩЕЙ)" D LE^%ZAPM.bs.BSTT Q:'YES  S $P(Fi,",",2)=li
 D Yes^%ZAPM.bs.BSXfun("УЧИТЫВАТЬ РЕГИСТР ПРИ ПОИСКЕ ?") S $P(Fi,",",3)=YES
 D R(40,Fi) Q
E151642 D R(40,"") Q
E15165 D OOO G D
E151631 D R(38,"") Q
E15169 D PRED^%ZAPM.bs.BSF9 G D
E151632 D RAML D:YES R(38,1) Q  ;РАМКИ
E151633 D RAML D:YES R(38,2) Q
E151634 D RAML D:YES R(38,3) Q
E1514 G OPT^%ZAPM.bs.BSF5
OOO D R(8,$G(BSY1(3),BSY1(0))) D R(9,$G(BSX1(3),BSX1(0))) S y=$O(BY(""),-1),x=$O(BX(""),-1) I $D(@(BSR_"(BST,"_BY(y)_","_BX(x)_")")) S l=$P(@$ZR,"@",3),ll=$P(@$ZR,"@",4) D R(10,y+l-1),R(11,x+ll-1) Q
 S ls=" НЕУДАЧА ",YES=0 D O^%ZAPM.bs.BSF7 Q
RAML S B=@(BSR_"(BST)") I $P(B,"@",21) S ls=" У ТАБЛИЦЫ ВКЛЮЧЕН ВИДЕОСТАТУС !!! ",YES=0 D O^%ZAPM.bs.BSF7 Q
 I $P(B,"@",8)<2!($P(B,"@",9)<2)!($P(B,"@",10)>79) S ls=" ДЛЯ РАМКИ ОКНО ВЫВОДА ТАБЛИЦЫ СЛИШКОМ ВЕЛИКО ",YES=0 D O^%ZAPM.bs.BSF7 Q
 S YES=1,ls=" ОБЖИМАТЬ ГРАНИЦЫ ОКНА БУДЕМ ? " D YES^%ZAPM.bs.BSF D:YES OOO Q
E151611 S Sort=$P(@BSR@(BST),"@",36) I TIP=3 D Yes^%ZAPM.bs.BSXfun("ВКЛЮЧИТЬ ОБЯЗАТЕЛЬНУЮ СОРТИРОВКУ СПИСКА ?",1) G D:YES<1 S Sort="1,1,0,"_$P(Sort,",",4) D SO^%ZAPM.bs.BSF9 G SETSORT
 S li=$P(Sort,","),ls=" СОРТИРОВАТЬ С КАКОЙ СТРОКИ" D LE^%ZAPM.bs.BSTT G D:'YES,D:'+li S $P(Sort,",")=+li
 S li=$P(Sort,",",2),ls=" С КАКИМ ШАГОМ" D LE^%ZAPM.bs.BSTT G D:'YES,D:'+li S $P(Sort,",",2)=+li D SORT^%ZAPM.bs.BSF9
SETSORT D R(36,Sort) K Sort G D
E151612 D R(36,"") G D ;СОРТИРОВКА ТАБЛИЦ
PAROL S ls="Вводите ПАРОЛЬ НА КОРРЕКЦИЮ ХАРАКТЕРИСТИК РАЗДЕЛА",li="",s=4,PARROL=1 K k D P12 Q
USER S ls="Вводите ваш ПАРОЛЬ",li="",s=4,PARROL=1 K k D P12 S ls=" Введите комментаpий...",ll="@" D LE^%ZAPM.bs.BSTT Q
E1571 D PASSWORD(BSR,BST,2,"Вводите пароль на вход в таблицу") G D
E1572 D PASSWORD(BSR,BST,5,"Вводите пароль на коррекцию данных") G D
E1573 D PASSWORD(BSR,BST,4,"Вводите пароль на коррекцию описания таблицы") G D
P12 S ll="@" D LINE^%ZAPM.bs.BSF1 I ('$D(k)) S k=li,ls=" Еще раз ... "_ls,li="" G P12
 I li'=k S ls=" Ничего ... не понимаю " D O^%ZAPM.bs.BSF7 Q
 I $D(PARROL) S %PAROL=li K PARROL Q
 S $P(@(BSR_"(BST)"),"@",s)=li K k,s Q
PASSWORD(MAS,TAB,s,ls,VAR) N k,li,ll S li="" I TAB'="" S MAS=MAS_"(TAB)"
PA S ll="@" D LE^%ZAPM.bs.BSTT I YES,('$D(k)) S k=li,ls=" Еще раз ... "_ls,li="" G PA
 I li'=k S ls=" Ничего ... не понимаю " D O^%ZAPM.bs.BSF7 Q
 I $D(PARROL) S %PAROL=li K PARROL Q
 S $P(@MAS,"@",s)=li K s Q
e Q
TBD I R3=89 ZT "F10"
 I R3=83 D COM^%ZAPM.bs.BS2 G D
 I R3=85 D SRV^%ZAPM.bs.BSF5 G D^%ZAPM.bs.BSF5
 I R3=86 D FIND^%ZAPM.bs.BSF5 G D
 I R3=88 S OO=20,OOO="^%ZAPM.bs.BS" K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G D:R1=27,MOUN:%B=1,UNMO:%B=2,SETUP:%B=3,Screen:%B=5 I %B=4 D:$G(%BS(23)) EraseD,LOCKTAB^%ZAPM.bs.BSF6,PAUSE D MGR^%ZAPM.bs.BS,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST
 G D
Screen D NEW Q
EraseD W $$atr^%ZAPM.bs.BS3(0),/ED(2) Q
PAUSE W $$r^%ZAPM.bs.BS3 Q
15 W /CUP(20,1) Q
OP I $ZV["Cach"||($ZV["IRIS") U 0:(80:"") Q
 U $I:(80:::::1) Q
CL I $ZV["Cach"||($ZV["IRIS") U 0:("IS") Q
 U $I:(0::::1) Q
UNMO N SYS,M,I,i D OP,15 S i=0 K SYS F I=1:1:7 I $$ZU^%ZAPM.bs.BS3(1,I)'="" S i=i+1,SYS(i)=I
 I '$D(SYS) S ls=" ДЕМОНТИРОВАТЬ НЕЧЕГО " D CL,O^%ZAPM.bs.BSF7 G NEW
 S X=SYS(i)
UNMO1 D UNM,CL G NEW
UNM I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 ZF  S YES=1 ZF  D CHECKDDP^%ZAPM.bs.BSD2($G(X,1)) Q:YES<1  D MGR^%ZAPM.bs.BS D ^UMOUNT Q
M D MOU,CL G NEW
MOUN D  D:'(R1=27!(%BShNAME="")) OP,15,MOU,CL G NEW
 .D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,R1,%BShNAME,%BSrs,%BSvg) S BSR="^%ZAPM.bs.BSETUP",BST="MOUNT" D CHECK,^%ZAPM.bs.BST
 .S %BShNAME=$P($G(^%ZAPM.bs.BSETUP("MOUNT",ny,2)),"@",15) I $L(%BShNAME)'=3!(%BShNAME["\") S %BShNAME=$$AddFile^%ZAPM.bs.BSDOS2(%BShNAME) Q
 .S %BSvg=$P($G(^%ZAPM.bs.BSETUP("MOUNT",ny,3)),"@",15),%BSrs=%BShNAME
MOU I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 D SI^%ZAPM.bs.BSN N (%BS,vl,%BShNAME,%BSrs,%BSvg) ZF  ZF  D OP,15,MGR^%ZAPM.bs.BS
 I $D(%BSrs) D ^MOUNTRVG
 I '$D(%BSrs) D ^DBMAINT3,DDPDIR^%ZAPM.bs.BSMSMF ;ОБНОВИТЬ ССЫЛКИ В ^BSdirddp
 D MOUNT^%ZAPM.bs.BSMSMF($G(VGNAME)) Q
SETUP S BSR="^%ZAPM.bs.BSETUP",BST="SETUP" D ^%ZAPM.bs.BST,CONF^%ZAPM.bs.BSH,CLr
NEW S NEWVOLUM=1,R1=27 D  K SYS,M,OO,OOO G END^%ZAPM.bs.BSF
 .S %BS(18)=$$%BSU^%ZAPM.bs.BSF7()
CHECK D MGR^%ZAPM.bs.BS Q:$D(@(BSR_"(BST)"))  S BSr1="^%ZAPM.bs.BSS",BSt1="MOUNT",BSr2="^%ZAPM.bs.BSETUP",BSt2=BST D COPY^%ZAPM.bs.BSTK Q
LOCK D:$D(%BS)["0" CLr U $I::%BS(32) Q
%BS1 S %BS(1)=$P($G(^%ZAPM.bs.BSETUP("SETUP",20,2)),"@",15) ;```I $E(%BS(1),8),$D(^ ("%MOUSE")) D ^%ZAPM.bs.BSMOUSE
 S $E(%BS(1),19)=$S($ZV'["Cach"&&($ZV'["IRIS"):0,$E(%BS(1),19):$E(%BS(1),19)+3,1:0)
 S %BS(18)=$$%BSU^%ZAPM.bs.BSF7()
 Q
LV S IntP=1
CLr I $ZV'["Cach"&&($ZV'["IRIS") N I,II,uci,SGCNFG S uci=$$ZU^%ZAPM.bs.BS3(0) I '$D(IntP) D
 .D MGR^%ZAPM.bs.BS I '$D(^%ZAPM.bs.BS("SYSGEN")) D CONF^%ZAPM.bs.BSH S ^%ZAPM.bs.BS("SYSGEN")=""
 .E  D BUFERS^%ZAPM.bs.BSH
 ;I $P($$LICINFO^%MSMOPS,"^")_","_$ZU(0)'=("10"_"00"_"00"_"0,"_"MG"_"R,M"_"SW") H
 I '$D(^%ZAPM.bs.BSETUP("PATH")) S BSr1="^%ZAPM.bs.BSS",BSt1="PATH",BSr2="^%ZAPM.bs.BSETUP",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 I '$D(^%ZAPM.bs.BSETUP("SETUP")) S BSr1="^%ZAPM.bs.BSS",BSt1="SETUP",BSr2="^%ZAPM.bs.BSETUP",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 I '$D(^%ZAPM.bs.BSETUP("SERVER")) S BSr1="^%ZAPM.bs.BSS",BSt1=$S($ZV["MSM":"SERVER",1:"CacheServ"),BSr2="^%ZAPM.bs.BSETUP",BSt2="SERVER" D COPY^%ZAPM.bs.BSTK
 S %BS(32)="X3.64-1979" I $P'=1 ;   S %BS(32)=???
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) D %BS35^%ZAPM.bs.BSre ;ЗАГРУЗКА ТАБЛИЦЫ ПЕРЕКОДИРОВКИ
 I '$D(IntP) D NS^%ZAPM.bs.BSH
 ;```D %BS35^%ZAPM.bs.BSre ;ЗАГРУЗКА ТАБЛИЦЫ ПЕРЕКОДИРОВКИ
 ;
 I $ZV["MSM-Workstation" S ^$DISPLAY($PDISPLAY,"ZOEMDB")=1
 I $ZV["Cach"||($ZV["IRIS") D CACHERUN^%ZAPM.bs.BSC
 I $ZV["MSM-PC" D ADRMEM
 D %BS1 B $E(%BS(1),15)=0
 D INITHELP^%ZAPM.bs.BSDOS2
 S %BS(2)=$P($G(^%ZAPM.bs.BSETUP("SETUP",3,2)),"@",15)
 S %BS(6)=$P($G(^%ZAPM.bs.BSETUP("SETUP",2,2)),"@",15) I '%BS(6) K %BS(6)
 S %BS(23)=+$P($G(^%ZAPM.bs.BSETUP("SETUP",10,2)),"@",15)
 S %BS(18)=$$%BSU^%ZAPM.bs.BSF7(),%BS(15)=+$G(%BS(15))
 S %BS(24,1)=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""PROTOKOL"")")
 S %BS(24,2)=$P($G(^%ZAPM.bs.BSETUP("PATH",4,4)),"@",15)
 S %BS(21)=$P($G(^%ZAPM.bs.BSETUP("SETUP",14,2)),"@",15) K:'(+%BS(21)=1!(+%BS(21)=2))!('$D(^%ZAPM.bs.BS("COM",+%BS(21)))) %BS(21) I $D(%BS(21)) S %BS(21)=^%ZAPM.bs.BS("COM",+%BS(21))_" "_$P(%BS(21)," ",2,99)
 S %BS(33)=$P($G(^%ZAPM.bs.BSETUP("SETUP",4,2)),"@",15)
 I '$D(^%ZAPM.bs.BSETUP("MOUNT")) S BSr1="^%ZAPM.bs.BSS",BSt1="MOUNT",BSr2="^%ZAPM.bs.BSETUP",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 S %BS(34)=$P($G(^%ZAPM.bs.BSETUP("SETUP",5,2)),"@",15)
 S %BS(34)=$S(%BS(34)'["/":"Y/Y/Y",1:%BS(34))
 S %BS(33)=$S(%BS(33)'["/":"10/0/0",1:%BS(33))
 I $D(^%ZAPM.bs.BSETUP("YEAR",1)) S %BS(36)=$H+$G(^%ZAPM.bs.BSETUP("YEAR",1))
 S %BS(20)=$P($G(^%ZAPM.bs.BSETUP("SETUP",12,2)),"@",15)
 S %BS(20)=$S(%BS(20)'["^":"",1:%BS(20))
 I $G(%BS(20))'="" S %BS(22)=$P($G(@%BS(20)@("CharGlob",1,4),"@@@@@@@@@@@@@@4114,4114,4114"),"@",15)
 E  S %BS(22)="4114,4114,4114"
 S %BS(5)=$P($G(^%ZAPM.bs.BSETUP("SETUP",15,2)),"@",15) S:%BS(5)>2 %BS(5)=0
 S %BS(16)=$P($G(^%ZAPM.bs.BSETUP("SETUP",16,2)),"@",15) S:%BS(16)>2 %BS(16)=0
 I '$D(%BS(12)) S %BS(12)=""
 I '$D(^%ZAPM.bs.BSETUP("COLOR")) S BSr1="^%ZAPM.bs.BSS",BSt1="COLOR",BSr2="^%ZAPM.bs.BSETUP",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 S %BS="" F I=2:1:13 S %BS=%BS_$S($P($G(^%ZAPM.bs.BSETUP("COLOR",I,2)),"@",15)'="":$P($G(@$ZR),"@",15),1:"0")_"!"
 I '$D(^%ZAPM.bs.BSETUP("PRNDFLT")) S BSr1=%BS(20),BSt1="PRNDFLT",BSr2="^%ZAPM.bs.BSETUP",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 I '$D(^%ZAPM.bs.BSETUP("PARPRN")) S BSr1=%BS(20),BSt1="PARPRN",BSr2="^%ZAPM.bs.BSETUP",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 I '$D(^%ZAPM.bs.BSbufB("INFO_K")) S BSr1="^%ZAPM.bs.BSS",BSt1="INFO_K",BSr2="^%ZAPM.bs.BSbufB",BSt2=BSt1 D COPY^%ZAPM.bs.BSTK
 K vD,%BS(7) S I=1 F  S I=$O(^%ZAPM.bs.BSETUP("MOUNT",I)) Q:'I  D
 .I $P($P(^%ZAPM.bs.BSETUP("MOUNT",I,2),"@",15),":")'="" S vD($P($P(@$ZR,"@",15),":"))=$S("N"[$P($G(^%ZAPM.bs.BSETUP("MOUNT",I,4)),"@",15):0,1:1)
 .I $P(^%ZAPM.bs.BSETUP("MOUNT",I,3),"@",15)'="",$P($G(^(5)),"@",15)="Y" S %BS(7,$P(^(3),"@",15))=""
 S (%BS(4),I)="" D  S %BS(4)=$TR(%BS(4),"QWERTYUIOPASDFGHJKLZXCVBNM","qwertyuiopasdfghjklzxcvbnm") K vD
 .F  S I=$O(vD(I)) Q:I=""  I vD(I) S %BS(4)=%BS(4)_I_":"
 K vD S:'%BS(2) %BS(2)="9999-1"
%GU N I S YES=0 ;ПЕРЕХОД ИЗ КИПА В КИП      uci="КИП,ТОМ"
 Q:$G(uci)=""  
 I $ZV["Cach"||($ZV["IRIS") D  Q  ;Cache' from InterSystems
 .I $$ZU(uci) S YES=1
 S I=$$ZU^%ZAPM.bs.BS3($P(uci,","),$P(uci,",",2)) I I'="" V 2:$J:$P(I,",",2)*32+$P(I,","):2 K np S YES=1 Q
 I '$D(np) S ls=" Кип,Том <"_uci_"> НЕдоступны " D O^%ZAPM.bs.BSF7
 K np Q
ZU(UCI,SYS) ;ПЕРЕЙТИ В НУЖНЫЙ КИП
 I $ZV["Cach"||($ZV["IRIS") Q $$CNS^%ZAPM.bs.BSCp(UCI)
 I '$$ZU^%ZAPM.bs.BS3(UCI,SYS) Q 0 ;
 V 2:$J:$P($ZU(UCI,SYS),",",2)*32+$P($ZU(UCI,SYS),","):2
 Q 1
ADRMEM N VT,CPU386 D VTYPE^%VIDEO S %BS(17)=$S(VT&CPU386:#B8000,'VT&CPU386:#B0000,VT&'CPU386:#B8000000,1:#B0000000) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF5" type="MAC" languagemode="0"><![CDATA[
%BSF5 ;ПОМЕТКА;СЕРВИС БАЗЫ ДАННЫХ,ПОИСК,МЕНЮ                ; 15:40   02.02.2000
SRV K M S M(1,1)=" MUMPS MS-DOS ТEST-MSM TEST-%BS СТАТИСТИКА BACKCOPY " I $E(BST)="R",BSR["%BSbufB",ny>2 S M(1,1)=M(1,1)_"ХАРАКТЕРИСТИКИ_РАЗДЕЛОВ "
 S M(1,1)=M(1,1)_"@6@ @0",OO=1,OOO="M" D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF Q:R1=27  I %B=1 D ^%ZAPM.bs.BSMSM Q
 I %B=2 D ^%ZAPM.bs.BSDOS Q
 I %B=3 D TEST^%ZAPM.bs.BSMSM Q
 I %B=4 D ^%ZAPM.bs.BSI Q
 I %B=5 D STAT^%ZAPM.bs.BSF11 Q
 I %B=6 D COPYINF^%ZAPM.bs.BSVOL Q
 D %GBL^%ZAPM.bs.BS2:%B=6 Q
FIND S li=$G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)),ls=" Введите контекст ПОИСКА ;имя таблицы ",ll="@ " D LE^%ZAPM.bs.BSTT Q:'YES  ;ТАБЛИЦ
STA K END S St=1,(uci,Uci)=$$ZU^%ZAPM.bs.BS3(0),^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)=$G(li) D FIUCI G:$D(END) FEND
 K BSuCI S UCI=$P($$ZU^%ZAPM.bs.BS3(0),","),SYS=$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 F I=0:1 Q:$$ZU^%ZAPM.bs.BS3(1,I)=""  S BSuCI(I)=$P($$ZU^%ZAPM.bs.BS3(1,I),",",2) F J=1:1 Q:$$ZU^%ZAPM.bs.BS3(J,I)=""  S BSuCI(I,J)=$P($$ZU^%ZAPM.bs.BS3(J,I),",") I '(BSuCI(I)=SYS&(BSuCI(I,J)=UCI)) S uci=BSuCI(I,J)_","_BSuCI(I) D %GU^%ZAPM.bs.BSF4 I YES D FIUCI G:$D(END) FEND
 I '$D(DOX)&('$D(DOPART))&('$D(DOBD))&('$D(DOKD))&('$D(DOMASS)) S ls=" ТАБЛИЦА "_li_" НЕ НАЙДЕНА " D O^%ZAPM.bs.BSF7
 S uci=UCI_","_SYS D %GU^%ZAPM.bs.BSF4
FEND K l,St,STa,Uci,uci,iI,i,END,UCI,SYS,BSuCI Q
FIUCI I $D(DOUCI) X DOUCI E  Q
 S i="^" F  S i=$O(@i) Q:i=""  S i="^"_i I i'="^%ZAPM.bs.BSbufB" D  G:$D(END) FFND
 .S ls=uci_"  "_i D WAITS^%ZAPM.bs.BSF2
 .I $G(DOBD)'="",$P($G(@i),"@")="BSD - MSW" X DOBD,WA Q  ;БАЗЫ
 .I $G(DOKD)'="",$P($G(@i),"@")["%BS-invert-" X DOKD,WA Q  ;КОДИФИКАТОРЫ
 .I $G(DOMASS)'="" X DOMASS,WA Q  ;МАССИВЫ````` недавно перенес
 .I $P($G(@i),"@")="BaSe MsW " D  Q  ;РАЗДЕЛЫ %BS
 ..I $D(DOPART) X DOPART,WA Q
 ..S iI="" F  S iI=$O(@i@(iI)) Q:iI=""  D  Q:$D(END)
 ...I $D(DOX) X DOX,WA Q  ;ТАБЛИЦЫ
 ...I ("@"_iI)[("@"_li) I $D(@(i_"(iI)")) S ls=$ZR_"   "_$P(@$ZR,"@")_"; ГОДИТСЯ ? " D YES^%ZAPM.bs.BSF I YES S END=i,TABLfind=iI Q
e Q
BSSS(ll) F l=1:1:19 S @(BSR_"(BST,St,l)")=^%ZAPM.bs.BSS("STA",ll,l)
 Q
FFND S EXITout=$$ZU^%ZAPM.bs.BS3(0) D  S uci=Uci D %GU^%ZAPM.bs.BSF4 D  S uci=EXITout D %GU^%ZAPM.bs.BSF4
 .K ^%ZAPM.bs.BSbufB("T"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("R"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("fT"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 S %NAM=END Q
SERV N YES1 S %B=1,M(1,1)=^%ZAPM.bs.BS(27,1),ls="" D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BS(25)","M(25)")
 K Dark I $G(%BS("Tmp","AKBD",BSD),"RWD")'="RWD" S Dark(1,1)=" 1 1 0 1 1 0 0"
 D MEN K Dark G D:'YES,DUBLI:%B=2,FIND^%ZAPM.bs.BSBD:%B=3,COPDEL:%B=4,VIC:%B=5,LOG^%ZAPM.bs.BSF10:%B=6,MUK^%ZAPM.bs.BSLOG:%B=7
SUM I key=0 S ls=" ИМЕННОЙ КЛЮЧ СУММИРОВАТЬ НЕЛЬЗЯ " G O
 I key'=endkey S ls=" ВЫ ХОТИТЕ СУММИРОВАТЬ КЛЮЧИ НЕ ПОСЛЕДНЕГО УРОВНЯ ! ВЫ УВЕРЕНЫ ? " W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF G:'YES O
 I '$D(%DIA) S ls=" НЕ ПОМЕЧЕНЫ СЛАГАЕМЫЕ КЛЮЧИ " G O
 D:key NEWKEY1^%ZAPM.bs.BST1 D:'key NEWKEY0^%ZAPM.bs.BST1 G:'YES D S %iii=d D SUU
 X "I $D(@%NAm)" S do="D:i>3 SU^%ZAPM.bs.BSF5",TRe2=$P($ZR,")") D TRE2 I YES<1 D Yes^%ZAPM.bs.BSXfun("Смешиваем существующий узел и Сумму ?",2) I YES<1 G ENDD
 I YES D BLOK^%ZAPM.bs.BSF1 S @(TRe2_")")=$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())
ENDD K l,j,TRe1,TRe2,ii,%iii,NOKILLER,KILLER S R1=27 Q
SU S %iii=$P(^(j),"@",15) D SUU I $D(@%NAm)
 S TRe1=$P($ZR,")"),ls="Суммиpование.."_TRe1_" В "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2
 N Calc S Calc=$$CALC($NA(@Bsr@(Bst)))
 S l=TRe1_")",ll=TRe1_"," F  S l=$ZO(@l) Q:l'[ll  D
 .I Calc'="",Calc[("@"_$QS(l,$QL(l))_"@") Q  ;НЕ ВЫЧИСЛЯТЬ НЕКОТОРЫЕ
 .S @(TRe2_","_$P(l,ll,2,9))=$G(@(TRe2_","_$P(l,ll,2,9)))+@l
 Q
CYES ;РАЗРЕШИТЬ
 N A S A=$P(@BSR@(BST,ny,nx),"@",18)
 S $P(A,"#",4)="",$P(@BSR@(BST,ny,nx),"@",18)=A
 K @BSR@(BST,"NoCalcCell",1)
 Q
CNO ;ЗАПРЕТИТЬ
 N A S A=$P(@BSR@(BST,ny,nx),"@",18)
 S $P(A,"#",4)=1,$P(@BSR@(BST,ny,nx),"@",18)=A
 S @BSR@(BST,"NoCalcCell")="ЕСТЬ КЛЕТКИ ЗАПРЕЩЕННЫЕ К СУММИРОВАНИЮ И ВЫЧИТАНИЮ"
 Q
CALC(S) ;ВЕРНУТЬ СТРОКУ ИЗ ,СИХБ, ЗАПРЕЩЕННЫХ К СУММИРОВАНИЮ И ВЫЧИТАНИЮ
 I '$D(@S@("NoCalcCell")) Q ""
 I $D(@S@("NoCalcCell",1)) Q $$GLRET^%ZAPM.bs.BSF12($ZR)
 N i,j,s,z S s="" F i=1:1 Q:'$D(@S@(i))  F j=1:1 Q:'$D(@S@(i,j))  I $P($P(@S@(i,j),"@",18),"#",4) D  S s=s_"@"_z
 .I $P($P(@S@(i,j),"@",18),"#",1) S z=$P($P(@S@(i,j),"@",18),"#",1) Q
 .S z=i_","_j
 I s="" K @S@("NoCalcCell") Q ""
 D GLSET^%ZAPM.bs.BSF12($NA(@S@("NoCalcCell",1)),s_"@")
 Q s_"@"
SUU S %NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 I key=0 S %NAm=BSD_%iii Q
 S %NAm=%NAm_$S(%iii=+%iii:%iii,1:$C(34)_%iii_$C(34))_")" Q
VIC I '$D(%DIA) S ls="НЕ ПОМЕЧЕН ВЫЧИТАЕМЫЙ КЛЮЧ" G O
 K KILLER,VIC D DUBL G D:'YES1 S do="I i>2 S VIC=$P(^(j),""@"",15),i=9999999" D BLOK^%ZAPM.bs.BSF1
 D SUU X "I $D(@%NAm)" S TRe1=$P($ZR,")") I '$D(VIC) S ls="ПОМЕЧЕННЫЙ КЛЮЧ НЕ НАЙДЕН" G O
 S %iii=VIC D SUU X "I $D(@%NAm)" S TRe2=$P($ZR,")")
 S ls="Вычитание из"_TRe1_" - "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2
 N Calc S Calc=$$CALC($NA(@Bsr@(Bst)))
 S l=TRe2_")",ll=TRe2_"," F  S l=$ZO(@l) Q:l'[ll  D
 .I Calc'="",Calc[("@"_$QS(l,$QL(l))_"@") Q  ;НЕ ВЫЧИСЛЯТЬ
 .I '$D(@(TRe1_","_$P(l,ll,2,9))) S @$ZR=0 X WA
 S l=TRe1_")",ll=TRe1_"," F  S l=$ZO(@l) Q:l'[ll  D
 .I Calc'="",Calc[("@"_$QS(l,$QL(l))_"@") Q  ;НЕ ВЫЧИСЛЯТЬ
 .S @l=@l-$G(@(TRe2_","_$P(l,ll,2,9))) X WA
 G ENDD
DUBLI K KILLER D DUBL G ENDD:YES1,D
COPDEL S KILLER=1 D DUBL G ENDD:YES1,D
DUBL S YES1=0 Q:ny<3  S %iii=d D SUU X "I $D(@%NAm)" S TRe1=$P($ZR,")")
 D:key NEWKEY1^%ZAPM.bs.BST1 D:'key NEWKEY0^%ZAPM.bs.BST1 Q:'YES  S %iii=d D SUU X "I $D(@%NAm)" S TRe2=$P($ZR,")") D  S YES1=1 Q
 .S YES1=1 D TRE2 I YES<1 D Yes^%ZAPM.bs.BSXfun("Смешиваем существующий узел и Дублируемый ?",2) I YES<1 Q
 .S NOKILLER=1 I 'YES Q
 .I 'key D TRE^%ZAPM.bs.BSTK
 .I key D TREE^%ZAPM.bs.BSTK S @(TRe2_")")=$$h^%ZAPM.bs.BS3()_","_$G(%BS(12))_",1,"_$$h^%ZAPM.bs.BS3()
 .Q:'$D(KILLER)  I '$D(%w(3)) D PASDD^%ZAPM.bs.BST1 E  S YES=0 Q
 .D DEL^%ZAPM.bs.BSF10($NA(@(TRe1_$S(key:")",1:""))),2) Q
TRE2 I $D(@(TRe2_$S(key:")",1:""))) S ls=" КЛЮЧ "_d_" УЖЕ СУЩЕСТВУЕТ , УДАЛЯЕМ ? " D YES^%ZAPM.bs.BSF Q:'YES
 I '$D(%w(3)) D PASDD^%ZAPM.bs.BST1 E  S YES=0 Q
 D DEL^%ZAPM.bs.BSF10($NA(@(TRe2_$S(key:")",1:""))),2) Q
PL G D:TIP=7 S %zT=$ZT,$ZT="ERP^%ZAPM.bs.BSF5",%B=1 D MENU(^%ZAPM.bs.BS(22,1)_"ОСОБАЯ "," ******* ПОМЕТКА КЛЕТОК ******* ",5) S %DIAP=1 G D:'YES,7:%B=4,71:%B=2,OS:%B=5
76 I %B=1 D P S:$G(%DIAP) $P(@(BSR_"(BST)"),"@",3)=1,%DIA="" F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  I $D(@(BSR_"(BST,i,nx)")) S $P(^(nx),"@",12)=$G(%DIAP)
 I %B=3 D P S:$G(%DIAP) $P(@(BSR_"(BST)"),"@",3)=1,%DIA="" F j=1:1 Q:'$D(@(BSR_"(BST,ny,j)"))  I $D(@(BSR_"(BST,ny,j)")) S $P(^(j),"@",12)=$G(%DIAP)
 G 70
O D O^%ZAPM.bs.BSF7
D K KILLER G 0^%ZAPM.bs.BSTM
MENU(m,ms,b) N OO,OOO,M,%JB S M(1,1)=m_"@6@ @0",OO=1,OOO="M",ls=ms ;БЛОЧНОЕ МЕНЮ
MEN W /CUP(25,1) D 0^%ZAPM.bs.BSF W /EL(0),$$clr^%ZAPM.bs.BS3(8),ls S OOO="M",OO=1 S:$G(b) %B=b D 0^%ZAPM.bs.BSF,24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB S YES=$S(R1=27:0,1:1) D A25^%ZAPM.bs.BSF1 Q
MI G D:TIP=7 S %B=1,%zT=$ZT,$ZT="ERP^%ZAPM.bs.BSF5" D MENU(^%ZAPM.bs.BS(22,1)," ******* СНЯТИЕ ПОМЕТКИ ******* ",2) S %DIAP="" G D:'YES,7:%B=4,71:%B=2,76
P S ls=$S($G(%DIAP):"ПОМЕТКА КЛЕТОК",1:"СНЯТИЕ ПОМЕТКИ") D WAITS^%ZAPM.bs.BSF2 Q
7 S OOO="M",OO=1,M(1,1)=" ОТКАЗ ПЕРВАЯ_ГРАНИЧНАЯ_ТОЧКА_" S:$D(%DI) M(1,1)=M(1,1)_"{"_%DI_"}" I $D(%DI) S M(1,1)=M(1,1)_" ВТОРАЯ_ГРАНИЧНАЯ_ТОЧКА"_$S($D(%DIA):"{"_%DIA_"}",1:"")
 S M(1,1)=M(1,1)_" @6@ @0" D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G D:R1=27!(%B=1),@("7"_%B)
73 S %DIA=ny_","_nx I $P(%DI,",")<$P(%DIA,",") S i1=$P(%DI,","),i2=$P(%DIA,",")
 E  S i1=$P(%DIA,","),i2=$P(%DI,",")
 I $P(%DI,",",2)<$P(%DIA,",",2) S j1=$P(%DI,",",2),j2=$P(%DIA,",",2)
 E  S j1=$P(%DIA,",",2),j2=$P(%DI,",",2)
 D P S:$G(%DIAP) $P(@(BSR_"(BST)"),"@",3)=1 F i=i1:1:i2 Q:'$D(@(BSR_"(BST,i)"))  F j=j1:1:j2 Q:'$D(@(BSR_"(BST,i,j)"))  S $P(^(j),"@",12)=$G(%DIAP)
70 D 0^%ZAPM.bs.BSF,W^%ZAPM.bs.BST K i,j,i1,i2,j1,j2,%DI S $ZT=$G(%zT) G D
71 K:'$G(%DIAP) %DIA,%DI G 74
72 S %DI=ny_","_nx K %DIA G D
74 D 75 D:$D(%DIA) 0^%ZAPM.bs.BSF,W^%ZAPM.bs.BST K:'$G(%DIAP) %DIA,i,j G D
75 S $P(@(BSR_"(BST)"),"@",3)=$G(%DIAP) D P F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  S $P(^(j),"@",12)=$G(%DIAP),%DIA=1
 Q
OS ;ОСОБАЯ ПОМЕТКА
 D MENU(" С_ШАГОМ_? ХРАНимые_В_БАЗЕ ИНВЕРсия ОЧИСТить ПУСТЫЕ_ДАННЫЕ БАЗА_ПОМЕТОК "," Эти pежимы pаботают от указателя ВПРАВО и ВНИЗ (База пометок в ^%ZAPM.bs.BSVOL,MARK)",1) G D:'YES
 I %B=1!(%B=4) S e=$$LineEdit^%ZAPM.bs.BSXfun($S(%B=1:2,1:1),"Так с каким шагом "_$S(%B=1:"ПОМЕЧАТЬ",1:"СНИМАТЬ ПОМЕТКУ")) G D:'YES
 I %B=6 D GOMARK^%ZAPM.bs.BSVOL G 70
 S $P(@(BSR_"(BST)"),"@",3)=1,%DIA=1
 S e=$S(%B=1:e,1:1) D P F i=ny:e:se F j=nx:e:ke I $D(@(BSR_"(BST,i,j)")) S $P(^(j),"@",12)=$S(%B=1:1,%B=2:$P(^(j),"@",9)'=1,%B=3:'$P(^(j),"@",12),%B=5:$P(^(j),"@",15)="",1:"")
 G 70
ERP S ls="ОШИБКА ПРИ ПОМЕТКИ !!! " I $ZE["<PROT" S ls=ls_" ТАБЛИЦА ЗАЩИЩЕНА"
 E  S ls=ls_$ZE
 D O^%ZAPM.bs.BSF7 G 70
OPT ;ОПТИМИЗАЦИЯ
 I $P(@(BSR_"(BST)"),"@",22) S ls=" ТАБЛИЦА УЖЕ БЫЛА ОПТИМИЗИРОВАНА " D O^%ZAPM.bs.BSF7 G D
 S ls=" !!!! ВНИМАНИЕ !!!! " D O^%ZAPM.bs.BSF7 S ls=" ЭТО НЕОБРАТИМЫЙ ПРОЦЕСС, КОРРЕКЦИЯ ТАБЛИЦЫ БУДЕТ ЗАПРЕЩЕНА, ВЫ УВЕРЕНЫ ? " W *7 S %B=2 D YES^%ZAPM.bs.BSF I YES S ls=" ВЫ ТОЧНО УВЕРЕНЫ ? ",%B=2 W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF
 S ls=" OPT^%ZAPM.bs.BSF5 " D O^%ZAPM.bs.BSF7 G D ;!!!!!!! ЗАКРЫТО
 G D:'YES S ls="ОПТИМИЗАЦИЯ" D WAITS^%ZAPM.bs.BSF2 S $P(@(BSR_"(BST)"),"@",22)=1,BSr=BSR,BSt=BST
 F f="FTR","FCL","COL","RTR" I $D(@(BSr_"(BSt,f)")) S i="" F  S i=$O(@(BSr_"(BSt,f,i)")) Q:i=""  S j="" F  S j=$O(@(BSr_"(BSt,f,i,j)")) Q:j=""  K ^(j,1)
 F k=0:1:13 I $D(@(BSR_"(BST,""KEY"",k)")) K ^(k,2),^(4) S zr=$ZR F kk=10:1 X "I $D(@zr)" Q:'$D(^(kk))  K ^(kk,2)
 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST,CALC^%ZAPM.bs.BSF3 G B^%ZAPM.bs.BSTM
REM ;       РЕМОНТ
 D EnterP^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""REPAIR"",""BUT"")") S YES=$S(d=1&(R1=13):1,1:0)
 G D:'YES S ls="РЕМОНТ ТАБЛИЦЫ" D WAITS^%ZAPM.bs.BSF2,REMONT(BSR,BST)
 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST,CALC^%ZAPM.bs.BSF3 G B^%ZAPM.bs.BSTM
REMONT(BSR,BST) 
 K ^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15)) F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  S $P(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1),"#")=$S($P(@(BSR_"(BST,i,1)"),"@",3)="":1,1:$P(@(BSR_"(BST,i,1)"),"@",3))
 F j=1:1 Q:'$D(@(BSR_"(BST,1,j)"))  S $P(^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,j),"#",2)=$S($P(^(j),"@",4)="":1,1:$P(^(j),"@",4)) X $G(WA)
 S do="S zr=$ZR,$P(@zr,""@"",3)=$P(^%ZAPM.bs.BSbufB(""u""_$G(%BS(3),$P)_$J_""u""_%BS(15),i,1),""#""),$P(@zr,""@"",4)=$P(^%ZAPM.bs.BSbufB(""u""_$G(%BS(3),$P)_$J_""u""_%BS(15),1,j),""#"",2),$P(@zr,""@"",11)="""""
 D ALLT^%ZAPM.bs.BSS1 S $P(@(BSR_"(BST)"),"@",24)="" K ^%ZAPM.bs.BSbufB("u"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D TAB^%ZAPM.bs.BSF1 I '$P(@(BSR_"(BST)"),"@",22) S ls=" РЕТРАНСЛЯЦИЮ ФОРМУЛ БУДЕМ ДЕЛАТЬ ? " D YES^%ZAPM.bs.BSF I YES S BSr=BSR,BSt=BST D TRANS^%ZAPM.bs.BSS1
 Q
CKD(%VGI) Q:'$D(%BS(6))  Q:'$D(%VGI)  D INT^%SP I %BS(6)>%FTOTBLK S ls=" ВНИМАНИЕ !!! На Томе "_$P($$ZU^%ZAPM.bs.BS3(1,%VGI),",",2)_" Осталось "_%FTOTBLK_" Свободных Блоков " D O^%ZAPM.bs.BSF7
 C 63 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF6" type="MAC" languagemode="0"><![CDATA[
%BSF6 ;ИНФО,DIR-%BS,ТЕМНЫЕ БЛОКИ МЕНЮ ; 10:57   05.01.2001
INFO Q:BSR="^%ZAPM.bs.BSS"&(BST="INFO")  D KILBF K %KAT S %KAT(1)=$S_"!"_$G(BSR)_"!"_$G(BST),%KAT(2)=$G(@(BSR_"(BST)")) I $D(ny) S %KAT(3)=$G(@BSR@(BST,ny,nx))
 S %KAT(7,"LST")=$G(@BSR@(BST,"LST"))
 I $D(MY) S %KAT(4)="{"_ny_","_nx_"}" D
 .F f="FCL","COL","FTR","RTR","CMD" I $D(@(BSR_"(BST,f,ny,nx)"))=11 S %KAT(4,f)=@$ZR D
 ..I $D(@(BSR_"(BST,f,ny,nx,1)")) S %KAT(4,f,1)=@$ZR
 ..I $D(@(BSR_"(BST,f,ny,nx,2)")) S %KAT(4,f,2)=@$ZR
 .F f="FCL","COL","FTR","RTR","CMD" D
 ..S ff=$S(f="FCL":7,f="COL":13,f="FTR":8,f="RTR":16,f="CMD":14,1:999),nynx="0,0" I $P(@(BSR_"(BST,ny,nx)"),"@",ff)?.N1",".N S nynx=$P(@$ZR,"@",ff)
 ..I f="COL",$P(@(BSR_"(BST,ny,nx)"),"@",13)?.N1",".N,$D(@(BSR_"(BST,f,ny,nx,2)")) S %KAT(4,f,2)=@$ZR
 ..I $D(@(BSR_"(BST,f,"_nynx_")")) S %KAT(4,f)=@$ZR I $D(@(BSR_"(BST,f,"_nynx_",1)")) S %KAT(4,f,1)=@$ZR
 I $D(@(BSR_"(BST,""KEY"")")) S %KAT(5)=$P(@$ZR,"@") S i="" F  S i=$O(@(BSR_"(BST,""KEY"",i)")) Q:i=""  S %KAT(5,i)=$G(@(BSR_"(BST,""KEY"",i)")) S ii="" F  S ii=$O(@(BSR_"(BST,""KEY"",i,ii)")) Q:ii=""  S %KAT(5,i,ii)=$G(@(BSR_"(BST,""KEY"",i,ii)")) D
 .S iii="" F  S iii=$O(@BSR@(BST,"KEY",i,ii,iii)) Q:iii=""  S %KAT(5,i,ii,iii)=$G(@BSR@(BST,"KEY",i,ii,iii))
 I $D(@(BSR_"(BST,""Key"")")) S i="" F  S i=$O(@(BSR_"(BST,""Key"",i)")) Q:i=""  S %KAT(6,i)=$G(@(BSR_"(BST,""Key"",i)")) S ii="" F  S ii=$O(@(BSR_"(BST,""Key"",i,ii)")) Q:ii=""  S %KAT(6,i,ii)=$G(@(BSR_"(BST,""Key"",i,ii)")) D
 .S iii="" F  S iii=$O(@BSR@(BST,"Key",i,ii,iii)) Q:iii=""  S %KAT(6,i,ii,iii)=$G(@BSR@(BST,"Key",i,ii,iii))
 I $D(BSTABL) Q
 S IYI="^%ZAPM.bs.BSS,INFO" D NE^%ZAPM.bs.BSN K %KAT,f Q
KILBF ;УДАЛЕНИЕ СТАРЫХ БУФЕРОВ
 F f="S ff=$P(^(j),""@"",14)","S ff=$P($P(^(j),""@"",18),""#"",2)","S ff=$P($P(^(j),""@"",18),""#"")","COL","RTR","FTR","FCL","CMD" S BSr="^%ZAPM.bs.BSbufB",BSt="INF"_f_$G(%BS(3),$P)_$J_"u"_BSR_","_BST K @(BSr_"(BSt)")
 Q
LOS S I="LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1",IYI="^%ZAPM.bs.BSbufB,"_I D NE^%ZAPM.bs.BSN G 1^%ZAPM.bs.BSTM
DARK S Dark(1,1,2,2,1)=" 0 1",Dark(1,1,2,2,2)=" 0 1"
 S Dark(1,1,2,2,3)=" 0 1",Dark(1,1,4)=" 0 0 1 1",Dark(1,1,5)=" 0 1 0 1",Dark(1,1,6,3,1)=" 1 0",Dark(1,1,6,5)=" 0 1",Dark(1,1,8)=" 0 1",Dark(1,1,6,3,2)=" 1 0"
 Q
AF ;РЕДАКТИРОВАНИЕ БЛОК-МЕНЮ
 D SA^%ZAPM.bs.BSsBUF N oo,o1,o0,o2,o3,o4,o5,o6,o7,o8,o9
 I $E(O0,1)'="^" S ls=" МАССИВ БЛОК-МЕНЮ НЕ ГЛОБАЛЬНЫЙ " D O^%ZAPM.bs.BSF7 G AFE
 S BSr1="^%ZAPM.bs.BSS",BSt1="ALTF",BSr2="^%ZAPM.bs.BSbufB",BSt2="ALTF"_$G(%BS(3),$P)_$J_"u" D COPY^%ZAPM.bs.BSTK S $P(@(BSr2_"(BSt2)"),"@",6)=""
 S o3=$G(@(O0_")")),$P(@(BSr2_"(BSt2,1,2)"),"@",15)=$P(o3,O4,O6+1)
 S $P(@(BSr2_"(BSt2,2,2)"),"@",15)=$P(o3,"@",5)
 I $P(o3,"@",5)'="" S $P(@(BSr2_"(BSt2,3,2)"),"@",15)=$G(@(OOO_"("_$P(o3,"@",5)_","_O6_")"))
 S $P(@(BSr2_"(BSt2,4,2)"),"@",15)=$P(o3,"@",2)
 S $P(@(BSr2_"(BSt2,5,2)"),"@",15)=$P($P(o3,"@",8),";",O6)
 S $P(@(BSr2_"(BSt2,6,2)"),"@",15)=$P($P(o3,"@",7),";",O6)
 S $P(@(BSr2_"(BSt2,8,2)"),"@",15)=O0
 S $P(@(BSr2_"(BSt2,9,2)"),"@",15)=$O(@($P(OOO,"(")_"($C(1))"),-1)
 S $P(@(BSr2_"(BSt2,7,2)"),"@",15)=$P($P(o3,"@",6),";",O6),IYI=BSr2_","_BSt2 D NE^%ZAPM.bs.BSN
 G AFE:'$P(@(BSr2_"(BSt2)"),"@",6) S ls=" ЗАПИЩЕМ РЕЗУЛЬТАТЫ КОРРЕКЦИИ БЛОКА МЕНЮ ? " D YES^%ZAPM.bs.BSF G AFE:'YES
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSF6",O0=$P(^(BSt2,8,2),"@",15) F i1=1:1:8 S @("o"_i1)=$P(@(BSr2_"(BSt2,i1,2)"),"@",15)
 G AFE:o1=""!(o1[" ") S o0=$G(@(O0_")")),$P(o0,O4,O6+1)=o1,$P(o0,"@",5)=o2 I o2'="" S @(OOO_"("_o2_","_O6_")")=o3
 S $P(o0,"@",2)=o4,oo=$P(o0,"@",8),$P(oo,";",O6)=o5,$P(o0,"@",8)=oo
 S oo=$P(o0,"@",7),$P(oo,";",O6)=o6,$P(o0,"@",7)=oo
 S oo=$P(o0,"@",6),$P(oo,";",O6)=o7,$P(o0,"@",6)=oo
 S @(O0_")")=o0,$ZT=$G(%zT)
AFE D RE^%ZAPM.bs.BSsBUF Q
HISET() Q "^%ZAPM.bs.BSbufB(""HISCOMMAND"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")"
 Q
ERR S ls=" ОШИБКА "_$ZE D O^%ZAPM.bs.BSF7 G AFE
CMint S BSLOGIN=$G(%BS(12)),BSSES=$G(%BS(40)),CMint="N (BSLOGIN,BSSES) "
CM D LOCK^%ZAPM.bs.BSF4 N %BSenter
 D SA^%ZAPM.bs.BSsBUF,OP^%ZAPM.bs.BSF4,UCIS^%ZAPM.bs.BSF3,CMD,UCIR^%ZAPM.bs.BSF3,RE^%ZAPM.bs.BSsBUF,CL^%ZAPM.bs.BSF4,CLr^%ZAPM.bs.BSF4,CCC^%ZAPM.bs.BSC Q
CMD W $$atr^%ZAPM.bs.BS3(0),/ED(2) D SI^%ZAPM.bs.BSN N (%BS,vl,Tmp,CMint,BSLOGIN,BSSES) D SI^%ZAPM.bs.BSN G ERCMD
SHELL N ls,%HIS S %BSenter=1,ls="Область: <"_$$ZU^%ZAPM.bs.BS3(0)_"> Устройство="_$G(%BS(3),$P)_" ("_$P_") Задание="_$J_" Версия ("_$G(^%ZAPM.bs.BS)_")"
 S %HIS=$$HISET ;D Tex^%ZAPM.bs.BSMSMF("%BS-Cmd. Change Variable","")
 S Tmp=$$LineEdit^%ZAPM.bs.BSXfun("",ls,"","","^%ZAPM.bs.BSHLP(""ALT-F10"")",%HIS,"")
 I Tmp'="",$$Data^%ZAPM.bs.BSF12($NA(@$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""CMD"")")@(Tmp))),$G(^(Tmp,"S"))'="",$$DelHist^%ZAPM.bs.BSXuse(%HIS,1) Q
 Q
CMD1 S %zT=$ZT,$ZT="ERCMD^%ZAPM.bs.BSF6"
 F  D SHELL Q:Tmp="EXIT"!(Tmp="exit")!(Tmp=".")!(Tmp="1")!(YES=0)!(Tmp="Msw")  H:Tmp="2"  D:Tmp="DOS"!(Tmp="dos")!(Tmp="3") SSD^%ZAPM.bs.BSD2 D  X $G(CMint)_Tmp
   .D CLEAR
   .I Tmp'="" D
   ..I $E(Tmp)="?",Tmp'="?" D MSMHELP^%ZAPM.bs.BSDOS2($$BIGL^%ZAPM.bs.BSsFUNM($E(Tmp,2,999))) S Tmp="" Q
   ..I $$Data^%ZAPM.bs.BSF12($NA(@$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""CMD"")")@(Tmp))) S Tmp=$G(^(Tmp,"c")) I Tmp'="" Q
   ..I $D(^%ZAPM.bs.BScmd(Tmp)) S Tmp=$G(^(Tmp,"c")) Q
   .I $E(Tmp,1)="!" S Tmp="D EXE^%ZAPM.bs.BSDOS("_$C(34)_$E(Tmp,2,999)_$C(34)_",1)"
 S $ZT=$G(%zT)
 Q
CLEAR W $$atr^%ZAPM.bs.BS3(0),/CUP(1,1),/ED(2) D Echo^%ZAPM.bs.BSXfun(1) Q
LOCKTAB N  S uci=$$ZU^%ZAPM.bs.BS3(0) D MGR^%ZAPM.bs.BS,^LOCKTAB,%GU^%ZAPM.bs.BSF4 Q
ERCMD I $ZE["<NOSYS"!($ZE["<NAMESPACE") S CCMMDD="^%ZAPM.bs.BScmd"
 U 0 W ! W:$ZE'="" "Последняя Ошибка: ",$ZE,! W !,"Введите '?' для помощи по Командам и 'F1' - режимы строчного редактора",!
 S mtempXERROR=$G(mtempXERROR)+1 I mtempXERROR>5 W !,"Произошло зацикливание с ошибкой !!!" R *R H
 ;W !!,"1. Возвpат в %BS  введите : 'EXIT','.' или клавиша <Esc>",!!,"2. Выход в MSM  введите :'HALT'",!!,"3. Уйти в DOS  введите : 'DOS'",! 
 G CMD1
HELP S IYI="%BSS,CMD" D ENTER^%ZAPM.bs.BSN D CLEAR Q
DIR ;ВХОД В КАТАЛОГ %BS
 D SA^%ZAPM.bs.BSsBUF,UCIS^%ZAPM.bs.BSF3 D  D UCIR^%ZAPM.bs.BSF3,RE^%ZAPM.bs.BSsBUF Q
 .D ^%ZAPM.bs.BSD
F1 S l4=19,Xx=nx,Yy=ny,$P(@(BSR_"(BST,ny,nx)"),"@",19)=$P(@(BSR_"(BST)"),"@",39) D TAB2^%ZAPM.bs.BSF3 S l4=$P(@(BSR_"(BST,Yy,Xx)"),"@",19),$P(@$ZR,"@",19)="" D R^%ZAPM.bs.BSF4(39,l4) K l4,Xx,Yy Q
F1K S l4=20 D TAB2^%ZAPM.bs.BSF3 K l4 Q
F1KCOPY S l4=$P(BS,"@",20),do="S $P(^(j),""@"",20)=l4" D BLOK^%ZAPM.bs.BSF1 K l4 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF7" type="MAC" languagemode="0"><![CDATA[
%BSF7 ;ФУНКЦИИ %BS ; 14:22   05.03.2001
%BSUSER() ;ПЕРЕОПРЕДЕЛЕНИЕ ИМЕНИ ПОЛЬЗОВАТЕЛЯ
 S YES=1 D PPP^%ZAPM.bs.BS1 I '$D(%BS(12)) S YES=0 Q $C(0)
 I %BS(12)'="",$G(@%BS(18)@(%BS(12),0,"9,4"))'="" S %BS(37)=@$ZR
 Q %BS(12)
e ;
ENTERPAS(B) N i ;ОПРЕДЕЛЕНИЕ ПАРОЛЕЙ ТАБЛИЦЫ
 F i=2,4,5 K %w(i) S %w(i)=$P(B,"@",i) I %w(i)'="" D
 .I $G(%BS(12))="" K %w(i) Q
 .I $G(@%BS(18)@(".@PASSWORD",%BS(12)),"¤")=%w(i) Q
 .K %w(i)
 Q
 ;???? K KEYPAS S li=IMQ D TIR S:BSr'["^" BSr="^"_BSr I $G(@(BSr_"(BSt,""KEY"",key,6)"))["$KEYPAS(" S KEYPAS='$$KEYPAS^%ZAPM.bs.BSF7(BSD,.%KEYS)
CHECK(GL) N GL1 I $G(%BS(12))'="",$G(@%BS(18)@(".@PASSWORD",%BS(12)),"¤@")=@GL Q 1
 I $G(@GL)="" D L^%ZAPM.bs.BS3(GL) K @GL D U^%ZAPM.bs.BS3(GL) Q 1
 D PASCHECK^%ZAPM.bs.BS1(GL,"",1,"На Узел существует пароль ! Введите ","GL1") I '$D(GL1) Q 0
 Q 1
PASS(G,K) N GL,GL1 ;ПАРОЛИРОВАНИЕ УЗЛОВ БАЗЫ ДАННЫХ
 S G=$$BSD^%ZAPM.bs.BSA(G,$G(K(0))) I $D(K) F ii=1:1:key-1 Q:'$D(K(ii))  S G=G_$S(K(ii)'=+K(ii):$C(34)_K(ii)_$C(34),1:K(ii))_","
 S G=G_$S(d'=+d:$C(34)_d_$C(34),1:d)_","
 I $D(@(G_"""@PASSWORD"")")) S GL=$ZR D PASCHECK^%ZAPM.bs.BS1(GL,"",1,"На Узел '"_d_"' существует пароль ! Введите ","GL1") I '$D(GL1) Q
 S:'$D(GL) GL=$ZR S ls=" Будем вводить новый пароль на Узел '"_d_"'" D YES^%ZAPM.bs.BSF I 'YES Q
 D L^%ZAPM.bs.BS3(GL),PASSWORD^%ZAPM.bs.BSF4(GL,"",1,"Вводите пароль На Узел '"_d_"'","GL1"),U^%ZAPM.bs.BS3(GL) I '$D(GL1) Q
 Q
O I $G(%BS(13))="%BS-PC" d ErrMsg^%ZAPM.bs.BSXfun(ls) Q  ;СООБЩЕНИЕ ОБ ОШИБКЕ
OSH n x I $ZV'["Cach"&&($ZV'["IRIS") U $I:(0::::#10080)
 W $$bel^%ZAPM.bs.BS3,/CUP(23,1),$$clr^%ZAPM.bs.BS3($G(CoLoR,10)),$E(ls,1,153),$$atr^%ZAPM.bs.BS3(0),$J("",153-$L($E(ls,1,153)))
 W $$clr^%ZAPM.bs.BS3($G(CoLoR,10))," <Ok>",$$atr^%ZAPM.bs.BS3(0),$$rt^%ZAPM.bs.BS3(9999),/CUP(23,1) X "I 0" I R1=0,R2=140 D x^%ZAPM.bs.BS3("Ловушка...пользователя")
 W $$atr^%ZAPM.bs.BS3(0),/CUP(23,1),/EL(0),/CUP(24,1),/EL(0),/CUP(25,1),/EL(0)
 Q
CHNAME ;СМЕНА ИМЕНИ
 S ls=" ВАШЕ ТЕКУЩЕЕ ИМЯ :"_%BS(12)_" ,ХОТИТЕ РАБОТАТЬ ПОД ДРУГИМ ? " D YES^%ZAPM.bs.BSF
 I YES D OP^%ZAPM.bs.BSF4 S Me=%BS(12),MeCtO=$$%BSUSER D CL^%ZAPM.bs.BSF4 S %BS(12)=Me Q:MeCtO=$C(0)  S %BS(12)=MeCtO
 Q
AF ;ВЫЗОВ АНАЛИТИЧЕСКИХ ФОРМ
 N MeCtO,FLAG S FLAG=$E(%BS(1),11)
AFin S MeCtO=$$ZU^%ZAPM.bs.BS3(0) I $$ZU^%ZAPM.bs.BSF4("MOL","VOI") D  S uci=MeCtO D %GU^%ZAPM.bs.BSF4 I 'YES H
 .N MeCtO
 .S IYI=$S('FLAG:"^[""MOL"",""VOI""]ENTER,M0",1:"^[""MOL"",""VOI""]ENTER,L")
 .D NEB^%ZAPM.bs.BSN
 Q
DDR ;ВЫЗОВ DDR
 N MeCtO,FLAG S FLAG=$E(%BS(1),11)
DDRin S MeCtO=$$ZU^%ZAPM.bs.BS3(0) D MGR^%ZAPM.bs.BS
 S IYI=$S('FLAG:"^%ZAPM.bs.BSDDR,DDRM0",1:"^%ZAPM.bs.BSMDDR,Z") D  S uci=MeCtO D %GU^%ZAPM.bs.BSF4
 .N MeCtO,FLAG
 .D NEB^%ZAPM.bs.BSN
         I 'YES H
 Q
DDRint(FLAG) G DDRin
SAY N I,QQ S QQ=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""OWNER"")")
 W !,$G(@QQ@(1))," §",^%ZAPM.bs.BS F I=2:1 Q:'$D(@QQ@(I))  W !,@QQ@(I)
 Q
HIDON D R^%ZAPM.bs.BSF4(42,1) Q
HIDOFF D R^%ZAPM.bs.BSF4(42,"") Q
EdNumF S ls=" Вводите / Корректируйте Номер ПОЛЯ DBF",li=$P(@(BSR_"(BST,ny,nx)"),"@",6) D LE^%ZAPM.bs.BSTT I YES G:'YES EdNumF S $P(@(BSR_"(BST,ny,nx)"),"@",6)=li Q
 Q
CoNumF S li=$P(@(BSR_"(BST,ny,nx)"),"@",6),do="S $P(^(j),""@"",6)=li" D BLOK^%ZAPM.bs.BSF1
 Q
CtrDBF S YES=1 I '$D(@(BSR_"(BST,""DBF"")")) S YES=0 D ErrMsg^%ZAPM.bs.BSXfun("ДЛЯ ТАБЛИЦЫ ЕЩЁ НЕ ОПРЕДЕЛЕНА СТРУКТУРА DBF") Q
 Q
CtrNum S YES=1  I +$G(@(BSR_"(BST,""DBF"",4,1)"))<li G CtrNumEr
 I li<1 G CtrNumEr
 Q
CtrNumEr S YES=0 D ErrMsg^%ZAPM.bs.BSXfun("В СТРУКТУРЕ DBF "_$G(@$ZR)_" ПОЛЕЙ ! А ВЫ ВВОДИТЕ "_li_" ?") Q
ClearSpc(s) N i f i=$L(s):-1:0 q:$E(s,i)'=" "
 q $E(s,i>0,i)
WIND N x,y S ls=" Вводите / Корректируйте Размер Окна Коррекции Y,X ",li=$P(@(BSR_"(BST,ny,nx)"),"@",21)
WIN D LE^%ZAPM.bs.BSTT I YES D:li'="" CtlWIND G:'YES WIN D  Q
 .D Yes^%ZAPM.bs.BSXfun("В клетках ВСЕЙ таблицы ?",2) I YES D R^%ZAPM.bs.BSF4(26,li) Q
 .S $P(@(BSR_"(BST,ny,nx)"),"@",21)=li
CtlWIND S YES=1 I li="" Q
 S y=$P(li,","),x=$P(li,",",2) I (x*y)>500 D ErrMsg^%ZAPM.bs.BSXfun("ОЧЕНЬ БОЛЬШОЕ ОКНО") S YES=0 Q
 I (x*y)<1 D ErrMsg^%ZAPM.bs.BSXfun("ОЧЕНЬ МАЛЕНЬКОЕ ОКНО") S YES=0 Q
 I x>70&(x<5) D ErrMsg^%ZAPM.bs.BSXfun("НЕПРАВИЛЬНЫЙ ДИАПАЗОН ПО X (от 5 до 70)") S YES=0 Q
 I y>10&(x<2) D ErrMsg^%ZAPM.bs.BSXfun("НЕПРАВИЛЬНЫЙ ДИАПАЗОН ПО Y (от 2 до 10)") S YES=0 Q
 Q
BA S li=$$BigEdit^%ZAPM.bs.BSXuse(li,y1,x1,y2,x2,"@") K x,y,x1,x2,y1,y2 Q
BAR(y,x) S y1=($P(BS,"@")+1-BS1+BSY1(BS0)),y2=($P(BS,"@")-BS1+BSY1(BS0)+$P(BS,"@",3))
 ;~~~S y=+$P(BS,"@",21),x=$P($P(BS,"@",21),",",2)
 I (y+2)<y1 S y1=2,y2=y1+y-1 D BARX G BA
 I y<(24-y2) S y1=y2+2,y2=y1+y-1 D BARX G BA
 S y1=8,y2=y1+y D BARX G BA
BARX S x1=(79-x)\2,x2=x1+x Q
UPG ;ПОВЫШЕНИЕ ВЕРСИИ ТАБЛИЦЫ
 S Tab=$$DclTab^%ZAPM.bs.BSGFUN0("") Q:Tab=""
 S Glo=$$TranTab^%ZAPM.bs.BSGFUN0(Tab) Q:Glo=""  I $D(@Glo) D Yes^%ZAPM.bs.BSXfun("ТАБЛИЦА "_Tab_" УЖЕ СУЩЕСТВУЕТ ! ПЕРЗАПИСЫВАЕМ ?",2) Q:YES<1
 I $D(@(BSR_"(BST)")) S Tab=$ZR
 I Tab=Glo D ErrMsg^%ZAPM.bs.BSXfun(" ТЕКУЩУЮ НЕЛЬЗЯ !!!") Q
 D UpGraid^%ZAPM.bs.BSGFUN0(Tab,Glo) Q
%BSU() ;Имя базы данных пользователей %BS
 I $ZV["Cach"||($ZV["IRIS") Q "%BS(39)"
 N RAZ S RAZ=0
RAZ I $D(^%ZAPM.bs.BSS("USER","KEY")),$$Data^%ZAPM.bs.BSF12($NA(@$P(^%ZAPM.bs.BSS("USER","KEY"),"@"))) Q $ZR
 I $G(%BS(23)) S RAZ=RAZ+1 I RAZ<5 W $$bel^%ZAPM.bs.BS3,$$bel^%ZAPM.bs.BS3 H 1 G RAZ
 Q "^%ZAPM.bs.BSuDFLT"
 ;
ver() i $P($ZV,"Version ",2)'<4 Q "|" ;Полная ссылка в MSM 4.0
 Q "]"
]]></Routine>


<Routine name="%ZAPM.bs.BSF8" type="MAC" languagemode="0"><![CDATA[
%BSF8 ;ЭКРАН В ДОС,ПАНЕЛЬ,msmHistory,Copy-Merge...; 17:08  6-MAR-95 ; 14:19   14.09.99
Shift(R2) D SA^%ZAPM.bs.BSsBUF
 I $$Data^%ZAPM.bs.BSF12($$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSS(""CMD"")")),$D(@$ZR@("ShiftF"_(R2-83))),$D(@$ZR@("c")) X @$ZR G ShE
 I $D(^%ZAPM.bs.BScmd("ShiftF"_(R2-83))),$D(@$ZR@("c")) X @$ZR
ShE D RE^%ZAPM.bs.BSsBUF Q
AltKey I R3=-1 D
 .I R2=139,$E(%BS(1),4),'$E($G(%BS(14)),4) D WiL Q
 .I R2=140,$E(%BS(1),5),'$E($G(%BS(14)),4) D Trap Q
 .I R2=84 S IYI="^%ZAPM.bs.BSS(ShiftF1" D NE^%ZAPM.bs.BSN Q
 .I R2=88,$D(BSR),$D(BST) D BUFCOPY^%ZAPM.bs.BSF12 Q
 Q
TPr(BT) ;УСТАНОВКА ТИТУЛА ПО ТИТУЛУ ПЕЧАТИ
 N yt,xt S yt=+$P($P(@BT,"@",50),","),xt=+$P($P(@BT,"@",50),",",2) I yt,($P($G(@BT@(yt,xt)),"@")+$P($G(@BT@(yt,xt)),"@",3))'>20 S $P(@BT,"@",19)=yt_","_xt
 Q
Trap N R1,R2,R3,YES,li,lop,ls D x^%ZAPM.bs.BS3("Alt-F12") Q
WiL N Wi,i,ii,iii,%,%FN,%DEV,%DEVTYPE,%GO,%JB,Ox,Oy,R1,R2,R3,YES,li,lop,ls
 S %FN="%BSPRN.SCR"
 D SaveLock^%ZAPM.bs.BSsBUF("Wi",1,1,25,80)
 D SA^%ZAPM.bs.BSsBUF
 D DosOpn^%ZAPM.bs.BSBL1(54,%FN) Q:'$D(%FN)  U %DEV W "---------- Экран ... ",$TR($J("",58)," ","-"),"-",!
 F i=1:1 Q:'$D(Wi(i))  U %DEV W "|",$E($$Wi(Wi(i)),1,78),"|",!
 U %DEV W "-",$TR($J("",78)," ","-"),"-",!
 D CLO^%ZAPM.bs.BSS1,RE^%ZAPM.bs.BSsBUF Q
Wi(Wi) N iii,ii S iii="" F ii=1:2 Q:$E(Wi,ii)=""  S iii=iii_$E(Wi,ii)
 Q iii
 ;
MSMHIST ; ДОБАВЛЕНИЕ В HISTORY СТРОКУ ИЗ ТЕКСТА ДЛЯ MSM
 I $ZV["Cach"||($ZV["IRIS") D HIST^%ZAPM.bs.BSCp Q
 N uci,i,lHisT S lHisT=$E($G(LocS,@Bstr),Col,$$LNG^%ZAPM.bs.BSF12),uci=$$ZU^%ZAPM.bs.BS3(0) D MGR^%ZAPM.bs.BS
 S i=$O(^MSMSHIST($J,""),-1)+1,^MSMSHIST($J,i)=lHisT D %GU^%ZAPM.bs.BSF4 W $$bel^%ZAPM.bs.BS3
 D Say^%ZAPM.bs.BSXfun("В History MSM положена строка '"_lHisT_"'") Q
 ;
COPYCMD ;КОПИРОВАНИЕ ТАБ В БЛОК
 S l4=14
COPY S li=$P(@(BSR_"(BST,ny,nx)"),"@",l4),do="S $P(^(j),""@"",l4)=li" D BLOK^%ZAPM.bs.BSF1 K l4,li Q
 ;
TXTLOG ;ТЕКСТ ОБ ОШИБКЕ
 I ('$D(@BSR@(BST,"COL",ny,nx))!$P(@BSR@(BST,ny,nx),"@",13)="") D ErrMsg^%ZAPM.bs.BSXfun("СНАЧАЛО ВВЕДИТЕ ФОРМУЛУ ЛОГ.КОНТРОЛЯ") Q
 S li=$G(@BSR@(BST,"COL",ny,nx,2)),ll="{}",ls="Редактируйте Текст об ошибке в Формуле Логического Контроля" D LE^%ZAPM.bs.BSTT I 'YES Q
 I li="" K @BSR@(BST,"COL",ny,nx,2) D OkMsg^%ZAPM.bs.BSXfun("ТЕКСТ УДАЛЕН",1) Q
 S @BSR@(BST,"COL",ny,nx,2)=li Q
 ;
ErrSay(ZE) ;ВОЗВРАТ ТЕКСТА ОШИБКИ ПО КОДУ
 N S S S=$ZR I $ZV["Cach"||($ZV["IRIS") Q:$P(ZE,">")="" "" Q $G(^%ZAPM.bs.BSCGER($P(ZE,">")))_". $ZR="_S
 Q $G(^%ZAPM.bs.BSGER(+$P(ZE,":",4)))_". "_$G(^%ZAPM.bs.BSGER(+$P(ZE,":",4),+$P(ZE,":",5)))_". $ZR="_S
 ;
ButtPan ;СОЗДАНИЕ ПАНЕЛИ С КНОПКАМИ
 N i,j,M,P1,P2,GGG S ny=1,nx=1
 F i=ny:1 Q:$$DataCell(BSR,BST,i,nx)=""  S M(0,i)=$$DataCell(BSR,BST,i,nx) I $$ColrCell(BSR,BST,i,nx)'="" S M(0,i,1)=$$ColrCell(BSR,BST,i,nx)
 S j=0 F i=ny:1 Q:$$DataCell(BSR,BST,i,nx+1)=""  S j=j+1,M(1,i)=$$DataCell(BSR,BST,i,nx+1) D
 .I j=1,$$ColrCell(BSR,BST,i,nx+1)'="" S P1=$$ColrCell(BSR,BST,i,nx+1)
 .I j=2,$$ColrCell(BSR,BST,i,nx+1)'="" S P2=$$ColrCell(BSR,BST,i,nx+1)
 .I $$DataCell(BSR,BST,i,nx+2)'="" S M(4,j)=$$DataCell(BSR,BST,i,nx+2) ;DATA
 .I $$EntrCell(BSR,BST,i,nx+1)'="" S M(3,j)=$$EntrCell(BSR,BST,i,nx+1) ;DO
 .I $$LogCell(BSR,BST,i,nx+1)'="" S M(2)=j                             ;PRED
 .I $$DataCell(BSR,BST,i,nx+3)="GO" S M(5,j)=1                         ;GO
 S M(1)=$G(P1)_"/"_$G(P2),M=$P(@BSR@(BST),"@",1)_"/"_$P(@BSR@(BST),"@",31)
 S M(6,1)=$S($P(@BSR@(BST),"@",8)=1:0,1:$P(@BSR@(BST),"@",8)),M(6,2)=$S($P(@BSR@(BST),"@",9)=1:0,1:$P(@BSR@(BST),"@",9))
 S M(0)=$P(@BSR@(BST),"@",31) I $D(@BSR@(BST,"BUT")) S GGG=$ZR,ls="Заменяем старую панель ?" D YES^%ZAPM.bs.BSF I 'YES Q
 I '$D(GGG) S GGG=$ZR
 D Copy("M",GGG) S $P(@BSR@(BST),"@",17)=8
 Q
DoButt ;ВХОД В ТАБЛИЦУ-ПАНЕЛЬ С КНОПКАМИ
 I '$D(@BSR@(BST,"BUT"))
 D EnterP($ZR) I d<0 W $$bel^%ZAPM.bs.BS3 G GO^%ZAPM.bs.BST
 Q
Go W $$bel^%ZAPM.bs.BS3 S R1=27 Q
EnterP(GGG) N Bu,But
 I '$D(@GGG) S d=-5 G Go
 ;```I $G(%BS(14)) G TrmPanel
 s Bu=$G(@GGG@(2),1) ;ПРЕДУСТАНОВКА
EnteP S Mouse(1)=$G(Mouse),Mouse=2,d=$$TxtPanel^%ZAPM.bs.BSXfun1(GGG,$G(@GGG@(6,1),0),$G(@GGG@(6,2),0),Bu) S Mouse=$G(Mouse(1))
 I d=-4 G Go
 I d<0 G Go
 I YES=0 S R1=27 Q
 I $D(@GGG@(3,d)) S IYI=@$ZR D NEB^%ZAPM.bs.BSN I d'="",'$D(@GGG@(5,d)) S Bu=d G EnteP
 S R1=13,d=$G(@GGG@(4,$S(d="":0,1:d)),d)
 Q
TrmPanel ;ЭМУЛЯЦИЯ ПАНЕЛИ С КНОПКАМИ ДЛЯ ТЕРМИНАЛОВ
 N A,AA,T,TT,X,XXx,P,%B,ls,li,IYI
 S AA="" F A=1:1 Q:'$D(@GGG@(0,A))  S AA=AA_$$Cut^%ZAPM.bs.BSF10($$Cut^%ZAPM.bs.BSF10(@GGG@(0,A),0),1)_" "
 S TT=" " F T=1:1 Q:'$D(@GGG@(1,T))  S TT=TT_$TR($G(@GGG@(1,T))," ","_")_" "
 S P=$G(@GGG@(2)),AA=" "_AA_" "
TrmPa D MENU^%ZAPM.bs.BSF5(TT,$E(AA,1,79),P) I R1=0,R2=33 S d=-7 Q
 I YES<1 S R1=27 Q
 I '%B G Go
 S XXx=%B I $D(@GGG@(3,XXx)) S IYI=@$ZR D NEB^%ZAPM.bs.BSN I XXx'="",'$D(@GGG@(5,XXx)) S P=XXx G TrmPa
 S R1=13,d=$G(@GGG@(4,XXx),0)
 Q
DataCell(BSR,BST,i,j) Q $P($G(@BSR@(BST,i,j)),"@",15)
ColrCell(BSR,BST,i,j) Q $P($G(@BSR@(BST,i,j)),"@",10)
EntrCell(BSR,BST,i,j) Q $P($G(@BSR@(BST,i,j)),"@",14)
LogCell(BSR,BST,i,j) Q $P($G(@BSR@(BST,i,j)),"@",13)
 ;
Copy(TRe1,TRe2,NOKILLER,S)  ;Копирование Узла в ...  S=1 - Выводить счет узлов
 N j,jj,WA,WAI,R,r,Sec,TRe3,v ;NOKILLER=1   Неудалять Целевой узел
                            ;NOKILLER=""  УДАЛЯТЬ
                            ;!!!ЕСЛИ TRe1=Код СИМВОЛА ,КАКИМ ПЕРЕЗАПИСЫВАТЬ
                            ;      УДАЛЯЕМЫЕ ДАННЫЕ В УЗЛЕ TRe2
                            ;TRe2=Номер Устройства ВЫВОДА УЗЛОВ TRe1
 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSF8"
 S R="]",r=2 ;4.;I $P($ZV,"Version ",2)'<4 S R="|",r=3
 I TRe2?.N S TRe2=+TRe2
 I TRe2'?.N,TRe1'?.N,$G(NOKILLER)="" K @TRe2
 I $P($ZV,"Version ",2)'<4,TRe2'?.N,"1"'[$G(NOKILLER) M @TRe2=@TRe1 Q
 I TRe2'?.N D
 .I TRe1?.N S:$D(@TRe2)'["0" @TRe2=$TR($J("",$L(@TRe2))," ",$C(+TRe1)) Q
 .S:$D(@TRe1)'["0" @TRe2=@TRe1
 I TRe2?.N U TRe2 W:$D(@TRe1)'["0" TRe1,!,@TRe1,! Q:$ZC
 I $G(S)'="" U 0 D Wait^%ZAPM.bs.BSXfun($S(S=1:"Копируем "_TRe1_" в "_TRe2_"...",1:S))
 I TRe1?.N,TRe2'?.N S Sec=+TRe1,TRe1=TRe2
 S (j,TRe3)=TRe1 I $E(TRe1,$L(TRe1))=")" S TRe1=$E(TRe1,1,$L(TRe1)-1)
 S jj=$S(TRe1[R:$P(TRe1,R,r,99),1:$P(TRe1,"^",2,99))_$S(TRe1["(":",",1:"(")
 I TRe2?.N D  Q
 .F v=1:1 S j=$ZO(@j) Q:$S(j[R:$P(j,R,r,99),1:j)'[jj  U TRe2 W j,!,@j,! Q:$ZC  I '(v#50),$G(S)'="" U 0 X WA
 I $E(TRe2,$L(TRe2))=")" S TRe2=$E(TRe2,1,$L(TRe2)-1)
 I $G(Sec)'="" D  K:$G(NOKILLER)="" @TRe3 Q
 .F  S j=$ZO(@j) Q:$S(j[R:$P(j,R,r,99),1:j)'[jj  S @j=$TR($J("",$L(@j))," ",$C(Sec)) I $G(S)'="" U 0 X WA
 F  S j=$ZO(@j) Q:$S(j[R:$P(j,R,r,99),1:j)'[jj  S @(TRe2_$S(TRe2["(":",",1:"(")_$P(j,jj,2,9))=@j I $G(S)'="" U 0 X WA
 Q
ERFILE D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
VLY0 D R^%ZAPM.bs.BSF4(48,+$E($P(@(BSR_"(BST)"),"@",48),1)_"0") Q
VLY1 D R^%ZAPM.bs.BSF4(48,+$E($P(@(BSR_"(BST)"),"@",48),1)_"1") Q
VL1 D R^%ZAPM.bs.BSF4(48,"1"_+$E($P(@(BSR_"(BST)"),"@",48),2)) Q
VL0 D R^%ZAPM.bs.BSF4(48,"0"_+$E($P(@(BSR_"(BST)"),"@",48),2)) Q
UK0 D R^%ZAPM.bs.BSF4(43,"") Q
UK1 D R^%ZAPM.bs.BSF4(43,1) Q
KM0 D R^%ZAPM.bs.BSF4(49,"") Q
KM1 D R^%ZAPM.bs.BSF4(49,1) Q
TitPrO N li
TitPr S li=$P(@BSR@(BST),"@",50)
 S li=$$LineEdit^%ZAPM.bs.BSXfun(li,"ВВЕДИТЕ ТИТУЛ ДЛЯ ПЕЧАТИ (В ФОРМАТЕ:Y,X)") Q:YES<1  I li'="",li'?1N.N1","1N.N D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ФОРМАТА") G TitPr
 D R^%ZAPM.bs.BSF4(50,li) Q
PK0 D R^%ZAPM.bs.BSF4(45,1) Q
PK1 D R^%ZAPM.bs.BSF4(45,"") Q
AF0 D R^%ZAPM.bs.BSF4(47,"") Q
AF1 S li=$$LineEdit^%ZAPM.bs.BSXfun(2,"Проверять формат: 1= где ВЫЧ, 2= для СводокИсписков, 3=БД, 12= и то и то")
 D R^%ZAPM.bs.BSF4(47,li) Q
 ;
UKA ;ДВИЖЕНИЕ УКАЗАТЕЛЯ
Right I R3=67 S MR=0,M1=MX D WO^%ZAPM.bs.BSTM S MR=1 D  S MX=M1 Q
 .F  S M1=$O(BX(M1)) Q:M1=""  I $P($G(@BSR@(BST,BY(MY),BX(M1))),"@",5)="" Q
 .I M1="" F  S M1=$O(BX(M1)) Q:M1=MX  I $P($G(@BSR@(BST,BY(MY),BX(M1))),"@",5)="" Q
Lift I R3=68 S MR=0,M1=MX D WO^%ZAPM.bs.BSTM S MR=1 D  S MX=M1 Q
 .F  S M1=$O(BX(M1),-1) Q:M1=""  I $P($G(@BSR@(BST,BY(MY),BX(M1))),"@",5)="" Q
 .I M1="" F  S M1=$O(BX(M1),-1) Q:M1=MX  I $P($G(@BSR@(BST,BY(MY),BX(M1))),"@",5)="" Q
Down I R3=66 S MR=0,M1=MY D WO^%ZAPM.bs.BSTM S MR=1 D  S MY=M1 Q
 .F  S M1=$O(BY(M1)) Q:M1=""  I $P($G(@BSR@(BST,BY(M1),BX(MX))),"@",5)="" Q
 .I M1="" F  S M1=$O(BY(M1)) Q:M1=MY  I $P($G(@BSR@(BST,BY(M1),BX(MX))),"@",5)="" Q
Up I R3=65 S M1=MY,MR=0 D WO^%ZAPM.bs.BSTM S MR=1 D  S MY=M1 Q
 .F  S M1=$O(BY(M1),-1) Q:M1=""  I $P($G(@BSR@(BST,BY(M1),BX(MX))),"@",5)="" Q
 .I M1="" F  S M1=$O(BY(M1),-1) Q:M1=MY  I $P($G(@BSR@(BST,BY(M1),BX(MX))),"@",5)="" Q
 Q
TA K MxS,MyS,MsS S mx=MX,my=MY D  I $D(MsS) S MX=mx,MY=my K MxS,MyS,MsS,mx,my,Na Q
 .F  S MX=$O(BX(MX),Na) D:MX=""  Q:$D(MsS)  I $P($G(@(BSR_"(BST,"_BY(MY)_","_BX(MX)_")")),"@",5)="" S MyS=1 Q
 ..S MX=$O(BX(""),Na),MY=$O(BY(MY),Na) D:MY=""  Q:$D(MsS)
 ...I $D(MxS) S MsS=1 Q
 ...S MxS=1,MY=$O(BY(""),Na)
 I $D(MyS) K MxS,MyS,MsS,mx,my,Na Q
 Q
HO S MR=0,Na=1 D WO^%ZAPM.bs.BSTM,SET S MR=1 I $P($G(@BSR@(BST,BY(MY),BX(MX))),"@",5)="" Q
 G TA
EN S MR=0,Na=-1 D WO^%ZAPM.bs.BSTM,SET S MR=1 I $P($G(@BSR@(BST,BY(MY),BX(MX))),"@",5)="" Q
 G TA
SET S MX=$O(BX(""),Na),MY=$O(BY(""),Na) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSF9" type="MAC" languagemode="0"><![CDATA[
%BSF9 ;ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ; 17:24   27.12.1999
SecyKill(G) ;СЕКРЕТНОЕ УДАЛЕНИЕ УЗЛА МАССИВА
 N GG I $D(@G)'["0" S @G=$J("",$L(@G))
 S GG=G F  S GG=$ZO(@GG) Q
 Q
SORT ;СОРТИРОВКА ПО МНОГИМ КОЛОНКАМ
 D Yes^%ZAPM.bs.BSXfun("СОРТИРОВАТЬ ДАННЫЕ ПО-ВОЗРАСТАНИЮ ?",$S(+$P(Sort,",",3):2,1:1)) S $P(Sort,",",3)='YES
 D Yes^%ZAPM.bs.BSXfun("СОРТИРОВАТЬ ДАННЫЕ ТОЛЬКО ПО ОДНОЙ ТЕКУЩЕЙ КОЛОНКЕ",$S(+$P(Sort,",",4):2,1:1)) I YES S $P(Sort,",",4)="" Q
SO S li=$TR($P(Sort,",",4),"!",","),ls="ВВЕДИТЕ ЧЕРЕЗ ЗАПЯТУЮ НОМЕРА КОЛОНОК ПО КОТОРЫМ СОРТИРОВАТЬ" D LE^%ZAPM.bs.BSTT Q:'YES  Q:'+li  S $P(Sort,",",4)=$TR(li,",","!") Q
POST ;ПОСТДВИЖЕНИЕ
 N PO,M,Pr
 S PO=$P(@BSR@(BST),"@",44),Pr=$S(PO="":4,PO=0:3,1:PO)
 S M(0,1)="Определите движение указателя после",M(0,2)="редактирования данных клетки ,для текущей таблицы"
 S M(1,1)=" ВНИЗ ",M(1,2)=" ВПРАВО ",M(1,3)=" НЕТ ",M(1,4)=" ОБЩЕСИСТЕМНОЕ "
 S M="/"_$P(%BS,"!",8),M(0)=$P(%BS,"!",8),M(1)=$P(%BS,"!",8)_"/"_$P(%BS,"!",3)
 S %B=$$TxtPanel^%ZAPM.bs.BSXfun1("M",0,0,$G(Pr,1)) I YES=0 Q
 S POSt=$S(%B=4:"",%B=3:0,1:%B),$P(@BSR@(BST),"@",44)=POSt Q
PRED ;ПРЕДОБРАБОТКА КЛАВИШ
 S li=$P(@BSR@(BST),"@",41)
 S ls="Введите программу выполняемую по DO перед стандартной отработкой" D LE^%ZAPM.bs.BSTT I 'YES Q
 I li'="" S $ZT="PREDER^%ZAPM.bs.BSF9",(R1,R2,R3)=0 D Pred^%ZAPM.bs.BSF12(li)
 D R^%ZAPM.bs.BSF4(41,li) Q
PREDER D ErrMsg^%ZAPM.bs.BSXfun("Ошибка В ссылке на программу ! "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) G PRED
 ;
SelZ ;ПРЕДОБРАБОТКА КЛАВИШ (ЗАВИСИМАЯ) НУЖНА ТРАН - $$SelecBut^%ZAPM.bs.BSsFUNM(T)
 Q:R1>332
 I R1>31,R1<333,$D(Sel(0)),$D(Sel(ny,nx)) D
 .N N1,N2,N3,N4,N5,N6 S N1=ny,N2=nx,N3=MY,N4=MX
 .S MR=0,ny=$P($G(Sel(0),1),","),nx=$P($G(Sel(0),",1"),",",2),Sel(0)=(N1_","_N2)
 .S N5="" F  S N5=$O(BY(N5)) Q:N5=""  I BY(N5)=ny Q
 .S N6="" F  S N6=$O(BX(N6)) Q:N6=""  I BX(N6)=nx Q
 .I N5'=""&(N6'="") S MY=N5,MX=N6 D W^%ZAPM.bs.BSTM
 .S MR=1,ny=N1,nx=N2,MY=N3,MX=N4
 .S R1=-2
 I R1=13,R2=-1,R3=-1 S (d,d0,d1)=$G(Sel(+$P(Sel(0),","),+$P(Sel(0),",",2))),R1=-3 Q
 I R1=27,R2=-1,R3=-1 S (d0,d1,d)="",R1=-3 Q
 Q
ViewT ;СМОТРЕТЬ d1 У КЛЕТКИ
 Q:R1>332
 I R1=0,R2=18!(R2=31) D
 .S li=d1,$P(BS,"@",21)=(($L(d1)\60+1)_","_60) D BAR^%ZAPM.bs.BSF7 S R1=-2
 Q
B5 ;ВОССТАНОВЛЕНИЕ АТРИБ
 I '$D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),3)) D ErrMsg^%ZAPM.bs.BSXfun(" Буффер пуст !!!") Q
 S TRe1=$ZR,ls=" Ваша ТАБЛИЦА изменится до неузнаваемости ! Восстанавливаем АТРИБУТЫ КЛЕТОК ? " D YES^%ZAPM.bs.BSF I 'YES Q
 S do="D BATR^%ZAPM.bs.BSF9(i,j)" D BLOK^%ZAPM.bs.BSF1 E  Q
 S i="" F  S i=$O(@TRe1@(i)) Q:i=""  I 'i,"FTR$$r^%ZAPM.bs.BS3TR/COL/FCL/CMD/TSP/TSV/KEY"'[i D Copy^%ZAPM.bs.BSF8($NA(@TRe1@(i)),$NA(@BSR@(BST,i)))
 S BSr=BSR,BSt=BST D TRANS^%ZAPM.bs.BSS1
 G RESEND^%ZAPM.bs.BSF2
BATR(i,j) N l,h,d,c,f
 S l=$P(@$ZR,"@",4),h=$P(@$ZR,"@",3),d=$P(@$ZR,"@",15),c=$P(@$ZR,"@",10)
 Q:'$D(@TRe1@(i,j))  S @BSR@(BST,i,j)=@TRe1@(i,j),$P(@$ZR,"@",15)=d,$P(@$ZR,"@",3)=h,$P(@$ZR,"@",4)=l,$P(@$ZR,"@",10)=c
 F f="FTR","RTR","COL","FCL","CMD" I $D(@TRe1@(f,i,j)) D Copy^%ZAPM.bs.BSF8($NA(@TRe1@(f,i,j)),$NA(@BSR@(BST,f,i,j)))
 Q
PgUp S M1=$O(BY("")),s=BY(M1),t1=BSY(BS0),t=$P($G(%TIT,1),",") D  S BSY(BS0)=$S(i=t:t,1:i+1)
 .S h=0 F i=s:-1:t S h=h+$P(@(BSR_"(BST,i,1)"),"@",3) Q:h>(BSY2(BS0)-BSY1(BS0))
 Q:t1=BSY(BS0)  D VW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM Q
PgLt S M1=$O(BX("")),k=BX(M1),t=$P($G(%TIT,",1"),",",2),t1=BSX(BS0) D  S BSX(BS0)=$S(j=t:t,1:j+1)
 .S l=0 F j=k:-1:t S l=l+$P(@(BSR_"(BST,1,j)"),"@",4) Q:l>(BSX2(BS0)-BSX1(BS0))
 Q:t1=BSX(BS0)  D GW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM Q
PROTALL ;ХАРАКТЕРИСТИКИ В БЛОК
 I '$P($G(@BSR@(BST,ny,nx)),"@",12) D NEWDIR^%ZAPM.bs.BSD1 Q
 N PROTE,GLB,NAM
 S GLB=%NAM
 S PROTE=$$RP^%ZAPM.bs.BSGCH(GLB) I PROTE<1 W $$bel^%ZAPM.bs.BS3 Q
 D Yes^%ZAPM.bs.BSXfun("Всем помеченным Глобалам присвоить харрактеристики "_PROTE_" ! Вы уверены ?",2) Q:YES<1
 S do="I i>$S($E(BST)=""R"":2,1:1) S NAM=$P(^(j),""@"",15),NAM=$P(NAM,"" "",$S($E(NAM)=""^"":1,1:2)) D L^%ZAPM.bs.BS3(NAM) I LOC D CP^%ZAPM.bs.BSGCH(NAM,PROTE),U^%ZAPM.bs.BS3(NAM)" D BLOK^%ZAPM.bs.BSF1
 D NEWDIR^%ZAPM.bs.BSD1
 Q
ver(S) ;4.;i $P($ZV,"Version ",2)'<4 Q "|" ;Полная ссылка в MSM 4.0
 Q $S(S=1:"[",1:"]")
GLOBAL(R) ;ПОЛНАЯ ССЫЛКА
 N T,P    ;   ^[U,S]P,T --> ^[U,S]P(T)
 Q:$E(R,$L(R))=")" R  Q:R?.N1",".N R
 I R[$$ver(1),$P($P(R,$$ver(1),2),$$ver(2))["," S T=$P(R,",",3),P=$P(R,",",1,2) G GLOB
 I R[$$ver(1),$P($P(R,$$ver(1),2),$$ver(2))'["," S T=$P(R,",",2),P=$P(R,",",1) G GLOB
 E  S T=$P(R,",",2),P=$P(R,",")
GLOB S P=$$BSR^%ZAPM.bs.BSA(P)
 S T=$S(T=+T:T,1:$C(34)_T_$C(34)) Q (P_"("_T_")")
SYSFIX ;Перестроенные томов баз даных
 I $ZV["Cach"||($ZV["IRIS") Q
 I +Version<263,$P($ZV,"Version ",2)<4 D SysUpg
 I +Version<377 D PRN
 N A
AGAIN D  ;W !,"ВЫСТАВИТЬ ОПЦИЮ ФОРМИРОВАНИЯ ПОЛНОЙ ДАТЫ В ФОРМАТЕ (ГГГГММДД) [Y/N]" R A G:A="" AGAIN Q:"^N"[A  G:"Yy"'[A AGAIN
 .S A=$P(^%ZAPM.bs.BSETUP("SETUP",20,2),"@",15),$E(A,14)=1,$P(^%ZAPM.bs.BSETUP("SETUP",20,2),"@",15)=A
 .S A=$P(^%ZAPM.bs.BSS("SETUP",20,2),"@",15),$E(A,14)=1,$P(^%ZAPM.bs.BSS("SETUP",20,2),"@",15)=A
 ;W !,"ДЛЯ АВТОМАТИЧЕСКОЙ ПЕРЕСТРОКИ БАЗ ДАННЫХ ПОДДЕРЖИВАЮЩИХ 2000 ГОД ВЫПОЛНИТЕ",!,"КОМАНДУ >D Y2000K^%ZAPM.bs.BSF9",!
 ;D Y2000K
 Q
PRN ;Перестроенные томов PRN
 D CLr^%ZAPM.bs.BSF4,Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! У вас старая версия %BS ! Перенастраиваем во таблицах НОВЫЙ ФОРМАТ ОПЦИЙ ВЫВОДА  ?",1) Q:YES<1
 N i,I,II,III
 S DOX="X a1,a2",a1="I $D(@i@(iI,""PRN"")),$P(@$ZR,""#"")=3 S $P(@$ZR,""#"")=1,a3=a3+1"
 S a2="I $D(@i@(iI,""PRN"")),$P(@$ZR,""@"")=3 S $P(@$ZR,""@"")=1,a3=a3+1",a3=0
 D STA^%ZAPM.bs.BSF5 D OkMsg^%ZAPM.bs.BSXfun("ПРОИЗОШЛО "_a3_" ЗАМЕН")
 D OkMsg^%ZAPM.bs.BSXfun("Для нормальной работы смонтируйте ещё не Перестроенные тома баз дааных и введите команду >D PRN^%ZAPM.bs.BSF9") Q
SysUpg ;Перестроенные тома баз даных для работы в DDP
 D CLr^%ZAPM.bs.BSF4,Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! У вас старая версия %BS ! Перенастраиваем ВСЕ разделы ВСЕХ томов под работу в DDP ?",1) Q:YES<1
 N i,I,II,III
 S DOX="I i'[""^%ZAPM.bs.BS"" D PartU^%ZAPM.bs.BSF9($NA(@i@(iI)))" D STA^%ZAPM.bs.BSF5
 D OkMsg^%ZAPM.bs.BSXfun("Для нормальной работы в DDP, смонтируйте ещё не Перестроенные тома баз дааных и введите команду >D SysUpg^%ZAPM.bs.BSF9") Q
PartU(P) D Wait^%ZAPM.bs.BSXfun("Перенастраиваем:"_P)
 I $P(@P,"@",39)'="" S $P(@P,"@",39)=$$GLOBAL($P(@P,"@",39))
 S II="" F  S II=$O(@P@(II)) Q:'II  S III="" F  S III=$O(@P@(II,III)) Q:III=""  D  X WA
 .I $P(@P@(II,III),"@",14)'="" S $P(@P@(II,III),"@",14)=$$GLOBAL($P(@P@(II,III),"@",14))
 .I $P(@P@(II,III),"@",20)'="" S $P(@P@(II,III),"@",20)=$$GLOBAL($P(@P@(II,III),"@",20))
 Q
RGDOUT ;ВЫВОД ПРОГРАММ И МАССИВОВ КАЖДОГО КИПА
 D ^%SDEV I '$G(%DEV) Q
 S DOUCI="I $ZU(0)'=""MGR,MSW"" D RGDO^%ZAPM.bs.BSF9 I 0"
 D STA^%ZAPM.bs.BSF5
 Q
RGDO U %DEV D  U 0 Q
 .N  D ^%RD,^%GD
Y2000K ;Перестроение баз даных
 D CLr^%ZAPM.bs.BSF4,Yes^%ZAPM.bs.BSXfun("У ВАС ЕСТЬ ПРОБЛЕМЫ 2000 ГОДА ? Перенастраиваем ВСЕ разделы ВСЕХ томов ? (РЕКОМЕНДУЮ ПРЕДВАРИТЕЛЬНО СДЕЛАТЬ КОПИЮ)",1) Q:YES<1
 N i,I,II,III
 S DOX="I i'[""^%ZAPM.bs.BS"" D Y2TAB^%ZAPM.bs.BSTABY2($NA(@i@(iI)),iI)"
 S DOBD="D BD^%ZAPM.bs.BSTABY2($NA(@i))"
 D STA^%ZAPM.bs.BSF5 D OkMsg^%ZAPM.bs.BSXfun("Для РЕШЕНИЯ ПРОБЛЕМ 2000 ГОДА, смонтируйте ещё не Перестроенные тома баз дааных и введите команду >D Y2000K^%ZAPM.bs.BSF9")
 Q
MMAIN ;СОЗДАНИЕ ГЛАВНОГО МЕНЮ
 N li,i,I,II,M1,M2,M3,M4,M5,MMb,i,iI
 S li=$$LineEdit^%ZAPM.bs.BSXfun("??","ВВЕДИТЕ УЗЕЛ ГЛАВНОГО МЕНЮ ") Q:YES<1  Q:li=""
 S MMb=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""MainMenu"")"),MMb=$NA(@MMb@(li))
 I $D(@MMb) D Yes^%ZAPM.bs.BSXfun("УЖЕ СУЩЕСТВУЕТ УЗЕЛ"_$ZR_" ! УДАЛЯЕМ ?") I YES=1 K @MMb
 S DOUCI="S M1=$P($ZU(0),"","",2) I 1"
 S DOX="S M2="" ""_$P($ZU(0),"","",1)_"" ""_i_"" ""_$TR($P(@i,""@"",2),$C(34),""`""),M4=""*"",M3="" ""_iI_"" ... ;""_$$TIP^%ZAPM.bs.BS($P(@i@(iI),""@"",17))_""; ""_$TR($P(@i@(iI),""@"",1),$C(34),""`""),@MMb@(M1,M2,M3,M4,""USPT"")=$$MMS^%ZAPM.bs.BSF9(i,iI),@MMb@(M1,M2,M3,M4,""NS"")=$$MMNS^%ZAPM.bs.BSF9()"
 D STA^%ZAPM.bs.BSF5
 D OkMsg^%ZAPM.bs.BSXfun("РЕЗУЛЬТАТЫ БУДУТ В ^%ZAPM.bs.BSVOL(""MainMenu"")")
 Q
MMNS() I $$ZU^%ZAPM.bs.BS3(0)=$$ZU^%ZAPM.bs.BS3(1,0) Q 0
 Q $P($$ZU^%ZAPM.bs.BS3(0),",")_","_$P($$ZU^%ZAPM.bs.BS3(0),",",2)
MMS(i,iI) I i["^%" Q $NA(@i@(iI))
 Q $NA(@("^["""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(i,"^",2))@(iI))
BSrBSt(IMQ) ;ФОРМИРОВАНИЕ  BSr BSt
 I IMQ'["(" S BSr=$P(IMQ,",",1,$L(IMQ,",")-1),BSt=$P(IMQ,",",$L(IMQ,",")) Q
 I IMQ["("  S BSr=$P(IMQ,"("),BSt=$P($P(IMQ,"(",2),")") Q
 Q
XGlob(U,X,S) ;X=Действие с Узлом @g S=1 - Выводить счет узлов
 N j,jj,WA,WAI,R,r,g,Head,STOP ;Head - голова узла
 S R="]",r=2,Head=U ;4.;I $P($ZV,"Version ",2)'<4 S R="|",r=3
 I $D(@U)'["0" s g=U X X
 I $G(S) U 0 D Wait^%ZAPM.bs.BSXfun("Действие с "_U)
 S j=U I $E(U,$L(U))=")" S U=$E(U,1,$L(U)-1)
 S jj=$S(U[R:$P(U,R,r,99),1:$P(U,"^",2,99))_$S(U["(":",",1:"(")
 F  S j=$ZO(@j) Q:$S(j[R:$P(j,R,r,99),1:j)'[jj  S g=j X X Q:$D(STOP)  I $G(S) U 0 X WA
 Q
Statis(U,T,N,S) ;Статистика Узла U    S=1 - Выводить счет узлов
 ;T - цель результата  N=0 - имена массивов
 ;                     N=1 - полные ссылки узлов массивов
 N X S X="D Stati",N=+$G(N) D XGlob(U,X,+$G(S)) Q
Stati Q:@g'["^"  N S,SS,i,ii S S=@g F i=1:1 Q:$P(S,"^",i)=""  S SS=$P($P(S,"^",i),"@") D
 .I 'N D  Q
 ..S SS=$P(SS,"(")
 ..D Stat
 .D Stat
 Q
Stat S @T@(SS)=$G(@T@(SS))+1 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSFF" type="MAC" languagemode="0"><![CDATA[
%BSFF ; пpогpамма ГОРЯЧИХ ФУНКЦИЙ ; 13:25   27.07.2000
 Q
TODAY() Q $$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3)
]]></Routine>


<Routine name="%ZAPM.bs.BSFT" type="MAC" languagemode="0"><![CDATA[
%BSFT ;CТАРАЯ ТРАНСЛЯЦИЯ ФОРМУЛ ; 13:13   16.07.99
 S (li1,i0)=li,ft=1 ;li-ИСХОДНЫЙ ТЕКСТ li1-ОТТРАНСЛИРОВАННЫЙ ТЕКСТ
 I i0["$$TSP" S ft=2 G TSP ;СПИСОК
 I i0["$$TSV" S ft=3 G TSV ;СВОДКА
 S %zT=$ZT,$ZT="ERRO^%ZAPM.bs.BSFT"
 I i0["$$" D FUN ;->i0
 D AAA
 S (d3,d,d0,d1)=1,li1=$S(f="COL":"I ",1:"S d1=")_li1 X li1 S ^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),5)=li1,$ZT=$G(%zT),YES=1 Q
AAA F i=2:1 Q:i0'["{"  S i0=$P(i0,"{")_"$$A^%ZAPM.bs.BSA("_$P(i0,"{",2,9999)
 S i0=$TR(i0,"}",")"),li1=i0 Q
FUN ;ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ
 S i1=i0,YES=1 F  Q:i1'["$$"  S i5=$P($P(i1,"$$",2,255),"(") D  Q:'YES
 .I '$D(@("^%ZAPM.bs.BSFUN(i5)")) S YES=1 D  Q  //S ls=" ФУНКЦИЯ "_i5_" НЕ ОПРЕДЕЛЕНА В %BS !!! ЭТО ВАША ФУНКЦИЯ ? " D YES^%ZAPM.bs.BSF D  Q
 ..I YES S i1=$P(i1,"$$")_"||"_$P(i1,"$$",2,9999) Q
 .I i5["TS" S i1=$P(i1,"$$")_"||"_$P(i1,"$$",2,9999) Q
 .S pr=$G(^%ZAPM.bs.BSFUN(i5,"9,4"))_"!"_$G(^%ZAPM.bs.BSFUN(i5,"11,4")),i2=$P($P(i1,"$$",2,9999),"(",2,9999)
 .;I ^%ZAPM.bs.BS("FUN")[i5 D F
 .I $G(^%ZAPM.bs.BSFUN(i5,"7,4"))=1 D F
 .S i2=$P($P(i1,"$$",2,9999),"(",2,9999)
 .S i1=$P(i1,"$$")_"||"_$P(pr,"!",2)_"("_$P($P(i1,"$$",2,9999),"(",2,9999) Q
 S (li1,i0)=$TR(i1,"|","$") K i1,i2,i3,i4,i5,i6,i7,ii1,ii2,ii3,ii4 Q
TSP ;СПИСКОВЫЕ ФУНКЦИИ
 G:f'="FCL" OTL I TIP=3 G TS
 I TIP>1 S ls=" ВАША ТАБЛИЦА УЖЕ НЕ МОЖЕТ БЫТЬ СПИСКОМ " G OTLUP
 I TIP<2 S ls=" Вы хотите что-бы ваша таблица:"_BSR_","_BST_" стала списком ? Вы уверены " D YES^%ZAPM.bs.BSF I 'YES S ls=" ОТМЕНА " G OTLUP
 S $P(@(BSR_"(BST)"),"@",17)=3,TIP=3 G TS
TSV ;СВОДКОВЫЕ ФУНКЦИИ
 G:f'="FCL" OTL I TIP=4 G TS
 I TIP>1 S ls=" ВАША ТАБЛИЦА УЖЕ НЕ МОЖЕТ БЫТЬ СВОДКОЙ " G OTLUP
 I TIP<2 S ls=" Вы хотите что-бы ваша таблица стала сводкой ? Вы уверены ? " D YES^%ZAPM.bs.BSF I 'YES S ls=" ОТМЕНА " G OTLUP
 S $P(@(BSR_"(BST)"),"@",17)=4,TIP=4
TS S i1=i0,YES=1,i6=$P(i1,"$$",2,255),i5=$P(i6,"(") I '$D(@("^%ZAPM.bs.BSFUN(i5)")) S ls=" ФУНКЦИЯ "_i5_" НЕ ОПРЕДЕЛЕНА !!!" D O^%ZAPM.bs.BSF7 S YES=0 Q
 S:i6["$$TS" i6=$P($P(i6,"$$TS"),")",1,$L($P(i6,"$$TS"),")")-1)_")" S %zT=$ZT,$ZT="ERRO^%ZAPM.bs.BSFT",li1="S YES=$$"_i5_"^%ZAPM.bs.BSsFUNR("_$P(i6,"(",2,999) I li1[",," F  Q:li1'[",,"  S li1=$P(li1,",,")_$C(44,34,44)_$P(li1,",,",2,999)
 X li1 S $ZT=$G(%zT),li1=i0 Q
ERRO I $ZE["<MXSTR" S ls=" ДЛИНА СТРОКИ ПОСЛЕ ТРАНСЛЯЦИИ БОЛЬШЕ ДОПУСТИМОЙ " G ERR
 I $ZE["PARM>"!($ZE["<FUN") S ls=" ОШИБКА В ПАРАМЕТРАХ ФУНКЦИИ ИЛИ НЕВЕРНЫЙ АДРЕС КЛЕТКИ " ;G ERR
 S ls=" ОШИБКА "_$E($ZE,1,21) D O^%ZAPM.bs.BSF7 S ls=$G(li1,"???")
ERR D O^%ZAPM.bs.BSF7 S YES=0,li1="" Q
OTL S ls=" ФОРМУЛЫ $$TS* РАЗРЕШЕНЫ ТОЛЬКО В ФОРМУЛАХ ВЫЧИСЛЕНИЯ ! "
OTLUP D O^%ZAPM.bs.BSF7 S (ft,li,li1)="" Q
F ;ЗАМЕНА "{}" НА "Її" ДЛЯ ФУНКЦИИЙ ТИПА SUM,MAX,MIN,PLU...
 S i4=1 F i3=1:1:$L(i2) Q:$E(i2,i3)=""  S:$E(i2,i3)="(" i4=i4+1 S:$E(i2,i3)=")" i4=i4-1 Q:$E(i2,i3)=")"&(i4=0)
 S p0="FU("_$E(i2,1,i3) D @p0 I $D(p44) S i3=i3-$L(p44)-1-$L(p44,$C(34))
 S i1=$P(i1,"$$")_"$$"_$P($P(i1,"$$",2),"(")_"("_$TR($E(i2,1,i3),"{}","")_$E(i2,i3+1,9999) Q
FU(p1,p2,p3,p4) I $D(p4) S p44=p4
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSFTF" type="MAC" languagemode="0"><![CDATA[
%BSFTF ;БЫСТРАЯ ТРАНСЛЯЦИЯ ФОРМУЛ ; 15:24  4-DEC-97
 ;li-ИСХОДНЫЙ ТЕКСТ
 ;li1-ОТТРАНСЛИРОВАННЫЙ ТЕКСТ
 ;f-тип ФУНКЦИИ f="FCL"-Calc ;f="FTR"-Tran ;f="COL"-Logs ;f="RTR" Read
 ;ft - ПАРАМЕТР ИСПОЛНЯЕМОСТИ ФУНКЦИИ =1 ДА   ВСЁ ОСТАЛЬНОЕ - НЕТ
 N i0,i,d3,d,d0,d1,l
 S (li1,i0)=li,ft=1
 I i0["$$FCl" S ft=4 D TST(9,"БЫСТРЫМ СПИСКОМ") Q  ;БЫСТРЫЙ НАСЧЕТ
 I i0["$$FCs" S ft=5 D TST(10,"БЫСТРОЙ СВОДКОЙ") Q  ;БЫСТРЫЙ НАСЧЕТ
 I i0["$$TSP" S ft=2 G TSP^%ZAPM.bs.BSFT ;D TST(3,"СПИСКОМ") Q
 I i0["$$TSV" S ft=3 G TSV^%ZAPM.bs.BSFT ;D TST(4,"СВОДКОЙ") Q
 S %zT=$ZT,$ZT="ERRO^%ZAPM.bs.BSFTF"
 S YES=0,li1=$$FunTrans(i0,f)
 S (d3,d,d0,d1)=1 X li1 S ^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),5)=li1,$ZT=$G(%zT),YES=1 Q
FunTrans(li,f) N i
 I li["$$" S i="" F  S i=$O(^%ZAPM.bs.BSFUN(i)) Q:i=""  I $D(^%ZAPM.bs.BSFUN(i,"11,4")) S l="$$"_i_"(",li=$$TR^%ZAPM.bs.BSsFUNM(li,l,"$$"_@$ZR_"(")
 I li["{" D
 .S li=$$TR^%ZAPM.bs.BSsFUNM(li,"{{","$$A^%ZAPM.bs.BSA("),li=$$TR^%ZAPM.bs.BSsFUNM(li,"}}",")")
 .S li=$$TR^%ZAPM.bs.BSsFUNM(li,$C(34)_"{",$C(0,1)),li=$$TR^%ZAPM.bs.BSsFUNM(li,"}"_$C(34),$C(2,3))
 .S li=$$TR^%ZAPM.bs.BSsFUNM(li,"{","$$A^%ZAPM.bs.BSA("),li=$$TR^%ZAPM.bs.BSsFUNM(li,"}",")")
 .S li=$$TR^%ZAPM.bs.BSsFUNM(li,$C(0,1),$C(34)_"{"),li=$$TR^%ZAPM.bs.BSsFUNM(li,$C(2,3),"}"_$C(34))
 Q $S(f="COL":"I "_li,1:"S d1="_li)
TST(TI,S) G:f'="FCL" OTL I TIP=TI G TS
 I TIP>1 S ls=" ВАША ТАБЛИЦА УЖЕ НЕ МОЖЕТ БЫТЬ "_S G OTLUP
 I TIP<2 S ls=" Вы хотите что-бы ваша таблица стала "_S_" ? Вы уверены ? " D YES^%ZAPM.bs.BSF I 'YES S ls=" ОТМЕНА " G OTLUP
 S TIP=TI
TS S $P(@BSR@(BST),"@",17)=TIP
 S %zT=$ZT,$ZT="ERRO^%ZAPM.bs.BSFTF",li1=li I li1["$$" S i="" F  S i=$O(^%ZAPM.bs.BSFUN(i)) Q:i=""  I $D(^%ZAPM.bs.BSFUN(i,"11,4")) S l="$$"_i_"(",li1=$$TR^%ZAPM.bs.BSsFUNM(li1,l,"$$"_@$ZR_"(")
 S li1="S YES="_li1
 X li1 S $ZT=$G(%zT),li1=li Q
ERRO S ls="" I $ZE["<MXSTR" S ls=" ДЛИНА СТРОКИ ПОСЛЕ ТРАНСЛЯЦИИ БОЛЬШЕ ДОПУСТИМОЙ "
 I $ZE["PARM>"!($ZE["<FUN") S ls=" ОШИБКА В ПАРАМЕТРАХ ФУНКЦИИ ИЛИ НЕВЕРНЫЙ АДРЕС КЛЕТКИ "
 I $ZE["LINER>" S ls=" ОШИБКА В ИМЕНИ ФУНКЦИИ "
 S ls=ls_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 S ls=$G(li1,"???")
ERR D O^%ZAPM.bs.BSF7 S YES=0,li1="" Q
OTL S ls="СПИСКОВЫЕ И СВОДКОВЫЕ ФУНКЦИИ РАЗРЕШЕНЫ ТОЛЬКО В ФОРМУЛАХ ВЫЧИСЛЕНИЯ !"
OTLUP D O^%ZAPM.bs.BSF7 S (ft,li,li1)="" Q
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSGCH" type="MAC" languagemode="0"><![CDATA[
%BSGCH ;ХАРАКТЕРИСТИКИ РАЗДЕЛОВ ; 17:54   23.12.1999
 ;COPYRIGHT MICRONETICS DESIGN CORP @1990 & %BS 1.1 @1993
 N %JB,II,Ox,Oy,R1,R2,R3,ls,uci,PPPP
 N %GBL,%,%ANS,%BLK,%DIV,%DN,%DR,%DT,%EF,%GBN,%HLP,%I,%MF,%NB,%PC,%PT,%QF,%QST,%QUE,%RSP,%RSPHLD,%T,%X,CLASS,GN,PRO,PROTECT,KEY,%OF,XEM,%F,%MAX,%UI,%USZ,%UT,CC,I,K,OF,TFL,TYP,UC,XE
 N %DB,%GNUM,%GSN,%MGR,%NAM,%PR,%ST,%UCI,%USTS,COL,NEW,SEQ,%GVN,VG,MM,MMM,OO,OOO,VGI,VGVOL,FBLK,%a,%PTRS,%VGI,%VGN,%VGPTR,%VGPTR1,%VGSLOT
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) S Erro=-7 G EXIT
 S %zT=$ZT,$ZT="ERROR^%ZAPM.bs.BSGCH" S ls="" i $P($ZV,"Version ",2)'<4 G 0^%ZAPM.bs.BSGCH4 ;MSM 4.0
 I '$D(%GLB) S Erro=-1 G EXIT
 O 63::0 I '$T S ls="View Buffer busy.. Please retry later",Erro=-3 G EXIT
 D GETVG^%VGUTIL S %MGR=($$ZU^%ZAPM.bs.BS3($P($$ZU^%ZAPM.bs.BS3(0),","),$P($$ZU^%ZAPM.bs.BS3(0),",",2))="1,0")
%GLOBAL S %UCI="",%VGN=$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 I %GLB=""!(%GLB="^")!(%GLB="^Q") S Erro=-1 G EXIT
 S %QF=0,%EF=0
 S:%GLB?1"^".E %GLB=$E(%GLB,2,99)
 I %GLB["[" S %UCI=$P(%GLB,"]"),%GLB=$P(%GLB,"]",2)
%CHECK I %UCI["""" F %I=1:1:$L(%UCI) I $E(%UCI,%I)="""" S $E(%UCI,%I)="",%I=%I-1
 I %UCI'="",%UCI'?1"["3U1","3U,%UCI'?1"["3U S ls="НЕПРАВИЛЬНОЕ ИМЯ КИПА В ССЫЛКЕ МАССИВЕ",Erro=-2 G EXIT
 I %UCI'="" S:$L(%UCI)<5 %UCI=%UCI_","_%VGN ;S %GLB="["""_$P(%UCI,"[",2)_"""]"_$P(%GLB,"]",2)
 I %UCI'="" S %VGN=$P(%UCI,",",2) S %UCI=$E(%UCI,2,4) S %UI=$$ZU^%ZAPM.bs.BS3(%UCI,%VGN) I %UI<1  S ls="НЕСУЩЕСТВУЮЩЕЕ ИМЯ КИПА",Erro=-2 G EXIT
 I (%UCI'="")&('%MGR) S ls="Cross UCI is notation not available from non manager UCI",Erro=-2 G EXIT
 S %UI=$S(%UCI'="":+%UI,1:$V(2,$J,2)#32),(%VGI,VGI)=VG(%VGN),%VGSLOT="G"_%VGI D GETVOL^%VGUTIL
 I '(%GLB?1"%".AN!(%GLB?1A.AN)) S ls="НЕПРАВИЛЬНОЕ ИМЯ МАССИВА",Erro=-1 G EXIT
 I $L(%GLB)>8 S ls=" Global name must be 8 characters or less ",Erro=-1 G EXIT
 S %PTRS=$V($V(44)+8,-3,2),%USZ=$V($V(44)+14,-3,2),%VGPTR=$V(40+%PTRS+$V(44)),%VGPTR1=$V(%VGI*4+%VGPTR),%UT=%UI-1*32+$V(%VGPTR1+20)
UCINUM ;
 S %GBN=$V(%UT+4,-3,4),GN=%GLB,%GLB=%GLB_$C(0)
%GDBLK V %GBN:%VGSLOT S OF=$V(1022,0),TYP=1,TFL=$E($V(1021,0,1,3))
 S K="" K KEY S I=$S(TYP=1&TFL&($V(0,0,4)=0):13,1:0)
 F I=I:0:OF-1 S CC=$V(I,0,1),UC=$V(I+1,0,1),K=$E(K,1,CC)_$V(I+2,0,UC,1),KEY(I)=K,I=I+UC+2+$S(TYP=8:$V(I,0,1)+1,TYP=1&TFL:11,1:3)
 S %F=0,%X=-1
%GDENT S %X=$N(KEY(%X)) I %X'<0 G:$S(TFL:%GLB]KEY(%X),1:KEY(%X)]%GLB) %GDENT  S:%GLB=KEY(%X) %F=1
 I 'TFL,'%F S %GBN=$V(%X+2+$V(%X+1,0,1),0,3) G %GDBLK
 I TFL,'%F S %GBN=$ZB($V(1012,0,4),#FFFFFF,1) G:%GBN>0 %GDBLK
 I '%F&%EF S ls="МАССИВ НЕ НАЙДЕН В КИПЕ!!, ВОЙДИТЕ СИСТЕМНЫЙ КИП",Erro=-4 G EXIT
 I '%F S ls=" МАССИВ НЕ РАСПРЕДЕЛЁН ",Erro=-4 G EXIT
%GDENT1 S %HLP=2
 S %OF=%X+2+$V(%X+1,0,1)+4
 S %USTS=(($V(%OF,0,1)#4)=3)
 G %PRO
ERROR ;
 I $F($ZE,"<INRPT>") U 0 S ls="...Aborted." D O^%ZAPM.bs.BSF7 V 0:$J:$ZB($V(0,$J,2),#0400,7):2
 S $ZT=$G(%zT) ZQ
EXIT ;
 I $D(^ZZZZZZZZ)!($D(^UTILITY)) ; FLUSHES LOCAL COPY OF CHANGED GLOBAL
 C 63 S ls=$G(ls) I '$D(ReadProt),ls'="" D O^%ZAPM.bs.BSF7
 K %GBL,%,%ANS,%BLK,%DIV,%DN,%DR,%DT,%EF,%GBN,%HLP,%I,%MF,%NB,%PC,%PT,%QF,%QST,%QUE,%RSP,%RSPHLD,%T,%X,CLASS,GN,PRO,PROTECT,KEY,%OF,XEM,%F,%MAX,%UI,%USZ,%UT,CC,I,K,OF,TFL,TYP,UC,XE I $D(PPPP) S R1=27
 K %DB,%GNUM,%GSN,%MGR,%NAM,%PR,%ST,%UCI,%USTS,COL,NEW,SEQ,%GVN,VG,MM,MMM,OO,OOO,VGI,VGVOL,FBLK,%a,%PTRS,%VGI,%VGN,%VGPTR,%VGPTR1,%VGSLOT
 K PPPP S $ZT=$G(%zT) I $D(ReadProt) Q:$D(Erro) Erro Q ReadProt
 Q
%PRO I ('%MGR)&('%USTS) S ls="Protection access denied to ^"_GN,Erro=-5 G EXIT
 D %LST I $D(ReadProt) C 63 Q ReadProt
 S PROTECT=$V(%OF,0,1),ls="" G:$D(INTERNAL) %CLA S MM=$P($P(MMM(1,1)," ",%B+1),"=",2)
 G EXIT:R1=27 S %OPT=%B,MMM(1,1)=" NONE READ R\W R\W\D @6@ @0@3@",MMM(3,1)=" ЗАПРЕТ ДОСТУПА",%B=$S(MM["NO":1,MM["RE":2,MM="R\W":3,1:4)
 S MMM(3,2)=" ТОЛЬКО ЧТЕНИЕ ",MMM(3,3)=" ЧТЕНИЕ И ЗАПИСЬ ",MMM(3,4)=" ЧТЕНИЕ ЗАПИСЬ И УДАЛЕНИЕ "
 K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G:R1=27 %PRO I %B=1 S PPPP=1
%CLA S PRO=$S(%B=1:0,%B=2:1,%B=3:2,%B=4:3,1:4)
%CLASS1 F %I=1:1 S XE=$P(%OPT,",",%I) Q:XE=""  S %PT(XE)=PRO
%UPDT S PROTECT=0,%DIV=256
 F %X=1:1:4 S %DIV=%DIV\4,PROTECT=PROTECT+(2*%DIV*(%PT(%X)\2)+(%DIV*(%PT(%X)#2)))
 V %OF:0:PROTECT:1
 V -%GBN:%VGSLOT
 S FGBN="^"_$S(%UCI="":"",1:"["""_%UCI_$S(%VGN="":"",1:""","""_%VGN)_"""]")_GN
 S BKN=$ZBN(@FGBN)
 I +$P($ZV,"Version ",2)>2.2 S OK=$ZMSM(5,BKN) ;INVALIDATE NAKED GLOBALS
 K FGBN,BKN,OK
%AGAIN G %PRO:'$D(INTERNAL),EXIT
%LST S %DIV=256,MMM(1,1)=" ",MM=" "_%GLB_" ВЫБЕРИТЕ КЛАСС ПОЛЬЗОВАТЕЛЕЙ ДЛЯ МОДИФИКАЦИИ ЗАШИТЫ "
 F %X=1:1:4 S %DIV=%DIV\4,%PC=$V(%OF,0,1)\%DIV#4,%PT(%X)=%PC S MMM(1,1)=MMM(1,1)_$P("System,World,Group,User",",",%X)_"="_$P("NONE,READ,R\W,RWD",",",%PC+1)_" " I $D(ReadProt) S ReadProt=ReadProt_(%PC+1)
 Q:$D(ReadProt)
 S MMM(3,1)="Доступ пользователей системного КИПа к Глобалам системного Кипа",MMM(3,2)="Доступ пользователей из других систем к Глобалам вашей системы по DDP"
 S MMM(3,3)="Доступ пользователей из несистемных КИПов к Глобалам других Кипов",MMM(3,4)="Доступ пользователей из несистемных КИПов к Глобалам своего Кипа"
 S MMM(1,1)=MMM(1,1)_"@6@ @0@3@",OO=1,OOO="MMM" K %JB Q:$D(INTERNAL)  D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF Q
 ;
RP(%GLB) ;СМОТРЕТЬ ХАРАКТЕРИСТИКИ
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q "-7"
 N ReadProt,Erro S ReadProt="" G %BSGCH
 ;
CP(%GLB,Prot) ;ИЗМЕНИТЬ ХАРАКТЕРИСТИКИ
 ;%GLB=ИМЯ МАССИВА   Prot="SYSTEM/WORLD/GROUP/USER=NONE/READ/RW/RWD"
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 N Erro F %OPT=1:1:4 S %B=$E(Prot,%OPT) D:%B In(%GLB,%OPT,%B) Q:$D(Erro)
 C 63 Q
 ;
In(%GLB,%OPT,%B) ;%GLB-ИМЯ МАССИВА     %OPT=1/2/3/4 -- SYSTEM/WORLD/GROUP/USER
INT N INTERNAL   ;                     %B=1/2/3/4 -- NONE/READ/RW/RWD
 I %GLB[",",$$ZU^%ZAPM.bs.BS3(0)=$TR($P(%GLB,"]"),"^["_$C(34),"") S %GLB="^"_$P(%GLB,"]",2)
 S %B=$G(%B,4),%OPT=$G(%OPT,4),%GLB=$G(%GLB) I %B<1!(%B>4)!(%OPT<1)!(%OPT>4) W /BEL Q
 S INTERNAL=1 G %BSGCH
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSGCH4" type="MAC" languagemode="0"><![CDATA[
%BSGCH4 ;MSW MODIFICATION %GCH ; 17:54   23.12.1999 ;  7:17 11-FEB-97
 Q
0 N PPPP,Mouse,%GTEMP,%TPTR
 S $ZT="ERROR^%ZAPM.bs.BSGCH4"
 O 63::0 I '$T S ls="View Buffer busy.. Please retry later",Erro=-3 G EXIT
 D GETVG^%VGUTIL S %MGR=($V(2,$J,2)=1)
%GLOBAL Q:'$D(%GLB)
 S %GSEL=1 S:%GLB?1"^".E %GLB=$E(%GLB,2,99)
 I %GLB["]"&(%GLB'[",") S %GLB=$$TR^%ZAPM.bs.BSsFUNM(%GLB,"]",","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]")
 S:%GLB[($C(34)_",") %GLB=$$TR^%ZAPM.bs.BSsFUNM(%GLB,$C(34)_","_$C(34),",")
 I %GLB=""!(%GLB="^")!(%GLB="^Q") S Erro=-1 G EXIT
 U 63:(:::"P"),0
 D FIND
 U 63:(:::"C"),0
 G EXIT:%QF D %PRO
EXIT ;
 C 63 S ls=$G(ls) I '$D(ReadProt),ls'="" D O^%ZAPM.bs.BSF7
 K %JB,II,Ox,Oy,R1,R2,R3,ls,uci,OO,OOO,MM,MMM
 K %ANS,%BLK,%DIV,%DN,%DR,%DT,%EF,%GBN,%GLB,%GN,%HLP,%I,%MF,%NB,%OPT,%PC,%PT,%QF,%QST,%QUE,%RSP,%RSPHLD,%T,%VGN,%X,BTMLEVEL,CLASS,FBLK,GN,PRO,KEY,%OF,%F,%MAX,%UI,CC,I,K,OF,UC,VGI,VGVOL
 K %ACCESS,%B,%COLLSEQ,%COUNT,%DB,%GNUM,%GSN,%JOURNAL,%MGR,%NAM,%PR,%PROT,%PROTECT,%UCI,%NEW,%GVN,VG,%GSEL,%W,%DD
 K PPPP S $ZT=$G(%zT) I $D(ReadProt) Q:$D(Erro) Erro Q ReadProt
 Q
ERROR ;
 S ls=$ZE I $F($ZE,"<INRPT>") U 63:(:::"C"),0 C 63 W /BEL D EXIT V 0:$J:$ZB($V(0,$J,2),#0400,7):2
 C 63 ZQ
FIND ; Find directory block and patch offset for the global
 ; Returns with %GBN (gdir blk containing the global) in the VIEW buffer
 ;  %OF=offset of protection byte, %ACCESS=1 if user has access
 ;  %TPTR=top pointer block
 S %QF=0,%EF=0
 I %GLB["["!(%GLB["|") D  Q:%QF
 .S %UCI=$E(%GLB,3,5),%VGN=$E(%GLB,7,9),%GLB=$E(%GLB,12,$L(%GLB))
 .S %UI=+$$ZU^%ZAPM.bs.BS3(%UCI,%VGN)
 .I '%UI S ls="Global is not on a mounted volume group ["_%UCI_","_%VGN_"]",Erro=-4 S %QF=1
 E  S %UCI="",%VGN=$P($$ZU^%ZAPM.bs.BS3(0),",",2),%UI=+$$ZU^%ZAPM.bs.BS3("")
 S VGI=VG(%VGN) D  Q:%QF
 .N (%QF,VGI,%GSEL,%GN) D VGINFO^%VGUTIL2(VGI)
 .I VGRVG S %QF=1 S ls="%GCH not allowed on Remote Volume Group",Erro=-4 Q
 D GETVOL^%VGUTIL
 S GN=%GLB,%GLB=%GLB_$C(0)
FIND1 ;
 S %GBN=$$GDIR^%VGUTIL2(VGI,%UI),%TPTR=0
FIND2 ;
 I '%GBN S %F=0 G FIND35
 V %GBN:"G"_VGI S OF=$V(1022,0,2),BTMLEVEL=$V(1021,0,1)\128
 S K="" K KEY
 S I=$S(BTMLEVEL&($V(0,0,4)=0):13,1:0) ; 1st btm gdir starts at 13
 F I=I:0:OF-1 S CC=$V(I,0,1),UC=$V(I+1,0,1),K=$E(K,1,CC)_$V(I+2,0,UC,1),KEY(I)=K,I=I+UC+2+$S(BTMLEVEL:11,1:3)
 S %F=0,%X=-1
FIND3 S %X=$N(KEY(%X)) I %X'<0 G:$S(BTMLEVEL:%GLB]KEY(%X),1:KEY(%X)]%GLB) FIND3  S:%GLB=KEY(%X) %F=1
 I 'BTMLEVEL,'%F S %GBN=$V(%X+2+$V(%X+1,0,1),0,3) G FIND2
 I BTMLEVEL,'%F S %GBN=$ZB($V(1012,0,4),#FFFFFF,1) G:%GBN>0 FIND2
FIND35 ;
 I '%F,%EF S ls="Global "_%GN_" has been deleted...skipped.",Erro=0 S %QF=1 Q
 I '%F S ls="^"_GN_"  does not exist.. ",Erro=-4
 I %F DO  Q
 .S %OF=%X+2+$V(%X+1,0,1)+4,%EF=1
 .S %ACCESS=(($V(%OF,0,1)#4)=3),%TPTR=$V(%OF-4,0,3)
 .Q:%MGR!%ACCESS  ; honor protection and always give MGR access
 .S ls="Access denied to ^"_GN,Erro=-5 S %QF=1
 .Q
 U 63:(:::"C"),0
FIND4 ; Global does not exist in gdir
 S ls=" Global "_%GLB_" does not exist in gdir",Erro=-4
 S %QF=1 Q:%QF
 ;
%PRO ; Modify protection byte
 S (%PROT,%PROTECT)=$V(%OF,0,1)
 D %LST I $D(ReadProt) Q
 S ls="" G:$D(INTERNAL) %CLA S MM=$P($P(MMM(1,1)," ",%B+1),"=",2)
 G EXIT:R1=27 S %OPT=%B,MMM(1,1)=" NONE READ R\W R\W\D @6@ @0@3@",MMM(3,1)=" ЗАПРЕТ ДОСТУПА",%B=$S(MM["NO":1,MM["RE":2,MM="R\W":3,1:4)
 S MMM(3,2)=" ТОЛЬКО ЧТЕНИЕ ",MMM(3,3)=" ЧТЕНИЕ И ЗАПИСЬ ",MMM(3,4)=" ЧТЕНИЕ ЗАПИСЬ И УДАЛЕНИЕ "
 K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G:R1=27 %PRO I %B=1 S PPPP=1
%CLA S PRO=$S(%B=1:0,%B=2:1,%B=3:2,%B=4:3,1:4)
%CLASS1 F %I=1:1 S %X=$P(%OPT,",",%I) Q:%X=""  S %PT(%X)=PRO
%UPDT S %PROT=0,%DIV=256
 F %X=1:1:4 S %DIV=%DIV\4,%PROT=%PROT+(2*%DIV*(%PT(%X)\2)+(%DIV*(%PT(%X)#2)))
 U 63:(:::"P"),0
 D FIND1 I %QF U 63:(:::"C"),0 Q
 V %OF:0:%PROT:1 V -%GBN:"G"_VGI
 U 63:(:::"C"),0
 I $G(%TPTR),$ZMSM(5,%TPTR) ; invalidate top ptr blk in all nakeds
%AGAIN G %PRO:'$D(INTERNAL),EXIT
 Q
%LST S %DIV=256,MMM(1,1)=" ",MM=" "_%GLB_" ВЫБЕРИТЕ КЛАСС ПОЛЬЗОВАТЕЛЕЙ ДЛЯ МОДИФИКАЦИИ ЗАШИТЫ "
 F %X=1:1:4 S %DIV=%DIV\4,%PC=%PROT\%DIV#4,%PT(%X)=%PC S MMM(1,1)=MMM(1,1)_$P("System,World,Group,User",",",%X)_"="_$P("NONE,READ,R\W,RWD",",",%PC+1)_" " I $D(ReadProt) S ReadProt=ReadProt_(%PC+1)
 Q:$D(ReadProt)
 S MMM(3,1)="Доступ пользователей системного КИПа к Глобалам системного Кипа",MMM(3,2)="Доступ пользователей из других систем к Глобалам вашей системы по DDP"
 S MMM(3,3)="Доступ пользователей из несистемных КИПов к Глобалам других Кипов",MMM(3,4)="Доступ пользователей из несистемных КИПов к Глобалам своего Кипа"
 S MMM(1,1)=MMM(1,1)_"@6@ @0@3@",OO=1,OOO="MMM" K %JB Q:$D(INTERNAL)  D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF Q
]]></Routine>


<Routine name="%ZAPM.bs.BSGLOB" type="MAC" languagemode="0"><![CDATA[
%BSGLOB ;РАБОТА С ГЛОБАЛЬНЫМ СПИСКОМ ОБ"ЕКТОВ ; 16:53   12.12.1999
 I '$D(^%ZAPM.bs.BSbufB("ALINS"_$G(%BS(3),$P)_$J_"u")) S ls=" НЕТ СПИСКА МИКРОЗАПРОСОВ !  ДЛЯ ВКЛЮЧЕНИЯ В СПИСОК ВВЕДИТЕ <ALT-Insert> В ТАБЛИЦЕ ОПИСЫВАЮЩЕЙ МИКРОЗАПРОСЫ" D O^%ZAPM.bs.BSF7 Q
 S g1=BSR,g2=BST,g3=se,g4=ke,BST="ALINS"_$G(%BS(3),$P)_$J_"u",BSR="^%ZAPM.bs.BSbufB" D DEND^%ZAPM.bs.BSF2,REND^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1 S IYI=BSR_","_BST,BSR=g1,BST=g2,se=g3,ke=g4 D NE^%ZAPM.bs.BSN
 D Yes^%ZAPM.bs.BSXfun("Удаляем ВРЕМЕННУЮ ТАБЛИЦУ ?") Q:YES<1  D DEL^%ZAPM.bs.BSF10($NA(^%ZAPM.bs.BSbufB("ALINS"_$G(%BS(3),$P)_$J_"u")),1)
 Q
I(g1,g2,g3,g4,g5) N Gl,F1,F2 ;ПОМЕТКА <ALT-INSERT>
 N F1,F2,j,ii,i
 I g2=("ALINS"_$G(%BS(3),$P)_$J_"u") W /BEL Q
 I BSR["%BSbufB",$E(BST,1,2)="TZ" D PACKETZ(BSrz,BStz,$P(d," ",2)) Q
 I BSR["%BSbufB",$E(BST,1,2)="1k",$D(BSD),$P($P(BSD,"(",2),",",2)["ZPr" D PACKETZ($P(BSD,"("),$TR($P($P(BSD,"(",2),","),$C(34),""),d) Q
 I nx=2 S F2=g5,F1=$P($G(@BSR@(BST,ny,1)),"@",15)
 I nx=1 S F1=g5,F2=$P($G(@BSR@(BST,ny,2)),"@",15)
 I F2'["k" W /BEL G ESC
 I '$D(^%ZAPM.bs.BSbufB("ALINS"_$G(%BS(3),$P)_$J_"u")) S ii=$ZR,@ii=^%ZAPM.bs.BSS("ALINS"),i=2 D  G II
 .F j=1:1 Q:'$D(^%ZAPM.bs.BSS("ALINS",1,j))  S ^%ZAPM.bs.BSbufB("ALINS"_$G(%BS(3),$P)_$J_"u",1,j)=^%ZAPM.bs.BSS("ALINS",1,j) I "34"[j S $P(@$ZR,"@",4)=""
 S ii=$ZR,i=$P(@ii,"@",28)+1
II F j=1:1 Q:'$D(^%ZAPM.bs.BSS("ALINS",2,j))  S ^%ZAPM.bs.BSbufB("ALINS"_$G(%BS(3),$P)_$J_"u",i,j)=^%ZAPM.bs.BSS("ALINS",2,j),$P(@$ZR,"@",15)=$G(@("F"_j))
 S $P(@ii,"@",28)=i Q
ESC S R1=27,R2=-1,R3=-1 Q
PACKETZ(Pr,Tb,Zp) ;ДОБАВИТЬ ЗАПРОС В ПАКЕТ
 N PA,NZ
 D SA^%ZAPM.bs.BSsBUF
 S PA=$$UZEL^%ZAPM.bs.BSVOL("PACKET","^%ZAPM.bs.BSVOL","",""," В КАКОЙ ПАКЕТ ВСТАВЛЯТЬ ЗАПРОС "_Zp_". НОВЫЙ МОЖНО ВВЕСТИ")
 D RE^%ZAPM.bs.BSsBUF Q:PA=""  S NZ=$O(@PA@(""),-1),NZ=NZ+1
 S @PA@(NZ,"N")=Zp,@PA@(NZ,"PT")=$NA(@Pr@(Tb)),@PA@(NZ,"K")=$G(@Pr@(Tb,"ZPr",Zp,"^","K"))
 S @PA@(NZ,"ST")=1 ;СТАТУС
 ;S @PA@(NZ,"BP")=1 ;СТАТУС
 G ESC
Ksp ;ВЫБОРОЧНОЕ
 ;I '$D(Ksp) S li="",ls="ВВЕДИТЕ ДВЕ ЦИФРЫ КСП ,ЗА КОТОРОЕ ИНФОРМАЦИЮ ОСТАВИТЬ" D LE^%ZAPM.bs.BSTT S:YES Ksp=li I 'YES S END=1 Q
 ;S Ksp1=$E($P($P(g,",",2),")"),1,2)
 ;I Ksp1'="",Ksp1'=Ksp,Ksp1=+Ksp1 K @g
 W /BEL
 Q
KBD ;УБИЙЦА БАЗ ДАННЫХ
 N i,I,II,III,BD,DOPART,DOBD,VOL,k,k1,k2,k3,k4,k5,key,st,f1
 D CLr^%ZAPM.bs.BSF4 D VOl Q:'$D(VOl)
 D Yes^%ZAPM.bs.BSXfun("ОСТАВИТЬ ИНФОРМАЦИЮ ПО КАКОМУ-ТО КЛЮЧУ, УВЕРЕНЫ ?",1) I YES>0 S st=0 D  I st=1 Q
 .S ls="Давайте номер ключа для выборочного сохранения",li=1 D LE^%ZAPM.bs.BSS I li<1!(li>9) S st=1 Q
 .S key=li,ls="Вводите ФОРМУЛУ для IF (Значение ключа в key),(например:$E(k2,1,2)=21)",li="" D LE^%ZAPM.bs.BSS I li'["k" S st=1 Q
 .S f1=li Q
 Q:$G(st)=1  D Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! Сейчас начнётся ТОТАЛЬНОЕ УДАЛЕНИЕ БАЗ ДАННЫХ в "_VOl_" ! УВЕРЕНЫ ?",1) Q:YES<1
 S DOBD=DOPART_" I i'[""^%ZAPM.bs.BS""&(i'[""^BS"") D KILLBD^%ZAPM.bs.BSGLOB(i)" K DOPART D STA^%ZAPM.bs.BSF5
 D OkMsg^%ZAPM.bs.BSXfun("УБИТЫ ВСЕ...") Q
KILLBD(BD) I '$D(st),$D(@BD)=11 K @BD Q
 S BD1=BD F  S BD1=$ZO(@BD1) Q:BD1=""  S @("k"_key)=$QS(BD1,key) D
 .Q:@("k"_key)=""  X "I "_f1 E  K @BD1
 Q
VOl ;ВЫБОР ТОМА
 K VOl S li="",ls="УКАЖИТЕ ТРАНСЛИРУЕМЫЙ ТОМ или КИП,ТОМ" D LE^%ZAPM.bs.BSTT Q:'YES  Q:li=""  S VOl=li
 I $L(VOl)=3 S DOPART="I $P($$ZU^%ZAPM.bs.BS3(0),"","",2)=VOl" G VO
 I $L(VOl)=7 S DOPART="I $$ZU^%ZAPM.bs.BS3(0)=VOl" G VO
 E  W /BEL K VOl,DOPART
VO Q
TranGlob ;ГЛОБАЛЬНАЯ ТРАНСЛЯЦИЯ
 N SS,SZ,VOl,TRA,i,DOPART
 D VOl Q:'$D(VOl)
 S li="",ls="УКАЖИТЕ ССЫЛКУ - КИП,ТОМ   КОТОРУЮ ТРАНСЛИРОВАТЬ !!!" D LE^%ZAPM.bs.BSTT Q:'YES  S SS=li
 S li="",ls="УКАЖИТЕ ССЫЛКУ - КИП,ТОМ  НА КАКУЮ ЗАМЕЩАТЬ !!!" D LE^%ZAPM.bs.BSTT Q:'YES  S SZ=li
 S DOPART=DOPART_",i'[""^%ZAPM.bs.BS"",i'[""^BS"" D Tran^%ZAPM.bs.BSGLOB(i)"
 S TRA(0)="",TRA(0,1)=$P(SS,","),TRA(0,2)=$P(SS,",",2),i=0
 D SETT^%ZAPM.bs.BSZRAP,SETTRA^%ZAPM.bs.BSZRAP(SZ)
 D Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! Сейчас начнётся Трансляция массивов "_VOl_" ! УВЕРЕНЫ ?",1) Q:YES<1
 D STA^%ZAPM.bs.BSF5
 D OkMsg^%ZAPM.bs.BSXfun("...ВСЁ...") Q
Tran(II) N ii
 I $D(@II)'["0" D TRA^%ZAPM.bs.BSZRAP(II)
 F ii=1:1 S II=$ZO(@II) Q:II=""  D TRA^%ZAPM.bs.BSZRAP(II) I '(ii#50) U 0 X WA
 Q
Diag ;ДИАГНОСТИКА ТОМА
 N ii,i,DOPART,VOl,BSr,BSt,II,III,iii,IIII,TI
 D VOl Q:'$D(VOl)
 D Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! Сейчас начнётся ДИАГНОСТИКА разделов на ссылки "_VOl_" ! УВЕРЕНЫ ?",1) Q:YES<1
 S DOPART=DOPART_" D Dia^%ZAPM.bs.BSGLOB(i)",BSt="DiagPart"_$G(%BS(3),$P),BSr="^%ZAPM.bs.BSbufB"
 D MGR^%ZAPM.bs.BS,DiaK,STA^%ZAPM.bs.BSF5,Diagn
 I '$D(se) D OkMsg^%ZAPM.bs.BSXfun("ССЫЛКИ ОТСУТСТВУЮТ...") Q
 S Coment="Диагностика "_VOl D CREATE^%ZAPM.bs.BSTT
DiaK K ^%ZAPM.bs.BSbufB("DiagPart"),^%ZAPM.bs.BSbufB("DiagPart"_$G(%BS(3),$P)) Q
Dia(II) S TI=99 F ii=1:1 S II=$ZO(@II) Q:II=""  S:$L(II,",")=1 TI=$P($G(@II),"@",17) D:@II["]"&("56"'[TI)  I '(ii#50) U 0 X WA
 .S III=@II F iii=1:1 Q:$P(III,"]",iii)'["["  D
 ..S IIII=$TR($P($P(III,"]",iii),"[",2),",""",".") S IIII=$S(IIII="":"?="_II,1:IIII)
 ..S ^%ZAPM.bs.BSbufB("DiagPart",$TR($$ZU^%ZAPM.bs.BS3(0),",","."),$P(II,"("),IIII)=$G(^%ZAPM.bs.BSbufB("DiagPart",$TR($$ZU^%ZAPM.bs.BS3(0),",","."),$P(II,"("),IIII))+1
 Q
Diagn S II="^%ZAPM.bs.BSbufB(""DiagPart"")" F ii=1:1 S II=$ZO(@II) Q:II'["^%ZAPM.bs.BSbufB(""DiagPart"""  D  I '(ii#50) U 0 X WA
 .S t0=" в Томе "_$TR($P(II,",",2),".",",")_" Разделе "_$P(II,",",3)_" ссылка "_$TR($P($P(II,",",4),")"),".",",")_" встречается "_@II_" раз" D CR^%ZAPM.bs.BSTT
 Q
TipMass(i) 
 I $P($G(@i),"@")="BSD - MSW" Q 3 ;БАЗЫ
 I $P($G(@i),"@")["%BS-invert-" Q 2
 I $P($G(@i),"@")="BaSe MsW " Q 1 ;РАЗДЕЛЫ %BS
 Q 0
]]></Routine>


<Routine name="%ZAPM.bs.BSH" type="MAC" languagemode="0"><![CDATA[
%BSH ;РЕКОНФИГУРАЦИЯ MSM и :%BS,РАБОТА с HFS ; 16:17   01.04.2001
 Q
CONF I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 D MGR^%ZAPM.bs.BS I $P($ZV,"Version ",2)<4,'$D(^ ("SGDDBNS")) W !!," В системе нет оптционального пакета NAMESPACE ! ",*7 S STOPBS=1 Q
 N MODIF X "ZL %GR S:$T(ASK+4)'[""Overw"" MODIF=1 ZL %BSH" I $G(MODIF) D
 .W !!!,"Модификация системмных и библиотечных утилит "
 .I $P($ZV,"Version ",2)<4 D  ;ДЛЯ 3
 ..S DB="ZL DBMAINT3 X:$T(HNAME)=""HNAME ;"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""HNAME""):HNAME ZR HNAME ZS DBMAINT3" X DB
 ..S DB="ZL %SP X:$T(INT)'[""%SPDBNA"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""INT^%SP""):INT ZR INT ZS %SP" X DB
 ..S DB="ZL DBMAINT3 X:$T(ADDV)="""" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""HADDV""):VGSLOT ZS DBMAINT3" X DB
 ..S DB="ZL %GSEL X:$T(GS1)'[""%BS"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""%GSEL""):GS1 ZR GS1 ZS %GSEL" X DB
 .I $P($ZV,"Version ",2)'<4 D  ;ДЛЯ 4
 ..S DB="ZL DBMAINT8 X:$T(HNAME)=""HNAME ;"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""HNAME""):HNAME ZR HNAME ZS DBMAINT8" X DB
 ..S DB="ZL %SP X:$T(INT)'[""VOLDBNA"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""INT^%SPmsm4""):INT ZR INT ZS %SP" X DB
 ..S DB="ZL %GSEL X:$T(GS1+2)'[""%BS"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""%GSEL4""):GS1+2 ZR GS1+2 ZS %GSEL" X DB
 ..S DB="ZL MOUNTRVG X:$T(RCIR+1)'[""?"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""RVG8""):RCIR+1 ZR RCIR+1 ZS MOUNTRVG" X DB
 ..S DB="ZL MOUNTRVG X:$T(RVGN+1)'[""%BSvgT"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""RVG18""):RVGN+1 ZR RVGN+1 ZS MOUNTRVG" X DB
 .S DB="ZL %RSEL X:$T(L0+1)'[""%BS"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""%RSEL""):L0+1 ZR L0+1 ZS %RSEL" X DB
 .S DB="ZL %SDEV X:$T(HFS1+1)'[""FILE^%ZAPM.bs.BSDOS2"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""HFILE""):HFS1+1 ZR HFS1+1 ZS %SDEV" X DB
 .S DB="ZL SGDDB X:$T(PROMPT)["";"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""SGDDB""):PROMPT ZR PROMPT ZS SGDDB" X DB
 .S DB="ZL %RR X:$T(R0+2)'[""already exist"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""%RR""):R0+2 ZR R0+2 ZS %RR" X DB
 .S DB="ZL %GR X:$T(ASK+4)'[""already exist"" DB1 ZL %BSH",DB1="W $ZN,"" "" ZI ^%ZAPM.bs.BS(""%GR""):ASK+4 ZR ASK+4 ZS %GR" X DB
 .W !,"Для продолжения нажмите любую клавишу" R *R1
 K ^%ZAPM.bs.BS("LPT"),^("NS"),^("COM") S C=$P(^SYS("CONFIG"),";"),C=$P(^SYS("CONFIG",C),";") D NAS F I=1:1:90 I $D(^SYS(C,"DDB",I)) D
 .I $P(@$ZR,",",2)?1"LPT"1N S ^%ZAPM.bs.BS("LPT",I)=$P(@$ZR,",",5) Q
 .I $P(^SYS(C,"DDB",I),",",12) S ^%ZAPM.bs.BS("NS",I)=$G(NS($P(@$ZR,",",12)))
 .I $P(^SYS(C,"DDB",I),",",2)["COM" S ^%ZAPM.bs.BS("COM",$E($P(^SYS(C,"DDB",I),",",2),4))=I_","_+$E($P(^SYS(C,"DDB",I),",",3),2,3)
 I $G(^%ZAPM.bs.BSbufB("CLR","FTR",1,1))["/YX" K ^%ZAPM.bs.BSbufB("CLR") S BSr1="^%ZAPM.bs.BSS",BSr2="^%ZAPM.bs.BSbufB",(BSt1,BSt2)="CLR" D COPY^%ZAPM.bs.BSTK S ^%ZAPM.bs.BSbufB="БУФЕР"
 D BUFERS
 I $ZV["3.0.1",$G(%BS(23)),$D(^ ("DDPSRV")) X "ZL DDPSRV I $T(ZUSE)[""%BSddp""" E  S I=$ZT,$ZT="DDPJOB^%ZAPM.bs.BSH" D  S $ZT=I
 .I $P($ZV,"Version ",2)="3.0.10",$D(^ ("DDPSRV10")) X "ZL DDPSRV10 ZS DDPSRV"
 .I $P($ZV,"Version ",2)="3.0.12",$D(^ ("DDPSRV12")) X "ZL DDPSRV12 ZS DDPSRV"
NS I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) S %BS(13)="%BS-PC" U $I::%BS(32) D  Q
 .I $ZV["Cach"||($ZV["IRIS") D %BS3^%ZAPM.bs.BSCp
 I $P($ZV,"Version ",2)<4,'$D(^ ("SGDDBNS")) W !!," В системе нет оптционального пакета NAMESPACE ! ",*7 H
 N BDTRM S %BS(3)=$I,BDTRM=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""TRM"")") I $$Data^%ZAPM.bs.BSF12($NA(@BDTRM@($I))) D  Q
 .U $I::$G(%BS(32),"X3.64-1979")
 .S %BS(13)=$G(@BDTRM@($I,"NSP")),%BS(14)=$G(@BDTRM@($I,"FLG"))
 .S %BS(14,1)=$G(^("OpenLPT")),%BS(14,2)=$G(^("CloseLPT"))
 .S %BS(3)=$G(^("Principal"),$I)
 I $I'=1 W !,"Комплекс не настроен для устройства "_$P R *R H
 S %BS(13)="%BS-PC" U $I::$G(%BS(32),"X3.64-1979")
 Q
 I %BS(3)'=+%BS(3) S %BS(3)=$J
 Q
BUFERS I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSbufB"),2,3)'="44" S ^%ZAPM.bs.BSbufB="Буфер %BS" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSbufB","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSbufP"),2,3)'="44" S ^%ZAPM.bs.BSbufP="BaSe MsW @БУФЕРА ПРИНТ-СЕРВЕРОВ" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSbufP","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSETUP"),2,3)'="44" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSETUP","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSHLP"),2,3)'="44" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSHLP","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BS"),2,3)'="44" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BS","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSdel"),2,3)'="44" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BS","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSJPRN"),2,3)'="44" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSJPRN","0440")
 I $E($$RP^%ZAPM.bs.BSGCH($G(%BS(20),"^%ZAPM.bs.BSDFLT")),2,3)'="44" D CP^%ZAPM.bs.BSGCH($G(%BS(20),"^%ZAPM.bs.BSDFLT"),"0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSbufS"),2,3)'="44" S ^%ZAPM.bs.BSbufS="BaSe MsW @РАЗДЕЛ НАСЧИТАННЫХ СВОДОК И СПИСКОВ" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSbufS","0440")
 I $E($$RP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSDDR"),2,3)'="44" S $P(^%ZAPM.bs.BSDDR,"@",5)="" D CP^%ZAPM.bs.BSGCH("^%ZAPM.bs.BSDDR","0440")
 Q
NAS S I="" F  S I=$O(^SYS("namespace",I)) Q:I=""  I $E(I,1,4)="%BS-" S NS(I)=""
e Q
NASL D NAS S I="" F  S I=$O(NS(I)) Q:I=""  W !,I
 W !,"КАКУЮ NAMESPASE ПРИКРЕПИТЬ К УСТРОЙСТВУ #",$P R "  <%BS-PC>  :",I S:I="" I="%BS-PC" Q:"^."[I  I '$D(NS(I)) G NASL
 S ^%ZAPM.bs.BS("NS",$G(%BS(3),$P))=I Q
VOLNEW ;ПЕРЕАДРЕСАЦИЯ ПУТИ К ТОМУ
 S (HNAME,VOLNA(I))=%BShNAME(2)_"\"_$P(HNAME,"\",$L(HNAME,"\")) D CHKNAME^DBMAINT3 Q
VOL(vol,%VGI) S YES=1 ;ПРОВЕРКА ТОМА
 I $D(^%ZAPM.bs.BSbufB("VOLu"_$G(%BS(3),$P),vol)),$G(%BS(4))[$P(@$ZR,"/") D CHE(@$ZR) I 'YES G END
 I '$D(^%ZAPM.bs.BSbufB("VOLu"_$G(%BS(3),$P),vol)) ZF  D INT^%SP S ^%ZAPM.bs.BSbufB("VOLu"_$G(%BS(3),$P),vol)=$S($$ver^%ZAPM.bs.BSF7()="]":%SPDBNA,1:VOLDBNA),YES=1 G END
 Q
UCI(vol,%VGI) S YES=1 I $D(^%ZAPM.bs.BSbufB("VOLu"_$G(%BS(3),$P),vol)),$G(%BS(4))[$P(@$ZR,"/") S %FN=@$ZR D CHE(%FN) G:'YES END S %BS(9)=%FN
 Q
CHKSUM(%R) ;ВЫЧИСЛЕНИЕ КОНТРОЛЬНОЙ СУММЫ У ПРОГРАММЫ
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q -1
 I '$ZBN(^ (%R)) Q -1
 N %T,%J,%K
 S %T=0 X "ZL @%R F %J=1:1 S %K=$T(+%J) Q:%K=""""  S %T=%T+$ZCRC(%K,1)"
 Q %T
CHECK ;ПРОВЕРКА HFS
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 S YES=1 Q:'$D(@(BSR_"(BST,""HVL"")"))  S MR="" F  S MR=$O(@(BSR_"(BST,""HVL"",MR)")) Q:MR=""  S %FN=@(BSR_"(BST,""HVL"",MR)") I %FN'="" S vv=0 D CHE(%FN) Q:'YES
 I $D(%FN) S %BS(9)=%FN
END K %FN,%DEV Q
CHE(%FN) ;
CH S YES=$$CHECKHFS(%FN) I YES Q
 S ls=" ОШИБКА ЧТЕНИЯ БАЗЫ ДАННЫХ "_%FN_" !!!.ПОВТОРИТЬ ? " W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF I 'YES S ls=" ОШИБКА ДОСТУПА К "_%FN_" !!! " Q
 G CH
CHECKHFS(%FN) G E:%FN="" F %DEV=51:1:54 O %DEV::0 Q:$T
 G:'$T E O %DEV:%FN U %DEV I $ZA=-1 G E
U O %DEV:(%FN:"R") U %DEV I $ZA<0 G E
 C %DEV U $P Q 1
E C %DEV U $P Q 0
DDPJOB I $ZE["LOBR>" W !,"   Остановите Сервер DDP и выполните D CONF^%ZAPM.bs.BSH",$$bel^%ZAPM.bs.BS3 H 2 Q
 Q
TABVAR I $$VAR(1) D ErrMsg^%ZAPM.bs.BSXfun("НЕ ОПРЕДЕЛЕНЫ")
 Q
VAR(A) ;ПРОЛЬЗОВАТЕЛЬСКИЕ ПЕРЕМЕННЫЕ
 N DI,BSR,BST,VA,D,ER,BX,WA
 S DI=$P($G(^%ZAPM.bs.BSETUP("SERVER",12,4)),"@",15) Q:DI="" 4 I '$$Data^%ZAPM.bs.BSF12(DI) S DI=$NA(@%BS(20)@("Variables")) I '$D(@DI) Q 3
 S BSR=$P(DI,"("),BST=$TR($P($P(DI,"(",2),")"),$C(34),"") I $G(A) D ^%ZAPM.bs.BST Q ""
 D CALC^%ZAPM.bs.BSF3,U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
 Q 1
C123 ;
]]></Routine>


<Routine name="%ZAPM.bs.BSHTML" type="MAC" languagemode="0"><![CDATA[
%BSHTML ; пpогpамма ВЫГРУЗКИ ТАБЛИЦЫ В HTML ; 16:20   07.09.2001
 Q
HTML(TABLE) 
 ;Header of HTML Program
 N XB,YB,XE,YE,X,Y,I,SD,B,YT,XT,YXT,YdT,XdT,ASD,BS,ny,nx,d,d0,d1
 D ADD("<!--%BS VERSION "_$G(^%ZAPM.bs.BS)_"-->")
 D ADD("<HTML>")
 D ADD("<HEAD>")
 D ADD("<TITLE>"_$TR($P(@TABLE,"@"),S1,S2)_"</TITLE>")
 D ADD("</HEAD>")
 D ADD("<BODY>")
 D Wait^%ZAPM.bs.BSXfun("вывод в HTML")
 I $G(OUThtml) D TABCEL
 E  D TABLE
 D End
 Q
TABCEL ;ВЫВОД ТАБЛИЦЫ В HTML В ВИДЕ ТАБЛИЦЫ
 N n1 D ADD("<FONT FACE=""Courier New""><SMALL><SMALL><TABLE BORDER=0>")
 F ny=1:1 Q:'$D(@TABLE@(ny))  K S D  X $G(WA)
 .D ADD("<TR>")
 .F nx=1:1 Q:'$D(@TABLE@(ny,nx))  K S D
 ..D CELL^%ZAPM.bs.BSCi D ADD("<TD>")
 ..S n1="" F  S n1=$O(S(n1)) Q:n1=""  D ADD($$HTm^%ZAPM.bs.BSre($TR(S(n1),S1,S2))_"<BR>")
 ..D ADD("</TD>")
 .D ADD("</TR>")
 D ADD("</TABLE></SMALL></SMALL></FONT>")
 Q
TABLE ;OF HTML
 D ADD("<CENTER><SMALL><SMALL><PRE>")
 F ny=1:1 Q:'$D(@TABLE@(ny))  K S D  X $G(WA)
 .F nx=1:1 Q:'$D(@TABLE@(ny,nx))  D CELL^%ZAPM.bs.BSCi
 .S nx="" F  S nx=$O(S(nx)) Q:nx=""  D ADD($$HTm^%ZAPM.bs.BSre($TR(S(nx),S1,S2)))
 D ADD("</PRE></SMALL></SMALL></CENTER>")
 Q
End ;of HTML Program
 D ADD("</BODY>")
 D ADD("</HTML>")
 Q
ADD(S) U %DEV W S,! U 0
 Q
BS2EXCEL(TABLE,GT) ;BS TO EXCEL ПРИЛОЖЕНИЕ ДЛЯ CACHE'  Bs2Exc.exe
 N TIX,TIY,TIT,XB,YB,XE,YE,X,Y,I,SD,B,YT,XT,YXT,YdT,XdT,ASD,BS,ny,nx,d,d0,d1,LNG,N,NN,NNN,KS,BSR,BST,TIP
 S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1($G(@TABLE)) D  ;ПЕРЕКОДИРОВАТЬ
 .K S1,S2 I $$ANSI^%ZAPM.bs.BSre("")
 S LNG=1000,N=0,NN="",KS=0,BSR=$P(TABLE,"("),BST=$QS(TABLE,1),TIP=$P(@TABLE,"@",17)
 D BS2TIT
 F ny=1:1 Q:'$D(@TABLE@(ny))  K S D
 .I TIP=5 S S(1)=$G(@TABLE@(ny)) ;ЭТО ТЕКСТ
 .E  F nx=1:1 Q:'$D(@TABLE@(ny,nx))  D:$P(TIT,",")=ny&($P(TIT,",",2)=nx)  D CELL^%ZAPM.bs.BSCi
 ..S TIX=$L($G(S(1)))+1,TIY=KS
 .S nx="" F  S nx=$O(S(nx)) Q:nx=""  S NNN=$TR(S(nx),S1,S2) D
 ..I ($L(NN)+$L(NNN))>LNG S N=N+1,@GT@(N)=$E(NN,1,$L(NN)-1),NN=""
 ..S NN=NN_NNN_$C(1),KS=KS+1
 S N=N+1,@GT@(N)=$E(NN,1,$L(NN)-1),@GT=KS
 S P4="$"_(TIY-2)_":$"_TIY,P5=TIX+1 ;ПЛЮС ПЕРВЫЙ ПРОБЕЛ В EXCEL
 Q +N
BS2TIT S TIT="1,1"
 I $P(@TABLE,"@",19) S TIT=$P(@TABLE,"@",19)
 E  I $P(@TABLE,"@",50) S TIT=$P(@TABLE,"@",50)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSHTML1" type="MAC" languagemode="0"><![CDATA[
%BSHTML1 ; пpогpамма работы с Java & JavaScript ; 15:07   04.05.2003
 q
NETDIR() ;СЕТЕВАЯ ДИРЕКТОРИЯ
 N Ns S Ns=$P($G(^%ZAPM.bs.BSETUP("SERVER",15,4)),"@",15) I Ns="" S Ns="C:\TEMP\"
 Q Ns
UNAME() N A S A=$TR($$h^%ZAPM.bs.BS3(),",","_") Q $E(A,$L(A)-8,$L(A))
NAMEFILE() N N1,N2 S N1=$P($P(BST,"!",3),".",1)
 ;это для молнии
 I N1="" S N1=$E(BST,1,8) Q $$TOM()_"\"_$$KIP()_"\"_$$UNAME()
 ;это для табеля
 S:$E(N1,2)="P" $E(N1,2)="" S N2=$E(N1,7) I N2="" S N2="_"
 I $E(N1,2,6)["KOM" S N1="_KOM" ;командировки --------------
 Q $$TOM()_"\"_$$KIP()_"\"_$E(N1,2,6)_"\"_$$UNAME()
KIP() N Ns S Ns=$P(BST,$C(34),2)
 I Ns="" S Ns=$p($P(BST,"!",3),".",1)
 I Ns="" D  Q Ns
 .I $P(BST,"_",1)["INSP" S Ns="INSP"
 .E  S Ns=$P(BST,"_",1)
 Q Ns
TOM() N Ns S Ns=$P(BST,$C(34),4)
 I Ns="" d
 .S Ns=$p($P(BST,"!",3),".",1)
 .i Ns["Q"!(Ns["SP") S Ns="TAB"
 I Ns="" Q "MOL"
 Q Ns
INTJAVA(BSR,BST,%FN) ;ВЫВОД ТАБЛИЦЫ В JAVA-APPLET ВНУТРЕННЯЯ ТОЧКА
 N S1,S2,BUF,BUF1,BUF2,%DEV,S,DOS,FNO,PR1,N1,N2
 S DOS=52 I $$Open^%ZAPM.bs.BSXdos(%FN,"W")<0 Q
 I '$D(S1) D INIT^%ZAPM.bs.BSre(1)
 I $ZV["Cach"||($ZV["IRIS") S (S1,S2)=""
 U DOS D JAVA C DOS
 Q
OUTJAVA ;ВЫВОД ТАБЛИЦЫ В JAVA-APPLET
 N S1,S2,BUF,BUF1,BUF2,%DEV,%FN,S,DOS,FNO,PR1,N1,N2
 S PR1=$$NETDIR()_$$NAMEFILE_".HTM" D DOSOPN^%ZAPM.bs.BSBL1 Q:'$D(%FN)
 I '$D(S1) D INIT^%ZAPM.bs.BSre(1)
 I $ZV["Cach"||($ZV["IRIS") S (S1,S2)=""
 D Wait^%ZAPM.bs.BSXfun("Идет вывод")
 U %DEV D JAVA
 C %DEV
 U 0 D OkMsg^%ZAPM.bs.BSXfun("Вывод Завершен")
 Q
Desc() ;ЗАГОЛОВКИ
 N N I $D(@BSR@(BST,"PERHEAD")) Q $G(@BSR@(BST,"PERHEAD")) ;TAF
 S N=$P($G(@BS),"@") I $P(N,"~~~",2)'="" Q $P(N,"~~~",2) ;ТАБЕЛЬ
 I $P(N,"|",2)'="" Q $P(N,"|",2)
 Q N
SCREEN ; РАЗРЕШЕНИЕ АПЛЕТА
 ;РАЗРЕШЕНИЕ МОНИТОРА      screen.availWidth screen.availHeight
 ;S W=620,H=350   ;640x480 !!! ВЗАВИСИМОСТИ ОТ COOKIE ИЛИ IP\ADRESSA
 ;S W=801,H=601    ;800x600
 S W=1023,H=760   ;1024x768
 ;S W=1280,H=1024   ;1280x1024
 Q
CODEBASE() I $G(%BsWebL) Q $$0^%ZAPM.bs.BSCh(31)
 N Ns S Ns=$P($G(^%ZAPM.bs.BSETUP("SERVER",16,4)),"@",15) I Ns="" S Ns="CACHESERVER"
 Q "http://"_Ns_"/iss/tabview/"
PERDAT(G) ;ПЕРИОД ДАТ В ТИТУЛ ДОКУМЕНТА
 N T,C S T="Насчет от "_$P($G(@G@("PERDATE")," ..?")," ",2)
 I $D(@G@("PER",1)) F C=1:1 Q:'$D(@G@("PER",C))  S T=T_BK_@G@("PER",C)
 Q T
JAVA ;ФОРМИРОВАНИЕ ТАБЛИЦЫ ДЛЯ АПЛЕТА
 S UsBS12=$G(%BS(12))
 N %BS,I,II,NSPACE,GL,P1,P2,P3,P9,PART,TABL,TIP,CFG,BS
 N JAVA,W,H,BODY,STR,COL,TIT,TIX,TIY,BYTE,S1,S2
TE I $G(%BsWebL),'$$TABVAR^%ZAPM.bs.BSCh1 Q
 I '$G(%BsWebL) D VARLOC
 S (S2,S1)="" I $$IFDOS($P($G(@BS),"@")) K S1,S2 I $$ANSI^%ZAPM.bs.BSre("")
 D SCREEN ;640x480 РАЗРЕШЕНИЕ АПЛЕТА
APPLET ;ФОРМИРОВАНИЕ ТАБЛИЦЫ
 W "<HTML>",BK
 W "<HEAD><TITLE>"_$TR($$Desc(),S1,S2)_"</TITLE>",BK
 W "<!--%BS + "_$ZV_"-->",BK
 W "<!--%BS "_BST_$TR(" Выводил "_$G(UsBS12)_" из Cистемы "_$$ZU^%ZAPM.bs.BS3(1,0)_" , а насчитывал "_$G(@BSR@(BST,"PERUSER")),S1,S2)_"-->",BK
 W "<!--<BSTITLE> "_$TR($$PERDAT($NA(@BSR@(BST))),S1,S2)_"</BSTITLE>-->"
 ;W BK,"<SCRIPT LANGUAGE=""JavaScript"" SRC="""_$$CODEBASE()_"TabView.JS"">",BK
 ;W "</SCRIPT>",BK
 W BK,"<SCRIPT LANGUAGE=""JavaScript""><!--",BK
 W "function NewSize() {",BK
 W "var W=document.body.clientWidth;",BK
 W "var H=document.body.clientHeight;",BK
 W "document.TabView.SetOptionApplet(W-10,H-15,""0"",0,0,0);",BK
 W "}//--></SCRIPT>",BK
 W "<SCRIPT LANGUAGE=""JavaScript"" EVENT=""onresize"" FOR=""window""> NewSize();",BK
 W "</SCRIPT>",BK
 W "<SCRIPT LANGUAGE=""JavaScript"" EVENT=""onscroll"" FOR=""window""> window.scroll(0,0);",BK
 W "</SCRIPT>",BK
 W "</HEAD>",BK
 W "<BODY onload=""NewSize();"">",BK
 D BODY I '$D(@BODY) W STR G FINAL
 W "<APPLET CODE=TabView.class CODEBASE="""_$$CODEBASE()_""" ID=TabView WIDTH="_W_" HEIGHT="_H_">",BK
 W "<PARAM NAME=COMMENT VALUE="""_1_""">",BK
 W "<PARAM NAME=t2tFontN VALUE=""Courier"">",BK
 W "<PARAM NAME=t2tFontH VALUE=12>",BK
 S Tmp=$$GLRET^%ZAPM.bs.BSF12($NA(@BODY@(1)))
 I $E(Tmp,1)=" "!($E(Tmp,1)="") W "<PARAM NAME=FirstChar VALUE=1>",BK D GLSET^%ZAPM.bs.BSF12($NA(@BODY@(1)),"F"_$E(Tmp,2,9999))
 W "<PARAM NAME=t2tstr VALUE="_STR_">",BK
 W "<PARAM NAME=t2tcol VALUE="_COL_">",BK
 I $G(TIT) W "<PARAM NAME=t2tituls VALUE="_$G(TIY,1)_">",BK,"<PARAM NAME=t2titulc VALUE="_$G(TIX,1)_">",BK
 W "<PARAM NAME=t2t VALUE=""",BK
 S BYTE=0,BYT=0 F I=1:1 Q:'$D(@BODY@(I))  S II=$$GLRET^%ZAPM.bs.BSF12($NA(@BODY@(I)))_$J("",COL-$L($$GLRET^%ZAPM.bs.BSF12($NA(@BODY@(I)))))_BK,BYTE=BYTE+$L(II) D
 .I (BYTE+$L(II))>35000 I $E(II,$L(II)-2)=" " S $E(II,$L(II)-2)="_"
 .I BYTE>35000 D
 ..S BYTE=$L(II),BYT=BYT+1 W """>",BK,"<PARAM NAME=t2t"_BYT_" VALUE=""",BK
 ..I $E(II,1)=" " S $E(II,1)="_"
 .W $TR(II,S1,S2)
 W """></APPLET>",BK
FINAL W "</BODY>","</HTML>",BK
 Q
BYTEPLUS I $E(II,$L(II))=" " S $E(II,$L(II))="_"
 Q
BODY S COL=0,STR=0,BODY=$$TMPG^%ZAPM.bs.BSF11
 I $P(@BS,"@",17)=5 D  Q  ;ТЕКСТ
 .S COL=0 F I=1:1 Q:'$D(@PART@(TABL,I))  D  I COL<$L(Tmp) S COL=$L(Tmp)
 ..S Tmp=$$CTRL^%ZAPM.bs.BSre($TR($G(@PART@(TABL,I)),$C(34),"'"))
 ..D GLSET^%ZAPM.bs.BSF12($NA(@BODY@(I)),Tmp)
 .S STR=I-1
 I $P(@BS,"@",17)=1 D  Q  ;ТАБЛИЦА
 .N X,S,ny,nx,d,d1,d0,BSR,BST ;МОДУЛЬ ИЗ ^%ZAPM.bs.BSHTML
 .S TABLE=BS,STR=0,%BS(15)=1,BSR=PART,BST=TABL,TIT="1,1"
 .I $P(@BS,"@",19) S TIT=$P(@BS,"@",19)
 .E  I $P(@BS,"@",50) S TIT=$P(@BS,"@",50)
 .F ny=1:1 Q:'$D(@TABLE@(ny))  K S D  I $D(%DEV) U 0 X WA U %DEV
 ..F nx=1:1 Q:'$D(@TABLE@(ny,nx))  D:$P(TIT,",")=ny&($P(TIT,",",2)=nx)  D CELL^%ZAPM.bs.BSCi
 ...S TIX=$L($G(S(1)))+1,TIY=STR+1
 ..S nx="" F  S nx=$O(S(nx)) Q:nx=""  S STR=STR+1 D  I COL<$L(Tmp) S COL=$L(Tmp)
 ...S Tmp=$$CTRL^%ZAPM.bs.BSre($TR(S(nx),$C(34),"'"))
 ...D GLSET^%ZAPM.bs.BSF12($NA(@BODY@(STR)),Tmp)
 S STR="УКАЗАННЫЙ ТИП ОБЪЕКТА ПОКА НЕ ПОДДЕРЖИВАЕТСЯ"
 Q
TAGS(S) ;ESCAPE КОДИРОВАНИЕ
 I S[" " S S=$$TR^%ZAPM.bs.BSsFUNM(S," ","&nbsp;")
 I S["<" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"<","&lt;")
 I S[">" S S=$$TR^%ZAPM.bs.BSsFUNM(S,">","&gt;")
 I S[$C(34) S S=$$TR^%ZAPM.bs.BSsFUNM(S,$C(34),"&quot;")
 ;I S["%" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"%","%25")
 ;I S["\" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"\","%5C")
 ;I S[":" S S=$$TR^%ZAPM.bs.BSsFUNM(S,":","%3A")
 Q S
IFDOS(S) ;ПРОВЕРКА КОДИРОВКИ
 I $TR(S,$C(128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175),"")'=S Q 1
 Q 0
TEST S (BST,TABL)="A1000_20000417_1",(BSR,PART)="^[""MGR"",""WNT""]%BSMOLN",BK=""
 S BS=$NA(@PART@(TABL))
 D TE
 Q
VARLOC ;ЛОКАЛЬНЫЕ ПЕРЕМЕННЫЕ
 S BK=$C(13,10),TABL=BST,PART=BSR,BS=$NA(@PART@(TABL))
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSI" type="MAC" languagemode="0"><![CDATA[
%BSI ;ТЕСТ ТАБЛИЦ (Е.Истомин) недоделанная ; 20:15   13.03.99
 I $ZV["Cach"||($ZV["IRIS") D ErrMsg^%ZAPM.bs.BSXfun(" НЕТ РЕЖИМА В "_$ZV) Q
 N j,do,CountUCI,CountVOL,MesStr,BStmp,TmpVOL,TmpUCI,Buf
 S $ZT="ErrGlo^%ZAPM.bs.BSI"
 D SA^%ZAPM.bs.BSsBUF,zzz,RE^%ZAPM.bs.BSsBUF,CL^%ZAPM.bs.BSF4 Q
zzz W /CUP(1,1),$$atr^%ZAPM.bs.BS3(0),*27,"[0J"
 S MesStr=""
 S Way=1
 K ^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u")
 K BStmp,TmpVOL,TmpUCI,Buf
 D MGR^%ZAPM.bs.BS
 I $P($$ZU^%ZAPM.bs.BS3(0),",",2)'=$P($$ZU^%ZAPM.bs.BS3(1,0),",",2) D  Q
 .S MesStr="Перейдите в системный том."
 .D ErrGlo^%ZAPM.bs.BSI
 .Q
 D Ramka^%ZAPM.bs.BSXfun(4,20,12,60,2,"47;30;6",1)
 W /CUP(5,25),$$atr^%ZAPM.bs.BS3("47;30"),"0%           Тома            0%"
 W /CUP(9,25),"0%           Кипы            0%"
 W /CUP(6,25),$$atr^%ZAPM.bs.BS3("44;34;1;5"),"                               "
 W /CUP(10,25),"                               ",$$atr^%ZAPM.bs.BS3("40;37;6;2")
 D Ramka^%ZAPM.bs.BSXfun(14,10,22,70,2,"47;30;6",1)
 W /CUP(14,30)," Диагностика таблиц "
 F CountVOL=0:1 Q:$$ZU^%ZAPM.bs.BS3(1,CountVOL)=""  D
 .F CountUCI=1:1 Q:$$ZU^%ZAPM.bs.BS3(CountUCI,CountVOL)=""  D
 ..S TmpUCI($$ZU^%ZAPM.bs.BS3(CountUCI,CountVOL))=CountUCI Q
 .S BStmp($P($$ZU^%ZAPM.bs.BS3(1,CountVOL),",",2))=CountUCI-1
 .S TmpVOL($P($$ZU^%ZAPM.bs.BS3(1,CountVOL),",",2))=CountVOL+1
 .Q
 S OldVOL=$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)
 S Str=15
 S DOX="D START^%ZAPM.bs.BSI(i,iI)" D STA^%ZAPM.bs.BSF5
 W /CUP(1,1),*27,"[0J"
 I '$D(^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u")) D  G Ex
 .D OkMsg^%ZAPM.bs.BSXfun("Повреждений не обнаружено.")
 I $D(^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u")) S ls=" Диагностика закончена. Просмотр ошибок ? " D YES^%ZAPM.bs.BSF G Ex:YES<1 I YES=1 D  Q
 .D Select Q
 S ls="Попытаемся отремонтировать таблицу "_$P(Buf(Cou),";")_" ?"
 D YES^%ZAPM.bs.BSF I YES=1 D
 .S uci=""_$P(Buf(Cou),";",3)_","_$P(Buf(Cou),";",4)_"" D %GU^%ZAPM.bs.BSF4
 .D REMONT^%ZAPM.bs.BSF5($P(Buf(Cou),";",2),$P(Buf(Cou),";",1))
 .D x^%ZAPM.bs.BS3("I+40")
Ex ;D RE^%ZAPM.bs.BSsBUF
 Q
 
START(BSR,BST) 
 S Scrol1=TmpVOL($P($$ZU^%ZAPM.bs.BS3(0),",",2))/CountVOL*31
 S Scrol2=TmpVOL($P($$ZU^%ZAPM.bs.BS3(0),",",2))/CountVOL*100
 W /CUP(6,25),$$atr^%ZAPM.bs.BS3("44;34;2;6"),$TR($J("",Scrol1)," ",$C(219))
 W $$atr^%ZAPM.bs.BS3("47;30"),/CUP(5,52),$J(Scrol2,3,0),"%"
 S Scrol3=TmpUCI($$ZU^%ZAPM.bs.BS3(0))/BStmp($P($$ZU^%ZAPM.bs.BS3(0),",",2))*31
 S Scrol4=TmpUCI($$ZU^%ZAPM.bs.BS3(0))/BStmp($P($$ZU^%ZAPM.bs.BS3(0),",",2))*100
 I $P($$ZU^%ZAPM.bs.BS3(0),",",2)'=OldVOL W /CUP(10,25),$$atr^%ZAPM.bs.BS3("44;34;1;5"),"                               "
 W /CUP(10,25),$$atr^%ZAPM.bs.BS3("44;34;2;6"),$TR($J("",Scrol3)," ",$C(219))
 W $$atr^%ZAPM.bs.BS3("47;30"),/CUP(9,52),$J(Scrol4,3,0),"%"
 I BSR="^%ZAPM.bs.BSbufS"!(BSR="^%ZAPM.bs.BSX") G EXIT
 
 ;``РАЗОВАЯ ПРОКАЧКА - ИСПРАВЛЕНИЕ БАГА
 ;``I $P(@(BSR_"(BST)"),"@",41)'="" S zXz=$ZR D
 ;``.N A S A=$P(@zXz,"@",41) I A["MENU^%ZAPM.bs.BSF11,MENU^%ZAPM.bs.BSF11" S $P(@zXz,"@",41)="MENU^%ZAPM.bs.BSF11"
 ;``G EXIT
 
 I $P(@(BSR_"(BST)"),"@",17)=5 G EXIT
 I Str=22 S StrBST(8)=" "_BST_$TR($J(0,20-$L(BST)),"0",":") F TT=1:1:7 D
 .S StrBST(TT)=StrBST(TT+1)
 .W /CUP(TT+14,15),$$atr^%ZAPM.bs.BS3("47;30;6"),StrBST(TT)
 .W:TT=7 /CUP(TT+14,15),$$atr^%ZAPM.bs.BS3("47;30;6"),StrBST(TT+1) D:TT=7 PROV
 I Str<22&(Str>15) S StrBST(Str-14)=" "_BST_$TR($J(0,20-$L(BST)),"0",":") D
 .W /CUP(Str,15),$$atr^%ZAPM.bs.BS3("47;30;6"),StrBST(Str-14) D PROV S Str=Str+1 Q
 I Str=15 S StrBST(Str-14)=" "_BST_$TR($J(0,20-$L(BST)),"0",":") D
 .W /CUP(Str,15),$$atr^%ZAPM.bs.BS3("47;30;6"),StrBST(Str-14) D PROV S Str=Str+1 Q
 D MaxY^%ZAPM.bs.BSI S MaxHighY=TempY
 D MaxX^%ZAPM.bs.BSI S MaxHighX=TempX
 S FlagEr=0
 F u=1:1:MaxHighX-1 F m=1:1:MaxHighY-1  D  G JUMP:FlagEr
 .I '$D(@(BSR_"(BST,m,u)")) S FlagEr=1 D Mess Q
 .S ColDiag=$S($P(@(BSR_"(BST,m,u)"),"@",3)="":1,1:$P(@(BSR_"(BST,m,u)"),"@",3))
 .S ColDiag=ColDiag+$S($P(@(BSR_"(BST,m,u)"),"@",1)="":1,1:$P(@(BSR_"(BST,m,u)"),"@",1))
 .I $D(@(BSR_"(BST,m+1,u)")) I $P(@(BSR_"(BST,m+1,u)"),"@",1)'=ColDiag D  Q
 ..D Mess S FlagEr=1 Q
 .Q
 F h=1:1:MaxHighY-1 F j=1:1:MaxHighX-1  D  G JUMP:FlagEr
 .I '$D(@(BSR_"(BST,h,j)")) S FlagEr=1 D Mess Q
 .S StrDiag=$S($P(@(BSR_"(BST,h,j)"),"@",4)="":1,1:$P(@(BSR_"(BST,h,j)"),"@",4))
 .S StrDiag=StrDiag+$S($P(@(BSR_"(BST,h,j)"),"@",2)="":1,1:$P(@(BSR_"(BST,h,j)"),"@",2))
 .I $D(@(BSR_"(BST,h,j+1)")) I $P(@(BSR_"(BST,h,j+1)"),"@",2)'=StrDiag  D   Q
 ..D Mess S FlagEr=1 Q
 .Q
 F u=1:1:MaxHighX-1 D  G JUMP:FlagEr
 .I (u+1)'>(MaxHighX-1) D  Q
 ..I $P(@(BSR_"(BST,MaxHighY-1,u)"),"@",3)'=$P(@(BSR_"(BST,MaxHighY-1,u+1)"),"@",3) S FlagEr=1 D Mess Q
 F h=1:1:MaxHighY-1 D  G JUMP:FlagEr
 .I (h+1)'>(MaxHighY-1) D  Q
 ..I $P(@(BSR_"(BST,h,MaxHighX-1)"),"@",4)'=$P(@(BSR_"(BST,h+1,MaxHighX-1)"),"@",4) S FlagEr=1 D Mess Q
 D OK S StrBST(Str-15)=StrBST(Str-15)_" Ok ...       " G EXIT
JUMP D Error S StrBST(Str-15)=StrBST(Str-15)_" ошибка ...   "
 ;S do="S zr=$ZR,$P(@zr,""@"",3)=$P(^%ZAPM.bs.BSbufB(""u""_$G(%BS(3),$P)_$J_""u""_%BS(15),m,1),""#""),$P(@zr,""@"",4)=$P(^%ZAPM.bs.BSbufB(""u""_$G(%BS(3),$P)_$J_""u""_%BS(15),1,j),""#"",2)"
 ;D ALLT^%ZAPM.bs.BSS1
EXIT S OldVOL=$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 Q
 
PROV S x=$X,y=$Y W $$atr^%ZAPM.bs.BS3("47;31")," проверяю ... " Q
OK S $X=x,$Y=y W $$atr^%ZAPM.bs.BS3("47;30;6")," Ok ...       " Q
Error S $X=x,$Y=y W $$atr^%ZAPM.bs.BS3("47;30;6")," ошибка ...   " Q
 
Mess 
 I '$D(^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u")) S ^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u")="Error"
 S ^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u",Way)=BST_";"_BSR_";"_$P($$ZU^%ZAPM.bs.BS3(0),",")_";"_$P($$ZU^%ZAPM.bs.BS3(0),",",2)
 S Way=Way+1
 Q
 
Bord(%1,%2,%3,%4) 
 W /CUP(%1,$G(%3)),$$atr^%ZAPM.bs.BS3(%4),$C(220)
 W /CUP($G(%1)+1,$G(%2)+1),$$atr^%ZAPM.bs.BS3(%4),$TR($J("",$G(%3)-$G(%2))," ",$C(223))
 Q
 
EnterBut(%1,%2,%3) 
 Q
 
ErrGlo 
 N Delay,I
 D Ramka^%ZAPM.bs.BSXfun(8,15,14,65,2,"41;33;1",1)
 I MesStr="" S MesStr=$ZE W /CUP(8,35)," Ошибка ! "
 S Delay=$P(%BS(2),"-",3)*1000
 W /CUP(10,(65-15-$L(MesStr))\2+15),$$atr^%ZAPM.bs.BS3("41;37;1"),$E(MesStr,1,40)
 D Bord(12,36,44,"41;30;2") D CL^%ZAPM.bs.BSF4
 W /CUP(12,36),$$atr^%ZAPM.bs.BS3("47;30;2;6"),"  Ввод  ",*R D OP^%ZAPM.bs.BSF4
 W /CUP(12,36),$$atr^%ZAPM.bs.BS3("41")," ",$$atr^%ZAPM.bs.BS3("47;30;2;6"),"  Ввод  "
 W /CUP(13,36),$$atr^%ZAPM.bs.BS3("41"),"         "
 F I=1:1:Delay
 D Bord(12,36,44,"41;30;2")
 W /CUP(12,36),$$atr^%ZAPM.bs.BS3("47;30;2;6"),"  Ввод  "
 F I=1:1:Delay
 ;W /CUP(1,1),$$atr^%ZAPM.bs.BS3(0),*27,"[0J"
 D CL^%ZAPM.bs.BSF4,RE^%ZAPM.bs.BSsBUF
 Q
 
Select 
 D Ramka^%ZAPM.bs.BSXfun(6,15,20,65,2,"44;36;1",1)
 W /CUP(7,17),$$atr^%ZAPM.bs.BS3("40;33"),"           Таблица            Раздел           ",$$atr^%ZAPM.bs.BS3(0)
 W /CUP(8,16),$$atr^%ZAPM.bs.BS3("44;36;1"),"-------------------------------------------------",$$atr^%ZAPM.bs.BS3(0)
 S Index1=""
 F k=1:1 S Index1=$O(^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u",Index1)) Q:Index1=""  D
 .S Buf(k)=$G(^%ZAPM.bs.BSbufB("Mes"_$G(%BS(3),$P)_$J_"u",Index1))
 .Q
 F j=1:1:$S(k-1<11:k-1,1:11)  W /CUP(8+j,17),$$atr^%ZAPM.bs.BS3("44;36;1"),"           ",$P(Buf(j),";"),$J("",18-$L($P(Buf(j),";"))),$P(Buf(j),";",2),$J("",18-$L($P(Buf(j),";",2)))
 W /CUP(9,17),$$atr^%ZAPM.bs.BS3("40;32;1"),"           ",$P(Buf(1),";"),$J("",18-$L($P(Buf(1),";"))),$P(Buf(1),";",2),$J("",18-$L($P(Buf(1),";",2)))
 S Str=9,Cou=1,i=0
Rotat D CL^%ZAPM.bs.BSF4 R *R D OP^%ZAPM.bs.BSF4
 I R=66&(Str=19) D  G Rotat
 .I Cou<(k-1) S i=i+1,Cou=Cou+1 D
 ..F j=1:1:$S(k-1<11:k-1,1:11)  W /CUP(8+j,17),$$atr^%ZAPM.bs.BS3("44;36;1"),"           ",$P(Buf(j+i),";"),$J("",18-$L($P(Buf(j+i),";"))),$P(Buf(j+i),";",2),$J("",18-$L($P(Buf(j+i),";",2)))
 ..W /CUP(Str,17),$$atr^%ZAPM.bs.BS3("40;32;1"),"           ",$P(Buf(j+i),";"),$J("",18-$L($P(Buf(j+i),";"))),$P(Buf(j+i),";",2),$J("",18-$L($P(Buf(j+i),";",2)))
 I R=66 D  G Rotat
 .I (Cou+1)<k D
 ..W /CUP(Str,17),$$atr^%ZAPM.bs.BS3("44;36;1"),"           ",$P(Buf(Cou),";"),$J("",18-$L($P(Buf(Cou),";"))),$P(Buf(Cou),";",2),$J("",18-$L($P(Buf(Cou),";",2)))
 ..W /CUP(Str+1,17),$$atr^%ZAPM.bs.BS3("40;32;1"),"           ",$P(Buf(Cou+1),";"),$J("",18-$L($P(Buf(Cou+1),";"))),$P(Buf(Cou+1),";",2),$J("",18-$L($P(Buf(Cou+1),";",2)))
 ..S Str=Str+1,Cou=Cou+1
 I R=65&(Str=9) D  G Rotat
 .I Cou'<2 S i=i-1,Cou=Cou-1 D
 ..F j=1:1:$S(k-1<11:k-1,1:11)  W /CUP(8+j,17),$$atr^%ZAPM.bs.BS3("44;36;1"),"           ",$P(Buf(j+Cou-1),";"),$J("",18-$L($P(Buf(j+Cou-1),";"))),$P(Buf(j+Cou-1),";",2),$J("",18-$L($P(Buf(j+Cou-1),";",2)))
 ..W /CUP(Str,17),$$atr^%ZAPM.bs.BS3("40;32;1"),"           ",$P(Buf(Cou),";"),$J("",18-$L($P(Buf(Cou),";"))),$P(Buf(Cou),";",2),$J("",18-$L($P(Buf(Cou),";",2)))
 I R=65 D  G Rotat
 .W /CUP(Str,17),$$atr^%ZAPM.bs.BS3("44;36;1"),"           ",$P(Buf(Cou),";"),$J("",18-$L($P(Buf(Cou),";"))),$P(Buf(Cou),";",2),$J("",18-$L($P(Buf(Cou),";",2)))
 .W /CUP(Str-1,17),$$atr^%ZAPM.bs.BS3("40;32;1"),"           ",$P(Buf(Cou-1),";"),$J("",18-$L($P(Buf(Cou-1),";"))),$P(Buf(Cou-1),";",2),$J("",18-$L($P(Buf(Cou-1),";",2)))
 .S Str=Str-1,Cou=Cou-1
 I R=13 Q
 G Rotat
 
MaxY 
 S TempY=0
 F t=1:1 D  Q:'$D(@(BSR_"(BST,1,t+1)"))&('$D(@(BSR_"(BST,1,t+2)")))
 .F HighY=1:1 Q:'$D(@(BSR_"(BST,HighY,t)"))
 .I TempY<HighY S TempY=HighY
 .Q
 
MaxX 
 S TempX=0
 F t=1:1 D  Q:'$D(@(BSR_"(BST,t+1,1)"))&('$D(@(BSR_"(BST,t+2,1)")))
 .F HighX=1:1 Q:'$D(@(BSR_"(BST,t,HighX)"))
 .I TempX<HighX S TempX=HighX
 .Q
]]></Routine>


<Routine name="%ZAPM.bs.BSIND" type="MAC" languagemode="0"><![CDATA[
%BSIND ; пpогpамма РАБОТЫ С ИНДЕКСИРОВАННЫМИ ПОКАЗАТЕЛЯМИ И КЛЮЧАМИ ; 18:06   11.06.2003
 Q
DELNODE(BSR,BST,ny,nx) ;УДАЛИТЬ ИНДЕКСЫ
 N B,BD S B=$$MASS Q:B=""
 K @B@(BST_","_ny_","_nx)
 Q
FINDCEL(F,ny,nx,BSR,BST) ;ИНДЕКСИРОВАННЫЕ ПОКАЗАТЕЛИ
 N B,BD,T1,T2,T3,k0,k1,k2,k3,k4,k5,k6,k7,k8,k9,FF,FFF,LOO,LOOP,i
 S %zT=$ZT,$ZT="ERRO^%ZAPM.bs.BSIND"
 S B=$$MASS I B="" D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ! В ДОСТУПЕ К БД-ПОИСКА "_BD) Q
 I '$D(@B@(BST_","_ny_","_nx))!(F="@+")!($$PORA()) D DELNODE(BSR,BST,ny,nx) I '$$GREAT(F) Q
 I F="@-" D DELNODE(BSR,BST,ny,nx),OkMsg^%ZAPM.bs.BSXfun("УДАЛИЛИ ИНДЕКСЫ") Q
 S BD=$NA(@B@(BST_","_ny_","_nx)),F=$E(F,2,9999)
 S FF=$O(@B@(F),-1)
 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSVOL(INDEX)",1,2,"~","FF^%ZAPM.bs.BSIND")
 S i=$G(%BS("Tmp","BSD")),j=$P($G(%BS("Tmp","LastTabl")),"@",9)
 I $QS(i,$QL(i))=j S i=$NA(@i)
 E  S i=$NA(@i@(j))
 I '$$Data^%ZAPM.bs.BSF12(i) W /BEL Q
 I $D(@i)'=1 S k1=$O(@i@("")) I $D(@i@(k1))'=1 S k2=$O(@i@(k1,"")) I $D(@i@(k1,k2))'=1 S k3=$O(@i@(k1,k2,"")) I $D(@i@(k1,k2,k3))'=1 S k4=$O(@i@(k1,k2,k3,"")) I $D(@i@(k1,k2,k3,k4))'=1 S k5=$O(@i@(k1,k2,k3,k4,"")) I $D(@i@(k1,k2,k3,k4,k5))'=1 S k6=$O(@i@(k1,k2,k3,k4,k5,"")) I $D(@i@(k1,k2,k3,k4,k5,k6))'=1 S k7=$O(@i@(k1,k2,k3,k4,k5,k6,"")) I $D(@i@(k1,k2,k3,k4,k5,k6,k7))'=1 S k8=$O(@i@(k1,k2,k3,k4,k5,k6,k7,"")) I $D(@i@(k1,k2,k3,k4,k5,k6,k7,k8))'=1
 S i=$ZR I '$$Data^%ZAPM.bs.BSF12(i) W /BEL Q
 D Yes^%ZAPM.bs.BSXfun("Установим на узел ? "_@i) Q:YES<1
 S END=2,zr=@i,j=")"
 Q
PORA() ;ПОРА ЛИ ОБНОВИТЬ ИНДЕКС
 N S
 S S=$G(@B@(BST_","_ny_","_nx)) I S="" Q 1
 I $P(S,"~",3),($P($$h^%ZAPM.bs.BS3,",")=$P(S,"~",3)) Q 0
 Q 1
FF S @BSR@(BST,"KEY")=BD
 Q
GREAT(F) ;СОЗДАТЬ ИНДЕКСЫ
 N I,FFF,II,LOOP,LOO
 S FF=F I $P(F,"@",2)'["BSD" S FF=$G(@BSR@(BST,"INDEX",ny,nx),"@F k0=95:1:99,""00"",""01"",""02"",""03"",""04"",""05"" S k1="""" F  S k1=$O(@(BSD_k0)@(k1)) Q:k1=""  S k2="""" F  S k2=$O(@(BSD_k0)@(k1,k2)) Q:k2=""""  S k3="""" F  S k3=$O(@(BSD_k0)@(k1,k2,k3)) Q:k3=""""  S k4="""" F  S k4=$O(@(BSD_k0)@(k1,k2,k3,k4)) Q:k4=""""  I k4>0 D CRE($NA(@(BSD_k0)@(k1,k2,k3,k4)),""$E($G(^(57),0),1,3)"",""$G(^(57),0)"",""$G(^(58),0)"")")
 D Wait^%ZAPM.bs.BSXfun("Создаем индекс для "_BST_","_ny_","_nx)
 S LOOP=0
 S %zT=$ZT,$ZT="EREX^%ZAPM.bs.BSIND"
 X FF
 S @B@(BST_","_ny_","_nx)=LOOP_"~"_LOO_"~"_$P($$h^%ZAPM.bs.BS3,",")_"~"_FF
 Q 1
CRE(S,U1,U2,U3,U4,U5,U6,U7,U8,U9) ;ПРИСВОЕНИЕ УЗЛА
 I '$D(FFF) D
 .S FFF=$NA(@B@(BST_","_ny_","_nx)),FFF=$E(FFF,1,$L(FFF)-1)
 .F I=1:1:9 I $D(@("U"_I)) S FFF=FFF_","_@("U"_I)
 .S FFF=FFF_")"
 I $D(@S@("3,3"))
 S LOOP=LOOP+1,@FFF@(LOOP)=S
 I '$D(LOO) S LOO=$QL($ZR)
 X WA
 Q
FINDKEY(F,ny,nx,BSR,BST) ;ИНДЕКСИРОВАННЫЕ КЛЮЧИ
 D OkMsg^%ZAPM.bs.BSXfun("ОТЛАДКА;-)") Q
 
 ;S END=2,c=...
 Q
MASS() N li,ll,YES,ls S (BD,B)=$G(@BSR@(BST,"INDEX"))
 ;I B="" D EDIT S:li'="" B=li I B="" Q ""
 I $$Data^%ZAPM.bs.BSF12(B)="00" W /BEL Q ""
 I $$Data^%ZAPM.bs.BSF12(B)=0 S @B="%BS-index-"
 Q B
DECODE(S,C,OT,KU) ;ПЕРЕКОДИРОВКА
 Q:'$D(ny)!('$D(nx))!('$D(R1))!('$D(R2))!('$D(R3))
 I ny=S,nx=C,R1=$P(OT,",",1),R2=$P(OT,",",2),R3=$P(OT,",",2) S R1=$P(KU,",",1),R2=$P(KU,",",2),R3=$P(KU,",",3)
 Q
EnterYX(Y0,X0) ;ВКЛЮЧИТЬ ПЕРЕКОДИРОВАНИЯ <ENTER> НА <ALT-Y> ДЛЯ КЛЕТКИ {Y,X}
 Q:'$D(ny)!('$D(nx))!('$D(R1))
 I ny=Y0,nx=X0,R1=13,R2=-1,R3=-1 S R1=0,R2=21
 Q
ENTER ;ВКЛЮЧИТЬ ПЕРЕКОДИРОВАНИЯ <ENTER> НА <ALT-Y> ДЛЯ КЛЕТКИ {26,2}
 Q:'$D(ny)!('$D(nx))!('$D(R1))
 I ny=26,nx=2,R1=13,R2=-1,R3=-1 S R1=0,R2=21
 Q
INDEXP S $P(@BSR@(BST,2,2),"@",15)=S,$P(@BSR@(BST,3,2),"@",15)=SSS
 S $P(@BSR@(BST,1,2),"@",15)=SS
 Q
EDIT ;РЕДАКТИРОВАНИЕ ССЫЛКИ ИНДЕКСИРОВАНИЯ ДЛЯ КЛЕТКИ
 ;N SS,S,i,SSS,SSSS
 ;S SS=$P($P(BS,"@",18),"#",1),SSS=BST,SSSS=BSR I SS="" S SS=ny_":"_nx
 ;
 ;I S="" S S=$$BSR^%ZAPM.bs.BSA("^X11111"),S=$NA(@S@(SSS))
 ;N BS,B,BST,BSR,BSY,BSX
 ;S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSVOL(INDEXP)","2#1#8",2,"~","INDEXP^%ZAPM.bs.BSIND") I R1=27 Q
 ;D x^%ZAPM.bs.BS3(i)     ;---//--- для msm 4.x.x
 ;Q
 I $G(@BSR@(BST,"INDEX"))="" D
 .S li=$$LineEdit^%ZAPM.bs.BSXfun($G(@BSR@(BST,"INDEX")),"СНАЧАЛО ВВЕДИТЕ ССЫЛКУ НА МАССИВ ИНДЕКСИРОВАНИЯ")
 .I YES S @BSR@(BST,"INDEX")=li
 I $G(@BSR@(BST,"INDEX"))="" Q
 S li=$$LineEdit^%ZAPM.bs.BSXfun($G(@BSR@(BST,"INDEX",ny,nx)),"ВВЕДИТЕ ОПЦИИ ФОРМИРОВАНИЯ ИНДЕКСИРОВАННОГО МАССИВА (F1)","","","^%ZAPM.bs.BSHLP(Find")
 I YES S @BSR@(BST,"INDEX",ny,nx)=li
 Q
ERRO D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
EREX D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ФОРМИРОВАНИЯ ИНДЕКСА !"_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q ""
]]></Routine>


<Routine name="%ZAPM.bs.BSJPR0" type="MAC" languagemode="0"><![CDATA[
%BSJPR0 ;Обработка клавиш в таблице карты вывода ; 13:29 19-NOV-98
 Q
PRED ;Обработка клавиш в таблице карты вывода
 Q:R1>332
 ;I R1=27&(R2=79)&(R3=81) D  Q                       ;Вывод на устройство
 .D 4 S out=$$Gout^%ZAPM.bs.BSout1(BSRnew,BSTnew,1,2)
 .S BSRold=$P($G(^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u")),"#"),BSTold=$P($G(^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u")),"#",2)
 .S out=$$OUT^%ZAPM.bs.BSout2(BSRold,BSTold)
 .D W^%ZAPM.bs.BST
 
 ;I R1=13&(R2=-1)&(R3=-1) D  Q                       ;Просмотр на экране
 .D 4  S out=$$Gout^%ZAPM.bs.BSout1(BSRnew,BSTnew,1,1)
 .S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")="БУФЕР @@@@@@@1@1@22@80@@@@1@@5@@@1@@@@@@@@@@@1;6;36;44//1;6;36;40@@@@@@@1"
 .D ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSbufB","uP"_$G(%BS(3),$P)_$J_"u")
 .S R1=-2 D W^%ZAPM.bs.BST
 
 I R1=27&(R2=79)&(R3=82) D OPprn^%ZAPM.bs.BSout(BSR,BST) Q   ;Опции принтера
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSJPRN" type="MAC" languagemode="0"><![CDATA[
%BSJPRN ;ПРИНТ-СЕРВЕРА; 21:28 29-JUL-96 ; 8:42   07.03.99
 Q
START() ;СТАРТ СЕРВЕРА
 S %zT=$ZT,$ZT="ER1^%ZAPM.bs.BSJPRN" D Wait^%ZAPM.bs.BSXfun("ЗАПУСК\АКТИВАЦИЯ ПРИНТ-СЕРВЕРА")
 I $$U("A")=1,$$U("D") D E("ПРИНТ-СЕРВЕР ЗАНЯТ, ИЗ "_$G(@UStro@("Z"),"?")) Q 0
 I $$U("A")=1,$$U("D")=0,$$U("Z")="" D S("O",""),S("C",$$ZU^%ZAPM.bs.BS3(1,0)_"u"_$G(%BS(3),$P)) G ZAPR
 I '$$U("A"),$$JOBSR(UStro) G ZAPR
EX Q 0
ER1 D ErrMsg^%ZAPM.bs.BSXfun($$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
ZAPR F Z=1:1 Q:$$U("O")=($$ZU^%ZAPM.bs.BS3(1,0)_"u"_$G(%BS(3),$P))  H 1 X WA I Z=$$PAR^%ZAPM.bs.BSprint(3) D E("ПРИНТ-СЕРВЕР НЕ АКТИВИРУЕТСЯ") G EX
 D S("O",""),S("C","!")
 F Z=1:1 Q:$$U("O")'=""  H 1 X WA I Z=$$PAR^%ZAPM.bs.BSprint(3) G XXX
 I $$U("O")=1 D E("У ПРИНТ-СЕРВЕРА НЕ ГОТОВО УСТРОЙСТВО ПЕЧАТИ")
 I $$U("O")=0 D E("У ПРИНТ-СЕРВЕРА ЧТО-ТО С НОМЕРОМ ПЕЧАТИ")
 I $$U("O")'="OK" G XXX
 D BUF,S("Z",$$ZU^%ZAPM.bs.BS3(1,0)),S("B",BUF),S("US",uS),S("UL",uL),S("UK",uK),S("OT",oT),S("RP",rP),S("EXE",uE)
 D S("O",""),S("C","P")
 Q 1
BUF ;СДЕЛАТЬ БУФЕР И ПЕРЕМЕННЫЕ
 ;TXT
 S uK=$G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","SHR")),uS=$P(uK,"#"),uL=$P(uK,"#",2),uK=$P(uK,"#",3)
 S uE=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","TXT")),"#",2)
 S oT=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","DOS")),"#"),rP=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","DOS")),"#",2)
 S BUF=$NA(^%ZAPM.bs.BSbufP($P($$RANDFILE^%ZAPM.bs.BSF11,".")))
 D Copy^%ZAPM.bs.BSF8($NA(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")),BUF,0,1) S @BUF=@%BS(20)@("TextEdit"),$P(@BUF,"@")="Для "_$G(date)_" от "_$$ZU^%ZAPM.bs.BS3(1,0)_" "_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())
 Q
XXX D E("У ПРИНТ-СЕРВЕРА ЧТО-ТО ПЕЧАТЬЮ") G EX
CN(UStro) N Z D Wait^%ZAPM.bs.BSXfun("КОНТРОЛЬ СЕРВЕРА")
 D S("O",""),S("C","?")
 F Z=1:1 Q:$$U("O")="?"  H 1 X WA I Z=$$PAR^%ZAPM.bs.BSprint(3) D Yes^%ZAPM.bs.BSXfun("МНЕ КАЖЕТСЯ, ЧТО СЕРВЕР ПОМЕР...ПОХОРОНИМ ?") G:YES<1 CNN D EXIT^%ZAPM.bs.BSprint G CNN
 D S("O",""),OkMsg^%ZAPM.bs.BSXfun("СЕРВЕР ЕЩЕ ЖИВОЙ, ЗАГАСИТЬ ЕГО МОЖЕТЕ КОМАНДОЙ 'D'")
CNN Q 1
JOBSR(UStro) ;ЗАПУСК СЕРВЕРА
 X "J ^%ZAPM.bs.BSprint(UStro)["""_$$TR^%ZAPM.bs.BSsFUNM($$PR(19),",",""",""")_"""]:$$PAR^%ZAPM.bs.BSprint(6):1" E  D E("ПРИНТ-СЕРВЕР НЕ ХОЧЕТ ЗАПУСКАТЬСЯ...неполадки с мотором, наверное") Q 0
 D S("O",""),S("C",$$ZU^%ZAPM.bs.BS3(1,0)_"u"_$G(%BS(3),$P))
 Q 1
STOP ;
 Q
 ;US,UO -УСТРОЙСТВО
 ;UStro -ССЫЛКА
 ;ExZ - КОЛ-ВО ЭКЗЕМПЛЯРОВ
S(U,S) S @UStro@(U)=S Q
U(U) Q $G(@UStro@(U))
E(E) D ErrMsg^%ZAPM.bs.BSXfun(E) Q
INIT(UO) ;ПЕРЕОПРЕДЕЛЕНИЕ US
 U 0 N B,BUF,uK,uL,oT,rP,uS,uE
 S ExZ=1 I +UO S ExZ=+UO
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSJPRN"
 S B=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSJPRN(""PRN"")")
 I $$9'=0,B'="",$O(@B@(""))'="" G CHOISE
DF S US=$$DFLT
DF1 Q 1
9() Q $E(%BS(1),9)
CHOISE ;ВЫБОР ПРИНТЕРА
 D SA^%ZAPM.bs.BSsBUF
 S IYI="PRN,%BSJPRN,,,<>" D ENTER^%ZAPM.bs.BSN D RE^%ZAPM.bs.BSsBUF I date="" Q 0
 S UStro=$NA(@B@(date)) I $$9=1,$$PR(19)=$$ZU^%ZAPM.bs.BS3(1,0) S US=$$PR(17) G DF1
 I $$START Q 0
 D Yes^%ZAPM.bs.BSXfun("Может будем использовать ЛОКАЛЬНЫЙ принтер БЕЗ ПРИНТ-СЕРВЕРА",1) I YES>0 G DF
 Q 0
ERR S US=$$DFLT W $$bel^%ZAPM.bs.BS3 S $ZT=$G(%zT) G DF
PR(P) I UStro["PRNDFLT" Q $P($G(^%ZAPM.bs.BSETUP("PRNDFLT",P,2),@%BS(20)@("PRNDFLT",P,2)),"@",15)
 Q $G(@UStro@((P_",2")))
DFLT() I $D(^%ZAPM.bs.BSETUP("PRNDFLT")) S UStro=$NA(^%ZAPM.bs.BSETUP("PRNDFLT"))
 E  S UStro=$NA(@%BS(20)@("PRNDFLT"))
 Q $$PR(17)
MAX(UO) I UO=2 Q $J //ДЛЯ КАШИ!!!
 Q $S('$$PR(18):255,1:$$PR(18))
SBROS(UO) ;Сброс параметров
 Q $C($$PR(15))
CTRL(S,UO) ;УПРАВЛЕНИЕ ПРИНТЕРОМ
 I S["@" S S=$TR(S,"@","#")
 I S["27," Q S
 F I=1:1:3 S II=$P($P(S,"#",I),",") I II'="" S $P(S,"#",I)=$$PR(II)
 Q S
COM ;КОМАНДА СЕРВЕРУ
 S IYI="^%ZAPM.bs.BSJPRN,PCMD" D NE^%ZAPM.bs.BSN I date="" G CO
 N E
 I $E(date,1)="E" D  G CO
 .I $G(@%BS("Tmp","BSD")@("D"))=2 S E=$$LineEdit^%ZAPM.bs.BSXfun($G(@%BS("Tmp","BSD")@("EXE"))) I YES>0,E S @%BS("Tmp","BSD")@("EXE")=E Q
 .W $$bel^%ZAPM.bs.BS3
 I $E(date,1)="?" D  G CO
 .I $$CN(%BS("Tmp","BSD"))
 I $E(date,1)="A" D  G CO
 .I '$G(@%BS("Tmp","BSD")@("A")),$$JOBSR(%BS("Tmp","BSD")) Q
 .W $$bel^%ZAPM.bs.BS3
 I $E(date,1)'="" S @%BS("Tmp","BSD")@("C")=$E(date,1) G CO
 Q
CO S R1=-1 Q
TRAN ;ПЕРЕРИСОВКА КЛЕТОК
 S do="I $P(@$ZR,""@"",8)'="""",$P(@$ZR,""@"",9)'=1 D W^%ZAPM.bs.BSTM" D 66^%ZAPM.bs.BSF3
 Q
TRANS ;
 Q:R1>332
 I %BS(2)'["^" S %BS(2,1)=%BS(2),%BS(2)="2-D TRAN^%ZAPM.bs.BSJPRN" S R1=-1 Q
 ;I R1=13,R2=-1,R3=-1 D UNDO Q
 I R1=27,R2=-1,R3=-1 D UNDO Q
 Q
UNDO I %BS(2)["^" S %BS(2)=%BS(2,1) K %BS(2,1)
 I %BS(2)["^" D CLr^%ZAPM.bs.BSF4
 Q
ERASER(Y) N I ;ЧИСТИЛЬЩИК
 I '$G(Y) Q:$P($G(^%ZAPM.bs.BSETUP("PARPRN",7,2)),"@",15)'="Y"  Q:$O(^%ZAPM.bs.BSbufP(""))=""
ERA S I="" F  S I=$O(^%ZAPM.bs.BSbufP(I)) Q:I=""  D L^%ZAPM.bs.BS3($NA(^%ZAPM.bs.BSbufP(I)),1) D  D U^%ZAPM.bs.BS3($NA(^%ZAPM.bs.BSbufP(I)))
 .I 'LOC,$G(Y) K ^%ZAPM.bs.BSbufP(I) Q
 .I LOC K ^%ZAPM.bs.BSbufP(I)
 Q
CHEKPRN N B,S,UStro,SS ;ПРОВЕРКА АКТИВНЫХ СЕРВЕРОВ
 S %zT=$ZT,$ZT="ERB^%ZAPM.bs.BSJPRN"
 S B=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSJPRN(""PRN"")") I $$9'=0,B'="",$D(@B) D
 .S S="",SS="" F  S S=$O(@B@(S)) Q:S=""  S UStro=$NA(@B@(S)) I $$PR(19)=$$ZU^%ZAPM.bs.BS3(1,0),$$U("A") S SS=SS_S_","
 S YES=1 I $G(SS)'="" D Yes^%ZAPM.bs.BSXfun("В СИСТЕМЕ АКТИВНЫ ПРИНТ-СЕРВЕРА:"_SS_",ПРЕРЫВАЕМ ИХ ?",2) I YES D
 .S S="" F  S S=$O(@B@(S)) Q:S=""  S UStro=$NA(@B@(S)) I $$PR(19)=$$ZU^%ZAPM.bs.BS3(1,0),$$U("A") D EXIT^%ZAPM.bs.BSprint
 Q
ERB D BEL^%ZAPM.bs.BSprint S $ZT=$G(%zT) Q
BEGINER N B,S ;НАЧАЛО
 Q:$P($G(^%ZAPM.bs.BSETUP("PARPRN",2,2)),"@",15)=""  S S=$P($G(^%ZAPM.bs.BSETUP("PARPRN",2,2)),"@",15)
 S %zT=$ZT,$ZT="ERB^%ZAPM.bs.BSJPRN"
 S B=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSJPRN(""PRN"")") I $$9'=0,B'="",$D(@B@(S)) S S=$NA(@B@(S)) D  Q
 .I '$G(@S@("A")),$$JOBSR(S) Q
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSLOG" type="MAC" languagemode="0"><![CDATA[
%BSLOG ; пpогpамма ЛОГИЧЕСКОГО КОНТРОЛЯ ; 14:02   14.09.99
 Q
MUK ;МЕЖУРОВНЕВЫЙ КОНТРОЛЬ
 S MUse=se
 I ny<3 G D
 I 'key D ErrMsg^%ZAPM.bs.BSXfun("НА НУЛЕВОМ УРОВЕНЕ КОНТРОЛЬ НЕ ПРОИЗВОДИТСЯ") G D
 D TempT^%ZAPM.bs.BSTT ;ПОДГОТОВКА НОВОГО ОТЧЕТА
 K MU,MUNO,MUBD,MUER
 S MUER=0 D Wait^%ZAPM.bs.BSXfun("МЕЖУРОВНЕВЫЙ КОНТРОЛЬ")
 I '$G(%DIA) D MUKL(d) G:$D(MUNO) MUKILL G MUEND
 S do="S d=$P(^(j),""@"",15) D MUKL^%ZAPM.bs.BSLOG(d)" D BLOK^%ZAPM.bs.BSF1 I $D(MUNO) G MUKILL
 D UNMARK^%ZAPM.bs.BSF11($NA(@BSR@(BST))) K %DIA D W^%ZAPM.bs.BST
MUEND ;ЗАВЕРШЕНИЕ ОТЧЕТА
 I 'MUER D TempTX^%ZAPM.bs.BSTT("КОНТРОЛЬ ПРОШЕЛ УСПЕШНО"),TempTX^%ZAPM.bs.BSTT("")
 G:$D(MUNO)!('$D(@BSr@(BSt,2))) MUKILL
 D TempTXT^%ZAPM.bs.BSTT("ОТЧЕТ МЕЖУРОВНЕВОГО КОНТРОЛЯ",$G(@%BS(20)@("TextEdit")))
 D TempTXTE^%ZAPM.bs.BSTT ;ВХОД В ТЕКСТ
MUKILL K @BSr@(BSt) ;УДАЛЕНИЕ ОТЧЕТА
D S se=MUse
 K KILLER,MU,MUse,MUNO,MUBD,LB,F,ERTX G 0^%ZAPM.bs.BSTM
MUKL(d) N i,Tmp
 Q:d=""  I '$D(%KEYS) S Tmp=BSD_d
 E  S Tmp=BSD_$G(%KEYS(0))
 I key D
 .F i=1:1:key I $D(%KEYS(i)) S Tmp=$NA(@Tmp@(%KEYS(i)))
 .S Tmp=$NA(@Tmp@(d))
 D MU(Tmp,$NA(@Bsr@(Bst)),key)
 Q
MU(B,BSG,U) ;САМ КОНТРОЛЬ
 N er S er=$$CHECK(BSG) I 'er D:'$D(MUNO) ErrMsg^%ZAPM.bs.BSXfun("ДЛЯ "_BSG_" НЕ ОПИСАНЫ ФОРМУЛЫ МЕЖУРОВНЕГО КОНТРОЛЯ В "_$G(MUBD)_". Ошибка:"_er) S MUNO=1 Q
 S %zT=$ZT,$ZT="ERMU^%ZAPM.bs.BSLOG"
 N k0,k1,k2,k3,k4,k5,k6,k7,k8,k9
 F I1=0:1 Q:'$D(%KEYS(I1))  S @("k"_I1)=%KEYS(I1)
 S I1="",ER=0 F  S I1=$O(MU(BSG,I1)) Q:I1=""  D
 .I I1<U S I2="" D  Q
 ..F  S I2=$O(MU(BSG,I1,I2)) Q:I2=""  D TempTX^%ZAPM.bs.BSTT("ФОРМУЛА МЕЖУРОВНЕГО КОНТРОЛЯ: "_MU(BSG,I1,I2,1)),TempTX^%ZAPM.bs.BSTT(" , ПРЕДНАЗНАЧЕННАЯ ДЛЯ РАБОЫ НА "_I1_" УРОВНЕ, НЕ БУДЕТ ИСПОЛЬЗОВАНА."),TempTX^%ZAPM.bs.BSTT("  ДЛЯ ВКЛЮЧЕНИЯ ЕЕ В РАБОТУ ПЕРЕЙДИТЕ НА "_I1_" УРОВЕНЬ"),TempTX^%ZAPM.bs.BSTT(""),E
 .I I1=U S I2="" D  Q
 ..F  S I2=$O(MU(BSG,I1,I2)) Q:I2=""  X MU(BSG,I1,I2,1) E  D TempTX^%ZAPM.bs.BSTT("НА УЗЛЕ "_B_" ОШИБКА !!! ФОРМУЛА :"_MU(BSG,I1,I2,1)),TempTX^%ZAPM.bs.BSTT(MU(BSG,I1,I2,2)),ERTX,TempTX^%ZAPM.bs.BSTT(""),E
 .I (I1-U)=1 S I4="",BB=B D  Q  ;ТОЛЬКО НА УРОВЕНЬ ВЫШЕ
 ..F  S I4=$O(@BB@(I4)) Q:I4=""  I I4'["@" S B=$NA(@BB@(I4)) D
 ...S I2="" F  S I2=$O(MU(BSG,I1,I2)) Q:I2=""  X MU(BSG,I1,I2,1) E  D TempTX^%ZAPM.bs.BSTT("НА УЗЛЕ "_B_" ОШИБКА !!! ФОРМУЛА :"_MU(BSG,I1,I2,1)),TempTX^%ZAPM.bs.BSTT(MU(BSG,I1,I2,2)),ERTX,TempTX^%ZAPM.bs.BSTT(""),E
 .I (I1-U)>1 S I2="" D  Q
 ..F  S I2=$O(MU(BSG,I1,I2)) Q:I2=""  D TempTX^%ZAPM.bs.BSTT("ФОРМУЛА МЕЖУРОВНЕГО КОНТРОЛЯ: "_MU(BSG,I1,I2,1)),TempTX^%ZAPM.bs.BSTT(" , ПРЕДНАЗНАЧЕННАЯ ДЛЯ РАБОЫ НА "_I1_" УРОВНЕ, НЕ БУДЕТ ИСПОЛЬЗОВАНА."),TempTX^%ZAPM.bs.BSTT("  ДЛЯ ВКЛЮЧЕНИЯ ЕЕ В РАБОТУ ПЕРЕЙДИТЕ НА "_I1_" УРОВЕНЬ"),TempTX^%ZAPM.bs.BSTT(""),E
 Q
GTX N EK,ERT,I,F,J,S,O ;ТЕКСТ ЗНАЧЕНИЙ У ГРУПП
 S F=$P(GTX,"@"),O=$P(GTX,"@",2),S=$P(GTX,"@",3),GTX(-1)="",GTX(-3)="",GTX(-4)=""
 F J=1:1 Q:$P(GTX(-2),"@",J,J+1)=""  D
 .S I="" F  S I=$O(GTX(I)) Q:I=""  I '(I=-3!(I=-1)!(I=-2)!(I=-4)) D
 ..I F=",ALL," D  Q
 ...I S[(","_I_",") S $P(GTX(-4),"@",J)=$P(GTX(-4),"@",J)+$P(GTX(I),"@",J) Q
 ...S $P(GTX(-1),"@",J)=$P(GTX(-1),"@",J)+$P(GTX(I),"@",J) Q
 ..I S=",ALL," D  Q
 ...I F[(","_I_",") S $P(GTX(-1),"@",J)=$P(GTX(-1),"@",J)+$P(GTX(I),"@",J) Q
 ...S $P(GTX(-4),"@",J)=$P(GTX(-4),"@",J)+$P(GTX(I),"@",J) Q
 ..I F[(","_I_",") S $P(GTX(-1),"@",J)=$P(GTX(-1),"@",J)+$P(GTX(I),"@",J) Q
 ..I S[(","_I_",") S $P(GTX(-4),"@",J)=$P(GTX(-4),"@",J)+$P(GTX(I),"@",J) Q
 .Q:'$D(GTX(-1))!('$D(GTX(-4)))
 .I $P(GTX(-3),"@",J)<$L($P(GTX(-1),"@",J)) S $P(GTX(-3),"@",J)=$L($P(GTX(-1),"@",J))
 .I $P(GTX(-3),"@",J)<$L($P(GTX(-2),"@",J)) S $P(GTX(-3),"@",J)=$L($P(GTX(-2),"@",J))
 .I $P(GTX(-3),"@",J)<$L($P(GTX(-4),"@",J)) S $P(GTX(-3),"@",J)=$L($P(GTX(-4),"@",J))
 F J=1:1 Q:$P(GTX(-2),"@",J,J+1)=""  D
 .S I="" F  S I=$O(GTX(I)) Q:I=""  I I'=-3 D
 ..I '$D(ERT(I)) S ERT(I)=$S(I=-1:"(1 СУМ) |",I=-4:"(2 СУМ) |",I=-2:"  КОДЫ  |",1:$J(I,7)_" |")
 ..S ERT(I)=ERT(I)_$J($P(GTX(I),"@",J),$P(GTX(-3),"@",J)+1)
 D ERT,TempTX^%ZAPM.bs.BSTT(ERT(-2)),ERT
 S I="" F  S I=$O(ERT(I)) Q:I=""  I '(I=-3!(I=-1)!(I=-2)!(I=-4)) D
 .I F=",ALL," D  Q
 ..I S'[(","_I_",") D TempTX^%ZAPM.bs.BSTT(ERT(I))
 .I F[(","_I_",") D TempTX^%ZAPM.bs.BSTT(ERT(I))
 D TempTX^%ZAPM.bs.BSTT($TR(ERT(-1)," ","_")),TempTX^%ZAPM.bs.BSTT($TR(ERT(-4)," ","_"))
 S I="" F  S I=$O(ERT(I)) Q:I=""  I '(I=-3!(I=-1)!(I=-2)!(I=-4)) D
 .I S=",ALL," D  Q
 ..I F'[(","_I_",") D TempTX^%ZAPM.bs.BSTT(ERT(I))
 .I S[(","_I_",") D TempTX^%ZAPM.bs.BSTT(ERT(I))
 D ERT K GTX Q
E S MUER=MUER+1 Q
ERTX G:$D(GTX) GTX Q:'$D(ERTX)  N ERT,I,K,J ;ТЕКСТ ЗНАЧЕНИЙ
 S K=ERTX(-1),ERTX(-1)="",ERTX(-3)="" Q:'$D(ERTX(K))
 F J=1:1 Q:$P(ERTX(-2),"@",J,J+1)=""  D
 .S I="" F  S I=$O(ERTX(I)) Q:I=""  I '(I=-3!(I=-1)!(I=-2)) D
 ..I I'=K S $P(ERTX(-1),"@",J)=$P(ERTX(-1),"@",J)+$P(ERTX(I),"@",J) Q
 .I $P(ERTX(-3),"@",J)<$L($P(ERTX(-1),"@",J)) S $P(ERTX(-3),"@",J)=$L($P(ERTX(-1),"@",J))
 .I $P(ERTX(-3),"@",J)<$L($P(ERTX(-2),"@",J)) S $P(ERTX(-3),"@",J)=$L($P(ERTX(-2),"@",J))
 .I $P(ERTX(-3),"@",J)<$L($P(ERTX(K),"@",J)) S $P(ERTX(-3),"@",J)=$L($P(ERTX(K),"@",J))
 F J=1:1 Q:$P(ERTX(-2),"@",J,J+1)=""  D
 .S I="" F  S I=$O(ERTX(I)) Q:I=""  I I'=-3 D
 ..I '$D(ERT(I)) S ERT(I)=$S(I=-1:"  (СУМ) |",I=-2:"  КОДЫ  |",1:$J(I,7)_" |")
 ..S ERT(I)=ERT(I)_$J($P(ERTX(I),"@",J),$P(ERTX(-3),"@",J)+1)
 D ERT,TempTX^%ZAPM.bs.BSTT(ERT(-2)),ERT,TempTX^%ZAPM.bs.BSTT(ERT(K)),TempTX^%ZAPM.bs.BSTT($TR(ERT(-1)," ","_"))
 S I="" F  S I=$O(ERT(I)) Q:I=""  I '(I=-3!(I=-1)!(I=-2)!(I=K)) D TempTX^%ZAPM.bs.BSTT(ERT(I))
 D ERT K ERTX Q
ERT D TempTX^%ZAPM.bs.BSTT($TR($J("",$L(ERT(-2)))," ","-")) Q
ERMU I $ZE["LINER" D ErrMsg^%ZAPM.bs.BSXfun(" НЕПРАВИЛЬНАЯ ФУНКЦИЯ КОНТРОЛЯ В ФОРМУЛЕ "_I2_" !") S $ZT=$G(%zT) Q
 I $ZE["<ZOPER" D ErrMsg^%ZAPM.bs.BSXfun(" НЕПРАВИЛЬНАЯ АРИФМЕТИЧЕСКАЯ ОПЕРАЦИЯ В ФОРМУЛЕ "_I2_" !") S $ZT=$G(%zT) Q
 I $ZE["<ZFEST" D ErrMsg^%ZAPM.bs.BSXfun(" НЕПРАВИЛЬНЫЕ ПАРАМЕТРЫ В ФОРМУЛЕ "_I2_" !") S $ZT=$G(%zT) Q
 D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА В ФОРМУЛЕ "_I2_" !!! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
CHECK(BSG) ;ПРОВЕРКА СООТВЕТСТВИЯ ТОБД И ДДР
 N BD,I1,I2,I3
 Q:$D(MU(BSG)) 1 S (MUBD,BD)=$$Bd^%ZAPM.bs.BSMDDR1 I BD="" Q 0
 I '$D(@BD@("@S")) D SETINDX
 I $D(@BD@("@S",BSG)) S I1=$P(@BD@("@S",BSG),"§") Q:I1="" "I1"
 I '$D(@BD@("@S",BSG)) D  Q:I1="" "I10"_BD_BSG
 .S I1="" F  S I1=$O(@BD@(I1)) Q:I1=""  I $G(@BD@(I1,"^","S"))'="",@BD@(I1,"^","S")=BSG S @BD@("@S",BSG)=I1_"§"_"^§S" Q
 Q:'$D(@BD@(I1)) "BDI1" S I2="" F  S I2=$O(@BD@(I1,I2)) Q:I2=""  I $E(I2)="K",$G(@BD@(I1,I2,"KE")) S I3=@$ZR D
 .S MU(BSG,I3,I2,1)=$G(@BD@(I1,I2,"FO")),MU(BSG,I3,I2,2)=$G(@BD@(I1,I2,"TX"))
 S F=I1 I '$$LBD^%ZAPM.bs.BSMDDR1($NA(@BD@(I1)),"1") Q "LBD"
 I $D(MU(BSG)) Q 1
 Q "?0"
SETINDX ;ИНДЕКСИРОВАНИЕ БАЗЫ ДАННЫХ
 S I1="" F  S I1=$O(@BD@(I1)) Q:I1=""  I $G(@BD@(I1,"^","S"))'="" S @BD@("@S",@BD@(I1,"^","S"))=I1_"§"_"^§S"
 Q
GROUP(FI,O,S,EK,EP) ;СУММА КОДОВ ГРУППЫ F ПО ВСЕМ ПОКАЗАТЕЛЯМ
             ;ДОЛЖНА БЫТЬ O (O-АРИФМЕТИЧЕСКАЯ ОПЕРАЦИЯ) ПО ОТНОШЕНИЮ К СУММЕ
             ;ГРУППЫ S ПО ВСЕМ ПОКАЗАТЕЛЯМ, КРОМЕ EK КОДОВ И EP ПОКАЗАТЕЛЕЙ
 N I,II,III,QQ,I1 X $G(WA)
 K GTX S FI=","_$G(FI)_",",S=","_$G(S)_"," I FI=",,"!(S=",,") ZT "FEST"
 I FI=",ALL,"&(S=",ALL,") ZT "FEST"
 I O=""!(O'?.P) ZT "OPER"
 S GTX=FI_"@"_O_"@"_S
 S I1="",QQ=0 F  S I1=$O(LB(F,"I",I1)) Q:I1=""  I $P(LB(F,"I",I1),"@",2)'="" D
 .I $G(EP)'="",(","_EP_",")[(","_I1_",") Q
 .S QQ=QQ+'$$GROU($P(LB(F,"I",I1),"@",2),+I1),$P(GTX(-2),"@",+I1)=I1
 Q 'QQ
GROU(P,P1) S I="",II=0,III=0 F  S I=$O(@B@(I)) Q:I=""  D
 .I $G(EK)'="",(","_EK_",")[(","_I_",") Q
 .I FI=",ALL," D  Q
 ..I S[(","_I_",") S III=III+$G(@B@(I,P)),$P(GTX(I),"@",P1)=$G(@B@(I,P)) Q
 ..S II=II+$G(@B@(I,P)),$P(GTX(I),"@",P1)=$G(@B@(I,P)) Q
 .I S=",ALL," D  Q
 ..I FI[(","_I_",") S II=II+$G(@B@(I,P)),$P(GTX(I),"@",P1)=$G(@B@(I,P)) Q
 ..S III=III+$G(@B@(I,P)),$P(GTX(I),"@",P1)=$G(@B@(I,P)) Q
 .I FI[(","_I_",") S II=II+$G(@B@(I,P)),$P(GTX(I),"@",P1)=$G(@B@(I,P)) Q
 .I S[(","_I_",") S III=III+$G(@B@(I,P)),$P(GTX(I),"@",P1)=$G(@B@(I,P)) Q
 X "I II"_O_"III" Q $T
SumKP(K,P) ;СУММА КОДОВ КРОМЕ К ПО ПОКАЗАТЕЛЮ P РАВНА КОДУ К ПО ПОКАЗАТЕЛЮ P
           ;ЕСЛИ P="" ТО ПОВСЕМ ПОКАЗАТЕЛЯМ
 N I,II,III,QQ,I1 X $G(WA) K ERTX S ERTX(-1)=K
 I '$D(P) D  Q 'QQ
 .S I1="",QQ=0 F  S I1=$O(LB(F,"I",I1)) Q:I1=""  I $P(LB(F,"I",I1),"@",2)'="" S QQ=QQ+'$$Sum($P(LB(F,"I",I1),"@",2),+I1),$P(ERTX(-2),"@",+I1)=I1
 I $P(LB(F,"I",P),"@",2)'="" D  I $$Sum($P(LB(F,"I",P),"@",2),+P) Q 1
 .S $P(ERTX(-2),"@",+P)=P
 Q 0
Sum(P,P1) S I="",II=0,III=0 F  S I=$O(@B@(I)) Q:I=""  D
 .I I'=K S II=II+$G(@B@(I,P)),$P(ERTX(I),"@",P1)=$G(@B@(I,P)) Q
 .I I=K S III=+$G(@B@(I,P)),$P(ERTX(I),"@",P1)=$G(@B@(I,P)) Q
 I II=III Q 1
 Q 0
YesKod(K) ;ЕСТЬ ЛИ КОД ?
 X $G(WA)
 I $D(@B@(K)) Q 1
 Q 0
OnlyKod(K) ;ПРЕДСТАВЛЕН ТОЛКО ОДИН КОД
 N I,II,III X $G(WA)
 S I="" F  S I=$O(@B@(I)) Q:I=""  D
 .I I'=K S II=I Q
 .I I=K S III=K
 I $D(II) Q 0
 I $D(III) Q 1
 Q 0
KP(K,P) ;ДАННЫЕ КОДА И ПОКАЗАТЕЛЯ
 X $G(WA) I P'="" D  Q P
 .I $P(LB(F,"I",P),"@",2)'="" S P=$P(LB(F,"I",P),"@",2),P=$G(@B@(K,P)) Q
 .S P=""
 Q ""
LER D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
LOGS ;СПИСОК ЛОГИЧЕСКИХ ОШИБОК
 N lO,lOg,NoKiTab,s1,s2,s3,s4,ny,nx,i3,i4,t1,t2,t0,i,ii,i1,i2,iii,Obraz
 S s1=se,s2=ke,s3=BSR,s4=BST S %zT=$ZT,$ZT="LER^%ZAPM.bs.BSLOG"
L S ny="",t0="/// Лог.Ошибки для:"_BSR_"("_BST_") "
 S BSr="^%ZAPM.bs.BSbufB",BSt="LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1" S:$D(uzel) NoKiTab=1 D CR^%ZAPM.bs.BSTT I $D(uzel) S t0=" //"_$G(uzel) D CR^%ZAPM.bs.BSTT
 F  S ny=$O(@(BSR_"(BST,ny)"))  Q:'ny  S nx="" F  S nx=$O(@(BSR_"(BST,ny,nx)"))  Q:nx=""  I $P(@(BSR_"(BST,ny,nx)"),"@",11),$P(@$ZR,"@",3) D
 .S i3=ny,i4=nx
 .I $P(@$ZR,"@",13)?.N1",".N S i3=+$P($P(@$ZR,"@",13),","),i4=+$P($P(@$ZR,"@",13),",",2)
 .S t1="{"_ny_","_nx_"} ",t2=$G(@(BSR_"(BST,""COL"",i3,i4,1)")) I $D(^(2)) S t2=@$ZR
 .I $D(@BSR@(BST,"COL",ny,nx,2)) S t2=@$ZR
 .S t2=$$TR^%ZAPM.bs.BSsFUNM(t2,"ny",ny)
 .S t2=$$TR^%ZAPM.bs.BSsFUNM(t2,"nx",nx) D:+$P(B,"@",35)  S:t2="" t2=" ИСХОДНЫЕ ТЕКСТЫ ФОРМУЛ ОТСУТСТВУЮТ !!!" S t0=t1_"--> "_t2 D CR^%ZAPM.bs.BSTT
 ..S lOg=$S($P(B,"@",35)=1:"9#2",1:$P(B,"@",35)),lOg=$P(lOg,"#",2)
 ..S t1="" F lO=1:1 Q:+$P(lOg,",",lO)=0  S t1=t1_$$A^%ZAPM.bs.BSA(ny,+$P(lOg,",",lO))_" "
 ..F iii=2:1 Q:$P(t2,"{",iii)=""  S ii=$P($P(t2,"{",iii),"}") D  I ii?.N1",".N,$D(@(BSR_"(BST,"_ii_")")),$P($P(@$ZR,"@",18),"#",2)'="" S t2=$P(t2,"{",1,iii-1)_"{§"_$P($P(@$ZR,"@",18),"#",2)_"§}"_$P($P(t2,"{",iii,9999),"}",2,9999)
 ...X "S i1="_$P(ii,","),"S i2="_$P(ii,",",2) S ii=i1_","_i2
 ..S t2=" "_$$TR^%ZAPM.bs.BSsFUNM($$TR^%ZAPM.bs.BSsFUNM(t2,"{§","["),"§}","]")
 .Q:'$E($P(B,"@",48),1)  S t0=" ----> "_$G(^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1",$NA(@BSR@(BST,ny,nx))),"???") D CR^%ZAPM.bs.BSTT
 S Obraz=@%BS(20)@("TextEdit"),Obraz(1)="Логические ошибки" D CREAT^%ZAPM.bs.BSTT
 S IYI=BSr_","_BSt,BSR=s3,BST=s4,se=s1,ke=s2 Q:$D(uzel)
 D NE^%ZAPM.bs.BSN
 Q
PROK //ПРОКАЧАТЬ ДЛЯ КАШИ
 S I="",G="^DDRm(""@S"")" F  S I=$O(@G@(I)) Q:I=""  D
 .S II=$P($P(I,"[",2),"]"),I1=$$TR^%ZAPM.bs.BSsFUNM(I,II,"""GLAVK"",""""")
 .S @G@(I1)=@G@(I) K @G@(I)
 .W !,I," - ",I1
 Q       
]]></Routine>


<Routine name="%ZAPM.bs.BSMDDR" type="MAC" languagemode="0"><![CDATA[
%BSMDDR ; НОВЫЙ DDR ; 10:58   28.11.1999
 Q
Z ;ЗАКАЧКА ИЗ БАЗЫ СТАРОГО ТИМОФЕЕВСКОГО ddRА В НОВЫЙ МОЙ
 ;N BD,BDN,I,II,III,F,S,K,P,W
 ;S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSDDR(""DDR"")") I '$$Data^%ZAPM.bs.BSF12(BD) W $$bel^%ZAPM.bs.BS3 Q
 ;S BDN=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""DDR"")") I '$$Data^%ZAPM.bs.BSF12(BDN) W $$bel^%ZAPM.bs.BS3 Q
 ;S I="" F  S I=$O(@BD@(I)) Q:I=""  S F=@BD@(I,"3,4") I F'="" D
 ;.I $G(@BD@(I,"5,4"))="" Q
 ;.I $G(@BD@(I,"4,4"))="" Q
 ;.S S=$P(@BD@(I,"5,4"),",",2),S=$S(S=+S:S,1:$C(34)_S_$C(34)),S="^"_@BD@(I,"4,4")_$P(@BD@(I,"5,4"),",")_"("_S_")"
 ;.S P=$G(@BD@(I,"18,4")),W=$G(@BD@(I,"19,4")),K=$G(@BD@(I,"23,4")),PI="ПКЗ,ГРП,СУМ,"
 ;.F II="K","S","P","W","PI" I @II'="" S @BDN@(F,"^",II)=@II
 ;.F II=7:1:16 I $D(@BD@(I,II_",4")) S @BDN@(F,II-7,"F")=$P(@BD@(I,II_",4"),"#") I @BD@(I,II_",4")["#" S @BDN@(F,II-7,"M")="Y"
 Q
ZZ ;ПРОКАЧКА БАЗЫ НОВОГО DDR ДАТЫ ПРИВЕДЕНИЯ
 ;N BD,BDN,I,II,III,F,S,K,P,W
 ;S BDN=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""DDR"")") I '$$Data^%ZAPM.bs.BSF12(BDN) W $$bel^%ZAPM.bs.BS3 Q
 ;S I="" F  S I=$O(@BDN@(I)) Q:I=""  D
 ;.I $D(@BDN@(I,0,"F")),@$ZR="$E({""ДАТ""},5,6)" S @$ZR="$E($$DatGuKBB({""ДАТ""}),1,2)"
 ;.I $D(@BDN@(I,1,"F")),@$ZR="$E({""ДАТ""},5,6)_$E({""ДАТ""},3,4)_$E({""ДАТ""},1,2)" S @$ZR="$$DatGuKBB({""ДАТ""})"
 Q
OTKAT ;УДАЛЕНИЕ УЗЛОВ БД РАНЕЕ ЗАНЕСЕННЫХ
 D 333^%ZAPM.bs.BSF
 N BD,LB,zzRrLast,PR
 S BD=$$Bd^%ZAPM.bs.BSMDDR1 Q:BD=""
 D CTRL^%ZAPM.bs.BSMDDR1(BSD,%KEYS(1),%KEYS(2),BD,1,"KILL")
 S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)=@zzRrLast
 D TW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMDDR0" type="MAC" languagemode="0"><![CDATA[
%BSMDDR0() ; пpогpамма ДЛЯ ТРАНСФОРМАЦИИ ОШИБОЧЕК ; 12:03  6-JAN-98
 N I,ZR W /CUP(11,1),$$atr^%ZAPM.bs.BS3(0) F I=1:1:12 W /EL(0),!
 I $D(@%BS("Tmp","BSD")@(ny)) S ZR=$ZR W $$clr^%ZAPM.bs.BS3(11),/CUP(11,1) D  W $$atr^%ZAPM.bs.BS3(0)
 .F I=1:1:12 W /EL(0),!
 .W /CUP(11,1) F I=1:1 Q:'$D(@ZR@(I))  W @$ZR,! Q:$Y>23
 Q d1
]]></Routine>


<Routine name="%ZAPM.bs.BSMDDR1" type="MAC" languagemode="0"><![CDATA[
%BSMDDR1 ;ДИСПЕТЧЕР ВВОДА ДАННЫХ (НОВЫЙ РЕЛИЗ); 18:24  7-APR-97 ; 17:34   20.06.2001
 Q
VVOD ;СЧИТЫВАНИЕ DOS-ФАЙЛА
 K %BS("Tmp","DosFiles")
int N S,TM,%IN,BP,BD,N,D,F,FN,%FN,%DEV,XN,LB,zzRrLast,S1,S2,T,TmpND,NEWFORMAT
 S TM=$$TMPG^%ZAPM.bs.BSF11 D REST(TM) D USE0 Q:'$D(%FN)
 S BD=$$Bd Q:BD=""
 S BP=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""BPO"")") I '$$Data^%ZAPM.bs.BSF12(BP) S @BP="восстановил "_$H ; D ErrMsg^%ZAPM.bs.BSXfun("Буфер "_BP_" не Доступен") Q
 S FN="" F  S FN=$O(@TM@(FN)) Q:FN=""  S N=@TM@(FN),F=$P(FN,"\",$L(FN,"\")) D
 .I '$D(GuiCall) I $D(@BP@("@HFS",N)) D Yes^%ZAPM.bs.BSXfun("ИЗ `"_$P(N,"?",3)_"` ДОКУМЕНТЫ УЖЕ ВВОДИЛ "_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$P(@$ZR,"?",1))_" :"_$P(@$ZR,"?",2)_". ПОВТОРИМ ?",2) I YES<1 K @TM@(FN) Q
 .S @BP@("@HFS",N)=$$h^%ZAPM.bs.BS3()_"?"_$G(%BS(12)) I $D(GuiCall) D
 ..N fN S fN=$P(FN,".",1,$L(FN,".")-1)
 ..I '$ZU(140,4,fN) S @BP@("@HFS",$ZU(140,1,fN)_"?"_$P(fN,"\",$L(fN,"\")))=$$h^%ZAPM.bs.BS3()_"?"_$G(%BS(12))
 D TempT^%ZAPM.bs.BSTT
 I $D(NEWFORMAT) D BP^%ZAPM.bs.BSBD1 G tm
 S FN="",TmpND=0 F  S FN=$O(@TM@(FN)) Q:FN=""  D Wait^%ZAPM.bs.BSXfun("обработка "_FN) S D="" F  S D=$O(@TM@(FN,D)) Q:D=""  D  X WA
 .S N="" F  S N=$O(@TM@(FN,D,N)) Q:N=""  S S=@TM@(FN,D,N) I S'="" S S1=$G(@TM@(FN,D,N+1)) D
 ..I N=1 S F=$P($P(S,"-=",2),"=") D
 ...D FORMAF^%ZAPM.bs.BSBD1
 ...S S2=S_S1 D RAZ(S2)
 ...S S=$E(S2,1,v) I $E(S2,v+1,9999)["+",$TR($E(S2,v+1,9999),"+=","")="" S S=S_"+++",S2="" S @TM@(FN,D,N+1)="" Q
 ...I $L($E(S2,v+1,9999))>($$LNG^%ZAPM.bs.BSF12-1) D PEREST($E(S2,v+1,9999),N) Q
 ...S @TM@(FN,D,N+1)=$E(S2,v+1,9999)
 ..S @BP@(F,ND,(N+1)_",2")=S
 .D U^%ZAPM.bs.BS3($NA(@BP@(F,ND)))
 .D CTRL(BP,F,ND,BD)
tm D SC ;AN
 K @TM
 I TmpND>0 D  
 .D TempTX^%ZAPM.bs.BSTT("    .... ИТОГО ВВЕДЕНО В БУФЕР ("_TmpND_") ДОКУМЕНТОВ")
 .D TempTXT^%ZAPM.bs.BSTT("ФАЙЛ *ФОРМА* ?НОМЕР ДОКУМЕНТА? //СТАТУС",$G(@%BS(20)@("TextEdit")))
 .I $D(GuiCall) W "<H3>"_$P($G(@BSr@(BSt)),"@",1)_"</H3>" D  W "<HR>" Q
 ..N S,ST,DIS,ND,CHE F i=1:1 Q:'$D(@BSr@(BSt,i))  S ST=$G(@BSr@(BSt,i))_" //"_$$STATUS($P($G(@BSr@(BSt,i)),"*",2),$P($G(@BSr@(BSt,i)),"?",2)) D
 ...I S="?" W ST Q
 ...W "<LI>"_i_".<input type='checkbox' "_DIS_" name='chDOC"_ND_"' value=0 size=35 "_CHE_" >"_ST
 . D TempTXTE^%ZAPM.bs.BSTT Q
 Q
STATUS(F,ND1) S ND=ND1,DIS="DISABLED",CHE=""  I F=""!(ND="") Q "?"
 S S=$G(@BP@(F,ND,"2,1"))
 I S=4 Q "Занесено в БД"
 I S=3 S DIS="",CHE="CHECKED" Q GREEN_"Готова к Занесению в БД"_EF
 Q RED_"Есть ошибки..."_S_EF
RAZ(S2) ;РАЗРЕЗ
 F v=80:-1:1 Q:$E(S2,v)="="
 I $E(S2,v)'="=" F v=80:1:$L(S2) Q:$E(S2,v)="="
 Q
PEREST(S3,N) ;ПРИМЕР РЕКУРСИИ !!!
 N I,II,v
PER S I=$O(@TM@(FN,D,""),-1) F II=I:-1:N+2 S @TM@(FN,D,II+1)=@TM@(FN,D,II)
 D RAZ(S3)
 S @TM@(FN,D,N+1)=$E(S3,1,v)
 I $L($E(S3,v+1,9999))>($$LNG^%ZAPM.bs.BSF12-1) S S3=$E(S3,v+1,9999),N=N+1 G PER
 S @TM@(FN,D,N+2)=$E(S3,v+1,9999)
 Q
SCANING S BP=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""BPO"")") G SC
SCAN D Yes^%ZAPM.bs.BSXfun("ПЕРЕНАСЧИТЫВАЕМ ОБЩЕЕ КОЛИЧЕСТВО ОШИБОК В БУФЕРЕ ПРЕДВВОДА ?",2) Q:YES<1
SC ;D Wait^%ZAPM.bs.BSXfun("сканирование буфера") 
 N C1,C2,C3
 S F="" F  S F=$O(@BP@(F)) Q:F=""  I F'["@" S (C3,C1,C2)=0 D  D SCANI
 .S N="" F  S N=$O(@BP@(F,N)) Q:N=""  I N'["@" D SCA X $G(WA)
 Q
SCANI S @BP@(F)="ВСЕГО="_(C3+C2+C1)_" "_$S(C3:"ОШИБОЧНЫХ="_C3,1:"")_" "_$S(C1:"ГОТОВЫХ "_C1,1:"")_" "_$S(C2:"ЗАНЕСЕНЫХ "_C2,1:"") Q
SCA I $G(@BP@(F,N,"2,1"))=3 S C1=C1+1 Q
 I $G(@BP@(F,N,"2,1"))=4 S C2=C2+1 Q
 S C3=C3+1
 Q
ZAP ;ЗАПИСЬ В БД
 S com="ЗАПИСЬ В БД ",F=$P($$CHOIS^%ZAPM.bs.BSMDDR2(com,"Z"),"§",2) Q:F=""
 S BD=$$Bd Q:BD=""
 I F'=" " D ZAPI(F) G ZAPIS
 S F="" F  S F=$O(@BP@(F)) Q:F=""  D ZAPI(F)
ZAPIS D OkMsg^%ZAPM.bs.BSXfun(com_"ЗАВЕРШЕН") Q
ZAPI(F) N N,S,K,C3,C1,C2 S (C3,C1,C2)=0
 D Wait^%ZAPM.bs.BSXfun($NA(@BP@(F)))
 S N="" F  S N=$O(@BP@(F,N)) Q:N=""  I N'["@" D
 .D CTRL(BP,F,N,BD,1)
 .D SCA X WA
 D SCANI
 Q
SIN ;СИНТАКСИЧЕСКИЙ КОНТРОЛЬ
 S com="СИНТАКСИЧЕСКИЙ КОНТРОЛЬ ",F=$P($$CHOIS^%ZAPM.bs.BSMDDR2(com,"S"),"§",2) Q:F=""
 S BD=$$Bd Q:BD=""
 I F'=" " D SINT(F) G SINTX
 S F="" F  S F=$O(@BP@(F)) Q:F=""  D SINT(F)
SINTX D OkMsg^%ZAPM.bs.BSXfun(com_"ЗАВЕРШЕН") Q
SINT(F) N N,S,K,C3,C1,C2 S (C3,C1,C2)=0
 D Wait^%ZAPM.bs.BSXfun($NA(@BP@(F)))
 S N="" F  S N=$O(@BP@(F,N)) Q:N=""  I N'["@" D CTRL(BP,F,N,BD),SCA X WA
 D SCANI
 Q
Bd() S BD=$$KBD^%ZAPM.bs.BSF12($$DDRTOBD^%ZAPM.bs.BSBD)
 I '$$Data^%ZAPM.bs.BSF12(BD) D ErrMsg^%ZAPM.bs.BSXfun("База Описания Ввода "_BD_" не Доступна") Q ""
 Q BD
CTRL(BP,F,ND,BD,Z,uzel) 
 ;Z="" СИНТ. КОНТРОЛЬ ДОКУМЕНТА
 ;Z=1 ЗАНЕСЕНИЕ В БД
 ;Z=1,$G(uzel)'="" ЛОГ. КОНТРОЛЬ ДОКУМЕНТА БЕЗ ЗАНЕСЕНИЯ В БД
 ;Z=1,$G(uzel)="KILL" ОТКАТ-УДАЛЕНИЕ УЗЛОВ БД ДОКУМЕНТА
 ;BP-МАСССИВ БПО
 ;F - ИМЯ ФОРМЫ
 ;ND - НОМЕР ДОКУМЕНТА
 N N,S,K,STOP,P,PO,LB1,LB2,OS,OSN,ls,GG,d,bd,bd1,Ke,KK,Wt,REC,RECK,DUBL,POK,KEYALL
 N OldP,rlo,PLU,REC1,RECK1,oTl,KaE,LastKey,ErrKey
 I $G(@BP@(F,ND,"2,1"))=4 S zzRrLast=$ZR Q:$G(uzel)=""
 D L^%ZAPM.bs.BS3($NA(@BP@(F,ND)),1) I 'LOC Q  ;ЗАЛОКИРОВАН
 D CTT
 D U^%ZAPM.bs.BS3($NA(@BP@(F,ND)))
 Q
CTT S OS=0,OldP=$G(@BP@(F,ND,"2,1"))
 S @BP@(F,ND,"2,1")="",zzRrLast=$ZR F N=2:1 Q:'$D(@BP@(F,ND,N_",2"))  K @BP@(F,ND,N)
 I '$D(@BD@(F)) D PROT(2,"НА ФОРМУ "_F_" НЕТ ОПИСАНИЯ В "_BD),ER(1,"1 !!!") Q
 I '$D(LB(F)) S GG=$$LBD($NA(@BD@(F)),$G(Z)) I 'GG D PROT(2,GG) Q
 I $G(LB(F,"XECTIME"))=2 X $G(LB(F,"XEC")) Q  ;СПЕЦ.ПРОГА ДЛЯ ВВОДА ИЗ БПО
 ;D x^%ZAPM.bs.BS3(1)     ;---//--- для msm 4.x.x
 D LO I S(2)["NODE_DDR" D CTT^%ZAPM.bs.BSBD1 Q
 F K=0:1:9 I $D(LB(F,K)) S LastKey=K I '$D(LB(F,K,1)) D CTRK(K,.Ke) Q:$D(ErrKey)  S Ke(K)=d
 I $D(ErrKey) D PROT(2,"ОШИБКА В ОПИСАНИИ КЛЮЧА "_K) Q
 S KK=LastKey ;ПОСЛЕДНИЙ КЛЮЧ
 S %zT=$ZT,$ZT="ERPOK^%ZAPM.bs.BSMDDR1"
 S bd=$P(LB(F,"KEY"),"@")_$G(Ke(0))
 I '$$Data^%ZAPM.bs.BSF12(bd) S @bd="BSD - MSW@" ;D PROT(2,"НЕ ДОСТУПНА БАЗА "_bd_" !  ВОЙДИТЕ НА 0-Й КЛЮЧ И СОЗДАЙТЕ НОВЫЙ УЗЕЛ БАЗЫ ДАННЫХ") Q
 F K=0:1:9 I $D(LB(F,K,1)) S LB1(K)=$P(LB(F,K),$C(34),2),LB2($P(LB(F,K),$C(34),2))=K
ctr K ls,POK I $G(LB(F,"W"))="!!!" S Wt=1 ;РАЗРЕШИТЬ ДУБЛИРОВАНИЕ
 S N=1 F  S N=$O(S(N)) Q:N=""  S OSN=0 D  I OSN D ER("в"_(N-1),OSN)
 .F P=1:1 Q:$P(S(N),"=",P,P+1)=""  S PO=$P(S(N),"=",P) D
 ..I PO["++" S PLU=N Q
 ..Q:PO["--"!(PO="")  I N=2 Q:PO=F
 ..D d
 ..I $G(LB(F,"PI"))[(PO_",") Q
 ..I $G(LB(F,"W"))=PO D  Q
 ...I d=0,$G(uzel)'="KILL" D PROT(N,"ПОКАЗАТЕЛЬ "_PO_d_" ТРЕБУЕТ УДАЛЕНИЕ ДОКУМЕНТА ! ЭТО МОЖНО ВЫПОЛНИТЬ КОМАНДОЙ <ALT-F2> --> <ОТКАТ>") S OS=OS+1,OSN=OSN+1 Q
 ...S Wt=$S(d=1:1,1:PO) Q
 ..I '$D(LB(F,"I",PO)) D
 ...D PROT(N,"НЕСУЩЕСТВУЮЩИЙ ПОКАЗАТЕЛЬ "_PO_" !!!") S OS=OS+1,OSN=OSN+1 K ls
 ..I $D(LB(F,"I",PO,1)) D
 ...I $D(LB(F,"SPO")),LB(F,"SPO")[(PO_",") Q  ;СНЯТИЕ КОНТРОЛЯ
 ...S YES=1 X LB(F,"I",PO,1) I 'YES D PROT(N,PO_"="_d_" !!! "_$G(ls,"СИНТ.ОШИБКА")) S OS=OS+1,OSN=OSN+1 K ls Q
 ..I $G(Z)=2,$G(LB(F,"I",PO))["@" S REC(PO)=d
 ..I '$D(LB(F,"P")) D
 ...I $D(POK(PO)) D PROT(N,"ПОКАЗАТЕЛЬ "_PO_d_" ДУБЛИРУЕТСЯ ! УЖЕ БЫЛ В "_POK(PO)_" СТРОКЕ") S OS=OS+1,OSN=OSN+1 Q
 ...I '$D(POK(PO)) S POK(PO)=N-1
 ..I $D(LB2(PO)) D  K POK Q
 ...I $D(LB(F,"KEY",LB2(PO),1)) D
 ....I $D(LB(F,LB2(PO),2)) Q
 ....S YES=1 X LB(F,"KEY",LB2(PO),1) I 'YES D PROT(N,PO_"="_d_" !!! "_$G(ls,"СИНТ.ОШИБКА")) S OS=OS+1,OSN=OSN+1 K ls Q
 ...I d="" D PROT(N,"КЛЮЧ НОМЕР "_LB2(PO)_" ПУСТОЙ !") S OS=OS+1,OSN=OSN+1 Q
 ...S Ke(LB2(PO))=d
 ...I KK=LB2(PO) S KaE=1 D
 ....S bd1=bd
 ....I $D(LB(F,"P")) D
 .....F K=1:1:KK-1 Q:'$D(Ke(K))  S bd1=$NA(@bd1@(Ke(K))) ;```:KK-1
 .....I $G(Z)'=2,$G(uzel)="" D RECCHP K REC1,RECK1 S REC1=bd1,RECK1=Ke(KK) I $G(LB(F,"I",PO))["@" S REC1(PO)=d
 ....I '$D(LB(F,"P")) D
 .....F K=1:1:KK Q:'$D(Ke(K))  S bd1=$NA(@bd1@(Ke(K)))
 .....I $G(uzel)="",$D(@bd1),'$G(Wt) D PROT(N,bd1_". УЖЕ СУЩЕСТВУЕТ И НЕТ "_$G(Wt,"""КОР1""")) S OS=OS+1 Q
 .....I $G(uzel)="",$D(DUBL(bd1)) D PROT(N,bd1_" УЖЕ ВСТРЕЧАЛОСЬ В ЭТОМ ДОКУМЕНТЕ, В СТРОКЕ "_DUBL(bd1)) S OS=OS+1 Q
 ....S DUBL(bd1)=N-1
 ....I $G(Z)=2 D REC K REC,RECK S REC=bd1,RECK=Ke(KK) I $G(LB(F,"I",PO))["@" S REC(PO)=d
 I '$D(PLU) D PROT(N,"НЕТ НОРМАЛЬНОГО ЗАВЕРШЕНИЯ ДОКУМЕНТА ""=+++"" !") S OS=OS+1,OSN=OSN+1
 I '$D(KaE),'$D(LB(F,"Singl")) D  D PROT(N,"КЛЮЧ !!! НЕ ЗАВЕРШИЛСЯ ПОСЛЕДНИМ !") S OS=OS+1,OSN=OSN+1
 I $D(LB(F,"Singl")) S bd1=$$SingB I $D(@bd1),'$G(Wt) D PROT(N,bd1_".. УЖЕ СУЩЕСТВУЕТ И НЕТ "_$G(Wt,"""КОР1""")) S OS=OS+1 Q
 I $D(LB(F,"P")),$G(Z)'=2 D RECCHP K REC1,RECK1
 I 'OS S:$G(uzel)="" @BP@(F,ND,"2,1")=3 I $G(Z)=1 K REC,DUBL S Z=2 G ctr
 I OS D ER(" всего",OS) Q
 I $G(Z)=2 D REC S:$G(uzel)'="" @BP@(F,ND,"2,1")=OldP I "KILL"'[$G(uzel) S $P(@BP@(F,ND,"INF"),"?",6)=$S($D(oTl):"",1:+$G(rlo))
 I $G(uzel)="KILL" S Z="" K REC,DUBL,uzel G ctr ;ЭМУЛЯЦИЯ СИНТ.КОНТРОЛЯ
 Q
SingB() ;ФОРМИРОВАНИЕ ССЫЛКИ БД
 N bd1
 S bd1=bd F K=1:1:9 Q:'$D(Ke(K))  S bd1=$NA(@bd1@(Ke(K)))
 Q bd1
REC N K,KK
 S %zT=$ZT,$ZT="ERREC^%ZAPM.bs.BSMDDR1"
 I $D(LB(F,"XEC")) X LB(F,"XEC")
 I $D(LB(F,"Singl")),$D(REC)="10" D  G REs
 .S REC=$$SingB
 Q:'$D(RECK)
REs D L^%ZAPM.bs.BS3(REC,1) I 'LOC D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ЛОКИРОВАНИЯ УЗЛА "_REC) Q
 I $G(uzel)="KILL" D  G RE1
 .D Yes^%ZAPM.bs.BSXfun("УДАЛЯЕМ УЗЕЛ "_REC_" ! ВЫ ХОРОШО ПОДУМАЛИ ?") Q:YES<1  K @REC
 I $D(uzel) D  G RE1
 .D L^%ZAPM.bs.BS3(LB(F,"S"),1) I 'LOC Q  D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ЛОКИРОВАНИЯ ТОБД "_LB(F,"S")) Q
 .S uzel="# Док."_ND_" узел "_REC D LOGREC^%ZAPM.bs.BSMDDR2 S rlo=$G(rlo)+$G(lo)
 .D U^%ZAPM.bs.BS3(LB(F,"S"))
 D RE S @BP@(F,ND,"2,1")=4
RE1 D U^%ZAPM.bs.BS3(REC)
 Q
RE I $D(LB(F,"P")) D  D record(REC),re Q
 .F K=1:1 Q:$P(LB(F,"I",LB(F,"P")),"@",K,K+1)=""  I $P(LB(F,"I",LB(F,"P")),"@",K)=RECK D  Q
 ..S KK="" F  S KK=$O(REC(KK)) Q:KK=""  D
 ...I $P(LB(F,"I",KK),"@",K)="" D PROT(N,"ОШИБКА НАСТРОКИ !!! В ТОБД НА """_LB(F,"P")_"""="_RECK_" ПОКАЗАТЕЛЬ "_KK_" НЕ ХРАНИТСЯ В БД !") S OS=OS+1,OSN=OSN+1 Q
 ...D rec($NA(@REC@($P(LB(F,"I",KK),"@",K))),REC(KK))
 S KK="" F  S KK=$O(REC(KK)) Q:KK=""  D rec($NA(@REC@($P(LB(F,"I",KK),"@",2))),REC(KK))
 D record(REC),re
 Q
re D record($NA(@BP@(F,ND))) Q
record(g) S @g=$$h^%ZAPM.bs.BS3()_","_$G(%BS(12))_",1" Q
rec(g,d) I d="" K @g Q
 S @g=d Q
d S (d,d1,d0)=$E(PO,4,9999),PO=$E(PO,1,3) Q
RECCHP ;КОНТРОЛЬ МНОГОЛИНЕЙНЫХ ТОБД
 Q:'$D(RECK1)
 N K,KK
 I $D(@bd1),'$G(Wt) D PROT(N,bd1_"... УЖЕ СУЩЕСТВУЕТ И НЕТ "_$G(Wt,"""КОР1""")) S OS=OS+1 Q
 ;???I $D(DUBL(bd1)) D PROT(N,bd1_" УЖЕ ВСТРЕЧАЛОСЬ В ЭТОМ ДОКУМЕНТЕ, В СТРОКЕ "_DUBL(bd1)) S OS=OS+1 Q
 F K=1:1 Q:$P(LB(F,"I",LB(F,"P")),"@",K,K+1)=""  I $P(LB(F,"I",LB(F,"P")),"@",K)=RECK1 D  Q
 .S KK="" F  S KK=$O(REC1(KK)) Q:KK=""  D
 ..I $P(LB(F,"I",KK),"@",K)="" D PROT(N,"ОШИБКА НАСТРОКИ !!! В ТОБД НА """_LB(F,"P")_"""="_RECK1_" ПОКАЗАТЕЛЬ "_KK_" НЕ ХРАНИТСЯ В БД !") S OS=OS+1,OSN=OSN+1 Q
 Q
ERPOK D PROT($G(Iv,2),"!ПОКАЗАТЕЛЬ! "_$G(PO)_" !!! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT),OS=OS+1 Q
ERREC D PROT($G(Iv,2),"ОШИБКА ПРИ ЗАПИСИ В БД!!! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT),OS=OS+1 Q
CTRK(K,%KEYS) ;КОНТРОЛЬ КЛЮЧЕЙ ИЗ НЕПОВТОРЯЮЩИХСЯ ПОКАЗАТЕЛЕЙ
 N FO,d1,d0,YES,Iv,ls,%NAm,ii
 S %zT=$ZT,$ZT="ERKEY^%ZAPM.bs.BSMDDR1"
 S %NAm=$$BSD^%ZAPM.bs.BSA($P(LB(F,"KEY"),"@"),$G(%KEYS(0))) F ii=1:1:9 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 S FO=$$TR^%ZAPM.bs.BSsFUNM(LB(F,K),"{","$$FOR("),FO=$$TR^%ZAPM.bs.BSsFUNM(FO,"}",")")
 X "S (d1,d,d0)="_FO
 I d="" D PROT(2,"КЛЮЧ НОМЕР "_K_" ПУСТОЙ !") S OS=OS+1 Q
 I $D(LB(F,"KEY",K,1)) D
 .I $D(LB(F,K,2)) Q
 .X LB(F,"KEY",K,1) I 'YES D PROT($G(Iv,2),"ОШИБКА ДАННЫХ КЛЮЧА НОМЕР "_K_" "_$G(ls)) S OS=OS+1 K ls Q
 Q
ERKEY D PROT($G(Iv,2),"!!!КЛЮЧ "_K_" !!! "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) S OS=OS+1
 S ErrKey=1 Q
DatGuKBB(D) ;ДАТУ ОТЧЕТА ДДММГГ-->ПРИВОДИТ НА ГГГГММ28
 N G,M  ;Y2000 УДАЛИТЬ МОДУЛЬ !!!!!!!!
 S D=$$REVERS^%ZAPM.bs.BSsFUNR(D)
 I '$$DAT^%ZAPM.bs.BSsFUNR(6,D) Q "???" ;Y2000
 S G=$$Y^%ZAPM.bs.BSsFUNR(D),M=+$$M^%ZAPM.bs.BSsFUNR(D),D=+$$D^%ZAPM.bs.BSsFUNR(D) I D'>20 S M=M-1
 I $D(F),"\15101\15301\50404\15203\55102\15201\55101\14205\55105\15202\20601\55103\55106\"[("\"_F_"\") S M=M-1
 I M<1 S G=G-1,M=12
 I G<0 S G=99
 S:G?1N G="0"_G S:M?1N M="0"_M
 S G=$$ADDYEAR^%ZAPM.bs.BSsFUNR(G)
 Q G_M_"28"
FOR(P) ;ФУНКЦИЯ {}
 S Iv=1 F  S Iv=$O(S(Iv)) Q:Iv=""  I ("="_S(Iv))[("="_P) Q
 Q $P($P(("="_S(Iv)),("="_P),2),"=")
LO F N=2:1:301 I $G(@BP@(F,ND,N_",2"))'=""  S S(N)=@$ZR,S=N
 Q
ER(S,K) S @BP@(F,ND,"2,1")=$G(@BP@(F,ND,"2,1"))_S_"="_K_" " Q  ;КОЛИЧЕСТВО ОШИБОК
LBD(G,K) ;СОЗДАНИЕ ЛОКАЛЯ ПО ТОБЗ
 N I,II,BS,IM,VT,GG,GGG,Iz,QQ
 I $S<25000 D SIZE^%ZAPM.bs.BSN(25) I $S<25000 K LB
 F I=0:1:9 I $D(@G@(I,"F"))  S LB(F,I)=@$ZR D
 .I $D(@G@(I,"SKO")) S LB(F,I,2)="Y"
 .I $D(@G@(I,"M")),'$D(NEWFORMAT) S LB(F,I,1)="Y",QQ=1 //!!!!!!!!!!!!! ЕСЛИ ЧТО-ТО СЛОМАЕТСЯ $D(NEWFORMAT)
 I '$D(QQ) S LB(F,"Singl")=1
 F I="PI","S","P","W","NK","SPO","XEC","XECTIME" I $D(@G@("^",I)) S LB(F,I)=@$ZR
 I '$D(LB(F,"S")) Q "НЕ ОПИСАНА ССЫЛКА на ТОБД В "_G
 S GG=LB(F,"S") I GG["#" D  Q GGG
 .F Iz=1:1 Q:$P(LB(F,"S"),"#",Iz,Iz+1)=""  S GG=$P(LB(F,"S"),"#",Iz),GGG=$$l(GG)
 Q $$l(GG)
l(GG) I '$$Data^%ZAPM.bs.BSF12(GG) Q "НЕДОСТУПНА ТАБЛИЦА ОПИСАНИЯ БД "_$G(GG)
 I $P(@GG,"@",17)'=2 Q "ТАБЛИЦА "_$G(GG)_" НЕ ЯВЛЯЕТСЯ ТОБД"
 D Copy^%ZAPM.bs.BSF8($NA(@GG@("KEY")),$NA(LB(F,"KEY")))
 F II=0:1:9 I $D(LB(F,"KEY",II)) F I=10:1 Q:'$D(LB(F,"KEY",II,I))  K LB(F,"KEY",II,I)
 F I=1:1 Q:'$D(@GG@(I))  F II=1:1 Q:'$D(@GG@(I,II))  S BS=@$ZR D
 .Q:$P($P(BS,"@",18),"#",2)=""  S IM=$P($P(BS,"@",18),"#",2) K VT
 .I $P(BS,"@",16)'="" D  ;СИНТАКСИС
 ..I $P(BS,"@",16)="0" S VT=$G(@GG@("RTR",I,II)) Q
 ..S VT=$G(@GG@("RTR",+$P($P(BS,"@",16),","),+$P($P(BS,"@",16),",",2)))
 .I IM=$G(LB(F,"P")) S $P(LB(F,"I",IM),"@",I)=$P($G(@GG@(I,$G(LB(F,"NK"),II))),"@",15) Q
 .I $G(K),$P(BS,"@",9)=2 D
 ..I $D(uzel) S LB(F,"L",IM)=I_","_II
 ..I $D(LB(F,"P")) S $P(LB(F,"I",IM),"@",I)=$S($P($P(BS,"@",18),"#")'="":$P($P(BS,"@",18),"#"),1:I_","_II) Q
 ..S $P(LB(F,"I",IM),"@",2)=$S($P($P(BS,"@",18),"#")'="":$P($P(BS,"@",18),"#"),1:I_","_II)
 .S:$G(LB(F,"I",IM))'["@" LB(F,"I",IM)=""
 .I $D(VT) S LB(F,"I",IM,1)=VT
 Q 1
PROT(N,TX) ;ЗАПИСЬ ПРОТОКОЛА
 N NN
 I 'N S N=2
 S $ZT="PROTERR"
 S NN=$O(@BP@(F,ND,N,""),-1)+1,@BP@(F,ND,N,NN)=TX I $D(GuiCall) w "<LI>"_F_" #"_ND_" "_RED_TX_EF
 Q
PROTERR 
 I $ZE["<WRITE" H
 Q
REST(TM) N fT1,fT2,i
 I '$D(GuiCall) D DOSREAD^%ZAPM.bs.BSS1 I '$D(%FN) Q
 I $D(%BS("Tmp","DosFiles")) S XN="" F  S XN=$O(%BS("Tmp","DosFiles",XN)) G:XN="" XNE D XNOPN I $D(%FN) D XN
XN //работаем файл
 D USE0 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSMDDR1"
 q:'$D(%DEV)  S FR=%DEV D CLO 
 I $P(%FN,".",$L(%FN,"."))'="",",jpg,bmp,doc,rtf,xls,cdr,avi,mp3,wav,html,htm,tab,ppt,pps,"[(","_$$LITL^%ZAPM.bs.BSsFUNM($P(%FN,".",$L(%FN,".")))_",") g Vi
 K fT1,fT2 D File2Arr^%ZAPM.bs.BSCEXE(%FN,.fT1),STR2MAS^%ZAPM.bs.BSCmail(.fT1,.fT2,$C(13,10)) K fT1 S i="" F  S i=$O(fT2(i)) Q:i=""  I $G(fT2(i))'="" S fT1(i)=fT2(i) I $G(fT1)="" S fT1=i
 S %IN=$G(fT1(fT1)) K fT2 M fT2=fT1 //первая строчка файла
 ; U %DEV R %IN
RES I %IN'["%BS-SCANINIG"&(%IN'["%BS-FORMAT")  D SCAN^%ZAPM.bs.BSF11(%FN) I 'YES G Vi ;ПРЕДСКАНИРОВАНИЕ ФАЙЛА
 S S=%IN
 D USE0 D Wait^%ZAPM.bs.BSXfun("Ввод ИНФОРМАЦИИ из "_%FN) S @TM@(%FN)=$$FILE^%ZAPM.bs.BSDOS(%FN,1)_"?"_$P(%FN,"\",$L(%FN,"\"))
 I S["%BS-FORMAT" D PFLREAD^%ZAPM.bs.BSBD1 Q
 S D=0,SS=""
 ;D  F  U %DEV R S Q:$ZC'=0  D  I '(D#10) D USE0  X WA ;`CACHE'
 S i="" F  S i=$O(fT2(i)) Q:i=""  S S=fT2(i) D
 .I S["%BS-SCANINIG" Q
 .I $TR(S," ","")="" Q
 .I S["-=" S D=D+1,N=0,SS=""
 .S SS=SS_S
 .I S'["=" Q
 .S N=N+1,@TM@(%FN,D,N)=SS,SS=""
Vi I '$D(N) D USE0 D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ФОРМАТА ДОКУМЕНТА '"_%FN) K %FN G EEE
 I (SS_S)'="",$G(@TM@(%FN,D,N))'=(SS_S) S N=N+1,@TM@(%FN,D,N)=SS_S //закрытие докумета в БПО
EEE S $ZT=$G(%zT) D CLO
 Q //работать с текущим закончили
ERFILE I $ZE["<ENDOFFILE"  G Vi
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) G CLO
XNOPN //открываем текущий файл
 ;N DOS K %DEV,%FN S DOS=$$OpenDOS^%ZAPM.bs.BSXdos() Q:DOS<0
 ;Q:$$Open^%ZAPM.bs.BSXdos(XN,"R")<0  S %DEV=DOS,
 S (%DEV,%FN)=XN
 Q
XNE K %BS("Tmp","DosFiles") //закрываем список файлов
CLO D USE0
 C:$D(%DEV) %DEV 
 Q
USE0 I '$D(GuiCall) U 0
 E  U GuiI
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMDDR2" type="MAC" languagemode="0"><![CDATA[
%BSMDDR2 ; ЗАПИСЬ В БАЗУ, ПРОТОКОЛ & ETC ; 12:29   28.11.99
 Q
NEWYEAR ;ПЕРЕНУМЕРАЦИЯ
 N li
 S BP=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""BPO"")") I '$$Data^%ZAPM.bs.BSF12(BP) D ErrMsg^%ZAPM.bs.BSXfun("Буфер "_BP_" не Доступен") Q
 S li=$$LineEdit^%ZAPM.bs.BSXfun(+$G(@BP@("@Last")),"Вводите\Корректируйте НОМЕР для "_BP)
 I YES>0 S @BP@("@Last")=+li K @BP@("@HFS")
 Q
CellTab(T,Z) ;ФУНКЦИЯ ВЫЗОВА ТАБЛИЦЫ И ВОЗВРАТ КЛЕТКИ
 N BSr,BSt,IYI,MaS
 S $ZT="ER^%ZAPM.bs.BSMDDR2"
 S li=$G(@%BS("Tmp","BSD")@(T))
Cell I li="" D BEL(T) Q
 D TIR^%ZAPM.bs.BST4 I li="" G ER
 S (MaS,YES)=1
 D RII^%ZAPM.bs.BSF3 I YES<1 S li="" G ER
 S IYI=BSr_"("_BSt D ENTER^%ZAPM.bs.BSN I date="" S li="" Q
 I '$G(Z) S li=$P(%BS("Tmp","LastTabl"),"@")
 S:$G(Z) li="" Q
ER W $$bel^%ZAPM.bs.BS3 Q
BEL(T) D ErrMsg^%ZAPM.bs.BSXfun("Данные В узле '"_T_"' Отсутствуют или не записаны в Базу Данных")
 q
CTKBD ;КОНТРОЛЬ ИЗ КАРТЫ БД
 D 333^%ZAPM.bs.BSF
 N BD,LB,zzRrLast
 S BD=$$Bd^%ZAPM.bs.BSMDDR1 Q:BD=""
 D CTRL^%ZAPM.bs.BSMDDR1(BSD,%KEYS(1),%KEYS(2),BD)
 I $D(zzRrLast) S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)=@zzRrLast I @zzRrLast=4 D ErrMsg^%ZAPM.bs.BSXfun("СИНТ.КОНТРОЛЬ ДЕЛАТЬ НЕ БУДУ! ДОКУМЕНТ ЗАНЕСЕН") Q
 D TW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 D OkMsg^%ZAPM.bs.BSXfun("КОНТРОЛЬ ПРОИЗВЕДЕН...")
 Q
LOGCON ;ЛОГ. КОНТРОЛЬ ИЗ КАРТЫ БД
 D 333^%ZAPM.bs.BSF
 N BD,LB,zzRrLast,PR,NUM,%BS,loo,lo
 S BD=$$Bd^%ZAPM.bs.BSMDDR1 Q:BD=""  D LV^%ZAPM.bs.BSF4
 K ^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1"),^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1")
 S %BS(15)=999,%BS(13)="%BS-WS" ;???
 D CTRL^%ZAPM.bs.BSMDDR1(BSD,%KEYS(1),%KEYS(2),BD,1,1)
 G LOGIC
LOG ;ЛОГИЧЕСКИЙ КОНТРОЛЬ
 N l,j,TRe1,TRe2,ii,%iii,NOKILLER,KILLER,lo,loo
 S com="ЛОГИЧЕСКИЙ КОНТРОЛЬ ",F=$P($$CHOIS(com,"L"),"§",2) Q:F=""
 S BD=$$Bd^%ZAPM.bs.BSMDDR1 Q:BD=""
 K ^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1"),^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1")
 I F'=" " D LOGI(F) G LOGIC
 D Yes^%ZAPM.bs.BSXfun("ЛОГ.КОНТРОЛЬ ПО ВСЕМ !!!,ВЫ УВЕРЕНЫ ?") Q:YES<1  S F="" F  S F=$O(@BP@(F)) Q:F=""  D LOGI(F)
LOGIC I '$D(^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1")) D OkMsg^%ZAPM.bs.BSXfun("ПРОСМОТРЕНО "_+$G(loo)_" УЗЛОВ В ДОКУМЕНТАХ. ЛОГИЧ.ОШИБОК НЕ НАЙДЕНО") G ENDD
 S I="LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1"
 d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSbufB","LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1") K ^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u1"),^%ZAPM.bs.BSbufB("VarLogS"_$G(%BS(3),$P)_$J_"u1")
ENDD Q
rec(Y,X,d) I d="" Q
 S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),Y,X)=d Q
LOGI(F) N N,S,K,C3,C1,C2 S (C3,C1,C2)=0
 D Wait^%ZAPM.bs.BSXfun($NA(@BP@(F)))
 S N="" F  S N=$O(@BP@(F,N)) Q:N=""  I N'["@" D
 .I "34"[$G(@BP@(F,N,"2,1")) D CTRL^%ZAPM.bs.BSMDDR1(BP,F,N,BD,1,1)
 .D SCA^%ZAPM.bs.BSMDDR1 X WA
 D SCANI^%ZAPM.bs.BSMDDR1
 Q
LOGREC ;ДЕЛАЕМ БУФЕР И КОНТРОЛЬ
 K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),oTl
 S %NAm=$E(REC,1,$L(REC)-1)_",",li=LB(F,"S"),loo=$G(loo)+1
 I $D(LB(F,"P")) D  G LO
 .F K=1:1 Q:$P(LB(F,"I",LB(F,"P")),"@",K,K+1)=""  I $P(LB(F,"I",LB(F,"P")),"@",K)=RECK D  Q
 ..S KK="" F  S KK=$O(REC(KK)) Q:KK=""  D
 ...I $P(LB(F,"I",KK),"@",K)["," D rec(+$P($P(LB(F,"I",KK),"@",K),","),+$P($P(LB(F,"I",KK),"@",K),",",2),REC(KK)) Q
 ...S oTl=1
 S KK="" F  S KK=$O(REC(KK)) Q:KK=""  D rec($P(LB(F,"L",KK),","),$P(LB(F,"L",KK),",",2),REC(KK))
LO I $D(oTl) D PROT^%ZAPM.bs.BSMDDR1(2,"ЛОГ.КОНТР.ИЗ ""DDR"" ПРОИЗВЕСТИ НЕВОЗМОЖНО") S $ZT=$G(%zT) Q
 D  ;МОДУЛЬ КОНТРОЛЯ
 .N (uzel,%BS,vl,BSD,Ke,%NAm,li,lo) S PO="Лог.Контр."
 .D TIR^%ZAPM.bs.BST4 I li="" D PROT^%ZAPM.bs.BSMDDR1(2,"ЛОГ.КОНТР! "_li_" !!! "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
 .D RII^%ZAPM.bs.BSF3 S BSR=BSr,BST=BSt,(nx,ny)=1
 .S K="" F  S K=$O(Ke(K)) Q:K=""  S %KEYS(K)=Ke(K),@("k"_K)=Ke(K)
 .D TIP^%ZAPM.bs.BST
 .D COL^%ZAPM.bs.BSF3
 Q
ERL D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
CHAN N TI S TI=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1),1)
 S TI=$$LineEdit^%ZAPM.bs.BSXfun(TI,"Меняйте ПРИЗНАК обработки (*2*-ошибки,3-готова,4-занесена)") Q:YES<1
 S ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)=TI,$P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1 D TW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 Q
ZAPBD ;ЗАПИСЬ В БД И КОНТРОЛЬ ИЗ КАРТЫ БД
 D 333^%ZAPM.bs.BSF
 N BD,LB,zzRrLast,PR
 S BD=$$Bd^%ZAPM.bs.BSMDDR1 Q:BD=""
 I $G(@BSD@(%KEYS(1),%KEYS(2),"2,1"))=4 D ErrMsg^%ZAPM.bs.BSXfun("УЖЕ ЖЕ ЗАНЕСЕНО ?!!!...") Q
 D CTRL^%ZAPM.bs.BSMDDR1(BSD,%KEYS(1),%KEYS(2),BD,1)
 S (PR,^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1))=@zzRrLast
 I PR<4 D ErrMsg^%ZAPM.bs.BSXfun("ЕСТЬ ОШИБКИ !!! ИСПРАВЛЯЙТЕ...")
 I PR=4 D OkMsg^%ZAPM.bs.BSXfun("ЗАНЕСЕНО В БД")
 D TW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM
 Q
PRO N F,BP,com,NR,TI
 S com="ПРОТОКОЛ ",F=$P($$CHOIS(com,"P"),"§",2) Q:F=""
 D Table^%ZAPM.bs.BSN("^%ZAPM.bs.BSMDDR","PRO") Q:$P(YES,"@",4)=27  S NR=$P($P(YES,"@"),","),com=com_$P(YES,"@",9)
 S TI=$$LineEdit^%ZAPM.bs.BSXfun($TR($$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3()-362),".","")_"-"_$TR($$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3()),".",""),"введите диапазон дат ввода в буфер, в формате: ДДММГГ-ДДММГГ") Q:YES<1
 D TempT^%ZAPM.bs.BSTT S com=com_" "_TI
 I F'=" " D PROTO(F) G PROTOK
 S F="" F  S F=$O(@BP@(F)) Q:F=""  D PROTO(F)
PROTOK D TempTXT^%ZAPM.bs.BSTT(com,$G(@%BS(20)@("TextEdit")))
 D TempTXTE^%ZAPM.bs.BSTT K @BSr@(BSt)
 Q
PROTO(F) N N,S,K D Wait^%ZAPM.bs.BSXfun($NA(@BP@(F)))
 S N="" F  S N=$O(@BP@(F,N)) Q:N=""  I N'["@" D LIST(BP,F,N,NR,$G(TI)) D  K S X WA
 .F K=1:1 Q:'$D(S(K))  D TempTX^%ZAPM.bs.BSTT(S(K))
 Q
CHE(M,T) I M="S",T'["ОШИБ" Q 0
 I M="Z",T'["ГОТОВ" Q 0
 I M="L",'(T["ГОТОВ"!(T["ЗАНЕС")) Q 0
 Q 1
CHOIS(com,MO) ;ВЫБОР РЕЖИМА РАБОТЫ
 N F,BSr,BSt,YES
 S BP=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""BPO"")") I '$$Data^%ZAPM.bs.BSF12(BP) S @BP="восстановил!!! "_$H ;D ErrMsg^%ZAPM.bs.BSXfun("Буфер "_BP_" не Доступен") Q ""
 D TempT^%ZAPM.bs.BSTT,TempTX^%ZAPM.bs.BSTT(" § §РАБОТАТЬ ПО ВСЕМ ФОРМАМ§ §")
 S F="" F  S F=$O(@BP@(F)) Q:F=""  I F'["@",$$CHE(MO,$G(@BP@(F))) D TempTX^%ZAPM.bs.BSTT("ТОЛЬКО §"_F_"§  "_$G(@BP@(F)))
 D TempTXT^%ZAPM.bs.BSTT("РЕЖИМ работы с буфером: "_$G(com),$G(@%BS(20)@("ErrorTXT")))
 d ^%ZAPM.bs.BSX("TEXT",BSr,BSt) Q:YES<1 ""
 Q $G(@BSr@(BSt,YES))
PROTLIST ;ПРОТОКОЛ ИЗ КАРТЫ БД
 N S
 D LIST(BSD,%KEYS(1),%KEYS(2),6) I '$D(S) W $$bel^%ZAPM.bs.BS3 Q
 D TempT^%ZAPM.bs.BSTT F N=1:1 Q:'$D(S(N))  D TempTX^%ZAPM.bs.BSTT(S(N))
 D TempTXT^%ZAPM.bs.BSTT(S(1),$G(@%BS(20)@("TextEdit"))) ;И ШАБЛОН
 D TempTXTE^%ZAPM.bs.BSTT
 Q
TT(T) Q $$DATHR^%ZAPM.bs.BSsFUNR(6,$$REVERS^%ZAPM.bs.BSsFUNR(T))
TIME(TI,HR) Q:TI="" 1 N T1,T2 S T1=$$TT($P(TI,"-")),T2=$$TT($P(TI,"-",2))
 I HR'<T1&(HR'>T2) Q 1
 Q 0
LIST(BP,F,ND,NR,TI) ;ПРОТОКОЛ КОНТРОЛЯ ДОКУМЕНТА
 N N,K,PO,IN,H
 S PO=$G(@BP@(F,ND,"2,1")) I '(NR=5&(PO=4)!(NR=4&(PO=3))!(NR=3&('PO))!(NR=6)) Q
 S IN=$G(@BP@(F,ND,"INF")) I $G(TI)'["*",'$$TIME($G(TI),+$P(IN,"?",2)) Q
 D LI("--------------------------------------------------------------------")
 D LI("|ДОКУМЕНТ ФОРМЫ "_F_"   N "_ND)
 D LI("|ПОЛУЧЕН ИЗ "_$P(IN,"?")_" "_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$P(IN,"?",2))_", ПОЛЬЗОВАТЕЛЕМ: "_$P(IN,"?",3))
 D LI("|СТАТУС: "_$S(PO=3:"ГОТОВ К ЗАНЕСЕНИЮ",PO=4:"УЖЕ ЗАНЕСЕН",1:"¶!¶ СИНТ.ОШИБКИ В :"_PO)_", ЛОГИЧ.ОШИБОК:"_$S($P(IN,"?",6)="":"???¶",'$P(IN,"?",6):"НЕТ",1:" ¶!¶!¶!¶ "_$P(IN,"?",6)))
 D LI("|-------------------------------------------------------------------")
 F N=2:1 Q:'$D(@BP@(F,ND,N_",2"))  D LI("|"_@$ZR) F K=1:1 Q:'$D(@BP@(F,ND,N,K))  D LI("|  "_@$ZR)
 D LI("------------------------------ ВЫДАН "_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())_", ПОЛЬЗОВАТЕЛЕМ: "_%BS(12))
 Q
LI(T) Q:T=""  S S=$G(S)+1,S(S)=T Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMENU" type="MAC" languagemode="0"><![CDATA[
%BSMENU ;ПРИМЕРНЫЙ МОДУЛЬ ВЫЗОВА ПОЛЬЗОВАТЕЛЬСКИХ АРМов ; 11:46   04.05.2001
KKK ;КАДРЫ
 D SELF
 S uci="KDR,CEN" D %GU^%ZAPM.bs.BSF4 H:'YES  ;ПЕРЕХОД В НУЖНЫЙ КИП,ТОМ
 ;I $P=4 D ^KK H ;СТАРТ ЗАДАЧИ ИЗ ПРИКРЕПЛЕННОГО ТЕРМИНАЛА
K1 S BSR="^KDR",BST="MENUPRIM" D ^%ZAPM.bs.BST ;СТАРТ ОСНОВНОГО МЕНЮ
 I ny=7!(R1=27) D ^%SSD ;ВЫХОД ИЗ MSM
 I ny=2 D OP^%ZAPM.bs.BSF4,^PRK G K1
 I ny=1 D ^KK G K1
 G K1
 ;
KBB ;АРМ КОМАНДУЮЩЕГО
 D SELF
0 S uci="ASU,CEN" D %GU^%ZAPM.bs.BSF4
1 S BSR="^KBB",BST="MENU" D ^%ZAPM.bs.BST I R1=27!(ny=10) D MGR^%ZAPM.bs.BS G ^%SSD
 I ny=1 S uci="KDR,CEN" D %GU^%ZAPM.bs.BSF4,OP^%ZAPM.bs.BSF4 I YES D ^PRK G 0
 G 1
 ;
LASTVERS(GLO) ;САМОПОВЫШЕНИЕ ВЕРСИИ
 N DI,DII
 S %zT=$ZT,$ZT="OG^%ZAPM.bs.BSMENU",YES=0
 I '$$Data^%ZAPM.bs.BSF12(GLO) S DI=$P($G(^%ZAPM.bs.BSETUP("PATH",10,4)),"@",15) I DI>1 F DII=1:1:DI-1 I $$Data^%ZAPM.bs.BSF12(GLO) Q
 S Zv=$G(@GLO@("LAST"))
 I $G(IntSe,1)=1,'$$VERS Q
 I $G(NOAUTO) D YES I YES'="Y" Q
 S %FN=$$AddFile^%ZAPM.bs.BSDOS2($$DIR^%ZAPM.bs.BSMSMF_"%BS.PAC") F DOS=51:1:54 O DOS::0 Q:$T
 I $$Open^%ZAPM.bs.BSXdos(%FN,"W")<0 Q
 I '$D(IntSe) W #,"... Подготовка к повышению версии "
 D L^%ZAPM.bs.BS3(GLO,1)
 S X="" F  S X=$O(@GLO@("LAST",X)) Q:X=""  U DOS W @GLO@("LAST",X),! I '(X#150) I '$D(IntSe) U 0 W "."
 C DOS U 0 S YES=1 D U^%ZAPM.bs.BS3(GLO)
 Q
OG W $$bel^%ZAPM.bs.BS3 S $ZT=$G(%zT),YES=0 D U^%ZAPM.bs.BS3(GLO)
 Q
VERS() Q:Zv=^%ZAPM.bs.BS 0 Q:+Zv<+^%ZAPM.bs.BS 0 Q 1
YES U 0 W !!,"Выставлен Флаг Повышения %BS Версии ",Zv,". Приступим ? [Y/N] <N> " R YES S YES=$TR(YES,"yn","YN") Q
IntSELF(IntSe) G SELF
SEL S NOAUTO=1
SELF S %zT=$ZT,$ZT="SELFER^%ZAPM.bs.BSMENU" ;АВТО-ПОВЫШЕНИЕ
 N Zv,FIR,X,DOS S FIR=1
 I $P($G(^%ZAPM.bs.BSETUP("SERVER",2,4)),"@",15)'="" D LASTVERS($P($P($G(^%ZAPM.bs.BSETUP("SERVER",2,4)),"@",15),"\",2,99)) I YES S FIR=0 G SE
 S %FN=$$DIR^%ZAPM.bs.BSMSMF_"%BSVER.DAT"
SE F %DEV=51:1:54 O %DEV::0 Q:$T
 G:'$T E O %DEV:%FN U %DEV I $ZA=-1 G E
U O %DEV:(%FN:"R") U %DEV I $ZA<0 G E
 R X I FIR G E:X'="§" R X S Zv=$P(X,"§",2) G E:'$$VERS
 I FIR,$G(NOAUTO) D YES I YES'="Y" G E
 ;```=$$DIR^%ZAPM.bs.BSMSMF_"%BS.PAC"
 I FIR S FIR=0,%FN=$$BaseDir^%ZAPM.bs.BSDOS_$$DIR^%ZAPM.bs.BSMSMF_"%BS.PAC" C %DEV G SE
 X X
E U 0 C %DEV K %DEV,%FN G SELFER
SELFER S $ZT=$G(%zT) W $$bel^%ZAPM.bs.BS3 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMOUSE" type="MAC" languagemode="0"><![CDATA[
%BSMOUSE  ; пpогpамма работа С МЫШьЮ ; 22:56 11-NOV-96
INIT      ; Check if mouse is installed
          S init=$$INIT^%MOUSE()  ; mouse installed?
          I 'init G END
TYPE      ; Determine type of mouse
          S info=$$INFO^%MOUSE()  ; get <type>,<irq>,<version>
          I $$HIDE^%MOUSE()
          ;S %BS(25,1)=$$REPORT^%MOUSE(),Mouse=1
          ;S %BS(25)="F  R *R1:0,*R2:0,*R3:0 Q:R1'=-1  I $G(%BS(25,1))'=$$REPORT^%MOUSE() D MOUSE^%ZAPM.bs.BSMOUSE Q:R1'=-1  F  R *R:0 E  Q"
          S MouseYes(1)=$$REPORT^%MOUSE(),Mouse=1
          S MouseYes="F  R *R1:0,*R2:0,*R3:0 Q:R1'=-1  I $G(MouseYes(1))'=$$REPORT^%MOUSE() D MOUSE^%ZAPM.bs.BSMOUSE Q:R1'=-1  F  R *R:0 E  Q"
END       Q
MOUSE     N co ; F  R *R1:0,*R2:0,*R3:0 Q:R1'=-1  I $G(MouseYes(,1))'=$$REPORT^%MOUSE() D  Q:R1'=-1  F  R *R:0 E  Q
          S co=$$REPORT^%MOUSE()
          I "1"[$G(Mouse),$P(co,",",2)>$P(MouseYes(1),",",2) S R1=27,R2=91,R3=66 S:$P(co,",",2)=192 $P(co,",",2)=190 G M
          I "1"[$G(Mouse),$P(co,",",2)<$P(MouseYes(1),",",2) S R1=27,R2=91,R3=65 S:$P(co,",",2)=0 $P(co,",",2)=1 G M
          I "2"[$G(Mouse),$P(co,",",1)>$P(MouseYes(1),",",1) S R1=27,R2=91,R3=67 S:$P(co,",",1)=632 $P(co,",",1)=630 G M
          I "2"[$G(Mouse),$P(co,",",1)<$P(MouseYes(1),",",1) S R1=27,R2=91,R3=68 S:$P(co,",",1)=0 $P(co,",",1)=1 G M
M         S MouseYes(1)=co ;!!!I $$PUT^%MOUSE($P(co,",",1),$P(co,",",2))
          Q:'$P(co,",",3)
          I $ZB(+$P(co,",",3),1,1) S R1=13
          I $ZB(+$P(co,",",3),2,1) S R1=27
A         S R2=-1,R3=-1 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMSM" type="MAC" languagemode="0"><![CDATA[
%BSMSM ;MUMPS-ИНТЕРФЕЙС ; 13:38 18-DEC-98
 D 0 G D
0 I '$$AccesMSM^%ZAPM.bs.BSDOS2(1) G PROT
 S OO=29,OOO="^%ZAPM.bs.BS" K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF Q:R1=27  I %B=1 S IYI="^%ZAPM.bs.BSS(UTILITY" D ENTER^%ZAPM.bs.BSN Q
 I %B=3!(%B=4) S Br=BSR,Bt=BST,FIL=1 S:%B=4 FIL="d[""%BS""" D  S BST=Bt,BSR=Br K Br,Bt G 0
 .D D^%ZAPM.bs.BSDIR("","",FIL,"S d=$O(^ (d))","S t1=d_$J("""",9-$L(d)) S d1=$S ZL @d S t1=t1_$J(d1-$S,5)_"" ;""_$P($T(+1),"";"",2,99)","^%ZAPM.bs.BSbufB","RDIR"_$G(%BS(3),$P)_$J_"u","ПРОГРАММЫ",2,"D ROLI^%ZAPM.bs.BSMSM","ROFK^%ZAPM.bs.BSMSM","  новая пpогpамма","DelF8^%ZAPM.bs.BSDOS")
 .S IYI=BSr_","_BSt
RR .D ENTER^%ZAPM.bs.BSN I R1=27 Q
 .I R1=13 S IntGO=$P(@BSR@(BST),"@",15) I IntGO["^" S R3=83 D @IntGO
 .G RR
 I %B=6 S FIL="$P($G(@d),""@"")=""BSD - MSW""",ls="БАЗЫ ДАННЫХ" G G
 I %B=7 S FIL="$P($G(@d),""@"")[""%BS-invert-""!(d[""in"")",ls="КОДИФИКАТОРЫ" G G
 I %B=8 S FIL="$P($G(@d),""@"")[""%BS-dinam""",ls="ДИНАМИЧЕСКИЕ БОКОВИНЫ СВОДКИ" G G
 I %B=5 S FIL="$P($G(@d),""@"")=""BaSe MsW """,ls="РАЗДЕЛЫ ПОЛЬЗОВАТЕЛЯ" G G
 I %B=2 S FIL=1,ls="КАТАЛОГ МАССИВОВ" G G
 I %B=9 I $$PROTFUN D ^%ZAPM.bs.BSMSMF G 0
 G 0
G S Br=BSR,Bt=BST D   S BST=Bt,BSR=Br K Br,Bt G 0
 .D D^%ZAPM.bs.BSDIR("^","^",FIL,"S d=""^""_$O(@d)","S t1=d_$J("""",10-$L(d))_"";""_$$HEADGLO^%ZAPM.bs.BSMSM(d)","^%ZAPM.bs.BSbufB","GDIR"_$G(%BS(3),$P)_$J_"u"_$G(%BS(3),$P),ls,2,"D GLOLI^%ZAPM.bs.BSMSM","GLOFK^%ZAPM.bs.BSMSM","  новый массив","DelF8^%ZAPM.bs.BSDOS")
 .S IYI=BSr_","_BSt
GG .D ENTER^%ZAPM.bs.BSN I R1=27 Q
 .I R1=13 S IntGO=$P(@BSR@(BST),"@",15) I IntGO["^" S R3=83 D @IntGO
 .G GG
D D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST Q
HEADGLO(d) I d="^BSrecord" Q "%BS-pазделение доступа в кип"
 I d="^BShigh" Q "%BS-самоповышение веpсии"
 I $E(d,$L(d)-1,$L(d))="in",$P($G(@$P(d,"in")),"@")["%BS-invert-" Q "%BS-Инвеpтиpованный к "_$P(d,"in")
 I $D(@d)["0" Q "?"
 S d=@d I $P(d,"@")="BSD - MSW" Q "%BS-База данных PART="_$P(d,"@",2)_" TABL="_$P(d,"@",3)
 I $P(d,"@")="BaSe MsW " Q "%BS-Раздел ;"_$P(d,"@",2)
 I $P(d,"@")["%BS-invert-" Q "%BS-Кодификатоp из PART="_$P($P($P(d,"@"),"-",3),",",1,2)_" TABL="_$P($P($P(d,"@"),"-",3),",",3)_" ;"_$P(d,"@",2)
 I $P(d,"@")["%BS-dinam" Q "%BS-М/Запросы PART="_$P($P($P(d,"@"),"-",3),",",1,2)_" TABL="_$P($P($P(d,"@"),"-",3),",",3)_" ;"_$P(d,"@",2)
 Q $$DELCTL^%ZAPM.bs.BSsFUNM(d)
e Q
GLOFK S %NAM=$P(d," ")
 I R3=83 S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),7)=%NAM D S,^%ZAPM.bs.BSMSMG(),CL^%ZAPM.bs.BSF4,R I $D(IntGO) K IntGO Q
 I R3=85 D  I %NAM["^" S %GLB=%NAM K %PAROL D ^%ZAPM.bs.BSGCH,PROTALL^%ZAPM.bs.BSF9
 .I '$$RP^%ZAPM.bs.BSGCH("^BSdirddp") S %NAM="" D ERRRVG^%ZAPM.bs.BS2 Q
 I R3=87 G DD:ny<2 D  K AllWAY Q:R1=27
 .I '$$AccesMSM^%ZAPM.bs.BSDOS2(3) D PROT^%ZAPM.bs.BSMSM Q
 .K AllWAY I $D(%DIA) S do="I i>1 S %NAM=$P($P(^(j),""@"",15),"" "") I %NAM'="""" D DelG^%ZAPM.bs.BSMSM(%NAM)" D BLOK^%ZAPM.bs.BSF1 Q
 .D DelG^%ZAPM.bs.BSMSM(%NAM) Q
 G DD
DelG(G) Q:G=""  D L^%ZAPM.bs.BS3($NA(@G)) Q:'LOC  D  D U^%ZAPM.bs.BS3($NA(@G)) Q
 .D YEG Q:'YES  K @G S R1=27 Q
 Q
YEG I '$D(%DIA) S ls=" УДАЛЯЕМ МАССИВ "_G_", ВЫ УВЕРЕНЫ ? ",%B=2 W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF Q
 I $D(%DIA),'$G(AllWAY) D Yes^%ZAPM.bs.BSXfun("УДАЛЯЕМ МАССИВ "_G_". Удалять С ПОДТВЕРЖДЕНИЕМ !!!",1) Q:YES<0  I 'YES D Yes^%ZAPM.bs.BSXfun(" ВЫ УВЕРЕНЫ ? Удалять ВСЕ ПОМЕЧЕННЫЕ МАССИВЫ БЕЗ ПОДТВЕРЖДЕНИЯ !",1) Q:YES<1  S AllWAY=1
 Q
DelR(G) Q:G=""  D YER Q:'YES  X "ZR  ZS @G ZL %BSMSM" S R1=27,ny=1
 Q
YER I '$D(%DIA) S ls=" УДАЛЯЕМ ПРОГРАММУ "_G_", ВЫ УВЕРЕНЫ ? ",%B=2 W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF Q
 I $D(%DIA),'$G(AllWAY) D Yes^%ZAPM.bs.BSXfun("УДАЛЯЕМ ПРОГРАММЫ "_G_". Удалять С ПОДТВЕРЖДЕНИЕМ !!!",1) Q:YES<0  I 'YES D Yes^%ZAPM.bs.BSXfun(" ВЫ УВЕРЕНЫ ? Удалять ВСЕ ПОМЕЧЕННЫЕ ПРОГРАММЫ БЕЗ ПОДТВЕРЖДЕНИЯ !",1) Q:YES<1  S AllWAY=1
 Q
ROFK S %NAM=$P(d," ")
 I R3=83 S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,4)=%NAM D S,^%ZAPM.bs.BSXprog(),CL^%ZAPM.bs.BSF4,R I $D(IntGO) K IntGO Q
 I R3=87 G DD:ny<2 D  K AllWAY Q:R1=27
 .I '$$AccesMSM^%ZAPM.bs.BSDOS2(3) D PROT^%ZAPM.bs.BSMSM Q
 .K AllWAY I $D(%DIA) S do="I i>1 S %NAM=$P($P(^(j),""@"",15),"" "") I %NAM'="""" D DelR^%ZAPM.bs.BSMSM(%NAM)" D BLOK^%ZAPM.bs.BSF1 Q
 .D DelR^%ZAPM.bs.BSMSM(%NAM) Q
DD G D^%ZAPM.bs.BS
TEST D OP^%ZAPM.bs.BSF4,SA^%ZAPM.bs.BSsBUF,^%ZAPM.bs.BSMSMV,RE^%ZAPM.bs.BSsBUF Q
S D SA^%ZAPM.bs.BSsBUF Q
R D RE^%ZAPM.bs.BSsBUF Q
PROTFUN() I $P($$ZU^%ZAPM.bs.BS3(0),",")'=$P($$ZU^%ZAPM.bs.BS3(1,0),",") D ErrMsg^%ZAPM.bs.BSXfun("Вы находитесь не в системном КИПе") Q 0
 I '$$AccesMSM^%ZAPM.bs.BSDOS2(2) D PROT^%ZAPM.bs.BSMSM Q 0
 Q 1
PROT D ErrMsg^%ZAPM.bs.BSXfun("Нарушение прав доступа для пользователя '"_$G(%BS(12))_"'") Q
ROLI W /CUP(23,1),$$clr^%ZAPM.bs.BS3(4),/EL(0),"    <Esc> - ОТМЕНА      <F4> - РЕДАКТИРОВАТЬ      <F8> - УДАЛИТЬ  ",$$atr^%ZAPM.bs.BS3(0) Q
GLOLI W /CUP(23,1),$$clr^%ZAPM.bs.BS3(4),/EL(0)," <Esc> - ОТМЕНА <F4> - РЕДАКТИРОВАТЬ <F6> - ХАРАКТЕРРИСТИКИ <F8> - УДАЛИТЬ ",$$atr^%ZAPM.bs.BS3(0) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMF" type="MAC" languagemode="0"><![CDATA[
%BSMSMF ;РЕДАКТИРОВАНИЕ ФУНКЦИЙ                             ; 10:18   17.06.99
 S IYI="^%ZAPM.bs.BSS(FUN_ED" D ENTER^%ZAPM.bs.BSN Q
ROU ;ВХОД В ПРОГРАММУ
 S LA=$P(d,"^"),RO=$P(d,"^",2) X:'$D(^ (RO)) "ZR  ZI LA_"" ;..."" ZS @RO" X "ZL @RO F i=0:1 Q:$T(+i)=""""  I $P($P($T(+i),"" ""),""("")=LA Q"
 D ^%ZAPM.bs.BSX("PROG",RO,i_",1") Q
HELP Q:d=""  S Br=$P(d,"("),Bt=$P(d,"(",2) Q:Bt=""  I '$D(@(Br_"(Bt)")) S $P(@$ZR,"@",17)=5 ;BSr1="^%ZAPM.bs.BSS",BSt1="NEW4",BSr2=Br,BSt2=Bt D COPY^%ZAPM.bs.BSTK
 S IYI=d D NE^%ZAPM.bs.BSN
e Q
RSE(N) ;ВХОД В ПРОГРАММУ ИЗ СПИСКА
 N (%BS,vl,N)
RS S BSR="^%ZAPM.bs.BSbufB",BST="%RSEBUF"_N D ^%ZAPM.bs.BST Q:$G(YES)<1
 S d=$P($G(@BSR@(BST,YES)),":") Q:$E(d)="-"  S RO=$P(d,"+"),i=$P(d,"+",2)
 D ^%ZAPM.bs.BSX("PROG",RO,i_",1") G RS
 Q
DosRec(NumDev,%FN) ;ОТКРЫТИЕ УСТРОЙСТВА HFS=%DEV ДЛЯ ДОЗАПИСИ
 I $ZV["Cach"||($ZV["IRIS") Q "ПОКА НЕ УМЕЮ ДОПИСЫВАТЬ В ФАЙЛ"
 S YES=1,%zT=$ZT,$ZT="DosErr^%ZAPM.bs.BSMSMF"
 F %DEV=$G(NumDev,51):1:54 O %DEV::0 Q:$T
 I '$T K %DEV S YES=-1 G DosEnd
 O %DEV:(%FN:"A") U %DEV I $ZA<0 U 0 S YES=-2 C %DEV G DosEnd
DosEnd U 0 Q YES
DosErr S $ZT=$G(%zT) Q $ZE
Tex(T,MODE) ;СИСТЕМНЫЙ ПРОТОКОЛ
 N %DEV,%FN i '$d(%BS(44)) D VAR^%ZAPM.bs.BSCh 
 I '$P($G(%BS(44)),",",3) Q  //ЛОГИ ОТКЛЮЧЕНЫ
 i $G(%BS(24,1))="" d VARI^%ZAPM.bs.BSC4
 I $E(%BS(24,1))="^" D  Q
 .n msg,t1 S msg(2)=": "_$G(MODE)_" :IP="_$G(%BS(41))_" :$J="_$J_" :%BScfg="_$$CFG^%ZAPM.bs.BSCp
 .S @%BS(24,1)@($P($$h^%ZAPM.bs.BS3(),","),$ZT($P($$h^%ZAPM.bs.BS3(),",",2),1)_".."_$INCREMENT(^mtempBSprot),"U")=$G(%BS(12),$G(BSLOGIN,"???"))
 .s msg(1)="User: "_@$zr
 .S ^("S")=msg(2)
 .S ^("A")=T  s msg(3)="Action: "_T I $E(T,1,5)="Error" d
 ..i $P($g(%BS(44)),",",1) D SYSMSG^%ZAPM.bs.BSCek(T,"E")
 ..i $P($g(%BS(44)),",",2) D ADDNEWMAIL^%ZAPM.bs.BSCmail($P($P($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin"),"@",1),"<",2),"BSystemGuard",msg(3)_$C(13,10)_msg(2)_$C(13,10)_msg(1),T)
 .I T["Change" D
 ..i $P($g(%BS(44)),",",2) D ADDNEWMAIL^%ZAPM.bs.BSCmail($P($P($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin"),"@",1),"<",2),"BSystemGuard",msg(3)_$C(13,10)_msg(2)_$C(13,10)_msg(1),T)
 I $ZV["Cach"||($ZV["IRIS") Q
 Q:$$DosRec(51,$$AddFile^%ZAPM.bs.BSDOS2(%BS(24,1)))'=1
 S T="§"_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())_"§User:"_$G(%BS(12),"???")_"§SysVol:"_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"§$$:"_T_"§$$h^%ZAPM.bs.BS3():"_$$h^%ZAPM.bs.BS3()
 U %DEV W T,! C %DEV Q
LOCK I $E(%BS(24,1))="^",$$Data^%ZAPM.bs.BSF12(%BS(24,1)) L +@%BS(24,1)@($P($$ZU^%ZAPM.bs.BS3(1,0),",",2),$G(%BS(12),"???")):0 E  W /BEL,!!!,"Конфликт систем MSM !",!,$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)," Уже работает !" H
 Q
UNLOCK I $E(%BS(24,1))="^",$$Data^%ZAPM.bs.BSF12(%BS(24,1)) L -@%BS(24,1)@($P($$ZU^%ZAPM.bs.BS3(1,0),",",2),$G(%BS(12),"???"))
 Q
REGO I $ZV["Cach"||($ZV["IRIS") Q  //D Tex("Login") Q       
 D Tex("Begin%BSv"_+^%ZAPM.bs.BS),LOCK Q
REGB D Tex("BeginStop") Q
REGE I $ZV["Cach"||($ZV["IRIS") D Tex("TermLogout") Q      
 D Tex("Exit%BSv"_+^%ZAPM.bs.BS),UNLOCK Q
MOUNT(I) D Tex("Mount"_I_" ") Q
UNMOU(I) D Tex("Dismount "_I_" ") Q
ER D Tex("Error:"_$G(ls)_" ="_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) Q
SAVE ;СОХРАНЕНИЕ ТЕКСТА ТЕСТА
 N V,%DEV,I,II,%FN Q:$G(%BS(24,2))=""  Q:$$DosRec(51,$$AddFile^%ZAPM.bs.BSDOS2(%BS(24,2)))'=1
 S T="§"_$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())_"§User:"_$G(%BS(12),"???")_"§SysVol:"_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"§$$:TestSys§$$h^%ZAPM.bs.BS3():"_$$h^%ZAPM.bs.BS3()
 U %DEV W !,$TR($J("",78)," ","="),!,T,!,$TR($J("",78)," ","-")
 U %DEV W !,"=="
 S V="" F I=1:1  Q:'$D(@BSR@(BST,I))  S II=$P(@BSR@(BST,I,1),"@",15) D  I II'="" U %DEV W !,II U 0
 .I $E(II,1)=" " S $E(II,1,2)="| " Q
 .I $E(II,6,8)=V  S II="| "_II Q
 .S V=$E(II,6,8) U %DEV W !,"|=" S II="| "_II Q
 U %DEV W !,"==",! C %DEV U 0 Q
DDPDIR ;ОБНОВЛЕНИЕ ССЫЛКИ
 ;|I '$$RP^%ZAPM.bs.BSGCH("^BSdirddp") Q  ;МЫ В RVG
 S DOUCI="S $P(^BSdirddp,""@"",2)=$$ZU^%ZAPM.bs.BS3(1,0) I 0",DOX="" D STA^%ZAPM.bs.BSF5 Q
DIR() N A S A=$P($G(^%ZAPM.bs.BSETUP("PATH",2,4)),"@",15) I A="" Q A
 I $E(A,$L(A))'="\" S A=A_"\"
 Q A
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMG" type="MAC" languagemode="0"><![CDATA[
%BSMSMG(G) ;ПРОСМОТР МАССИВОВ ; 15:12   14.01.2000
 I '$$AccesMSM^%ZAPM.bs.BSDOS2(1) G PROT^%ZAPM.bs.BSMSM
 D LOCK^%ZAPM.bs.BSF4 I $G(%BS(13))="%BS-PC" d SaveWin^%ZAPM.bs.BSXfun(1,1,25,80),ClearDis
 U $I::%BS(32) N IntRef
 I $G(G)'="",G["^" S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),7)=G K G
0 K GL S li=$G(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),7))
00 I $D(G),G'["^",G'="",$D(@G)>0 S GL=G,IntRef=G K G G 000
 D GLO^%ZAPM.bs.BSF3 G:'$D(GL) EXIT G:'YES EXIT
 I GL["~D" D ^%ZAPM.bs.BSMSMS(2,GL) G:dat="" 0 S GL="^"_dat
000 S glo=GL I '$D(@GL) D Yes^%ZAPM.bs.BSXfun(" МАССИВ "_GL_" НЕ СУЩЕСТВУЕТ ! ,БУДЕМ СОЗДАВАТЬ ?",2) G:'YES ESHE F i=1,2,3 S @(GL_"(i)")=i
 S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),7)=GL
 N Sp,FIL,L,Pg,Ha
 S Sp=8000,FIL=$G(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),7,1)) D CL^%ZAPM.bs.BSF4 S L=0,LL=20 I FIL="" S FIL="I 1"
H D HOME S L=0,g1=g
 ;ОБЩИЙ ЦИКЛ
L S g=$$ZO(g,Ha) I g="" S g=$S(Ha>0:glo,1:glo_"("""")"),L=0 W $$bel^%ZAPM.bs.BS3 G PAUSE:HHH,PAUSE:FIL'=1 D  G L
 .I g["(" D HOME Q
 .E  D END
 W $$clr^%ZAPM.bs.BS3(8),g,$$atr^%ZAPM.bs.BS3(0),$$W(@g),$$atr^%ZAPM.bs.BS3(0),!
 I Pg D LO I L>LL G PAUSE
 I 'Pg,Sp F i=1:1:Sp S ii=123 ;ЗАДЕРЖКА
READ R *r1:0,*r2:0,*r3:0 G L:r1<0
 I r1=43,r2=-1 S Sp=Sp-1000 S:Sp<0 Sp=0 G L
 I r1=45,r2=-1 S Sp=Sp+1000 S:Sp>8000 Sp=8000 G L
PAUSE W $$clr^%ZAPM.bs.BS3(4),/CUP(24,1),/EL(0)," <F1>-ПОМОЩЬ <F4>-РЕДАКТ <F5>-ДЕРЕВО <F6>-ФИЛЬТР <F7>-ИНДЕКС <+->-SPEED: " D  W " ",$S(Pg:" ",Ha>0:"=",1:"=")," ",$$atr^%ZAPM.bs.BS3(0)
 .W $S(Sp=8000:"MIN",Sp=7000:"MIn",Sp=6000:"Min",Sp=5000:"min",Sp=4000:"max",Sp=3000:"Max",Sp=2000:"MAx",1:"MAX")
PA W $$rt^%ZAPM.bs.BS3(+$G(%BS(2),9999)) S HHH=0,L=0,LL=20 I R1=-1,%BS(13)="%BS-PC" D GLUC^%ZAPM.bs.BSXgluc G PA
 I R1=27,R2=-1 K GL G:$D(IntRef) EXIT G 0
 S L=0 I R1=27,R2=91,R3=66 S Pg=0,Ha=1 W ! G L ;ВНИЗ
 I R1=27,R2=91,R3=65 S Pg=0,Ha=-1 W ! G L      ;ВВЕРХ
 I R1=0,R2=71 D HOME G L
 I R1=0,R2=79 D END G L
 I R1=0,R2=81 S Pg=1,Ha=1,L=0 D P G L
 I R1=0,R2=73 S Pg=1,Ha=-1,L=0 D P G L
 I R1=27,R2=79,R3=84 D ^%ZAPM.bs.BSTREE(glo),HOME G L
 I R1=27,R2=79,R3=83 D  G L
 .I '$$AccesMSM^%ZAPM.bs.BSDOS2(2) D PROT^%ZAPM.bs.BSMSM Q
 .D:Ha>0  D EDIT,CL^%ZAPM.bs.BSF4 S Pg=1,Ha=1,L=0 S:G'="" g=G W /CUP(1,1),/ED(2)
 ..S GG=g F i=1:1:15 S GG=$$ZO(GG,-1) Q:GG=""  S g=GG
 I R1=27,R2=79,R3=86 D INDX S Ha=1,L=0,Pg=1 W /CUP(1,1),/ED(2) G L
 I R1=27,R2=79 D  G L:$ZV["Cach"||($ZV["IRIS"),PAUSE
 .I R3=80 D HELP Q
 .I R3=85 D FILT Q
 G PAUSE
e Q
 ///z 
ClearDis w $$esc^%ZAPM.bs.BS3(7),$$atr^%ZAPM.bs.BS3("2;37;44"),/CUP(1,1),/ED(2),/CUP(22,47),"%ZAPM.editor "_+^%ZAPM.bs.BS,$$atr^%ZAPM.bs.BS3("2;37;40"),/CUP(23,1),/EL(0),/CUP(24,1),/EL(0),/CUP(25,1),/EL(0),/CUP(1,1) Q
ZO(g,Ha) 
Z1 I g[")("""")" S g=$$TR^%ZAPM.bs.BSsFUNM(g,")("""")",")")
 S g=$ZO(@g,Ha) I g="" Q ""
 X FIL I  Q g
 G Z1
W(g) //i $tr(%S,$c(127,5))'=%S s %S=$tr(%S,$c(127,5),$c(174,169))
 I $TR(g,$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,127),"")'=g W $$clr^%ZAPM.bs.BS3(10)
 Q $TR(g,$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,127),$c(174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174))
P W /ED(2),/CUP(1,1) Q
LO S L=L+(($L(g)+$L($G(@g)))\79)+1 Q
HI W /ED(2),/CUP(1,1),$$clr^%ZAPM.bs.BS3(12),g,$$atr^%ZAPM.bs.BS3(0) I $D(@g)'["0" W $$W(@g),$$atr^%ZAPM.bs.BS3(0)
 W ! D LO Q
HELP S IYI="^%ZAPM.bs.BSHLP(HELPGL" D N^%ZAPM.bs.BSN("IYI"),ENTER^%ZAPM.bs.BSN,Q^%ZAPM.bs.BSN("IYI") D  Q
 .I $ZV["Cach"||($ZV["IRIS") D HOME
EDIT S:g["("""")" g=$P(g,"(") D ^%ZAPM.bs.BSMSMGE(g) Q
FILT S li=FIL,%hlp="^%ZAPM.bs.BSHLP(HELP_F",ls=" Введите Фильтp пpосмотpа (g=ссылка @g=данные) F1-ПОМОЩЬ "
 S %HIS="^%ZAPM.bs.BSbufB(""HISARREYFILTR"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")" D LE^%ZAPM.bs.BSTT Q:'YES
 S %zT=$ZT,$ZT="ERRF^%ZAPM.bs.BSMSMG" S:li="" li="I 1" X li
 S $ZT=%zT,FIL=li I $ZV["Cach"||($ZV["IRIS") D HOME
 Q
INDX S li=$S($G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),8))[$P(g,"("):$G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),8)),1:g),li=$$LineEdit^%ZAPM.bs.BSXfun(li,"Введите ссылку массива ","","","","^%ZAPM.bs.BSbufB(""HISARREYINDX"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")") Q:'YES!(li="")
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSMSMG" I $D(@li)'["0" S li=$$ZO(li,-1)
 S $ZT=%zT,Ha=1,(g,^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),8))=li Q
END S g=$$ZO((glo_"("""")"),-1),Ha=-1,Pg=1,HHH=1 D HI Q
HOME S g=glo,Ha=1,Pg=1,HHH=1 D HI Q
ESHE S li=GL G 00
EXIT D OP^%ZAPM.bs.BSF4 D LoadWin^%ZAPM.bs.BSXfun W $$esc^%ZAPM.bs.BS3(8) Q
ERRF S ls=$ZE D O^%ZAPM.bs.BSF7 G FILT
ERR S ls=$ZE D O^%ZAPM.bs.BSF7 G INDX
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMGE" type="MAC" languagemode="0"><![CDATA[
%BSMSMGE(GLO) ;ПОЛНОЭКРАННЫЙ РЕДАКТОР МАССИВОВ (I PART) ; 13:36   28.02.99
 N GG,i,ii,iii,Y1,Y2,YY,XX,Y,X,YES,%YES,W,S,M,EDI,R1,R2,R3,%CO,%LO,%LL,q0,q3,%ES,%EC,I,II,III,I1,I2
 D L^%ZAPM.bs.BS3(GLO) I 'LOC G EXIT
 I '$D(FIL) S FIL="I 1"
 S EDI=0,%YES=1 D LOCK^%ZAPM.bs.BSF4
 D CL^%ZAPM.bs.BSF4,%LOCK^%ZAPM.bs.BSMSMGI G %U
D ;Delite
 S K1=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
DBEG I YY=$P(S(YY),"/",3) G:XX=$P(S(YY),"/") %C S S(YY,1)=$E(S(YY,1),1,XX-$P(S(YY),"/")-1)_$E(S(YY,1),XX-$P(S(YY),"/")+1,$$LNG^%ZAPM.bs.BSF12),XX=XX-1 D  G DEND
 .W /CUP(YY,XX),/EL(0),$E(S(YY,1),XX-$P(S(YY),"/")+1,$P(S(YY),"/",5)) S III=YY F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=YY  W /CUP(III,$P(S(III),"/")),/EL(0),$E(S(YY,1),$P(S(III),"/",4),$P(S(III),"/",5))
 I XX'>$P(S(YY),"/") S YY=YY-1,XX=80 G DBEG
 S S($P(S(YY),"/",3),1)=$E(S($P(S(YY),"/",3),1),1,$P(S(YY-1),"/",2)+XX-$P(S(YY),"/")-1)_$E(S($P(S(YY),"/",3),1),$P(S(YY-1),"/",2)+XX-$P(S(YY),"/")+1,$$LNG^%ZAPM.bs.BSF12),XX=XX-1 D  ;
 .W /CUP(YY,XX),/EL(0),$E(S($P(S(YY),"/",3),1),$P(S(YY),"/",4)+(XX-$P(S(YY),"/")),$P(S(YY),"/",5)) S III=YY,II=$P(S(YY),"/",3)
 .F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=II  W /CUP(III,$P(S(III),"/")),/EL(0),$E(S($P(S(YY),"/",3),1),$P(S(III),"/",4),$P(S(III),"/",5))
DEND S K2=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
 S YES="",M($P(S(YY),"/",3),3)="" I K1>K2 D YES S (I3,Y)=$P(S(YY),"/",3) D  D PUT,REM I XX<$P(S(YY),"/") S YY=YY-1,XX=80
 .S G=M(Y,1),Y=I3 D  D FOR,LOO S Y=I3-1 Q
 ..F I=I3:1:25 K M(I),S(I)
 G %C
KS(%1,%2) Q ($L($P(%1,"(",2))+$L(%2))\(79-$L($P(%1,"(")))+1
%U W /CUP(1,1),$$atr^%ZAPM.bs.BS3(0),/ED(2)
 S W=$E($$GetLock^%ZAPM.bs.BSXfun()),P=1 ;P=0-ПОЛЕ ИНДЕКСОВ/МЕТОК,1-СТРОК ;
BEGI I $D(@GLO)=0 G EXIT
 S Y=1,G=GLO K M,S D:$D(@G)'["0" FOR D CL,LOO S Y=0 D PUT,REM S YY=$O(S("")),Y1=1,Y2=0,XX=$P(S(YY),"/")
%C F  R *R:0  E  Q
 W /CUP(YY,XX) W $$rt^%ZAPM.bs.BS3(+$G(%BS(2),9999)) I R1=-1,%BS(13)="%BS-PC" D GLUC^%ZAPM.bs.BSXgluc G %C
 I R1=27,R2<0 D YES G EXIT
 I R1=12 D YES G H^%ZAPM.bs.BSMSMGO
 I R1=20 D YES G N^%ZAPM.bs.BSMSMGO
 I R1=10 G J^%ZAPM.bs.BSMSMGO //UNDO
 I R1=11 D YES G K^%ZAPM.bs.BSMSMGO
 G %C:$E(%CO,R1+1)=" ",@$E(%CO,R1+1):$E(%CO,R1+1)'="S" D  G %C
 .D ref(1) q
 .S K1=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1 I $L(S($P(S(YY),"/",3),1))>509,W W $$bel^%ZAPM.bs.BS3 D REM Q
 .I YY=$P(S(YY),"/",3) S S(YY,1)=$S(XX'=$P(S(YY),"/"):$E(S(YY,1),1,XX-$P(S(YY),"/")),1:"")_$C(R1)_$E(S(YY,1),XX-$P(S(YY),"/")+2-W,$$LNG^%ZAPM.bs.BSF12) W $C(R1) D:W  G SEND
 ..W $E(S(YY,1),XX-$P(S(YY),"/")+2,$P(S(YY),"/",5)) S III=YY F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=YY  W /CUP(III,$P(S(III),"/")),$E(S(YY,1),$P(S(III),"/",4),$P(S(III),"/",5))
 .I ($P(S(YY-1),"/",2)+XX-$P(S(YY),"/")+1)=509 W $$bel^%ZAPM.bs.BS3 D REM Q
 .S S($P(S(YY),"/",3),1)=$E(S($P(S(YY),"/",3),1),1,$P(S(YY-1),"/",2)+XX-$P(S(YY),"/"))_$C(R1)_$E(S($P(S(YY),"/",3),1),$P(S(YY-1),"/",2)+XX-$P(S(YY),"/")+2-W,$$LNG^%ZAPM.bs.BSF12) W $C(R1) D:W  ;
 ..W $E(S($P(S(YY),"/",3),1),$P(S(YY),"/",4)+(XX-$P(S(YY),"/")+1),$P(S(YY),"/",5)) S III=YY,II=$P(S(YY),"/",3)
 ..F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=II  W /CUP(III,$P(S(III),"/")),$E(S($P(S(YY),"/",3),1),$P(S(III),"/",4),$P(S(III),"/",5))
SEND .S K2=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
 .S YES="",M($P(S(YY),"/",3),3)="" I K1<K2 D YES S (I3,Y)=$P(S(YY),"/",3) D  D PUT,REM
 ..F I=Y:1 Q:'$D(S(I))  Q:Y'=$P(S(I),"/",3)
 ..I I>23 S GG=M($P(S(YY),"/",3),1),G=$O(M(0)),G=M(G,1),Y=0 K M,S D LOO D  S Y=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) Q
 ...S YY="" F  S YY=$O(S(YY),-1) Q:M($P(S(YY),"/",3),1)=GG
 ...S XX=$P(S(YY),"/") Q
 ..S G=M(Y,1),Y=I3 D  D FOR,LOO S Y=I3-1 Q
 ...F I=I3:1:25 K M(I),S(I)
 .S XX=XX+1 I XX>80 S YY=YY+1 W /CUP(YY,1)," " S XX=$P($G(S(YY),XX),"/")+1 W /CUP(YY,XX-1),$C(R1) Q
E ;ESC-КОДЫ
 I %ES[R3 S I=$F(%ES,R3)-2 G @$E(%EC,I,I+1):$T(@$E(%EC,I,I+1))'=""
 G %C
Z ;НОЛЬ-КОДЫ
 I R2=113,$E(%BS(1),3) D YES G ALTF10^%ZAPM.bs.BSMSMGO
 I R2=84 D YES D SHIFTF1^%ZAPM.bs.BSMSMGO,SCREEN G HM^%ZAPM.bs.BSMSMGE
 I R2=20 D YES G ALTT^%ZAPM.bs.BSMSMGO
 I R2=37 D YES G KILL^%ZAPM.bs.BSMSMGO
 ;I R2=97 D YES D ref(1),SCREEN G HM^%ZAPM.bs.BSMSMGE  //F4
 I R2=98 D YES G F5^%ZAPM.bs.BSMSMGO
 I R2=99 D YES G F6^%ZAPM.bs.BSMSMGO
 I R2=100 D YES G F6^%ZAPM.bs.BSMSMGO
 I %ES[R2 S I=$F(%ES,R2)-2 G @$E(%EC,I,I+1):$T(@$E(%EC,I,I+1))'=""
 G %C
I ;
 S YY=YY+1 D:'$D(S(YY))  S XX=$P($G(S(YY),XX),"/") G %C
 .D YES S Y=0,GG=$$ZO(G,1) I GG="" W $$bel^%ZAPM.bs.BS3 D REM S YY=YY-1 Q
 .D WAIT S G=GG,K1=$$KS(G,@G) S K2=0 F  S Y=$O(M(Y)),K2=K2+$$KS(M(Y,1),S(Y,1)) Q:K1'>K2
 .S G=M(Y,1),Y=0 K M,S D LOO S Y=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) D PUT F YY=23:-1:1 Q:$D(S(YY))
 .D REM Q
T ;
 S XX=XX+10 D  G %C
 .I XX>79 S YY=YY+1,XX=$P($G(S(YY),79),"/") Q
 .I $P(S(YY),"/",3)=YY,(XX-$P(S(YY),"/")+1)>$L(S(YY,1)) S XX=$P(S(YY),"/")+$L(S(YY,1)) Q
 .I $P(S(YY),"/",3)'=YY,(XX-$P(S(YY),"/")+1+$P(S(YY-1),"/",2))>$L(S($P(S(YY),"/",3),1)) S XX=$L(S($P(S(YY),"/",3),1))-$P(S(YY-1),"/",2)+$P(S(YY),"/") Q
ref(m) D
 .n i,g,G,ii,YES //РЕДАКТИРОВАТЬ В СТРОЧНОМ РЕДАКТОРЕ
 .S $ZT="ErRef"
 .S i=$P(S(YY),"/",3),G=M(i,1)
 .N S,M,YY,XX,oldata
 .S oldata=$G(@G)
 .I m=1 S i=$D(@G),ii=$G(@G),txt=G_"==="_$S(i["0":"НЕОПРЕДЕЛЕНО",ii="":"ПУСТО",1:"")
 .E  S i="",ii=G,txt="Редактируем индекс="_G
 .// //i $tr(%S,$c(127,5))'=%S s %S=$tr(%S,$c(127,5),$c(174,169))
 .i $TR(ii,$C(127,5),"")'=ii s ii=$TR(ii,$C(127,5),$c(174,169))
 .S S=$$LineEdit^%ZAPM.bs.BSXfun(ii,txt) Q:YES<1
 .i $tr(S,$c(174,169))'=S  s S=$tr(S,$c(174,169),$c(127,5))
 .I m,i["0",S="" D Yes^%ZAPM.bs.BSXfun("ВЫ ХОТИТЕ ВВЕСТИ ПУСТОЕ ЗНАЧЕНИЕ ?") Q:YES<1
 .i 'm S @S=oldata Q  //ИНДЕКС
 .S @G=S
 D SCREEN
 Q
ErRef D ErrMsg^%ZAPM.bs.BSXfun($ZE)
 Q
P ;ПЕРЕХОД НА ПОЛЕ ИНДЕКСОВ
F2 D YES D ref(0) g %C
 ;I '$D(Fname) S Fname="N:\123.TXT" I $ZU(140,4,Fname)'=0 O Fname:"UWN" U Fname W "-----",! W  W "-------",! U 0 C Fname 
 G ^%ZAPM.bs.BSMSMGI
TA ;
 S XX=XX-10 D  G %C
 .I XX<$P(S(YY),"/"),YY=$P(S(YY),"/",3) S XX=$P(S(YY),"/") Q
 .I XX<$P(S(YY),"/") S XX=79,YY=YY-1 Q
 .Q
LT ;
 S XX=XX-1 D  G %C
 .i '$d(S(YY)) Q
 .I XX<$P(S(YY),"/"),YY=$P(S(YY),"/",3) S XX=$P(S(YY),"/") Q
 .I XX<$P(S(YY),"/") S XX=79,YY=YY-1 Q
 .Q
RT ;
 S XX=XX+1 D  G %C
 .I XX>79 S YY=YY+1,XX=$P($G(S(YY),78),"/") Q
 .i '$d(S(YY)) Q
 .I $P(S(YY),"/",3)=YY,(XX-$P(S(YY),"/")+1)>$L(S(YY,1)) S XX=$P(S(YY),"/")+$L(S(YY,1)) Q
 .I $P(S(YY),"/",3)'=YY,(XX-$P(S(YY),"/")+1+$P(S(YY-1),"/",2))>$L(S($P(S(YY),"/",3),1)) S XX=$L(S($P(S(YY),"/",3),1))-$P(S(YY-1),"/",2)+$P(S(YY),"/") Q
 .Q
UP ;
 S YY=YY-1 D  G %C
 .I '$D(S(YY)) D YES D  Q
 ..S Y=0 I $$ZO(M($O(M("")),1),-1)="" W $$bel^%ZAPM.bs.BS3 S YY=YY+1 Q
 ..S G=$$ZO(M($O(M("")),1),-1) S Y2=1,Y=1 K M,S D FOR,LOO S Y=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) D PUT,REM S YY=1,XX=$P($G(S(YY),XX),"/") Q
 .I XX<$P(S(YY),"/"),YY=$P(S(YY),"/",3) S XX=$P(S(YY),"/") Q
 .I $P(S(YY),"/",3)=YY,(XX-$P(S(YY),"/")+1)>$L(S(YY,1)) S XX=$P(S(YY),"/")+$L(S(YY,1)) Q
 .I $P(S(YY),"/",3)'=YY,(XX-$P(S(YY),"/")+1+$P(S(YY-1),"/",2))>$L(S($P(S(YY),"/",3),1)) S XX=$L(S($P(S(YY),"/",3),1))-$P(S(YY-1),"/",2)+$P(S(YY),"/") Q
 .Q
DN ;
 S YY=YY+1 D  G %C
 .I '$D(S(YY)) D YES D  Q
 ..S Y=0 S:G'="" GG=$$ZO(G,1) S:G="" GG=G I GG="" W $$bel^%ZAPM.bs.BS3 D REM S YY=YY-1 Q
 ..D WAIT S G=GG,K1=$$KS(GG,@GG),K2=0 F  S Y=$O(M(Y)),K2=K2+$$KS(M(Y,1),S(Y,1)) Q:K1'>K2
 ..S G=M(Y,1),Y=0 K M,S D LOO S Y=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) D PUT S YY=$O(S(""),-1)
 ..D REM S XX=$P($G(S(YY),XX),"/") Q
 .I XX<$P(S(YY),"/"),YY=$P(S(YY),"/",3) S XX=$P(S(YY),"/") Q
 .I $P(S(YY),"/",3)=YY,(XX-$P(S(YY),"/")+1)>$L(S(YY,1)) S XX=$P(S(YY),"/")+$L(S(YY,1)) Q
 .I $P(S(YY),"/",3)'=YY,(XX-$P(S(YY),"/")+1+$P(S(YY-1),"/",2))>$L(S($P(S(YY),"/",3),1)) S XX=$L(S($P(S(YY),"/",3),1))-$P(S(YY-1),"/",2)+$P(S(YY),"/") Q
U ;
 D ref(1) G %C
 S K1=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
 I YY=$P(S(YY),"/",3) S S(YY,1)=$E(S(YY,1),1,XX-$P(S(YY),"/"))_$E(S(YY,1),XX-$P(S(YY),"/")+2,$$LNG^%ZAPM.bs.BSF12) D  G DLED
 .W /CUP(YY,XX),/EL(0),$E(S(YY,1),XX-$P(S(YY),"/")+1,$P(S(YY),"/",5)) S III=YY F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=YY  W /CUP(III,$P(S(III),"/")),/EL(0),$E(S(YY,1),$P(S(III),"/",4),$P(S(III),"/",5))
 S S($P(S(YY),"/",3),1)=$E(S($P(S(YY),"/",3),1),1,$P(S(YY-1),"/",2)+XX-$P(S(YY),"/"))_$E(S($P(S(YY),"/",3),1),$P(S(YY-1),"/",2)+XX-$P(S(YY),"/")+2,$$LNG^%ZAPM.bs.BSF12) D  G DLED
 .W /CUP(YY,XX),/EL(0),$E(S($P(S(YY),"/",3),1),$P(S(YY),"/",4)+(XX-$P(S(YY),"/")),$P(S(YY),"/",5)) S III=YY,II=$P(S(YY),"/",3)
 .F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=II  W /CUP(III,$P(S(III),"/")),/EL(0),$E(S($P(S(YY),"/",3),1),$P(S(III),"/",4),$P(S(III),"/",5))
DLED S K2=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
 S YES="",M($P(S(YY),"/",3),3)="" I K1>K2 W $$esc^%ZAPM.bs.BS3("[J") D YES S (I3,Y)=$P(S(YY),"/",3) D  D PUT,REM I XX'>$P(S(YY),"/"),YY'=$P(S(YY),"/",3) S YY=YY-1,XX=80
 .S G=$G(M(Y,2),M(Y,1)),Y=I3 D  D FOR,LOO S Y=I3-1 Q
 ..F I=I3:1:25 K M(I),S(I)
 G %C
IN ;
 S W=$S(W=0:1,1:0) D REM G %C ;ВСТАВКА СИМВОЛА
L ;
 S K1=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
 I YY=$P(S(YY),"/",3) S S(YY,1)=$E(S(YY,1),1,XX-$P(S(YY),"/")) W /CUP(YY,XX),/EL(0) G ELED
 S S($P(S(YY),"/",3),1)=$E(S($P(S(YY),"/",3),1),1,$P(S(YY-1),"/",2)+XX-$P(S(YY),"/")) W /CUP(YY,XX),/EL(0)
ELED S K2=($L($P(M($P(S(YY),"/",3),1),"(",2))+$L(S($P(S(YY),"/",3),1)))\(79-$L($P(M($P(S(YY),"/",3),1),"(")))+1
 S YES="",M($P(S(YY),"/",3),3)="" I K1>K2 W $$esc^%ZAPM.bs.BS3("[J") D YES S (I3,Y)=$P(S(YY),"/",3) D  D PUT,REM I XX'>$P(S(YY),"/"),YY'=$P(S(YY),"/",3) S YY=YY-1,XX=80
 .S G=$G(M(Y,2),M(Y,1)),Y=I3 D  D FOR,LOO S Y=I3-1 Q
 ..F I=I3:1:25 K M(I),S(I)
 G %C
PD ;
 D YES S G=M($O(M(""),-1),1) I $$ZO(G,1)="" W $$bel^%ZAPM.bs.BS3 D REM G %C
 S Y=0 K M,S D LOO S Y=0,YY=0,Y2=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) D PUT,REM G I
HM ;
 S YY=$P(S(YY),"/",3),XX=$P($G(S(YY),XX),"/") G %C
PU ;
 D YES I $O(M(""))="" W $$bel^%ZAPM.bs.BS3 G HM
 I $$ZO(M($O(M("")),1),-1)="" W $$bel^%ZAPM.bs.BS3 G HM
 D PUU G I
PUU S Y=0,GG=$O(M("")) I GG="" S G=GLO G PUU1
 S (GG,G)=M($O(M("")),1) F i=1:1:20 S GG=$$ZO(GG,-1) Q:GG=""  S G=GG
PUU1 S:GG'="" G=GG K M,S D LOO S Y=0,YY=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) D PUT,REM Q
WAIT D WAIT^%ZAPM.bs.BSF2 Q
EN ;
 S i=$P(S(YY),"/",3) F ii=YY:1 Q:$P($G(S(ii)),"/",3)'=i  S iii=ii
 S YY=iii,XX=78 G RT
F1 ;
 S IYI="^%ZAPM.bs.BSHLP(HELPGE" D F0 D  G %C
 .I $ZV["Cach"||($ZV["IRIS") D SCREEN
F0 D N^%ZAPM.bs.BSN("IYI"),ENTER^%ZAPM.bs.BSN,Q^%ZAPM.bs.BSN("IYI"),%LOCK^%ZAPM.bs.BSMSMGI Q
YES Q:'$D(YES)  S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSMSMGI"
YE S I="" F  S I=$O(M(I)) Q:I=""  I M(I)="KILL" X $S(%YES:"K @M(I,1),M(I)",1:"S EDI=EDI+1,EDI(EDI)=0,EDI(EDI,1)=M(I,1)")
 S I="" F  S I=$O(M(I)) Q:I=""  I $D(M(I,3)) X $S(%YES:"S @M(I,1)=S(I,1)",1:"S EDI=EDI+1,EDI(EDI)=1,EDI(EDI,1)=M(I,1),EDI(EDI,2)=S(I,1)")
 K YES S $ZT=$G(%zT) Q
FOR ;ФОРМИРОВАНИЕ СТРОКИ G-ГЛ.ССЫЛКА,Y-ИНДЕКСЫ   M(...,S(...
 S M(Y,1)=G,M(Y)=($L($P(G,"("))+1),S(Y)=($L(G)+1)_"/"_(79-$L(G))_"/"_Y_"/1/"_(79-$L(G)),II1=(79-$L(G)),S(Y,1)=@G,II=0
 S K1=($L($P(M(Y,1),"(",2))+$L(S(Y,1)))\(79-$L($P(M(Y,1),"(")))+1
 I K1>1 S I1=80-$L(G) F II=1:1:K1-1 S II1=II1+(79-M(Y)+1),S(Y+II)=M(Y)_"/"_II1_"/"_Y_"/"_I1_"/"_(I1+(79-M(Y))),I1=I1+(79-M(Y)+1)
 S Y=Y+II Q
PUT ;ПЕЧАТЬ СТРОКИ
 S I=$O(M(Y)) Q:I=""  D:I'["."  F  S I=$O(M(I)) Q:I=""  I I'["." D  ;
 .W /CUP(I,1) //,$$esc^%ZAPM.bs.BS3("[J")
 .W $$clr^%ZAPM.bs.BS3(11),M(I,1),$$atr^%ZAPM.bs.BS3(0),$E(S(I,1),1,$P(S(I),"/",5)) S III=I F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=I  W /CUP(III,$P(S(III),"/")),$E(S(I,1),$P(S(III),"/",4),$P(S(III),"/",5))
 .Q
 Q
LOO ;ЦИКЛ ПО ГЛОБАЛИ G=^NAM(...)
 S I2=G F  Q:Y>23  S Y=Y+1,I2=G,G=$$ZO(G,1) Q:G=""  D FOR
 I $D(S(Y)) S II=$P(S(Y),"/",3) F I=II:1:Y K M(I),S(I)
 Q
ZO(g,Ha) ;
Z1 S g=$ZO(@g,Ha) I g="" Q ""
 X FIL I  Q g
 G Z1
EXIT D U^%ZAPM.bs.BS3(GLO) D OP^%ZAPM.bs.BSF4 W $$atr^%ZAPM.bs.BS3(0) Q
CL D CL^%ZAPM.bs.BSF4 Q
SCREEN S Y=0,G=M($O(M("")),1),GG=$$ZO(G,-1) S:GG="" GG=$P(G,"(") S:GG'="" G=GG K M,S D LOO S Y=0 W $$atr^%ZAPM.bs.BS3(0),/ED(2) D PUT,REM Q
OP D OP^%ZAPM.bs.BSF4 Q
REM W $$clr^%ZAPM.bs.BS3(4),/CUP(24,1),/EL(0)," <F1>-ПОМОЩЬ <Ctrl-K>-УДАЛИТЬ УЗЕЛ <Ctrl-P>-ИНДЕКСЫ <Esc>-ВЫХОД " D  W $$atr^%ZAPM.bs.BS3(0) Q
 .W $S(W:"Вставка",1:"Замещение")
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMGF" type="MAC" languagemode="0"><![CDATA[
%BSMSMGF ; ПАКЕТНАЯ РАБОТА С ГЛОБАЛАМИ ; 17:54   23.12.1999
 Q
PROTOKOL(N) ;ПРОТОКОЛ РАБОТЫ
 N (%BS,vl,N) S BSR="^%ZAPM.bs.BSbufB",BST="%RSGBUF"_N D ^%ZAPM.bs.BST
 Q
NAKED(G) ;РАБОТА С ССЫЛКОЙ
 S t0=G_" ="_@G W !,t0 D CR^%ZAPM.bs.BSTT
 Q
FIND N PROX ;ПОИСК
 S PROX=1
FI N %GSEL,%GTEMP,FIND,%SE,%ST,%X,G,GG,g,g,t,t0,Coment,BSr,BSt,Obraz,%G,%JO
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSMSMGF"
 Q:'$$SEL
ASK3 D OP^%ZAPM.bs.BSF4 S %X=$$LineEdit^%ZAPM.bs.BSXfun("","Введите подстроку","","","",$$HISFIND^%ZAPM.bs.BSS()) I %X="",'$D(%SE(1)) Q
 I '$G(REPLAY),%X'="" S %ST=$G(%ST)+1,%SE(%ST)=%X G ASK3
 I $G(REPLAY) S %SE(1)=%X,%ST=1,REPLAY=$$LineEdit^%ZAPM.bs.BSXfun("","На что заменим ?") D Yes^%ZAPM.bs.BSXfun("С подтверждением ?",1) S REPLA=YES
GO D TXT(PROX) S G="" F  S G=$O(@%GTEMP@(G)) Q:G=""  S g="^"_G F  S g=$ZO(@g) Q:g=""  D  I $D(STOP) ZT "EXIT"
 .F I=1:1:%ST I @g[%SE(I) D NAKED(g) I $D(REPLAY) D REPL(REPLA>0) U 0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1)
EXIT D QU Q
ER I $ZE["ZEXI" D ErrMsg^%ZAPM.bs.BSXfun("Прервано...") S $ZT=$G(%zT) G EXIT
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) G EXIT
REPL(Y) I Y W !!,"Заменим на: ",$$TR^%ZAPM.bs.BSsFUNM(@g,%SE(1),REPLAY),!!,"[E]-Редактор ручками...Есть варианты, выберай [Y/N/E/Q] <N>" R *Y S Y=$C(Y) Q:("N"_$C(13))[Y  I Y="E" D  Q
 .S Y=$$LineEdit^%ZAPM.bs.BSXfun(@g,g) Q:YES<0  S @g=Y
 I "^Q"[Y S STOP=1
 S @g=$$TR^%ZAPM.bs.BSsFUNM(@g,%SE(1),REPLAY)
 Q
SEL() U 0 W $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) D OP^%ZAPM.bs.BSF4
 I $ZV["MSM" D ^%GSEL,CL^%ZAPM.bs.BSF4 S %Jo=$J,%G=%GSEL I +$G(%GSEL)=0 G NOSEL
 I $ZV["Cach"||($ZV["IRIS") D ^%GSET S %Jo=%JO,%GTEMP="^UTILITY(%JO)",%GSEL=%G I '%G G NOSEL
 D CL^%ZAPM.bs.BSF4
 I $D(@%GTEMP@("%BSbufB")) K @%GTEMP@("%BSbufB")
 Q 1
NOSEL D ErrMsg^%ZAPM.bs.BSXfun("Массивы не выбраны") Q 0
QU D OkMsg^%ZAPM.bs.BSXfun("Обработан(о) "_$G(%GSEL,%G)_" Массив(ов)")
 S Coment=$$TX D CREAT^%ZAPM.bs.BSTT
 Q
TX() Q "- Поиск "_$S(PROX=2:"И Замена данных",PROX=3:"по фильтру",1:"")_" в массивах."
TXT(PROX) ;ПОДГОТОВКА ПРОТОКОЛА
 S BSr="^%ZAPM.bs.BSbufB",BSt="%RSGBUF"_PROX,Obraz(12)=1,Obraz(21)=1
 S t0=$$TX_" Введите <ALT-G> для входа в редактор" D CR^%ZAPM.bs.BSTT U 0 W !,$$TX,!
 I $D(%SE) F I=1:1:$G(%ST,1) S t0="- "_%SE(I) W t0,! D CR^%ZAPM.bs.BSTT
 I $D(FIL) S t0="- "_FIL W t0,! D CR^%ZAPM.bs.BSTT
 S t0=" " D CR^%ZAPM.bs.BSTT
 Q
REPLAY ;ЗАМЕНА
 N REPLAY,PROX,REPLA
 S REPLAY=1,PROX=2 G FI
FILTER ;ФИЛЬТР
 N FIL,%GSEL,%GTEMP,PROX,FIND,%SE,%ST,%X,G,GG,g,t,t0,Coment,BSr,BSt,Obraz
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSMSMGF"
 Q:'$$SEL  S FIL="",PROX=3,g="^%ZAPM.bs.BSbufB" D FILT^%ZAPM.bs.BSMSMG Q:$G(FIL)=""
 D TXT(3) S G="" F  S G=$O(@%GTEMP@(G)) Q:G=""  S g="^"_G F  S g=$ZO(@g) Q:g=""  X FIL_" D NAKED(g)"
 D QU Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMGI" type="MAC" languagemode="0"><![CDATA[
%BSMSMGI ;ПОЛНОЭКРАННЫЙ РЕДАКТОР ИНДЕКСОВ ; 21:20 24-FEB-99
 W $$clr^%ZAPM.bs.BS3(11) S P=1,YY=$P(S(YY),"/",3),XX=$L($P(M(YY,1),"("))+2
 
  G %C
D ;ЗАБОЙ
 I '$D(M(YY,2)) S M(YY,2)=M(YY,1)
 S M(YY,1)=$E(M(YY,1),1,XX-2)_$E(M(YY,1),XX,255),XX=XX-1
 W $$clr^%ZAPM.bs.BS3(11),/CUP(YY,XX),$E(M(YY,1),XX,255)
 S YES="",M(YY,3)=""
%C W /CUP(YY,XX) W $$rt^%ZAPM.bs.BS3(+$G(%BS(2),9999)) I R1=-1,%BS(13)="%BS-PC" D GLUC^%ZAPM.bs.BSXgluc G %C
 G %C:$E(%CO,R1+1)=" ",%C:$T(@$E(%CO,R1+1))="",@$E(%CO,R1+1):$E(%CO,R1+1)'="S" D  G %C
 .I '$D(M(YY,2)) S M(YY,2)=M(YY,1)
S .;SET
 .I $L(M(YY,1))>77 W $$bel^%ZAPM.bs.BS3 D REM Q
 .S M(YY,1)=$E(M(YY,1),1,XX-1)_$C(R1)_$E(M(YY,1),XX+1-W,255) I $E(M(YY,1),$L(M(YY,1)))'=")" S M(YY,1)=M(YY,1)_")"
 .W $$clr^%ZAPM.bs.BS3(11),$C(R1),$E(M(YY,1),XX+1,255)
 .S YES="",M(YY,3)="",XX=XX+1 Q
E ;ESC-КОДЫ
 I R2<0 D LOG E  G END
 I %ES[R3 S I=$F(%ES,R3)-2 G @$E(%EC,I,I+1):$T(@$E(%EC,I,I+1))'=""
 G %C
Z ;
 I %ES[R2 S I=$F(%ES,R2)-2 G @$E(%EC,I,I+1):$T(@$E(%EC,I,I+1))'=""
 G %C
I ;
 D LOG I  G %C
II S YY=$O(M(YY)) G:YY="" II S XX=$L($P(M(YY,1),"("))+2 G %C
P ;ПЕРЕХОД НА ПОЛЕ ДАННЫХ
 D LOG I  G %C
 G END
LT ;ВЛЕВО
 S XX=XX-1 D  G %C
 .I XX<($L($P(M(YY,1),"("))+2) S XX=$L($P(M(YY,1),"("))+2
 .Q
RT ;
 S XX=XX+1 D  G %C
 .I XX>($L(M(YY,1))) S XX=($L(M(YY,1))) Q
 .Q
UP ;
 D LOG I  G %C
UUPP F I=YY-1:-1:-2 Q:$D(M(I))
 I I<1 S YY=26 G UUPP
 S YY=I
UPP I XX>($L(M(YY,1))) S XX=($L(M(YY,1)))
 G %C
DN ;
 D LOG I  G %C
DNN S YY=$O(M(YY)) G:YY="" DNN
 G UPP
IN ;
 S W=$S(W=0:1,1:0) D REM G %C ;ВСТАВКА СИМВОЛА
LOG ;КОНТРОЛЬ ИНДЕКСА И ЗАПИСЬ В БАЗУ
 S %zT=$ZT,$ZT="INDER^%ZAPM.bs.BSMSMGI" K III
 S @("III("_$P(M(YY,1),"(",2))=123 S:$D(III) III=0 I '$D(III) D INDE Q
 S $ZT=$G(%zT)
YES Q:'$D(M(YY,3))
 I $D(@M(YY,1))'["0" S ls=" "_M(YY,1)_" УЖЕ СУЩЕСТВУЕТ, ПЕРЕЗАПИШЕМ ? " D YES^%ZAPM.bs.BSF W $$clr^%ZAPM.bs.BS3(11) I 'YES&($D(M(YY,2))) S M(YY,1)=M(YY,2) D  K M(YY,3),YES G YYYY
 .W $$clr^%ZAPM.bs.BS3(11),/CUP(I,1),/EL(0),M(I,1),$$atr^%ZAPM.bs.BS3(0),$E(S(I,1),1,$P(S(I),"/",5)) S III=I F  S III=$O(S(III)) Q:III=""  Q:$P(S(III),"/",3)'=I  D  W $E(S(I,1),$P(S(III),"/",4),$P(S(III),"/",5))
 ..W /CUP(III,1),$$esc^%ZAPM.bs.BS3("[J"),/CUP(III,$P(S(III),"/")) Q
 X $S(%YES:"S @M(YY,1)=S(YY,1)",1:"S EDI=EDI+1,EDI(EDI)=1,EDI(EDI,1)=M(YY,1),EDI(EDI,2)=S(YY,1)")
 K M(YY,3),YES
YYYY D SCREEN^%ZAPM.bs.BSMSMGE
 S YY=$S($D(M(YY)):YY,1:$O(M(YY))) S:YY="" YY=$O(M(YY)) S XX=$L($P(M(YY,1),"("))+2 Q
INDER D INDE S $ZT=$G(%zT) Q
INDE D ErrMsg^%ZAPM.bs.BSXfun(" ОШИБКА В ИНДЕКСЕ "),REM Q
WAIT Q
K ;
 D ErrMsg^%ZAPM.bs.BSXfun(" УДАЛИТЬ МОЖНО ТОЛЬКО ИЗ ПОЛЯ ДАННЫХ "),REM G %C
F1 ;
 S IYI="^%ZAPM.bs.BSHLP,HELPGI" D F0^%ZAPM.bs.BSMSMGE G %C
END D SCREEN^%ZAPM.bs.BSMSMGE
 S YY=$S($D(M(YY)):YY,1:$O(M(YY))) S:YY="" YY=$O(M(YY)) S XX=$P(S(YY),"/") W $$atr^%ZAPM.bs.BS3(0) G %C^%ZAPM.bs.BSMSMGE
CL D CL^%ZAPM.bs.BSF4 Q
OP D OP^%ZAPM.bs.BSF4 Q
REM W $$clr^%ZAPM.bs.BS3(4),/CUP(24,1),/EL(0)," <F1>-ПОМОЩЬ  <Ctrl-P>-ИНДЕКСЫ <Esc>-ВЫХОД " D  W $$clr^%ZAPM.bs.BS3(11) Q
 .W $S(W:"Вставка",1:"Замещение")
 ;
%LOCK ;ЛОКАЛЬНЫЕ ПЕРЕМЕННЫЕ
 S %ES="65,66,67,68,71,82,73,81,79,00,80,81,82,83,84,85,86,87,88,89,15"
 S %EC="UP,DN,RT,LT,HM,IN,PU,PD,EN,DL,F1,F2,F3,F4,F5,F6,F7,F8,F9,F0,TA"
 S %CO="Z       DTJKHI  P   N      E L  ",%CO=%CO_$TR($J("",220)," ","S")
 S $E(%CO,128)="U",%W=0 Q
BEGIN O 0:(0::::#10080) Q
e ;
ERR S ls=$ZE D O^%ZAPM.bs.BSF7 W $$r^%ZAPM.bs.BS3 D SCREEN^%ZAPM.bs.BSMSMGE Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMGO" type="MAC" languagemode="0"><![CDATA[
%BSMSMGO ;ПОЛНОЭКРАННЫЙ РЕДАКТОР МАССИВОВ (II PART) ; 21:21 24-FEB-99
%C G %C^%ZAPM.bs.BSMSMGE
H ;
 D AddHist^%ZAPM.bs.BSXuse("^%ZAPM.bs.BSbufB(""HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")",$$LEND()) G %C
N ;OUT HISTORY
 S Tmp1=$G(^%ZAPM.bs.BSbufB("HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1"),1))
SETN S Tmp=$E($$LBEG()_Tmp1_$S(W:$$LEND(),1:$E($$LEND(),$L(Tmp1)+1,$$LNG^%ZAPM.bs.BSF12)),1,509)
 S i=YY,Y=$P(S(YY),"/",3) S @M(Y,1)=Tmp D SCREEN^%ZAPM.bs.BSMSMGE G %C
J ;ОТМЕНА
 ;S S(YY,1)=@M($P(S(YY),"/",3),1) D SCREEN^%ZAPM.bs.BSMSMGE
 K M($P(S(YY),"/",3),3) D SCREEN^%ZAPM.bs.BSMSMGE
 G HM^%ZAPM.bs.BSMSMGE
ALTT s Tmp1=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB","HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")) G:'YES %C G SETN
SHIFTF1 S IYI="^%ZAPM.bs.BSS(ShiftF1" D SA^%ZAPM.bs.BSsBUF,F0^%ZAPM.bs.BSMSMGE,RE^%ZAPM.bs.BSsBUF Q  ;;G %C
ALTF10 D CM^%ZAPM.bs.BSF6 G %C
K ;УДАЛЕНИЕ УЗЛА БЕЗ ПОДТВЕРЖДЕНИЯ
 I '$$AccesMSM^%ZAPM.bs.BSDOS2(3) D PROT^%ZAPM.bs.BSMSM G %C
 S i=YY,Y=$P(S(YY),"/",3) I $D(@M(Y,1))'=1 S ls=" УДАЛЯТЬ "_$ZR_" !!! ВЫ УВЕРЕНЫ ? " D YES^%ZAPM.bs.BSF I 'YES G %C
KI S G=M(Y,1),%zT=$ZT,$ZT="ERR^%ZAPM.bs.BSMSMGI" D  S $ZT=$G(%zT),(I3,Y)=Y-1 D LOO^%ZAPM.bs.BSMSMGE W /CUP(I3,80),$$esc^%ZAPM.bs.BS3("[J") S Y=I3 D PUT^%ZAPM.bs.BSMSMGE,REM^%ZAPM.bs.BSMSMGE S I=$O(S(""),-1)
 .K @M(Y,1) F I=Y:1:25 K M(I),S(I)
 I I="" D PUU^%ZAPM.bs.BSMSMGE Q  ;G I
 S YY=$S('$D(S(i)):I,1:i),XX=$P(S(YY),"/") G %C
F5 ;КОПИРОВАНИЕ ДЕРЕВА В БУФЕР
 S i=YY,Y=$P(S(YY),"/",3) I $D(@M(Y,1))=1 D ErrMsg^%ZAPM.bs.BSXfun("Потомков Нет") G %C
 D CopyF5(10,$ZR)
 G %C
CopyF5(U,TRe1) N UU K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),U)
 S TRe2=$NA(@("^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),U,"_$P(TRe1,"(",2,99))),UU=TRe1
 D Copy^%ZAPM.bs.BSF8(TRe1,TRe2,0,1),OkMsg^%ZAPM.bs.BSXfun("Узел ("_$P(UU,"(",2,999)_" скопирован в Буфер") Q
CopyF6(TRe1,TRe2) D Copy^%ZAPM.bs.BSF8(TRe1,TRe2,1,1) D OkMsg^%ZAPM.bs.BSXfun("Узел из Буфера Смешали с ("_$P(TRe2,"(",2,99)) Q
F6 ;КОПИРОВАНИЕ ИЗ БУФЕРА В ТЕКУЩИЙ УЗЕЛ
 S i=YY,Y=$P(S(YY),"/",3) I $D(@M(Y,1))
 S TRe2=$ZR I '$D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),10)) D ErrMsg^%ZAPM.bs.BSXfun("Буфер Пуст") G %C
 S TRe1=$ZR S TRe1=$$LineEdit^%ZAPM.bs.BSXfun(TRe1,"Можете редактировать исходный узел")
 S TRe2=$$LineEdit^%ZAPM.bs.BSXfun(TRe2,"Можете редактировать целевой узел")
 D CopyF6(TRe1,TRe2)
 S G=M(Y,1),%zT=$ZT,$ZT="ERR^%ZAPM.bs.BSMSMGI" S $ZT=$G(%zT),(I3,Y)=Y-1 D LOO^%ZAPM.bs.BSMSMGE W /CUP(I3,80),$$esc^%ZAPM.bs.BS3("[J") S Y=I3 D PUT^%ZAPM.bs.BSMSMGE,REM^%ZAPM.bs.BSMSMGE S I=$O(S(""),-1)
 I I="" D PUU^%ZAPM.bs.BSMSMGE Q  ;G I
 S YY=$S('$D(S(i)):I,1:i),XX=$P(S(YY),"/") G %C
KILL ;G %C ;!!!УДАЛЕНИЕ УЗЛА БЕЗ УДАЛЕНИЯ ПОТОМКОВ
 I '$$AccesMSM^%ZAPM.bs.BSDOS2(3) D PROT^%ZAPM.bs.BSMSM G %C
 S i=YY,Y=$P(S(YY),"/",3) I $D(@M(Y,1))=1 G KI
 S TRe1=$P($ZR,")"),TRe2="^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",9,"_$P(TRe1,"(",2,99) K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),9) D TREE K @(TRe1_")")
 S TRe2=$P(TRe1,"(")_"(",TRe1="^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",9" D TREE
 S G=M(Y,1),%zT=$ZT,$ZT="ERR^%ZAPM.bs.BSMSMGI" S $ZT=$G(%zT),(I3,Y)=Y-1 D LOO^%ZAPM.bs.BSMSMGE W /CUP(I3,80),$$esc^%ZAPM.bs.BS3("[J") S Y=I3 D PUT^%ZAPM.bs.BSMSMGE,REM^%ZAPM.bs.BSMSMGE S I=$O(S(""),-1)
 I I="" D PUU^%ZAPM.bs.BSMSMGE Q  ;G I
 S YY=$S('$D(S(i)):I,1:i),XX=$P(S(YY),"/") G %C
TREE S ls="Копи..."_TRe1_" В "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2 S j=TRe1_")"
 S jj=$S(TRe1["]":$P(TRe1,"]",2,99),1:$P(TRe1,"^",2,99))_","
 S jjj=$S($E(TRe2,$L(TRe2))="(":"",1:",")
 F  S j=$ZO(@j) Q:$S(j["]":$P(j,"]",2,99),1:j)'[jj  S @(TRe2_jjj_$P(j,jj,2,9))=@j X WA
 Q
ZO(g,Ha) ;
Z1 S g=$ZO(@g,Ha) I g="" Q ""
 X FIL I  Q g
 G Z1
CL D CL^%ZAPM.bs.BSF4 Q
OP D OP^%ZAPM.bs.BSF4 Q
LEND() I YY=$P(S(YY),"/",3) Q $E(S(YY,1),XX-$P(S(YY),"/")+1,$$LNG^%ZAPM.bs.BSF12)
 Q $E(S($P(S(YY),"/",3),1),$P(S(YY-1),"/",2)+XX-$P(S(YY),"/")+1,$$LNG^%ZAPM.bs.BSF12)
LBEG() I YY=$P(S(YY),"/",3) Q $E(S(YY,1),1,XX-$P(S(YY),"/"))
 Q $E(S($P(S(YY),"/",3),1),1,$P(S(YY-1),"/",2)+XX-$P(S(YY),"/"))
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSMSMS" type="MAC" languagemode="0"><![CDATA[
%BSMSMS(ObEkT,KaTvY,T) ; пpогpамма КАТАЛОГА ПРОГРАММ И МАССИВОВ ;  9:47 28-APR-97
 ;ObEkT=1/2 ПРОГ\МАСС KaTvY=~D\~L ВЕСЬ КАТАЛОГ\ВЫБРАННЫЕ  T=МАССИВ ВЫБОРКИ
 N G,I,II,III,J,JJ,L,BSR,BST,NEW,P
 I KaTvY="~D" G:$D(T) DI D P,@ObEkT,TAB Q
 I KaTvY="~L" G LI
 W !,"Команды ",KaTvY," нет" Q
DI D P,@ObEkT,MARK,TAB,MODIF G EX
LI D P,L,MARK,TAB,MODIF
EX W /CUP(1,1),/ED(2)
 D OP^%ZAPM.bs.BSF4 Q
ADD(I) ;ДОБАВЛЕНИЕ
 I $D(NEW) K NEW S L=L+1,J=0 F JJ=1:1:4 S @G@(L,JJ)=^%ZAPM.bs.BSS("DIR2",2,2)
 S J=J+1
 S $P(@G@(L,J),"@",15)=I I '(J#4) S NEW=1
 Q
TAB S li=G D TIR^%ZAPM.bs.BST4
 S BSR=$P(li,",",2),BST=$P(li,","),ke=4,se=L D RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1
 S IYI=BSR_"("_BST N (IYI,%BS,vl,dat) D ENTER^%ZAPM.bs.BSN S:R1=27 dat=""
 Q
MODIF ;ПОСТМОДИФИКАЦИЯ
 K @T S L=1,@P=0 F  S L=$O(@G@(L)) Q:'L  F J=1:1:4 I $P(@G@(L,J),"@",15)'="",$P(@G@(L,J),"@",12) S @T@($P(@G@(L,J),"@",15))="",@P=@P+1
 Q
MARK D MARK^%ZAPM.bs.BSF11(G,T) Q
P ;ПОДГОТОВКА
 S G=$$TMPG^%ZAPM.bs.BSF11 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""DIR2"")",G)
 S J=0,L=2,II=@G@(2,3),$P(@G@(1,3),"@",15)=$S($G(ObEkT)=1:"routines",1:"globals")
 S $P(@G@(1,2),"@",15)=" "_$S($G(KaTvY)="~D":"Directory",1:"Selected")
 S P=$S($G(ObEkT)=1:"%RSN",1:"%GSN") Q
L S I=""
 F  S I=$O(@T@(I)) Q:I=""  D ADD(I)
 Q
 ///z Routines
1 S I=""
 F  S I=$O(^ROUTINE(I)) Q:I=""  D ADD(I)
 Q
 ///z Globals
2 S I="" new list 
 d GetGlobalDir^%ZAPM.bs.BSCp($namespace,.list)
 F  S I=$Order(list(I)) Q:I=""  Do ADD(I)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSN" type="MAC" languagemode="0"><![CDATA[
%BSN ;ВЫЗОВ ТАБЛИЦ,ДИНАМИЧЕСКИЙ РАЗДЕЛ,СОЗДАНИЕ МЕНЮ И ТАБЛИЦ ; 16:41   01.04.2001
S(%z,%zz) S ^(%z)=$E(%zz,1,$$LNG^%ZAPM.bs.BSF12) Q  ;!!!!!!!!
N(%zzzzz) D %nN(1) K ^%ZAPM.bs.BSbufB("AN"_$G(%BS(3),$P)_$J_"u"_$G(%nN)) I $D(^("AN"_$G(%BS(3),$P)_$J_"u"_$G(%nN),1))
 I $ZV["MSM" S %zzz=$O()
 I $ZV["Cach"||($ZV["IRIS") S %zzz="",%zzz=$O(@%zzz)
 S %zzzzz=","_%zzzzz_",%nN," F  S %zzz=$O(@%zzz) Q:%zzz=""  I %zzz'["%zzz",%zzzzz'[(","_%zzz_",") D
 .I $D(@%zzz)=1 D S(%zzz,@%zzz) Q
 .D:$D(@%zzz)=11 S(%zzz,@%zzz) S %zzzz=%zzz F  S %zzzz=$Q(@%zzzz) Q:%zzzz=""  D S(%zzzz,@%zzzz)
K X "K (%BS,"_$P(%zzzzz,",",2,$L(%zzzzz,",")-1)_")" Q
Q(%zzzzz) S %zzzzz=","_%zzzzz_",%zzzzz,%nN," D K,%nN(0) S %zzz="" F  S %zzz=$O(^%ZAPM.bs.BSbufB("AN"_$G(%BS(3),$P)_$J_"u"_$G(%nN),%zzz)) Q:%zzz=""  I %zzzzz'[(","_$P(%zzz,"(")_",") S @%zzz=^(%zzz)
 K %zzz,^%ZAPM.bs.BSbufB("AN"_$G(%BS(3),$P)_$J_"u"_$G(%nN)) D %nN(-1) K %nN Q
%nN(z) S %nN=$G(^%ZAPM.bs.BSbufB("AN"_$G(%BS(3),$P)_$J_"u"),0)+z S ^%ZAPM.bs.BSbufB("AN"_$G(%BS(3),$P)_$J_"u")=%nN Q
BSTG(IYI,trig) D NE Q $S($G(trig):$G(date),1:dat)
BST(tr,trig) D  D NE Q $S($G(trig):$G(date),1:dat)
 .S IYI=$P(tr,",") Q  ;!!!!!!!!!!!!!!!!!!
NEM S li="" Q
Table(P,T) N IYI,ny,nx,dat,date,d,d1,d0 S IYI=P_","_T D NE^%ZAPM.bs.BSN S YES=$G(%BS("Tmp","LastTabl"))_"@"_date Q
NEW S IYI=$P(@(BSR_"(BST,ny,nx)"),"@",$G(l4,14))
NEB G XEC^%ZAPM.bs.BSF3:IYI?.N1",".N,NEM:IYI?1"I ".N D NE S $ZT=$G(%zT),li=$G(date) K date D:$D(%CAL) CALC^%ZAPM.bs.BSF3 Q
NE D SA^%ZAPM.bs.BSsBUF,ENTER S ENTERkk=1 D RE^%ZAPM.bs.BSsBUF S Refresh=1 K IYI,ENTERkk Q
ENTER D SI ;```I $ZV["Cach"||($ZV["IRIS") N (%BS,vl,EXITout,d,FLine,%zT,%KAT,%File,IYI,date,R1,dat,Key0,Key1,Key2,Key3,Key4,Key5,Key6,Key7,Key8,Key9)
 D NNN(",Key0,Key1,Key2,Key3,Key4,Key5,Key6,Key7,Key8,Key9")
 ;N (%BS,EXITout,d,%zT,%KAT,%File,IYI,date,R1,dat) D SI
 ;N S,STATUS,VYC,BS0,BSX,BSY,B,BX,BY,x,t,zr,t1,%VDB,%CAL,%X1,%X2,%Y1,%Y2,%TIT,MR,%w(2),M1,BS,%w(4),%w(5),%DIA,%DI,%DIAP,%ZAP,%FK,i,j,ii,jj,se,ke,j1,j2,j3,MX,MY,M,BS1,BS2,BSF,BSX1,
 ;...BSX2,BSY1,BSY2,CLR,ENDLI,BSI,BSII,MR23,MR24,MR25,NAZAD,li,ls,lo,BSR,BST,RA,PREDMOV,MxX,MyY,My,Mx,COLOR,EXITout,%FN,%DEV,%Cu,es,ek,h,hi,hl,%INV,%INV1,%INV2,v,vv,vvv,%Co,%R,%a,%r,%JB,%BS(5),LAB,OO,OOO,TAB,TIP,f,ft D SI
 ;N BSR,BST,RA,PREDMOV,MxX,MyY,My,Mx,COLOR,EXITout,%FN,%DEV,%Cu,es,ek,h,hi,hl,%INV,%INV1,%INV2,v,vv,vvv,%Co,%R,%a,%r,%JB,%BS(5),LAB,OO,OOO,TAB,TIP,f,ft D SI
 S YES=1 I IYI[")" S BSR=$P(IYI,"("),BST=$P($P(IYI,"(",2),")") S BST=$S(BST=+BST:BST,1:$P(BST,$C(34),2)) G ENT1 ;D IN^%ZAPM.bs.BST(IYI) G ENTE
 I IYI["(" S BSR=$P(IYI,"("),BST=$P(IYI,"(",2) S:BSR'["^" BSR="^"_BSR G ENT1
 I IYI["<>" D PBD(IYI) G QQ:'YES,ENT
 E  S BSR=$P(IYI,",",1,$L(IYI,",")-1),BST=$P(IYI,",",$L(IYI,",")) S:BSR'["^" BSR="^"_BSR
ENT1 I BST="<INV>" D INV G:'YES QQ
ENT D STA^%ZAPM.bs.BST
ENTE I $D(IMQ),$D(%BS("Tmp","EXIToutBD",IMQ)) S d=%BS("Tmp","EXIToutBD",IMQ),R1=13 K %BS("Tmp","EXIToutBD",IMQ)
 S date=$S($G(R1,27)=27:"",1:$G(d)),dat=$G(d)
QQ D QQQ("") Q
NNN(fzq) D N("%BS,vl,EXITout,d,FLine,%zT,%KAT,%File,IYI,date,R1,dat"_$G(fzq)) Q
QQQ(fzq) D Q("%BS,vl,EXITout,d,%zT,%KAT,FLine,%File,IYI,date,R1,dat"_$G(fzq)) Q
e Q
SI D:$S<20000 SIZE(20) Q
SIZE(%Sz) I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 Q:'$G(%Sz)  S %Sz=($V(108,$J,4)\1024)+%Sz
 I $S ;%Sz-НА СКОЛЬКО КБАЙТ УВЕЛИЧИТЬ РАЗДЕЛ
 V 108:$J:%Sz*1024:4 Q
DEL I R3=85 D PASE^%ZAPM.bs.BST1 I $D(%w(4)) S ls=" ВНИМАНИЕ !!!! ВЫ ТОЧНО ХОТИТЕ НАСИЛЬНО ОСВОБОДИТЬ ФАЙЛ-СЕРВЕР ? ",R1=27 D YES^%ZAPM.bs.BSF I YES I $D(gl) K @gl
 I R3=86 D PASE^%ZAPM.bs.BST1 I $D(%w(4)) D  S ls=" ВЫ ХОТИТЕ НАСИЛЬНО ПРЕКРАТИТЬ СЕАНС РАБОТЫ ПОЛЬЗОВАТЕЛЯ "_$P(i1,",",3)_" ? ",R1=27 D YES^%ZAPM.bs.BSF I YES I $D(gl) S @(gl_"(2,"_i1_")")="OUT"
 .S i1="" F j=2,4,6 S i2=$P(@(BSR_"(BST,ny,j)"),"@",15),i1=i1_$S(i2=+i2:i2,1:""""_i2_"""")_$S(j=6:"",1:",")
 I R3=87 G D^%ZAPM.bs.BS:ny<2 D  Q:R1=27
 .I '$D(%w(4)) D PASE^%ZAPM.bs.BST1 I '$D(%w(4)) Q
 .I $D(%DIA) S do="D DE^%ZAPM.bs.BSN" D BLOK^%ZAPM.bs.BSF1 Q
 .S i=ny D DE Q
D G D^%ZAPM.bs.BS
DE S %NAM="^"_$P(@(BSR_"(BST,i,12)"),"@",15),%TAB=$P(^(10),"@",15),uci=$P(^(14),"@",15)_","_$P(^(16),"@",15) Q:uci["="!(%TAB="")
 S ls=" ОСВОБОДИМ "_%TAB_","_$P(%NAM,"^",2)_","_uci_" ВЫ УВЕРЕНЫ ? " D YES^%ZAPM.bs.BSF I 'YES Q
 D %GU^%ZAPM.bs.BSF4 ;!!!I %NAM="^%ZAPM.bs.BSbufS" S %TAB="^["""_$P(%TAB,":")_""":"""_$P(%TAB,":",2)_"""]"_$P(%TAB,":",3,99)
 S $P(@(%NAM_"(%TAB)"),"@",30)="",R1=27 Q
INV ;ПСЕВДО-ТАБЛИЦА
 I $D(^%ZAPM.bs.BSbufB("INV"_$G(%BS(3),$P)_$J_"u"_BSR)),$P(@$ZR,"@")=$P(@BSR,"@",7) S BST="INV"_$G(%BS(3),$P)_$J_"u"_BSR,BSR="^%ZAPM.bs.BSbufB" Q
 S ke=2,BSr="^%ZAPM.bs.BSbufB",BSt="INV"_$G(%BS(3),$P)_$J_"u"_BSR,ii="",ls="ДЕЛАЕТСЯ ПСЕВДО-ТАБЛИЦА" D WAITS^%ZAPM.bs.BSF2
 S %zT=$ZT,$ZT="ERFOR^%ZAPM.bs.BSN"
 S head=$P(@BSR,"@",7),col(1)=$P(%BS,"!",6),col(2)=$P(%BS,"!",7) I $P(@BSR,"@",8) D  F  S ii=$O(@BSR@(1,ii)) Q:ii=""  S t1=ii,t2=@BSR@(1,ii) D CR S v=1
 .I $P($ZV,"Version ",2)'<4 S l1=$L($O(@BSR@(1,""),-1))+1,l2=79-l1 Q
 .S l1=9,l2=71
 I '$P(@BSR,"@",8) F  S ii=$O(@(BSR_"(ii)")) Q:ii=""  S l1=$L(ii)+1 S t1=ii,t2=@(BSR_"(ii)") S l2=79-l1 D CR S v=1 I '(ii#10) X $G(WA)
 S Fk="" D CREAT S $P(@(BSr_"(BSt)"),"@")=head,YES=1,$ZT=$G(%zT) K head Q
ERFOR D ErrMsg^%ZAPM.bs.BSXfun($ZE) S YES=0 Q
PBD(IYI) N Fk,tIT,BKs,l1,BSt,BSr,GL,BSd,ke,t1,i,ii,se,cc ;ТАБЛИЦА ЗНАЧЕНИЙ КЛЮЧЕЙ БАЗЫ ДАННЫХ
 S %zT=$ZT,$ZT="ERFOR^%ZAPM.bs.BSN"
 S BSr=$P(IYI,",",2),BSt=$P(IYI,",",1) S:BSr["^" BSr=$P(BSr,"^",2) S BSr="^["""_$P(IYI,",",3)_""","""_$P(IYI,",",4)_"""]"_BSr S BSd=$P($G(@(BSr_"(BSt,""KEY"")")),"@") I BSd="" S YES=0 Q
 S ii=0 F i=5:1 Q:$P(IYI,",",i)="<>"  Q:i'=5&($P(IYI,",",i)="")  S BKs(ii)=$P(IYI,",",i),ii=ii+1
 S cc=$P($G(@(BSr_"(BSt,""KEY"",ii)")),"@",10),ff=$G(@(BSr_"(BSt,""KEY"",ii,3)"))
 S BSr="^%ZAPM.bs.BSbufB",BSt="KEYS"_$G(%BS(3),$P)_$J_"u"_BSd,ls="ДЕЛАЕТСЯ ТАБЛИЦА" D WAITS^%ZAPM.bs.BSF2
 S GL=$$BSD^%ZAPM.bs.BSA(BSd,$G(BKs(0))) F ii=1:1 Q:'$D(BKs(ii))  S GL=GL_$S(BKs(ii)=+BKs(ii):BKs(ii),BKs(ii)?1"Key".N&($D(@BKs(ii))):$S(@BKs(ii)=+@BKs(ii):BKs(ii),1:$C(34)_@BKs(ii)_$C(34)),1:$C(34)_BKs(ii)_$C(34))_","
 S v=1,ke=1,t1=$G(FLine," ЗНАЧЕНИЯ: "_GL),l1=60,cl=$P(%BS,"!",4) D CR S t1="" D CR S $P(@$ZR,"@",8)=0,$P(@$ZR,"@",3)=0,@(BSr_"(BSt,""FTR"",2,1)")=ff
 S cl=cc,ii="" F  S ii=$O(@(GL_"ii)")) Q:ii=""  I ii'["@" S t1=ii D CR S $P(@$ZR,"@",8)="2,1"
 I se=2 D ErrMsg^%ZAPM.bs.BSXfun(" У УЗЛА:"_GL_" ЗНАЧЕНИЙ НЕТ ") S YES=0 Q
 S Fk="" D CREAT S YES=1,$ZT=$G(%zT) Q
CR ;l1,l2,...ln-ДЛИНЫ КОЛОНОК t1,t2,...tn-СОДЕРЖАНИЕ КОЛОНОК,ke-КОЛ-ВО КОЛОНОК
 ;v- ВЫСОТА ТЕКУЩЕЙ СТРОКИ
 ;NoKiTab=1 - НЕ УДАЛЯТЬ СТАРУЮ ТАБЛИЦУ
 Q:'$D(ke)  I '$D(CReATe) K:'$D(NoKiTab) @(BSr_"(BSt)") S:$D(@BSr)["0" $P(@BSr,"@")="BaSe MsW " S CReATe=$$h^%ZAPM.bs.BS3(),se=0 D:$D(NoKiTab)  S WA=$G(WA) F i=1:1:ke S @("l"_i)=$S('$D(@("l"_i)):70,1:@("l"_i))
 .F i=1:1 Q:'$D(@BSr@(BSt,i))  S se=i
 S se=se+1 F j=1:1:ke S @(BSr_"(BSt,se,j)")="@@"_$G(v,1)_"@"_(@("l"_j))_"@@@@@1@"_$G(cl,$G(col(j)))_"@@@@@"_$G(@("t"_j))
 Q
CREAT K CReATe,i,j,cl,col S @BSr@(BSt)="@@@@@@@1@1@22@80@1@@1@1@@1@@"_$G(tIT)_"@1@"_$P($G(@BSr@(BSt)),"@",21,99),BSR=BSr,BST=BSt S:$D(Fk) $P(@$ZR,"@",15)=Fk S:$D(PrEd) $P(@$ZR,"@",41)=PrEd D RESZER^%ZAPM.bs.BSF2,TABm^%ZAPM.bs.BSF1 Q
CREATE D CREAT K BSr,BSt,tIT,Fk D ^%ZAPM.bs.BST Q
ERR S ls=$ZE D O^%ZAPM.bs.BSF7 G 1
DOAF2 D SI G:'$D(@(BSR_"(BST,""AF2"")")) OO I $G(@$ZR)="" S OOO=BSR,BLo=BST G DOA
 S OOO=$P(@$ZR,",",1,$L(@$ZR,",")-1),BLo=$P(@$ZR,",",$L(@$ZR,","))
DOA S OO=$S(BLo=+BLo:BLo,1:""""_BLo_"""")_",""AF2"",1"
 I '$D(@(OOO_"("_OO_",1)")) G OO
 W /CUP(25,1) D 0^%ZAPM.bs.BSF W /EL(0) D 0^%ZAPM.bs.BSF,24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB S YES=$S(R1=27:0,1:1) D A25^%ZAPM.bs.BSF1 Q
OO Q:TIP=7  S ls=" БЛОЧНОЕ МЕНЮ ОТСУТСТВУЕТ " G O^%ZAPM.bs.BSF7
AF2 I BST["@" S ls=" СНАЧАЛО ВЫЙДИТЕ ИЗ РЕЖИМА КОРРЕКЦИИ <F3> " D O^%ZAPM.bs.BSF7 G D
 S ls=" Вы хотите создать НА ОСНОВЕ ЭТОЙ ТАБЛИЦЫ БЛОЧНОЕ МЕНЮ для дpугой таблицы ? " D YES^%ZAPM.bs.BSF I 'YES G D
 S li=$G(@(BSR_"(BST,""AFG"",1)")) D TIR^%ZAPM.bs.BST4,RIT^%ZAPM.bs.BSF3 I 'YES G D
 I $D(@(BSr_"(BSt,""AF2"")")) S ls=" У "_BSr_","_BSt_" УЖЕ СУЩЕСТВУЕТ БЛОЧНОЕ ПРИКРЕПЛЕННОЕ МЕНЮ" D MENU^%ZAPM.bs.BSF5(" ОБНОВЛЯЕМ УДАЛЯЕМ ОТКАЗ ",ls) G D:'YES!(%B=3) K @(BSr_"(BSt,""AF2"")") G D:%B=2
 S (BSr2,BSr1)=BSr,(BSt2,BSt1)=BSt,ls=" ХРАНИТЬ БУДЕМ В ТОЙ ЖЕ ТАБЛИЦЫ " S %B=1 D YES^%ZAPM.bs.BSF I 'YES S li=$G(@(BSR_"(BST,""AFG"",2)")) D TIR^%ZAPM.bs.BST4,RIT^%ZAPM.bs.BSF3 G D:'YES S BSr2=BSr,BSt2=BSt
 S I=ny,IN="M(1,1)",YES=1 D M(I,IN) G D:'YES S I="M",@(BSR_"(BST,""AFG"",1)")=$$BSR^%ZAPM.bs.BSA(BSr1)_","_BSt1,^(2)=$$BSR^%ZAPM.bs.BSA(BSr2)_","_BSt2,@(BSr1_"(BSt1,""AF2"")")=$$BSR^%ZAPM.bs.BSA(BSr2)_","_BSt2 F  S I=$Q(@I) Q:I=""  S @(BSr2_"(BSt2,""AF2"","_$P(I,"(",2,99))=@I
 G D
M(i,m) N h,j,c,g S (g,c)="",@m=" ",h=+("9"_$TR($P($P(m,"(",2),")"),",","")) F j=1:1:ke Q:$P($P(@(BSR_"(BST,i,j)"),"@",15)," ")=""  D  Q:'YES
 .S @m=@m_$P($P(@(BSR_"(BST,i,j)"),"@",15)," ")_" ",M(h,j)=$P($P(@$ZR,"@",15)," ",2,999)
 .I $P(@$ZR,"@",14)?.N1",".N S II=$P(@$ZR,"@",14) I $D(@(BSR_"(BST,""CMD"","_II_")")) D
 ..I @$ZR?1"I ".N S I=+$P(@$ZR,"I ",2),IN=$P(m,")")_","_j_")" D M(I,IN) Q
 ..E  S $P(c,";",j)=@$ZR
 .I "0"'[$P(@$ZR,"@",14) S $P(c,";",j)="S IYI="""_$$TR^%ZAPM.bs.BSsFUNM($P(@$ZR,"@",14),$C(34),($C(34)_$C(34)))_""" D NEB^%ZAPM.bs.BSN"
 I $L(@m)>78 S ls="ВЫХОД ТЕКСТА БЛОКОВ ЗА ПРЕДЕЛЫ 78 СИМВОЛОВ" G O
 I $L(@m_"@6@ @0@BLo,""AF2"","_h_"@"_c_"@"_g)>($$LNG^%ZAPM.bs.BSF12-1) S ls="ВЫХОД КОМАНД МЕНЮ ЗА ПРЕДЕЛЫ "_($$LNG^%ZAPM.bs.BSF12-1)_" СИМВОЛОВ" G O
 S @m=@m_"@6@ @0@BLo,""AF2"","_h_"@"_c_"@"_g Q
O S ls="В СТРОКЕ "_i_" "_ls D O^%ZAPM.bs.BSF7 S YES=0 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSNIK1" type="MAC" languagemode="0"><![CDATA[
%BSNIK1(DEV1,DEV2) ;TABEL! ПРЕОБРАЗОВАНИЕ БД (Н.Кузнецов) ; 9:37   21.05.99
%NIKMVD ; NIK 06.08.97 Г. ; 18:34 10-NOV-97
 ;!!! УЖЕ СТАРАЯ - ВМЕСТО НЕЕ  ^%ZAPM.bs.BSTABE3
 ;DEV1 - НОМЕР ВХОДНОГО ДОС-УСТРОЙСТВА
 ;DEV2 - НОМЕР ВЫХОДНОГО ДОС-УСТРОЙСТВА
 N I,DEV,STR,STR0,END,P,DAT,UVD,KZ,KOL,S,A,J,DOS
 S END=0 D Wait^%ZAPM.bs.BSXfun("Переделка для формы 02901")
BEG I 'END D READ G KON:$A(STR)=-1!(STR="") ; K STR
 E  S END=0,STR=STR0
1 F I=1:1:7 S P(I)=$P(STR," ",I)
 S KZ=P(3)_P(4),DAT="ДАТ28"_P(6)_P(5),UVD="ОВД"_$P(P(7),";",1)
 ;I P(1)'="!" U 0 W !,"НЕ НАЧАЛО ДОКУМЕНТА:" D  G BEG U 0 W !,"НАЧАЛО ДОКУМЕНТА:" D  R !,"?_",A
 I P(1)'="!" U 0 W !,"НЕ НАЧАЛО ДОКУМЕНТА:" D  G BEG
 .F I=1:1:7 W P(I)," "
 I KZ="02901" S KOL=9,S=28 G Z1
 I KZ="02902" S KOL=3,S=23 G Z1
 I KZ="19901" S KOL=7,S=19 G Z1
 U 0 W !,"ФОРМА ",KZ," ДАННОЙ ПРОГРАММОЙ НЕ ОБРАБАTЫВАЕТСЯ !" R "?-",A G BEG
Z1 U 0 X WA ;W !,"ФОРМА ",KZ," ИЗ ",UVD
 F J=1:1:S D ZIKL I $A(STR)=-1!END S J=J-1 Q
 G END
ZIKL D READ Q:$A(STR)=-1!(STR="")  I $E(STR)="!" S END=1,STR0=STR Q
 F I=1:1:KOL S P(I)=$P(STR," ",I)
 S STR(J)="=СТР"_$E("00",1,2-$L(P(1)))_P(1)
 S P(KOL)=$P(P(KOL),";",1)
 F I=2:1:KOL S:P(I) STR(J)=STR(J)_"=00"_(I-1)_P(I)
 ;U 0 W !,"СДЕЛАЛ ",STR(J) ;R " ?-",A
 Q  ;G ZIKL
END S STR(0)="-----="_KZ_"="_DAT_"="_UVD
 S STR(J)=STR(J)_"=+++++"
REC ; ЗАПИСЬ В БУФЕР
 F I=0:1:J S STR=STR(I) D WRITE
 K STR
 G BEG
READ S STR="" U DEV1 R STR
 ;U 0 W !,"СЧИТАЛ:",STR,"***",!,$A(STR),"<" ;R A
 Q  ;I STR="" C %DEV G END
WRITE U DEV2 W STR,!
 ;U 0 W !,"ЗАПИСАЛ:",STR ;R A
 S STR="" Q
KON C DEV1,DEV2
 S STOPSCAN=1 ;U 0 W !,"ОБРАБОТКА ФОРМЫ ",KZ," ЗАКОНЧЕНА"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSNIK2" type="MAC" languagemode="0"><![CDATA[
%NIKTEST ;TABEL! КОНТРОЛЬ ДОКУМЕНТОВ ТАБЕЛЯ НА ПРЕДВВОДЕ (Н.Кузнецов) ; 17:44 10-JUN-98
 ; пpогpамма ... |-МОДИФИЦИРОВАННО МНОЙ =MSW
 N
0 S (I1,I2,I3)="",R="@",NSUM="" ;УБРАЛ NEW - ZAS
 ;|R !,"Введите номер формы:",NF G END:NF=""
 S NF=14201,BUF=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSMDDR(""BPO"")"),TAB="^[""GLAVK""]DDRm(NF)"
 S FORM=@TAB@("^","S") ;
 S TBL=@FORM I $P(TBL,R,17)'=2 W !," - ЭТО ТАБЛИЦА НЕ ИМЕЕТ БАЗЫ ДАННЫХ !" Q
 ;W !,"TBL=",TBL R A
 F I=1:1 Q:'$L($G(@TAB@(I,"F")))  S I(I)=^("F") ;W !,"I",I,"=",^("F") R " ?",A
 S KKEY=I-1,III(1)="",N3K=""
 I KKEY=3 S N3K=$P($G(I(3)),"""",2) ;W !,"3-ИЙ КЛЮЧ:",N3K R "  НАЖМИТЕ КНОПКУ",A
 I  S NSUM=99 ;|W !,"Введите код ",N3K,", содержащий сумму:" R NSUM S NSUM=NSUM_"" ;G:NSUM="" 1 ;
 I  K III
 S IN3=1 ; ПРИ 2-Х КЛЮЧАХ
 S KS=$P(TBL,R,28),KK=$P(TBL,R,29) ; СТРОК И КОЛОНОК В ТАБЛИЦЕ
 F I=1:1:KS F K=1:1:KK S TIP=$P(@FORM@(I,K),R,9) I TIP=2 G A1
A1 I '$T W " - В ЭТОЙ ТАБЛИЦЕ НЕТ КЛЕТОК, ЗАПИСЫВАЕМЫХ В Б.Д.!" Q
 S S1=I,K1=K ; УЧЕСТЬ ДАТ, КОТ НЕТ В КОЛОНКАХ
10 S NIK=1 ;|R !,"Введите номер колонки, по которой проводить суммирование <1>:",NIK S:NIK="" NIK=1
 I NIK<1!(NIK>(KK/2-3)) W "-НЕВЕРНО !" G 10
 S NIK=$E("00",1,3-$L(NIK))_NIK W !,"имя показателя -<",NIK,">"
 S PRIZN=BUF_"(NF,PN,""2,1"")" ;ПРИЗНАК ОБРАБОТКИ 1-НЕ ОБРАБОТАН,2-С ОШИБКАМИ
 ; 4 - ЗАНЕСЕН В БД
 S DOK=BUF_"(NF,PN," ;ПЕРВАЯ СТРОКА ДОКУМЕНТА, ДАЛЕЕ-3,2;4,2 И Т.Д.
 S DOKS=BUF_"(NF,PN)"
 S PROT=$E(FORM,1,14)_"NIKitog(NF)",PN="" K @PROT
ZIKL S PN=$N(@DOKS) G END:PN<1 I 1!(@PRIZN=1) S STR="" D  D Z G ZIKL
 .F K=2:1 S S=$G(@(DOK_""""_K_",2"")")) Q:'$L(S)  S STR=STR_S ;W !,STR R A
 .Q:'$L(STR)  S STR=STR_"=" W *12,PN
Z S I=1
 F I4=2:1 S PK=$P(STR,"=",I4) Q:PK["++"  S NAM=$E(PK,1,3),PK=$E(PK,4,255) D CALC Q:NAM=NIK&(KKEY=2)  S I=I+1
 Q
CALC S L=" за КСП",R=" "
 I NAM="КСП" S KSP=PK,DIV=$E(PK,1,2) S:'$D(@PROT@(DIV)) I3=$S($L(NSUM):NSUM,1:1),@PROT@(DIV,1,I3)="ОТСУТСТВУЕТ"_L_KSP Q
 I KKEY=3 I NAM=N3K S IN3=PK,III(PK)="" ; W !,NAM," В 3 КЛЮЧЕ ",PK R A
 I NAM=NIK S:KSP=DIV @PROT@(DIV,1,IN3)=PK_L_KSP ;_"#"_PN_R
 I  S:$L(KSP)>2 @PROT@(DIV,KSP,IN3)=PK_L_KSP ;_"#"_PN_R
 Q
END R !,"Массив предввода просмотрен." S J=0
T1 S (J1,J2,J3)=0 I NSUM="" G T31
 S A="" ;R !,"Проверить наличие строки (строк) в документах предввода? <Enter>-Да:",A
 I A="" G STR
T2 S J1=J I J W !,N3K,NSUM," отсутствует в ",J," документах."
 I NSUM="" G T31
 W !,"Проверить правильность "_N3K_"="_NSUM R " в каждом документе? <Enter>-Да:",A
 I A="" G IND3
T3 S J2=J-J1 W !,"Обнаружено ",J2," ошибок."
T31 R !,"Сравнить данные за соединения (округа) с суммой по частям? <Enter>-Да:",A
 I A="" G M00
T33 S J3=J-J1-J2 W !,"Обнаружено ",J3," ошибок."
 W !,"Всего ",J," ошибок; распечатать на принтере? [Y]-Да:" R A
T4 F I=1:1:J W !,STR(I)
 I A="Y" O 3 U 3 S A="" W !,"Проверка сводных данных предввода по форме ",NF,! G T4
 C 3
EXIT W !,"КОНЕЦ РАБОТЫ ПРОГРАММЫ КОНТРОЛЯ ДОНЕСЕНИЙ ПО ТАБЕЛЮ ОТЧЕТНОСТИ"
 Q  ;
STR ; наличие строк
 ;W !,"Введите значение "_N3K_" в виде: код или код1,код2,... или код1-код2"
 ;R !,"напр. 01 или 01,99 или 01-03 :",KOD G T1:KOD=""
 S (KD,KOD)=NSUM
 I KOD["," F I=1:1 Q:$P(KOD,",",I)=""  S KOD=$P(KOD,",",I)_""","""_$P(KOD,",",I+1,99)
 I KOD["-" S LK=$L($P(KOD,"-",1)),ZIKL=$P(KOD,"-",1)_":1:"_$P(KOD,"-",2)_" S I3=$E(""000000"",1,(LK-$L(I3)))_I3"
 E  S ZIKL=""""_KOD_""""
 S ZIKL="F I3="_ZIKL_" D NAL"
 S I1=""
S11 S I1=$N(@PROT@(I1)) G T2:I1<0 ;,S11:I1=81!($E(I1,1)=7)
S12 S I2=$N(@PROT@(I1,I2)) G S11:I2<0,S12:I1=81&(I2=1)
 X ZIKL G S12
NAL I $D(@PROT@(I1,I2,I3)) I $P(^(I3)," ",1)'="ОТСУТСТВУЕТ" Q
 S J=J+1,STR(J)="Для КСП "_$S(I2=1:I1,1:I2)_" нет "_N3K_I3
 ;W !,STR(J) R A
 Q
 ;
IND3 S STR="",I1="",IN3="",(SUM,SUMM)=0,L="("_N3K
M0 S I1=$N(@PROT@(I1)) G T3:I1<1 K I3 D M01 G M0 ; ПО ДИВИЗИИ
 ;
M01 S I2=$N(@PROT@(I1,I2)) Q:I2<0  K SM,SUM D M1:$L(NSUM) G M01 ; ПО ЧАСТЯМ
 ;
M1 ; СУММАРНАЯ СТРОКА В ДОКУМЕНТЕ
 S SM=0,IN3="",NSTR=0,SUM=0 ; ВСТАВИЛ SUM=0 - ZAS
M11 S IN3=$N(@PROT@(I1,I2,IN3)) I IN3<0 D:SUM'=SM M12 Q  ; ПО СТРОКАМ
 ;S III(IN3)="" ; W !,"IN3=",IN3,"-",^(IN3) R A
 I IN3=NSUM S SUM=^(IN3)+0
 E  S SM=SM+^(IN3)
 I I2=1 S SUM(IN3)=^(IN3)+0
 E  S SM(IN3)=$G(SM(IN3))+^(IN3)
 G M11
M12 ; КОНЕЦ ПО ОДНОМУ КСП
 S SUM=$G(@PROT@(I1,I2,NSUM)) I 'SUM S SUM="ОТСУТСТВУЕТ ЗА КСП"_$S(I2>1:I2,1:I1)
 S STR="*** "_$P(SUM," ",2,3)_" представлено "_N3K_NSUM_"="_$P(SUM," ",1)
 ;S ^(NSUM)=SUM_" <>"_SM
 S IN3="",J=J+1,STR(J)=STR_" насчитано "_SM_"="
M13 S IN3=$N(@PROT@(I1,I2,IN3)) I IN3>0 S:IN3'=NSUM STR(J)=STR(J)_"+"_(^(IN3)+0)_L_IN3_")" G M13
 Q
%NIKKSP ; пpогpамма ... ПОСТРОЕНИЕ СТРУКТУРЫ ОКРУГОВ 19.08.97 ; 18:41 20-AUG-97
 N I1,okrug,I2,K1,K2,MAS
 S MAS=""""_"SYS"_"""",MAS="^["GLAVK"]KVCstr"
 S I1="" K okrug
1 S I1=$N(@MAS@(I1)) G END1:I1=-1,1:$E(I1,1)=7
 W !,"I1=",I1
 S I2="",K2=0,okrug(I1)=""
2 S I2=$N(@MAS@(I1,I2)) G 1:I2=-1,2:I2=I1 S K2=K2+1
 W "-",I2 S:$L(I2)=2 okrug(I1)=okrug(I1)_$S(K2=1:"",1:",")_I2
 G 2
END1 W !,"МАССИВ СФОРМИРОВАН"
 Q ;
M00 D %NIKKSP S I1=""
M001 S I1=$N(@PROT@(I1)) G T33:I1<0
 S I3=""
M32 S I3=$N(III(I3)) G:I3<0 M001 S SM=0,I2=0,K=0,STR=""
M31 S I2=$N(@PROT@(I1,I2)) G M33:I2<0,M31:I2=1!(I1=81) S K=K+1
 S SM=SM+$G(@PROT@(I1,I2,I3)),STR=STR_"+"_$G(@PROT@(I1,I2,I3)) G M31
M33 ;W !,"I1=",I1," I2=",I2," OKR=",$G(okrug(I1))," KCB=",I3,"#"
 G M32:'K I $D(okrug(I1)) D M4
 S S=$G(@PROT@(I1,1,I3)),SUM=$P(S," ",1) ;+***** 0
 I SM=(SUM+0)
 E  S J=J+1,STR(J)=$P(S," ",2,3)_" представлено "_N3K_I3_"="_S_" не равны сумме "_SM_"="_STR
 ;W !,"SM=",SM," SUM=",SUM," S=",S,!,"STR=",STR R A
 G M32
 Q
M4 ;W !,"ОКРУГ" R A;СУММИРОВАНИЕ ПО ОКРУГУ
 S ZIKL=okrug(I1) Q:'$L(ZIKL)
M41 S K=0
M42 S K=K+1,I0=$P(ZIKL,",",K),I2=1 Q:'I0
 S SM=SM+$G(@PROT@(I0,I2,I3)),STR=STR_"+"_$G(@PROT@(I0,I2,I3))
 ;W !,"I0=",I0 R A
 G M42
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSPK" type="MAC" languagemode="0"><![CDATA[
%BSPK ;ПАКЕТНЫЙ РЕЖИМ ```ОТЛАДКА; 16:14 30-MAY-97 ; 16:51 10-JUN-98
 Q
START ;НАСЧЕТ ПАКЕТОВ
 N U,I,Err,PACKET,ObR
 S U=$$CHOPAK,YES=0 Q:U=""
 S I="",PACKET=$$h^%ZAPM.bs.BS3() F  S I=$O(@U@(I)) Q:I=""  I $G(@U@(I,"ST")) D CALC($NA(@U@(I)))
 Q
CALC(P) ;СЧИТАТЬ ЗАПРОС
 N NZ,PT,I,U,T,R
 S NZ=$G(@P@("N")) I NZ="" D ErrPACK($NA(@P@("TT")),"Имя ЗАПРОСА пусто !") Q
 S PT=$G(@P@("PT")) I '$$Data^%ZAPM.bs.BSF12(PT) D ErrPACK($NA(@P@("TT")),"Нет доступа к СПИСОКУ\СВОДКЕ !") Q
 S R=$$PT(PT,1),T=$$PT(PT,0)
 I '$D(@R@(T,"ZPr",NZ)) D ErrPACK($NA(@P@("TT")),"ЗАПРОСА "_NZ_" В "_R_","_T_" УЖЕ НЕТ") Q
 S ObR=P F I="TT","BT","TZ","TB","TP" K @P@(I)
 D ZPSTART^%ZAPM.bs.BSZPS(NZ,R,T)
 Q
PT(PT,N) ;ИЗ ПОЛНОЙ ССЫЛКИ В 1=РАЗДЕЛ 2=ТАБЛИЦА
 I N Q $P(PT,"(")
 Q $TR($P($P(PT,"(",2),")"),$C(34),"")
ErrPACK(G,T) 
 S @G=T,Err=$G(Err)+1,Err(Err)=T
 Q
FBP ;ФОРМИРОВАНИЕ БУФЕРОВ ПЕЧАТИ
 Q
PBP ;ПЕЧАТЬ БУФЕРОВ
 Q
CLEARBUF ;ЧИСТКА БУФЕРОВ ПЕЧАТИ
 Q
PACKET ;ПАКЕТ ПАКЕТОВ
 Q
CHOPAK() ;ВЫБРАТЬ ПАКЕТ
 Q $$UZEL^%ZAPM.bs.BSVOL("PACKET","%BSVOL","",""," НАДО ВЫБРАТЬ ПАКЕТ, КОТОРЫЙ БУДЕМ СЧИТАТЬ")
 
]]></Routine>


<Routine name="%ZAPM.bs.BSPK1" type="MAC" languagemode="0"><![CDATA[
%BSPK1 ;КАРТА ВЫВОДА И ПЕЧАТЬ ДЛЯ ПАКЕТОВ ```ОТЛАДКА; 16:52 10-JUN-98 ; 14:01 24-FEB-99
 Q
OUTCARDS ;КАРТА ВЫВОДА
 N CARD
 S CARD=$NA(^%ZAPM.bs.BSbufB("TmpCardOut"_$G(%BS(3),$P)_$J_"u1"))
 D FC(BSR,BST,$G(@BSR@(BST,"PRN"),$P(^%ZAPM.bs.BSS("OPout1",2,1),"@",15)),CARD)
 D Table^%ZAPM.bs.BSN(BSR,BST)
 D Yes^%ZAPM.bs.BSXfun("Запомним Карту вывода") I YES>0
 Q
PACKCARD ;КАРТА ВЫВОДА ПАКЕТ
 N CARD
 S CARD=$NA(^%ZAPM.bs.BSbufP("Card§"_BSR_"§"_BST_"§"))
 D FC(BSR,BST,$G(@BSR@(BST,"PRN"),$P(^%ZAPM.bs.BSS("OPout1",2,1),"@",15)),CARD)
 D FB(BSR,BST,CARD)
 Q
 
FC(P,T,O,C) ;ФОРМИРОВАНИЕ КАРТЫ
 I $D(@P@(T,"CRD"))
 D ErrMsg^%ZAPM.bs.BSXfun("РЕЖИМ НА ОТЛАДКЕ") Q
 ;D x^%ZAPM.bs.BS3("19+PK1")     ;---//--- для msm 4.x.x
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSPRN" type="MAC" languagemode="0"><![CDATA[
%BSPRN ;ВЫВОД НА ПЕЧАТЬ (А.Тимофеев) ; 14:48   02.03.99
 I '$D(%CAL) D CALC^%ZAPM.bs.BSF3
TWA S IMQ1=BSR_","_BST S:$D(%TIT) IMQ2=BSY2(1)_","_BSX2(2) D TWA1 D Q^%ZAPM.bs.BSN("%BS,PRF,%zT,%KAT,%File,k0,k1,k2,k3,k4,k5,IMQ1,IMQ2,BSB,PRN,DOS,SR,SR1,SR2,SR3,PRA,PRA1")
 K SR,SR1,SR2,SR3 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST D:$D(%FN) C^%ZAPM.bs.BSBL1 G D^%ZAPM.bs.BS
TWA1 D SI^%ZAPM.bs.BSN D N^%ZAPM.bs.BSN("%BS,PRF,%zT,%KAT,%File,k0,k1,k2,k3,k4,k5,IMQ1,IMQ2,BSB,PRN,DOS,SR,SR1,SR2,SR3,PRA,PRA1") D SI^%ZAPM.bs.BSN
 D IMQ1 S:$D(IMQ2) BSY2(1)=$P(IMQ2,","),BSX2(2)=$P(IMQ2,",",2) S %I=$I
SPR ;СОЗДАНИЕ ПЕРЕМЕННЫХ ИЗ ОПЦИИ ДЛЯ ПЕЧАТИ
 I $D(PR2) G SK
 I DOS=1 G SPR1
 I $D(PRA) F ii=1:1:8 S @("PR"_ii)=$P(PRA,"@",ii) G:ii=8 OPR
 I $D(@(BSR_"(BST,""PRN"")")) S PRA=@$ZR F i=1:1:8 S @("PR"_i)=$P(PRA,"@",i) G:i=8 OPR
 F ii=2:1:9 S i=ii-1,@("PR"_i)=$P(^%ZAPM.bs.BSS("LPT",ii,2),"@",15) Q:ii=9
OPR S PR2=PR2-PR5 F i=4,6,7,8 S @("PR"_i)=$S(@("PR"_i)="Y":1,@("PR"_i)="N":0,1:"") G:i=8 SK
SPR1 ;ДЛЯ DOS-ФАЙЛА
 I $D(PRA1) F ii=1:1:8 S @("PR"_ii)=$P(PRA1,"@",ii) G:ii=8 OPR1
 I $D(@(BSR_"(BST,""HFS"")")) S PRA=@(BSR_"(BST,""HFS"")") F i=1:1:8 S @("PR"_i)=$P(PRA,"@",i) G:i=8 OPR1
 F ii=2:1:9 S i=ii-1,@("PR"_i)=$P(^%ZAPM.bs.BSS("HFS",ii,2),"@",15) Q:ii=9
OPR1 S:PR2="M" PR2=255 S PR2=PR2-PR5 F i=4,6,7,8 S @("PR"_i)=$S(@("PR"_i)="Y":1,@("PR"_i)="N":0,1:"") Q:i=8
SK ;НАЧАЛО
 I DOS=1 D DOSOPN^%ZAPM.bs.BSBL1 Q:'YES
 I $D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15))) S IMQ3=$G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15))) I IMQ3=IMQ1 S ls="ЕСТЬ ГОТОВЫЙ ФАЙЛ ВЫВОДА,БУДЕМ ВЫДАВАТЬ ?",%B=2 D YES^%ZAPM.bs.BSF I YES G:DOS'=1 PRN2^%ZAPM.bs.BSPRN1 D:DOS=1 DOSIN^%ZAPM.bs.BSBL1 U 0 Q
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15))=IMQ1 I PRN=1 G KW^%ZAPM.bs.BSPRN1
 ;ВЫВОД БЛОКА
 I BSR="^%ZAPM.bs.BSbufB" S ls=" Это уже блок , извини , выводи всю ! " D O^%ZAPM.bs.BSF7 Q
 S ls="ФОРМИРУЕТСЯ БЛОК" D WAITS^%ZAPM.bs.BSF2
 D ^%ZAPM.bs.BSBL S BSR="^%ZAPM.bs.BSbufB",BST="L"_$G(%BS(3),$P)_$J_"u"_%BS(15) D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST K ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"_%BS(15)) Q
IMQ1 S BSR=$P(IMQ1,",",1,$L(IMQ1,",")-1),BST=$P(IMQ1,",",$L(IMQ1,",")) Q
BEG ;ОСНОВНОЙ БЛОК ПОДГОТОВКИ ФАЙЛА ВЫВОДА
 D IMQ1 S BS0=0,BSX(BS0)=BSWX,BSY(BS0)=BSWY,(BSUY,BSUX)=1 S:BSWX=1 BSUX=0 S:BSWY=1 BSUY=0
WRITE S ls="ФОРМИРУЕТСЯ ФАЙЛ ВЫВОДА" D WAITS^%ZAPM.bs.BSF2,TIT ;PRN^%ZAPM.bs.BSPRN1
 Q
W S BSP=1 K BS1,BS2,BS  ;СОЗДАНИЕ БУФЕРНОГО ФАЙЛА ВЫВОДА
 K ENDDN S BSI=BSY(BS0)-1,BSDOS=1*DOS*PR4*AN6,PRF1=0 S:BSWY'=1 BSI=BSI+1 F  S BSI=$O(@(BSR_"(BST,BSI)")) Q:'BSI  K AN2,AN5 D  S PRF1=PRF1+1 D AN S BSDOS=$S(BSDOS=1:0,BSDOS=0:1,1:"") Q:$D(ENDDN)
 .K ENDRI S BSII=BSX(BS0)-1,BSDOS1=1*DOS*PR4 F  S BSII=$O(@(BSR_"(BST,BSI,BSII)")) Q:BSII=""  D WR S BSDOS1=$S(BSDOS1=1:0,BSDOS1=0:1,1:"")*DOS I $D(ENDRI)!($D(ENDDN)) Q
 Q
AN S BSF="",BSP0=$S(BS0=0:4,BS0=3:1,BS0=1:2,BS0=2:3,1:"") F  S BSF=$O(AN2(BSF)) Q:BSF=""  D  X WA
 .I DOS=0 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,BSP0,BSP)=AN2(BSF),BSP=BSP+1 Q
 .I PR4=0 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,BSP0,BSP)=AN2(BSF),BSP=BSP+1 Q
 .S AN8=$S(AN7=1:" ",AN7=0:"",1:""),AN10=$S(AN7=1:"#",AN7=0:"",1:""),^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,BSP0,0)=AN10_AN5(BSF) I BSDOS=0 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,BSP0,BSP)=AN8_AN2(BSF),BSP=BSP+1 Q
 .S AN9=$S(AN7=1:"X",AN7=0:"",1:""),^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,BSP0,BSP)=AN9_AN2(BSF),BSP=BSP+1
e Q
WR S CLR="" I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) I '$D(BS1) S BS1=$P(BS,"@")+1,BS2=$P(BS,"@",2)+1
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+(BSY1(BS0)*BSUY))*BSY2(BS0)>(BSY2(BS0)*BSY2(BS0)) S ENDDN=1,BSPY=BSI Q
 I $D(PRF) I $P(@(BSR_"(BST,BSI,1)"),"@",15)=PRF D  I PRF1>1 S ENDDN=1,BSPY=BSI Q
 .I BSWY=1 S PRF1=2 Q
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+1+(BSX1(BS0)*BSUX))>BSX2(BS0) S ENDRI=1 Q
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSI,BSII))
 I BSWY'=1&($G(PRF)<2)&(BSII=1)&(d=$G(PRF)) S (d,d0,d1)=" "
 I d0="" S d0=0
 I $P(BS,"@",8)'="" S ny=BSI,nx=BSII,%zT=$ZT,$ZT="FISH^%ZAPM.bs.BSPRN" D  S $ZT=$G(%zT)
 .I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"","_BSI_","_BSII_")")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)*BSY2(BS0)>(BSY2(BS0)*BSY2(BS0))  D WRD S AN2(BSF)=AN2(BSF)_AN1,AN5(BSF)=AN5(BSF)_AN4
 Q
WRD S AN1=$E(d1,BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1))),AN3=$S(BSDOS1=1:"X",BSDOS1=0:" ",1:""),AN4=$TR($J("",$P(BS,"@",4))," ",AN3)
 I '$D(AN2(BSF)) S AN2(BSF)="",AN5(BSF)=""
 I $L(AN1)<$P(BS,"@",4) S AN1=AN1_$J("",($P(BS,"@",4)-$L(AN1)))
 Q
TIT ;БЛОК ОПРЕДЕЛЕНИЯ ТИТУЛА И ГРАНИЧ. ТОЧЕК
 ;S:PR3'=+PR3 PRF=PR3,PR3=0
 I $P(@(BSR_"(BST)"),"@",19) S %TIT=$P(^(BST),"@",19)
 I $P(@(BSR_"(BST)"),"@",50) S %TIT=$P(^(BST),"@",50) ;ТИТУЛ ПЕЧАТИ```MSW
 E  K %TIT  ;G W
 I $P(@(BSR_"(BST)"),"@",8) S:$D(%TIT) BSTIT=%TIT*PR6 D  ;
 .I '$D(%TIT)!($G(BSTIT)=0) S BS0=0,BSY1(0)=$P(^(BST),"@",8),BSX1(0)=$P(^(BST),"@",9),BSY2(0)=PR3,BSX2(0)=PR2 S (AN6,AN7)=1 D W,PRN^%ZAPM.bs.BSPRN1 Q  ;ЕСЛИ БЕЗ ТИТУЛА
 .S BS0=0,BSY2(BS0)=PR3,BSX2(BS0)=PR2 D  S BSY1(BS0)=$P(@(BSR_"(BST,"_%TIT_")"),"@"),BSX1(BS0)=$P(@$ZR,"@",2)
 ..S BSY1(0)=+$P(^(BST),"@",8),BSX1(0)=+$P(^(BST),"@",9)
 .S BS0=1,(BSY1(3),BSY1(BS0))=+$P(@(BSR_"(BST)"),"@",8),BSX1(BS0)=BSX1(0),(BSY2(3),BSY2(BS0))=BSY1(0)-1,BSX2(BS0)=+PR2
 .S BS0=2,BSY1(BS0)=BSY1(0),(BSX1(3),BSX1(BS0))=+$P(^(BST),"@",9),BSY2(BS0)=PR3,(BSX2(3),BSX2(BS0))=BSX1(0)-1
 .S (BSY(3),BSX(3),BSY(1),BSX(2))=1,BSY(2)=BSY(0),BSX(1)=BSX(0) D
 ..I BSWX=1&(BSWY=1) S BS0=0,AN6=1,AN7=1 D W Q
 ..I BSWY=1 I BSWX'=1 S BS0=2,AN6=1,AN7=1 D W S BS0=0,AN6=$S(BSDOS=1:0,BSDOS=0:1,1:""),AN7=0 D W Q
 ..I BSWX=1 S BS0=1,AN6=1,AN7=1 D W S BS0=0,AN6=$S(BSDOS=1:0,BSDOS=0:1,1:""),AN7=1 D W Q
 ..S BS0=3,(AN6,AN7)=1 D W S BS0=1,AN6=1,AN7=0 D W S BS0=2,AN6=$S(BSDOS=1:0,BSDOS=0:1,1:""),AN10=AN6,AN7=1 D W S BS0=0,AN6=AN10,AN7=0 D W Q
 Q
FISH W $$bel^%ZAPM.bs.BS3 I $ZE["<NOPGM" S @$ZR=""
 S $ZT=$G(%zT) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSPRN1" type="MAC" languagemode="0"><![CDATA[
%BSPRN1 ;ВЫВОД НА ПЕЧАТЬ II (А.Тимофеев) ; 17:04 10-JUN-98
PRN ;СОЗДАНИЕ СТРОКИ ВЫВОДА
 I $D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,1)) D  Q
 .Q:'$D(^(1,BSP))  S STR=^(BSP)_$G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,2,BSP))
 I $D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,2)) Q:'$D(^(2,BSP))  S STR=^(BSP)
 Q
PRN1 I $D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,3)) D  Q
 .Q:'$D(^(3,BSP))  S STR=^(BSP)_^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,4,BSP)
 Q:'$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,4,BSP))  S STR=^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT,4,BSP)
e Q
PRN2 S %I=$P ;ВЫВОД НА ПЕЧАТЬ
PRN20 S ls=" Готово устройство печати ? " D YES^%ZAPM.bs.BSF Q:'YES
 S US=PR1,BSP="",%I=$P O US:255:1 E  S ls=" ПЕЧАТЬ ЗАНЯТА " D O^%ZAPM.bs.BSF7 G PRN2
 S %zT=$ZT,$ZT="STOP^%ZAPM.bs.BSPRN1"
 U US W $C(27,80) W $C(27,51,39) S SR=$G(@(BSR_"(BST,""SHR"")")) I SR'="" S SR1=$P(SR,"@"),SR2=$P(SR,"@",2),SR3=$P(SR,"@",3) D  ;ЕСЛИ ОПРЕДЕЛЕНЫ ПАРАМЕТРЫ
 .U US W:$G(SR1)'="" @("$C("_SR1_")") W:$G(SR2)'="" @("$C("_SR2_")") W:$G(SR3)'="" @("$C("_SR3_")")
 U %I R *R:0 I R=27 G STOP
 S ls=" Вывод информации " D WAITS^%ZAPM.bs.BSF2
 S BSIT="",QZ="" F  S BSIT=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT)) Q:BSIT=""  D  Q:QZ=1  D END
 .S BSP=0,STR="" D PRN I STR'="" D PRN3 Q:QZ=1
 .F BSP=1:1 S STR="" D PRN Q:STR=""  Q:QZ=1  D PRN3
 .Q:QZ=1  S BSP=0,STR="" D PRN1 I STR'="" D PRN3
 .Q:QZ=1  F BSP=1:1 S STR="" D PRN1 Q:STR=""  Q:QZ=1  D PRN3
 Q:QZ=1  G END1
PRN3 U US W !,$J("",PR5),STR U %I X $G(WA) R *R:0 I R=27 G STOP
 Q
END U US W:PR4=1 ! W:PR4=0 #
 Q
END1 U US W $C(27,80) W $C(27,51,39)
 C US U %I S $ZT=$G(%zT) R *R:0,*R:0,*R:0
 S R=1,ls="ЕЩЕ ЭКЗЕМПЛЯР ?",%B=2 D YES^%ZAPM.bs.BSF I YES>0 G PRN20
 Q
STOP W $$bel^%ZAPM.bs.BS3 S ls=" ПЕЧАТЬ ПРЕРВАНА ",QZ=1 D O^%ZAPM.bs.BSF7
 W $ZE
 G END1
BF ;ОПЦИИ ВЫВОДА
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15))
BFB D SA^%ZAPM.bs.BSsBUF,R^%ZAPM.bs.BS3($NA(@BSR@(BST))),BF2,D^%ZAPM.bs.BS3($NA(@BSR@(BST))),RE^%ZAPM.bs.BSsBUF Q
BF2 I $D(@(BSR_"(BST,""PRN"")")) S PRA=@(BSR_"(BST,""PRN"")") F i=1:1:8 S @("PR"_i)=$P(PRA,"@",i) G:i=8 BF1
 F ii=2:1:9 S i=ii-1,@("PR"_i)=$P(^%ZAPM.bs.BSS("LPT",ii,2),"@",15) G:ii=9 BF1
BF1 K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15)),BSd,BSk S kk="LPT",j="^%ZAPM.bs.BSS(kk)",ii=@j D  F jj=2,4,5,12,13,14,15 S $P(ii,"@",jj)=""
 .S BSr1="^%ZAPM.bs.BSS",BSt1=kk,BSr2="^%ZAPM.bs.BSbufB",BSt2="fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15) D COPY^%ZAPM.bs.BSTK Q
 S ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15))=ii F PRB=2:1:9 S i=PRB-1,$P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),PRB,2),"@",15)=@("PR"_i) Q:PRB=9
 S YYY=BSR_","_BST D  K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15)) Q
 .D SI^%ZAPM.bs.BSN N (%BS,vl,PRF,%zT,%KAT,%File,YYY,BSB,PRA)
 .S BST="fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSR="^%ZAPM.bs.BSbufB" D ^%ZAPM.bs.BST Q:R1=27  F PRB=2:1:9 S i=PRB-1,@("PR"_i)=$P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u"_%BS(15),PRB,2),"@",15) Q:PRB=9
 .D  I PR8="Y" S $P(PRA,"@",8)="N",@($P(YYY,",",1,$L(YYY,",")-1)_"(($P(YYY,"","",$L(YYY,"",""))),""PRN"")")=PRA
 ..S PRA="" F i=1:1:8 S PRA=PRA_@("PR"_i)_"@" Q:i=8
 .Q
KW ;КАРТА ВЫВОДА
 S:PR3'=+PR3 PRF=PR3,PR3=0
 I '$D(ke) D REND^%ZAPM.bs.BSF2 I '$D(se) D DEND^%ZAPM.bs.BSF2
 K ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 U 0 S ls="ФОРМИРУЕТСЯ КАРТА" D WAITS^%ZAPM.bs.BSF2
 S (BSGY,BSGX)=0
 I $P(@(BSR_"(BST)"),"@",19) S BSGY=BSY2(1)*PR6,BSGX=BSX2(2)*PR6
KW1 K BSPX S I=0,J=2,UX=1,UY=0 F BSII1=1:1:ke X WA S BSII=BSII1-UY Q:BSII=""  I $D(@(BSR_"(BST,1,BSII)")) D  I $D(BSPX) S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,J)="@@3@10@@@@@1@1;6;33;45@@@@@С КОЛОНКИ           :"_UX,J=J+1,UX=BSII,UY=PR6+UY,I=BSGX*PR6 K BSPX
 .I ($P(^(BSII),"@",4)+I)>(PR2) S BSPX=1 Q
 .S I=I+$P(^(BSII),"@",4) Q
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,J)="@@3@10@@@@@1@1;6;33;45@@@@@С КОЛОНКИ           :"_UX,ke=J
 K BSPY S I=0,J=2,UY=1,UX=0 F BSI1=1:1:se X WA S BSI=BSI1-UX Q:BSI=""  I $D(@(BSR_"(BST,BSI,1)")) D  I $D(BSPY) S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),J,1)="@@2@10@@@@@1@1;6;33;45@@@@@СО СТРОКИ :"_UY,J=J+1,UY=BSI-1,UX=PR6+UX,I=BSGY*PR6 K BSPY
 .I $D(PRF) D  Q
 ..I ($P(^(1),"@",15))=PRF S BSPY=1,UX=UX-1 Q
 ..S I=I+$P(^(1),"@",3) Q
 .I ($P(^(1),"@",3)+I)*PR3>(PR3*PR3) S BSPY=1 Q
 .S I=I+$P(^(1),"@",3) Q
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),J,1)="@@2@10@@@@@1@1;6;33;45@@@@@СО СТРОКИ :"_UY,se=J
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)="@@3@10@@@@@1@1;6;33;45@@@@@  КАРТА     ВЫВОДА  "
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15))="@@@@@@@1@1@22@80@@X MRMR@@OFK^%ZAPM.bs.BSPRN1@1@1@@"
 G:PR7=0 WBK S BST="W"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSR="^%ZAPM.bs.BSbufB"
 ;```D RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST
 D TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST D x^%ZAPM.bs.BS3("72+PRN1")     ;---//--- для msm 4.x.x
 I DOS=1 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <F2> - Вывод в DOS-файл <ENTER> - На экран  <ESC> - Отмена """ G KW2
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <F2> - Вывод на печать <ENTER> - На экран  <ESC> - Отмена """
KW2 D STA^%ZAPM.bs.BST I R1=27 Q  ;ДЛЯ ЭКРАНА
 S BSWX=$P($P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,nx),"@",15),":",2),BSWY=$P($P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,1),"@",15),":",2),BSIT=1 D  G KW2
 .D SI^%ZAPM.bs.BSN N (%BS,vl,PRF,%zT,%KAT,%File,k0,k1,k2,k3,k4,k5,BSB,BSWX,BSWY,IMQ1,PR1,PR2,PR3,PR4,PR5,PR6,PR7,PR8,BSIT,DOS,%FN,%DEV,%I,SR1,SR2,SR3,SR) D BEG^%ZAPM.bs.BSPRN,WTV Q
 Q
KW3 S BSWX=$P($P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,nx),"@",15),":",2),BSWY=$P($P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,1),"@",15),":",2),$P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx),"@",15)="  ВЫДАН  " D  Q  ;ДЛЯ ПЕЧАТИ
 .D SI^%ZAPM.bs.BSN N (%BS,vl,PRF,%zT,%KAT,%File,k0,k1,k2,k3,k4,k5,BSB,BSWX,BSWY,IMQ1,PR1,PR2,PR3,PR4,PR5,PR6,PR7,PR8,DOS,%FN,%DEV,BSIT,%I,SR1,SR2,SR3,SR)
 .S BSIT=1 D BEG^%ZAPM.bs.BSPRN D  Q
 ..I DOS=1 D DOSIN^%ZAPM.bs.BSBL U 0 Q
 ..D PRN2
WBK ;ВЫВОД БЕЗ КАРТЫ
 D SI^%ZAPM.bs.BSN N (%BS,vl,PRF,%zT,%KAT,%File,k0,k2,k1,k3,k4,k5,BSB,BSIK,BSIIK,BSIT,IMQ1,PR1,PR2,PR3,PR4,PR5,PR6,PR7,PR8,DOS,%FN,%DEV,%I,SR1,SR2,SR3,SR)
 S BSIT=0,BSIK=1 F  S BSIK=$O(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIK)) Q:BSIK=""  S BSWY=$P($P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIK,1),"@",15),":",2),BSIIK=1 D  ;
 .F  S BSIIK=$O(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,BSIIK)) Q:BSIIK=""  S BSWX=$P($P(^(BSIIK),"@",15),":",2) S BSIT=BSIT+1 D BEG^%ZAPM.bs.BSPRN
 I DOS=1 D DOSIN^%ZAPM.bs.BSBL1 U 0 Q
 G PRN2
WTV ;ВЫВОД НА ЭКРАН
 W /ED(2),/CUP(1,1)
 S %I=$I,BSIT="" F  S BSIT=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSIT)) Q:BSIT=""  D
 .F BSP=1:1:21 S STR="" D PRN Q:STR=""  D WTV2
 .F BSP=1:1:21 S STR="" D PRN1 Q:STR=""  D WTV2
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S ls=" Отказ - <ESC>  " D O^%ZAPM.bs.BSF7 W $$r^%ZAPM.bs.BS3 Q
 G END1
WTV1 W $$r^%ZAPM.bs.BS3 Q
D D D^%ZAPM.bs.BS3($NA(@BSR@(BST))) G 0^%ZAPM.bs.BSTM
OFK I R3=81 D KW3
 G D
RPRN ;ПОВТОР ПЕЧАТИ
 I '$D(^%ZAPM.bs.BSbufB("ZP"_$G(%BS(3),$P)_$J_"u"_%BS(15))) Q
 S DAT=^%ZAPM.bs.BSbufB("ZP"_$G(%BS(3),$P)_$J_"u"_%BS(15)),PR1=$P(DAT,"."),PR4=$P(DAT,".",2),PR5=$P(DAT,".",3),SR=$P(DAT,".",4),SR1=$P(DAT,".",5),SR2=$P(DAT,".",6),SR3=$P(DAT,".",7)
 G PRN2
WTV2  W !,$E(STR,1,78) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSS" type="MAC" languagemode="0"><![CDATA[
%BSS ;СОРТИРОВКА,ПОДЖАТИЕ,ПОИСК,КОДИФИКАТОРЫ,ЗАМЕНА ; 15:26   24.01.2000
 N SB
 I $P(B,"@",24)'="S" G SORT^%ZAPM.bs.BSS2:($P(B,"@",36)&(TIP<2)) G PRESS
 K ^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S SB=$ZR,Nx=nx,Na=$$SORTNA^%ZAPM.bs.BSS2($P($P(B,"@",36),",",3)) I $P($P(B,"@",36),",",4) S Nx=$$SORTFOR^%ZAPM.bs.BSS2($P($P(B,"@",36),",",4))
 S WA="",ls="СОРТИРОВКА ПО КОЛОНКЕ "_Nx D WAITS^%ZAPM.bs.BSF2
 D DEND^%ZAPM.bs.BSF2 D:'$D(ke) REND^%ZAPM.bs.BSF2
 F i=1:1:se I $G(@BSR@(BST,i)) S I=$$SORTDATA() D  X $G(WA)
 .I I="" S I="@"
S .I '$D(@SB@(I)) D  Q
 ..F j=1:1:ke S @SB@(I,j)=@BSR@(BST,i,j)
 .S II=$O(@SB@(I,"?",""),-1)+1
 .F j=1:1:ke S @SB@(I,"?",II,j)=@BSR@(BST,i,j)
 I '$D(@SB) G NO
 S I="",kj=0,II="" F i=1:1:se I $G(@BSR@(BST,i)) X $G(WA) D
 .I I'="",$D(@SB@(I,"?")) D  Q:II'=""
 ..S II=$O(@SB@(I,"?",II),Na) Q:II=""  D SETSORT($NA(@SB@(I,"?",II)))
 .S I=$O(@SB@(I),Na) D SETSORT($NA(@SB@(I)))
 Q:$D(IntSortS)
 D TAB^%ZAPM.bs.BSF1 Q:$D(IntSort)
 D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
SETSORT(II) F j=1:1:ke S @BSR@(BST,i,j)=@II@(j) I $P(@$ZR,"@",7)=3 S kj=kj+1,$P(@$ZR,"@",15)=kj
 Q
D G 0^%ZAPM.bs.BSTM
SORTDATA() I Nx'["," Q "%"_$E($P(@BSR@(BST,i,+Nx),"@",15),1,$$LNG^%ZAPM.bs.BSF12)
 N F,FF S FF="" X "F F="_Nx_" Q:'F  D SORTD" Q "%"_FF
SORTD S FF=FF_$P(@BSR@(BST,i,F),"@",15)_"," Q
NO S ls=" Это НЕ список, или список пустой " D O^%ZAPM.bs.BSF7 G D
LE D LE^%ZAPM.bs.BSTT Q
 Q  ;ls-ТЕКСТ ll-ЗАПРЕЩЕННЫЕ СИМВОЛЫ li-СТРОКА
PRESS I $P(B,"@",24) D UNPRESS^%ZAPM.bs.BSSR D TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
 S OO=16,OOO="^%ZAPM.bs.BS" K %JB D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G D:R1=27
 D PRESS^%ZAPM.bs.BSSR G D:YES<1 S $P(@(BSR_"(BST)"),"@",24)=1,B=@$ZR
PRE D TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
CONT S fi=2 G FID
CONTAB I $D(%ZAP) S ls=" ТАБЛИЦА ЗАЩИЩЕНА ОТ КОРРЕКЦИИ ДАННЫХ " D O^%ZAPM.bs.BSF7 G D
 I '$D(%w(5)) D PASD^%ZAPM.bs.BST1 E  G D
 S li=$G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)),ls=" ЗАМЕНА В ТАБЛИЦЕ Вводите Контекст что заменять" D LE^%ZAPM.bs.BSTT I 'YES G D^%ZAPM.bs.BS
 S d1=li,ls=" Вводите СТРОКУ ,НА что заменять" D LE^%ZAPM.bs.BSTT G D^%ZAPM.bs.BS:'YES D CC
 S d0=li,li=d1,%zT=$ZT,$ZT="ERR^%ZAPM.bs.BSS",do="I $P(^(j),""@"",5)'=1 Q:$P(^(j),""@"",15)'[li  S d=$P(^(j),""@"",15),TmP=$ZR D CCC^%ZAPM.bs.BSS I YES D CONTX^%ZAPM.bs.BSS S $P(@TmP,""@"",15)=d" D BLOK^%ZAPM.bs.BSF1 E  G D
 S ^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)=li,$ZT=$G(%zT) K d2 D W^%ZAPM.bs.BST
 G B^%ZAPM.bs.BSTM
FIDD S fi=1
FID N jj,jjj,%HIS,%hlp,iC
 I TIP'=2!('$D(BSD)) S ls="ЭТО НЕ КАРТА БАЗЫ ДАННЫХ" D O^%ZAPM.bs.BSF7 G D
 I $D(NOKEY) S ls="Войдите В КАРТУ БАЗЫ ДАННЫХ нормальным образом (Не нажимая F4)" D O^%ZAPM.bs.BSF7 G D
 I $P(BS,"@",9)<2 S ls=" Клетка {"_ny_","_nx_"} Не хранится В Базе Данных ! " D O^%ZAPM.bs.BSF7 G D
 S Refresh=1
 S li=$G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)),ls=" ("_$S(fi=1:"ПОИСК",1:"ЗАМЕНА")_" В БАЗЕ ДАННЫХ) Вводите Контекст "_$S(fi=1:"поиска (F1-помощь)",1:",что заменять"),%HIS=$$HISFIND(),%hlp="^%ZAPM.bs.BSHLP(Find" D LE^%ZAPM.bs.BSTT I 'YES G D^%ZAPM.bs.BS
 I li["@" D FINDCEL^%ZAPM.bs.BSIND(li,ny,nx,BSR,BST) G:$G(END)=2 NEWCARD G D ;ИНДЕКСИРОВАННЫЕ ПОКАЗАТЕЛИ
 I fi'=1 S d=li,ls=" (ЗАМЕНА В БАЗЕ ДАННЫХ) Вводите СТРОКУ ,НА что заменять" D LE^%ZAPM.bs.BSTT G D^%ZAPM.bs.BS:'YES D CC
 G:li=""&(fi=1) D S:fi=2 d0=li,li=d S ^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)=li
 S jj=$S($P($P(BS,"@",18),"#")="":ny_","_nx,1:$P($P(BS,"@",18),"#")),jjj=$C(34) I jj=+jj S jjj=""
 S j=","_jjj_jj_jjj_")" K jj,jjj
 S YES=0,ls=$S(fi=1:"ПОИСК",1:"ЗАМЕНА:<"_li_"> НА:<"_d0_">")_" В БАЗЕ ДАННЫХ"
 D WAITS^%ZAPM.bs.BSF2 I fi=1,$$FFII() G Begin
 S i=BSD I $D(%KEYS(0)) S iC=$$CHOISE(%KEYS(0)) S:iC'="" i=i_iC I iC="" D ErrMsg^%ZAPM.bs.BSXfun("Отмена поиска") G FINiC
 ;ССЫЛКА СНАЧАЛА
Begin I $$ACTION() G NEWCARD
 K d2,END G FIN:fi=1,NEWC
CC S ls=" ЗАМЕНА С КОНТРОЛЕМ ? " D YES^%ZAPM.bs.BSF S fiii=YES Q
CCC S YES=1 Q:'fiii  S ls=" КЛЕТКА {"_i_","_j_"}="_$E(d,1,30)_"... ЗАМЕНЯЕМ ? " D YES^%ZAPM.bs.BSF Q
CONTX Q:d'[li  S d=$$TR^%ZAPM.bs.BSsFUNM(d,li,d0) Q
ERR S ls=$ZE D O^%ZAPM.bs.BSF7 G D
CHOISE(K) ;ВЫБОР КЛЮЧА
 N T1,T2,T3 S T1="^%ZAPM.bs.BSbufB",T2="0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),T3=li
 N (K,%BS,T1,T2,T3)
 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSS(KCH0)",1,2,"","CHOIS^%ZAPM.bs.BSS")
 S tab=$P(%BS("Tmp","LastTabl"),"@",4) I tab=27 Q ""
 S K=$P(%BS("Tmp","LastTabl"),"@",9)
 Q K
CHOIS ;ПОЛОМАТЬ ТАБЛИЦУ
 S $P(@BSR@(BST,2,3),"@",15)="ДЛЯ ПОИСКА:"_$G(T3)
 S Le="Find0Key" I '$D(%BS("Tmp",Le)) S %BS("Tmp",Le,1)=T1,%BS("Tmp",Le,2)=T2,%BS("Tmp",Le,3)=K
 I '$D(@T1@(T2)) S T1=%BS("Tmp",Le,1),T2=%BS("Tmp",Le,2),K=%BS("Tmp",Le,3)
 S AA=3 F A=3:1 Q:'$D(@T1@(T2,A,1))  D
 .S @BSR@(BST,A,1)=@BSR@(BST,3,1)
 .S @BSR@(BST,A,2)=@BSR@(BST,3,2)
 .S @BSR@(BST,A,3)=@BSR@(BST,3,3)
 .S $P(@BSR@(BST,A,3),"@",15)=$P(@T1@(T2,A,1),"@",15) I K=$P(@T1@(T2,A,1),"@",15) S AA=A
 S @BSR@(BST,"STA")=AA_",3@3@3@@@@"_(AA+2)_"@17"
 Q
ACTION() S %zT=$ZT,$ZT="ERA^%ZAPM.bs.BSS" D Wait^%ZAPM.bs.BSXfun("Поиск по шаблону "_li)
 K END F  S i=$ZO(@i) Q:i=""  D:i[j  Q:$D(END)  I YES Q
 .X WA I fi=1,$$ACTI(i,li) S zr=i W $$bel^%ZAPM.bs.BS3 S ls=$E(" Нашли "_$P(i,"(",2)_"="_$E(@i,1,30)_"...",1,79) D MENU^%ZAPM.bs.BSF5(" УСТАНОВИМ ДАЛЬШЕ ПРЕРВАТЬ ",ls) S:%B=3 END=1 S:%B=2 YES=0 I %B=1 S YES=1 Q
 .I fi=2,@i[li D:'fiii  Q:'fiii  S ls=$E(" Найдена "_$P(i,"(",2)_"="_$E(@i,1,30)_"...",1,79) W $$bel^%ZAPM.bs.BS3 D MENU^%ZAPM.bs.BSF5(" ЗАМЕНИМ ДАЛЬШЕ ПРЕРВАТЬ ",ls) S:%B=2 YES=0 S:%B=3 END=1 I %B=1 D  S YES=0
 ..S d=@i,%zT=$ZT,$ZT="ERR^%ZAPM.bs.BSS" D CONTX S @i=d,$ZT=$G(%zT),YES=0 I d="" K @i
 I YES Q 1
 Q 0
ACTI(i,li) I li'["?",("@"_@i)[("@"_li) Q 1
 I li["?" X "I (""@""_@i)"_li I  Q 1
 Q 0
ERA D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q 0
FFII() N (%BS,i,li,%NAm)
 I li["*"!(li["?") D
 .N I,S,II,SS
 .S S=$TR(li,"?","*"),SS="",II=0 F I=1:1 Q:$P(S,"*",I,I+1)=""  D
 ..S II=II+$L($P(S,"*",I))+1
 ..I $P(S,"*",I)'="" S SS=SS_"1"""_$P(S,"*",I)_""""
 ..I $E(li,II)="*" S SS=SS_".E"
 ..I $E(li,II)="?" S SS=SS_"1E"
 .S li="?1""@"""_SS_$S($E(li,$L(li))="*":".E",1:"")
 D Yes^%ZAPM.bs.BSXfun("ПРОДОЛЖАЕМ ПОИСК ОТ ТЕКУЩЕЙ КАРТЫ ?")
 I YES>0 S i=$E(%NAm,1,$L(%NAm)-1)_")" K END Q 1
 Q 0
NEWCARD ;zr - НОВАЯ ССЫЛКА j=",57)"  ----- $QS !!!!
 K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)) F m=1:1:9 K ^%ZAPM.bs.BSbufB(m_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 S k=$P($P(zr,"(",2),j) F i=1:1 Q:$P(k,",",i)=""  S %KEYS(i)=$P(k,",",i) I %KEYS(i)'=+%KEYS(i)&($E(%KEYS(i),1)=$C(34)) S %KEYS(i)=$E(%KEYS(i),2,$L(%KEYS(i))-1)
 ;D x^%ZAPM.bs.BS3(zr)     ;---//--- для msm 4.x.x
 I $D(%KEYS(0)) S %KEYS(0)=$P($P(zr,BSD,2),"(",1) I %KEYS(0)="" ZT "KEY0"
 I $D(%KEYS(i)) ZT "KEY("_i
NEWC D %NAm^%ZAPM.bs.BST1,FOR^%ZAPM.bs.BSF3 X I_" D BSD^%ZAPM.bs.BST1" D CALC^%ZAPM.bs.BSF3 G CARD
CARD F i=0:1:9 I $D(%KEYS(i)) S @("k"_i)=%KEYS(i)
 G KEY^%ZAPM.bs.BST
ShiftF7 ;ПОВТОРНЫЙ ПОИСК
 S Tmp="ShifF7",li=$G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)),fi=nx_","_ny_",0,1,1"
 S ls="ПОВТОРНЫЙ ПОИСК..."_li
 G FIND
HISFIND() Q "^%ZAPM.bs.BSbufB(""HISFIND"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")"
FindTxt(fi) ;fi=nx,ny,FLAG_REG,FLAG_TRAN,[
FIND S f2=$P(fi,",",2),f3=$P(fi,",",3),f4=$P(fi,",",4),f5=$P(fi,",",5),fi=$P(fi,",") S:"DFLT"[f2 f2=ny S f5=$S(f5:"",1:"@")
 S fii=$S(BSR["BSbufR":" ^",BSR["BSbuT":" ~",1:"") D WAITS^%ZAPM.bs.BSF2
 G:$G(Tmp)="Mark"!($G(Tmp)="ShifF7") fiN
 S %HIS=$$HISFIND()
 S li=$G(finl,$G(^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2))),ls=" (ПОИСК "_$S(f4:"ТРАНСФ.",1:"ДАННЫХ")_" В"_$S(fi:" "_fi_" КОЛОНКЕ",1:"О ВСЕЙ ТАБЛИЦЕ")_")  Вводите Контекст поиска" D LE^%ZAPM.bs.BSTT I 'YES G D^%ZAPM.bs.BS
 G:li="" D S ls="ПОИСК" D WAITS^%ZAPM.bs.BSF2
fiN D:'$D(se) DEND^%ZAPM.bs.BSF2
 I fi'=1 D:'$D(ke) REND^%ZAPM.bs.BSF2
 S YES=0,^%ZAPM.bs.BSbufB(0,$G(%BS(3),$P),2)=$G(li) F i=f2:1:se X $G(WA) F j=$S(fi:fi,1:1):1:$S(fi:fi,1:ke) I $D(@(BSR_"(BST,i,j)")) D  I YES S BSY(0)=i D TW^%ZAPM.bs.BST K MY,Tmp D KLE^%ZAPM.bs.BSTM G D
 .I $G(Tmp)="Mark" D  Q
 ..I $P(^(j),"@",12) S ls=" Найдена КЛЕТКА {"_i_","_j_"}="_$E(d1,1,60)_"... Годится ? " D YES^%ZAPM.bs.BSF Q
 .I $P(^(j),"@",9)=1 S (d,d0,d1)=$P(^(j),"@",15)
 .E  S (d,d0,d1)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j))
 .I f4 S BS=@BSR@(BST,i,j),ny=i,nx=j D
 ..I $P(BS,"@",8)'="" S %zT=$ZT,$ZT="FTRe^%ZAPM.bs.BSS" D  S $ZT=$G(%zT),YES=0
 ...I d0="" S d0=0
 ...I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"",ny,nx)")) Q
 ...X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 .I 'f3 I (f5_$$BIGL^%ZAPM.bs.BSsFUNM(d1))[(f5_fii_$$BIGL^%ZAPM.bs.BSsFUNM(li)) S ls=" Найдена КЛЕТКА {"_i_","_j_"}="_$E(d1,1,60)_"... Годится ? " D YES^%ZAPM.bs.BSF Q
 .I (f5_d1)[(f5_fii_li) S ls=" Найдена КЛЕТКА {"_i_","_j_"}="_$E(d1,1,60)_"... Годится ? " D YES^%ZAPM.bs.BSF Q
FIN S ls=" Поиск НЕ увенчался успехом " D O^%ZAPM.bs.BSF7
FINiC K Tmp,f5,f1,f2,f3,f4,fi,fii,fiii,finl,Tmp G D
FTRe S $ZT=$G(%zT) W $$bel^%ZAPM.bs.BS3 Q
 ;s1-ТЕКСТ s2=ИМЯ УЗЛА s3-ТИП s4-1 КОЛ s5-?
DIN S s1="МикроЗапросы",s2="DIN",s3="dinamo",s4="Формул $$TSVV для сводки",s5=0 G MASS
INV S s1="Кодификатоp",s2="INV",s3="invert",s4="Кодов",s5=1 G MASS
ERGLO S ls=" Не корректное имя массива ",$ZT=$G(%zT) D O^%ZAPM.bs.BSF7
MASS I BST["@" S ls=" СНАЧАЛО ВЫЙДИТЕ ИЗ РЕЖИМА КОРРЕКЦИИ <F3> " D O^%ZAPM.bs.BSF7 G D
 I '$D(%DIA) S ls=" БЛОК НЕ ОПРЕДЕЛЕН ! " D O^%ZAPM.bs.BSF7 G D
 G:$D(%INV) GOO S ls=" Вы хотите создать "_s1_" ? " D YES^%ZAPM.bs.BSF I 'YES G D
 S li=$G(@(BSR_"(BST,s2)")),ls="Вводите Имя Массива",ll="@" D LE^%ZAPM.bs.BSTT I 'YES G D
 S %zT=$ZT,$ZT="ERGLO^%ZAPM.bs.BSS" S:li'["^" li="^"_li I '$D(@li) G GO
 I $G(@li)'[("%BS-"_s3) S ls=" МАССИВ "_li_" СУЩЕСТВУЕТ И НЕ НАШ ! БУДЕМ ИСПОЛЬЗОВАТЬ ? " W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF G:'YES MASS
 I $G(@li)'["%BS-"_s3_"-"_BSR_","_BST_"@" S ls=" МАССИВ создан из "_$P($P($G(@li),"-",3,9),"@")_" ! БУДЕМ ИСПОЛЬЗОВАТЬ ? " W $$bel^%ZAPM.bs.BS3 D YES^%ZAPM.bs.BSF G:'YES MASS
 S ls=" БУДЕМ ОБНОВЛЯТЬ ? " D YES^%ZAPM.bs.BSF I 'YES G D
GO S %INV=li,$ZT=$G(%zT),s6="" S ls="Введите / Корректируйте комментарий",li=$P($G(@%INV),"@",2),ll="@" D LE^%ZAPM.bs.BSTT S:YES s6=li
GOO I '$D(%INV1) S ls=" Указатель находится в колонке "_s4_" ? " D YES^%ZAPM.bs.BSF D:'YES  G D:'YES S %INV1=nx G:TIP=4&(s2="DIN") DIN^%ZAPM.bs.BSF11 D OkMsg^%ZAPM.bs.BSXfun("ТЕПЕРЬ УСТАНОВИТЕ УКАЗАТЕЛЬ В ПОЛЕ ТЕКСТОВ И ПОВТОРИТЕ <F6>...и т.д.") G D
 .D ErrMsg^%ZAPM.bs.BSXfun("НУ ЧТО-ЖЕ ВЫ ! УСТАНОВИТЕ УКАЗАТЕЛЬ ТУДА И ПОВТОРИТЕ <F6>...и т.д.")
 S ls=" Указатель находится в колонке ТЕКСТов ? " D YES^%ZAPM.bs.BSF S:YES %INV2=nx I 'YES G D
 I %INV1=%INV2 S ls=" КОЛОНКИ СОВПАДАЮТ ?! " K %INV1,%INV2 D O^%ZAPM.bs.BSF7 G D
 D SETKD
 F i=1:1:se I $D(@(BSR_"(BST,i,%INV1)")),$P(^(%INV1),"@",12) D:s5  D:'s5 DINA I 'YES S BSY(0)=i D TW^%ZAPM.bs.BST,KLE^%ZAPM.bs.BSTM G D
 .S kod=$P(@$ZR,"@",15),txt=$P(^(%INV2),"@",15) I kod="" S ls=" КОД В СТРОКЕ "_i_" ПУСТОЙ ! " D O^%ZAPM.bs.BSF7 S YES=0 Q
 .I txt="" S ls=" ТЕКСТ В СТРОКЕ "_i_" ПУСТОЙ ! " D O^%ZAPM.bs.BSF7 S YES=0 Q
 .I $D(@%INV@(1,kod)) S ls=" КОД="_kod_" УЖЕ БЫЛ !!! " D O^%ZAPM.bs.BSF7 S YES=0 Q
 .S @%INV@(1,kod)=txt,@%INV@(2,txt)=kod,s6=s6+1
ENDIN I 's6 D ErrMsg^%ZAPM.bs.BSXfun("НЕ СОЗДАЛОСЬ НЕ ОДНОГО УЗЛА !")
 I s6 D OkMsg^%ZAPM.bs.BSXfun("СОЗДАЛОСЬ "_s6_" УЗЛОВ !") S @(BSR_"(BST,s2)")=%INV,@%INV@(1)=s6
 D U^%ZAPM.bs.BS3(%INV) K s6,s1,s2,s3,s4,s5,%INV,%INV1,%INV2,kod,txt G D
DINA S txt=$P(^(%INV2),"@",15),kod=$P(^(%INV1),"@",15) I kod="" S ls=" ФОРМУЛА В СТРОКЕ "_i_" ОТСУТСТВУЕТ ! " D O^%ZAPM.bs.BSF7 S YES=0 Q
 I txt="" S ls=" ТЕКСТ В СТРОКЕ "_i_" ПУСТОЙ ! " D O^%ZAPM.bs.BSF7 S YES=0 Q
 S (k1,k2,k3,k4,k5,k6,k7,k8,k9)=1,%zT=$ZT,$ZT="DINER^%ZAPM.bs.BSS"
 X "I "_kod
DINASET S s6=s6+1,@%INV@(1,s6)=txt_"@"_kod
 S $ZT=$G(%zT) Q
DINASE(txt,kod) G DINASET
TSVV(kod) X "I "_kod Q $T
SETKD D L^%ZAPM.bs.BS3(%INV) K GrKoD
 D DEL^%ZAPM.bs.BSF10($NA(@%INV@(1)),3),DEL^%ZAPM.bs.BSF10($NA(@%INV@(2)),3) K @%INV@(1),@%INV@(2)
 S YES=1,@%INV="%BS-"_s3_"-"_BSR_","_BST_"@"_s6_"@"_$G(%INV1)_"@"_$G(%INV2) D CP^%ZAPM.bs.BSGCH(%INV,$P(%BS(22),",",2))
 S $P(@%INV,"@",7)=$$h^%ZAPM.bs.BS3(),$P(@$ZR,"@",8)=1,s6=0,ls="Делаю "_s1 D WAITS^%ZAPM.bs.BSF2,DEND^%ZAPM.bs.BSF2
 Q
DINER D ErrMsg^%ZAPM.bs.BSXfun("Ошибка формулы в строке:"_i_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S YES=0 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSS1" type="MAC" languagemode="0"><![CDATA[
%BSS1 ;СОХРАНЕНИЕ,ВОССТАНОВЛЕНИЕ,СИМВОЛЬНЫЕ ИМЕНА ; 15:06   15.04.2003
e Q
COPY D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) K %DEV Q  ;СОХРАНЕНИЕ ОПИСАНИЯ ТАБЛИЦ
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSS1",ls="СОХРАНЕНИЕ...~"_%TAB D WAITS^%ZAPM.bs.BSF2
 I $D(@(%NAM_"(%TAB)")) S (cc,c)=$ZR,c1=$P(@$ZR,"@"),%3=$$TIP^%ZAPM.bs.BS($P(@$ZR,"@",17)),%0=$$ESDAY^%ZAPM.bs.BSsFUNR(10,$$h^%ZAPM.bs.BS3()) U %DEV W ";TABLE@"_%NAM_"@"_%TAB_"@"_%0_"@"_%3_"@"_c1,!
 D  F  S c=$ZO(@c) Q:c=""!(c'[($P(cc,")")_","))  D  U 0
 .U %DEV W $P(c,",",$S(c["]"&($P(c,"]")[","):3,1:2),255),$C(1),@c,!
 K c1,%3,%1,%2,c,cc Q
ER U 0 I $ZE["<INRP" S ls=" ПРЕРВАНО..." D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) G CLO
 I $ZE["<ENDOFFILE" G CLO
 S ls=$ZE,$ZT=$G(%zT) D O^%ZAPM.bs.BSF7
CLO U 0 C:$D(%DEV) %DEV Q
ERR U 0 I $ZE["<SYNT" S ls=" Не корректное имя раздела " D O^%ZAPM.bs.BSF7
 W *7 S $ZT=$G(%zT),ls=$ZE D O^%ZAPM.bs.BSF7 G I
D G 0^%ZAPM.bs.BSTM
ALLT S i="" F  S i=$O(@(BSR_"(BST,i)")) Q:'i  F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  X do
 Q
PRI S ls=" Создать для всех клеток БЛОКА уникальные СИМВОЛЬНЫЕ ИМЕНА для хранения ? " D YES^%ZAPM.bs.BSF Q:'YES
 S ls=" Если у вас уже хранится информация в Б.Данных, то она потеряется.Вы уверены ? " D YES^%ZAPM.bs.BSF Q:'YES
 S ls=" Уже созданные ИМЕНА ДЛЯ ХРАНЕНИЯ будем изменять ? " D YES^%ZAPM.bs.BSF S fi=YES
 S li1=$G(@(BSR_"(BST,""XBD"")"),57)+1,^("XBD")=li1,do="I $P(^(j),""@"",9)'=1 S li=$S($P($P(^(j),""@"",18),""#"")'=""""&('fi):$P($P(^(j),""@"",18),""#""),1:i_$C(li1)_j)_""#""_$P($P(^(j),""@"",18),""#"",2),$P(^(j),""@"",18)=li" D BLOK^%ZAPM.bs.BSF1 Q
BLK S li=$P($P(@(BSR_"(BST,ny,nx)"),"@",18),"#",2,3),do="S ix=$P(^(j),""@"",18) S ix=$P(ix,""#"")_""#""_li S $P(^(j),""@"",18)=ix" D BLOK^%ZAPM.bs.BSF1 Q
LON S ls=" ДЛИНА ИМЕНИ БОЛЬШЕ "_ii_" СИМВОЛОВ " D O Q
XBD1 K ^%ZAPM.bs.BSbufB("I"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S ^("I"_$G(%BS(3),$P)_$J_"u"_%BS(15))=1,do="I $P($P(^(j),""@"",18),""#"")'="""" S ^%ZAPM.bs.BSbufB(""I""_$G(%BS(3),$P)_$J_""u""_%BS(15),$P($P(@(BSR_""(BST,i,j)""),""@"",18),""#""))=i_"",""_j",ls="ИДЕНТИФИКАЦИЯ ИМЕН" D WAITS^%ZAPM.bs.BSF2,ALLT Q
XBD I $P(@(BSR_"(BST,ny,nx)"),"@",9)<2 S ls=" КЛЕТКА НЕ ХРАНИТСЯ В БАЗЕ ДАННЫХ " D O^%ZAPM.bs.BSF7 Q
 S ls=" Корректируйте СИМВОЛНОЕ ИМЯ КЛЕТКИ для адресно-независимого хранения (до 9 c.)",li=$P($P(@(BSR_"(BST,ny,nx)"),"@",18),"#"),ll="@#" D LE^%ZAPM.bs.BSTT S ii=9 Q:'YES
 S iii=1 G:li="" OU I $L(li)>ii D LON G XBD
 I li["," S ls=" СИМВОЛ <,> ЗАПРЕЩЕН " D O G XBD
 ;I li=+li S ls=" ИМЯ ДОЛЖНО БЫТЬ СИМВОЛЬНОЕ !!! " D O G XBD
 I '$G(^%ZAPM.bs.BSbufB("I"_$G(%BS(3),$P)_$J_"u"_%BS(15))) D XBD1
 I $D(^%ZAPM.bs.BSbufB("I"_$G(%BS(3),$P)_$J_"u"_%BS(15),li)),(^(li)'=(ny_","_nx)) S ls=" ИМЯ :"_li_" Уже имеет КЛЕТКА {"_^(li)_"} " D O^%ZAPM.bs.BSF7 Q
 S ^%ZAPM.bs.BSbufB("I"_$G(%BS(3),$P)_$J_"u"_%BS(15),li)=ny_","_nx G OU
OUT S ls=" Вводите / Корректируйте ИМЯ КЛЕТКИ для вывода данных ",li=$P($P(@(BSR_"(BST,ny,nx)"),"@",18),"#",2),ll="@#" D LE^%ZAPM.bs.BSTT S iii=2,ii=3 Q:'YES
 I $L(li)>ii D LON G OUT
OU S ix=$P(@(BSR_"(BST,ny,nx)"),"@",18) S $P(ix,"#",iii)=li S $P(@(BSR_"(BST,ny,nx)"),"@",18)=ix Q
SSS S ls="Корректируйте ССЫЛКУ НА КЛЕТКУ ИМЕЮЩУЮ ФОРМУЛУ ВЫЧИСЛЕНИЯ ДЛЯ ДАННЫХ ВЫВОДА",li=$P($P(@(BSR_"(BST,ny,nx)"),"@",18),"#",3) D LE^%ZAPM.bs.BSTT Q:'YES  G:li="" SS
 I li'?.N1",".N!('+li)!('+$P(li,",",2)) S ls=" ОШИБКА ШАБЛОНА ""НОМЕР_СТРОКИ,НОМЕР_КОЛОНКИ"" !!! " D O G SSS
 I '$D(@(BSR_"(BST,"_li_")")) S ls=" НЕТ КЛЕТКИ {"_li_"}" D O G SSS
 I '$D(@(BSR_"(BST,""FCL"","_li_")")) D Yes^%ZAPM.bs.BSXfun("НЕТ ФОРМУЛЫ ВЫЧИСЛ. У КЛЕТКИ {"_li_"} ! ЭТО ТАК НУЖНО ? ЗАПИШЕМ ?",2) I 'YES G SSS
SS S iii=3 G OU
 ;-----------
O D O^%ZAPM.bs.BSF7 Q
LE D A25^%ZAPM.bs.BSF1 W ls D 24^%ZAPM.bs.BSTM,LINE^%ZAPM.bs.BSF1 Q
 ;-----------
REST K %DEV,%FN D DOSREAD I '$D(%FN) K %DEV Q  ;ВОССТАНОВЛЕНИЕ ОПИСАНИЯ ТАБЛИЦ
 ;I $D(%BS("Tmp","DosFiles")) S XN="" F  S XN=$O(%BS("Tmp","DosFiles",XN)) G:XN="" XNE D XNOPN I $D(%FN) D XN
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSS1" F  U %DEV R %IN G:$ZC'=0 CLO D RES G:$ZC'=0!($ZE["<ENDOFFILE") CLO
 S $ZT=$G(%zT),ls=" В Файле "_%FN_" Описания Таблиц не найдено " D O G CLO
RES I $E(%IN,1,6)[";TABLE" U 0 D
 .S (S2,S1)="" I $$IFDOS^%ZAPM.bs.BSHTML1(%IN) D INIT^%ZAPM.bs.BSre(1) S %IN=$TR(%IN,S1,S2)
 .S ls=" Восстановим:"_$P(%IN,"@",2)_","_$P(%IN,"@",3)_" ;"_$P(%IN,"@",5)_" ;"_$P(%IN,"@",6),ls=$E(ls,1,79) D YES^%ZAPM.bs.BSF I YES G I
 Q
I S li=$G(%NAM,$P(%IN,"@",2))_","_$P(%IN,"@",3),ls="Корректируйте имя Восстанавливаемой таблицы. <Esc>-Отмена" D LE E  Q
 Q:li=""  S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BSS1",BSt=$P(li,",",$L(li,",")),BSr=$P(li,",",1,$L(li,",")-1) S:BSr'["^" BSr="^"_BSr
 I $D(@(BSr_"(BSt)")) S ls=" Таблица "_BSt_" В Разделе "_BSr_" Уже существует ! Замещаем ? " D YES^%ZAPM.bs.BSF G I:'YES S %NA=%NAM,%NAM=BSr,%TAB=BSt D PASE^%ZAPM.bs.BS1 S %NAM=%NA I '$D(%w(4)) G I
 S TIp="" I $P($G(@(BSr_"(BSt)")),"@",17) S TIp=$P(@$ZR,"@",17) I TIp=3!(TIp=4) S I=BSt F  S I=$O(@(BSr_"(I)")) Q:I=""!($P(I,".")'=BSt)  K @(BSr_"(I)")
 S BSt="@"_BSt K @(BSr_"(BSt)") S BSt=$E(BSt,2,99) K @(BSr_"(BSt)"),%w(4)
 S $ZT=$G(%zT),ls="ВОССТАНОВЛЕНИЕ..."_BSr_","_BSt D WAITS^%ZAPM.bs.BSF2
 F  U %DEV R %IN U 0 Q:$ZC'=0!($E(%IN,1,6)[";TABLE")!(%IN="")  D  S @(BSr_"(BSt"_$S($E(%IN,1)=$C(1):")",1:",")_$P(%IN,$C(1)))=$P(%IN,$C(1),2,999)
 .S %IN=$TR(%IN,S1,S2)
 .I $E(%IN,6)="]" D
 ..I $P(%IN,")")["," S %IN=$P(%IN,",",2,999) Q
 ..S %IN=$P(%IN,")",2,999)
 S @BSr@(BSt,"LST")=$H_","_$G(%BS(12))_",Restory from "_%FN
 D TRANS Q:$ZC'=0  G RES
TRANS U 0 S ls="РЕТРАНСЛЯЦИЯ ",TIp=$P(@(BSr_"(BSt)"),"@",17) K lo D WAITS^%ZAPM.bs.BSF2 S:'TIp TIp=1
 F f="FTR","FCL","COL","RTR" I $D(@(BSr_"(BSt,f)")) S i="" F  S i=$O(@(BSr_"(BSt,f,i)")) Q:i=""  S j="" F  S j=$O(@(BSr_"(BSt,f,i,j)")) Q:j=""  D  I YES S @(BSr_"(BSt,f,i,j)")=li1,^(j,1)=li
 .I ^(j)'["$$TS",$E(^(j),1,2)'=$S(f="COL":"I ",1:"S ") S zT=$ZR,ls=" НАЙДЕНА ОШИБКА ТРАНСЛЯЦИИ:"_$E(^(j),1,30)_"... ИСПРАВИМ ? " D YES^%ZAPM.bs.BSF I YES,$D(@zT) S $E(^(j),1,2)=$S(f="COL":"I ",1:"S ")
 .D  I 'YES S $P(@(BSR_"(BST,i,j)"),"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))="" S lo(f)=$G(lo(f))+1
 ..S li=^(j,1) D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,k0,k1,k2,k3,k4,k5,k6,k7,k8,k9,%KAT,%File,TIp,nx,ny,R1,R2,R3,li,li1,BSB,BSr,BSt,YES,f,ft,se,ke) S BSR=BSr,BST=BSt,TIP=TIp
 ..D ^%ZAPM.bs.BSFT Q
 I $D(lo) S ls=" РЕТРАНСЛЯЦИЯ НЕУДАЧНАЯ; ДЛЯ " D  S ls=ls_"ОШИБОК" D YES^%ZAPM.bs.BSF K lo
 .F f="FTR","RTR","COL","FCL" I $D(lo(f)) S ls=ls_f_":"_lo(f)_"  "
 Q
DosRead(%Dev,%Fn) 
DOSREAD I $D(%DEV)&($D(%FN)) G U:%DEV>50&(%DEV<55),U:$ZV["Cach"||($ZV["IRIS") ;ОТКРЫТЬ ДЛЯ ЧТЕНИЯ
DEV I $ZV["Cach"||($ZV["IRIS") S %DEV=51 G FN
 F %DEV=$G(%Dev,51):1:54 O %DEV::0 Q:$T
 I '$T S %DEV=0 S ls=" Все файловые устpойства ДОС заняты ..." D O G END
FN U 0 S %DEVTYPE="HFS" K %FN S ls=" Введите полный путь к DOS-файлу, Который будем читать (F3-Каталог)",li=$G(%Fn)
 D ChP^%ZAPM.bs.BSF10(1)
 S %KAT="D DOS^%ZAPM.bs.BSDOS",ll="",%HIS="^%ZAPM.bs.BSbufB(""HISFILE"_$S('$E($G(%BS(1)),12):$G(%BS(3),$P)_$G(%BS(12)),$E($G(%BS(1)),12)=1:"1"_$G(%BS(12)),1:"1")_""")" D LE^%ZAPM.bs.BSTT Q:li=""!('YES)  S %FN=li G:"^."[%FN END I $G(%SDEV)="HISTORY" C %DEV Q
 I $ZV["MSM" O %DEV:%FN U %DEV I $ZA=-1 U 0 S ls=" Файл "_%FN_" не существует " D O G FN
U I $ZV["Cach"||($ZV["IRIS") I '$$OpenFile^%ZAPM.bs.BSCF1(%FN,"R") U 0 S ls=" Ошибка откpытия файла "_%FN D O C %DEV G FN
 I $ZV["MSM" O %DEV:(%FN:"R") U %DEV I $ZA<0 U 0 S ls=" Ошибка откpытия файла "_%FN D O C %DEV G FN
END S %3=250 I "^."[%FN S %4="" C %DEV K %DEV,%FN D CL^%ZAPM.bs.BSF4 Q
 U 0 D CL^%ZAPM.bs.BSF4 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSS2" type="MAC" languagemode="0"><![CDATA[
%BSS2 ;СОРТИРОВКА ТАБЛИЦЫ;ТИПОВОЙ СПИСОК ; 15:09   01.07.99
SORT K ^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 S Nx=nx,I=$P(B,"@",36),Ns=+$P(I,",",2),Na=$$SORTNA($P(I,",",3)),Ny=+I I $P(I,",",4) S Nx=$$SORTFOR($P(I,",",4))
 S ls="СОРТИРОВКА ПО КОЛОНКЕ "_Nx D WAITS^%ZAPM.bs.BSF2 D:'$D(se) DEND^%ZAPM.bs.BSF2 D:'$D(ke) REND^%ZAPM.bs.BSF2
 S Na=$S(Na:1,1:-1)
 F i=Ny:Ns:se I $D(@BSR@(BST,i,+Nx)) S I=$$SORTDATA^%ZAPM.bs.BSS() D  X WA
 .I I="" S I=" "
S .I '$D(^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15),I)) D  Q
 ..F j=1:1:ke S ^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15),I,j)=@(BSR_"(BST,i,j)")
 .I I'=+I S I=I_" " G S
 .S I=I+.0000000001 G S
 I '$D(^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15))) S ls=" СОРТИРОВКА НЕ УДАЛАСЬ " D O^%ZAPM.bs.BSF7,K G D
 S I="",kj=0 F i=Ny:Ns:se X WA D  F j=1:1:ke S @(BSR_"(BST,i,j)")=^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15),I,j)
 .S I=$O(^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15),I),Na)
 D K,TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST G B^%ZAPM.bs.BSTM
K K ny,Nx,Ns,I,kj,^%ZAPM.bs.BSbufB("Sort"_$G(%BS(3),$P)_$J_"u"_%BS(15)),Na Q
SORTNA(Na) Q $S(Na:-1,1:1)
SORTFOR(N) N NN,NNN S N=$TR(N,"!",","),NNN="" I N'["," Q +N
 F NN=1:1 Q:'$P(N,",",NN)  S NNN=NNN_$P(N,",",NN)_$S($P(N,",",NN+1):",",1:"")
 Q NNN
D G 0^%ZAPM.bs.BSTM
TIS ;ТИПОВОЙ СПИСОК\СВОДКА
 N F,Ks,KKs,ii,i,j,BSr1,BSt1,BSr2,BSt2,CO,TI
 S TI=%B,ls=" ВЫ ХОТИТЕ СДЕЛАТЬ "_$S(%B=1:"СПИСОК",1:"СВОДКУ")_" НА ОСНОВЕ ТАБЛИЦЫ-БАЗЫ ДАННЫХ ? "
 I '$D(BSPART) D YES^%ZAPM.bs.BSF Q:'YES  S li="" D RIT^%ZAPM.bs.BSF3 Q:'YES  Q:'$D(BSr)  Q:'$D(BSt)  I $P(@(BSr_"(BSt)"),"@",17)'=2 S ls=" ЭТО НЕ БАЗА ДАННЫХ " D O^%ZAPM.bs.BSF7 Q
 S BSr1=BSr,BSt1=BSt,BSr2=%NAM,BSt2=TAB D COPY^%ZAPM.bs.BSTK
 S $P(@(BSr2_"(BSt2)"),"@",17)=1 K @(BSr2_"(BSt2,""KEY"")"),Ks S (j,i)=""
 D Wait^%ZAPM.bs.BSXfun("Создаю")
 F  S i=$O(@BSr2@(BSt2,i)) Q:'i  X $G(WA) F  S j=$O(@BSr2@(BSt2,i,j)) Q:'j  I $D(@BSr2@(BSt2,i,j)) D
 .S ii=@$ZR
 .I $P(ii,"@",9)'=1 S:'$D(Ks) Ks=i S:'$D(CO) CO=j S $P(@BSr2@(BSt2,i,j),"@",9)=1 D
 ..I TI=1 S F="$$TSPL(""{"_i_","_j_"}"","""","""","""",""1"")" D SETF(i,j,F)
 ..I TI'=1 S F="$$TSVL(""{"_i_","_j_"}"","""","""",1,2,1)" D SETF(i-1,j,F)
 ..S $P(@BSr2@(BSt2,i,j),"@",15)=""
 .S KKs=i
 I '$D(Ks) S ls=" НЕ НАШЛА КЛЕТКИ ХРАНИМЫЕ В БАЗЕ !!! " D O^%ZAPM.bs.BSF7 Q
 I TI=1 S F="$$TSP("""_$$TSE(BSr1)_","_BSt1_""","_Ks_",""1:1:"_(Ks-1)_""","""_(Ks+1)_":1:"_KKs_""")"  ;ОСНОВНАЯ ФУНКЦИЯ СПИСКА
 I TI'=1 S F="$$TSV("""_$$TSE(BSr1)_","_BSt1_""","_(Ks-1)_","_(CO-2)_","""","""")"  ;ОСНОВНАЯ ФУНКЦИЯ СВОДКИ
 D SETF(2,1,F)
 I '$D(BSPART) I TI'=1 S F=$P($G(^["GLAVK"]MZAPROS("zzz",1),"$$TSVD(""^MZAPROS1@^MZAPROS2"",/"),"/")_(Ks+1)_","_KKs_$P($G(^["GLAVK"]MZAPROS("zzz",1),"/)"),"/",2) D SETF(Ks,CO-2,F)
 I $D(BSPART) I TI'=1 S F=$P($G(^["FON"]AsI("MZAPROS",1),"$$TSVD(""^MZAPROS1@^MZAPROS2"",/"),"/")_(Ks-1)_","_(Ks-1)_$P($G(^["FON"]AsI("MZAPROS",3),"/)"),"/",2) D SETF(Ks,CO-2,F)
 Q
TSE(B) N A,I S A="" F I=1:1:$L(B) S A=A_$E(B,I) I $E(B,I)=$C(34) S A=A_$E(B,I)
 Q A
SETF(i,j,F) S $P(@BSr2@(BSt2,i,j),"@",7)=2,@(BSr2_"(BSt2,""FCL"",i,j)")=F,^(j,1)=F
 Q
E133 S ls=" УДАЛИТЬ ИЗ ТАБЛИЦЫ БЛОЧНОЕ МЕНЮ ,ВЫЗЫВАЕМОЕ ПО <ALT-F2> ? " D YES^%ZAPM.bs.BSF I YES K @(BSR_"(BST,""AF2"")")
 G D
E134 S ls=" УДАЛИТЬ ИЗ ТАБЛИЦЫ КЛЮЧИ !!! САМИ ПОЗАБОТЬТЕСЬ О БАЗЕ ДАННЫХ !. УДАЛЯЕМ ? " D YES^%ZAPM.bs.BSF I YES K @(BSR_"(BST,""KEY"")") D R^%ZAPM.bs.BSF4(17,1)
 G D
E1351 ;УДАЛЕНИЕ
E1352 ;ФОРМУЛ
E1353 ;
E1354 D CH G D:'YES S ff=$S(LAB["1^":"FCL",LAB["2^":"FTR",LAB["3^":"RTR",1:"COL"),pi=$S(ff="FCL":7,ff="FTR":8,ff="RTR":16,1:13)
 S do="I $P(^(j),""@"",pi)'="""" S $P(^(j),""@"",pi)="""" K @(BSR_""(BST,ff,i,j)"")"
 I '$D(%DIA) D ALLT^%ZAPM.bs.BSS1 I ff="FCL",TIP=2!(TIP=3) D R^%ZAPM.bs.BSF4(17,1) S TIP=1
 D:$D(%DIA) BLOK^%ZAPM.bs.BSF1
 G D
CH I '$D(%DIA) S ls=" УДАЛЯЕМ ФОРМУЛЫ ИЗ ВСЕЙ ТАБЛИЦЫ ? " D YES^%ZAPM.bs.BSF
 E  S ls=" УДАЛЯЕМ ФОРМУЛЫ ПОМЕЧЕННЫЕ В БЛОКЕ ? " D YES^%ZAPM.bs.BSF
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSSP" type="MAC" languagemode="0"><![CDATA[
%BSSP ;НАСЧЕТ СПИСКОВ ; 13:15   17.01.2002
 G 0
CYC1 X "S L(1,iii)="_%1 I $G(%3)'="" X "S L(2,iii)="_%3
 Q
CYC2 X "S L(1,iii)="_%1 I %2'="" X "S L(2,iii)="_%2
 I %3'="" X "S L(3,iii)="_%3
 Q
CYC3 S ib=$P($P(%1,"("_$C(34),2),","),ie=$P($P(%3,"("_$C(34),2),","),jb=$P($P(%1,",",2),$C(34)_")"),je=$P($P(%3,",",2),$C(34)_")"),LIC(iii)="",ii=0 I $D(@zr)
 F s=ib:%2:ie F k=jb:%2:je I 1 X:"1"'[%4 "I "_$TR($TR(%4,$C(221,222,223,224),s),$C(231,232,233,234),k) S %TEST=$T D
 .I %TEST S ii=ii+1,L(ii,iii)=$G(^(s_","_k)) Q
 .I '%TEST S ii=ii+1,ER(ii)=""
 Q
CYC4 X %1 S L(1,iii)=$G(%0) Q
CYCL I $D(@CurNam@(@("k"_keys),"3,3"))
 X SP(6,2) ;ДО
 S zr=$ZR I $D(SP(2)) S iii="" F  S iii=$O(SP(2,iii)) Q:iii=""  X SP(2,iii) X "I "_%1 E  G CYCE
 I '$D(CALCFON) W /CUP(23,1),/EL(0),zr
 I $D(@zr)
 K L,ER,LIC S iii="" F  S iii=$O(SP(4,iii)) Q:iii=""  X SP(4,iii) ;ТЕЛО ЦИКЛА
 S ii="" F  S ii=$O(ER(ii)) Q:ii=""  K:ii'=1 L(ii)
 I $D(ER(1)),$O(L(1))="" K L
 I $D(ER(1)),$O(L(1))'="",$D(LIC) S i1=$O(L(1)) S ii="" D  K L(i1)
 .F  S ii=$O(LIC(ii)) Q:ii=""  S L(1,ii)=$G(L(i1,ii))
 I $D(LIC) S ii="" F  S ii=$O(L(ii)) Q:ii=""  D
 .K iiii S iii="" F  S iii=$O(L(ii,iii)) Q:iii=""  I $G(L(ii,iii))'="" S iiii=1 Q
 .I '$D(iiii) K L(ii)
 K R,LIC S ii="" F  S ii=$O(L(ii)) Q:ii=""  S ny=ny+1,@BSr@(BSt,ny)=Pi,Yl=Yl+$P(O(1,1),"@",3) F iii=1:1:ke S @(BSr_"(BSt,ny,iii)")=O(1,iii) I $D(L(ii,iii)) S $P(@$ZR,"@",15)=L(ii,iii) 
 I $D(L),sii X "F si="_sii_" D COP" ;РАЗГРАНИЧИТЕЛЬ ТЕЛА ЦИКЛА
 X SP(6,3) ;ПОСЛЕ
CYCE Q
PI I +SP(6,1) S fo=1 X "F si="_SP(6,1)_" D COP" S Pi=Pi+1 ;ПРОМ.ИТОГ
 S fo=0 Q
0 I $E(%BS(1),13) D Yes^%ZAPM.bs.BSZPS Q:YES<1
BEGIN I '$D(x) S x=$NA(^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15)))
 I $D(CALCFON) S $P(@x,"#",2)=1,YES=0,x=$$%^%ZAPM.bs.BSF12($ZR) L -@x D  H 3 Q:YES
 .I CALCFON=2,$P($ZV,"Version ",2)="4.0.11" D ErrMsg^%ZAPM.bs.BSXfun("Удаленный процесс в "_$ZV_" ЗАПУСТИТЬ НЕЛЬЗЯ !") S YES=1
 .I CALCFON=2,$P($ZV,"Version ",2)'="4.0.11" S UUU=$P($P(UU,"[",2),"]") X "J J^%ZAPM.bs.BSSP(x,$G(ObR))["_UUU_"]::1" I  D:'$D(PACKET) OkMsg^%ZAPM.bs.BSXfun("Фоновый процесс в СИСТЕМЕ ["_UUU_"] ЗАПУЩЕН") S YES=1
 .I CALCFON=1 J J^%ZAPM.bs.BSSP(x,$G(ObR))::1 I  D:'$D(PACKET) OkMsg^%ZAPM.bs.BSXfun("Фоновый процесс ЗАПУЩЕН") S YES=1
 S $P(@x,"#",2)="" I $D(CALCFON) D:'$D(PACKET) ErrMsg^%ZAPM.bs.BSXfun("Не могу запустить фоновый процесс")
 D J(x,$G(ObR)) Q
J(x,ObR) S Total=$P($$h^%ZAPM.bs.BS3(),",",2) S:$G(%BS(15))<1 %BS(15)=0 L +@x K PaGe,zr,CH,SP,CALCFON
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSSP" D SI^%ZAPM.bs.BSN
 S i=$P(@x,"#"),BST=$P(i,",",$L(i,",")),BSR=$P(i,",",1,$L(i,",")-1)
 S ZPR=$P(@$ZR,"#",4),ZPT=$P(@$ZR,"#",5) S:$P(@$ZR,"#",2) CALCFON=1,WA="" S %0=$$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3()) D KCHO^%ZAPM.bs.BSsFUNM
 S BSr=$S(ZPR'="":ZPR,1:$$cB^%ZAPM.bs.BSSV),(iii,i)=$$TNAME^%ZAPM.bs.BSF13(BSR,BST),ii="",TIP=3,%Co=2,%Do=0,ls="ИДЕТ ГЕНЕРАЦИЯ СПИСКА" D:'$D(CALCFON) WAITS^%ZAPM.bs.BSF2 S WA=""
 I ZPR="" S ii=0 F  S i=$O(@(BSr_"(i)")) Q:i'[(iii_".")  D  S:ii<$P(i,".",2) ii=$P(i,".",2)
 S ii=ii+1,ZR="I $D(@zr)",BSt=$S(ZPT'="":ZPT,1:iii_"."_ii)
 L -@x,+@BSr@(BSt) ;ЛОКИРОВКА
 I $$VAR^%ZAPM.bs.BSH ;ПЕРЕМЕННЫЕ
 N Desc
 S @(BSr_"(BSt)")=@(BSR_"(BST)"),Desc=$P(@$ZR,"@"),$P(@$ZR,"@")=" "_%0_" ;СЧЕТ",$P(@$ZR,"@",17)=1,$P(@$ZR,"@",30)="" F i=2,4,5 S $P(@$ZR,"@",i)=""
 I $G(ObR)'="" S @ObR@("TT")=$ZR
 S I="",Yl=0,Pi=1 F  S I=$O(@x@(I)) Q:I=""  S II="" F  S II=$O(@x@(I,II)) Q:II=""  F III=1,2,3,4 I $D(@x@(I,II,III)) S CH(I,II,III)=$$Variabl(^(III))
 K SAY,@x L -@x S SAY=""
 S C=1 I $D(CH(1,0)) S SAY=$S(CH(1,0,4)'["NONE#":$P(CH(1,0,4),"#")_$$s(CH(1,0,1),0),1:"")
 F II=1:1:9 D:$D(CH(1,II))
 .I $G(CH(1,II,4),"NONE#")["TXTC#" S SAY=SAY_" "_$P(CH(1,II,4),"#",2) Q
 .I $G(CH(1,II,4),"NONE#")'["NONE#" D
 ..S SAY=SAY_" "_$P(CH(1,II,4),"#")_" "_$$s(CH(1,II,1),II)
 ..S SAY=SAY_" "_$P(CH(1,II,4),"#",2)_" "_$$s(CH(1,II,2),II)
 S BSD=@(BSR_"(BST,""TSP"",1)") I $D(^(2,1)) F i=1:1 Q:'$D(^(i))  S SP(2,i)=^(i)
 I '$D(@BSD) S ls=" БАЗЫ ДАННЫХ НЕТ !!! "_BSD G NO
 S SP(3,2)=@(BSR_"(BST,""TSP"",3,2)"),SP(3,3)=^(3),SP(3,4)=^(4),SP(3,5)=^(5),i=""
 I $D(@(BSR_"(BST,""TSP"",4)")) S SP(4)=$$GLRET^%ZAPM.bs.BSF12($ZR) F  S i=$O(@(BSR_"(BST,""TSP"",4,i)")) Q:i=""  I i S SP(4,i)=^(i)
 I $D(@(BSR_"(BST,""TSP"",7)")) S SP(7)=@$ZR
 S ny=0 K ke,k0,k1,k2,k3,k4,k5,O,fCL,fCOL I $D(@(BSR_"(BST,""TSP"",0)")) D SAY(@$ZR) S %Co=%Co+1 ;ЗАГОЛОВОК
 D SAY(SAY) ;СТРОКА ПЕРИОДА
 S (SP(6,2),SP(6,3))="" I $D(@(BSR_"(BST,""TSP"",6,1)")) S SP(6,1)=^(1) S:'^(2) SP(6,2)="X ""I $D(@zr)"" X ""I "_^(3)_""" I  D PI" S:^(2) SP(6,3)="X ""I $D(@zr)"" X ""I "_^(3)_""" I  D PI" I +^(4) S SP(6,4)=1
 I $D(@BSR@(BST,"ExcelOut")) S @BSr@(BSt,"ExcelOut")=@$ZR
 S $P(@BSr@(BSt,"ExcelOut"),",",3)=ny+1
 I +SP(3,3) S fo=1 X "F si="_SP(3,3)_" D COP" S ke=kj-1 ;ШАПКА
 D:'$D(ke) REND^%ZAPM.bs.BSF2 S CH="",CH=$O(CH(1,CH)) I CH="" S ls=" НЕОПРЕДЕЛЕНЫ КЛЮЧИ " G NO
 S si=+SP(3,2) I 'si S ls=" НЕ ОПРЕДЕЛЕНО ТЕЛО ЦИКЛА СПИСКА " G NO
 I $P(@(BSR_"(BST)"),"@",19) S $P(@(BSr_"(BSt)"),"@",19)=($P($P(@$ZR,"@",19),",")+%Co)_","_$P($P(@$ZR,"@",19),",",2)
 I $P(@(BSR_"(BST)"),"@",50) S $P(@(BSr_"(BSt)"),"@",50)=($P($P(@$ZR,"@",50),",")+%Co)_","_$P($P(@$ZR,"@",50),",",2)
 I $D(@(BSR_"(BST,""PRN"")")) S @(BSr_"(BSt,""PRN"")")=@$ZR
 I $D(@(BSR_"(BST,""RSM"")")) S @(BSr_"(BSt,""RSM"")")=@$ZR
 I $D(@(BSR_"(BST,""SVM"")")) S @(BSr_"(BSt,""SVM"")")=@$ZR
 I $D(@BSR@(BST,"Var")) D Copy^%ZAPM.bs.BSF8($NA(@$ZR),$NA(@BSr@(BSt,"Var")))
 S @BSr@(BSt,"REM")=$P(@BSR@(BST),"@")
 I $D(@(BSR_"(BST,""SHR"")")) S @(BSr_"(BSt,""SHR"")")=@$ZR
 I $D(@(BSR_"(BST,""HFS"")")) S @(BSr_"(BSt,""HFS"")")=$G(@$ZR)
 I $D(@(BSR_"(BST,""AF2"")")) S @(BSr_"(BSt,""AF2"")")=BSR_","_BST
 S @BSr@(BSt,"LST")=$H_","_$G(%BS(12))_",Greated"
 S @(BSr_"(BSt,""sp"")")="S"
 S fo=1 D COP S nyR=ny F kj=1:1:ke S $P(@(BSr_"(BSt,ny,kj)"),"@",3)=0,$P(@$ZR,"@",18)="" I $G(@(BSr_"(BSt,""FCL"",ny,kj)"))["$$TSP" K @$ZR S $P(@(BSr_"(BSt,ny,kj)"),"@",7)=""
 S AFO=@BSR@(BST),AFOO=""
 I $D(@(BSR_"(BST,si,1)")) F kj=1:1 Q:'$D(@(BSR_"(BST,si,kj)"))  S O(1,kj)=@$ZR,$P(O(1,kj),"@",7)="" D
 .I $D(@(BSR_"(BST,""FCL"",si,kj)")),@$ZR["$$TSPN" S $P(O(1,kj),"@",7)=3
 .I $P(AFO,"@",47),$D(@(BSR_"(BST,""FCL"",si,kj)")),@$ZR["$$TSP" S AFOO=AFOO_kj_"," ;А-ФОРМАТ
 .I $D(@(BSR_"(BST,""FTR"",si,kj)")) S $P(O(1,kj),"@",8)=nyR_","_kj
 .I $D(@(BSR_"(BST,""FCL"",si,kj)")),@$ZR'["$$TSP" S $P(O(1,kj),"@",7)=nyR_","_kj,fCL=1
 .I $D(@(BSR_"(BST,""COL"",si,kj)")) S $P(O(1,kj),"@",13)=nyR_","_kj,fCOL=1
 .I $D(@(BSR_"(BST,""RTR"",si,kj)")) S $P(O(1,kj),"@",16)=nyR_","_kj
 S:$G(fCL) $P(@(BSr_"(BSt)"),"@",32)=1 K fCL
 N nam,ks1,X1,X2,X3,X4,X5,X6,X7,X8,X9,ks2,ks3,ks4,ks5,ks6,ks7,ks8,ks9,CurNam
 S (nam,%NAm)=BSD,Ke=kj-1 I CH=0 S (nam,%NAm,BSD)=BSD_CH(1,CH,1),CH=CH+1,k0=CH(1,CH,1)
 I '$$GETDDP^%ZAPM.bs.BSF12(%NAm) G CEND
 S:$G(fCOL) $P(@(BSr_"(BSt)"),"@",33)=1 K fCOL
 S %NAm=%NAm_"(" F key=1:1:10 Q:'$D(CH(1,key))
 S keys=key-1,C=1,fo=0,sii=$S(SP(3,2)'=+SP(3,2):$P(SP(3,2),",",2,99),1:0)
 F i=1:1:9 S @("X"_i)="I 1 " I $D(CH(C,i,3)) S @("X"_i)=@("X"_i)_" "_CH(C,i,3)
 D
L1 .S k1=$$OTDO^%ZAPM.bs.BSSV($NA(@nam),1) F  S k1=$O(@nam@(k1)) Q:k1=""!(k1=ks1)  X X1 I  D
L2 ..D:'$D(CH(C,2)) CYCL I $D(CH(C,2,1)) S k2=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1)),2) F  S k2=$O(@nam@(k1,k2)) Q:k2=""!(k2=ks2)  X X2 I  D
L3 ...D:'$D(CH(C,3)) CYCL I $D(CH(C,3,1)) S k3=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2)),3) F  S k3=$O(@nam@(k1,k2,k3)) Q:k3=""!(k3=ks3)  X X3 I  D
L4 ....D:'$D(CH(C,4)) CYCL I $D(CH(C,4,1)) S k4=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2,k3)),4) F  S k4=$O(@nam@(k1,k2,k3,k4)) Q:k4=""!(k4=ks4)  X X4 I  D
L5 .....D:'$D(CH(C,5)) CYCL I $D(CH(C,5,1)) S k5=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2,k3,k4)),5) F  S k5=$O(@nam@(k1,k2,k3,k4,k5)) Q:k5=""!(k5=ks5)  X X5 I  D
L6 ......D:'$D(CH(C,6)) CYCL I $D(CH(C,6,1)) S k6=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2,k3,k4,k5)),6) F  S k6=$O(@nam@(k1,k2,k3,k4,k5,k6)) Q:k6=""!(k6=ks6)  X X6 I  D
L7 .......D:'$D(CH(C,7)) CYCL I $D(CH(C,7,1)) S k7=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2,k3,k4,k5,k6)),7) F  S k7=$O(@nam@(k1,k2,k3,k4,k5,k6,k7)) Q:k7=""!(k7=ks7)  X X7 I  D
L8 ........D:'$D(CH(C,8)) CYCL I $D(CH(C,8,1)) S k8=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2,k3,k4,k5,k6,k7)),8) F  S k8=$O(@nam@(k1,k2,k3,k4,k5,k6,k7,k8)) Q:k8=""!(k8=ks8)  X X8 I  D
L9 .........D:'$D(CH(C,9)) CYCL I $D(CH(C,9,1)) S k9=$$OTDO^%ZAPM.bs.BSSV($NA(@nam@(k1,k2,k3,k4,k5,k6,k7,k8)),9) F  S k9=$O(@nam@(k1,k2,k3,k4,k5,k6,k7,k8,k9)) Q:k9=""!(k9=ks9)  X X9 I  D
CEND I '$D(CALCFON) W /CUP(23,1),/EL(0)
 M @BSr@(BSt,"PERIODS")=CH //СОХРАНИТЬ ВЫБОРКУ
 K Mx S se=ny,Mr="",ls="ФОРМАТИРОВАНИЕ ВЫСОТЫ СТРОК" D:'$D(CALCFON) WAITS^%ZAPM.bs.BSF2 F i=2:1:se X WA I $G(@(BSr_"(BSt,i)"))=1 S Mx=$P(@$ZR@(1),"@",3) G:'SP(4) CEN X "F j="_SP(4)_" D XBOCT" D
 .S:Mx>21 Mx=20,Mr=1 I Mx>1 F j=1:1:ke S $P(@(BSr_"(BSt,i,j)"),"@",3)=Mx I Mr S $P(@(BSr_"(BSt,i,j)"),"@",12)=1
 G:$D(Mx) CEN F i=2:1:se K @(BSr_"(BSt,i)")
 S ny=1,$P(@(BSr_"(BSt)"),"@")=$P($P(@(BSr_"(BSt)"),"@"),";")_";ПУСТО" G CE
CEN I +SP(3,5) S ls="ОБРАБОТКА ФУНКЦИИ $$TSPN" D:'$D(CALCFON) WAITS^%ZAPM.bs.BSF2 S jj=0,j=+SP(3,5) F i=1:1:se X WA I $P($G(@(BSr_"(BSt,i,j)")),"@",7)=3 S jj=jj+1,$P(@$ZR,"@",15)=jj
 D:+$G(SP(6,4)) PI I +SP(3,4) S fo=1 X "F si="_SP(3,4)_" D COP" ;ИТОГ
CE I $G(AFOO) D GLSET^%ZAPM.bs.BSF12($NA(@BSr@(BSt,"AFO")),AFOO)
 K %TEST,BB,AFO,AFOO,SpStr,Pi,PaGe,si,sii,uci,r4,nyR,I,%1,%0,%2,%3,%4,%5,key,keys,CH,X1,X2,X3,X4,Mx,X5,O,L,SP,fo,%NAm,kj,f,ER,LIC,iiii D KCHO^%ZAPM.bs.BSsFUNM
 S $P(@BSr@(BSt),"@",24)="S"
 S BST=BSt,BSR=$$%^%ZAPM.bs.BSF12(BSr),ke=Ke
 I $P(@(BSR_"(BST)"),"@")'["ПУСТО",$P(@BSR@(BST),"@",36) K se S B=@$ZR,nx=$P($P(B,"@",36),",",2),IntSort=1,IntSortS=1 D CALC^%ZAPM.bs.BSF3,^%ZAPM.bs.BSS K IntSort,IntSortS
 D TAB^%ZAPM.bs.BSF1 S $ZT=$G(%zT) D  Q:$D(CALCFON)  D:'$D(PACKET) SPIS^%ZAPM.bs.BSF10 S CALCFONs=1 Q
 .I $G(ObR)'="" S @ObR@("TZ")=($P($$h^%ZAPM.bs.BS3(),",",2)-Total\60)_" мин"
 .I $P(@(BSr_"(BSt)"),"@")'["ПУСТО" S $P(@$ZR,"@")=$P($P(@(BSr_"(BSt)"),"@"),";")_";ГОТОВ "_" за "_($P($$h^%ZAPM.bs.BS3(),",",2)-Total)_" сек"_"|"_$G(Desc)
 .S $P(@$ZR,"@",30)=""
 .D TPr^%ZAPM.bs.BSF8($ZR)
 .S @BSr@(BSt,"PERDATE")=$$ESDAY^%ZAPM.bs.BSsFUNR(7,$$h^%ZAPM.bs.BS3())
 .S @BSr@(BSt,"PERUSER")=$G(%BS(12))
 .S @BSr@(BSt,"PER",1)=$G(SAY)
 .L -@BSr@(BSt)
COP ;КОПИРОВАНИЕ
 Q:'$D(@(BSR_"(BST,si,1)"))  S ny=ny+1,Yl=Yl+$P(@$ZR,"@",3) X WA
 F kj=1:1 Q:'$D(@(BSR_"(BST,si,kj)"))  S @(BSr_"(BSt,ny,kj)")=@$ZR I fo F f="FCL","COL","FTR","RTR" I $D(@(BSR_"(BST,f,si,kj)")) S @(BSr_"(BSt,f,ny,kj)")=@$ZR I f="COL" D
 .I $D(@(BSR_"(BST,f,si,kj,1)")) S @(BSr_"(BSt,f,ny,kj,1)")=@$ZR
 .I $D(@(BSR_"(BST,f,si,kj,2)")) S @(BSr_"(BSt,f,ny,kj,2)")=@$ZR
 Q
XBOCT Q:'$L($P($G(@(BSr_"(BSt,i,j)")),"@",15))  S jj=@$ZR I $D(SP(7)),$P(jj,"@",8)'="",(","_SP(7)_",")[(","_j_",") D TRANS^%ZAPM.bs.BST(BSr,BSt,jj,i,j) S $P(jj,"@",15)=d1
 I ($L($P(jj,"@",15))\$P(jj,"@",4)+$S($L($P(jj,"@",15))#$P(jj,"@",4):1,1:0))>Mx S Mx=$L($P(jj,"@",15))\$P(jj,"@",4)+$S($L($P(jj,"@",15))#$P(jj,"@",4):1,1:0)
e Q
SAY(SAY) S fo=0 I +SP(3,2) X "F si="_+SP(3,2)_" D COP" F j=1:1:kj-1 I $D(@(BSr_"(BSt,ny,j)")) S $P(@$ZR,"@",15)="",$P(@$ZR,"@",7)="",$P(@$ZR,"@",8)="",$P(@$ZR,"@",13)="",$P(@$ZR,"@",18)="",$P(@$ZR,"@",16)="",$P(@$ZR,"@",3)=1,$P(@$ZR,"@",6)=""
 S i=1 F j=1:1 Q:'$D(^(j))  S $P(^(j),"@",15)=$E(SAY,i,i+$P(^(j),"@",4)-1),i=$P(^(j),"@",4)+i
 Q
NO D  Q:$D(CALCFON)!($D(PACKET))  S $ZT=$G(%zT) D O^%ZAPM.bs.BSF7 S YES=0 Q
 .I $G(ObR)'="" S @ObR@("TT")="!!! "_ls
 .S $P(@(BSr_"(BSt)"),"@")="!!! "_ls,$P(@$ZR,"@",30)="" L -@BSr@(BSt)
END Q
s(d,K) ;ТРАНСФОРМАЦИЯ ТЕКСТА ВЫБОРКИ
 S %zT=$ZT,$ZT="ERTR^%ZAPM.bs.BSSP"
 S d1=d,d0=+d
 I $D(@BSR@(BST,"Key",K)) D
 .I $D(@BSR@(BST,"Key",K,3)) X @$ZR
 I "0§"[d1 Q ""
 Q d1
ERTR D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q $ZE
ER I $ZE["<INRPT" S ls=" ПРЕРВАНО ОПЕРАТОРОМ..." G NO
   I $ZE["<DKFUL" S ls=" ДИСК ПЕРЕПОЛНИЛСЯ" G NO
   I $ZE["<CMND"!($ZE["<SYNTX")!($ZE["<UNDEF") S ls=" ОШИБКА В ФОРМУЛАХ !",CALCFON=1 D NO Q:$D(CALCFON)!($D(PACKET))  D ERCMD^%ZAPM.bs.BSF11 Q
ER1 S ls=$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE) G NO
Variabl(FL) Q:FL'["vl(" FL ;ЗАМЕНА ПЕРЕМЕННЫХ ДАННЫМИ В ТЕКСТАХ ВЫБОРКИ
 N i,ii,iii,vi
 S iii=FL,%zT=$ZT,$ZT="ERvl^%ZAPM.bs.BSSP"
 F i=2:1 Q:$P(FL,"vl(",i,i+1)=""  S ii=$P($P(FL,"vl(",i),")") X "S vi=vl("_ii_")" S iii=$$TR^%ZAPM.bs.BSsFUNM(iii,"vl("_ii_")",vi)
 Q iii
ERvl I $ZE["UNDEF>" D ErrMsg^%ZAPM.bs.BSXfun(" НЕ ОПРЕДЕЛЕНА ПЕРЕМЕННАЯ vl("_ii_")")
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q $ZE
]]></Routine>


<Routine name="%ZAPM.bs.BSSR" type="MAC" languagemode="0"><![CDATA[
%BSSR ;ПОДЖАТИЕ ТАБЛИЦЫ, КАЛЬКУЛЯТОР  (А.Тимофеев) ; 16:52   15.09.99
 G D
D G 0^%ZAPM.bs.BSTM ;
SVO() N I,II
 I $G(@BSR@(BST,"PER")) Q @$ZR ;КОЛИЧЕСТВО ПЕРИОДОВ У СВОДКИ
 F I=ny:1:ny+9 I $G(@BSR@(BST,I)),(+$G(II)<+@$ZR) S II=@$ZR
 Q $G(II)
PRESSCFG ;КОНФИГУРИРОВАТЬ ОПЦИИ
 S li=$P(@BSR@(BST),"@",51) I li="" S li="1,1\"_ny_","_nx_"\1"
CFGAGAIN S li=$$LineEdit^%ZAPM.bs.BSXfun(li,"ВВЕДИТЕ ПАРАМЕТРЫ ПОДЖАТИЯ В ФОРМАТЕ: RY,RX\TY,TX\S   (F1-ПОМОЩЬ)","","","^%ZAPM.bs.BSHLP(""PRESS"")") Q:YES<1  I li'="",li'?1N.N1","1N.N1"\"1N.N1","1N.N1"\"1N D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА ФОРМАТА ! СМОТРИ F1") G CFGAGAIN
 D R^%ZAPM.bs.BSF4(51,li)
 Q
APRESS(G) ;АВТОПОДЖАТИЕ СВОДОК
 ;ЕСЛИ НАДО СДЕЛАТЬ НА АВТОМАТЕ ДЛЯ ПАКЕТОВ
 Q
PRESAUTO(R) ;АВТОПОДЖАТИЕ
 I $P(@(BSR_"(BST)"),"@",24) Q  ;УЖЕ ПОДЖАТА
 N is,js,RX,RY,O,Titul,MOD,%DIA,se,ke
 S MOD=$P(R,"\",3) D GR,AUTO
 S $P(@(BSR_"(BST)"),"@",24)=1,B=@$ZR
 D TAB^%ZAPM.bs.BSF1,TIT^%ZAPM.bs.BST Q
PRESS ;ПОДЖАТИЕ
 N is,js,RX,RY,O,Titul,MOD S MOD=%B I $P(B,"@",51) S R=$P(B,"@",51),$P(R,"\",3)=MOD G AUT
 I '$P(B,"@",19)&('$P(B,"@",50)) D Yes^%ZAPM.bs.BSXfun("ТИТУЛ НЕ УСТАНОВЛЕН !!! ПРОДОЛЖИМ ПОДЖАТИЕ ?",2) Q:YES<1
 S R=+$$SVO_",1\"_$S($P(B,"@",19):$P(B,"@",19),$P(B,"@",50):$P(B,"@",50),1:ny_","_nx)
AUT S R=$$LineEdit^%ZAPM.bs.BSXfun(R,"ВВЕДИТЕ ПАРАМЕТРЫ ПОДЖАТИЯ В ФОРМАТЕ: RY,RX\TY,TX\MODE    (F1-ПОМОЩЬ)","","","^%ZAPM.bs.BSHLP(""PRESS"")") Q:YES<1
AUTO S ls="идет поджатие" D WAITS^%ZAPM.bs.BSF2 S Titul=$P(R,"\",2) D GR
 I $D(%DIA) D Yes^%ZAPM.bs.BSXfun("В ТАБЛИЦЕ ЕСТЬ ПОМЕЧЕННЫЕ КЛЕТКИ. Будем поджимать ВСЕ ПОМЕЧЕННЫЕ "_$S(%B=1:"СТРОКИ",%B=2:" КОЛОНКИ",1:"СТРОКИ И КОЛОНКИ")_" ! (И пустые, и с данными) ?") Q:YES<1  D PRESP(MOD,"I $P(BOS,""@"",12)") S YES=1 Q
 D PRESSING(MOD) S YES=1
 Q
PRESSING(O) ;САМ ПРЕССИНГ
 N I,J,PR,ST,NB D GR S RX=$P(R,",",2)+1,RY=$P(R,",")+1,ST=0,NB=is
 F I=is:1:se X WA I ((I-is+1)#RY) F J=js:1:ke I ((J-js+1)#RX) I $$A^%ZAPM.bs.BSA(I,J)'="" D PR(1,I,1),PR(2,J,1)
 I "13"[O F I=is:1:se X WA D
 .I '((I-is+1)#RY) D:'ST  S ST=0,NB=I+1 Q
 ..F i=NB:1:I I i'=se D ERASY(i)
 .I $$PRI(1,I) S ST=1
 S ST=0,NB=js
 I "23"[O F J=js:1:ke X WA D
 .I '((J-js+1)#RX) D:'ST  S ST=0,NB=J+1 Q
 ..F i=NB:1:J I i'=ke D ERASX(i)
 .I $$PRI(2,J) S ST=1
 Q
PR(U,J,S) ;ПРИСВОЕНИЕ В ЛОКАЛЬ PR БАЙТА S В ПОЗИЦИЮ J УРОВНЯ U
 S $E(PR(U,J\4000),J-((J\4000)*4000)+1)=S Q
PRI(U,J) ;ВЕРНУТЬ БАЙТ ПО НОМЕРУ J УРОВНЯ U
 Q $E($G(PR(U,J\4000)),J-((J\4000)*4000)+1)
 
PRESP(O,USL) ;ПОМЕЧЕННЫЕ
 N I,J D GR
 F i=is:1:se X WA F j=js:1:ke S BOS=@BSR@(BST,i,j) X USL D:$T
 .I O=1 D ERASY(i) S j=ke+1 Q
 .I O=2 D ERASX(j) Q
 .D ERASY(i),ERASX(j) Q
 Q
ERASY(i) I $P(@BSR@(BST,i,1),"@",3)["X" Q
 N j F j=1:1:ke S $P(@BSR@(BST,i,j),"@",3)="X"_$P(@BSR@(BST,i,j),"@",3)
 Q
ERASX(j) I $P(@BSR@(BST,1,j),"@",4)["X" Q
 N i F i=1:1:se S $P(@BSR@(BST,i,j),"@",4)="X"_$P(@BSR@(BST,i,j),"@",4)
 Q
UNPRESS I TIP'=2 D Yes^%ZAPM.bs.BSXfun("Таблица Поджата. Снимем поджатие ?",2) Q:YES<1
 S ls="СНЯТИЕ ПОДЖАТИЯ" D WAITS^%ZAPM.bs.BSF2,UNPRES,TAB^%ZAPM.bs.BSF1 S $P(@(BSR_"(BST)"),"@",24)="",B=@$ZR Q
UNPRES N BOS,BOS1,i,j
 D GR F i=1:1:se X WA F j=1:1:ke S (BOS1,BOS)=@BSR@(BST,i,j) D  I BOS'=BOS1 S @BSR@(BST,i,j)=BOS
 .I $E($P(BOS,"@",3),1)="X" S $P(BOS,"@",3)=$P($P(BOS,"@",3),"X",2)
 .I $E($P(BOS,"@",4),1)="X" S $P(BOS,"@",4)=$P($P(BOS,"@",4),"X",2)
 Q
GR S TIT=$P(@(BSR_"(BST)"),"@",19),(is,js)=1 S:$D(Titul) TIT=Titul I TIT S is=$P(TIT,","),js=$P(TIT,",",2)
 D:'$D(ke) REND^%ZAPM.bs.BSF2 D:'$D(se) DEND^%ZAPM.bs.BSF2 ;ОПРЕД.КОНЕЧНЫХ ТОЧЕК
 Q
QQ G D^%ZAPM.bs.BS
CALK ;Калькулятор
 N i,i1,i2,i3,i4,%KAT,sEt
 S %zT=$ZT,$ZT="ERCA^%ZAPM.bs.BSSR"
 S li=$S($D(Bstr):@Bstr,1:$G(d)) I $D(%DIA) S li="",do="S sEt=$S($P(^(j),""@"",9)=1:$P(^(j),""@"",15),1:$G(^%ZAPM.bs.BSbufB(""BB""_$G(%BS(3),$P)_$J_""u""_%BS(15),i,j))) i +sEt s li=li_""+""_+sEt" D BLOK^%ZAPM.bs.BSF1
 I $L(li)>($$LNG^%ZAPM.bs.BSF12-1) D Yes^%ZAPM.bs.BSXfun("Получается очень длинная строка! Посчитаем Сразу ?") I YES>0 G C2
C1 S li=$$LineEdit^%ZAPM.bs.BSXfun($TR(li," ",""),"Пиши, например: 123+34 или 23/45+(98+67*34) выполнение-последовательное !","","","^%ZAPM.bs.BSHLP(CAL",$NA(^%ZAPM.bs.BSbufB("HISCALC"_$G(%BS(3),$P))),"Exit^%ZAPM.bs.BSSR")
 I $D(%KAT) S YES=1 Q
 I 'YES Q
 I li="" Q
 S i4="" F i2=1:1 S i3=$E(li,i2) Q:i3=""  D  Q:i4=1
 .I "1234567890+-/*.\)("'[i3 S i4=1 Q
 I i4=1 D ErrMsg^%ZAPM.bs.BSXfun("Никаких букв и = тоже ни к чему !!") G C1
C2 S i1="S i="_li X i1 S li=i G C1
 Q
Exit ;ВЫХОД ИЗ КАЛЬКУЛЯТОРА
 i R1=27,R2=79,R3=89 S %KAT=li,(R2,R3)=-1
 Q
ERCA I $ZE'["SINT" S ls="Ты шо !!!" D O^%ZAPM.bs.BSF7
  S ls="Нельзя же так писать !!!" D O^%ZAPM.bs.BSF7 X "I 0" S YES=0,$ZT=$G(%zT)
  Q
]]></Routine>


<Routine name="%ZAPM.bs.BSSV" type="MAC" languagemode="0"><![CDATA[
%BSSV ;;НАСЧЕТ СВОДОК ; 13:15   17.01.2002
 I $D(^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15))) S x=$ZR
 I $G(@Bsr@(Bst,"TSV",1,3))'="" D CHO^%ZAPM.bs.BSF11(@$ZR,$G(@Bsr@(Bst,"TSV",1,3,1)),x,$G(^(2))) Q:YES<1  G 0
 ;```D:$G(ZPT)="" OLD^%ZAPM.bs.BST2 S:$D(OLDT) $P(@x,"#",6)=1
 G 0
CY(Ss) I $D(@zr)
 I $G(%5)=1 S Ss=1
 I $E(SVo,2)=2 S $P(iv(%Co*n(iS)+iS+Cc+C-n(iS)),"@",iii)=Ss+$P($G(iv(%Co*n(iS)+iS+Cc+C-n(iS))),"@",iii) Q
 I $E(SVo,2)=0 S $P(^(iii),"@",15)=Ss+$P(@BSr@(BSt,(%Co*n(iS)+iS+Cc+C-n(iS)),iii),"@",15) Q
 I $E(SVo,2)=1 S $P(iv,"@",iii)=Ss+$P(iv,"@",iii) Q
 Q
CYC1 X "D CY("_%1_") I %3'="""" D CY("_%3_")"
 Q
CYC2 X "D CY("_%1_") I %2'="""" D CY("_%2_")"
 I %3'="" X "D CY("_%3_")"
 Q
CYC3 S ib=$P($P(%1,"("_$C(34),2),","),ie=$P($P(%3,"("_$C(34),2),","),jb=$P($P(%1,",",2),$C(34)_")"),je=$P($P(%3,",",2),$C(34)_")"),ii=0
 I 'STO F s=ib:%2:ie F k=jb:%2:je I 1 D  X:"1"'[%4 "I "_$TR($TR(%4,$C(221,222,223,224),s),$C(231,232,233,234),k) I  D CY($G(^(s_","_k)))
 .I $D(@zr)
 I STO S a2=0 F s=ib:%2:ie S a2=a2+1,b2=0 F k=jb:%2:je S b2=b2+1 I a1=a2&(b1=b2) D  I 1 X:"1"'[%4 "I "_$TR($TR(%4,$C(221,222,223,224),s),$C(231,232,233,234),k) I  D CY($G(^(s_","_k)))
 .I $D(@zr)
 Q
CY3 S ab=$P($P(q1,"("_$C(34),2),","),ae=$P($P(q3,"("_$C(34),2),","),bb=$P($P(q1,",",2),$C(34)_")"),be=$P($P(q3,",",2),$C(34)_")"),ii=0
 S a1=0 F a=ab:q2:ae S a1=a1+1,b1=0 F b=bb:q2:be S b1=b1+1 I 1 X:"1"'[q4 "I "_$TR($TR(q4,$C(221,222,223,224),a),$C(231,232,233,234),b) I  S STO=1,iii="" F  S iii=$O(SP(4,iii)) Q:iii=""  X ZR,SP(4,iii)
 Q
CYC4 X %1 D CY(%0) Q
CYCL I $D(@CurNam@(@("k"_keys),"3,3"))
 S zr=$ZR I $D(SP(2)) S iii="" F  S iii=$O(SP(2,iii)) Q:iii=""  X SP(2,iii) X "I "_%1 E  G CYCE
 I '$D(CALCFON) W /CUP(23,1),/EL(0),zr
 I $E(SVo,2)'=2 D @("cycl"_$E(SVo,2))
 I $D(iv),$S<25000 D SIZE^%ZAPM.bs.BSN(25) I $S<25000 D REC
 S iS="" F  S iS=$O(SP(5,iS)),STO=0 Q:iS=""  X ZR,SP(5,iS) I  I 'STO S iii="" F  S iii=$O(SP(4,iii)) Q:iii=""  X SP(4,iii)
CYCE Q
REC S iS="" F  S iS=$O(iv(iS)) Q:iS=""  F iii=1:1 Q:$P(iv(iS),"@",iii,iii+1)=""  I "0"'[$P(iv(iS),"@",iii) S $P(^(iii),"@",15)=$P(@BSr@(BSt,iS,iii),"@",15)+$P(iv(iS),"@",iii)
 K iv Q
cycl0 ;СТАРАЯ
 S iS="" F  S iS=$O(SP(5,iS)),STO=0 Q:iS=""  X ZR,SP(5,iS) I  I 'STO D
 .S iii="" F  S iii=$O(SP(4,iii)) Q:iii=""  X ZR,SP(4,iii)
 Q
cycl1 ;S iS="" F  S iS=$O(SP(5,iS)),STO=0 Q:iS=""  X ZR,SP(5,iS) I  I 'STO D
 .S iii="",iv="" F  S iii=$O(SP(4,iii)) Q:iii=""  X SP(4,iii)
 .F  S iii=$O(SP(4,iii)) Q:iii=""  S $P(^(iii),"@",15)=$P(@BSr@(BSt,(%Co*n(iS)+iS+Cc+C-n(iS)),iii),"@",15)+$P(iv,"@",iii)
 Q
COP ;КОПИРОВАНИЕ СТРОКИ si
 I $D(@(BSR_"(BST,si,1)")) S St=St+1 X WA F kj=1:1 Q:'$D(@(BSR_"(BST,si,kj)"))  S @(BSr_"(BSt,St,kj)")=@$ZR D
 .I 'fo F f="FCL","FTR","COL" S $P(@$ZR,"@",$S(f="COL":13,f="FCL":7,f="RTR":16,1:8))=""
 .I fo D
 ..I $D(@BSR@(BST,"FTR",si,kj)) S @BSr@(BSt,"FTR",St,kj)=@$ZR
 ..I "2345"'[$P(@BSR@(BST,si,kj),"@",7) I $D(@BSR@(BST,"FCL",si,kj)) S @BSr@(BSt,"FCL",St,kj)=@$ZR
 ..I '$P(B,"@",27) S f="COL" I $D(@(BSR_"(BST,f,si,kj)")) S @(BSr_"(BSt,f,St,kj)")=@$ZR D
 ...I $D(@(BSR_"(BST,f,si,kj,1)")) S @(BSr_"(BSt,f,St,kj,1)")=@$ZR
 Q
0 I $G(SRAVN) S CALCFON=SRAVN
 I $E(%BS(1),13) D Yes^%ZAPM.bs.BSZPS Q:YES<1
BEGIN I $D(CALCFON) S $P(@x,"#",2)=1,YES=0,x=$$%^%ZAPM.bs.BSF12($ZR) L -@x D  H 3 Q:YES
 .I CALCFON=2,$P($ZV,"Version ",2)="4.0.11" D ErrMsg^%ZAPM.bs.BSXfun("Удаленный процесс в "_$ZV_" ЗАПУСТИТЬ НЕЛЬЗЯ !") S YES=1
 .I CALCFON=2,$P($ZV,"Version ",2)'="4.0.11" S UUU=$P($P(UU,"[",2),"]") X "J J^%ZAPM.bs.BSSV(x,$G(ObR))["_UUU_"]::1" I  D:'$D(PACKET) OkMsg^%ZAPM.bs.BSXfun("Фоновый процесс в СИСТЕМЕ ["_UUU_"] ЗАПУЩЕН") S YES=1
 .I CALCFON=1 J J^%ZAPM.bs.BSSV(x,$G(ObR))::1 I  D:'$D(PACKET) OkMsg^%ZAPM.bs.BSXfun("Фоновый насчет ЗАПУЩЕН") S YES=1
 S $P(@x,"#",2)="",x=$ZR I $D(CALCFON) D:'$D(PACKET) ErrMsg^%ZAPM.bs.BSXfun("Не могу запустить фоновый процесс")
 D J(x,$G(ObR)) Q
J(xZ,ObR) S Total=$P($$h^%ZAPM.bs.BS3(),",",2) S:$G(%BS(15))<1 %BS(15)=0 L +@xZ K zr,CH,SP,CALCFON,n D SI^%ZAPM.bs.BSN
 S i=$P(@xZ,"#"),BST=$P(i,",",$L(i,",")),BSR=$P(i,",",1,$L(i,",")-1),BSdd=$P(@$ZR,"#",3),ZPR=$P(@$ZR,"#",4),ZPT=$P(@$ZR,"#",5) S:$P(@$ZR,"#",2) CALCFON=1,WA="" I +$P(@$ZR,"#",6) S OLDT=1,CO=$P(@$ZR,"#",7)
 S %0=$$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3()) D:'$D(CALCFON) END^%ZAPM.bs.BSF D KCHO^%ZAPM.bs.BSsFUNM
 S n=1,BSr=$S(ZPR'="":ZPR,1:$$cB),(iii,i)=$$TNAME^%ZAPM.bs.BSF13(BSR,BST),ii="",TIP=4,%Co=2,%Do=0,ls="ИДЕТ ГЕНЕРАЦИЯ СВОДКИ"
 I ZPR="" S ii=0 F  S i=$O(@(BSr_"(i)")) Q:i'[(iii_".")  S:ii<$P(i,".",2) ii=$P(i,".",2) ;````I $D(OLDT),$P($P(@(BSr_"(i)"),"@"),"_",2)=CO S ii=ii-1 Q
 S ii=ii+1,ZR="I $D(@zr)",BSt=$S(ZPT'="":ZPT,1:iii_"."_ii),ls=ls_" "_BSt D:'$D(CALCFON) WAITS^%ZAPM.bs.BSF2 S WA="" K:'$D(@(BSr_"(BSt)")) OLDT
 L +@BSr@(BSt)
 I $$VAR^%ZAPM.bs.BSH ;ПЕРЕМЕННЫЕ
 I $D(@(BSr_"(BSt)")),$P($P(@$ZR,"@"),"_",2)'=$G(CO,"?") K @$ZR,OLDT
 I $G(ObR)'="" S @ObR@("TT")=$ZR
 N Desc
 S (B,@(BSr_"(BSt)"))=@(BSR_"(BST)"),Desc=$P(@$ZR,"@"),$P(@$ZR,"@")="__"_%0_";СЧЕТ",$P(@$ZR,"@",17)=1,$P(@$ZR,"@",30)="" F i=2,4,5 S $P(@$ZR,"@",i)=""
 S I="" F Tmp=1:1 S I=$O(@xZ@(I)) Q:'I  S II="" F  S II=$O(@xZ@(I,II)) Q:II=""  F III=1,2,3,4 I $D(@xZ@(I,II,III)) S CH(Tmp,II,III)=$$Variabl^%ZAPM.bs.BSSP(^(III))
 S CH="",CH=$O(CH(1,CH)) I CH="" S ls=" НЕОПРЕДЕЛЕНА ВЫБОРКА КЛЮЧЕЙ " G NO^%ZAPM.bs.BSSP
 K SAY,ZPR,ZPT L -@xZ S xZ=@xZ K @$ZR
 F C=1:1 Q:'$D(CH(C))  D  S SAY(C)=C_" - период "_SAY
 .S SAY="" I $D(CH(C,0)) S SAY=SAY_$S(CH(C,0,4)'["NONE#":$P(CH(C,0,4),"#")_$$s^%ZAPM.bs.BSSP(CH(C,0,1),0),1:"")
 .F II=1:1:9 D
 ..I $G(CH(C,II,4),"NONE#")["TXTC#" S SAY=SAY_" "_$P(CH(C,II,4),"#",2) Q
 ..I $G(CH(C,II,4),"NONE#")'["NONE#" D
 ...S SAY=SAY_" "_$P(CH(C,II,4),"#")_" "_$$s^%ZAPM.bs.BSSP(CH(C,II,1),II)
 ...S SAY=SAY_" "_$P(CH(C,II,4),"#",2)_" "_$$s^%ZAPM.bs.BSSP(CH(C,II,2),II)
 S %zT=$ZT,$ZT="ER"_$S($D(CALCFON):1,1:"")_"^%ZAPM.bs.BSSP"
 S COMP=C-1,KLB=$G(@(BSR_"(BST,""TSV"",1)")) ;!!!I $D(^(2,1)) F i=1:1 Q:'$D(^(i))  S SP(2,i)=^(i)
 I 'KLB S ls=" БАЗ ДАННЫХ НЕТ ! " G NO^%ZAPM.bs.BSSP
 S TSVV=$G(@(BSR_"(BST,""TSV"",1,2)")),TSVL=$G(^(1)),TSVU=$G(^(4)),TSVN=$G(^(7)),TSVD=+$P($G(^(3,1)),",",3)
 S (Cc,St,fo)=0 I $D(@(BSR_"(BST,""TSV"",0)")) D SAY(@$ZR,1) S Cc=1
 F C=1:1:COMP D SAY(SAY(C),C+Cc) S @BSr@(BSt,"PER",C)=SAY(C)
 S St=COMP+Cc,TSV=$S($G(TSVD):TSVD-1,+TSVL:TSVL-1,+TSVU:TSVU-1,1:0) I '+TSV S ls=" ОШИБКА В РАСПОЛОЖЕНИИ ФУНКЦИЙ " G NO^%ZAPM.bs.BSSP
 I $P(@(BSR_"(BST)"),"@",19) S $P(@(BSr_"(BSt)"),"@",19)=($P($P(@$ZR,"@",19),",")+St)_","_$P($P(@$ZR,"@",19),",",2)
 I $P(@(BSR_"(BST)"),"@",50) S $P(@(BSr_"(BSt)"),"@",50)=($P($P(@$ZR,"@",50),",")+St)_","_$P($P(@$ZR,"@",50),",",2)
 I $D(@BSR@(BST,"ExcelOut")) S @BSr@(BSt,"ExcelOut")=@$ZR
 S $P(@BSr@(BSt,"ExcelOut"),",",3)=St+1
 I '$D(OLDT) S fo=1 F si=1:1:TSV D COP ;СОЗДАНИЕ ШАПКИ
 I $D(@(BSR_"(BST,""PRN"")")) S @(BSr_"(BSt,""PRN"")")=@$ZR
 I $D(@(BSR_"(BST,""RSM"")")) S @(BSr_"(BSt,""RSM"")")=@$ZR
 I $D(@(BSR_"(BST,""SVM"")")) S @(BSr_"(BSt,""SVM"")")=@$ZR
 I $D(@BSR@(BST,"Var")) D Copy^%ZAPM.bs.BSF8($NA(@$ZR),$NA(@BSr@(BSt,"Var")))
 S @BSr@(BSt,"REM")=$P(@BSR@(BST),"@")
 I $D(@(BSR_"(BST,""SHR"")")) S @(BSr_"(BSt,""SHR"")")=@$ZR
 I $D(@(BSR_"(BST,""HFS"")")) S @(BSr_"(BSt,""HFS"")")=$G(@$ZR)
 I $D(@(BSR_"(BST,""AF2"")")) S @(BSr_"(BSt,""AF2"")")=BSR_","_BST
 S @(BSr_"(BSt,""sp"")")="S"
 S @BSr@(BSt,"LST")=$H_","_$G(%BS(12))_",Greated"
 S @BSR@(BST,"PER")=COMP ;ПЕРИОДЫ СРАВНЕНИЯ
 S fo=0,%Co=COMP,SVo=$G(@BSR@(BST,"SVO"),"12")
 ;I +(TSVU) ;УНИВЕРСАЛЬНЫЕ ФОРМУЛЫ ???????? КОГДА ОНИ БУДУТ ????
 ;.....ЗАМЕНА СТАРОЙ
 I $D(OLDT) I +TSVV&(+TSVL) S si=TSV F  S si=$O(@(BSR_"(BST,si)")) G SVB:'si S fo=$S($P(@(BSR_"(BST,si,TSVV)"),"@",7):1,1:0) D ZER I fo S n(si)=n,n=n+1 F C=2:1:COMP D ZER
 ;......МИКРОЗАПРОСЫ ПОДРАЗУМЕВАЮТ МОНОБАЗУ !!!!!!!!!!!!!!!!!!
 I $P(xZ,"#",9)'="" D CREAT^%ZAPM.bs.BSF11($P(xZ,"#",9),$P($P(xZ,"#",10),",",3),$P($P(xZ,"#",10),",",4),$P($P(xZ,"#",10),",",1),$P($P(xZ,"#",10),",",2)) G SVB
 ;.........НОВАЯ БЕЗ М\ЗАПРОСОВ
 I +TSVV&(+TSVL) S si=TSV F  S si=$O(@(BSR_"(BST,si)")) G SVB:'si S fo=$S($P(@(BSR_"(BST,si,TSVV)"),"@",7):1,1:0) D COP I fo S @(BSr_"(BSt,St)")=1,n(si)=n,n=n+1 F C=2:1:COMP D COP S @(BSr_"(BSt,St)")=C,$P(@(BSr_"(BSt,St,TSVV)"),"@",15)=""
SVB S (ke,Ke)=kj-1 K iv D:'$D(CALCFON) Wait^%ZAPM.bs.BSXfun("ЦИКЛ ПО ДИАПАЗОНУ И БАЗЕ ДАННЫХ") F NBD=1:1:KLB D
 .K SP(2),SP(3),SP(4) I $D(@(BSR_"(BST,""TSV"",2,NBD)")) I $D(^(NBD,1)) F i=1:1 Q:'$D(^(i))  S SP(2,i)=^(i) ;TSPGL
 .I $D(@(BSR_"(BST,""TSV"",4,NBD)")) S i="" F  S i=$O(@(BSR_"(BST,""TSV"",4,NBD,i)")) Q:i=""  S SP(4,i)=^(i) ;TSVL
 .I $P(xZ,"#",9)="" D  ;КОГДА НЕТ МИКРО-ЗАПРОСОВ
 ..K SP(5) I $D(@(BSR_"(BST,""TSV"",5,0)")) S i="" F  S i=$O(@(BSR_"(BST,""TSV"",5,0,i)")) Q:i=""  S SP(5,i)=^(i) ;ВСЕ БАЗЫ
 ..I $D(@(BSR_"(BST,""TSV"",5,NBD)")) S i="" F  S i=$O(@(BSR_"(BST,""TSV"",5,NBD,i)")) Q:i=""  S SP(5,i)=^(i) ;TSVV
 .;~~~I $D(@(BSR_"(BST,""TSV"",3,NBD)")) S i="" F  S i=$O(@(BSR_"(BST,""TSV"",3,NBD,i)")) Q:i=""  S j="" F  S j=$O(@(BSR_"(BST,""TSV"",3,NBD,i,j)")) Q:j=""  S SP(3,i,j)=^(j) ;TSVU
 .K ke,k0,k1,k2,k3,k4,k5,O S BSD=$P($P(BSdd,"!",NBD),"@") F C=1:1:COMP D SVO
 G SVE ;..............КОНЕЦ СВОДКИ
SVO N nam,ks1,X1,X2,X3,X4,X5,X6,X7,X8,X9,ks2,ks3,ks4,ks5,ks6,ks7,ks8,ks9,CurNam
 S (nam,%NAm)=BSD I CH=0 S (nam,%NAm)=BSD_CH(C,CH,1),k0=CH(C,CH,1)
 I '$$GETDDP^%ZAPM.bs.BSF12(%NAm) Q
 S %NAm=%NAm_"(" F key=1:1:10 Q:'$D(CH(C,key))
 S keys=key-1,fo=0
 F i=1:1:9 S @("X"_i)="I 1 " I $D(CH(C,i,3)) S @("X"_i)=@("X"_i)_" "_CH(C,i,3)
 D
L1 .S k1=$$OTDO($NA(@nam),1) F  S k1=$O(@nam@(k1)) Q:k1=""!(k1=ks1)  X X1 I  D
L2 ..D:'$D(CH(C,2)) CYCL I $D(CH(C,2,1)) S k2=$$OTDO($NA(@nam@(k1)),2) F  S k2=$O(@nam@(k1,k2)) Q:k2=""!(k2=ks2)  X X2 I  D
L3 ...D:'$D(CH(C,3)) CYCL I $D(CH(C,3,1)) S k3=$$OTDO($NA(@nam@(k1,k2)),3) F  S k3=$O(@nam@(k1,k2,k3)) Q:k3=""!(k3=ks3)  X X3 I  D
L4 ....D:'$D(CH(C,4)) CYCL I $D(CH(C,4,1)) S k4=$$OTDO($NA(@nam@(k1,k2,k3)),4) F  S k4=$O(@nam@(k1,k2,k3,k4)) Q:k4=""!(k4=ks4)  X X4 I  D
L5 .....D:'$D(CH(C,5)) CYCL I $D(CH(C,5,1)) S k5=$$OTDO($NA(@nam@(k1,k2,k3,k4)),5) F  S k5=$O(@nam@(k1,k2,k3,k4,k5)) Q:k5=""!(k5=ks5)  X X5 I  D
L6 ......D:'$D(CH(C,6)) CYCL I $D(CH(C,6,1)) S k6=$$OTDO($NA(@nam@(k1,k2,k3,k4,k5)),6) F  S k6=$O(@nam@(k1,k2,k3,k4,k5,k6)) Q:k6=""!(k6=ks6)  X X6 I  D
L7 .......D:'$D(CH(C,7)) CYCL I $D(CH(C,7,1)) S k7=$$OTDO($NA(@nam@(k1,k2,k3,k4,k5,k6)),7) F  S k7=$O(@nam@(k1,k2,k3,k4,k5,k6,k7)) Q:k7=""!(k7=ks7)  X X7 I  D
L8 ........D:'$D(CH(C,8)) CYCL I $D(CH(C,8,1)) S k8=$$OTDO($NA(@nam@(k1,k2,k3,k4,k5,k6,k7)),8) F  S k8=$O(@nam@(k1,k2,k3,k4,k5,k6,k7,k8)) Q:k8=""!(k8=ks8)  X X8 I  D
L9 .........D:'$D(CH(C,9)) CYCL I $D(CH(C,9,1)) S k9=$$OTDO($NA(@nam@(k1,k2,k3,k4,k5,k6,k7,k8)),9) F  S k9=$O(@nam@(k1,k2,k3,k4,k5,k6,k7,k8,k9)) Q:k9=""!(k9=ks9)  X X9 I  D
CEND M @BSr@(BSt,"PERIODS")=CH
 D REC
 Q
OTDO(S,K) ;ОПРЕДЕЛЕНИЕ ГРАНИЦ ПЕРЕБОРА КЛЮЧЕЙ
 N K1,K2
 I CH(C,K,1)="" S K1=""
 I CH(C,K,2)="" S K2=""
 I '$D(K1) S K1=$O(@S@(CH(C,K,1)),-1)
 I '$D(K2) S K2=$O(@S@(CH(C,K,2)))
 S @("ks"_K)=K2,CurNam=S Q K1
ERCEN W /BEL S d1=$ZE Q
SVE I '$D(CALCFON) W /CUP(23,1),/EL(0)
CEN I +TSVN S ls="ОБРАБОТКА СРАВНЕНИЯ" D:'$D(CALCFON) WAITS^%ZAPM.bs.BSF2 S j=+TSVN D
 .N PA,d,d1,d0,C S PA=$P(TSVN,";",2)
 .F i=1:1:St I $G(@BSr@(BSt,i)) S (C,jj)=@$ZR D  S $P(@BSr@(BSt,i,j),"@",15)=d1 X WA
 ..S $ZT="ERCEN^%ZAPM.bs.BSSV"
 ..I PA="C" S (d,d0,d1)=jj
 ..I PA?1N.N S (d,d0,d1)=$G(CH(jj,PA,1))
 ..I PA="" S (d,d0,d1)=$G(CH(jj,0,1))
CE I $D(SP(4)) S (iS,n)="" D  D GLSET^%ZAPM.bs.BSF12($NA(@BSr@(BSt,"AFO")),n)
 .F  S iS=$O(SP(4,iS)) Q:iS=""  S n=n_iS_","
 K TSVL,TSVV,TSVD,SP,n,si,sii,Cc,k0,k2,k3,k4,k5,StR,KLB,I,%1,%0,%2,%3,%4,%5,key,keys,SAY,CH,X1,X2,X3,X4,Mx,X5,O,L,SP,fo,%NAm,kj,f,a,b,s,k,ib,ie,jb,je,q1,q2,q3,q4,q5,ab,ae,bb,be,STO,a1,a2,b1,b2 D KCHO^%ZAPM.bs.BSsFUNM
 S BST=BSt,BSR=$$%^%ZAPM.bs.BSF12(BSr),se=St,ke=Ke,ls="ФОРМИРОВАНИЕ ТАБЛИЦЫ" D:'$D(CALCFON) WAITS^%ZAPM.bs.BSF2 D TABM^%ZAPM.bs.BSF1 K TSV S $ZT=$G(%zT) D  Q:$D(CALCFON)  D:$D(zr)&('$D(PACKET)) ^%ZAPM.bs.BST S CALCFONs=1 Q
 .I $G(ObR)'="" S @ObR@("TZ")=($P($$h^%ZAPM.bs.BS3(),",",2)-Total)_" сек"
 .S I=$P(@(BSr_"(BSt)"),"@"),I=$P(I,";")_";"_$S($D(zr):"ГОТОВА",1:"ПУСТАЯ")_" за "_($P($$h^%ZAPM.bs.BS3(),",",2)-Total)_" сек"
 .S $P(I,"_",2)=COMP,$P(@(BSr_"(BSt)"),"@")=I_"|"_$G(Desc)
 .S $P(@$ZR,"@",30)="" D TPr^%ZAPM.bs.BSF8($ZR)
 .I $P(@BSr@(BSt),"@",51) D APRESS^%ZAPM.bs.BSSR($NA(@BSr@(BSt)))
 .S @BSr@(BSt,"PERDATE")=$$ESDAY^%ZAPM.bs.BSsFUNR(7,$$h^%ZAPM.bs.BS3())
 .S @BSr@(BSt,"PERUSER")=$G(%BS(12))
 .K COMP L -@BSr@(BSt)
ZER S St=St+1 X WA F kj=1:1 Q:'$D(@(BSr_"(BSt,St,kj)"))  I $P(@$ZR,"@",15) S $P(@$ZR,"@",15)=""
 Q
SAY(SAY,C) I '$D(OLDT) S si=1 D COP F j=1:1:kj-1 I $D(@(BSr_"(BSt,C,j)")) S $P(@$ZR,"@",15)="",$P(@$ZR,"@",7)="",$P(@$ZR,"@",8)="",$P(@$ZR,"@",13)="",$P(@$ZR,"@",3)=1,$P(@$ZR,"@",18)=""
 I $D(@(BSr_"(BSt,C,1)"))
 I $D(OLDT) S i=1 F j=1:1 Q:'$D(^(j))  S $P(^(j),"@",15)=$E($J("",$L(SAY)),i,i+$P(^(j),"@",4)-1),i=$P(^(j),"@",4)+i X WA
 S i=1 F j=1:1 Q:'$D(^(j))  S $P(^(j),"@",15)=$E(SAY,i,i+$P(^(j),"@",4)-1),i=$P(^(j),"@",4)+i X WA
 Q
cB() I $ZV'["Cach"&&($ZV'["IRIS") Q "^%ZAPM.bs.BSbufS" //$$%^%ZAPM.bs.BSF12("^%ZAPM.bs.BSbufS")
 N A S A=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSbufS")
 Q A_$$2LAT^%ZAPM.bs.BSCp($G(%BS(12),$G(BSLOGIN)))
]]></Routine>


<Routine name="%ZAPM.bs.BST" type="MAC" languagemode="0"><![CDATA[
%BST ;ВХОД В ТАБЛИЦУ ; 11:16   03.10.2000
 W $$atr^%ZAPM.bs.BS3(0) I $ZV'["Cach"&&($ZV'["IRIS") U 0:(0::::#10080)
 I $P($ZV,"Version ",2)<4 W $$clear^%ZAPM.bs.BS3
 K STATUS D SI^%ZAPM.bs.BSN I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 ;N S,STATUS,VYC,BS0,BSX,BSY,B,BX,BY,BS1,BS2,MX,MY,x,t,zr,t1,%VDB,%CAL,%X1,%X2,%Y1,%Y2,%TIT,MR,%w(2),M1,BS,%w(4),%w(5),%DIA,%DI,%ZAP,%FK,i,j,ii,jj,se,ke,j1,j2,j3,MX,MY,M,BS1,BS2,BSF,BSX1,BSX2,BSY1
 ;N BSY2,CLR,ENDLI,BSI,BSII,MR23,MR24,MR25,NAZAD,li,ls,lo,COLOR
 ;N RA,PREDMOV,MxX,MyY,My,Mx,COLOR,EXITout,%FN,%DEV,%Cu,es,ek,h,hi,hl,%INV,%INV1,%INV2,v,vv,vvv,TIP,%FK,%ZAP,%VDB,MOV
 S $ZT="PRO^%ZAPM.bs.BST"
% K PredOb I '$D(@BSR@(BST))!($$TIP^%ZAPM.bs.BS($P($G(@BSR@(BST)),"@",17))["!!!") S ls="ОБЪЕКТ ~"_BST_" В РАЗДЕЛЕ "_BSR_" НЕ ОПОЗНАН " G STOP
 S $ZT=$G(%zT) I $P(@$ZR,"@",39) Q  ;D Enter^%ZAPM.bs.BSGTab($ZR) Q  ;%BS Gamma Version
 I ($P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_$G(%BS(3),$P)_$J_"i"_$G(%BS(12)))'[$P(@$ZR,"@",30) S ls=" ТАБЛИЦА ЗАНЯТА ПОЛЬЗОВАТЕЛЕМ "_$P(@$ZR,"@",30) D  G STOP
 .D Yes^%ZAPM.bs.BSXfun(" СНИМЕМ ЗАКРЫТИЕ ???",2) I YES D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) I LOC S $P(@BSR@(BST),"@",30)="" D U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
 I BSR'["," S BSR=$$BSR^%ZAPM.bs.BSA(BSR)
 I $P(@$ZR,"@",37) D CHECK^%ZAPM.bs.BSH I 'YES G STOP
 D TIPP I '$D(%w(2)) D PASS^%ZAPM.bs.BST1 E  G END^%ZAPM.bs.BSF
 G DoBSX:TIP=5,DoLINK^%ZAPM.bs.BSF13:TIP=6,DoButt^%ZAPM.bs.BSF8:TIP=8
GOO I $E(%BS(1),20),%BS(12)="" D  H
 .S BSR="^%ZAPM.bs.BSS",BST="LOGON" D ^%ZAPM.bs.BST,Echo^%ZAPM.bs.BSXfun(1) D:d=2 SS^%ZAPM.bs.BSD2 Q:d<0
GO I $D(@(BSR_"(BST,""KEY"")")) D KEY^%ZAPM.bs.BST1:TIP=2,^%ZAPM.bs.BST2:TIP=3!(TIP=4) Q:'$D(F4)
 I '$D(@(BSR_"(BST,""KEY"")")),'$P(B,"@",34) D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) G:'LOC STOP
KEY I '$D(STATUS) S BS0=0,(BSX(BS0),BSY(BS0))=1,(BSX1(BS0),BSY1(BS0))=1,BSX2(BS0)=79,BSY2(BS0)=22
 W $$setkod^%ZAPM.bs.BS3 D LOCK^%ZAPM.bs.BSF4 D TIP   q:'$d(BSR)  //```msw 
WRITE I $G(@BSR@(BST,"RSM"))'="" D XM^%ZAPM.bs.BSre(@$ZR) ;ВЫПОЛНИТЬ КОМАНДУ ВОССТАНОВЛЕНИЯ
 I $D(@BSR@(BST,"FCL")) D CALC^%ZAPM.bs.BSF3
 I $P(@BSR@(BST),"@",47) D CHECKF^%ZAPM.bs.BSF10($P(@BSR@(BST),"@",47)) ;АВТОФОРМАТ
 I $P(@BSR@(BST),"@",24) D UNPRESS^%ZAPM.bs.BSSR I '$P(B,"@",24) G Wr
 I $P(@BSR@(BST),"@",51) D PRESAUTO^%ZAPM.bs.BSSR($P(@BSR@(BST),"@",51)) ;АВТОПОДЖАТИЕ
Wr I $P(B,"@",41)'="" S R1=333 D Pred^%ZAPM.bs.BSF12($P(B,"@",41)) ;ПРЕДОБР.ПОСЛЕ ВЫЧИСЛЕНИЯ
 D TIT
WRI I $ZV'["Cach"&&($ZV'["IRIS") U 0:(0::::#10080)
 S ls="ЗАГРУЗКА" D WAITS^%ZAPM.bs.BSF2 D W,MR K %VDB S $ZT=$G(%zT) G ^%ZAPM.bs.BSTM
VW D VT,W Q
GW D GT,W Q
TW D VT,GT,W Q
W I $G(Mx,0)'=0!($G(My,0)'=0),%BS(13)="%BS-PC",$ZV'["Windows" G ^%ZAPM.bs.BST5
MOV D:'$D(%VDB) CLEA K BS1,BS2,BY,BX S %BSTM=0
 K ENDDN S BSI=BSY(BS0)-1 F  S BSI=$O(@(BSR_"(BST,BSI)")) Q:'BSI  S BS(1)=1 I $P(@(BSR_"(BST,BSI,1)"),"@",3) D  Q:$D(ENDDN)
 .K ENDRI S BSII=BSX(BS0)-1 F  S BSII=$O(@(BSR_"(BST,BSI,BSII)")) Q:BSII=""  D WR I $D(ENDRI)!($D(ENDDN)) S BS(2)=0 Q
e Q
TRANS(BSR,BST,BS,BSI,BSII) N TranS,ny,nx,d,d0 S TranS=1 G TRAN
WR W $$atr^%ZAPM.bs.BS3(0) S CLR=COLOR I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",4)  I '$D(BS1) S BS1=$P(BS,"@")+1,BS2=$P(BS,"@",2)+1 I 'BS0 S (BS(1),BS(2))=1
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+BSY1(BS0))>BSY2(BS0) S ENDDN=1 Q
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+2+BSX1(BS0))>BSX2(BS0) S ENDRI=1 Q
 I $P(BS,"@",10) S CLR=$P(BS,"@",10) I $E(%BS(1),19) S CLR=$P(%BS,"!",$E(%BS(1),19))
 I $P(BS,"@",12) S CLR=$P(%BS,"!",3)
TRAN I $P(BS,"@",9)=1 S (d,d1,d0)=$P(BS,"@",15)
 E  S (d,d1,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSI,BSII)) //```??
 I $P(BS,"@",8)'="" S %zT=$ZT,$ZT="FFF^%ZAPM.bs.BST" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .S ny=BSI,nx=BSII I '$P(BS,"@",8) X $G(@BSR@(BST,"FTR",BSI,BSII)) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 I $D(TranS) Q
w I '$D(%VDB) S l=$J("",$P(BS,"@",3)*$P(BS,"@",4)) F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)>BSY2(BS0)  D  W $E(d1_l,BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))
 .W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0))),$$atr^%ZAPM.bs.BS3(CLR) Q
 Q:BS0  I BS(1) S BY($P(BS,"@")-BS1+1+BSY1(0))=BSI,BS(1)=0
 I BS(2) S BX($P(BS,"@",2)-BS2+1+BSX1(0))=BSII
 Q
VT Q:'$D(%TIT)  S BS0=2,BSY(BS0)=BSY(0) D W S BS0=0 Q
GT Q:'$D(%TIT)  S BS0=1,BSX(BS0)=BSX(0) D W S BS0=0 Q
MR K %FK,%ZAP N i F i=12:1:14 S @("MR"_(i+11))="" I $P(@(BSR_"(BST)"),"@",i)'="" D
 .I $P(^(BST),"@",i)=1 S @("MR"_(i+11))="D MR"_(i+11) Q
 .S @("MR"_(i+11))=$P(^(BST),"@",i)
 K %fk I $P(^(BST),"@",15)'="" S %FK=$P(^(BST),"@",15)
 I $P(^(BST),"@",16) S %ZAP=1
 I TIP=2,$G(%BS("Tmp","AKBD",BSD),"RWD")="R" S %ZAP=1
 Q
TIPP S B=@(BSR_"(BST)") S TIP=$P(B,"@",17) S:TIP="" TIP=1 D ENTERPAS^%ZAPM.bs.BSF7(B) Q
TIP S:'$D(%Co) %Co=0    q:'$d(BSR)  S B=$G(@(BSR_"(BST)")) //$G(
 S:$P(B,"@",3) %DIA=1 S:$P(B,"@",20) %CAL=$P(B,"@",20) S TIP=$P(B,"@",17) S:TIP="" TIP=1 D ENTERPAS^%ZAPM.bs.BSF7(B)
 S COLOR=$S($E(%BS(1),19):$P(%BS,"!",$E(%BS(1),19)),1:$P(B,"@",31)) I COLOR="" S COLOR=0
 S %Cu=$S($G(TIP)=7:"D KL","1"[$P(B,"@",25):"D KL",1:"D 24") K Ukaz I $P(B,"@",43) S Ukaz=1
 I $P(B,"@",46)'="",'$D(ObOi) D OBWRITE^%ZAPM.bs.BSF10
 S:$G(%BS(15))<1 %BS(15)=0 S se=$P(B,"@",28),ke=$P(B,"@",29) S Mouse=$S(ke=1:1,1:"") I $P(B,"@",38),'$D(RA) S RA=$P(B,"@",38) D Ramka^%ZAPM.bs.BSXfun($P(B,"@",8)-1,$P(B,"@",9)-1,$P(B,"@",10)+1,$P(B,"@",11)+1,RA,COLOR,1)
 S POSt=%BS(16) I $P(B,"@",44)'="" S POSt=$P(B,"@",44)
 I $P(B,"@",41)'="" S PredOb=$P(B,"@",41)
 I $D(BSR) D PST^%ZAPM.bs.BSD1(BSR)
 I TIP=2,$D(BSD),$G(%BS("Tmp","AKBD",BSD),"RWD")="R" S %ZAP=1
 Q
TIT I $P(@(BSR_"(BST)"),"@",19) S %TIT=$P(^(BST),"@",19) K:'$D(@(BSR_"(BST,"_%TIT_")")) %TIT
 E  K %TIT
 I $D(@BSR@(BST)) D  ;
 .I '$D(%TIT) S BS0=0,BSY1(0)=$P(^(BST),"@",8),BSX1(0)=$P(^(BST),"@",9),BSY2(0)=$P(^(BST),"@",10),BSX2(0)=$P(^(BST),"@",11) D:$E($G(%BS(14)),2) TRM Q
 .S BS0=0,BSY2(BS0)=+$P(^(BST),"@",10),BSX2(BS0)=+$P(^(BST),"@",11) D  S BSY1(BS0)=$P(@(BSR_"(BST,"_%TIT_")"),"@")+BSY1(0)-1,BSX1(BS0)=$P(@$ZR,"@",2)+BSX1(0)-1 I $G(STATUS)'=BST S BSY(0)=+$P(%TIT,","),BSX(0)=+$P(%TIT,",",2),STATUS=BST
 ..S BSY1(0)=+$P(^(BST),"@",8),BSX1(0)=+$P(^(BST),"@",9)
 .S BS0=1,(BSY1(3),BSY1(BS0))=+$P($G(@(BSR_"(BST)"),1),"@",8),BSX1(BS0)=BSX1(0),(BSY2(3),BSY2(BS0))=BSY1(0)-1,BSX2(BS0)=+$P(^(BST),"@",11)
 .S BS0=2,BSY1(BS0)=BSY1(0),(BSX1(3),BSX1(BS0))=+$P(^(BST),"@",9),BSY2(BS0)=+$P(^(BST),"@",10),(BSX2(3),BSX2(BS0))=BSX1(0)-1
 .S (BSY(3),BSX(3),BSY(1),BSX(2))=1,BSY(2)=BSY(0),BSX(1)=BSX(0),BS0=3 D:$E($G(%BS(14)),2) TRM D W S BS0=1 D W S BS0=2 D W S BS0=0
 Q
TRM I TIP'=7 F i=0,1,2 D
 .I $D(BSX2(i)),BSX2(i)>64,ke'=1 S BSX2(i)=64
 .I $D(BSY2(i)),BSY2(i)>21 S BSY2(i)=21
 Q
FFF W $$bel^%ZAPM.bs.BS3 I $ZE["<NOPGM" S @$ZR=""
 S $ZT=$G(%zT) G w
CLEA I TIP=7 S ColrMenu=$S($P(B,"@",31)="":"1;6;30;47",1:$P(B,"@",31)) D  K BFL,% Q
 .I $D(^%ZAPM.bs.BSR(2,1)) D
 ..W /ED(2),/CUP(1,1) W $$atr^%ZAPM.bs.BS3(ColrMenu)
 ..I $E($G(%BS(14)),6)=3 D  Q  ;ДЛЯ АРМ-ТЕРМ
 ...F i=1:1:25 W /CUP(i,1),$E($TR(^(i),"x",""),1,80-(i=25))
 ..F i=1:1:25 W /CUP(i,1),$E($TR(^(i),"x",""),1,80)
 .W /CUP(24,3) W:%BS(13)["%BS-PC" $$atr^%ZAPM.bs.BS3(ColrMenu) W ^%ZAPM.bs.BS(26),/CUP(4,3+((77-$L($P(B,"@")))\2)),$P(B,"@")
 .D MENU
 I '($D(ObOi)!($D(RA))) D
 .I $G(%BS(14)),((BSY1(BS0)<3&(BSX1(BS0)<3))!($E(BST,1,2)="fT")) W /CUP(BSY1(BS0),BSX1(BS0)),$C(27),"[0J" Q
 .W $$atr^%ZAPM.bs.BS3(0) F i=BSY1(BS0):1:BSY2(BS0) W /CUP(i,BSX1(BS0)),$J("",BSX2(BS0)-BSX1(BS0)+1)
 Q
MENUU() ;ТИТУЛ МЕНЮ
 I $G(%BS(38))="" Q $E($ZV,1,28)
 Q $E("Работает: "_$G(%BS(38)),1,28)
MENU I '$D(ColrMenu) G UNDOMENU^%ZAPM.bs.BSF11
 W $$atr^%ZAPM.bs.BS3(ColrMenu),/CUP(2,3),$$MENUU()," ",$$WEEKEND^%ZAPM.bs.BSsFUNR(1,$$h^%ZAPM.bs.BS3())," ",$$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3())," %BS Version ",+^%ZAPM.bs.BS," " Q
RAM(Y1,X1,Y2,X2,RA,COLOR) W $$atr^%ZAPM.bs.BS3(COLOR) S ii=$S(RA=1!(RA=""):"-----|",RA=2:"=====|",RA=" ":"      ",1:"§§§§§§")
 W /CUP(Y1,X1),$E(ii,1),$TR($J("",X2-X1-1)," ",$E(ii,2)),$E(ii,3)
 F i=Y1+1:1:Y2-1 W /CUP(i,X1),$E(ii,6),$J("",X2-X1-1),$E(ii,6)
 W /CUP(Y2,X1),$E(ii,4),$TR($J("",X2-X1-1)," ",$E(ii,2)),$E(ii,5) Q
P I $ZE'["<PRO" S ls=$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) Q
 S $ZT=$G(%zT) G GO
STOP D O^%ZAPM.bs.BSF7 S d="",R1=27,ny=1 G END^%ZAPM.bs.BSF
PRO S ls=$$ErrSay^%ZAPM.bs.BSF8($ZE) G STOP
STA ;ВОССТАНОВЛЕНИЕ ПО "STATUS ME"
 S $ZT="PRO^%ZAPM.bs.BST"
 G %:'$D(@(BSR_"(BST,""STA"")")) S S=^("STA"),STATUS=BST,zr=$ZR
 S BS0=0,BSX(BS0)=$P(S,"@",3),BSY(BS0)=$P(S,"@",2),MX=$P(S,"@",8),MY=$P(S,"@",7) I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 G %
DoBSX D L^%ZAPM.bs.BS3($NA(@BSR@(BST))),^%ZAPM.bs.BSX("TEXT",BSR,BST),U^%ZAPM.bs.BS3($NA(@BSR@(BST))),U^%ZAPM.bs.BS3($NA(@BSR@("@"_BST))) q
IN(%w) ;ВХОД ПО ПОЛНОЙ ССЫЛКЕ ИЗ BSN
]]></Routine>


<Routine name="%ZAPM.bs.BST1" type="MAC" languagemode="0"><![CDATA[
%BST1 ;ПАРОЛИ И КЛЮЧИ (ПОДПРОГРАММА) ; 15:50   15.04.2003
PASS D PASCHECK^%ZAPM.bs.BS1(BSR,BST,2," Введите пароль входа в таблицу:"_BSR_","_BST_" ","PASS") Q
PASE  I $ZV["Cach"||($ZV["IRIS") S %w(4)="" Q  ;```
 S i1=1,sys=$P($$ZU^%ZAPM.bs.BS3(0),",",2),uc=$P($$ZU^%ZAPM.bs.BS3(0),",") D  I uc="N" S ls=" Пользователю "_%BS(12)_" КОРРЕКТИРОВАТЬ ДАННЫЕ НЕЛЬЗЯ " D O^%ZAPM.bs.BSF7 X "I 0" Q
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),sys,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),$G(@%BS(18)@(%BS(37),sys,uc,$P(BSR,$S(BSR["]":"]",1:"^"),2),BST,"4,2"))="N" S uc="N"
 I $P(@(BSR_"(BST)"),"@",4)="" S %w(4)="" I 1 Q
PSE D PASCHECK^%ZAPM.bs.BS1(BSR,BST,4," Введите пароль коррекции описания таблицы:"_BSR_","_BST_" ","%w(4)") Q
PASD  I $ZV["Cach"||($ZV["IRIS") S %w(5)="" Q  ;```
 S i1=1,sys=$P($$ZU^%ZAPM.bs.BS3(0),",",2),uc=$P($$ZU^%ZAPM.bs.BS3(0),",") D  I uc="N" S ls=" Пользователю "_%BS(12)_" КОРРЕКТИРОВАТЬ ДАННЫЕ НЕЛЬЗЯ " D O^%ZAPM.bs.BSF7 X "I 0" Q
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),sys,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),$G(@%BS(18)@(%BS(37),sys,uc,$P(BSR,$S(BSR["]":"]",1:"^"),2),BST,"3,2"))="N" S uc="N"
 I $P(@(BSR_"(BST)"),"@",5)="" S %w(5)="" I 1 Q
PSD D PASCHECK^%ZAPM.bs.BS1(BSR,BST,5," Введите пароль коррекции данных таблицы:"_BSR_","_BST_" ","%w(5)") Q
PASDD  I $ZV["Cach"||($ZV["IRIS") S %w(3)="" Q  ;```
 S i1=1,sys=$P($$ZU^%ZAPM.bs.BS3(0),",",2),uc=$P($$ZU^%ZAPM.bs.BS3(0),","),BSr=$P(IMQ,",",1,$L(IMQ,",")-1),BSt=$P(IMQ,",",$L(IMQ,","))
 D  I uc="N" S ls=" Пользователю "_%BS(12)_" КОРРЕКТИРОВАТЬ ДАННЫЕ НЕЛЬЗЯ " D O^%ZAPM.bs.BSF7 X "I 0" Q
 .I %BS(12)'="",'$D(@%BS(18)@(%BS(37),"*")),'$D(@%BS(18)@(%BS(37),sys,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),'$D(@%BS(18)@(%BS(37),sys,uc,"*")),$G(@%BS(18)@(%BS(37),sys,uc,$P(BSr,$S(BSr["]":"]",1:"^"),2),BSt,"3,2"))="N" S uc="N"
 I $P(@(BSr_"(BSt)"),"@",5)="" S %w(3)="" I 1 Q
PSDD D PASCHECK^%ZAPM.bs.BS1(BSr,BSt,5," Введите пароль коррекции данных таблицы:"_BSr_","_BSt_" ","%w(3)") Q
RED W /CUP(24,1),/EL(0),$$atr^%ZAPM.bs.BS3("37;41") Q
CLE W $$atr^%ZAPM.bs.BS3(0) Q
KEY S BSD=$$KBD^%ZAPM.bs.BSF12($NA(@BSR@(BST))) I $G(%BS("Tmp","AKBD",BSD),"RWD")="NONE" D ErrMsg^%ZAPM.bs.BSXfun("ДЛЯ ПОЛЬЗОВАТЕЛЯ `"_$G(%BS(12))_"` БАЗА ДАННЫХ "_BSD_" НЕ ДОСТУПНА !") Q
 S IMQ=BSR_","_BST,Bsr=BSR,Bst=BST K NOKEY,%KEYS,NAZAD N Hid,Hidd
 F key=0:1:13 K ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15)) I $D(@BSR@(BST,"KEY",key)) S endkey=key
 D KW^%ZAPM.bs.BSD1 I $P(@BSR@(BST,"KEY",endkey),"@",6)="HiddenLastKey" D Hidden^%ZAPM.bs.BS2
 F key=0:1:endkey I $D(@(BSR_"(BST,""KEY"",key)")) D KE,MT G:$D(%BS("Tmp","EXIToutBD",IMQ)) ZF G:$D(NAZAD)&('$D(NOKEY)) ZF I key=endkey!($D(NOKEY)) D  S key=key-1 I $D(NOKEY) S NAZAD=1 G ZF
 .F i=0:1:13 S @("k"_i)=$G(%KEYS(i),0)
 .K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)) I '$D(NOKEY) K CALCFON D BSDvBSB:TIP=2 I $D(CALCFON) Q
 .S imq=IMQ
 .D SI^%ZAPM.bs.BSN N (Hid,Hidd,%BS,vl,%NAm,key,imq,endkey,%zT,%KAT,%File,BSB,BST,BSR,%KEYS,BSD,NOKEY,k0,k1,k2,k3,k4,k5,k6,k7,k8,k9)
 .I "IP"[$G(%BS("Tmp","AKBD",BSD),"RWD") D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` ВХОД В КАРТУ БАЗЫ ДАННЫХ ЗАПРЕЩЕН !") Q
 .I '$P(@BSR@(BST),"@",34),'$D(^(BST,"Free")) D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) I 'LOC D ErrMsg^%ZAPM.bs.BSXfun("ТАБЛИЦА ОПИСАНИЯ БАЗЫ ДАННЫХ ЗАНЯТА ДРУГИМ ПОЛЬЗОВАТЕЛЕМ") Q
 .I $D(%BS("Tmp","BSD")),$G(%BS("Tmp","AKBD",BSD),"RWD")'="R" D L^%ZAPM.bs.BS3($NA(@%BS("Tmp","BSD"))) I 'LOC D ErrMsg^%ZAPM.bs.BSXfun("УЗЕЛ БАЗЫ ЗАНЯТ ДРУГИМ ПОЛЬЗОВАТЕЛЕМ") Q
 .D SW("LAST",imq)
 .D KEY^%ZAPM.bs.BST I $D(%BS("Tmp","BSD")) D U^%ZAPM.bs.BS3($NA(@%BS("Tmp","BSD")))
 .D LW("LAST",imq) Q
ZF ;I '$D(Report) S $P(@(Bsr_"(Bst)"),"@",30)=""
 K Bsr,Bst G END^%ZAPM.bs.BSF
MT Q:'$D(MTr)  S (Bsr,BSR)=MTr,(Bst,BST)=MTt K MTr,MTt Q
SW(key,IMQ) D SW^%ZAPM.bs.BSD1(key)
 Q
LW(key,IMQ) D LW^%ZAPM.bs.BSD1(key)
 Q
KE ;ОПРЕДЕЛЕНИЕ КЛЮЧА
 D SI^%ZAPM.bs.BSN N (Hidd,Hid,%BS,vl,Bsr,Bst,MTr,MTt,%zT,%KAT,%File,%NAm,BSD,key,endkey,%KEYS,NAZAD,NOKEY,IMQ) F i=4:1:7,10,13:1:16,20 S @("k"_i)=$P(^(key),"@",i)
 S kt=$G(^(key,3))
 I key=0 D NAMEKEY Q
 D INDKEY Q
NAMEKEY ;ИМЕННОЙ КЛЮЧ
 N ucI S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР <F4>-РЕДАКТ <F5>-КОПИР <F6>-СЕРВИС <F7>-ТАБ  <F8>-УДАЛ."""
 S BSR="^%ZAPM.bs.BSbufB",BST="0k"_$G(%BS(3),$P)_$J_"u"_%BS(15)
 I $D(^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"STA")) D STA^%ZAPM.bs.BST G NAMKE
 D SW(key,IMQ)  K %BS("Tmp","Find0Key") //ДЛЯ ПОИСКА
 S %zT=$ZT,$ZT="NOSY^%ZAPM.bs.BST1"
 S %NAm=BSD,i=2,kd1=k6[",TIME" D K5^%ZAPM.bs.BST4
 K ^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15)),ii3 I k7'="",$$TAB^%ZAPM.bs.BSD1($ZR,k7) G IK7
 D HEAD($ZR) S ^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)="@@1@70@@@@@1@"_$P(%BS,"!",4)_"@@@@@ .. k"_key_" "_BSD
 S ^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)="@@"_k6_"@@@@@1@"_k10_"@@@@@ "_$S(k5'="":k5,1:"НОВЫЙ ИМЕННОЙ КЛЮЧ")
IK7 I kt'="" S ^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3,1)=@$ZR,i=i+1,$P(@$ZR,"@",3)="",$P(@$ZR,"@",8)=0,^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",3,1)=kt,kt1="3,1" D:kd1
 .S @$ZR=@$ZR_" I $P(BS,""@"",19)'="""" S kd=$S($P(BS,""@"",19):$$ESDAY^%ZAPM.bs.BSsFUNR(9,$P($P(BS,""@"",19),"","",1,2)),1:$P(BS,""@"",19)),d1=d1_$J("""",$P(BS,""@"",4)-$L(d1)-22)_kd_"" ""_$P($P(BS,""@"",19),"","",3)"
 I k7="" S LineT="@@"_k6_"@@@@"_$G(kt1)_"@1@"_k10_"@@@@@"
 I $ZV["Cach"||($ZV["IRIS") D CLO^%ZAPM.bs.BSCp,OPO^%ZAPM.bs.BSCp
 I $ZV["MSM" S ucI=$$ZU^%ZAPM.bs.BS3(0) D PEREXOD^%ZAPM.bs.BSF12(%NAm)
 F  S %NAm=$$OBD^%ZAPM.bs.BSD1(%NAm) Q:%NAm=""
 I $ZV["MSM" I $$ZU^%ZAPM.bs.BSF4($P(ucI,","),$P(ucI,",",2))
 I $ZV["Cach"||($ZV["IRIS") D CLO^%ZAPM.bs.BSCp,OPO^%ZAPM.bs.BSCp
 I $D(^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15))) D HEA($ZR)
 I $G(%BS("Tmp","AKBD",BSD),"RWD")="RWN"!($G(%BS("Tmp","AKBD",BSD),"RWD")="R") S $P(^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1),"@",3)=""
 S $ZT=$G(%zT) D:'$G(ii3) K3(0) D RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
NAMKE I R1=27!(ny=1)!($D(EXIT)) D LW(key,IMQ) K EXIT,^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S:'$D(%KEYS(key-1)) NAZAD=1 K %KEYS(key-1) S key=key-2 Q
 I ny=2 S li="" D To,NEWKEY0 G:'YES NAMEKEY K ^%ZAPM.bs.BSbufB("0k"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 I k13'="" D MTBD^%ZAPM.bs.BST4 I 'YES S R1=27 G NAMKE
SET S %KEYS(key)=d,%KEYS=key,Tmp=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S Tmp=Tmp_$S(%KEYS(ii)'=+%KEYS(ii):$C(34)_%KEYS(ii)_$C(34),1:%KEYS(ii))_","
 S %BS("Tmp","BSD")=Tmp_$S(d=+d:d,1:$C(34)_d_$C(34))_")"
 Q
 ;---
NEWKEY0 ;НОВЫЙ ИМЕННОЙ КЛЮЧ
 I "RIP"[$G(%BS("Tmp","AKBD",BSD),"RWD") D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` ДАННЫЕ РЕЖИМЫ ЗАПРЕЩЕНЫ !") S li="",YES=0 Q
 S ls=k15,ll="@",li=$G(dat) D 25,LE^%ZAPM.bs.BSTT K dat I 'YES S li="",YES=0 Q
 I "?"[li,k14'="" D KEYTAB,Es G NEWKEY0
 I li="" X "I 0" S YES=0 Q
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BST1" D KEYLOG I 'YES G NEWKEY0
 S li=BSD_li I $D(@li) G NEWK0
 S @li=$G(@BSD,"BSD - MSW@"_$G(BSr)_"@"_$G(BSt)) D CP^%ZAPM.bs.BSGCH(li,$P(%BS(22),",",3)) I $E($P(%BS(22),",",3),2)>1 S ^BSdirddp($S(li[",":li,1:$$DDPGL^%ZAPM.bs.BSD1($$ZU^%ZAPM.bs.BS3(0))_$P(li,"^",2)))=""
NEWK0 S d=$P(li,BSD,2),YES=1,$ZT=$G(%zT) I 1 Q
KEYTAB S IYI=k14 D Key,NE^%ZAPM.bs.BSN S li=$G(dat) Q
Key S v=""  F  S v=$O(%KEYS(v)) Q:v=""  S @("Key"_v)=%KEYS(v)
 Q
K3(k) K ^%ZAPM.bs.BSbufB(k_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3),^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",3) Q
INDKEY ;ИНДЕКСНЫЙ
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР "_$S('$$Tree():"<F3>-ПАРОЛЬ",1:"")_" <F4>-РЕД"_$S('$$Tree():"",1:"АКТИР.УЗЕЛ")_" <F5>-КОПИР <F6>-СЕРВИС "_$S('$$Tree():"<F7>-ТАБ",1:"")_" <F8>-УДАЛ."""
 S kd1=k6["TIME" D K5^%ZAPM.bs.BST4
 S BSR="^%ZAPM.bs.BSbufB",BST=key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15)
 I $D(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"STA")) D STA^%ZAPM.bs.BST G INDKE
 S %IND="",i=3,%NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0)))
 F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)'=+%KEYS(ii):$C(34)_%KEYS(ii)_$C(34),1:%KEYS(ii))_","
 D SW(key,IMQ)
 S %zT=$ZT,$ZT="NOSY^%ZAPM.bs.BST1"
 I $D(@(%NAm_"""@%BS"")")) D PBD^%ZAPM.bs.BST4 S R1=27 G INDKE
 I $D(@(%NAm_"""@PASSWORD"")")) I '$$CHECK^%ZAPM.bs.BSF7($ZR) S R1=27,ny=1 G INDKE
 K ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15)),ii3 I k7'="",$$TAB^%ZAPM.bs.BSD1($ZR,k7) G FoK
 D HEAD($ZR) S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),1,1)="@@1@70@@@@@1@"_$P(%BS,"!",4)_"@@@@@ .. k"_key_" "_%NAm
 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1)="@@"_k6_"@@@@@1@"_k10_"@@@@@ "_$S(k5'="":k5,1:"НОВЫЙ "_key_"-Й ИНДЕКСНЫЙ КЛЮЧ")
 I $G(%BS("Tmp","AKBD",BSD),"RWD")="RWN"!($G(%BS("Tmp","AKBD",BSD),"RWD")="R") S $P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,1),"@",3)=""
NK7 I kt'="" S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3,1)=@$ZR,$P(@$ZR,"@",3)="",$P(@$ZR,"@",8)=0,^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",3,1)=kt,kt1="3,1" D:kd1
 .S @$ZR=@$ZR_" I $P(BS,""@"",19)'="""" S d1=d1_$$KeyTime^%ZAPM.bs.BSsFUNR(BS)"
 I k7="" S LineT="@@"_k6_"@@@@"_$G(kt1)_"@1@"_k10_"@@@@@",^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3,1)=LineT,$P(@$ZR,"@",3)="",$P(@$ZR,"@",8)=0
FoK D Wait^%ZAPM.bs.BSXfun("формирование ключей")
 F  S %IND=$O(@(%NAm_"%IND)")) Q:%IND=""  I %IND'["@" S i=i+1,ii=%IND,^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,1)=LineT_ii_"@@@@"_$G(@(%NAm_"%IND)")),ii3=1 X:'(i#20) $G(WA)
 I $D(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))) D HEA($ZR)
 S $ZT=$G(%zT) D:'$G(ii3) K3(key) D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
INDKE I R1=27!(ny=1)!($D(EXIT)) D LW(key,IMQ) K EXIT,^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S:'$D(%KEYS(key-1)) NAZAD=1 K %KEYS(key-1) S key=key-2 Q
 I ny=2 S li="" D To,NEWKEY1 G:'YES INDKEY K ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 I k13'="" D MTBD^%ZAPM.bs.BST4 G INDKEY:$G(KEYPAS) I 'YES S R1=27 G INDKE
 G SET
NOSY I $ZE["<PROT"!($ZE["<NOUCI")!($ZE["<NOSYS") S ls=" НЕДОСТУПНА БАЗА ДАННЫХ "_BSD G NOS
 S ls=$ZE
NOS D O^%ZAPM.bs.BSF7 S NOKEY=1,$ZT=$G(%zT) Q
To S Date2Lin=d Q
Es I dat=$G(Date2Lin) S dat=""
 Q
NEWKEY1 ;НОВЫЙ ИНДЕКСНЫЙ КЛЮЧ
 I "RIP"[$G(%BS("Tmp","AKBD",BSD),"RWD") D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` ДАННЫЕ РЕЖИМЫ ЗАПРЕЩЕНЫ !") S li="",YES=0 Q
 S ls=k15,ll="@""",li=$G(dat) D 25,LE^%ZAPM.bs.BSTT K dat I 'YES S li="",YES=0 Q
 I "?"[li,k14'="" D KEYTAB,Es G NEWKEY1
 I li="" X "I 0" S YES=0 Q
 S %zT=$ZT,$ZT="ERR^%ZAPM.bs.BST1"
 D KEYLOG G:'YES NEWKEY1
 S $ZT=$G(%zT),d=li Q
25 W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),ls Q
D G 0^%ZAPM.bs.BSTM
HEA(G) S se=i,ke=1,$P(@G,"@",28)=i Q
HEAD(G) N Ui S @G="@@@@@@@1@1@22@80@X MRMR@1@@%FKR^%ZAPM.bs.BST1@1@1",$P(@$ZR,"@",25)=1,$P(@$ZR,"@",28)=i,$P(@$ZR,"@",39)=$S(k20="":"^%ZAPM.bs.BSHLP(KEY_BD",1:k20),se=i,ke=1
 S Ui=$P($$IYI^%ZAPM.bs.BSF10(IMQ),"@",41) I Ui["TreeCopy^%ZAPM.bs.BSF10" Q
 S $P(@G,"@",41)="TreeCopy^%ZAPM.bs.BSF10"_$S(Ui'="":","_Ui,1:"")
 Q
KEYLOG ;ПРОВЕРКА ЛОГИКИ
 S BSr=$P(IMQ,",",1,$L(IMQ,",")-1),BSt=$P(IMQ,",",$L(IMQ,",")) Q:$P(@(BSr_"(BSt,""KEY"",key)"),"@",16)=""  S ls="СИНТАКСИЧЕСКАЯ ОШИБКА",lo=$G(^(key,1)),(d,d0,d1)=li K %0,YES X lo S:'$D(YES) YES=$T S:YES li=$G(%0,li) I 'YES D  D O^%ZAPM.bs.BSF7 Q
 Q
%FKR K EXIT ;F-КЛАВИШИ ДЛЯ КЛЮЧЕЙ БАЗ ДАННЫХ
 S %iii=d I R3=89 D ZF ZT "F10"
 I "RIP"[$G(%BS("Tmp","AKBD",BSD),"RWD") D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` ДАННЫЕ РЕЖИМЫ ЗАПРЕЩЕНЫ !") G D
 I R3=87 G D:ny<3 K %w(3) D  K AllWAY Q:$D(EXIT)  G D ;F8
 .I $G(%BS("Tmp","AKBD",BSD),"RWD")'="RWD" D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` УДАЛЯТЬ УЗЛЫ БАЗЫ ДАННЫХ "_BSD_" НЕЛЬЗЯ !") Q
 .K AllWAY I $D(%DIA) S do="I i>2 S %iii=$P(^(j),""@"",15) I %iii'="""" D DELU^%ZAPM.bs.BST1" D BLOK^%ZAPM.bs.BSF1 Q
 .D DELU Q
 I R3=82,'$$Tree(),'$$PROT() G D:ny<3 D PASS^%ZAPM.bs.BSF7(BSD,.%KEYS) G D ;PASSWORD
 I R3=83,$$Tree() D EDIT^%ZAPM.bs.BSTREE G D ;РЕДАКТИРОВАНИЕ УЗЛА
 I R3=83,'$$PROT() S NOKEY=1,R1=27 Q  ;БЕЗ КЛЮЧЕЙ F4
 I R3=84 G COPY^%ZAPM.bs.BSBD ;SAVE.REST
 I R3=85 G SERV^%ZAPM.bs.BSF5 ;СУММА,КОПИР,ПОИСК,ПЕРЕЗАПИСЬ...
 I R3=86,'$$Tree(),'$$PROT() D TAB^%ZAPM.bs.BST4 Q  ;ПРИКРЕПЛЕННЫЕ ТАБЛИЦЫ
 G D
PROT() I $G(%BS("Tmp","AKBD",BSD),"RWD")'="RWD" D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` ДАННЫЕ РЕЖИМЫ ЗАПРЕЩЕНЫ !") Q 1
 Q 0
Tree() I $G(Bsr)["%BSVOL",$G(Bst)="TREE" Q 1 ;;ДЛЯ РЕДАКТИРОВАНИЯ ^%ZAPM.bs.BSVOL(TREE
 Q 0 ;F5 ДЛЯ РЕДАКТОРА МАССИВОВ
DELU I '$D(%w(3)) D PASDD^%ZAPM.bs.BST1 E  Q
 S %NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:key-1 Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 I key=0 S %NAm=BSD_%iii G DEL
 S %NAm=%NAm_$S(%iii=+%iii:%iii,1:$C(34)_%iii_$C(34))_")"
DEL I '$D(%DIA) S ls=" Удалить :"_%NAm_",Вы уверены ? ",%B=2 D YES^%ZAPM.bs.BSF I 'YES Q
 I $D(%DIA),'$G(AllWAY) D MENU^%ZAPM.bs.BSF5(" УДАЛИТЬ НЕ_УДАЛЯТЬ УДАЛИТЬ_ВСЕ_СРАЗУ ВЫХОД ","  УЗЕЛ "_%NAm_"  ",1) Q:(R1=27&(R2=-1))!(%B=2)  S:%B=3 AllWAY=1 I %B=4 S EndLoop=1 Q
 D L^%ZAPM.bs.BS3(%NAm) D DEL^%ZAPM.bs.BSF10($NA(@%NAm),2) D U^%ZAPM.bs.BS3(%NAm) S EXIT=1 Q
ERR I $ZE["<PROT" S ls=$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)
 D O^%ZAPM.bs.BSF7 X "I 0" S YES=0,$ZT=$G(%zT) Q
BSDvBSB S ls="Формирутся БУФЕР базы данных" D WAITS^%ZAPM.bs.BSF2 d gb
gBuf D %NAm //BD 2 BUF
BSDv K @gBuf
 I $D(Hidd) D Hidd^%ZAPM.bs.BS2
 D FOR^%ZAPM.bs.BSF3 X I_" D BSD" Q
 ;
 ;ЗАПИСЬ В Б.Д.
BSDAT(N,H) S N=$E(N,1,$L(N)-1)_")" I $D(@N@(H))
 Q $T
BSD Q:$P($G(@BSR@(BST,ny,nx)),"@",9)<2  d gb
 I $D(Hid) D  Q
 .Q:$P($P(^(nx),"@",18),"#",2)=""  S nynx=$P($P(^(nx),"@",18),"#",2)
 .Q:'$D(@Hid@(ny))  I $$BSDAT(%NAm,@Hid@(ny)),$G(@$ZR@(nynx))'="" S @gBuf@(ny,nx)=@$ZR
 I $P($P(^(nx),"@",18),"#")'="" S nynx=$P($P(^(nx),"@",18),"#")
 E  S nynx=ny_","_nx
 I $G(@(%NAm_"nynx)"))'="" S @gBuf@(ny,nx)=@$ZR
 Q
gb i '$d(gBuf) S gBuf=$NA(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)))
 q
%NAm S %NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:%KEYS Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 Q
v(N) Q $G(%BS("v",N))
]]></Routine>


<Routine name="%ZAPM.bs.BST132" type="MAC" languagemode="0"><![CDATA[
%BST132 ;ВХОД В ТАБЛИЦУ ; 11:16   03.10.2000
 W $$atr^%ZAPM.bs.BS3(0) //I $ZV'["Cach"&&($ZV'["IRIS") U 0:(0::::#10080)
 I $P($ZV,"Version ",2)<4 W $$clear^%ZAPM.bs.BS3
 K STATUS D SI^%ZAPM.bs.BSN I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 ;N S,STATUS,VYC,BS0,BSX,BSY,B,BX,BY,BS1,BS2,MX,MY,x,t,zr,t1,%VDB,%CAL,%X1,%X2,%Y1,%Y2,%TIT,MR,%w(2),M1,BS,%w(4),%w(5),%DIA,%DI,%ZAP,%FK,i,j,ii,jj,se,ke,j1,j2,j3,MX,MY,M,BS1,BS2,BSF,BSX1,BSX2,BSY1
 ;N BSY2,CLR,ENDLI,BSI,BSII,MR23,MR24,MR25,NAZAD,li,ls,lo,COLOR
 ;N RA,PREDMOV,MxX,MyY,My,Mx,COLOR,EXITout,%FN,%DEV,%Cu,es,ek,h,hi,hl,%INV,%INV1,%INV2,v,vv,vvv,TIP,%FK,%ZAP,%VDB,MOV
 S $ZT="PRO^%ZAPM.bs.BST132"
% K PredOb I '$D(@BSR@(BST))!($$TIP^%ZAPM.bs.BS($P($G(@BSR@(BST)),"@",17))["!!!") S ls="ОБЪЕКТ ~"_BST_" В РАЗДЕЛЕ "_BSR_" НЕ ОПОЗНАН " G STOP
 S $ZT=$G(%zT) I $P(@$ZR,"@",39) Q  ;D Enter^%ZAPM.bs.BSGTab($ZR) Q  ;%BS Gamma Version
 I ($P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_$G(%BS(3),$P)_$J_"i"_$G(%BS(12)))'[$P(@$ZR,"@",30) S ls=" ТАБЛИЦА ЗАНЯТА ПОЛЬЗОВАТЕЛЕМ "_$P(@$ZR,"@",30) D  G STOP
 .D Yes^%ZAPM.bs.BSXfun(" СНИМЕМ ЗАКРЫТИЕ ???",2) I YES D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) I LOC S $P(@BSR@(BST),"@",30)="" D U^%ZAPM.bs.BS3($NA(@BSR@(BST)))
 I BSR'["," S BSR=$$BSR^%ZAPM.bs.BSA(BSR)
 I $P(@$ZR,"@",37) D CHECK^%ZAPM.bs.BSH I 'YES G STOP
 D TIPP I '$D(%w(2)) D PASS^%ZAPM.bs.BST1 E  G END^%ZAPM.bs.BSF
 G DoBSX:TIP=5,DoLINK^%ZAPM.bs.BSF13:TIP=6,DoButt^%ZAPM.bs.BSF8:TIP=8
GOO I $E(%BS(1),20),%BS(12)="" D  H
 .S BSR="^%ZAPM.bs.BSS",BST="LOGON" D ^%ZAPM.bs.BST,Echo^%ZAPM.bs.BSXfun(1) D:d=2 SS^%ZAPM.bs.BSD2 Q:d<0
GO I $D(@(BSR_"(BST,""KEY"")")) D KEY^%ZAPM.bs.BST1:TIP=2,^%ZAPM.bs.BST2:TIP=3!(TIP=4) Q:'$D(F4)
 I '$D(@(BSR_"(BST,""KEY"")")),'$P(B,"@",34) D L^%ZAPM.bs.BS3($NA(@BSR@(BST))) G:'LOC STOP
KEY I '$D(STATUS) S BS0=0,(BSX(BS0),BSY(BS0))=1,(BSX1(BS0),BSY1(BS0))=1,BSX2(BS0)=79,BSY2(BS0)=22
 W $$setkod^%ZAPM.bs.BS3 D LOCK^%ZAPM.bs.BSF4 D TIP
WRITE I $G(@BSR@(BST,"RSM"))'="" D XM^%ZAPM.bs.BSre(@$ZR) ;ВЫПОЛНИТЬ КОМАНДУ ВОССТАНОВЛЕИЯ
 I $D(@BSR@(BST,"FCL")) D CALC^%ZAPM.bs.BSF3
 I $P(@BSR@(BST),"@",47) D CHECKF^%ZAPM.bs.BSF10($P(@BSR@(BST),"@",47)) ;АВТОФОРМАТ
 I $P(@BSR@(BST),"@",24) D UNPRESS^%ZAPM.bs.BSSR I '$P(B,"@",24) G Wr
 I $P(@BSR@(BST),"@",51) D PRESAUTO^%ZAPM.bs.BSSR($P(@BSR@(BST),"@",51)) ;АВТОПОДЖАТИЕ
Wr I $P(B,"@",41)'="" S R1=333 D Pred^%ZAPM.bs.BSF12($P(B,"@",41)) ;ПРЕДОБР.ПОСЛЕ ВЫЧИСЛЕНИЯ
 D TIT
WRI //I $ZV'["Cach"&&($ZV'["IRIS") U 0:(0::::#10080)
 S ls="ЗАГРУЗКА" D WAITS132,W,MR K %VDB S $ZT=$G(%zT) G ^%ZAPM.bs.BST132M
VW D VT,W Q
GW D GT,W Q
TW D VT,GT,W Q
WAITS132 S WA="" Q:$G(TIP)=7&($G(BST)'["@")  Q:$D(%BS)["0"  Q:$G(CALCFON)
 ;U $I:(0::::#10080)
 W /CUP(47,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),$$clr^%ZAPM.bs.BS3(12),"...",$E(ls,1,117),"...",$$atr^%ZAPM.bs.BS3(0)
WAI S WAI=0,WA="S WAI=WAI+1 I '(WAI#2) W $$atr^%ZAPM.bs.BS3(0),/CUP(47,"_($L($E($G(ls),1,117))+7)_"),WAI" W /CUP(148,1),/EL(0)
 Q
W I $G(Mx,0)'=0!($G(My,0)'=0),%BS(13)="%BS-PC",$ZV'["Windows" G ^%ZAPM.bs.BST5
MOV D:'$D(%VDB) CLEA K BS1,BS2,BY,BX S %BSTM=0
 K ENDDN S BSI=BSY(BS0)-1 F  S BSI=$O(@(BSR_"(BST,BSI)")) Q:'BSI  S BS(1)=1 I $P(@(BSR_"(BST,BSI,1)"),"@",3) D  Q:$D(ENDDN)
 .K ENDRI S BSII=BSX(BS0)-1 F  S BSII=$O(@(BSR_"(BST,BSI,BSII)")) Q:BSII=""  D WR I $D(ENDRI)!($D(ENDDN)) S BS(2)=0 Q
e Q
TRANS(BSR,BST,BS,BSI,BSII) N TranS,ny,nx,d,d0 S TranS=1 G TRAN
WR W $$atr^%ZAPM.bs.BS3(0) S CLR=COLOR I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",4)  I '$D(BS1) S BS1=$P(BS,"@")+1,BS2=$P(BS,"@",2)+1 I 'BS0 S (BS(1),BS(2))=1
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+BSY1(BS0))>BSY2(BS0) S ENDDN=1 Q
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+2+BSX1(BS0))>BSX2(BS0) S ENDRI=1 Q
 I $P(BS,"@",10) S CLR=$P(BS,"@",10) I $E(%BS(1),19) S CLR=$P(%BS,"!",$E(%BS(1),19))
 I $P(BS,"@",12) S CLR=$P(%BS,"!",3)
TRAN I $P(BS,"@",9)=1 S (d,d1,d0)=$P(BS,"@",15)
 E  S (d,d1,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSI,BSII))
 I $P(BS,"@",8)'="" S %zT=$ZT,$ZT="FFF^%ZAPM.bs.BST132" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .S ny=BSI,nx=BSII I '$P(BS,"@",8) X $G(@BSR@(BST,"FTR",BSI,BSII)) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 I $D(TranS) Q
w I '$D(%VDB) S l=$J("",$P(BS,"@",3)*$P(BS,"@",4)) F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)>BSY2(BS0)  D  W $E(d1_l,BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))
 .W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0))),$$atr^%ZAPM.bs.BS3(CLR) Q
 Q:BS0  I BS(1) S BY($P(BS,"@")-BS1+1+BSY1(0))=BSI,BS(1)=0
 I BS(2) S BX($P(BS,"@",2)-BS2+1+BSX1(0))=BSII
 Q
VT Q:'$D(%TIT)  S BS0=2,BSY(BS0)=BSY(0) D W S BS0=0 Q
GT Q:'$D(%TIT)  S BS0=1,BSX(BS0)=BSX(0) D W S BS0=0 Q
MR K %FK,%ZAP N i F i=12:1:14 S @("MR"_(i+11))="" I $P(@(BSR_"(BST)"),"@",i)'="" D
 .I $P(^(BST),"@",i)=1 S @("MR"_(i+11))="D MR"_(i+11) Q
 .S @("MR"_(i+11))=$P(^(BST),"@",i)
 K %fk I $P(^(BST),"@",15)'="" S %FK=$P(^(BST),"@",15)
 I $P(^(BST),"@",16) S %ZAP=1
 I TIP=2,$G(%BS("Tmp","AKBD",BSD),"RWD")="R" S %ZAP=1
 Q
TIPP S B=@(BSR_"(BST)") S TIP=$P(B,"@",17) S:TIP="" TIP=1 D ENTERPAS^%ZAPM.bs.BSF7(B) Q
TIP S:'$D(%Co) %Co=0 S B=@(BSR_"(BST)") S:$P(B,"@",3) %DIA=1 S:$P(B,"@",20) %CAL=$P(B,"@",20) S TIP=$P(B,"@",17) S:TIP="" TIP=1 D ENTERPAS^%ZAPM.bs.BSF7(B) S COLOR=$S($E(%BS(1),19):$P(%BS,"!",$E(%BS(1),19)),1:$P(B,"@",31)) I COLOR="" S COLOR=0
 S %Cu=$S($G(TIP)=7:"D KL","1"[$P(B,"@",25):"D KL",1:"D 24") K Ukaz I $P(B,"@",43) S Ukaz=1
 I $P(B,"@",46)'="",'$D(ObOi) D OBWRITE^%ZAPM.bs.BSF10
 S:$G(%BS(15))<1 %BS(15)=0 S se=$P(B,"@",28),ke=$P(B,"@",29) S Mouse=$S(ke=1:1,1:"") I $P(B,"@",38),'$D(RA) S RA=$P(B,"@",38) D Ramka^%ZAPM.bs.BSXfun($P(B,"@",8)-1,$P(B,"@",9)-1,$P(B,"@",10)+1,$P(B,"@",11)+1,RA,COLOR,1)
 S POSt=%BS(16) I $P(B,"@",44)'="" S POSt=$P(B,"@",44)
 I $P(B,"@",41)'="" S PredOb=$P(B,"@",41)
 I $D(BSR) D PST^%ZAPM.bs.BSD1(BSR)
 I TIP=2,$D(BSD),$G(%BS("Tmp","AKBD",BSD),"RWD")="R" S %ZAP=1
 Q
TIT I $P(@(BSR_"(BST)"),"@",19) S %TIT=$P(^(BST),"@",19) K:'$D(@(BSR_"(BST,"_%TIT_")")) %TIT
 E  K %TIT
 I $D(@BSR@(BST)) D  ;
 .I '$D(%TIT) S BS0=0,BSY1(0)=$P(^(BST),"@",8),BSX1(0)=$P(^(BST),"@",9),BSY2(0)=$P(^(BST),"@",10),BSX2(0)=$P(^(BST),"@",11) D:$E($G(%BS(14)),2) TRM Q
 .S BS0=0,BSY2(BS0)=+$P(^(BST),"@",10),BSX2(BS0)=+$P(^(BST),"@",11) D  S BSY1(BS0)=$P(@(BSR_"(BST,"_%TIT_")"),"@")+BSY1(0)-1,BSX1(BS0)=$P(@$ZR,"@",2)+BSX1(0)-1 I $G(STATUS)'=BST S BSY(0)=+$P(%TIT,","),BSX(0)=+$P(%TIT,",",2),STATUS=BST
 ..S BSY1(0)=+$P(^(BST),"@",8),BSX1(0)=+$P(^(BST),"@",9)
 .S BS0=1,(BSY1(3),BSY1(BS0))=+$P($G(@(BSR_"(BST)"),1),"@",8),BSX1(BS0)=BSX1(0),(BSY2(3),BSY2(BS0))=BSY1(0)-1,BSX2(BS0)=+$P(^(BST),"@",11)
 .S BS0=2,BSY1(BS0)=BSY1(0),(BSX1(3),BSX1(BS0))=+$P(^(BST),"@",9),BSY2(BS0)=+$P(^(BST),"@",10),(BSX2(3),BSX2(BS0))=BSX1(0)-1
 .S (BSY(3),BSX(3),BSY(1),BSX(2))=1,BSY(2)=BSY(0),BSX(1)=BSX(0),BS0=3 D:$E($G(%BS(14)),2) TRM D W S BS0=1 D W S BS0=2 D W S BS0=0
 Q
TRM I TIP'=7 F i=0,1,2 D
 .I $D(BSX2(i)),BSX2(i)>64,ke'=1 S BSX2(i)=64
 .I $D(BSY2(i)),BSY2(i)>21 S BSY2(i)=21
 Q
FFF W $$bel^%ZAPM.bs.BS3 I $ZE["<NOPGM" S @$ZR=""
 S $ZT=$G(%zT) G w
CLEA I TIP=7 S ColrMenu=$S($P(B,"@",31)="":"1;6;30;47",1:$P(B,"@",31)) D  K BFL,% Q
 .I $D(^%ZAPM.bs.BSR(2,1)) D
 ..W /ED(2),/CUP(1,1) W $$atr^%ZAPM.bs.BS3(ColrMenu)
 ..I $E($G(%BS(14)),6)=3 D  Q  ;ДЛЯ АРМ-ТЕРМ
 ...F i=1:1:48 W /CUP(i,1),$E($TR(^(i),"x",""),1,132-(i=48))
 ..F i=1:1:48 W /CUP(i,1),$E($TR(^(i),"x",""),1,132)
 .W /CUP(47,3) W:%BS(13)["%BS-PC" $$atr^%ZAPM.bs.BS3(ColrMenu) W ^%ZAPM.bs.BS(26),/CUP(4,3+((77-$L($P(B,"@")))\2)),$P(B,"@")
 .D MENU
 I '($D(ObOi)!($D(RA))) D
 .I $G(%BS(14)),((BSY1(BS0)<3&(BSX1(BS0)<3))!($E(BST,1,2)="fT")) W /CUP(BSY1(BS0),BSX1(BS0)),$C(27),"[0J" Q
 .W $$atr^%ZAPM.bs.BS3(0) F i=BSY1(BS0):1:BSY2(BS0) W /CUP(i,BSX1(BS0)),$J("",BSX2(BS0)-BSX1(BS0)+1)
 Q
MENUU() ;ТИТУЛ МЕНЮ
 I $G(%BS(38))="" Q $E($ZV,1,28)
 Q $E("Работает: "_$G(%BS(38)),1,28)
MENU I '$D(ColrMenu) G UNDOMENU^%ZAPM.bs.BSF11
 W $$atr^%ZAPM.bs.BS3(ColrMenu),/CUP(2,3),$$MENUU()," ",$$WEEKEND^%ZAPM.bs.BSsFUNR(1,$$h^%ZAPM.bs.BS3())," ",$$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3())," %BS Version ",+^%ZAPM.bs.BS," " Q
RAM(Y1,X1,Y2,X2,RA,COLOR) W $$atr^%ZAPM.bs.BS3(COLOR) S ii=$S(RA=1!(RA=""):"-----|",RA=2:"=====|",RA=" ":"      ",1:"§§§§§§")
 W /CUP(Y1,X1),$E(ii,1),$TR($J("",X2-X1-1)," ",$E(ii,2)),$E(ii,3)
 F i=Y1+1:1:Y2-1 W /CUP(i,X1),$E(ii,6),$J("",X2-X1-1),$E(ii,6)
 W /CUP(Y2,X1),$E(ii,4),$TR($J("",X2-X1-1)," ",$E(ii,2)),$E(ii,5) Q
P I $ZE'["<PRO" S ls=$ZE D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT) Q
 S $ZT=$G(%zT) G GO
STOP D O^%ZAPM.bs.BSF7 S d="",R1=27,ny=1 G END^%ZAPM.bs.BSF
PRO S ls=$$ErrSay^%ZAPM.bs.BSF8($ZE) G STOP
STA ;ВОССТАНОВЛЕНИЕ ПО "STATUS ME"
 S $ZT="PRO^%ZAPM.bs.BST132"
 G %:'$D(@(BSR_"(BST,""STA"")")) S S=^("STA"),STATUS=BST,zr=$ZR
 S BS0=0,BSX(BS0)=$P(S,"@",3),BSY(BS0)=$P(S,"@",2),MX=$P(S,"@",8),MY=$P(S,"@",7) I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 G %
DoBSX D L^%ZAPM.bs.BS3($NA(@BSR@(BST))),^%ZAPM.bs.BSX("TEXT",BSR,BST),U^%ZAPM.bs.BS3($NA(@BSR@(BST))),U^%ZAPM.bs.BS3($NA(@BSR@("@"_BST))) q
IN(%w) ;ВХОД ПО ПОЛНОЙ ССЫЛКЕ ИЗ BSN
]]></Routine>


<Routine name="%ZAPM.bs.BST132M" type="MAC" languagemode="0"><![CDATA[
%BST132M ;ДВИЖЕНИЕ МАРКЕРА ПО ТАБЛИЦЕ ; 11:45   12.11.2001
B D TIP^%ZAPM.bs.BST132,KLE I $D(END) D R^%ZAPM.bs.BSF G 1000^%ZAPM.bs.BSF
 S MR=1 D CL^%ZAPM.bs.BSF4
0 I $D(EXITout) G END^%ZAPM.bs.BSF
  D W W $$atr^%ZAPM.bs.BS3(0) X $G(MR23),$G(MR24),$G(MR25),$G(%Cu)
1 F  R *R:0 E  Q
 I $D(Refresh) D W^%ZAPM.bs.BST132 K Refresh D W
 W $$rt^%ZAPM.bs.BS3(+%BS(2)) I $D(PredOb) D Pred^%ZAPM.bs.BSF12(PredOb) I R1<0 G 0:R1=-2,END^%ZAPM.bs.BSF:R1=-3,LE:R1=-4
2 I R1=27 K % D  G:$G(%FK,1)'=1&(R2=79) @%FK G 101:'$G(%FK)&(R2=R3),0:$G(%,27)=27,^%ZAPM.bs.BSF
 .K %HO,%EN I R2=91 D  Q
 ..I $D(Ukaz) D UKA^%ZAPM.bs.BSF8 Q
 ..I R3=67 S m=MX,M1=$O(BX(MX)),MR=0 D WO D:M1=""  S MX=M1,MR=1 S:m=MX&(ke=1) MY=$O(BY(""),-1) Q  ;-->
 ...S M1=MX I $O(@(BSR_"(BST,ny,nx)"))'="" S BSX(BS0)=BSX(BS0)+1,Mx=$O(BX($O(BX("")))),MXx=BX(MX) D GW^%ZAPM.bs.BST132 S M1=$O(BX(""),-1),Mx=0 K MXx
 ..I R3=68 I nx=$P($G(%TIT,"1,1"),",",2),'$D(%TIT),ke=1  S MR=0 D WO S MR=1,MY=$O(BY("")) Q
 ..I R3=68 Q:nx=$P($G(%TIT,"1,1"),",",2)  S M1=$O(BX(MX),-1),MR=0 D WO D:M1=""  S MR=1,MX=M1 Q
 ...I $P(B,"@",24) D PgLt^%ZAPM.bs.BSF9 S M1=MX Q  ;!!!!!!!!
 ...S BSX(BS0)=BSX(BS0)-1,Mx=-1 D GW^%ZAPM.bs.BST132 S Mx=0,M1=$O(BX("")) Q
 ..I R3=66 S M1=$O(BY(MY)),MR=0 D WO D:M1=""  S MY=M1,MR=1 Q
 ...S M1=MY I $O(@(BSR_"(BST,ny)")) S BSY(BS0)=BSY(BS0)+1,My=$O(BY($O(BY("")))),MYy=BY(MY) D VW^%ZAPM.bs.BST132 S M1=$O(BY(""),-1),My=0 K MYy I '$D(BX(MX)) S M2=MX,MX=$O(BX(MX)) I MX="" S MX=$O(BX(M2),-1)
 ..I R3=65 Q:ny=$P($G(%TIT,1),",")  S M1=$O(BY(MY),-1),MR=0 D WO D:M1=""  S MR=1,MY=M1 Q
 ...I $P(B,"@",24) D PgUp^%ZAPM.bs.BSF9 S M1=MY Q  ;!!!!
 ...S BSY(BS0)=BSY(BS0)-1,R1=1,My=-1 D VW^%ZAPM.bs.BST132 S My=0,M1=$O(BY("")) I M1="" S ls=" СРОЧНО СДЕЛАЙТЕ РЕМОНТ ТАБЛИЦЕ !!! F6 " D O^%ZAPM.bs.BSF7
 ...I '$D(BX(MX)) S M2=MX,MX=$O(BX(MX)) I MX="" S MX=$O(BX(M2),-1)
F1 .I R2=79,(R3=80) S IYI=$P(BS,"@",20) S:IYI=""!(IYI["##") IYI=$P(B,"@",39) S:IYI="" IYI="^%ZAPM.bs.BSHLP,%BS-PC" D NE^%ZAPM.bs.BSN Q
 .I R2=79!(R2=-1) Q:'$G(%FK)  S:R3=-1 R3=89 D  Q  ;F-клавиши
 ..I R3>79&(R3<90) S %B=R3-79,OOO="^%ZAPM.bs.BS",OO=1 D  D:'$D(%DIA) DARK^%ZAPM.bs.BSF6 W /CUP(47,1) D ^%ZAPM.bs.BSB W /CUP(48,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) D CL^%ZAPM.bs.BSF4 W /CUP(47,1) S %=R1 K Dark Q
 ...S Dark(1,1)=" 0 0 0 0 0 0 0 0" N z
 ...I $E(%BS(1),17)=2 D DF6 F z=3,4,5 S $P(Dark(1,1)," ",z+1)="1"
 ...I $E(%BS(1),17)=3 D DF6 F z=3,4,5,8 S $P(Dark(1,1)," ",z+1)="1"
 ...I $E(%BS(1),9)=3 S $P(Dark(1,1)," ",3)="1"
 I R1=9 D TAB^%ZAPM.bs.BST5 G 0
 I R1=12,R2=-1 D SSS^%ZAPM.bs.BSF12 G 0
 I R1=0,R2=15 D STAB^%ZAPM.bs.BST5 G 0
 I R1=0,R2=18 S li=d G LE
 I R1=0,R2=33 D  G 1
 .I '$D(%fk) S (%fk,%FK)=1 Q
 .K %fk S %FK=$P(@BSR@(BST),"@",15) K:%FK="" %FK
SF1 I R1=0,(R2=139!(R2=140)!(R2=84)!(R2=88)) D AltKey^%ZAPM.bs.BSF8 G 0
 I R1=0,R3=-1,("85/86/87"[R2),$L(R2)=2 D Shift^%ZAPM.bs.BSF8(R2) G 0 ;F2,3,4 ЮЗЕРСКИЕ
 I R1=0,R2=31 S LineEdit=1,li=d G LE
 I R1=0,R2=46 G 0:BST'["@" D OUT^%ZAPM.bs.BSS1 G 0
 I R1=0,"48,47,20"[R2,R2?2N D CON I  G E11^%ZAPM.bs.BSF1:R2=48,E161^%ZAPM.bs.BSF1:R2=47,E21^%ZAPM.bs.BSF1:R2=20
 I R1=0,R2=38 G E141^%ZAPM.bs.BSF1:BST["@",LOS^%ZAPM.bs.BSF6:$D(^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u"_%BS(15))) D CON G 1
 I R1=0,R2=109 D BUF^%ZAPM.bs.BSF3 G 0
 I R1=0,R2=24 G ^%ZAPM.bs.BSS
 I R1=0,R2=21 G FIDD^%ZAPM.bs.BSS ;ПОИСК ПО БАЗЕ ДАННЫХ
 I R1=0,R2=25 S fi=nx G FIND^%ZAPM.bs.BSS
 I R1=0,R2=110 S fi=nx_",DFLT,0,1,1" G FIND^%ZAPM.bs.BSS
 I R1=0,R2=90 G ShiftF7^%ZAPM.bs.BSS
 I R1=0,R2=131 D CALK^%ZAPM.bs.BSSR G:YES LE G 0
 I R1=0,R2=113,$E(%BS(1),3),'$E($G(%BS(14)),4) D CM^%ZAPM.bs.BSF6 G 0
 I R1=0,R2=105 K %GO D DOAF2^%ZAPM.bs.BSN G:$D(%GO) @%GO G 0
 I R1=0,R2=44,BST["@" G 42^%ZAPM.bs.BSF
INS I R1=0,R2=82 D  S %DIA=1,$P(@(BSR_"(BST)"),"@",3)=1,$P(@(BSR_"(BST,ny,nx)"),"@",12)=$S($P(BS,"@",12):"",1:1) G:'%BS(5) 0 S BS=@$ZR,MR=0 D WO S MR=1,R1=27,R2=91,R3=$S(%BS(5)=1:66,%BS(5)=2:67,1:R3) G 2
 .S %DIA=$$GetLock^%ZAPM.bs.BSXfun(),$E(%DIA)=($E(%DIA)=0) D SetLock^%ZAPM.bs.BSXfun(%DIA)
 I R1=0,R2=162 D I^%ZAPM.bs.BSGLOB(BSR,BST,ny,nx,d) S R2=82 G INS
 I R1=0 D  G 0
 .I R2=71 S %HO=$S('$D(%HO):1,%HO=1:2,%HO=2:3,1:1) D  ;HOME
 ..I $D(Ukaz),%HO<3 D HO^%ZAPM.bs.BSF8 Q
 ..I %HO=1 S MX=$O(BX("")) S MR=0 D WO S MR=1 Q
 ..I %HO=2 S MR=0 D WO S MY=$O(BY("")),MX=$O(BX("")),MR=1 Q
 ..I %HO=3 S BSY(BS0)=$P($G(%TIT,1),","),BSX(BS0)=$P($G(%TIT,"1,1"),",",2) D TW^%ZAPM.bs.BST132,KLE Q
 .I R2=79 S %EN=$S('$D(%EN):1,%EN=1:2,%EN=2:3,1:1) D  ;END
 ..I $D(Ukaz),%EN<3 D EN^%ZAPM.bs.BSF8 Q
 ..I %EN=1 D DNX S MR=0 D WO S MR=1,MX=M1 Q
 ..I %EN=2 D DNY S MR=0 D WO S MR=1,MY=M1 Q
 ..I %EN=3 D REND^%ZAPM.bs.BSF2,DEND^%ZAPM.bs.BSF2,END^%ZAPM.bs.BS1 S BSY(BS0)=es,BSX(BS0)=ek D TW^%ZAPM.bs.BST132,KLE Q
 .I R2=132!(R2=22) S BSY(BS0)=$P($G(%TIT,1),",") D TW^%ZAPM.bs.BST132,KLE Q
 .I R2=118!(R2=49) D DEND^%ZAPM.bs.BSF2,ENDS^%ZAPM.bs.BS1 S BSY(BS0)=es D TW^%ZAPM.bs.BST132,KLE Q
 .I R2=73!(R2=152)!(R2=23) D PgUp^%ZAPM.bs.BSF9 Q
 .I R2=81!(R2=160)!(R2=50) S t1=BSY(BS0) D DNY S BSY(BS0)=BY(M1) Q:t1=BSY(BS0)  D VW^%ZAPM.bs.BST132,KLE Q  ;PgDn
 .I R2=157!(R2=37)!(R2=116) S t1=BSX(BS0) D DNX S BSX(BS0)=BX(M1) Q:t1=BSX(BS0)  D GW^%ZAPM.bs.BST132,KLE Q  ;->
 .I R2=155!(R2=36)!(R2=115) D PgLt^%ZAPM.bs.BSF9 Q
 I R1=13,$P(BS,"@",14)'="" S l4=14 D NEW^%ZAPM.bs.BSN K l4 G:'(R1'=27&(li'="")) 0 W $$atr^%ZAPM.bs.BS3(0) D W G 1:$D(%ZAP),1:$P(BS,"@",5)=1 I 1 D:'$D(%w(5)) PASD^%ZAPM.bs.BST1 G 1:'$T S YES=1 G LEE
 I R1=13,'$G(%FK) G 101
 I R1=-1,%BS(13)="%BS-PC" G 0 ;D GLUC^%ZAPM.bs.BSXgluc G 0
 I R1=43 G 0 ;,PL^%ZAPM.bs.BSF5
 I R1=45 G 0 ;,MI^%ZAPM.bs.BSF5
 I R1=127,(R2=R3) G 1:$D(%ZAP),1:$P(BS,"@",5)=1 D  G 0
 .I '$D(%w(5)) D PASD^%ZAPM.bs.BST1 E  Q
 .D Yes^%ZAPM.bs.BSXfun("Удаляем данные клетки {"_ny_","_nx_"} ?") Q:YES<1
 .D R^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))) I LOC D MED^%ZAPM.bs.BSF S i=ny,j=nx I $D(@BSR@(BST,ny,nx)) D DEL^%ZAPM.bs.BSF1,D^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))) D:$D(%CAL) CALC^%ZAPM.bs.BSF3
 G:R1<32 1 S li=$C(R1) I $P(B,"@",40)'="" S fi=$P(B,"@",40),finl=li G FIND^%ZAPM.bs.BSS
LE G 1:$D(%ZAP) I $P(BS,"@",5)=1 S ls=" Ввод Запрещен " D WAITS^%ZAPM.bs.BSF2 W $$bel^%ZAPM.bs.BS3 G 1
 I '$D(%w(5)) D PASD^%ZAPM.bs.BST1 E  G 1
 I $P(BS,"@",21) D BAR^%ZAPM.bs.BSF7(+$P(BS,"@",21),$P($P(BS,"@",21),",",2)) G LEE
 I $P(B,"@",26)["," D BAR^%ZAPM.bs.BSF7(+$P(B,"@",26),$P($P(B,"@",26),",",2)) G LEE
 I $P(B,"@",26)!($D(LineEdit)) S ls="Коppектиpуете значение клетки",lon=$S($P(BS,"@",9)=1:200,1:509) D HIS^%ZAPM.bs.BSF1("DAT"),LE^%ZAPM.bs.BSTT X "I 1" K LineEdit
 E  S li=$$Edit^%ZAPM.bs.BSXuse(li,($P(BS,"@")+1-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0)),($P(BS,"@")-BS1+BSY1(BS0)+$P(BS,"@",3)),($P(BS,"@",2)-BS2+BSX1(BS0)+$P(BS,"@",4)),"@")
LEE G:'YES 0 I li'="" K R1 D  G M:$D(R1),LE
 .I $P(BS,"@",16)'="" K %0 S %zT=$ZT,$ZT="ERRTR^%ZAPM.bs.BST132M",YES=1,(d,d0)=li K ls D  S:YES li=$G(%0,li) I 'YES S ls=$G(ls,"СИНТАКСИЧЕСКАЯ ОШИБКА ") D O^%ZAPM.bs.BSF7 K R1 Q
 ..I '$P(BS,"@",16) X $G(@BSR@(BST,"RTR",ny,nx)) S $ZT=$G(%zT) Q
 ..X $G(@(BSR_"(BST,""RTR"","_$P(BS,"@",16)_")")) S $ZT=$G(%zT)
 .I li["@" S ls=" Запрещенный Символ @ " D O^%ZAPM.bs.BSF7 Q
 .D SetCell(ny,nx,li) D:$D(%CAL) CALC^%ZAPM.bs.BSF3 S R1=1 Q
 G 0
SetCell(ny,nx,li) 
 I $P(BS,"@",9)=1 D L^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))),MED^%ZAPM.bs.BSF D  D U^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))) Q
 .S $P(@(BSR_"(BST,ny,nx)"),"@",15)=li
 E  S $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1,^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx)=li Q
 Q
M G:'POSt 0 S MR=0,BS=@BSR@(BST,BY(MY),BX(MX))
 D WO S MR=1,R1=27,R2=91,R3=$S(POSt=1:66,POSt=2:67,1:R3) G 2
W S BS=@(BSR_"(BST,"_BY(MY)_","_BX(MX)_")")
WO S ny=BY(MY),nx=BX(MX)
WG S CLR=$S($P(BS,"@",10):$P(BS,"@",10),1:COLOR) I $E(%BS(1),19) S CLR=$P(%BS,"!",$E(%BS(1),19))
 I $P(BS,"@",12) S CLR=$P(%BS,"!",3)
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx))
 I $P(BS,"@",8)'="" S %zT=$ZT,$ZT="FTRe^%ZAPM.bs.BST132M" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"",ny,nx)")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
w W $$atr^%ZAPM.bs.BS3($S('MR:CLR,1:$P(%BS,"!",$S($P(BS,"@",12):1,1:2))))
 S l=$P(BS,"@",3)*$P(BS,"@",4) F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)>BSY2(BS0)  D  W $E(d1_$J("",l),BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))
 .W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0)))
 W $$atr^%ZAPM.bs.BS3($S(MR:CLR,1:$P(%BS,"!",2))) Q
DNX S M1=$O(BX(""),-1) Q
24 W /CUP(47,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) Q
25 W /CUP(48,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) Q
KL W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0))),$$atr^%ZAPM.bs.BS3(0) Q
DNY S M1=$O(BY(""),-1) Q
DF6 N z F z=2:1:7,10 S $P(Dark(1,1,6)," ",z+1)="1"
 Q
CON Q:BST["@"  S ls=" УСТАНОВИТЕ РЕЖИМ КОРРЕКЦИИ ОПИСАНИЯ ТАБЛИЦЫ <F4> " G O^%ZAPM.bs.BSF7
MR23 W /CUP(46,1),/EL(0) W:$P(BS,"@",7)'="" "ВЫЧ" W:$P(BS,"@",8)'="" /CUP(46,5),"ТРАН" W:$P(BS,"@",6)'="" /CUP(46,10),"d",$P(BS,"@",6) W /CUP(46,14),$S($P(BS,"@",9)=1:"О.Т",1:"Б.Д") W:$P(BS,"@",5)=1 /CUP(46,19),"ЗАПР"
 W /CUP(46,24),$P(BS,"@",3),"x",$P(BS,"@",4) W:$P(BS,"@",13)'="" /CUP(46,30),"ЛОГ=",$S($P(BS,"@",11)=1:"НЕ",1:"ДА") W:$P(BS,"@",16)'="" /CUP(46,37),"СИНТ" W:$P(BS,"@",14)'="" /CUP(46,42),$S($P(BS,"@",14)?.N1",".N:"КОМ",1:"ТАБ")
 W:$P(BS,"@",17)'="" /CUP(46,46),"ДВЖ" W:$D(%DIA) /CUP(46,51),"Бл" W:$P(BS,"@",12) /CUP(46,52),"Л" W:$P($P(BS,"@",18),"#")'="" /CUP(46,54),$P($P(BS,"@",18),"#")
 W:$P($P(BS,"@",18),"#",2)'="" /CUP(46,58),"""",$P($P(BS,"@",18),"#",2),"""" W:$P(B,"@",24) /CUP(46,61),"ПОДЖ"
 W:$P(BS,"@",20)'="" /CUP(46,66),"F1" Q
MR24 D 24,RED W " {",ny,",",nx,"}" D 25 W $E(d,1,77) W:$E(d,77)'="" "..." Q
RED W:BST["@" $$atr^%ZAPM.bs.BS3("1;36;47")," РЕД ",$$atr^%ZAPM.bs.BS3(0) Q
MR25 D 24,RED W $E($$SS^%ZAPM.bs.BSF12(),1,132) D 25 W $E(d,1,132)_$ZN Q
ERRTR S ls=$ZE D O^%ZAPM.bs.BSF7 Q
FTRe S $ZT=$G(%zT) W $$bel^%ZAPM.bs.BS3 G w
101 S MR=0 D WO W $$atr^%ZAPM.bs.BS3(0) G 10^%ZAPM.bs.BSF
KLE K END S R1=27,%BSTM=1 D:TIP'=7 24 I '$D(MY) S MY=$O(BY("")) D:MY=""  Q:$D(END)  S MX=$O(BX("")) D:MX=""  Q:MX=""
 .S ls=" !!! ПУСТАЯ ТАБЛИЦА !!!"_$S($G(%TIT):",ИЛИ КОНФЛИКТ ТИТУЛА И ВЫСОТЫ СТРОК",1:"") D O^%ZAPM.bs.BSF7 S END=1
 I '$D(BY(MY))!('$D(BX(MX))) K MY,MX G KLE
 I $D(Ukaz) S Na=1 D TA^%ZAPM.bs.BSF8
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BST2" type="MAC" languagemode="0"><![CDATA[
%BST2 ;КЛЮЧИ И ЗАПРОСЫ СПИСКОВ И СВОДОК ; 16:37   11.09.2000
 S Bsr=BSR,Bst=BST D KCHO^%ZAPM.bs.BSsFUNM K %DIA,CALCFONs
 I $P($G(@(BSR_"(BST,""KEY"")")),"@",2)="" S ls=" НЕТ КЛЮЧЕЙ ",YES=0 D O^%ZAPM.bs.BSF7 G NO
 S (BSdd,zr)=@$ZR,YES=1,%zT=$ZT,$ZT="ERRNO^%ZAPM.bs.BST2" F I=1:1 Q:$P(zr,"!",I)=""  S BSt=$P($P(zr,"!",I),"@",2),BSr=$P(BSt,",",1,$L(BSt,",")-1),BSt=$P(BSt,",",$L(BSt,",")) D  G:'YES NO
 .I '$D(@(BSr_"(BSt,""KEY"")")) S ls=" НЕТ КЛЮЧЕЙ,или недоступна "_BSr_","_BSt_" ",YES=0 D O^%ZAPM.bs.BSF7
 I TIP=3,'$D(@(BSR_"(BST,""TSP"")")) S ls=" СПИСОК НЕ ПРОШЕЛ ТРАНСЛЯЦИЮ ",YES=0 D O^%ZAPM.bs.BSF7
 S $ZT=$G(%zT) I TIP=4,'$D(@(BSR_"(BST,""TSV"")")) S ls=" СВОДКА НЕ ПРОШЛА ТРАНСЛЯЦИЮ ",YES=0 D O^%ZAPM.bs.BSF7
NO I 'YES D KEY^%ZAPM.bs.BST K @(BSR_"(BST,""STA"")") G TEND
 S IMQ=$$BSR^%ZAPM.bs.BSA(BSR)_","_BST,TIp=TIP,Ii=$P(B,"@") K F4
TS ;ВЫБОР
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР <СТРЕЛКИ>-ДВИЖЕНИЕ <Esc>-ОТМЕНА <F4>-БЕЗ КЛЮЧА <F8>-УДАЛИТЬ """
 S (%OLDII,%TAB)=$$TNAME^%ZAPM.bs.BSF13(BSR,BST)_".",%nAM=$$cB^%ZAPM.bs.BSSV,BSR="^%ZAPM.bs.BSbufB",BST="TS"_$G(%BS(3),$P)_$J_"u"_%BS(15) I $D(^%ZAPM.bs.BSbufB("TS"_$G(%BS(3),$P)_$J_"u"_%BS(15),"STA")) D STA^%ZAPM.bs.BST G TSBE
 K ^%ZAPM.bs.BSbufB("TS"_$G(%BS(3),$P)_$J_"u"_%BS(15)),NOKEY,CALCFON,OLDT,SRAVN
 S i=3,TS=$ZR
 S @TS@(2,1)="@@0@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$$F^%ZAPM.bs.BSF11(IMQ)
 S @TS@(3,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ ЗАПРОСОВ="_$$ZCount(IMQ)
 ;            MSW          !
 S @TS@(1,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$$H^%ZAPM.bs.BSF11(IMQ)_" ;"_Ii
 S i=4,@TS@(4,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ НАСЧЕТ НА (MSM-DDP) СЕРВЕРЕ"
 I $ZV["Cach"||($ZV["IRIS") S $P(@TS@(2,1),"@",3)=0,$P(@TS@(4,1),"@",3)=0
 F  S %TAB=$O(@(%nAM_"(%TAB)")) Q:%TAB=""  Q:%TAB'[%OLDII  I %TAB'["@"&(%TAB'["&") S i=i+1 D
 .S @TS@(i,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_$P(%TAB,"!",3)_$J("",13-$L($P(%TAB,"!",3)))_$S($P(@(%nAM_"(%TAB)"),"@",30)="":".....",1:$E($P(@$ZR,"@",30),1,5))_";LOCKAL;"_$P(@$ZR,"@")
 I IMQ["]" D R^%ZAPM.bs.BSF11(IMQ)
 S @TS="@@@@@@@1@1@22@80@@X MRMR@@%FKT^%ZAPM.bs.BST2@1@1",se=i,ke=1,$P(@$ZR,"@",41)="F8DEL^%ZAPM.bs.BST2"
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST I $D(END) G TEND
TSBE I R1=27,$D(NOKEY) S BSR=$P(IMQ,",",1,$L(IMQ,",")-1),BST=$P(IMQ,",",$L(IMQ,",")) D KEY^%ZAPM.bs.BST K @(BSR_"(BST,""STA"")") G TS
 I R1=27 G TEND
 I ny=3 D ZP^%ZAPM.bs.BSZPS S R1=27 G TEND
 I d'[";LOCKAL;",d'[";REMOTE;" S:ny=2 CALCFON=1 S:ny=4 CALCFON=2 D KEY S R1=27 G TEND
 I d[";LOCKAL;" S BSR=%nAM,BST=$P(%OLDII,"!",1,2)_"!"_$P(d," ",2)
 I d[";REMOTE;" S BSR=UU,BST=$P(%OLDII,"!",1)_"!1!"_$P(d," ",2)
 I $P($P(@(BSR_"(BST)"),"@"),";",2)'["ГОТОВ" S ls=" ВОЙТИ НЕЛЬЗЯ..." D O^%ZAPM.bs.BSF7 G TEND
 I $D(@(BSR_"(BST,""STA"")")) D STA^%ZAPM.bs.BST G TEND
 D ^%ZAPM.bs.BST
TEND K ^%ZAPM.bs.BSbufB("TS"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S SPSV=1 G ZF^%ZAPM.bs.BST1
 ;
KEY L ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15)) ;ДЛЯ ВЫБОРКИ ПРИ НАСЧЕТЕ
 K NOKEY,%KEYS,NAZAD,^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15)) F key=0:1:13 I $D(@(BSr_"(BSt,""KEY"",key)")) S endkey=key
 F key=0:1:endkey K ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 F key=0:1:endkey I $D(@(BSr_"(BSt,""KEY"",key)")) D KE G:$D(NAZAD)&('$D(NOKEY)) END^%ZAPM.bs.BSF I key=endkey!($D(NOKEY)) D SPSVD G END^%ZAPM.bs.BSF:$D(CALCFONs)!('$D(key)) S key=key-1 I $D(NOKEY) S BSR=$P(IMQ,",",1,$L(IMQ,",")-1),BST=$P(IMQ,",",$L(IMQ,",")) G KEY^%ZAPM.bs.BST Q
 Q
F8DEL ;ПРЕДОБРАБОТКА ДЛЯ СПИСКА ОТЧЕТОВ
 I $E(%BS(1),17),R1=127 S R1=27,R2=79,R3=87
 Q
SPSVD I TIp=4 S %B=2,ls=" Определим еще один уровень СРАВНЕНИЯ " D YES^%ZAPM.bs.BSF I YES S key=0,COMP=COMP+1,SRAVN=+$G(CALCFON,$G(SRAVN)) K CALCFON Q
 I '$D(NOKEY) S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15))=IMQ_"##"_BSdd_"####"_COMP I '$D(OTLUP) G ^%ZAPM.bs.BSSP:TIp=3  G ^%ZAPM.bs.BSSV
e Q
KE ;ОПРЕДЕЛЕНИЕ КЛЮЧА
 N KMAX,KK,KML,zr
 F i=1,2,4,5,6,9,10,12,13,15,16 S @("k"_i)=$P(^(key),"@",i)
 K KK S zr=$ZR,KK=0 F i=10:1 Q:'$D(^(key,i))  S KK(i)=^(i),KK(i,1)=^(i,1) S:KK<$L(KK(i)) KK=$L(KK(i)) I @zr
 I '$D(Report),$D(@Bsr@(Bst,"Key",key)) D  ;СПЕЦИАЛЬНАЯ ВЫБОРКА
 .F i=1,2,4,5,6,9,10,12,13,15,16 I $P(^(key),"@",i)'="" S @("k"_i)=$P(^(key),"@",i)
 .S zr=$ZR,KMAX=0,KML=$O(^(key,""),-1) I @zr
 .F i=10:1:KML I $D(^(key,i)) S KK(i)=^(i),KK(i,1)=^(i,1) S:KMAX<$L(KK(i)) KMAX=$L(KK(i)) I @zr
 S KMAX=$S($G(KK)>$G(KMAX):$G(KK),1:$G(KMAX)),MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),"" <Enter>-ВЫБОР <СТРЕЛКИ>-ДВИЖЕНИЕ <Esc>-ОТМЕНА ,Можете корректировать ВЫБОРКУ """
 S II="KCH"_$S(key=0:0,1:1) I '$D(COMP) S COMP=1
 S l=$S($P(^%ZAPM.bs.BSS(II,1,2),"@",4)<$G(KMAX,0):KMAX,1:$P(@$ZR,"@",4)),BSr1="^%ZAPM.bs.BSS",BSt1=II
 I l>45 S l=45
 S (BSr2,BSR)="^%ZAPM.bs.BSbufB",(BSt2,BST)=key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15) D COPY^%ZAPM.bs.BSTK
 F i=1:1:$S(key:4,1:3) D  S $P(@$ZR,"@",4)=l
 .F j=1,3,2 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=^%ZAPM.bs.BSS(II,i,j) D
 ..I i=3,j=3 S $P(@$ZR,"@",15)=k1 ;```$S($$LASTHIS^%ZAPM.bs.BSF11(key,i):$$INSERT^%ZAPM.bs.BSF11(key,i),1:k1)
 ..I i=4,j=3 S $P(@$ZR,"@",15)=k4 ;```$S($$LASTHIS^%ZAPM.bs.BSF11(key,i):$$INSERT^%ZAPM.bs.BSF11(key,i),1:k4)
 I $D(^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,1)) S II=$S(@$ZR=""&(k1'=""):k1,1:@$ZR) S $P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3,3),"@",15)=II
 I key,$D(^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,2)) S II=$S(@$ZR=""&(k4'=""):k4,1:@$ZR) S $P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),4,3),"@",15)=II
 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,3)=$P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,3),"@",1,14)_"@"_$S(TIp=3:"",1:"Ср:"_COMP)_" Кл:"_key_"                              "_k9
 I $D(KK) S i=4 F ii=10:1 Q:'$D(KK(ii))  S i=i+1 D  S $P(@$ZR,"@",15)=KK(ii),$P(@$ZR,"@",4)=l,$P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,3),"@",15)=" <---",^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i,3)=KK(ii,1)
 .F j=1,3,2 S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),2,j),$P(@$ZR,"@",3)=1,$P(@$ZR,"@",15)=""
 K KK S ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15))=^%ZAPM.bs.BSS("KCH1")
 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
NAMKE I R1=27 K ^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key) D:'$D(%KNAM(key-1))  S key=key-2 Q
 .S NAZAD=1 K ZPNEW,^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15)),COMP,CALCFON,%KNAM,II
SET S %KNAM(key)=k6,^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,1)=$P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),3,3),"@",15),^(4)=k2_"#"_k12 Q:'key
 S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,2)=$P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),4,3),"@",15)
 I ny>4 S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,3)=$G(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",ny,3),"I 1") S ^%ZAPM.bs.BSbufB("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15),COMP,key,4)="TXTC#"_$P(^%ZAPM.bs.BSbufB(key_"k"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,2),"@",15) I d'=" <---" D SETEMP^%ZAPM.bs.BSF11
 Q
25 W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0),ls Q
D G 0^%ZAPM.bs.BSTM
ERR D O^%ZAPM.bs.BSF7 X "I 0" S YES=0 Q
ERRNO I $ZE["<PROT"!($ZE["<NOSYS")!($ZE["<NOUCI")!($ZE["<NAMESPACE") S ls=" НЕТ КЛЮЧЕЙ,или недоступна "_BSr_","_BSt_" " G RNO
 S ls=$ZE
RNO D O^%ZAPM.bs.BSF7 X "I 0" S YES=0,$ZT=$G(%zT) G NO
%FKT D R^%ZAPM.bs.BSF I R3=89 ZT "F10"
 I R3=83 S NOKEY=1,R1=27 Q  ;БЕЗ КЛЮЧЕЙ F4
 I R3=87 K AllWAY D DEL^%ZAPM.bs.BSF11 Q:R1=27  ;УДАЛИТЬ ТАБЛИЦУ
%F4 G D
OLD S ls=" НОВОЙ СВОДКОЙ ЗАМЕСТИМ СТАРУЮ ? " D YES^%ZAPM.bs.BSF S:YES OLDT=1 Q
v(N) Q $G(%BS("v",N))
ZCount(IMQ) //ПОСЧИТАТЬ СКОЛЬКО ЗАПРОСОВ
 N I,II,BSR,BST S I="",II=0,BSR=$P(IMQ,",",1,$L(IMQ,",")-1),BST=$P(IMQ,",",$L(IMQ,","))
 F  S I=$O(@BSR@(BST,"ZPr",I)) Q:I=""  S II=II+1
 Q II
]]></Routine>


<Routine name="%ZAPM.bs.BST3" type="MAC" languagemode="0"><![CDATA[
%BST3 ;ТРАНСЛЯЦИЯ СПИСКОВЫХ И СВОДКОВЫХ ФУНКЦИЙ ; 14:22   10.12.1999
TEST S YES=1,(s,k)=1 D REND^%ZAPM.bs.BSF2,DEND^%ZAPM.bs.BSF2,EN G SV:TIP=4
 S ls="СПИСКА" D S D OP^%ZAPM.bs.BSF4 K ^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15))
 K BSr,BSt,@(BSR_"(BST,""TSP"")"),jjk,ii,DUBLTSP
 F i=1:1:se F j=1:1:ke I $D(@(BSR_"(BST,""FCL"",i,j)")),@$ZR["$$TSP" S ^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=@$ZR D
 .I @$ZR["$$TSP(" D
 ..I $D(ii) S DUBLTSP=i_","_j Q
 ..S ii=i,jj=j
 .I '$D(ip),@$ZR["$$TSPPI(" S ip=i,jp=j
 .I '$D(jjk),@$ZR["$$TSPN(" S jjk=j
 I '$D(ii) S $P(@(BSR_"(BST)"),"@",17)=1 G END
 I $D(DUBLTSP) S ls=" ГЛАВНАЯ ФУНКЦИЯ СПИСКА $$TSP ДУБЛИРУЕТСЯ В клетке {"_DUBLTSP_"} !!! " G N
 I '$D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),ii,jj)) S ls=" Не ОПРЕДЕЛЕНА ГЛАВНАЯ ФУНКЦИЯ СПИСКА $$TSP !!! " G N
 S i0=@$ZR,jj1=0 K @$ZR D P,CR
 S BSt=$P(ii1,",",$L(ii1,",")),BSr=$P(ii1,",",1,$L(ii1,",")-1),%zT=$ZT,$ZT="ER^%ZAPM.bs.BST3" S:BSr'["^" BSr="^"_BSr I BSr[$C(34) S BSr=$$TR^%ZAPM.bs.BSsFUNM(BSr,$C(34)_$C(34),$C(34))
 I '$D(@(BSr_"(BSt)")) S ls=" Не Определена или НЕ доступна  "_BSr_","_BSt_" " G N
 I $P(@(BSr_"(BSt)"),"@",17)'=2 S ls=BSr_","_BSt_" ЭТО НЕ ТАБЛИЦА ОПИСАНИЯ БАЗЫ ДАННЫХ " G N
 S BSD=$$KBD^%ZAPM.bs.BSF12($NA(@BSr@(BSt))) I '$$Data^%ZAPM.bs.BSF12(BSD) S ls=" НЕ ОПРЕДЕЛЕНА или не доступна БАЗА ДАННЫХ:"_BSD_" из "_BSr_","_BSt_" !!! " G N
 S @(BSR_"(BST,""KEY"")")=$$BSR^%ZAPM.bs.BSA(BSD)_"@"_$$BSR^%ZAPM.bs.BSA(BSr)_","_BSt,TTT=0,BSr(1)=BSr,BSt(1)=BSt ;```ЕСТЬ ЗАВИСИМОСТЬ ОТ ТОГО, КТО ГЕНЕРИТ СПИСОК
 S @(BSR_"(BST,""TSP"",1)")=BSD,$ZT=$G(%zT) G:'$D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ii2)) NPL S ii="",ii=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ii2,ii)) G:ii="" NPL S @(BSR_"(BST,""TSP"",3,1)")=ii1,^(2)=ii2,^(3)=ii3,^(4)=ii4,^(5)=$G(jjk)
 S:ii5'="" @(BSR_"(BST,""TSP"",0)")=ii5 I +ii2,+$P(@(BSR_"(BST)"),"@",19),(ii2>+$P(@$ZR,"@",19)) S ls=" ОПУСТИТЕ ТИТУЛ НИЖЕ !!! " G N
 S j1="",m1="",ij2=ii2,j5="",jj1=1 F i=ii:1:ke I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ij2,i))["$$TSPL" S i0=@$ZR K @$ZR D CHK G EN:'YES S:ii5["1" j1=j1_i_"," S:ii5["2" m1=m1_i_"," S @(BSR_"(BST,""TSP"",4,i)")=j3
 D GLSET^%ZAPM.bs.BSF12($NA(@(BSR_"(BST,""TSP"",4)")),$E(j1,1,$L(j1)-1)) ;ЗАГИБАТЬ ПО ДАННЫМ
 I m1'="" S @(BSR_"(BST,""TSP"",7)")=$E(m1,1,$L(m1)-1) ;ЗАГИБАТЬ ПО ТРАНС
 S i="",j1="",j2=1,jj1=0 F  S i=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  I $G(^(j))["$$TSPGL" S i0=@$ZR K @$ZR D CHK G EN:'YES S @(BSR_"(BST,""TSP"",2,j2)")=$P(j3,",%2="),j2=j2+1
 S @(BSR_"(BST,""TSP"",2)")=j2-1 I $D(ip) S i0=^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),ip,jp) K @$ZR D P,CR S @(BSR_"(BST,""TSP"",6,1)")=ii1,^(2)=ii2,^(3)=ii3,^(4)=ii4
 G END
EN K @(BSR_"(BST,""KEY"")"),^("TSV")
END K ^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15)),i,j,ii,ii1,ii2,ii3,ii4,ii6,ii5,iii1,iii2,KOLB,i0,j1,m1,j2,j3,j4,j5,i2,i1,i3,i4,i5,i6,i7,jj1,jj2,jj3,DUBLTSP
 Q
S S ls="ТРАНСЛЯЦИЯ ФОРМУЛ "_ls D WAITS^%ZAPM.bs.BSF2 Q
CR F i=1:1:6 I $E(@("ii"_i),1)=$C(34)&($E(@("ii"_i),$L(@("ii"_i)))=$C(34)) S @("ii"_i)=$E(@("ii"_i),2,$L(@("ii"_i))-1)
 Q
SV S ls="СВОДКИ" D S
 K BSr,BSt,@(BSR_"(BST,""TSV"")"),jjk,jjs,jju,ii,id F i=1:1:se F j=1:1:ke I $D(@(BSR_"(BST,""FCL"",i,j)")),@$ZR["$$TSV" S ^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=@$ZR D
 .I '$D(ii),@$ZR["$$TSV(" S ii=i,jj=j
 .I '$D(id),@$ZR["$$TSVD(" S id=i,jd=j ;МИКРОЗАПРОСЫ
 .I '$D(jjk),@$ZR["$$TSVV(" S jjk=j ;ВЕРТИКАЛЬ ЛОГИКИ НА БОКОВИНУ
 .;!!!!!!I '$D(jju),@$ZR["$$TSVU(" S jju=i_","_j ;УНИВЕРСАЛЬНЫЕ
 .I '$D(jjs),@$ZR["$$TSVL(" S jjs=i ;ГОРИЗОНТАЛЬ ЛОГИКИ НА ШАПКУ
 I '$D(ii) S $P(@(BSR_"(BST)"),"@",17)=1 G END
 I '$D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),$G(ii,0),$G(jj,0))) S ls=" Не ОПРЕДЕЛЕНА ГЛАВНАЯ ФУНКЦИЯ СВОДКИ $$TSV !!! " G N
 I $D(id)&($D(jjk)) S ls=" ФУНКЦИИ $$TSVV и $TSVD НЕ СОВМЕСТИМЫ !!! " G N
 S i0=@$ZR,jj1=0 K @$ZR D P F i=1:1:6 I $E(@("ii"_i),1)=$C(34)&($E(@("ii"_i),$L(@("ii"_i)))=$C(34)) S @("ii"_i)=$E(@("ii"_i),2,$L(@("ii"_i))-1)
 S iii1=ii1,YES=1,iii2="" 
 F i=2:1 Q:$P(iii1,"^",i)=""  S ii1="^"_$P(iii1,"^",i),BSt=$P(ii1,",",$L(ii1,",")),BSr=$P(ii1,",",1,$L(ii1,",")-1),%zT=$ZT,$ZT="ER^%ZAPM.bs.BST3" D  S $ZT=$G(%zT) G END:'YES
 .S:BSr'["^" BSr="^"_BSr //S BSr=$$BSR^%ZAPM.bs.BSA(BSr) 
 .I BSr[$C(34) S BSr=$$TR^%ZAPM.bs.BSsFUNM(BSr,$C(34)_$C(34),$C(34))
 .I '$D(@(BSr_"(BSt)")) S ls=" Не Определена ИЛИ НЕ ДОСТУПНА "_BSr_","_BSt_" " G N
 .I $P(@(BSr_"(BSt)"),"@",17)'=2 S ls=" "_BSr_","_BSt_" НЕ БАЗА ДАННЫХ !!! " G N
 .S BSD=$$KBD^%ZAPM.bs.BSF12($NA(@BSr@(BSt))),BSD=$$BSR^%ZAPM.bs.BSA(BSD) I '$D(@BSD) S ls=" НЕ ОПРЕДЕЛЕНА БАЗА ДАННЫХ:"_BSD_" У "_BSr_","_BSt_" !!! " G N
 .S iii2=iii2_BSD_"@"_BSr_","_BSt_"!",BSr(i-1)=BSr,BSt(i-1)=BSt
 I i=2 S ls=" В $$TSV БАЗА ДАННЫХ НЕ ОПРЕДЕЛЕНА " G N
 S @(BSR_"(BST,""KEY"")")=iii2,KOLB=i-2,TTT=1
 S @(BSR_"(BST,""TSV"",1)")=KOLB,$ZT=$G(%zT) I +ii2 G:+ii2'=$G(jjs) NPV S ii="",ii=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ii2,ii)) G:ii="" NPV S @(BSR_"(BST,""TSV"",1,1)")=+ii2 I ii2=1 S ls=" ФУНКЦИИ $$TSVL ДОЛЖНЫ НАХОДИТСЯ НИЖЕ ШАПКИ " G N
 I ii4'="" S @(BSR_"(BST,""TSV"",0)")=ii4 ;ЗАГОЛОВОК
 I +ii3 G:+ii3'=$G(jjk,$G(jd)) NPV S @(BSR_"(BST,""TSV"",1,2)")=+ii3
 I +ii5 S @(BSR_"(BST,""TSV"",1,7)")=ii5 ;НОМЕРА СРАВНЕНИЯ
 S ij3=ii3,ij2=ii2 I +ii3 S j5="",jj1=2 F i=1:1:se I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,ij3))["$$TSVV" S i00=@$ZR K @$ZR F n=1:1:$L(i00,"$$TSVV")-1 S i0="$$TSVV"_$P(i00,"$$TSVV",n+1) K im1 D CHK G:'YES EN D
 .S @(BSR_"(BST,""TSV"",5,ii6,i)")="X ""I "_$S($E(im1,1)=$C(34)&($E(im1,$L(im1))=$C(34)):$E(im1,2,$L(im1)-1),1:im1)_""""_j3 K im1
 ;```        ```I +ij2 S j5="",jj1=1 F k=1:1:ke I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ij2,k))["$$TSVL" S i00=@$ZR K @$ZR F n=1:1:$L(i00,"$$TSVL")-1 S i0="$$TSVL"_$P(i00,"$$TSVL",n+1) D CHK G:'YES EN S @(BSR_"(BST,""TSV"",4,ii6,k)")=j3
 ;I +ij2 S j5="",jj1=1 F k=1:1:ke I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ij2,k))["$$TSVL" S i00=@$ZR K @$ZR X "I "_i00 G:'YES EN S @(BSR_"(BST,""TSV"",4,1,k)")=j3
 I +ij2 S j5="",jj1=1 F k=1:1:ke I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ij2,k))["$$TSVL" S i00=@$ZR K @$ZR F n=1:1:$L(i00,"$$TSVL")-1 S i0="$$TSVL"_$P(i00,"$$TSVL",n+1) D CHK G:'YES EN S @(BSR_"(BST,""TSV"",4,ii6,k)")=$$t(j3)
 I $D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),$G(id,0),$G(jd,0))) D TS^%ZAPM.bs.BSF11 I 'ls G N ;ДИНАМИЧЕСКАЯ БОКОВИНА
 I $D(jju) S @(BSR_"(BST,""TSV"",1,4)")=jju
 S i="",j1="",j2=1,jj1=1
 ;```!!!!!!!!F  S i=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  I $G(^(j))["$$TSVU" S i0=@$ZR K @$ZR D CHK G:'YES EN S @(BSR_"(BST,""TSV"",3,ii6,i,j)")=j3
 S i="",j1="",jj1=0
 F  S i=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  I $G(^(j))["$$TSVGL" S i0=@$ZR K @$ZR D CHK G EN:'YES S @(BSR_"(BST,""TSV"",2,1,$G(j2(ii6),1))")=$P(j3,",%2="),j2(ii6)=$G(j2(ii6),1) ;!!!,1,->,ii6,
 G END
t(I) Q:ii4'=1 I
 I ii5=1 S I="D CY(1)" Q I
 Q "D CY("_$$TR^%ZAPM.bs.BSsFUNM($E(ii1,2,$L(ii1)-1),$C(34)_$C(34),$C(34))_")"
CHK X WA S YES=1,j3="" D P Q:'YES  S ii6=+ii6 I TTT,ii6>KOLB!(ii6<1) S:jj1=2 ii6=0 I jj1=1 S ls=" НЕ КОРРЕКТНЫЙ НОМЕР БАЗЫ ДАННЫХ В $$TSVL в клетке{"_ij2_","_k_"} " G N
 Q:'YES  S j3=" S ",jj2="" D:jj1  Q:j3=""  F j4=1:1:5 S j3=j3_$S(jj1=2:"q",1:"%")_j4_$S(@("ii"_j4)[$C(34):("="_@("ii"_j4)_","),1:("="""_@("ii"_j4)_""","))
 .I jj1=2 S im1=ii1,ii1=ii2,ii2=ii3,ii3=ii4,ii4=ii5,ii5="" S:$L(im1)<3 im1="1" I ii1'["," S j3="" Q
 .I $L(ii4)<2 S ii4=1
 .S jj2="CYC"_$S(ii2["~":4,ii2="":1,+ii2:3,1:2) I $D(im1) S jj2="CY3"
 .I jj2["3" D
 ..F  Q:ii4'["""""s"  S ii4=$P(ii4,"""""s")_$C(34,34,221,222,223,224)_$P(ii4,"""""s",2,99)
 ..F  Q:ii4'[",k"  S ii4=$P(ii4,",k")_$C(44,231,232,233,234)_$P(ii4,",k",2,99)
 .I $L(ii4)>2&(jj2'["3") S jj2=" X ""I ""_%4 I  D "_jj2 Q
 .S jj2=" D "_jj2
 S j3=$E(j3,1,$L(j3)-1)_jj2 Q
N D O^%ZAPM.bs.BSF7 S YES=0 G EN
NPL S ls=" НЕ ОПРЕДЕЛЕНО ТЕЛО ЦИКЛА СПИСКА В СТРОКЕ "_+ii2 G N
NPV S ls=" НЕ ПРАВИЛЬНО ОПРЕДЕЛЕНЫ СТРОКА И КОЛОНКА Ф.$$TSVV,$$TSVL В $$TSV " G N
P S i1=i0,i5=$P($P(i1,"$$",2,255),"(")
 I '$D(^%ZAPM.bs.BSFUN(i5)) S ls=" ФУНКЦИЯ "_i5_" НЕ ОПРЕДЕЛЕНА !!!" G N
 S pr=$G(^%ZAPM.bs.BSFUN(i5,"9,4"))_"!"_$G(^%ZAPM.bs.BSFUN(i5,"11,4")),i2=$P($P(i1,"$$",2,9999),"(",2,9999)
 S i2=$P($P(i1,"$$",2,9999),"(",2,9999)
 S z=$E($P(i1,"$$"),$L($P(i1,"$$")))
 S i4=1 F i3=1:1:$L(i2) S:$E(i2,i3)="(" i4=i4+1 S:$E(i2,i3)=")" i4=i4-1 Q:$E(i2,i3)=")"&(i4=0)
 S i2=$E(i2,1,i3-1)_",",(ii1,ii2,ii3,ii4,ii5,ii6)="" I $P(pr,"!")=1 S ii1=$E(i2,1,$L(i2)-1),i3=1 G FF
 E  S i7=1 F i3=1:1:+$P(pr,"!") D  S @("ii"_i3)=$E(i2,i7,i6-1),i7=i6+1 D FF
 .S (h5,i5,i4)=0 F i6=i7:1:$L(i2) Q:$E(i2,i6)=""  S:$E(i2,i6)="{" h5=h5+1 S:$E(i2,i6)="}" h5=h5-1 S:$E(i2,i6)=$C(34) i5=i5+1 S:$E(i2,i6)="Ї" i4=i4+1 S:$E(i2,i6)="ї" i4=i4-1 Q:$E(i2,i6)=","&(i4=0)&('(i5#2))&(h5=0)
 Q
FF  F  Q:@("ii"_i3)'["{"  D  S @("ii"_i3)=$P(@("ii"_i3),"{")_"$G(^("_$C(34,34)_hh_$C(34,34)_"))"_$P(@("ii"_i3),"}",2,99)
 .I '$G(ii6) S ii6=1
 .S hi=$P($P(@("ii"_i3),"{",2),"}") I hi'["-",hi'["+",$P($P($G(@(BSr(ii6)_"(BSt(ii6),"_hi_")")),"@",18),"#")'="" S hh=$P($P($G(@$ZR),"@",18),"#") Q
 .E  S hh=hi
 I @("ii"_i3)["$$" S ggg=@("ii"_i3) D  S:YES @("ii"_i3)=ggg
 .D SI^%ZAPM.bs.BSN N (%BS,vl,%zT,%KAT,%File,ggg,YES) S i0=ggg D FUN^%ZAPM.bs.BSFT S ggg=i0 Q
e Q
F ;ЗАМЕНА "{}" НА "Її" ДЛЯ ФУНКЦИИЙ ТИПА SUM,MAX,MIN...
 S i4=1 F i3=1:1:$L(i2) Q:$E(i2,i3)=""  S:$E(i2,i3)="(" i4=i4+1 S:$E(i2,i3)=")" i4=i4-1 Q:$E(i2,i3)=")"&(i4=0)
 S i1=$P(i1,"$$")_"$$"_$P($P(i1,"$$",2),"(")_"("_$TR($E(i2,1,i3),"{}","Її")_$E(i2,i3+1,9999) Q
ER I $ZE["INDER" S ls=" Ошибка В имени ТАБЛИЦЫ "_BSr_","_BSt G N
 I $ZE["NOSYS>"!($ZE["NOUCI>")!($ZE["<NAMESPACE") S ls=" НЕДОСТУПНА БАЗА ДАННЫХ "_BSD G N
 S ls=$ZE G N
]]></Routine>


<Routine name="%ZAPM.bs.BST3F" type="MAC" languagemode="0"><![CDATA[
%BST3F ;FAST - ТРАНСЛЯЦИЯ СПИСКОВЫХ И СВОДКОВЫХ ФУНКЦИЙ ; 11:29   07.06.99
TEST 
 N i,j,ii,ii1,ii2,ii3,ii4,ii6,ii5,iii1,iii2,KOLB,i0,j1,j2,j3,j4,j5,i2,i1,i3,i4
 N i5,i6,i7,jj1,jj2,jj3,jjk,jp,p
 N s,k,b,BSr,BSt,Par,BSd
 S YES=1,(s,k)=1 D REND^%ZAPM.bs.BSF2,DEND^%ZAPM.bs.BSF2,EN G SV:TIP=10
 S ls="СПИСКА" D S D OP^%ZAPM.bs.BSF4
 K jjk,ii F i=1:1:se F j=1:1:ke I $D(@BSR@(BST,"FCL",i,j)),@$ZR["$$FCl" S @b@(i,j)=@$ZR D
 .I '$D(ii),@$ZR["$$FCl^" S ii=i,jj=j
 .;!!!!I '$D(ip),@$ZR["$$TSPPI(" S ip=i,jp=j
 .I '$D(jjk),@$ZR["$$FCln^" S jjk=j
 I '$D(ii) S $P(@(BSR_"(BST)"),"@",17)=1 G NOSP
 I '$D(@b@(ii,jj)) G NOSP
 S i0=@$ZR K @$ZR X i0 S ls="ОШИБКИ $$TCl !!! "
 F p=1:1 Q:$P(Pa(1),"\",i)=""  S li=$P(Pa(1),"\",i) D RIT^%ZAPM.bs.BSF3,BSD(BSr,BSt) I 'YES G N
 D x^%ZAPM.bs.BS3("!%BST3F!")     ;---//--- для msm 4.x.x
 S ls="КОНЕЦ"
 G N ;!!!!!!
 ;
 S @(BSR_"(BST,""TSP"",1)")=BSD,$ZT=$G(%zT) G:'$D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ii2)) NPL S ii="",ii=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ii2,ii)) G:ii="" NPL S @(BSR_"(BST,""TSP"",3,1)")=ii1,^(2)=ii2,^(3)=ii3,^(4)=ii4,^(5)=$G(jjk)
 S:ii5'="" @(BSR_"(BST,""TSP"",0)")=ii5 I +ii2,+$P(@(BSR_"(BST)"),"@",19),(ii2>+$P(@$ZR,"@",19)) S ls=" ОПУСТИТЕ ТИТУЛ НИЖЕ !!! " G N
 S j1="",ij2=ii2,j5="",jj1=1 F i=ii:1:ke I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ij2,i))["$$TSPL" S i0=@$ZR K @$ZR D CHK G EN:'YES S:ii5'="" j1=j1_i_"," S @(BSR_"(BST,""TSP"",4,i)")=j3
 D GLSET^%ZAPM.bs.BSF12($NA(@(BSR_"(BST,""TSP"",4)")),$E(j1,1,$L(j1)-1)) ;ЗАГИБАТЬ ПО ДАННЫМ
 S i="",j1="",j2=1,jj1=0 F  S i=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  I $G(^(j))["$$TSPGL" S i0=@$ZR K @$ZR D CHK G EN:'YES S @(BSR_"(BST,""TSP"",2,j2)")=$P(j3,",%2="),j2=j2+1
 S @(BSR_"(BST,""TSP"",2)")=j2-1 I $D(ip) S i0=^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),ip,jp) K @$ZR D P,CR S @(BSR_"(BST,""TSP"",6,1)")=ii1,^(2)=ii2,^(3)=ii3,^(4)=ii4
 G END
BSD(BSr,BSt) ;АНАЛИЗ ТАБЛИЦ
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BST3F" S:BSr'["^" BSr="^"_BSr I '$D(@(BSr_"(BSt)")) S ls=" Не Определена или НЕ доступна  "_BSr_","_BSt_" ",YES=0 Q
 I $P(@(BSr_"(BSt)"),"@",17)'=2 S ls=BSr_","_BSt_" НЕ БАЗА ДАННЫХ ",YES=0 Q
 S BSD=$P(@(BSr_"(BSt,""KEY"")"),"@") I '$D(@BSD) S ls=" НЕ ОПРЕДЕЛЕНА БАЗА ДАННЫХ У "_BSr_","_BSt_" !!! ",YES=0 Q
 S @(BSR_"(BST,""KEY"")")=$$BSR^%ZAPM.bs.BSA(BSD)_"@"_$$BSR^%ZAPM.bs.BSA(BSr)_","_BSt,TTT=0,BSr(p)=BSr,BSt(p)=BSt,BSd(p)=BSD,YES=1 Q
 Q
EN K @(BSR_"(BST,""KEY"")"),^("TSV"),^("TSP")
END K ^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15)) S b=$ZR Q
S S ls="ТРАНСЛЯЦИЯ ФОРМУЛ "_ls D WAITS^%ZAPM.bs.BSF2 Q
NOSP S ls=" Не ОПРЕДЕЛЕНА ГЛАВНАЯ ФУНКЦИЯ СПИСКА $$FCl !!! "
N D O^%ZAPM.bs.BSF7 S YES=0 G EN
NPL S ls=" НЕ ОПРЕДЕЛЕНО ТЕЛО ЦИКЛА СПИСКА В СТРОКЕ "_+ii2 G N
NPV S ls=" НЕ ПРАВИЛЬНО ОПРЕДЕЛЕНЫ СТРОКА И КОЛОНКА Ф.$$FCsk,$$FCss В $$FCs " G N
 ;
SV S ls="СВОДКИ" D S
 K BSr,BSt,@(BSR_"(BST,""TSV"")"),jjk,jjs,jju,ii,id F i=1:1:se F j=1:1:ke I $D(@(BSR_"(BST,""FCL"",i,j)")),@$ZR["$$TSV" S ^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=@$ZR D
 .I '$D(ii),@$ZR["$$TSV(" S ii=i,jj=j
 .I '$D(id),@$ZR["$$TSVD(" S id=i,jd=j
 .I '$D(jjk),@$ZR["$$TSVV(" S jjk=j ;ВЕРТИКАЛЬ ЛОГИКИ НА БОКОВИНУ
 .;!!!!!!I '$D(jju),@$ZR["$$TSVU(" S jju=i_","_j
 .I '$D(jjs),@$ZR["$$TSVL(" S jjs=i ;ГОРИЗОНТАЛЬ ЛОГИКИ НА ШАПКУ
 I '$D(ii) S $P(@(BSR_"(BST)"),"@",17)=1 G END
 I '$D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),$G(ii,0),$G(jj,0))) S ls=" Не ОПРЕДЕЛЕНА ГЛАВНАЯ ФУНКЦИЯ СВОДКИ $$TSV !!! " G N
 S i0=@$ZR,jj1=0 K @$ZR D P F i=1:1:6 I $E(@("ii"_i),1)=$C(34)&($E(@("ii"_i),$L(@("ii"_i)))=$C(34)) S @("ii"_i)=$E(@("ii"_i),2,$L(@("ii"_i))-1)
 S iii1=ii1,YES=1,iii2="" F i=2:1 Q:$P(iii1,"^",i)=""  S ii1="^"_$P(iii1,"^",i),BSt=$P(ii1,",",$L(ii1,",")),BSr=$P(ii1,",",1,$L(ii1,",")-1),%zT=$ZT,$ZT="ER^%ZAPM.bs.BST3F" S:BSr'["^" BSr="^"_BSr S BSr=$$BSR^%ZAPM.bs.BSA(BSr) D  S $ZT=$G(%zT) G END:'YES
 .I '$D(@(BSr_"(BSt)")) S ls=" Не Определена ИЛИ НЕ ДОСТУПНА "_BSr_","_BSt_" " G N
 .I $P(@(BSr_"(BSt)"),"@",17)'=2 S ls=" "_BSr_","_BSt_" НЕ БАЗА ДАННЫХ !!! " G N
 .S BSD=$P(@(BSr_"(BSt,""KEY"")"),"@"),BSD=$$BSR^%ZAPM.bs.BSA(BSD) I '$D(@BSD) S ls=" НЕ ОПРЕДЕЛЕНА БАЗА ДАННЫХ У "_BSr_","_BSt_" !!! " G N
 .S iii2=iii2_BSD_"@"_BSr_","_BSt_"!",BSr(i-1)=BSr,BSt(i-1)=BSt
 I i=2 S ls=" В $$TSV БАЗА ДАННЫХ НЕ ОПРЕДЕЛЕНА " G N
 S @(BSR_"(BST,""KEY"")")=iii2,KOLB=i-2,TTT=1
 S @(BSR_"(BST,""TSV"",1)")=KOLB,$ZT=$G(%zT) I +ii2 G:+ii2'=$G(jjs) NPV S ii="",ii=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ii2,ii)) G:ii="" NPV S @(BSR_"(BST,""TSV"",1,1)")=+ii2 I ii2=1 S ls=" ФУНКЦИИ $$TSVL ДОЛЖНЫ НАХОДИТСЯ НИЖЕ ШАПКИ " G N
 I ii4'="" S @(BSR_"(BST,""TSV"",0)")=ii4 ;ЗАГОЛОВОК
 I +ii3 G:+ii3'=$G(jjk) NPV S @(BSR_"(BST,""TSV"",1,2)")=+ii3
 I +ii5 S @(BSR_"(BST,""TSV"",1,7)")=+ii5 ;НОМЕРА СРАВНЕНИЯ
 S ij3=ii3,ij2=ii2 I +ii3 S j5="",jj1=2 F i=1:1:se I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,ij3))["$$TSVV" S i00=@$ZR K @$ZR F n=1:1:$L(i00,"$$TSVV")-1 S i0="$$TSVV"_$P(i00,"$$TSVV",n+1) K im1 D CHK G:'YES EN D
 .S @(BSR_"(BST,""TSV"",5,ii6,i)")="X ""I "_$S($E(im1,1)=$C(34)&($E(im1,$L(im1))=$C(34)):$E(im1,2,$L(im1)-1),1:im1)_""""_j3 K im1
 I +ij2 S j5="",jj1=1 F k=1:1:ke I $G(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),+ij2,k))["$$TSVL" S i00=@$ZR K @$ZR F n=1:1:$L(i00,"$$TSVL")-1 S i0="$$TSVL"_$P(i00,"$$TSVL",n+1) D CHK G:'YES EN S @(BSR_"(BST,""TSV"",4,ii6,k)")=j3
 I $D(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),$G(id,0),$G(jd,0))) S @(BSR_"(BST,""TSV"",1,3)")=id ;ДИНАМИЧЕСКАЯ БОКОВИНА
 I $D(jju) S @(BSR_"(BST,""TSV"",1,4)")=jju
 S i="",j1="",j2=1,jj1=1
 ;!!!!!!!!F  S i=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  I $G(^(j))["$$TSVU" S i0=@$ZR K @$ZR D CHK G:'YES EN S @(BSR_"(BST,""TSV"",3,ii6,i,j)")=j3
 S i="",j1="",jj1=0
 F  S i=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i)) Q:i=""  S j="" F  S j=$O(^%ZAPM.bs.BSbufB("F"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)) Q:j=""  I $G(^(j))["$$TSVGL" S i0=@$ZR K @$ZR D CHK G EN:'YES S @(BSR_"(BST,""TSV"",2,ii6,$G(j2(ii6),1))")=$P(j3,",%2="),j2(ii6)=$G(j2(ii6),1)
 G END
e Q
ER S ls="" I $ZE["INDER" S ls=" Ошибка В имени ТАБЛИЦЫ "_BSr_","_BSt
 I $ZE["NOSYS>"!($ZE["NOUCI>")!($ZE["<NAMESPACE") S ls=" НЕДОСТУПНА БАЗА ДАННЫХ "
 S ls=ls_$ZE_$$ErrMsg^%ZAPM.bs.BSF8($ZE) G N
]]></Routine>


<Routine name="%ZAPM.bs.BST4" type="MAC" languagemode="0"><![CDATA[
%BST4 ;ПРИКРЕПЛЕННЫЕ ТАБЛИЦЫ К БАЗЕ ДАННЫХ;MTBD;KEYPAS ; 18:56   09.06.99
MTBD S $ZT="ErrMT^%ZAPM.bs.BST4",YES=1,li=$$GLOBAL^%ZAPM.bs.BSF9(IMQ) I $G(@li@("KEY",key,5))'["$MTBD^" Q
 ;!!!S MaS=$$TR^%ZAPM.bs.BSsFUNM("^"_$P($P(@$ZR,"^",2),$C(34)_")"),$C(34)_$C(34),$C(34)) I MaS="^" S ls=" МАССИВ для MTBD НЕ ОПРЕДЕЛЕН " G O
 X "S MaS="_$P(@$ZR,"I ",2,99) I $P(MaS,"!",2)=""&($P(MaS,"!",3)="") S ls="И СЕЛЕКТОР ,и ФОРМУЛА для MTBD НЕ ОПРЕДЕЛЕНЫ. "_$P(MaS,"!",4)_" ! "_$P(MaS,"!",5),YES=0 G O
 I $P(MaS,"!",2)'="" S li=$G(@$P(MaS,"!",2)@(1,d)) I li="" G:$P(MaS,"!",3)'="" MTBF S ls=" Узел '"_$ZR_"' в Мультибазовом Селекторе НЕ ОПРЕДЕЛЕН ",YES=0 G O
 I $P(MaS,"!",2)="" G MTBF:$P(MaS,"!",3)'=""
MTB S MTr=$P(li,",",1,$L(li,",")-1),MTt=$P(li,",",$L(li,",")),IMQ=li Q
MTBF X "S li="_$P(MaS,"!",3) G MTB
ErrMT S ls=$$ErrSay^%ZAPM.bs.BSF8($ZE) G O
K5 S k66=$P(k6,","),k666=$P(k6,",",2) S:k66>5 k66=5 S:k666>79 k666=79 S:'k66 k66=1 S:'k666 k666=70 S k6=k66_"@"_k666 K k66,k666 Q
TAB I key=0 S ls=" К ИМЕННОМУ КЛЮЧУ ТАБЛИЦУ НЕ ПРИКРЕПИТЬ " D O G D
 D TA G D:'YES D TIR,RIT^%ZAPM.bs.BSF3 G D:'YES I li="",YES S ls=" ДЛЯ УДАЛЕНИЯ ИСПОЛЬЗУЙТЕ F8 " D O G D
 S Ta=$P($G(@(BSr_"(BSt)"),2),"@",17) I "2,3,4"[Ta&(Ta'="") S ls=" НЕЛЬЗЯ ПРИКРЕПИТЬ К КЛЮЧУ СПИСОК,СВОДКУ,ТАБЛ.C БАЗОЙ " D O G D
 S (TaB,IYI)=BSr_","_BSt D OkMsg^%ZAPM.bs.BSXfun("Вводить данные в прикрепленную таблицу  можно  только после          факта    прикрепления")
 D NE^%ZAPM.bs.BSN,TAB1 S R1=27
 G D
O D O^%ZAPM.bs.BSF7 Q
TA N %ddd S Tta=1,YES=0 S:ny>2 %ddd=d D TAB1 D:$D(%ddd) DDD I '$D(@(%NAm_"""@%BS"")")) D  Q:'YES
 .I $E(%NAm,$L(%NAm))="(" D ECT Q
 .I $D(@($E(%NAm,1,$L(%NAm)-1)_")")) D ECT Q
 .S (li,TaB)=$G(@(%NAm_"""@%BS"")")),YES=1 K Tta Q
D K Ta,TaB,Tab,PRr,%ddd Q
RaT(li) D RIT Q BSr_"("_BSt
TaR(li) D TIR Q li
ECT S ls=" У КЛЮЧА УЖЕ ЕСТЬ ПОТОМКИ " D O^%ZAPM.bs.BSF7 S YES=0 Q
RIT S MaS=1 D RII^%ZAPM.bs.BSF3 Q
 ;;;TIR S:li?.N1",".N li="" S BSr=$P(li,",",1,$L(li,",")-1),BSt=$P(li,",",$L(li,",")) D  S li=BSt_","_BSr_","_BSu_","_BSs Q
 ;;;.I BSr["]" S BSu=$P(BSr,$C(34),2),BSs=$P(BSr,$C(34),4),BSr=$P(BSr,"]",2) Q
 ;;;.S (BSu,BSs)="",BSr=$P(BSr,"^",2)
TIR S:li?.N1",".N li="" I li'[")" S BSr=$P(li,",",1,$L(li,",")-1),BSt=$P(li,",",$L(li,",")) D  S li=$S(li[",<>":li,1:(BSt_","_BSr_","_BSu_","_BSs)) Q
 .I BSr["]" S BSu=$P(BSr,$C(34),2),BSs=$P(BSr,$C(34),4),BSr=$P(BSr,"]",2) Q
 .S (BSu,BSs)="",BSr=$P(BSr,"^",2)
 S BSr=$P(li,"("),BSt=$P($P(li,"(",2),")") S BSt=$S(BSt=+BSt:BSt,1:$E(BSt,2,$L(BSt)-1)),BSt=$$TR^%ZAPM.bs.BSsFUNM(BSt,$C(34,34),$C(34)) ;```$P(BSt,$C(34),2))
 S BSu=$P(BSr,$C(34),2),BSs=$P(BSr,$C(34),4) S:BSr["]" BSr=$P(BSr,"]",2) ;4.;S:BSr["|" BSr=$P(BSr,"|",3)
 S li=BSt_","_BSr_","_BSu_","_BSs Q
TAB1 I '$D(%w(3)) D PASDD^%ZAPM.bs.BST1 E  Q
 D %NAm Q:$D(Tta)
TAB2 S ls=" Повесить на:"_%NAm_" таблицу ,Вы уверены ? " D YES^%ZAPM.bs.BSF I 'YES Q
 D L^%ZAPM.bs.BS3(%NAm) I LOC S @(%NAm_"""@%BS"")")=TaB
 D U^%ZAPM.bs.BS3(%NAm) Q
%NAm I '$D(%KEYS) S YES=0 Q
 S %NAm=$$BSD^%ZAPM.bs.BSA(BSD,$G(%KEYS(0))) F ii=1:1:%KEYS Q:'$D(%KEYS(ii))  S %NAm=%NAm_$S(%KEYS(ii)=+%KEYS(ii):%KEYS(ii),1:$C(34)_%KEYS(ii)_$C(34))_","
 Q
DDD S %NAm=%NAm_$S(%ddd=+%ddd:%ddd,1:$C(34)_%ddd_$C(34))_"," Q
PBD I $G(%BS("Tmp","AKBD",BSD),"RWD")="P" D ErrMsg^%ZAPM.bs.BSXfun("ПОЛЬЗОВАТЕЛЮ `"_$G(%BS(12))_"` ВХОД В ПРИКРЕПЛЕННУЮ ТАБЛИЦУ ЗАПРЕЩЕН !") S ny=0 Q
 S ls="НАСЧЕТ БУФЕРА ДЛЯ ПРИКРЕПЛЕННОЙ ТАБЛИЦЫ " D WAITS^%ZAPM.bs.BSF2,Key^%ZAPM.bs.BST1
 S IYI=@$ZR,PRr=BSR,PRt=BST,BSR=$P(IYI,",",1,$L(IYI,",")-1),BST=$P(IYI,",",$L(IYI,",")),B=@(BSR_"(BST)"),se=$P(B,"@",28),ke=$P(B,"@",29)
 K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)) D FOR^%ZAPM.bs.BSF3 X I_" D BSD^%ZAPM.bs.BST1" D CALC^%ZAPM.bs.BSF3,COL^%ZAPM.bs.BSF3,ENTER^%ZAPM.bs.BSN,BDS S BSR=PRr,BST=PRt K PRr,PRt Q
 Q
ERR D O^%ZAPM.bs.BSF7 X "I 0" S YES=0,$ZT=$G(%zT) Q
BDS Q:'$P($G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15))),"@",2)  N tIm S ls=" Записываем в Базу Данных результаты коррекции пpикpепленной таблицы ? " D YES^%ZAPM.bs.BSF I 'YES K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)) Q
 D %NAm^%ZAPM.bs.BST1,FOR^%ZAPM.bs.BSF3 X I_" D 3333" S tIm=$P($G(@($E(%NAm,1,$L(%NAm)-1)_")")),",",5,6),@($E(%NAm,1,$L(%NAm)-1)_")")=$$h^%ZAPM.bs.BS3()_","_$G(%BS(12))_",1,"_tIm
 K ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)) Q
3333 Q:$P(@(BSR_"(BST,ny,nx)"),"@",9)<2  I $D(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx)) S zr=@$ZR D  Q
 .I $P($P(@(BSR_"(BST,ny,nx)"),"@",18),"#")'="" S nynx=$P($P(^(nx),"@",18),"#")
 .E  S nynx=ny_","_nx
 .I zr="" K @(%NAm_"nynx)") Q
 .S @(%NAm_"nynx)")=zr ;ЗАПИСЬ В Б.Д.
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BST5" type="MAC" languagemode="0"><![CDATA[
%BST5 ;VIEW-КИНЕМАТИКА ТАБЛИЦЫ,TAB ; 10:51  3-DEC-94
 I $G(Mx,0)=-1 S l=$P(@(BSR_"(BST,BSY(BS0),BSX(BS0))"),"@",4) D Z(BSY1(BS0),BSX1(BS0),BSY2(BS0),BSX2(BS0)-l+1),V(BSY1(BS0),BSX1(BS0)+l-1),LF Q
 I $G(Mx,0)>0 D Z(BSY1(BS0),Mx,BSY2(BS0),BSX2(BS0)),V(BSY1(BS0),BSX1(BS0)-1),RT Q
 I $G(My,0)=-1 S l=$P(@(BSR_"(BST,BSY(BS0),BSX(BS0))"),"@",3) D Z(BSY1(BS0),BSX1(BS0),BSY2(BS0)-l,BSX2(BS0)+1),V(BSY1(BS0)+l,BSX1(BS0)-1),UP Q
 I $G(My,0)>0 D Z(My,BSX1(BS0),BSY2(BS0),BSX2(BS0)+1),V(BSY1(BS0),BSX1(BS0)-1),DN Q
 G MOV^%ZAPM.bs.BST
Z(bY1,bX1,bY2,bX2) F b=1:1:(bY2-bY1+1) S BFL(b)=$V(bY1+b-2*160+(bX1-1*2)+%BS(17),-1,bX2-bX1*2,1)
 Q  ;зап.часть экр. в локаль с bX1,bY1,bX2,bY2
V(bY1,bX1) S b="" F  S b=$O(BFL(b)) Q:b=""  V bY1+b-2*160+(bX1*2)+%BS(17):-1:BFL(b)::1
 K BFL Q  ;восст.часть экр. из локали В точку bY1,bX1
DN K BS1,BS2,BY
 S BSII=BSX(BS0) K ENDDN F BSI=BSY(BS0):1 Q:BSI>se  D Y Q:$D(ENDDN)
 Q:MYy=BY($O(BY(""),-1))  K ENDDN F BSI=MYy+1:1 Q:BSI>se  K ENDRI D  Q:$D(ENDDN)
 .F BSII=BSX(BS0):1 Q:BSII>ke  D KLE Q:$D(ENDRI)!($D(ENDDN))
 Q
Y I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",3)  I '$D(BS1) S BS1=$P(BS,"@")+1,BS2=$P(BS,"@",2)+1 I 'BS0 S (BS(1),BS(2))=1
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+BSY1(BS0))>BSY2(BS0) S ENDDN=1 Q
 S BY($P(BS,"@")-BS1+1+BSY1(0))=BSI Q
 Q
RT K BS1,BS2,BX
 S BSI=BSY(BS0) K ENDRI F BSII=BSX(BS0):1 Q:BSII>ke  D X Q:$D(ENDRI)
 Q:$O(BX(""))=""  Q:MXx=BX($O(BX(""),-1))  K ENDDN F BSI=BSY(BS0):1 Q:BSI>se  K ENDRI D  Q:$D(ENDDN)
 .F BSII=MXx:1 Q:BSII>ke  D KLE Q:$D(ENDRI)!($D(ENDDN))
 Q
X I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",4)  I '$D(BS1) S BS1=$P(BS,"@")+1,BS2=$P(BS,"@",2)+1 I 'BS0 S (BS(1),BS(2))=1
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+2+BSX1(BS0))>BSX2(BS0) S ENDRI=1 Q
 S BX($P(BS,"@",2)-BS2+1+BSX1(0))=BSII Q
KLE W $$atr^%ZAPM.bs.BS3(0) S CLR=COLOR I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",4)
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+BSY1(BS0))>BSY2(BS0) S ENDDN=1 Q
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+2+BSX1(BS0))>BSX2(BS0) S ENDRI=1 Q
 I $P(BS,"@",10) S CLR=$P(BS,"@",10)
 I $P(BS,"@",12) S CLR=$P(%BS,"!",3)
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSI,BSII))
 I d0="" S d0=0
 I $P(BS,"@",8)'="" D  S $ZT=$G(%zT)
 .S %zT=$ZT,$ZT="FFF^%ZAPM.bs.BST",ny=BSI,nx=BSII I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"","_BSI_","_BSII_")")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 I '$D(%VDB) F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)>BSY2(BS0)  D  W $J("",$P(BS,"@",4)) D  W $E(d1,BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))
 .W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0))),$$atr^%ZAPM.bs.BS3(CLR) Q
 Q
UP K ENDDN,BZ,BS1,BS2,ENDRI S BSI=BSY(BS0) F BSII=BSX(BS0):1 Q:BSII>ke  D WR Q:$D(ENDRI)
 Q:BS0  K BY S BSII=BSX(0) F BSI=BSY(0):1 Q:BSI>se  D YY Q:$D(ENDDN)
 Q
LF K ENDDN,BS1,BS2,BZ,ENDRI S BSII=BSX(BS0) F BSI=BSY(BS0):1 Q:BSI>se  D WR Q:$D(ENDDN)
 Q:BS0  K BX S BSI=BSY(0) F BSII=BSX(0):1 Q:BSII>ke  D XX Q:$D(ENDRI)
 Q
XX I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",4)
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+2+BSX1(BS0))>BSX2(BS0) S ENDRI=1 Q
 S BX($P(BS,"@",2)-BS2+1+BSX1(0))=BSII Q
YY I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",3)
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+BSY1(BS0))>BSY2(BS0) S ENDDN=1 Q
 S BY($P(BS,"@")-BS1+1+BSY1(0))=BSI Q  ;,BS(1)=0 Q
 Q
WR W $$atr^%ZAPM.bs.BS3(0) S CLR=COLOR I $D(@(BSR_"(BST,BSI,BSII)")) S BS=^(BSII) Q:'$P(BS,"@",4)  I '$D(BS1) S BS1=$P(BS,"@")+1,BS2=$P(BS,"@",2)+1
 I (($P(BS,"@")+$P(BS,"@",3)-2)-BS1+2+BSY1(BS0))>BSY2(BS0) S ENDDN=1 Q
 I (($P(BS,"@",2)+$P(BS,"@",4)-2)-BS2+2+BSX1(BS0))>BSX2(BS0) S ENDRI=1 Q
 I $P(BS,"@",10) S CLR=$P(BS,"@",10)
 I $P(BS,"@",12) S CLR=$P(%BS,"!",3)
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSI,BSII))
 I d0="" S d0=0
 I $P(BS,"@",8)'="" D  S $ZT=$G(%zT)
 .S %zT=$ZT,$ZT="FFF^%ZAPM.bs.BST",ny=BSI,nx=BSII I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"","_BSI_","_BSII_")")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
 I '$D(%VDB) F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)>BSY2(BS0)  D  W $J("",$P(BS,"@",4)) D  W $E(d1,BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))
 .W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0))),$$atr^%ZAPM.bs.BS3(CLR) Q
e Q
STAB S Na=-1 G TA
TAB S Na=1
TA K MxS,MyS,MsS S mx=MX,my=MY S MR=0 D WO^%ZAPM.bs.BSTM S MR=1 D  I $D(MsS) S MX=mx,MY=my K MxS,MyS,MsS,mx,my,Na Q
 .F  S MX=$O(BX(MX),Na) D:MX=""  Q:$D(MsS)  I $P($G(@(BSR_"(BST,"_BY(MY)_","_BX(MX)_")")),"@",5)="" S MyS=1 Q
 ..S MX=$O(BX(""),Na),MY=$O(BY(MY),Na) D:MY=""  Q:$D(MsS)
 ...I $D(MxS) S MsS=1 Q
 ...S MxS=1,MY=$O(BY(""),Na)
 I $D(MyS) K MxS,MyS,MsS,mx,my,Na Q
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSTAT" type="MAC" languagemode="0"><![CDATA[
STAT ; Статистика по RPT файлу. (А.Нефедов) ; 15:18   12.06.99
 I $ZV["Cach"||($ZV["IRIS") D ErrMsg^%ZAPM.bs.BSXfun(" НЕТ РЕЖИМА В "_$ZV) Q
 S RPTName=$G(%BS(24,1),$P($GET(^%ZAPM.bs.BSS("SETUP",17,2)),"@",15))
 I RPTName=""!($E(RPTName)="^") W "- No RPT file defined.",! Q
 S BSTAT=$$TMPG^%ZAPM.bs.BSF11
 S BVOL=$$TMPG^%ZAPM.bs.BSF11
 S BERR=$$TMPG^%ZAPM.bs.BSF11
 D Wait^%ZAPM.bs.BSXfun("Checking "_RPTName)
 F %Dev=51:1:54 O %Dev::0 Q:$T
 I '$T D ErrMsg^%ZAPM.bs.BSXfun("All Dos devices are buzy.") Q
 S %FN=$$AddFile^%ZAPM.bs.BSDOS2(RPTName)
 O %Dev:(%FN:"R") U %Dev I $ZA U 0 D ErrMsg^%ZAPM.bs.BSXfun("file not found") Q
 S Entr=0
 F  R Line Q:$ZC  D:Line'=""
 .U 0
 .S Entr=Entr+1
 .S User=$P(Line,"§",3) I User="" S User="User:?"
 .I User="User:" S User="User:!SysOp"
 .S Vol=$P(Line,"§",4)  I Vol="" S Vol="?"
 .S Command=$P(Line,"§",5)
 .S Com=$P($P(Command,":",2),"%",1) I (Com="")!($A(Com)<32)!($F(Com,$C(0))'=0) S Com="?"
 .S Time=$P($P(Line,"§",6),":",2)
 .S ^(User)=$G(@BSTAT@(User))+1
 .S ^(Com)=$G(@BSTAT@(User,Vol,Com))+1
 .S ^(Com,^(Com))=Time
 .I Com="Begin" S @BSTAT@(User,Vol,"Timer","Flag")=1,^("Start")=Time
 .I (Com="Exit")&($G(@BSTAT@(User,Vol,"Timer","Flag"))=1) S ^("Flag")=0 D
 ..S TM=($P(Time,",",1)-$P(^("Start"),",",1))*3600*24+$P(Time,",",2)-$P(^("Start"),",",2)
 ..S TM=TM\60,@BSTAT@(User,Vol,"Timer")=TM
 ..Q
 .I $E(Com,1,5)="Mount" S @BVOL@(" "_$E(Com,6,$L(Com)),"Timer","Flag")=1,^("Start")=Time
 .I ($E(Com,1,8)="Dismount")&($G(@BVOL@(" "_$E(Com,10,$L(Com)),"Timer","Flag"))=1) S ^("Flag")=0 D
 ..S TM=($P(Time,",",1)-$P(^("Start"),",",1))*3600*24+$P(Time,",",2)-$P(^("Start"),",",2)
 ..S TM=TM\60,@BVOL@(" "_$E(Com,10,$L(Com)),"Timer")=TM
 ..Q
 .I $E(Com,1,5)="Mount" S @BVOL@(" "_$E(Com,6,$L(Com)),"LastOper")="Mount",^("LastUser")=User,^("LastSys")=Vol
 .I $E(Com,1,8)="Dismount" S @BVOL@(" "_$E(Com,10,$L(Com)),"LastOper")="Dismount",^("LastUser")=User,^("LastSys")=Vol
 .I (Com="Error")!(Com="BeginStop") D
 ..I Com="BeginStop" S SubC=" "_"BEGINSTOP Ошибка регистрации"
 ..I Com="Error" S SubC=" "_$E($P(Command,"<",2,99),1,40)
 ..S ^(SubC)=$G(@BERR@(SubC))+1
 ..S @BERR@(SubC,"LastUser")=User,@BERR@(SubC,"LastSys")=Vol
 ..I $G(@BSTAT@(User,Vol,"Timer","Flag"))=1 S ^("Flag")=0 D
 ...S TM=($P(Time,",",1)-$P(^("Start"),",",1))*3600*24+$P(Time,",",2)-$P(^("Start"),",",2)
 ...S TM=TM\60,@BSTAT@(User,Vol,"Timer")=TM
 ...Q
 ..Q
 .W $$atr^%ZAPM.bs.BS3(0),/CUP(24,52),Entr
 .U %Dev
 .Q
 U 0
 C %Dev S UTotal=0,Ref=""
 F  S Ref=$O(@BSTAT@(Ref)) Q:Ref=""  S UTotal=UTotal+1
 D OkMsg^%ZAPM.bs.BSXfun(Entr_" - events total, "_UTotal_" - users found.")
Down 
 S BSR="^%ZAPM.bs.BSS",BST="STAT" ;,^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P))=BSTAT_"!"_BVOL_"!"_BERR
 D ^%ZAPM.bs.BST I R1=27 G Exit
 I ny=1 G Users
 I ny=2 G Mount
 G Errs
 ;Down Q
 W /ED(2)
 W /CUP(10,27),"1. Users summary."
 W /CUP(11,27),"2. Volumes information."
 W /CUP(12,27),"3. Errors detected."
 W /CUP(13,27),"4. Exit"
 S Arrow=5,R1=27,R2=91,R3=66
 F  D WCheck D CL^%ZAPM.bs.BSF4 R *R1 R:R1=27 *R2,*R3 D OP^%ZAPM.bs.BSF4 Q:R1=13!((R1>48)&(R1<53))
 G W1
WCheck 
  Q:(R1'=27)!(R2'=91)!((R3'=66)&(R3'=65))  S Temp=Arrow
  S:R3=66 Arrow=Arrow+1 S:Arrow>4 Arrow=1
  S:R3=65 Arrow=Arrow-1 S:Arrow<1 Arrow=4
  W /CUP(9+Temp,22),"   "
  W /CUP(9+Arrow,22),"==>",/CUP(9+Arrow,27)
  Q
W1 
 W /ED(2)
 S:R1'=13 Arrow=R1-48
 G:Arrow=4 Exit
 G:Arrow=1 Users
 G:Arrow=2 Mount
 G:Arrow=3 Errs
 G Down
 
Exit 
 ;S BSTAT=$P(^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P)),"!"),BERR=$P(^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P)),"!",3),BVOL=$P(^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P)),"!",2)
 K @BSTAT,@BVOL,@BERR
 Q
 
Users ;S BSTAT=$P(^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P)),"!")
 S (li,G)=$$TMPG^%ZAPM.bs.BSF11 D TIR^%ZAPM.bs.BST4
 S BSr=$P(li,",",2),BSt=$P(li,",")
 S i0="Пользователь"
 S i0=$$W(i0,23)_"Система"
 S i0=$$W(i0,41)_"Регистрации"
 S i0=$$W(i0,56)_"Время"
 S i0=$$W(i0,66)_"Ошибки"
 S Coment=i0
 S User=$O(@BSTAT@("")),Vol=""
 F  Q:User=""  D
 .S TBegin=0,TError=0,TTimer=0
 .F  S Vol=$O(@BSTAT@(User,Vol)) Q:Vol=""  D
 ..S HUser=User,HVol=Vol
 ..S:$E(HUser,1)=" " HUser=$E(HUser,2,$L(HUser))
 ..S:$E(HVol,1)=" " HVol=$E(HVol,2,$L(HVol))
 ..S HBegin=$G(@BSTAT@(User,Vol,"Begin")) S:HBegin="" HBegin="0" S TBegin=TBegin+HBegin
 ..S HError=$G(@BSTAT@(User,Vol,"Error")) S:HError="" HError="0" S TError=TError+HError
 ..S HTimer=$G(@BSTAT@(User,Vol,"Timer")) S:HTimer="" HTimer="0" S TTimer=TTimer+HTimer
 ..S t0="   "_HUser
 ..S t0=$$W(t0,26)_HVol
 ..S t0=$$W(t0,44)_HBegin
 ..S t0=$$W(t0,59)_HTimer
 ..S t0=$$W(t0,69)_HError
 ..D CR^%ZAPM.bs.BSTT
 ..Q
 .S t0="" D CR^%ZAPM.bs.BSTT
 .S t0=$$W(t0,35)_" Всего: "
 .S t0=$$W(t0,44)_TBegin
 .S t0=$$W(t0,59)_TTimer
 .S t0=$$W(t0,69)_TError
 .D CR^%ZAPM.bs.BSTT
 .S t0="" D CR^%ZAPM.bs.BSTT  D CR^%ZAPM.bs.BSTT
 .S User=$O(@BSTAT@(User))
 .Q
 D CREATE^%ZAPM.bs.BSTT
 K @G
 G Down
 
Mount ;S BVOL=$P(^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P)),"!",2)
 S (li,G)=$$TMPG^%ZAPM.bs.BSF11 D TIR^%ZAPM.bs.BST4
 S BSr=$P(li,",",2),BSt=$P(li,",")
 S Vol=""
 S i0="Имя тома"
 S i0=$$W(i0,14)_"Время испол."
 S i0=$$W(i0,30)_"Послед. операция"
 S i0=$$W(i0,49)_"Пользователь"
 S i0=$$W(i0,62)_"Система   "
 S Coment=i0
 F  S Vol=$O(@BVOL@(Vol)) D:Vol'=""  Q:Vol=""
 .S HTimer=$G(@BVOL@(Vol,"Timer")) S:HTimer="" HTimer="?"
 .S HOper=$G(@BVOL@(Vol,"LastOper")) S:HOper="" HOper="?"
 .S HUser=$G(@BVOL@(Vol,"LastUser")) S:HUser="" HUser="?"
 .S HSys=$G(@BVOL@(Vol,"LastSys")) S:HSys="" HSys="?"
 .S t0="  "_Vol
 .S t0=$$W(t0,17)_HTimer
 .S t0=$$W(t0,33)_HOper
 .S t0=$$W(t0,52)_HUser
 .S t0=$$W(t0,65)_HSys
 .D CR^%ZAPM.bs.BSTT
 .Q
 D CREATE^%ZAPM.bs.BSTT
 K @G
 G Down
 
Errs ;S BERR=$P(^%ZAPM.bs.BSbufB("StaTu"_$G(%BS(3),$P)),"!",3)
 S (li,G)=$$TMPG^%ZAPM.bs.BSF11 D TIR^%ZAPM.bs.BST4
 S BSr=$P(li,",",2),BSt=$P(li,",")
 S Err=""
 S i0="Ошибка"
 S i0=$$W(i0,42)_"Число раз"
 S i0=$$W(i0,52)_"Пользователь"
 S i0=$$W(i0,65)_"Система"
 S Coment=i0
 F  S Err=$O(@BERR@(Err)) D:Err'=""  Q:Err=""
 .S HErr=$G(@BERR@(Err)) S:HErr="" HErr="0"
 .S HUser=$G(@BERR@(Err,"LastUser")) S:HUser="" HUser="?"
 .S HSys=$G(@BERR@(Err,"LastSys")) S:HSys="" HSys="?"
 .S t0="   "_$P(Err," ",2)
 .S t0=$$W(t0,30)_$E(Err,$F(Err," ",2),$F(Err," ",2)+12)
 .S t0=$$W(t0,45)_HErr
 .S t0=$$W(t0,55)_HUser
 .S t0=$$W(t0,68)_HSys
 .D CR^%ZAPM.bs.BSTT
 .Q
 D CREATE^%ZAPM.bs.BSTT
 K @G
 G Down
 
W(St,Num) 
 N I,S S S=St
 F I=$L(St):1:Num-1 S S=S_" "
 Q S
]]></Routine>


<Routine name="%ZAPM.bs.BSTESTD" type="MAC" languagemode="0"><![CDATA[
%BSTESTD ;Пример описания диалоговой панели ```(А.Нефедов) ; 16:56 10-JUN-98
 ;
 ;W !,$P($$ESDAY^%ZAPM.bs.BSsFUNR(8,$$h^%ZAPM.bs.BS3())," ")
 ;F  R *R1 R:R1=27 *R2:0,*R3:0 W !,R1," ",R2," ",R3 Q:R1=13
 ;W $NA(G)
 ;Q
 
 D ^%ZAPM.bs.BSDIAL ; Регистрация стандартных классов.
 ;
 ; Now, we have to declare basic class
 ;
 ; ClassName@Left@Top@Width@Height@Text@Enable@Visible@Color@Hint@HintColor@
 ; 1         2    3   4     5      6    7      8       9     10   11
 ; Alight@Focused@TabStop@TabOrder@CursorDef@EmptyChar@ForeColor@BackColor@
 ; 12     13      14      15       16           17        18        19
 ; FocusColor@ShadowColor1@ShadowColor2@Control1@Command@GroupNum@CanClose
 ; 20         21           22           23       24      25       26
 ; CursorDef1@CommitKey
 ; 27         28
 ;
 ;
 D ;:$D(^f1)=0
 .S ^f1="TDialog@5@5@50@13@Test Dialog@1@1@0@@7@0@@@@@ @0@7@8@0@0@@@@$$CanClose^%ZAPM.bs.BSTESTD()"
 .S ^f1("Label1")="TLabel@7@7@12@15@Test Label1@1@1@8@@7@0@@0@0@@ @0@7"
 .S ^f1("Label2")="TLabel@7@8@12@15@Test Label2@1@1@8@@2@0@@0@0@@ @0@7"
 .S ^f1("Label3")="TLabel@7@10@17@15@Test Label3@1@1@8@@7@1@@0@0@@ @0@7"
 .S ^f1("Button1")="TButton@10@16@8@1@Yes@1@1@8@@7@3@@1@1@@ @7@4@15@0@7@@D DoneDlg"
 .S ^f1("Button2")="TButton@25@16@8@1@No@1@1@8@@7@3@@1@2@@ @7@4@15@0@7@@@"
 .S ^f1("Button3")="TButton@40@16@8@1@Help@1@1@8@@7@3@@1@3@@ @7@4@15@0@7@@D O^%ZAPM.bs.BSF3"
 .S ^f1("Check1")="TCheck@35@11@8@1@[ ] Option1@1@1@8@@7@3@@1@7@@ @0@7@15@0@7@1@"
 .S ^f1("Check2")="TCheck@35@12@8@1@Option2 [ ]@1@1@8@@7@3@@1@8@@ @0@7@15@0@7@@"
 .S ^f1("Radio1")="TRadio@35@7@8@1@( ) Alternativ1@1@1@8@@7@3@@1@4@@ @0@7@15@0@7@1@@1"
 .S ^f1("Radio2")="TRadio@35@8@8@1@( ) Alternativ2@1@1@8@@7@3@@1@5@@ @0@7@15@0@7@@@1"
 .S ^f1("Radio3")="TRadio@35@9@8@1@Alternativ3 ( )@1@1@8@@7@3@@1@6@@ @0@7@15@0@7@@@1"
 .S ^f1("Label4")="TLabel@7@14@17@15@Enter your name: @1@1@8@@7@1@@0@0@@ @0@7"
 .S ^f1("Edit1")="TEdit@25@14@17@15@@1@1@8@Тут должно быть ваше имя  @7@1@@1@9@@­@0@7"
 .S ^f1("Clock1")="TClock@71@1@8@15@000@1@1@8@@7@1@@0@0@@ @0@7"
 .Q
 ;
 N Name
 S Name=$$TMPG^%ZAPM.bs.BSF11
 D ExecDlg^%ZAPM.bs.BSDIAL("^f1",Name)
 K @Name,Name
 Q
 
CanClose() 
 I $P(^f1("Edit1"),"@",6)="" D ErrMsg^%ZAPM.bs.BSXfun("Требуется имя.") Q 0
 Q 1
 
 
]]></Routine>


<Routine name="%ZAPM.bs.BSTIMER" type="MAC" languagemode="0"><![CDATA[
%BSTIMER ; ФОНОВЫЙ ТАЙМЕР ДЛЯ ТЕСТИРОВАНИЯ БАЗЫ ДАННЫХ НА СЕРВЕРЕ (C.Кривошеев) ; 18:17   04.04.2001
 ;NEW INTERVAL,ACTTIME,FTRUE,FFALSE,FBAT,I,M,DATTIME,DAT1,%ERR,DATT,STRING
 F I=1:1:3 H 1 L +%BStimer:0 E  I I=3 H
 S INTERVAL=$P(^%ZAPM.bs.BSS("TIMER",4,4),"@",15)
 S STRING=$P(^%ZAPM.bs.BSS("TIMER",5,4),"@",15)
 S DAT1=$$TiME()
 S ACTTIME=$P(DAT1,":",1)*3600+($P(DAT1,":",2)*60)+$P(DAT1,":",3)
 S FTRUE=$P(^%ZAPM.bs.BSS("TIMER",7,4),"@",15)
 S FFALSE=$P(^%ZAPM.bs.BSS("TIMER",9,4),"@",15)
 S FBAT=$P(^%ZAPM.bs.BSS("TIMER",11,4),"@",15)
1 HANG INTERVAL I $$EVENT D ACTION ;LOOP
 I $D(STOP) HALT
 G 1
SETTIME(T) I T'?1N.N1":"2N W !,"НЕКОРРЕКТНЫЙ ФОРМАТ ВРЕМЕНИ ! (ЧЧ:MM)" Q
 S $P(^%ZAPM.bs.BSS("TIMER",2,4),"@",15)=T ;УСТАНОВИТЬ НУЖНОЕ ВРЕМЯ
 D STATUS
 Q
TiME() Q $P(^%ZAPM.bs.BSS("TIMER",2,4),"@",15)
ATiME() S DAT1=$$TiME()
 Q $P(DAT1,":",1)*3600+($P(DAT1,":",2)*60)+$P(DAT1,":",3)
EVENT() ;СОБЫТИE
 S M=$P($$h^%ZAPM.bs.BS3(),",",2),ACTTIME=$$ATiME()
 I (M>(ACTTIME-(INTERVAL/2)))&(M<(ACTTIME+(INTERVAL/2)+1)) Q 1
 Q 0
ACTION ;ДЕЙСТВИЯ
 DO AUTO^VALIDATE
 S DATTIME=$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())
 S DATT=$P($$h^%ZAPM.bs.BS3(),",",1)
 IF %ERR=0 D PROCTRUE J ^%ZAPM.bs.BSTIMER::0 H:$T  Q
 ;
 ;ЕСЛИ ОШИБКИ ЕСТЬ
 O 51:(FFALSE:"W") U 51 W "ERRORS"_DATTIME_":",!
 S I=""  F  S I=$O(%ERR(I)) Q:I=""  W %ERR(I),!
 C 51
 Q
PROCTRUE ;ЕСЛИ ОШИБОК НЕТ
 O 51:(FTRUE:"A") U 51 W "Test DataBase passed O'k  "_DATTIME_", File BackCopy is "_DATT_".arj",! C 51
 O 51:(FBAT:"W") U 51 W "rem   -=Creating "_DATTIME_"=-",!,STRING_DATT,! C 51
 Q
START ;ЗАПУСК НА СТАНЦИИ
SERVER ;ЗАПУСК НА СЕРВЕРЕ
 I '$D(^%ZAPM.bs.BSbufS) S ^%ZAPM.bs.BSbufS="BaSe MsW @РАЗДЕЛ НАСЧИТАННЫХ СВОДОК И СПИСКОВ",^%ZAPM.bs.BSMOLN="BaSe MsW @РАЗДЕЛ НАСЧИТАННЫХ СВОДОК И СПИСКОВ МОЛНИИ",^%ZAPM.bs.BSTABEL="BaSe MsW @РАЗДЕЛ НАСЧИТАННЫХ СВОДОК И СПИСКОВ ТАБЕЛЯ"
 J ^%ZAPM.bs.BSTIMER::0 I  W !,"%BS-TIMER STARTED. BASE VALIDATING IN "_$$TiME() Q
 W !,"%BS-TIMER NOT STARTED" Q
 Q
STATUS ;СТАТУС ТАЙМЕРА
 L +%BStimer:0 I  W !,"%BS-TIMER NOT ACTIVE" Q
 W !,"%BS-TIMER ALLREADY STARTED. BASE VALIDATING IN "_$$TiME()
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSTK" type="MAC" languagemode="0"><![CDATA[
%BSTK ;РЕДАКТИРОВАНИЕ КЛЮЧЕЙ ; 14:07   20.01.2000
E10 G:TIP=2 E10T I "1"[TIP S ls=" Вы ХОТИТЕ сделать вашу таблицу ,ТАБЛИЦЕЙ С БАЗОЙ ? " D YES^%ZAPM.bs.BSF G D:'YES,E10T
 I TIP=3!(TIP=4) D Yes^%ZAPM.bs.BSXfun(" Для '"_BST_"' ключи определяются функцией "_$S(TIP=3:"$$TSP",1:"$$TSV")_", но можно ОПРЕДЕЛИТЬ СПЕЦИАЛЬНЫЕ ПАРАМЕРЫ ВЫБОРОК КЛЮЧЕЙ только для '"_BST_"'! ВЫ ЭТО ХОТИТЕ ?",2) G ^%ZAPM.bs.BSTKS:YES>0 I TIP=4 D Yes^%ZAPM.bs.BSXfun(" Для СВОДОК определим РЕЖИМЫ насчета ?",2) D:YES>0
 .S Tmp=$$LineEdit^%ZAPM.bs.BSXfun($G(@BSR@(BST,"SVO"),"12"),"введите параметры насчета сводки..., для помощи введите F1","","","^%ZAPM.bs.BSHLP,SVO")
 .Q:YES<1  S @BSR@(BST,"SVO")=Tmp
 G D
E10T I $D(@(BSR_"(BST,""KEY"")")) S kk=0 G E100
 S OOO="^%ZAPM.bs.BS",OO=49 D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G D:R1=27 S kk=%B
 I %B=4 D RIT^%ZAPM.bs.BSF3 G:'YES E10T S CHUr=BSR,CHUt=BST,BSR=BSr,BST=BSt,kk=0
E100 D SA^%ZAPM.bs.BSsBUF,Ed,RE^%ZAPM.bs.BSsBUF
D G 0^%ZAPM.bs.BSTM
Ed D BF I '$D(@(BSR_"(BST,""KEY"")")) D EDI G RES
 S BSd=$G(@$ZR,"@"),$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,6),"@",15)=$G(@(BSR_"(BST,""KEY"")"),"???"),f="RTR"
 ;ИЗ КЛЮЧЕЙ В ТАБЛИЦУ ОПИСАНИЯ
 S $P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,7),"@",15)=$G(@BSR@(BST,"DDR")) ;ССЫЛКА НА УЗЕЛ DDR
 S $P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,8),"@",15)=$G(@BSR@(BST,"INDEX")) ;ССЫЛКА НА БД ПОИСКА
 F i=0:1:13 I $D(@(BSR_"(BST,""KEY"",i)")) K l1 D
 .F k=1:1:7,9,10,12:1:16,20 S @("k"_k)=$P(^(i),"@",k)
 .I $D(@(BSR_"(BST,""KEY"",i,1)"))  S l1=@$ZR,l2=$G(^(2)) I l1'="" S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"RTR",i+2,5)=l1,^(5,1)=l2,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,5),"@",16)=0
 .I $D(@(BSR_"(BST,""KEY"",i,3)"))  S l1=@$ZR,l2=$G(^(4)) I l1'="" S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",i+2,5)=l1,^(5,1)=l2,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,5),"@",8)=0
 .I $D(@(BSR_"(BST,""KEY"",i,5)"))  S l1=@$ZR,l2=$G(^(6)) I l1'="" S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i+2,5)=l1,^(5,1)=l2,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,5),"@",13)=0
 .K KK F k=10:1 Q:'$D(@(BSR_"(BST,""KEY"",i,k)"))  S KK(k)=^(k),KK(k,1)=$G(^(k,1)),KK(k,2)=$G(^(2))
 .S BSk(i)=1,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,2),"@",15)=k6,$P(^(3),"@",15)=k15,$P(^(4),"@",10)=k10,$P(^(4),"@",15)=k5,$P(^(2),"@",14)=k7
 .S $P(^(8),"@",15)=k2,$P(^(6),"@",15)=k1,$P(^(7),"@",15)=k4,$P(^(5),"@",15)=k3,$P(^(9),"@",15)=k12 I k9'="" S $P(^(1),"@",15)=k9
 .D KK
EDIT D EDI G RES
KK S k="",$P(^(5),"@",13)=k13,$P(^(5),"@",14)=k14,$P(^(5),"@",20)=k20
 F  S k=$O(KK(k)) Q:k=""  D  S $P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,k),"@",15)=KK(k),^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i+2,k)=KK(k,1),^(k,1)=KK(k,2),$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,k),"@",13)=0
 .F ij=1:1:12 I '$D(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),ij,k)) S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),ij,k)=$G(^%ZAPM.bs.BSS("KEY0",ij,k),^%ZAPM.bs.BSS("KEY0",ij,15))
 K KK Q
BF K ^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),BSd,BSk S BSt1="KEY"_kk,BSr1="^%ZAPM.bs.BSS",BSr2="^%ZAPM.bs.BSbufB",BSt2="@K"_$G(%BS(3),$P)_$J_"u"_%BS(15) D COPY
 F jj=2,4,5 S $P(@(BSr2_"(BSt2)"),"@",jj)=""
e Q
COPY S %zT=$ZT,$ZT="ERCOPY^%ZAPM.bs.BSTK"
 D Wait^%ZAPM.bs.BSXfun("дублируем.."_BSr1_","_BSt1_" в "_BSr2_","_BSt2)
 K @(BSr2_"(BSt2)") I $P($ZV,"Version ",2)'<4 M @(BSr2_"(BSt2)")=@(BSr1_"(BSt1)") Q
 I $D(@BSr2)["0" S:$D(@BSr1)=11 @BSr2=@BSr1
 S j=BSr1_"(BSt1)" I $D(@j) S jj=$P($ZR,")")_",",@(BSr2_"(BSt2)")=@j
 F  S j=$ZO(@j) Q:j'[jj  S @(BSr2_"(BSt2,"_$P(j,jj,2,9))=@j X $G(WA)
 Q
ERCOPY S ls=$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT),YES=0 Q
TRDEV N vor U %DEV S vor="]" ;4.;=$S($P($ZV,"Version ",2)<4:"]",1:"|")
 W:$D(@(TRe1_")"))'["0" (TRe1_")"),!,@(TRe1_")"),! U 0 W "." S j=TRe1_")",jj=$S(TRe1[vor:$P(TRe1,vor,2,99),1:$P(TRe1,"^",2,99))_","
 U %DEV F  S j=$ZO(@j) Q:$S(j[vor:$P(j,vor,2,99),1:j)'[jj  W j,!,@j,!
 U 0 Q
TREE K:'$D(NOKILLER) @(TRe2_")") I $P($ZV,"Version ",2)'<4 M @(TRe2_")")=@(TRe1_")") Q
 S:$D(@(TRe1_")"))'["0" @(TRe2_")")=@(TRe1_")") S ls="Копи..."_TRe1_" В "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2 S j=TRe1_")",jj=$S(TRe1["]":$P(TRe1,"]",2,99),1:$P(TRe1,"^",2,99))_","
 F  S j=$ZO(@j) Q:$S(j["]":$P(j,"]",2,99),1:j)'[jj  S @(TRe2_","_$P(j,jj,2,9))=@j X $G(WA)
 Q
TRE K:'$D(NOKILLER) @TRe2 I $P($ZV,"Version ",2)'<4 M @TRe2=@TRe1 Q
 S:$D(@TRe1)'["0" @TRe2=@TRe1 S ls="Коп.мас..."_TRe1_" В "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2 S j=TRe1,jj=$S(TRe1["]":$P(TRe1,"]",2,99),1:$P(TRe1,"^",2,99))_"("
 F  S j=$ZO(@j) Q:$S(j["]":$P(j,"]",2,99),1:j)'[jj  S @(TRe2_"("_$P(j,jj,2,9))=@j X WA
 Q
EDI D SI^%ZAPM.bs.BSN N (%BS,vl) S BST=$S($D(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15))):"@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),1:"K"_$G(%BS(3),$P)_$J_"u"_%BS(15)) F k=1:1:9 S @("k"_k)=1
 S BSR="^%ZAPM.bs.BSbufB" D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST Q
RES N BSDDR,BSINDEX
 I $D(CHUr) S BSR=CHUr,BST=CHUt K CHUt,CHUr
 G:'$D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,6)) END S BSD=$P(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,6),"@",15),%zT=$ZT,$ZT="E1^%ZAPM.bs.BSTK" D  S:BSD'["^" BSD="^"_BSD G:TIP=3!(TIP=4) REE I '$D(@BSD) S @$ZR="BSD - MSW@"_BSR_"@"_$E(BST,2,9) D CP^%ZAPM.bs.BSGCH(BSD,$P(%BS(22),",",3)) G RE
 .S BSDDR=$P(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,7),"@",15)
 .S BSINDEX=$P(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),12,8),"@",15)
 S $ZT=$G(%zT) E  I $P($G(@$ZR),"@",2)'=BSR!($P($G(@$ZR),"@",3)'=$E(BST,2,9)) S ls=" БАЗА ДАННЫХ ЧУЖАЯ !!! ВЫ ХОТИТЕ НАЗНАЧИТЬ ЕЁ И НАШЕЙ ТАБЛИЦЕ ?" D YES^%ZAPM.bs.BSF G YES:'YES
RE I BSD'=$G(BSd,BSD) D OkMsg^%ZAPM.bs.BSXfun("Старая База:"_BSd_" и новая:"_BSD_" не совпадает!") S ls="Редактируем снова?" D YES^%ZAPM.bs.BSF I YES G EDIT
REE F i=2:1:11 I $P($G(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,2)),"@",15)'="" I $D(BSk(i-2)) S BSk(i-2)=0
 K k0,Hidden F i=0:1:13 I $D(BSk(i)) I BSk(i) S k0=1
 I $D(k0) S ls="Старые и новые ключи не совпадают! Cнова будем редактировать?" D YES^%ZAPM.bs.BSF I YES G EDIT
 K @(BSR_"(BST,""KEY"")") S @(BSR_"(BST,""KEY"")")=BSD //!!! $$BSR^%ZAPM.bs.BSA(BSD)
 S $ZT=$G(%zT),f="RTR" D  F k=0:1:6,10,12:1:16 K @("k"_k)
 .I BSR="^%ZAPM.bs.BSS",BST="@USER" S %BS(18)=$$BSR^%ZAPM.bs.BSA(BSD)
 .I $G(BSDDR)'="" S @BSR@(BST,"DDR")=BSDDR
 .I $G(BSINDEX)'="" S @BSR@(BST,"INDEX")=BSINDEX
 ;ИЗ ТАБЛИЦЫ ОПИСАНИЯ В КЛЮЧИ
 F i=2:1:11 I $P($G(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,2)),"@",15)'="" S k0=i,k6=$P(^(2),"@",15),k7=$P(^(2),"@",14) D
 .S k15=$P(^(3),"@",15),k10=$P(^(4),"@",10),k2=$P(^(8),"@",15),k1=$P(^(6),"@",15),k3=$P(^(5),"@",15),k16=$P(^(5),"@",16),k4=$P(^(7),"@",15)
 .S k5=$P(^(4),"@",15),k14=$P(^(5),"@",14),k13=$P(^(5),"@",13),k12=$P(^(9),"@",15),k20=$P(^(5),"@",20),k9=$P(^(1),"@",15)
 .F k=10:1 Q:'$D(^(k))  S zr=$ZR,l1=@$ZR I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i,k)) S l2=@$ZR,l3=$G(^(k,1)),@(BSR_"(BST,""KEY"",i-2,k)")=$P(l1,"@",15),^(k,1)=l2,^(2)=l3 I @zr
 .S $P(@(BSR_"(BST,""KEY"",i-2)"),"@")=k1 F k=2:1:7,9,10,12:1:16,20 S $P(@$ZR,"@",k)=@("k"_k)
 .I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"RTR",i,5)) S l1=@$ZR,l2=$G(^(5,1)),@(BSR_"(BST,""KEY"",i-2,1)")=l1,^(2)=l2
 .I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",i,5)) S l1=@$ZR,l2=$G(^(5,1)),@(BSR_"(BST,""KEY"",i-2,3)")=l1,^(4)=l2
 .I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i,5)) S l1=@$ZR,l2=$G(^(5,1)),@(BSR_"(BST,""KEY"",i-2,5)")=l1,^(6)=l2
 .I k6="HiddenLastKey",k15="" D ErrMsg^%ZAPM.bs.BSXfun("В режиме HiddenLastKey В 3 колоночку надо ввести СИМВОЛЬНОЕ ИМЯ ВЫВОДА идентификации последнего ключа") S Hidden=1
 I $D(k0),($P(@(BSR_"(BST)"),"@",17)<2) S $P(@$ZR,"@",17)=2
 I $G(Hidden) D Yes^%ZAPM.bs.BSXfun("Cнова будем редактировать?") I YES G EDIT
END K ^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),k0,k1,k2,k3,k4,k5,k6,k10,k12,k16,k,k15,BSk,BSd,kk S $ZT=$G(%zT) Q
ER S ls=" ОШИБКА В ИМЕНИ ТАБЛИЦЫ ИЛИ РАЗДЕЛА ! "_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 G D
E1 S ls=" ОШИБКА В ИМЕНИ БАЗЫ ДАННЫХ ! "_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7
YES S ls=" Продолжим корректировать описание Ключей и Базы данных ? " D YES^%ZAPM.bs.BSF I YES G EDIT
 S $ZT=$G(%zT) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSTKS" type="MAC" languagemode="0"><![CDATA[
%BSTKS ; ПАРАМЕТРЫ КЛЮЧЕЙ ДЛЯ СПИСКОВ И СВОДОК; 16:08 14-FEB-97 ; 18:28 29-MAY-97
E10T S kk=0 G E100
 S OOO="^%ZAPM.bs.BS",OO=49 D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF G D:R1=27 S kk=0
 I %B=4 D RIT^%ZAPM.bs.BSF3 G:'YES E10T S CHUr=BSR,CHUt=BST,BSR=BSr,BST=BSt,kk=0
E100 D SA^%ZAPM.bs.BSsBUF,Ed,RE^%ZAPM.bs.BSsBUF
D G 0^%ZAPM.bs.BSTM
Ed D BF I '$D(@BSR@(BST,"Key")) D EDI G RES
 S f="RTR"
 ;ИЗ КЛЮЧЕЙ В ТАБЛИЦУ ОПИСАНИЯ
 F i=0:1:13 I $D(@(BSR_"(BST,""Key"",i)")) K l1 D
 .F k=1:1:7,9,10,12:1:16,20 S @("k"_k)=$P(^(i),"@",k)
 .I $D(@(BSR_"(BST,""Key"",i,1)"))  S l1=@$ZR,l2=$G(^(2)) I l1'="" S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"RTR",i+2,5)=l1,^(5,1)=l2,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,5),"@",16)=0
 .I $D(@(BSR_"(BST,""Key"",i,3)"))  S l1=@$ZR,l2=$G(^(4)) I l1'="" S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",i+2,5)=l1,^(5,1)=l2,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,5),"@",8)=0
 .I $D(@(BSR_"(BST,""Key"",i,5)"))  S l1=@$ZR,l2=$G(^(6)) I l1'="" S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i+2,5)=l1,^(5,1)=l2,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,5),"@",13)=0
 .K KK F k=10:1 Q:'$D(@(BSR_"(BST,""Key"",i,k)"))  S KK(k)=^(k),KK(k,1)=$G(^(k,1)),KK(k,2)=$G(^(2))
 .S BSk(i)=1,$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,2),"@",15)=k6,$P(^(3),"@",15)=k15,$P(^(4),"@",10)=k10,$P(^(4),"@",15)=k5,$P(^(2),"@",14)=k7
 .S $P(^(8),"@",15)=k2,$P(^(6),"@",15)=k1,$P(^(7),"@",15)=k4,$P(^(5),"@",15)=k3,$P(^(9),"@",15)=k12 I k9'="" S $P(^(1),"@",15)=k9
 .D KK
EDIT D EDI G RES
KK S k="",$P(^(5),"@",13)=k13,$P(^(5),"@",14)=k14,$P(^(5),"@",20)=k20
 F  S k=$O(KK(k)) Q:k=""  D  S $P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,k),"@",15)=KK(k),^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i+2,k)=KK(k,1),^(k,1)=KK(k,2),$P(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i+2,k),"@",13)=0
 .F ij=1:1:11 I '$D(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),ij,k)) S ^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),ij,k)=$G(^%ZAPM.bs.BSS("Key0",ij,k),^%ZAPM.bs.BSS("Key0",ij,9))
 K KK Q
BF K ^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),BSd,BSk S BSt1="Key0",BSr1="^%ZAPM.bs.BSS",BSr2="^%ZAPM.bs.BSbufB",BSt2="@K"_$G(%BS(3),$P)_$J_"u"_%BS(15) D COPY
 F jj=2,4,5 S $P(@(BSr2_"(BSt2)"),"@",jj)=""
 Q
COPY S %zT=$ZT,$ZT="ERCOPY^%ZAPM.bs.BSTK"
 K @(BSr2_"(BSt2)") I $P($ZV,"Version ",2)'<4 M @(BSr2_"(BSt2)")=@(BSr1_"(BSt1)") Q
 I $D(@BSr2)["0" S:$D(@BSr1)=11 @BSr2=@BSr1
 S j=BSr1_"(BSt1)",ls="КОПИ..."_BSr1_","_BSt1_" В "_BSr2_","_BSt2_"..." D WAITS^%ZAPM.bs.BSF2 I $D(@j) S jj=$P($ZR,")")_",",@(BSr2_"(BSt2)")=@j
 F  S j=$ZO(@j) Q:j'[jj  S @(BSr2_"(BSt2,"_$P(j,jj,2,9))=@j X $G(WA)
 Q
ERCOPY S ls=$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 S $ZT=$G(%zT),YES=0 Q
TRDEV N vor U %DEV S vor="]" ;4.;=$S($P($ZV,"Version ",2)<4:"]",1:"|")
 W:$D(@(TRe1_")"))'["0" (TRe1_")"),!,@(TRe1_")"),! U 0 W "." S j=TRe1_")",jj=$S(TRe1[vor:$P(TRe1,vor,2,99),1:$P(TRe1,"^",2,99))_","
 U %DEV F  S j=$ZO(@j) Q:$S(j[vor:$P(j,vor,2,99),1:j)'[jj  W j,!,@j,!
 U 0 Q
TREE K:'$D(NOKILLER) @(TRe2_")") I $P($ZV,"Version ",2)'<4 M @(TRe2_")")=@(TRe1_")") Q
 S:$D(@(TRe1_")"))'["0" @(TRe2_")")=@(TRe1_")") S ls="Копи..."_TRe1_" В "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2 S j=TRe1_")",jj=$S(TRe1["]":$P(TRe1,"]",2,99),1:$P(TRe1,"^",2,99))_","
 F  S j=$ZO(@j) Q:$S(j["]":$P(j,"]",2,99),1:j)'[jj  S @(TRe2_","_$P(j,jj,2,9))=@j X $G(WA)
 Q
TRE K:'$D(NOKILLER) @TRe2 I $P($ZV,"Version ",2)'<4 M @TRe2=@TRe1 Q
 S:$D(@TRe1)'["0" @TRe2=@TRe1 S ls="Коп.мас..."_TRe1_" В "_TRe2_"..." D WAITS^%ZAPM.bs.BSF2 S j=TRe1,jj=$S(TRe1["]":$P(TRe1,"]",2,99),1:$P(TRe1,"^",2,99))_"("
 F  S j=$ZO(@j) Q:$S(j["]":$P(j,"]",2,99),1:j)'[jj  S @(TRe2_"("_$P(j,jj,2,9))=@j X WA
 Q
EDI D SI^%ZAPM.bs.BSN N (%BS,vl)
 S BST=$S($D(^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15))):"@K"_$G(%BS(3),$P)_$J_"u"_%BS(15),1:"K"_$G(%BS(3),$P)_$J_"u"_%BS(15)) F k=1:1:9 S @("k"_k)=1
 S BSR="^%ZAPM.bs.BSbufB" D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
 Q
RES I $D(CHUr) S BSR=CHUr,BST=CHUt K CHUt,CHUr
 S %zT=$ZT,$ZT="E1^%ZAPM.bs.BSTK" G REE
 S $ZT=$G(%zT)
RE 
REE F i=2:1:11 I $P($G(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,2)),"@",15)'="" I $D(BSk(i-2)) S BSk(i-2)=0
 K k0,Hidden
 K @(BSR_"(BST,""Key"")") S $ZT=$G(%zT),f="RTR" F k=0:1:6,10,12:1:16 K @("k"_k)
 ;ИЗ ТАБЛИЦЫ ОПИСАНИЯ В КЛЮЧИ
 F i=2:1:11 I $P($G(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,2)),"@",15)'="" S k0=i,k6=$P(^(2),"@",15),k7=$P(^(2),"@",14) D
 .S k15=$P(^(3),"@",15),k10=$P(^(4),"@",10),k2=$P(^(8),"@",15),k1=$P(^(6),"@",15),k3=$P(^(5),"@",15),k16=$P(^(5),"@",16),k4=$P(^(7),"@",15)
 .S k5=$P(^(4),"@",15),k14=$P(^(5),"@",14),k13=$P(^(5),"@",13),k12=$P(^(9),"@",15),k20=$P(^(5),"@",20),k9=$P(^(1),"@",15)
 .F k=10:1 Q:'$D(^(k))  S zr=$ZR,l1=@$ZR I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i,k)) S l2=@$ZR,l3=$G(^(k,1)),@(BSR_"(BST,""Key"",i-2,k)")=$P(l1,"@",15),^(k,1)=l2,^(2)=l3 I @zr
 .S $P(@(BSR_"(BST,""Key"",i-2)"),"@")=k1 F k=2:1:7,9,10,12:1:16,20 S $P(@$ZR,"@",k)=@("k"_k)
 .I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"RTR",i,5)) S l1=@$ZR,l2=$G(^(5,1)),@(BSR_"(BST,""Key"",i-2,1)")=l1,^(2)=l2
 .I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"FTR",i,5)) S l1=@$ZR,l2=$G(^(5,1)),@(BSR_"(BST,""Key"",i-2,3)")=l1,^(4)=l2
 .I $D(^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15),"COL",i,5)) S l1=@$ZR,l2=$G(^(5,1)),@(BSR_"(BST,""Key"",i-2,5)")=l1,^(6)=l2
 I $D(k0),($P(@(BSR_"(BST)"),"@",17)<2) S $P(@$ZR,"@",17)=2
END K ^%ZAPM.bs.BSbufB("K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),^%ZAPM.bs.BSbufB("@K"_$G(%BS(3),$P)_$J_"u"_%BS(15)),k0,k1,k2,k3,k4,k5,k6,k10,k12,k16,k,k15,BSk,BSd,kk S $ZT=$G(%zT) Q
ER S ls=" ОШИБКА В ИМЕНИ ТАБЛИЦЫ ИЛИ РАЗДЕЛА ! "_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 G D
E1 S ls=" ОШИБКА В ИМЕНИ БАЗЫ ДАННЫХ ! "_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7
YES S ls=" Продолжим корректировать описание Ключей и Базы данных ? " D YES^%ZAPM.bs.BSF I YES G EDIT
 S $ZT=$G(%zT) Q
]]></Routine>


<Routine name="%ZAPM.bs.BSTM" type="MAC" languagemode="0"><![CDATA[
%BSTM ;ДВИЖЕНИЕ МАРКЕРА ПО ТАБЛИЦЕ ; 13:41   15.04.2003
B D TIP^%ZAPM.bs.BST,KLE I $D(END) D R^%ZAPM.bs.BSF G 1000^%ZAPM.bs.BSF
 S MR=1 D CL^%ZAPM.bs.BSF4
0 I $D(EXITout) G END^%ZAPM.bs.BSF
 I $D(Refresh) D TIP^%ZAPM.bs.BST,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST K Refresh ;```
  D W W $$atr^%ZAPM.bs.BS3(0) X $G(MR23),$G(MR24),$G(MR25),$G(%Cu)
1 F  R *R:0 E  Q
 I $D(Refresh) D W^%ZAPM.bs.BST K Refresh D W
 W $$rt^%ZAPM.bs.BS3(+%BS(2)) I $D(PredOb) D Pred^%ZAPM.bs.BSF12(PredOb) I R1<0 G 0:R1=-2,END^%ZAPM.bs.BSF:R1=-3,LE:R1=-4
 i R1=32 s R1=0,R2=82 ;ins
2 I R1=27 K % D  G:$G(%FK,1)'=1&(R2=79) @%FK G 101:'$G(%FK)&(R2=R3),0:$G(%,27)=27,^%ZAPM.bs.BSF
 .K %HO,%EN I R2=91 D  Q
 ..I $D(Ukaz) D UKA^%ZAPM.bs.BSF8 Q
 ..I R3=67 S m=MX,M1=$O(BX(MX)),MR=0 D WO D:M1=""  S MX=M1,MR=1 S:m=MX&(ke=1) MY=$O(BY(""),-1) Q  ;-->
 ...S M1=MX I $O(@(BSR_"(BST,ny,nx)"))'="" S BSX(BS0)=BSX(BS0)+1,Mx=$O(BX($O(BX("")))),MXx=BX(MX) D GW^%ZAPM.bs.BST S M1=$O(BX(""),-1),Mx=0 K MXx
 ..I R3=68 I nx=$P($G(%TIT,"1,1"),",",2),'$D(%TIT),ke=1  S MR=0 D WO S MR=1,MY=$O(BY("")) Q
 ..I R3=68 Q:nx=$P($G(%TIT,"1,1"),",",2)  S M1=$O(BX(MX),-1),MR=0 D WO D:M1=""  S MR=1,MX=M1 Q
 ...I $P(B,"@",24) D PgLt^%ZAPM.bs.BSF9 S M1=MX Q  ;!!!!!!!!
 ...S BSX(BS0)=BSX(BS0)-1,Mx=-1 D GW^%ZAPM.bs.BST S Mx=0,M1=$O(BX("")) Q
 ..I R3=66 S M1=$O(BY(MY)),MR=0 D WO D:M1=""  S MY=M1,MR=1 Q
 ...S M1=MY I $O(@(BSR_"(BST,ny)")) S BSY(BS0)=BSY(BS0)+1,My=$O(BY($O(BY("")))),MYy=BY(MY) D VW^%ZAPM.bs.BST S M1=$O(BY(""),-1),My=0 K MYy I '$D(BX(MX)) S M2=MX,MX=$O(BX(MX)) I MX="" S MX=$O(BX(M2),-1)
 ..I R3=65 Q:ny=$P($G(%TIT,1),",")  S M1=$O(BY(MY),-1),MR=0 D WO D:M1=""  S MR=1,MY=M1 Q
 ...I $P(B,"@",24) D PgUp^%ZAPM.bs.BSF9 S M1=MY Q  ;!!!!
 ...S BSY(BS0)=BSY(BS0)-1,R1=1,My=-1 D VW^%ZAPM.bs.BST S My=0,M1=$O(BY("")) I M1="" S ls=" СРОЧНО СДЕЛАЙТЕ РЕМОНТ ТАБЛИЦЕ !!! F6 " D O^%ZAPM.bs.BSF7
 ...I '$D(BX(MX)) S M2=MX,MX=$O(BX(MX)) I MX="" S MX=$O(BX(M2),-1)
F1 .I R2=79,(R3=80) S IYI=$P(BS,"@",20) S:IYI=""!(IYI["##") IYI=$P(B,"@",39) S:IYI="" IYI="^%ZAPM.bs.BSHLP,%BS-PC" D NE^%ZAPM.bs.BSN Q
 .I R2=79!(R2=-1) Q:'$G(%FK)  S:R3=-1 R3=89 D  Q  ;F-клавиши
 ..I R3>79&(R3<90) S %B=R3-79,OOO="^%ZAPM.bs.BS",OO=1 D  D:'$D(%DIA) DARK^%ZAPM.bs.BSF6 W /CUP(24,1) D ^%ZAPM.bs.BSB W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) D CL^%ZAPM.bs.BSF4 W /CUP(24,1) S %=R1 K Dark Q
 ...S Dark(1,1)=" 0 0 0 0 0 0 0 0" N z
 ...I $E(%BS(1),17)=2 D DF6 F z=3,4,5 S $P(Dark(1,1)," ",z+1)="1"
 ...I $E(%BS(1),17)=3 D DF6 F z=3,4,5,8 S $P(Dark(1,1)," ",z+1)="1"
 ...I $E(%BS(1),9)=3 S $P(Dark(1,1)," ",3)="1"
 I R1=8 S R1=27 G END^%ZAPM.bs.BSF ;BACKSPACE
 I R1=9 D TAB^%ZAPM.bs.BST5 G 0
 I R1=28 D CALK^%ZAPM.bs.BSSR G:YES LE G 0
 I R1=12,R2=-1 D SSS^%ZAPM.bs.BSF12 G 0
 I R1=0,R2=15 D STAB^%ZAPM.bs.BST5 G 0
 I R1=0,R2=18 S li=d G LE ; Alt-E Ctrl-E
 I (R1=0&&(R2=33))||(R1=6) D  G 1  ;alt-f  ctrl=f  возвращение функциональных клавишь
 .I '$D(%fk) S (%fk,%FK)=1 Q
 .K %fk S %FK=$P(@BSR@(BST),"@",15) K:%FK="" %FK
SF1 I R1=0,(R2=139!(R2=140)!(R2=84)!(R2=88)) D AltKey^%ZAPM.bs.BSF8 G 0
 I R1=0,R3=-1,("85/86/87"[R2),$L(R2)=2 D Shift^%ZAPM.bs.BSF8(R2) G 0 ;F2,F3,F4 ЮЗЕРСКИЕ
 I R1=0,R2=31 S LineEdit=1,li=d G LE ;Alt-s Ctrl-D
 I R1=0,R2=46 G 0:BST'["@" D OUT^%ZAPM.bs.BSS1 G 0
 I R1=0,"48,47,20"[R2,R2?2N D CON I  G E11^%ZAPM.bs.BSF1:R2=48,E161^%ZAPM.bs.BSF1:R2=47,E21^%ZAPM.bs.BSF1:R2=20
 I R1=0,R2=38 G E141^%ZAPM.bs.BSF1:BST["@",LOS^%ZAPM.bs.BSF6:$D(^%ZAPM.bs.BSbufB("LOGS"_$G(%BS(3),$P)_$J_$P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_"u"_%BS(15))) D CON G 1
 I R1=0,R2=109 D BUF^%ZAPM.bs.BSF3 G 0
 I R1=0,R2=24 G ^%ZAPM.bs.BSS
 I R1=0,R2=21 G FIDD^%ZAPM.bs.BSS ;ПОИСК ПО БАЗЕ ДАННЫХ 
 I R1=0,R2=25 S fi=nx G FIND^%ZAPM.bs.BSS
 I R1=0,R2=110 S fi=nx_",DFLT,0,1,1" G FIND^%ZAPM.bs.BSS
 I R1=0,R2=90 G ShiftF7^%ZAPM.bs.BSS
 I R1=0,R2=131 D CALK^%ZAPM.bs.BSSR G:YES LE G 0
 I R1=0,R2=113,$E(%BS(1),3),'$E($G(%BS(14)),4) D CM^%ZAPM.bs.BSF6 G 0
 I R1=0,R2=105 K %GO D DOAF2^%ZAPM.bs.BSN G:$D(%GO) @%GO G 0
 I R1=0,R2=44,BST["@" G 42^%ZAPM.bs.BSF
INS I R1=0,R2=82 D  S %DIA=1,$P(@(BSR_"(BST)"),"@",3)=1,$P(@(BSR_"(BST,ny,nx)"),"@",12)=$S($P(BS,"@",12):"",1:1) G:'%BS(5) 0 S BS=@$ZR,MR=0 D WO S MR=1,R1=27,R2=91,R3=$S(%BS(5)=1:66,%BS(5)=2:67,1:R3) G 2
 .S %DIA=$$GetLock^%ZAPM.bs.BSXfun(),$E(%DIA)=($E(%DIA)=0) D SetLock^%ZAPM.bs.BSXfun(%DIA)
 I R1=0,R2=162 D I^%ZAPM.bs.BSGLOB(BSR,BST,ny,nx,d) S R2=82 G INS
 I R1=0 D  G 0
 .I R2=71 S %HO=$S('$D(%HO):1,%HO=1:2,%HO=2:3,1:1) D  ;HOME
 ..I $D(Ukaz),%HO<3 D HO^%ZAPM.bs.BSF8 Q
 ..I %HO=1 S MX=$O(BX("")) S MR=0 D WO S MR=1 Q
 ..I %HO=2 S MR=0 D WO S MY=$O(BY("")),MX=$O(BX("")),MR=1 Q
 ..I %HO=3 S BSY(BS0)=$P($G(%TIT,1),","),BSX(BS0)=$P($G(%TIT,"1,1"),",",2) D  Q
 ...I $ZV["Cach"||($ZV["IRIS") D TIP^%ZAPM.bs.BST,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST Q
 ...D TW^%ZAPM.bs.BST,KLE Q
 .I R2=79 S %EN=$S('$D(%EN):1,%EN=1:2,%EN=2:3,1:1) D  ;END
 ..I $D(Ukaz),%EN<3 D EN^%ZAPM.bs.BSF8 Q
 ..I %EN=1 D DNX S MR=0 D WO S MR=1,MX=M1 Q
 ..I %EN=2 D DNY S MR=0 D WO S MR=1,MY=M1 Q
 ..I %EN=3 D REND^%ZAPM.bs.BSF2,DEND^%ZAPM.bs.BSF2,END^%ZAPM.bs.BS1 S BSY(BS0)=es,BSX(BS0)=ek D TW^%ZAPM.bs.BST,KLE Q
 .I R2=132!(R2=22) S BSY(BS0)=$P($G(%TIT,1),",") D TW^%ZAPM.bs.BST,KLE Q
 .I R2=118!(R2=49) D DEND^%ZAPM.bs.BSF2,ENDS^%ZAPM.bs.BS1 S BSY(BS0)=es D TW^%ZAPM.bs.BST,KLE Q
 .I R2=73!(R2=152)!(R2=23) D PgUp^%ZAPM.bs.BSF9 Q
 .I R2=81!(R2=160)!(R2=50) S t1=BSY(BS0) D DNY S BSY(BS0)=BY(M1) Q:t1=BSY(BS0)  D VW^%ZAPM.bs.BST,KLE Q  ;PgDn
 .I R2=157!(R2=37)!(R2=116) S t1=BSX(BS0) D DNX S BSX(BS0)=BX(M1) Q:t1=BSX(BS0)  D GW^%ZAPM.bs.BST,KLE Q  ;->
 .I R2=155!(R2=36)!(R2=115) D PgLt^%ZAPM.bs.BSF9 Q
 I R1=13,$P(BS,"@",14)'="" S l4=14 D NEW^%ZAPM.bs.BSN K l4 G:'(R1'=27&(li'="")) 0 W $$atr^%ZAPM.bs.BS3(0) D W G 1:$D(%ZAP),1:$P(BS,"@",5)=1 I 1 D:'$D(%w(5)) PASD^%ZAPM.bs.BST1 G 1:'$T S YES=1 G LEE
 I R1=13,'$G(%FK) G 101
 I R1=-1,%BS(13)="%BS-PC" G 0:$ZV["Cach"||($ZV["IRIS")  D GLUC^%ZAPM.bs.BSXgluc G 0
 I R1=43 G PL^%ZAPM.bs.BSF5
 I R1=45 G MI^%ZAPM.bs.BSF5
 I R1=127,(R2=R3) G 1:$D(%ZAP),1:$P(BS,"@",5)=1 D  G 0
 .I '$D(%w(5)) D PASD^%ZAPM.bs.BST1 E  Q
 .D Yes^%ZAPM.bs.BSXfun("Удаляем данные клетки {"_ny_","_nx_"} ?") Q:YES<1
 .D R^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))) I LOC D MED^%ZAPM.bs.BSF S i=ny,j=nx I $D(@BSR@(BST,ny,nx)) D DEL^%ZAPM.bs.BSF1,D^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))) D:$D(%CAL) CALC^%ZAPM.bs.BSF3
 G:R1<32 1 S li=$C(R1) I $P(B,"@",40)'="" S fi=$P(B,"@",40),finl=li G FIND^%ZAPM.bs.BSS
LE G 1:$D(%ZAP) I $P(BS,"@",5)=1 S ls=" Ввод Запрещен " D WAITS^%ZAPM.bs.BSF2 W $$bel^%ZAPM.bs.BS3 G 1
 I '$D(%w(5)) D PASD^%ZAPM.bs.BST1 E  G 1
 D HIS^%ZAPM.bs.BSF1("DAT")
 I $P(BS,"@",21) D BAR^%ZAPM.bs.BSF7(+$P(BS,"@",21),$P($P(BS,"@",21),",",2)) G LEE
 I $P(B,"@",26)["," D BAR^%ZAPM.bs.BSF7(+$P(B,"@",26),$P($P(B,"@",26),",",2)) G LEE
 I $P(B,"@",26)!($D(LineEdit)) S ls="Коppектиpуете значение клетки",lon=$S($P(BS,"@",9)=1:200,1:509) D LE^%ZAPM.bs.BSTT X "I 1" K LineEdit
 E  S li=$$Edit^%ZAPM.bs.BSXuse(li,($P(BS,"@")+1-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0)),($P(BS,"@")-BS1+BSY1(BS0)+$P(BS,"@",3)),($P(BS,"@",2)-BS2+BSX1(BS0)+$P(BS,"@",4)),"@")
LEE G:'YES 0 I li'="" K R1 D  G M:$D(R1),LE
 .I $P(BS,"@",16)'="" K %0 S %zT=$ZT,$ZT="ERRTR^%ZAPM.bs.BSTM",YES=1,(d,d0)=li K ls D  S:YES li=$G(%0,li) I 'YES S ls=$G(ls,"СИНТАКСИЧЕСКАЯ ОШИБКА ") D O^%ZAPM.bs.BSF7 K R1 Q
 ..I '$P(BS,"@",16) X $G(@BSR@(BST,"RTR",ny,nx)) S $ZT=$G(%zT) Q
 ..X $G(@(BSR_"(BST,""RTR"","_$P(BS,"@",16)_")")) S $ZT=$G(%zT)
 .I li["@" S ls=" Запрещенный Символ @ " D O^%ZAPM.bs.BSF7 Q
 .D SetCell(ny,nx,li) D:$D(%CAL) CALC^%ZAPM.bs.BSF3 S R1=1 Q
 G 0
SetCell(ny,nx,li) 
 I $P(BS,"@",9)=1 D L^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))),MED^%ZAPM.bs.BSF D  D U^%ZAPM.bs.BS3($NA(@BSR@(BST,ny,nx))) Q
 .S $P(@(BSR_"(BST,ny,nx)"),"@",15)=li
 E  S $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1,^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx)=li Q
 Q
M G:'POSt 0 S MR=0,BS=@BSR@(BST,BY(MY),BX(MX))
 D WO S MR=1,R1=27,R2=91,R3=$S(POSt=1:66,POSt=2:67,1:R3) G 2
W S BS=$G(@(BSR_"(BST,"_BY(MY)_","_BX(MX)_")")) //$G(
WO S ny=BY(MY),nx=BX(MX)
WG S CLR=$S($P(BS,"@",10):$P(BS,"@",10),1:COLOR) I $E(%BS(1),19) S CLR=$P(%BS,"!",$E(%BS(1),19))
 I $P(BS,"@",12) S CLR=$P(%BS,"!",3)
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),ny,nx))
 I $P(BS,"@",8)'="" S %zT=$ZT,$ZT="FTRe^%ZAPM.bs.BSTM" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .I '$P(BS,"@",8) X $G(@(BSR_"(BST,""FTR"",ny,nx)")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")"))
w W $$atr^%ZAPM.bs.BS3($S('MR:CLR,1:$P(%BS,"!",$S($P(BS,"@",12):1,1:2))))
 S l=$P(BS,"@",3)*$P(BS,"@",4) F BSF=1:1:$P(BS,"@",3) Q:($P(BS,"@")+BSF-BS1)>BSY2(BS0)  D  W $E(d1_$J("",l),BSF*$P(BS,"@",4)-$P(BS,"@",4)+1,$P(BS,"@",4)+($P(BS,"@",4)*(BSF-1)))
 .W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0)))
 W $$atr^%ZAPM.bs.BS3($S(MR:CLR,1:$P(%BS,"!",2))) Q
DNX S M1=$O(BX(""),-1) Q
24 W /CUP(24,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) Q
25 W /CUP(25,1),$$atr^%ZAPM.bs.BS3(0),/EL(0) Q
KL W /CUP(($P(BS,"@")+BSF-BS1+BSY1(BS0)),($P(BS,"@",2)-BS2+1+BSX1(BS0))),$$atr^%ZAPM.bs.BS3(0) Q
DNY S M1=$O(BY(""),-1) Q
DF6 N z F z=2:1:7,10 S $P(Dark(1,1,6)," ",z+1)="1"
 Q
CON Q:BST["@"  S ls=" УСТАНОВИТЕ РЕЖИМ КОРРЕКЦИИ ОПИСАНИЯ ТАБЛИЦЫ <F4> " G O^%ZAPM.bs.BSF7
MR23 W /CUP(23,1),/EL(0) W:$P(BS,"@",7)'="" "ВЫЧ" W:$P(BS,"@",8)'="" /CUP(23,5),"ТРАН" W:$P(BS,"@",6)'="" /CUP(23,10),"d",$P(BS,"@",6) W /CUP(23,14),$S($P(BS,"@",9)=1:"О.Т",1:"Б.Д") W:$P(BS,"@",5)=1 /CUP(23,19),"ЗАПР"
 W /CUP(23,24),$P(BS,"@",3),"x",$P(BS,"@",4) W:$P(BS,"@",13)'="" /CUP(23,30),"ЛОГ=",$S($P(BS,"@",11)=1:"НЕ",1:"ДА") W:$P(BS,"@",16)'="" /CUP(23,37),"СИНТ" W:$P(BS,"@",14)'="" /CUP(23,42),$S($P(BS,"@",14)?.N1",".N:"КОМ",1:"ТАБ")
 W:$P(BS,"@",17)'="" /CUP(23,46),"ДВЖ" W:$D(%DIA) /CUP(23,51),"Бл" W:$P(BS,"@",12) /CUP(23,52),"Л" W:$P($P(BS,"@",18),"#")'="" /CUP(23,54),$P($P(BS,"@",18),"#")
 W:$P($P(BS,"@",18),"#",2)'="" /CUP(23,58),"""",$P($P(BS,"@",18),"#",2),"""" W:$P(B,"@",24) /CUP(23,61),"ПОДЖ"
 W:$P(BS,"@",20)'="" /CUP(23,66),"F1" Q
MR24 D 24,RED W " {",ny,",",nx,"}" D 25 W $E(d,1,77) W:$E(d,77)'="" "..." Q
RED W:BST["@" $$atr^%ZAPM.bs.BS3("1;36;47")," РЕД ",$$atr^%ZAPM.bs.BS3(0) Q
MR25 D 24,RED W $E($$SS^%ZAPM.bs.BSF12(),1,79) D 25 W $E(d,1,79) Q
ERRTR S ls=$ZE D O^%ZAPM.bs.BSF7 Q
FTRe S $ZT=$G(%zT) W $$bel^%ZAPM.bs.BS3 G w
101 S MR=0 D WO W $$atr^%ZAPM.bs.BS3(0) G 10^%ZAPM.bs.BSF
KLE K END S R1=27,%BSTM=1 D:TIP'=7 24 I '$D(MY) S MY=$O(BY("")) D:MY=""  Q:$D(END)  S MX=$O(BX("")) D:MX=""  Q:MX=""
 .S ls=" !!! ПУСТАЯ ТАБЛИЦА !!!"_$S($G(%TIT):",ИЛИ КОНФЛИКТ ТИТУЛА И ВЫСОТЫ СТРОК",1:"") D O^%ZAPM.bs.BSF7 S END=1
 I '$D(BY(MY))!('$D(BX(MX))) K MY,MX G KLE
 I $D(Ukaz) S Na=1 D TA^%ZAPM.bs.BSF8
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSTREE" type="MAC" languagemode="0"><![CDATA[
%BSTREE(G) ;пpогpамма РАБОТЫ С ДЕРЕВОМ ГЛОБАЛЕЙ ; 15:05 21-OCT-98
 Q:'$$Data^%ZAPM.bs.BSF12(G)  N (%BS,G)  S BSR="^%ZAPM.bs.BSVOL",BST="TREE"
 S %BS("Tmp","Tree")=G D ^%ZAPM.bs.BST
 Q
T() ;ТРАНСФОРМАЦИЯ
 N G,a,n s n=65 Q:ny=3 ""
 S G=$$SS(ny=1!(ny=2)) Q:G="" ""
 S ii=$D(@G)
 s a=G i $l(a)>n s a="..."_$e(a,$l(a)-n,$l(a))
 Q $J(ii,2)_" "_a_$S(ii["0":"",1:"="_$$CTRL^%ZAPM.bs.BSChT(@G))
EDIT ;РЕДАКТИРОВАТЬ УЗЕЛ
 N G,S,i
 S G=$$SS(ny=1!(ny=2))
 S i=$D(@G),ii=$G(@G)
 i $TR(ii,$C(127,5),"")'=ii s ii=$TR(ii,$C(127,5),$c(174,169))
 S S=$$LineEdit^%ZAPM.bs.BSXfun(ii,G_"="_$S(i["0":"НЕОПРЕДЕЛЕНО",ii="":"ПУСТО",1:"")) Q:YES<1
 i $tr(S,$c(174,169))'=S  s S=$tr(S,$c(174,169),$c(127,5))
 I i["0",S="" D Yes^%ZAPM.bs.BSXfun("ВЫ ХОТИТЕ ВВЕСТИ ПУСТОЕ ЗНАЧЕНИЕ ?") Q:YES<1
 S @G=S
 Q
 /* .// //i $tr(%S,$c(127,5))'=%S s %S=$tr(%S,$c(127,5),$c(174,169))
 .i $TR(ii,$C(127,5),"")'=ii s ii=$TR(ii,$C(127,5),$c(174,169))
 .S S=$$LineEdit^%ZAPM.bs.BSXfun(ii,txt) Q:YES<1
 .i $tr(S,$c(174,169))'=S  s S=$tr(S,$c(174,169),$c(127,5))
 */
SS(A) N ii,i,G
 Q:'$D(BSD) ""
 S G=BSD
 I $D(%KEYS) F ii=1:1:%KEYS Q:'$D(%KEYS(ii))  S G=$NA(@G@(%KEYS(ii)))
 I $G(A) Q $NA(@G)
 Q $NA(@G@(d))
]]></Routine>


<Routine name="%ZAPM.bs.BSTT" type="MAC" languagemode="0"><![CDATA[
%BSTT ;АРМы,ТРАНСФОРМАЦИЯ ТАБЛИЦ В ТЕКСТЫ ; 15:21   28.12.1999
 Q
MMLOAD(UM) ;ЗАГРУЗКА
 N BSR,BST,NS,NSOLD
 S NS=$G(@UM@("NS")),NSOLD=$$ZU^%ZAPM.bs.BS3(0) D  I $$ZU^%ZAPM.bs.BSF4($P(NSOLD,",",1),$P(NSOLD,",",2)) Q
 .I NS'=0,NS'="",'$$ZU^%ZAPM.bs.BSF4($P(NS,",",1),$P(NS,",",2)) Q
 .I $G(@UM@("CMD"))'="" D  Q
 ..S $ZT="ERMMCMD^%ZAPM.bs.BSTT"
 ..X @UM@("CMD") Q
 .I $G(@UM@("USPT"))'="" D  Q
 ..S BSR=$P(@UM@("USPT"),"(",1),BST=$QS(@UM@("USPT"),1) D ^%ZAPM.bs.BST
 .D ErrMsg^%ZAPM.bs.BSXfun("ЗАГРУЖАТЬ НЕЧЕГО !")
 Q
ERMMCMD D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE))
 Q
MMLOOP(UM) ;ЦИКЛ ПО МЕНЮ
 N TM,BSR,BST,I,II,III,MLevel
 I $QL(UM)=KolKeyS D MMLOAD(UM) Q
 I $O(@UM@(""))="" D ErrMsg^%ZAPM.bs.BSXfun("ПУНКТ ПУТОЙ !") Q
 I $D(@UM@("*","NS")) D MMLOAD($NA(@UM@("*"))) Q
 I $D(@UM@("*","*","NS")) D MMLOAD($NA(@UM@("*","*"))) Q
 I $D(@UM@("*","*","*","NS")) D MMLOAD($NA(@UM@("*","*","*"))) Q
 I $D(@UM@("*","*","*","*","NS")) D MMLOAD($NA(@UM@("*","*","*","*"))) Q
 S TM=$$TMPG^%ZAPM.bs.BSF11,BSR=$P(TM,"("),BST=$QS(TM,1) D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSVOL(""MenuPatt"")",TM)
 S I="",II=4,III=@TM@(4,1) F  S I=$O(@UM@(I)) Q:I=""  I I'["@" S @TM@(II,1)=III,$P(@$ZR,"@",15)=I,II=II+1
 S @TM@("AF2")="^%ZAPM.bs.BSS,ALTF2",$P(@TM,"@",39)="^%ZAPM.bs.BSHLP,MAIN",$P(@$ZR,"@",41)="AF10^%ZAPM.bs.BSF12"
 D TAB^%ZAPM.bs.BSF1 S MLevel=$QL(UM)
MMLOO D STA^%ZAPM.bs.BST
 I R1=27!(R1=13&(ny=3)) K @TM Q
 I R1=13&(ny'=3) D MMLOOP($NA(@UM@(d))) G MMLOO
 G MMLOO
MMENU(U) ;ВЫЗОВ ГЛАВНОГО МЕНЮ
 N BM,i,KolKeyS
 S BM=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""MainMenu"")"),KolKeyS=$O(^%ZAPM.bs.BSVOL("MainMenu","KEY",""),-1)
 I '$$Data^%ZAPM.bs.BSF12(BM) D ErrMsg^%ZAPM.bs.BSXfun("НЕ ДОСТУПНА БД ГЛ.МЕНЮ") Q
 I '$D(@BM@(U)) D ErrMsg^%ZAPM.bs.BSXfun("НЕ СУЩЕСТВУЕТ УЗЛА ! "_$ZR) Q
 D MMLOOP($NA(@BM@(U)))
 Q
ARM(i) ;i="T,P,U,S-Y-X"
       ;Y=1 - ОБЯЗАТЕЛЬНО ЗАПУСКАТЬ В ЯВНО СМОНТИРОВАННОМ ТОМЕ S КИПЕ U
       ;X- MUMPS КОД ЗАПУСКА ПРИЛОЖЕНИЯ
 I $P(i,"-",2) S uci=$P($P(i,"-"),",",3,4) D %GU^%ZAPM.bs.BSF4 I 'YES Q
 I $P(i,"-",3,999)'="" X $P(i,"-",3,999) Q
 S BSR="^["""_$P(i,",",3)_""","""_$P($P(i,"-"),",",4)_"""]"_$P(i,",",2),BST=$P(i,",") D ^%ZAPM.bs.BST
 Q
ABUTZ Q  ;ПУСТО
ABUT ;КНОПКА
 N A,S
 I $P(^%ZAPM.bs.BSS("ARMB",6,1),"@",15) S $P(^%ZAPM.bs.BSS("ARMB",6,1),"@",15)=0,A=0
 E  S $P(^%ZAPM.bs.BSS("ARMB",6,1),"@",15)=1,A=1
 S S=$P(^%ZAPM.bs.BSS("ARMB",10,3),"@",15),$P(S,"-",2)=A,$P(^%ZAPM.bs.BSS("ARMB",10,3),"@",15)=S
 Q
ATAB ;ПАРАМЕТРЫ
 N I
 F I=1:1:4 S $P(^%ZAPM.bs.BSS("ARMB",I,3),"@",15)=$P($P(%BS("Tmp","Butt77",1),"-"),",",I)
 S $P(^%ZAPM.bs.BSS("ARMB",6,1),"@",15)=+$P(%BS("Tmp","Butt77",1),"-",2)
 S $P(^%ZAPM.bs.BSS("ARMB",8,3),"@",15)=$P(%BS("Tmp","Butt77",1),"-",3,99)
 S IYI="^%ZAPM.bs.BSS(ARMB" D NE^%ZAPM.bs.BSN
 S li=d,R1=13
 Q
XEC(i) ;i=КОМАНДА
 S %zT=$ZT,$ZT="XECERR^%ZAPM.bs.BSTT" X i Q
XECERR S $ZT=$G(%zT),ls="ОШИБКА ВЫЗОВА "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE) D O^%ZAPM.bs.BSF7 Q
EnterAR D ARM($G(@%BS("Tmp","BSD")@("5,4")))
 Q
SCREEN ;ЭКРАННОЕ РЕДАКТИРОВАНИЕ БЛОКА
 N X1,X2,Y1,Y2,i,j,L,l,H,h,m,LL,%GO,Err,YES,Ox,Oy,%JB,WA,WAI,LOC,jj,ls,l1,l2
 S (X1,Y1)=800,(X2,Y2)=0,(i,j)="" F  S i=$O(BY(i)) Q:'i  F  S j=$O(BX(j)) Q:'j  I $P($G(@BSR@(BST,BY(i),BX(j))),"@",12) S:Y1>i Y1=i S:Y2<i Y2=i S:X1>j X1=j S:X2<j X2=j
 S i=Y2-1+$P($G(@BSR@(BST,BY(Y2),BX(X2))),"@",3),j=X2-1+$P($G(@BSR@(BST,BY(Y2),BX(X2))),"@",4)
 ;;;I Y1=1!(Y2=1)!(i=22)!(j=80) D ErrMsg^%ZAPM.bs.BSXfun("Помеченные Клетки вышли за границу") Q
 D SCREENK S ^%ZAPM.bs.BSbufB("ScreenEdit"_$G(%BS(3),$P))=@%BS(20)@("Screen"),$P(@$ZR,"@",8)=Y1,$P(@$ZR,"@",9)=X1,$P(@$ZR,"@",10)=i,$P(@$ZR,"@",11)=j
 S $P(@$ZR,"@")="Редактирование Блока" ;       !????!,$P(@$ZR,"@",38)=""
 S LL=1 F i=BY(Y1):1:BY(Y2)  S h=$P($G(@BSR@(BST,i,1)),"@",3) D
 .K L F j=BX(X1):1:BX(X2) S l=$P($G(@BSR@(BST,i,j)),"@",4),s=$$A^%ZAPM.bs.BSA(i,j) D
 ..F m=1:1:h S L(m)=$G(L(m))_$E(s,(l*(m-1))+1,(l*(m-1))+l)_$J("",l-$L($E(s,(l*(m-1))+1,(l*(m-1))+l)))
 .F m=1:1:h S ^%ZAPM.bs.BSbufB("ScreenEdit"_$G(%BS(3),$P),LL)=L(m),LL=LL+1
 d ^%ZAPM.bs.BSX("EDIT","^%ZAPM.bs.BSbufB","ScreenEdit"_$G(%BS(3),$P),"") Q:$G(%GO)'="Save"
 S LL=1 F i=BY(Y1):1:BY(Y2)  S h=$P($G(@BSR@(BST,i,1)),"@",3) D
 .S L=0,l1=1 F j=BX(X1):1:BX(X2) S l=$P($G(@BSR@(BST,i,j)),"@",4),BS=$G(@BSR@(BST,i,j)) K s D
 ..S l2=l1+l-1
 ..F m=1:1:h S s=$G(s)_$E($G(^%ZAPM.bs.BSbufB("ScreenEdit"_$G(%BS(3),$P),LL+m-1)),l1,l2)_$J("",l-$L($E($G(^%ZAPM.bs.BSbufB("ScreenEdit"_$G(%BS(3),$P),LL+m-1)),l1,l2)))
 ..S s=$$ClearSpc^%ZAPM.bs.BSF7(s) D SetCell^%ZAPM.bs.BSTM(i,j,s) S l1=l2+1
 .S LL=LL+h
 D SCREENK,W^%ZAPM.bs.BST Q
SCREENK K ^%ZAPM.bs.BSbufB("ScreenEdit"_$G(%BS(3),$P)) Q
TXTREST I '$D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,2)) S ls=" БУФФЕР ПУСТ " D O^%ZAPM.bs.BSF7 Q
 S ls="КОПИРУЮ ИЗ БУФЕРА" D WAITS^%ZAPM.bs.BSF2 N K S K=$P(@(BSR_"(BST)"),"@") K @$ZR S (B,@$ZR)=^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,2),$P(@$ZR,"@")=K
 F i=1:1 Q:'$D(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,2,i))  S @(BSR_"(BST,i)")=@$ZR
 Q
TXT D TXTSAVA,TXTREST D:$P(B,"@",8)>1 O(8,-1) D:$P(B,"@",9)>1 O(9,-1)
 D:$P(B,"@",10)<80 O(10,1) D:$P(B,"@",11)<22 O(11,1) S @(BSR_"(BST)")=B
 Q
O(p,pp) S $P(B,"@",p)=$P(B,"@",p)+pp Q
TXTSAVA S ls="ДЕЛАЮ БУФЕР ТЕКСТА" D WAITS^%ZAPM.bs.BSF2 N I,L,h,l,ST,d S bf=2 K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,bf) S @$ZR=B,$P(@$ZR,"@",30)="",$P(@$ZR,"@",17)=5,$P(@$ZR,"@",29)=($$LNG^%ZAPM.bs.BSF12-1)
 S ST=0 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  D TL F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  D TX(@$ZR,$S($P(@$ZR,"@",9)<2:$P(@$ZR,"@",15),1:$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j))))
 D TL S $P(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,bf),"@",28)=ST Q
TXTSAVB S ls="ДЕЛАЮ БУФЕР ТЕКСТА" D WAITS^%ZAPM.bs.BSF2 N I,L,h,l,ST,d S bf=0 K ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,bf) S @$ZR=""
 S ST=-1 F i=1:1 Q:'$D(@(BSR_"(BST,i)"))  D TL F j=1:1 Q:'$D(@(BSR_"(BST,i,j)"))  D TX(@$ZR,$S($P(@$ZR,"@",9)<2:$P(@$ZR,"@",15),1:$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j))))
 D TL S ^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,bf)="1@"_(ST+1)_"@0" Q
TX(S,d) S (d1,d0)=d
 I $P(S,"@",8)'="" S %zT=$ZT,$ZT="FFF^%ZAPM.bs.BST" D  S $ZT=$G(%zT)
 .I d0="" S d0=0
 .S ny=i,nx=j I '$P(S,"@",8) X $G(@(BSR_"(BST,""FTR"",i,j)")) Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(S,"@",8)_")"))
 S l=$P(S,"@",4) I '$D(h) S h=$P(S,"@",3)
 S d1=d1_$J("",l*h) F I=1:1:h S L(I)=$G(L(I))_$E(d1,I*l-l+1,l+(l*(I-1)))
 Q
TL K h Q:'$D(L)  S L="" F  S L=$O(L(L)) Q:L=""  S ST=ST+1,^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),4,bf,ST)=$E(L(L),1,509)
 K L Q
B1 S bf=1 G B
B2 S bf=2 G B
B3 S bf=3 G B
B4 S bf=4
B G RES^%ZAPM.bs.BSF2
TempT ;СОЗДАТЬ БУФЕРНЫЙ ТЕКСТ
 N T S T=$$TMPG^%ZAPM.bs.BSF11
 S BSr=$P(T,"("),BSt=$P($P($P(T,"(",2),")"),$C(34),2),t0=""
 D CR
 S se=0 Q
TempTX(t0) D CR Q  ;ЦИКЛ ПРИСВОЕНИЯ ТЕКСТА
TempTXT(Coment,Obraz) D CREAT Q  ;ЗАВЕРШИТЬ
TempTXTE ;ВОЙТИ В ТЕКСТ
 S IYI=BSr_"("_BSt D NE^%ZAPM.bs.BSN Q
TempTXDE ;УДАЛИТЬ ТЕКСТ
 K @BSr@(BSt) Q
CR ;СОЗДАНИЕ ТЕКСТА BSr,BSt
   ;t0-СОДЕРЖАНИЕ СТРОКИ
   ;NoKiTab=1 - НЕ УДАЛЯТЬ СТАРЫЙ ТЕКСТ
 I '$D(CReATe) K:'$D(NoKiTab) @(BSr_"(BSt)") S:$D(@BSr)["0" @BSr="BaSe MsW @" S CReATe=$$h^%ZAPM.bs.BS3(),se=0,WA=$G(WA) D:$D(NoKiTab)
 .F i=1:1 Q:'$D(@BSr@(BSt,i))  S se=i
 S se=se+1 S @(BSr_"(BSt,se)")=$E(t0,1,$$LNG^%ZAPM.bs.BSF12)
 Q
CREAT K CReATe,i,j,cl D  S $P(@BSr@(BSt),"@",17)=5,$P(@$ZR,"@",14)=$G(tIT) S:$D(Fk) $P(@$ZR,"@",15)=Fk S $P(@$ZR,"@",28)=se,$P(@$ZR,"@",29)="" S:$G(Coment)'="" $P(@$ZR,"@")=Coment K Coment Q
 .I $G(Obraz)'="" S @BSr@(BSt)=Obraz
 .I $D(Obraz) S Ob="" F  S Ob=$O(Obraz(Ob)) Q:Ob=""  S $P(@BSr@(BSt),"@",Ob)=Obraz(Ob)
CREATE D CREAT
CREA S BSR=BSr,BST=BSt K BSr,BSt,tIT,Fk,Obraz,Ob D ^%ZAPM.bs.BST Q
 ;
FTR S f="FTR" G TXTINF
FCL S f="FCL" G TXTINF
COL S f="COL" G TXTINF
RTR S f="RTR" G TXTINF
TXTINF S ls="ГЕНЕРАЦИЯ "_$$FORM(f) D WAITS^%ZAPM.bs.BSF2
 S BSR=$P($G(%KAT(1)),"!",2),BST=$P($G(%KAT(1)),"!",3)
 S t0="" D BBB,UUU I YES Q
 D CR S do="D TXTIN^%ZAPM.bs.BSTT X WA" D ALLT^%ZAPM.bs.BSS1 I $D(TotalSi) S t0="Список "_$$FORM^%ZAPM.bs.BSTT(f)_" завершен" D CR Q
 D CREAT S $P(@(BSr_"(BSt)"),"@")="Список "_$$FORM(f) D CREA Q
TXTIN S ny=i,nx=j K fff S ffff=" --//-- " I $D(@(BSR_"(BST,f,ny,nx)")) G TXTINN
 D  I $D(@(BSR_"(BST,f,"_nynx_")")) S ffff=" в "_nynx_" ",fff=@$ZR,fffff=0 I $D(@(BSR_"(BST,f,"_nynx_",1)")) S fff=@$ZR,fffff=1
 .S ff=$S(f="FCL":7,f="COL":13,f="FTR":8,f="RTR":16,1:999),nynx="0,0" I $P(@(BSR_"(BST,ny,nx)"),"@",ff)?.N1",".N S nynx=$P(@$ZR,"@",ff)
 G TXTINFF
TXTINN S fff=$G(@$ZR),fffff=0 I $D(@BSR@(BST,f,ny,nx,1)) S fff=$G(@$ZR),fffff=1,sum(f)=$g(sum(f))+1
TXTINFF Q:'$D(fff)  S t0="" D CR S t0=" {"_ny_","_nx_"} "_ffff_" "_$S(fffff:"ИСХ",1:"исп")_" --> "_fff D CR Q
FORM(f) Q $S(f="FCL":"формул вычисления",f="COL":"формул логического контpоля",f="FTR":"формул тpансфоpмации",f="RTR":"формул синтаксического контpоля на ввод",f="CMD":"вызовов команд M по <Enter>",f["14":"входов в ТАБЛИЦЫ по <Enter>",f["2)":"символьных имен вывода",1:"имен хранения в базе данных")
CMD S f="CMD" G TXTINF
BBB S BSr="^%ZAPM.bs.BSbufB" I $D(TotalSi) S BSt="TotalSummeryInfo",t0="Список "_$$FORM^%ZAPM.bs.BSTT(f) Q
 S BSt="INF"_f_$G(%BS(3),$P)_$J_"u"_$TR(BSR,",","")_"("_BST Q
TAB S f="S ff=$P(^(j),""@"",14)" G TXX
NAO S f="S ff=$P($P(^(j),""@"",18),""#"",2)" G TXX
NAX S f="S ff=""?"" I $P(^(j),""@"",9)'=1 S ff=$P($P(^(j),""@"",18),""#"")" G TXX
TXX S ls="ГЕНЕРАЦИЯ "_$$FORM(f) D WAITS^%ZAPM.bs.BSF2
 S BSR=$P($G(%KAT(1)),"!",2),BST=$P($G(%KAT(1)),"!",3)
 S t0="" D BBB,UUU I YES Q
 D CR S do="D TXXX^%ZAPM.bs.BSTT X WA" D ALLT^%ZAPM.bs.BSS1 I $D(TotalSi) S t0="Список "_$$FORM^%ZAPM.bs.BSTT(f)_" завершен" D CR Q
 D CREAT S $P(@(BSr_"(BSt)"),"@")="Список "_$$FORM(f) D CREA Q
TXXX X f I f[",18),""#"")" Q:ff="?"  S t0="" D CR S t0=" {"_i_","_j_"}  --> "_$S(ff="":" Стандартое",1:ff)_" ;неполная ссылка=^("""_$S(ff="":i_","_j,1:ff)_""")" D CR Q
 I ff'="" S t0="" D CR S t0=" {"_i_","_j_"}  --> "_ff D CR Q
 Q
UUU I '$D(TotalSi),$D(@(BSr_"(BSt)")) D  S YES=1 Q
 .I $P(@(BSr_"(BSt)"),"@",28)=1 S ls=" СПИСОК ПУСТОЙ " D O^%ZAPM.bs.BSF7 Q
 .D CREA
 S YES=0 Q
KLSS() N %LL ;ПОЛНАЯ ССЫЛКА КЛЕТКИ В HISTORY
 S %LL="{"_ny_","_nx_","""_BST_""","""_$S(BSR["]":$P(BSR,"]",2),1:$P(BSR,"^",2))_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""" I TIP=2,$P(BS,"@",9)'=1 D
 .I $D(NOKEY) S %LL=%LL_",???..." Q
 .F pi=0:1:13 I $D(%KEYS(pi)) S %LL=%LL_","_$S(%KEYS(pi)=+%KEYS(pi):%KEYS(pi),1:$C(34)_%KEYS(pi)_$C(34))
 Q %LL_"}"
DosFile(li,ls,ll,L1,%hlp,L2,L3) N Ox,Oy,%File,%,ii,%zT,%DRV,%ER,%JB,R1,R2,R3,I,II,A,O,OO,OOO,T S L3="FVZ^%ZAPM.bs.BSTT(""D DOS^%ZAPM.bs.BSDOS"")",ll="" Q $$LineEdit^%ZAPM.bs.BSXfun($G(li),$G(ls),$G(ll),$G(L1),$G(%hlp),$G(L2,"^%ZAPM.bs.BSbufB(""HISFILE"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")"),$G(L3))
LE S $P(lop,"@",5)=$G(lon),li=$$LineEdit^%ZAPM.bs.BSXfun($G(li),$G(ls),$G(ll),"",$G(%hlp),$G(%HIS),"FVZ^%ZAPM.bs.BSTT("""_$G(%KAT)_""")") K %KAT,%hlp,ll,lon,%HIS Q
Add D AddHist^%ZAPM.bs.BSXuse("^%ZAPM.bs.BSbufB(""HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")",$$KLSS^%ZAPM.bs.BSTT()) W $$bel^%ZAPM.bs.BS3 K %File Q
FVZ(%KAT) ;ВЫЗОВ ПОДПРОГРАММ ДЛЯ СТРОЧНОГО РЕДАКТОРА
 i R1=27,R2=79,R3=82 X $G(%KAT) S R1=-2 I $G(%File)'="" d
 . S LocS=%File,cLen=$L(LocS)+1,Col=cLen,Qu=1 q
]]></Routine>


<Routine name="%ZAPM.bs.BSVOL" type="MAC" languagemode="0"><![CDATA[
%BSVOL ;ГЛОБАЛЬНОЙ ПРОКАЧКИ ТОМОВ; 12:51 19-APR-95 ; 14:17   06.06.2002
 Q
Index(TAB,PAR,UCI,SYS,FLine,Key0,Key1,Key2) ;ВОЗВРАЩАЕТ ВЫБРАННЫЙ УЗЕЛ ИЗ БАЗЫ ДАННЫХ
 S uZ="I" G uuZ
UzelBD(TAB,PAR,UCI,SYS,FLine,Key0,Key1,Key2) ;ВОЗВРАЩАЕТ ВЫБРАННЫЙ УЗЕЛ ИЗ БАЗЫ ДАННЫХ
uuZ N i,BD,IYI,d,dat,date,TRA,LL,li,BSr,BSt,BSR,BST
 S li=TAB_","_PAR_","_$G(UCI)_","_$G(SYS)_"," F i=0:1:13 I $D(@("Key"_i)) S li=li_@("Key"_i)_","
 S IYI=li_"<>"
 D ENTER^%ZAPM.bs.BSN Q:$G(date)="" ""
 D RII^%ZAPM.bs.BSF3
 S BD=$$KBD^%ZAPM.bs.BSF12($NA(@BSr@(BSt))) I BD'["^" W $$bel^%ZAPM.bs.BS3 Q ""
 I $P(li,",",5)'="" S BD=BD_$P(li,",",5)
 F i=1:1:9 I $P(li,",",i+5)'="" S BD=$NA(@BD@($P(li,",",i+5)))
 I '$$Data^%ZAPM.bs.BSF12(BD) Q ""
 I $G(uZ)="I" S uZ=date
 Q $NA(@BD@(date))
INDEX(TAB,PAR,UCI,SYS,FLine) ;ВОЗВРАЩАЕТ ВЫБРАННЫЙ УЗЕЛ ИЗ БАЗЫ ДАННЫХ 1 УРОВНЯ
 S uZ="I" G uZ  ;ИНДЕКС В uZ
UZEL(TAB,PAR,UCI,SYS,FLine) ;ВОЗВРАЩАЕТ ВЫБРАННЫЙ УЗЕЛ ИЗ БАЗЫ ДАННЫХ 1 УРОВНЯ
uZ N i,BD,IYI,d,dat,date,TRA,LL,li,BSr,BSt,BSR,BST
 S li=TAB_","_PAR_","_$G(UCI)_","_$G(SYS),IYI=li_",<>"
 D ENTER^%ZAPM.bs.BSN Q:$G(date)="" ""
 D RII^%ZAPM.bs.BSF3
 S BD=$$KBD^%ZAPM.bs.BSF12($NA(@BSr@(BSt))) I BD'["^" W $$bel^%ZAPM.bs.BS3 Q ""
 I '$$Data^%ZAPM.bs.BSF12(BD) Q ""
 I $G(uZ)="I" S uZ=date
 Q $NA(@BD@(date))
GOMARK ;ПОМЕТКА ИЗ БАЗЫ ПОМЕТОК
 N U,S,K,CMD,C,MARK1,MARK2,MARK3,MARK4,MARK5
 S U=$$UZEL("MARK","%BSVOL","",""," НАДО ВЫБРАТЬ ТОТ ТИП ПОМЕТКИ, КАКОЙ ВАМ НЕОБХОДИМ"),YES=0 Q:U=""
 S S=$G(@U@("STR")),K=$G(@U@("KOL")),CMD=$G(@U@("CMD"))
 S:S="" S="1:1:se" S:K="" K="1:1:ke" S:S["ny" S=$$TR^%ZAPM.bs.BSsFUNM(S,"ny",ny)
 S:K["nx" K=$$TR^%ZAPM.bs.BSsFUNM(K,"nx",nx)
 I CMD="" S CMD="I 0"
 S C="F ny="_S_" F nx="_K_" S d=$P(@BSR@(BST,ny,nx),""@"",15) X CMD I  S $P(@BSR@(BST,ny,nx),""@"",12)=1,%DIA=1"
 X C
 I $G(%DIA) S $P(@BSR@(BST),"@",3)=1,YES=1
 Q
START ;СТАРТ ПРОКАЧЕК
 N i,BD,IYI,d,dat,date,TRA,LL,%DEV,%FN,%FNU,FLine
 S IYI="PARAM,%BSVOL,,,<>",FLine="  НУЖНО ВЫБРАТЬ НЕОБХОДИМУЮ ПРОКАЧКУ"
 D ENTER^%ZAPM.bs.BSN Q:date=""
 S BD=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""PARAM"")") I BD'["^" W $$bel^%ZAPM.bs.BS3 Q
 N u,v,p,t,b,b1,k,k1,m,m1,w,r,sw,sr,g,pro,k2,b2,b3,b4,b5,m2,m3,m4,m5,L,BSr,BSt,Coment
 S I="u,v,p,t,b,b1,k,k1,m,m1,w,r,sw,sr,c,pro",BSt="ProkProt"_$G(%BS(3),$P)_$J_"u"_$G(%BS(3),$P),BSr="^%ZAPM.bs.BSbufB"
 F i=1:1 Q:$P(I,",",i)=""  S L(i)=$G(@BD@(date,$P(I,",",i)))
UCI ;КИП,ТОМ
 I (L(1)="")&(L(2)="") D ErrMsg^%ZAPM.bs.BSXfun("НЕ выбраны КИП,ТОМ") Q
 I (L(1)="*")&(L(2)="*") K DOUCI G PAR
 S DOUCI="S u=$P($$ZU^%ZAPM.bs.BS3(0),"",""),v=$P($$ZU^%ZAPM.bs.BS3(0),"","",2) I "
 I L(1)?3A S DOUCI=DOUCI_"u=L(1),"
 I L(2)?3A S DOUCI=DOUCI_"v=L(2),"
 I L(1)'?3A S DOUCI=DOUCI_$S("*"[L(1):1,1:L(1))_","
 I L(2)'?3A S DOUCI=DOUCI_$S(L(2)="*":1,1:L(2))_","
 S DOUCI=DOUCI_"1"
PAR ;РАЗДЕЛЫ
 S LL=0 I L(11)=""&(L(13)="")&(L(15)="") S LL=1
 I L(3)="" S DOPART="" G BASE
 S DOPART="S p=i I "
 I L(3)?1"^%".AN!(L(3)?1"^"1A.AN) S DOPART=DOPART_"p=L(3),"
 E  S DOPART=DOPART_$S(L(3)="*":1,1:L(3))_","
 S DOPART=DOPART_"1"
TABL ;ТАБЛИЦЫ
 I L(4)="*"!(L(4)="") S DOPART=DOPART_" S g=p D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  D DOO^%ZAPM.bs.BSVOL(g)") G BASE
 E  S DOPART=DOPART_" S g=p D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" S t="""" F  S t=$O(@(p_""(t)"")) Q:t=""""  I "_L(4)_" S (g1,g)=$NA(@p@(t)),g1=$E(g1,1,$L(g1)-1) D DOO^%ZAPM.bs.BSVOL(g) F  S g=$ZO(@g) Q:g'[g1  D DOO^%ZAPM.bs.BSVOL(g)")
BASE ;БАЗЫ
 I L(5)="" S DOBD="" G KOD
 S Tmp="" I L(6)'="" S Tmp="D URBD^%ZAPM.bs.BSVOL I  "
 I L(5)="*" S DOBD="S g=i D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  "_Tmp_"D DOO^%ZAPM.bs.BSVOL(g)") G KOD
 S DOBD="I "_L(5)_" S g=i D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  "_Tmp_"D DOO^%ZAPM.bs.BSVOL(g)")
KOD ;КОДИФИКАТОРЫ
 I L(7)="" S DOKD="" G MASS
 S Tmp="" I L(8)'="" S Tmp="D URKD^%ZAPM.bs.BSVOL I  "
 I L(7)="*" S DOKD="S g=i D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  "_Tmp_"D DOO^%ZAPM.bs.BSVOL(g)") G MASS
 S DOKD="I "_L(7)_" S g=i D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  "_Tmp_"D DOO^%ZAPM.bs.BSVOL(g)")
MASS ;МАССИВЫ
 I L(9)="" S DOMASS="" G GO
 S Tmp="" I L(10)'="" S Tmp="D URMS^%ZAPM.bs.BSVOL I  "
 I L(9)="*" S DOMASS="S g=i D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  "_Tmp_"D DOO^%ZAPM.bs.BSVOL(g)") G GO
 S DOMASS="I "_L(9)_" S g=i D DOO^%ZAPM.bs.BSVOL(g)"_$S(LL:"",1:" F  S g=$ZO(@g) Q:g=""""  "_Tmp_"D DOO^%ZAPM.bs.BSVOL(g)")
GO ;ПОДГОТОВКА К ПРОКАЧКЕ
 S %zT=$ZT,$ZT="DOOErr^%ZAPM.bs.BSVOL"
 I L(13)?3A1","3A&(L(14)?3A1","3A) D  ;ТРАНСЛЯЦИЯ
 .S TRA(0)="",TRA(0,1)=$P(L(13),","),TRA(0,2)=$P(L(13),",",2),i=0
 .D SETT^%ZAPM.bs.BSZRAP,SETTRA^%ZAPM.bs.BSZRAP(L(14))
 I L(11)'="" S L(11)=$TR(L(11),$C(253),"@"),L(12)=$TR(L(12),$C(253),"@")
 K LL,END
 D Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! Сейчас начнётся ПРОКАЧКА "_L(2)_" ! УВЕРЕНЫ ?",1) Q:YES<1
 D STA^%ZAPM.bs.BSF5
 I $D(END) D OkMsg^%ZAPM.bs.BSXfun("ПРОКАЧКА ОСТАНОВЛЕНА ОПЕРАТОРОМ !!!") Q
 D Yes^%ZAPM.bs.BSXfun("ЗаменаСтрок="_+$G(LL(1))_".ЗаменаСсылок="_+$G(LL(2))_".Будем смотреть протокол ?",2)
 I YES,(+$G(LL(1))!(+$G(LL(2)))) S Coment="Протокол замен" D CREATE^%ZAPM.bs.BSTT
 Q
COPYINF ;КОПИРОВАНИЕ МАССИВОВ В ФАЙЛ
 I $E(BST,1,2)'="fT" D ErrMsg^%ZAPM.bs.BSXfun("ПОДЫМИТЕСЬ ВЫШЕ, НА УРОВЕНЬ КИПОВ И ТОМОВ") Q
 N G,DI,ANSI,SERROR
 S DI=$P($G(^%ZAPM.bs.BSETUP("PATH",10,4)),"@",15) I DI="" W $$bel^%ZAPM.bs.BS3 D ErrMsg^%ZAPM.bs.BSXfun("Директория запасного копирования НЕ ОПРЕДЕЛЕНА! ИСПРАВЛЯЙТЕ в ^%ZAPM.bs.BSETUP,SERVER") Q
 S G=$$TMPG^%ZAPM.bs.BSF11
 I $D(%DIA) S do="D COPYUCI^%ZAPM.bs.BSVOL(G,@$ZR)" D BLOK^%ZAPM.bs.BSF1 G CO
 D COPYUCI(G,@BSR@(BST,ny,nx))
CO I $O(@G@(""))="" W $$bel^%ZAPM.bs.BS3 Q
 D Yes^%ZAPM.bs.BSXfun("Копию делать в Windows кодировке ?") I YES s ANSI=1
 D Yes^%ZAPM.bs.BSXfun("Запасное Копирование Массивов ! Будет фоновое ?") I YES<0 D OkMsg^%ZAPM.bs.BSXfun("ОТМЕНА",1) Q
 I YES J COPYVOL(G,DI,0,"",ANSI):16:1 I  G EXITCO
 D COPYVOL(G,DI,1,"",$G(ANSI))
EXITCO D UNMARK^%ZAPM.bs.BSF11($NA(@BSR@(BST))) ;СНЯТЬ ПОМЕТКУ С ТАБЛИЦЫ
 D W^%ZAPM.bs.BST K %DIA I $D(SERROR) D Yes^%ZAPM.bs.BSXfun("БЫЛИ МАССИВЫ С УПРАВЛЯЮЩИМИ СИМВОЛАМИ ! ПОСМОТРИМ КАКИЕ ?") I YES D
 .D ^%ZAPM.bs.BSMSMG("SERROR")
 Q
TIMEVENT() ;СОБЫТИЕ ДЛЯ КОПИРОВАНИЯ
 I $P($$h^%ZAPM.bs.BS3(),",",2)>$P($$DATHR^%ZAPM.bs.BSsFUNR(8,"970404"_$G(@G@("!TimeCopy:HHMM",S),2500)),",",2),'$D(@G@("!TimeCopyProtokol",S,+$$h^%ZAPM.bs.BS3())) S @G@("!TimeCopyProtokol",S,+$$h^%ZAPM.bs.BS3())=$P($$h^%ZAPM.bs.BS3(),",",2) Q 1
 Q 0
SAVEALL(Ss,G,S) ;СОХРАНЕНИЕ ТОМОВ
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 N DI
 S DI=$P($G(^%ZAPM.bs.BSETUP("PATH",10,4)),"@",15) I DI="" W $$bel^%ZAPM.bs.BS3 S @G@("!TimeCopyProtokol",S,+$$h^%ZAPM.bs.BS3())="НЕ ОПРЕДЕЛЕНА ПОДДИРЕКТОРИЯ СОХРАНЕНИЯ" Q
 D VALIDATE I $G(%ERR) S @G@("!TimeCopyProtokol",S,+$$h^%ZAPM.bs.BS3())="ЕСТЬ ОШИБКИ !!!" Q
 J COPYVOL($NA(@G@(Ss)),DI,0,$NA(@G@("!TimeCopyProtokol",S,+$$h^%ZAPM.bs.BS3()))):16:1 E  S @G@("!TimeCopyProtokol",S,+$$h^%ZAPM.bs.BS3())="ЗАДАНИЕ НЕ ЗАПУСТИЛОСЬ" Q
 Q
VALIDATE I $P($ZV,"Version ",2)<4 S %ERR=0 Q  ;ДЛЯ 3
 N (%ERR) D AUTO^VALIDATE Q
COPYVOL(G,DI,J,U,ANSI) ;КОПИРОВАНИЕ МАССИВОВ В ФАЙЛ
 N d,ERROR
 S d="" F  S d=$O(@G@(d)) Q:d=""  I $$ZU^%ZAPM.bs.BS3($P(d,",",2),$P(d,",",1))'="" V 2:$J:+$P(d,",")*32+$P(d,",",2):2 D COPY(DI_+$$h^%ZAPM.bs.BS3()_$TR($$ZU^%ZAPM.bs.BS3(0),",","."),$G(J)) Q:$D(ERROR)
 I $G(U)'="" D
 .I $D(ERROR) S @U=ERROR Q
 .S @U=($P($$h^%ZAPM.bs.BS3(),",",2)-$G(@U)\60)_" мин"
 D MGR^%ZAPM.bs.BS
 Q
COPY(FN,J) N DOS,U,i,Hi,HiR,X,X1,X2,X3,%X,%J,%RN,%ZPRINT,ii ;КОПИРОВАНИЕ
1 f DOS=51:1:54 o DOS::0 q:$T
 I '$T Q
 o DOS:(FN:"W") u DOS:(::0:0)
 i $ZC Q
 I $D(ERROR) W !,ERROR,! G COPYEXIT
 S Hi="",i="^" F  S i=$O(@i) Q:i=""  S i="^"_i I $$KROME(i) Q:$L(Hi)>4080  S Hi=Hi_i
 U DOS W Hi,!
 S HiR="",i="" F  S i=$O(^ (i)) Q:i=""  Q:$L(HiR)>4080  S HiR=HiR_" "_i
 U DOS W HiR,!
 I $G(J) U 0 D Wait^%ZAPM.bs.BSXfun($$ZU^%ZAPM.bs.BS3(0)_" Массивы")
 I $G(ANSI) D INIT^%ZAPM.bs.BSre(1)
 S i="^" F  S i=$O(@i) Q:i=""  S i="^"_i D  Q:$D(ERROR)  I $G(J) U 0 X WA
 .I '$$KROME(i) Q
 .U DOS S ii=i D:$D(@ii)'["0" Wr(ii),Wr(@ii) F  S ii=$ZO(@ii) Q:ii=""  D Wr(ii),Wr(@ii) I $ZC S ERROR="ОШИБКА ДИСКА при ЗАПИСИ МАССИВОВ" Q
 .W "*",!,"*",!
 U DOS W "**",!,"**",!
 G COPYEXIT:HiR="",ERROR:$D(ERROR)
 I $G(J) U 0 D Wait^%ZAPM.bs.BSXfun($$ZU^%ZAPM.bs.BS3(0)_" Программы")
 U DOS D Wr(";;;Routines;;;"),Wr("")
 S X3="U DOS W %RN,!",X1="S I="""" F  S I=$O(^ (I)) Q:I=""""  S %RN=I X:$G(J) X2 X X3,%ZPRINT Q:$ZC  "
 S %ZPRINT="ZL @%RN U DOS F %X=1:1 S %J=$T(+%X) W %J,! Q:$ZC  Q:%J=""""",X2="U 0 X WA"
 I $G(ANSI) S %ZPRINT="ZL @%RN U DOS F %X=1:1 S %J=$T(+%X) W $TR(%J,S1,S2),! Q:$ZC  Q:%J=""""",X2="U 0 X WA"
 X X1 I $ZC S ERROR="ОШИБКА ДИСКА при ЗАПИСИ ПРОГРАММ" G ERROR
COPYEXIT C DOS Q
Wr(S) I $G(ANSI) S S=$TR(S,S1,S2)
 I S'=$TR(S,$C(10,13),"") S SERROR($QS($ZR,0))=$G(SERROR($QS($ZR,0)))+1,S=$TR(S,$C(10,13),"")
 W S,!
 Q
ERROR C DOS G 1
 Q
KROME(i) I i="^%ZAPM.bs.BSbufB"!(i="^BSdirddp")!(i="^UTILITY") Q 0
 Q 1
COPYUCI(G,BS) S d=$P(BS,"@",15) I $E(d)'?1N W $$bel^%ZAPM.bs.BS3 Q
 S @G@(d)="" Q
DOO(g) ;ДЕЙСТВИЯ НАД g
 N gg,g1
 S %zT=$ZT,$ZT="DOOErr^%ZAPM.bs.BSVOL"
 I g'["(",L(16)'="" D  ;ЗАЩИТА
 .I L(16)="DFLT",$$TipMass^%ZAPM.bs.BSGLOB(g)>0 D CP^%ZAPM.bs.BSGCH($NA(@g),$P(%BS(22),",",$$TipMass^%ZAPM.bs.BSGLOB(g))) Q
 .D CP^%ZAPM.bs.BSGCH($NA(@g),L(16))
 X L(15) Q:$D(END)
 Q:$D(@g)["0"  S gg=@g
 I L(11)'="",gg[L(11) S g1=$$TR^%ZAPM.bs.BSsFUNM(gg,L(11),L(12)) I g1'=gg S @g=g1,LL(1)=$G(LL(1))+1 D Add("±"_g_"="_gg),Add("±±...="_g1)
 I $D(TRA) S g1=$$TRAnfer^%ZAPM.bs.BSZRAP(gg) I g1'=gg S @g=g1,LL(2)=$G(LL(2))+1 D Add(g_"="_gg),Add("...="_g1)
 S $ZT=$G(%zT) Q
Add(t0) ;ПРОТОКОЛ ПРОКАЧКИ
 I $L(t0)>($$LNG^%ZAPM.bs.BSF12-1) S t0=$E(t0,1,($$LNG^%ZAPM.bs.BSF12-1))
 D CR^%ZAPM.bs.BSTT Q
URBD ;ВЫБОРКА УРОВНЕЙ БД
URKD ;ВЫБОРКА УРОВНЕЙ КОДИФИКАТОРА
 I 1 Q  ;ПОКА ТАК
DOOErr S $ZT=$G(%zT) D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE))
 Q
 ;
VOl ;ВЫБОР ТОМА
 K VOl S li="",ls="УКАЖИТЕ ТРАНСЛИРУЕМЫЙ ТОМ или КИП,ТОМ" D LE^%ZAPM.bs.BSTT Q:'YES  Q:li=""  S VOl=li
 I $L(VOl)=3 S DOPART="I $P($$ZU^%ZAPM.bs.BS3(0),"","",2)=VOl" G VO
 I $L(VOl)=7 S DOPART="I $$ZU^%ZAPM.bs.BS3(0)=VOl" G VO
 E  W $$bel^%ZAPM.bs.BS3 K VOl,DOPART
VO Q
TranGlob ;ГЛОБАЛЬНАЯ ТРАНСЛЯЦИЯ
 N SS,SZ,VOl,TRA,i,DOPART
 D VOl Q:'$D(VOl)
 S li="",ls="УКАЖИТЕ ССЫЛКУ - КИП,ТОМ   КОТОРУЮ ТРАНСЛИРОВАТЬ !!!" D LE^%ZAPM.bs.BSTT Q:'YES  S SS=li
 S li="",ls="УКАЖИТЕ ССЫЛКУ - КИП,ТОМ  НА КАКУЮ ЗАМЕЩАТЬ !!!" D LE^%ZAPM.bs.BSTT Q:'YES  S SZ=li
 S DOPART=DOPART_",i'[""^%ZAPM.bs.BS"",i'[""^BS"" D Tran^%ZAPM.bs.BSGLOB(i)"
 S TRA(0)="",TRA(0,1)=$P(SS,","),TRA(0,2)=$P(SS,",",2),i=0
 D SETT^%ZAPM.bs.BSZRAP,SETTRA^%ZAPM.bs.BSZRAP(SZ)
 D Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! Сейчас начнётся Трансляция массивов "_VOl_" ! УВЕРЕНЫ ?",1) Q:YES<1
 D STA^%ZAPM.bs.BSF5
 D OkMsg^%ZAPM.bs.BSXfun("...ВСЁ...") Q
Tran(II) N ii
 I $D(@II)'["0" D TRA^%ZAPM.bs.BSZRAP(II)
 F ii=1:1 S II=$ZO(@II) Q:II=""  D TRA^%ZAPM.bs.BSZRAP(II) I '(ii#50) U 0 X WA
 Q
Diag ;ДИАГНОСТИКА ТОМА
 N ii,i,DOPART,VOl,BSr,BSt,II,III,iii,IIII,TI
 D VOl Q:'$D(VOl)
 D Yes^%ZAPM.bs.BSXfun("ВНИМАНИЕ ! Сейчас начнётся ДИАГНОСТИКА разделов на ссылки "_VOl_" ! УВЕРЕНЫ ?",1) Q:YES<1
 S DOPART=DOPART_" D Dia^%ZAPM.bs.BSGLOB(i)",BSt="DiagPart"_$G(%BS(3),$P),BSr="^%ZAPM.bs.BSbufB"
 D DiaK,STA^%ZAPM.bs.BSF5,Diagn
 I '$D(se) D OkMsg^%ZAPM.bs.BSXfun("ССЫЛКИ ОТСУТСТВУЮТ...") Q
 S Coment="Диагностика "_VOl D CREATE^%ZAPM.bs.BSTT
DiaK K ^%ZAPM.bs.BSbufB("DiagPart"),^%ZAPM.bs.BSbufB("DiagPart"_$G(%BS(3),$P)) Q
Dia(II) S TI=99 F ii=1:1 S II=$ZO(@II) Q:II=""  S:$L(II,",")=1 TI=$P($G(@II),"@",17) D:@II["]"&("56"'[TI)  I '(ii#50) U 0 X WA
 .S III=@II F iii=1:1 Q:$P(III,"]",iii)'["["  D
 ..S IIII=$TR($P($P(III,"]",iii),"[",2),",""",".") S IIII=$S(IIII="":"?="_II,1:IIII)
 ..S ^%ZAPM.bs.BSbufB("DiagPart",$TR($$ZU^%ZAPM.bs.BS3(0),",","."),$P(II,"("),IIII)=$G(^%ZAPM.bs.BSbufB("DiagPart",$TR($$ZU^%ZAPM.bs.BS3(0),",","."),$P(II,"("),IIII))+1
 Q
Diagn S II="^%ZAPM.bs.BSbufB(""DiagPart"")" F ii=1:1 S II=$ZO(@II) Q:II'["^%ZAPM.bs.BSbufB(""DiagPart"""  D  I '(ii#50) U 0 X WA
 .S t0=" в Томе "_$TR($P(II,",",2),".",",")_" Разделе "_$P(II,",",3)_" ссылка "_$TR($P($P(II,",",4),")"),".",",")_" встречается "_@II_" раз" D CR^%ZAPM.bs.BSTT
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSW" type="MAC" languagemode="0"><![CDATA[
%BSW ;ДЛЯ MSM-WORKSTATION OR CACHE' - ДИСПЕТЧЕР ; 10:09 19-JAN-99
 N Pddp,%NAM,IntBS S %NAM="^%ZAPM.bs.BSS",IntBS=1 D TAB^%ZAPM.bs.BS
 Q
 ;L  S $ZT="ALLERR^%ZAPM.bs.BS1" D  L  Q
 ;.D START
 ;START ;НОВЫЙ ПРОЦЕСС
 ;N  D CLr^%ZAPM.bs.BSF4 F  R *R:0 E  Q
 ;I $$VAR^%ZAPM.bs.BSH ;ПОКА НЕ ДО НИХ -----ПЕРЕМЕННЫЕ
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSX" type="MAC" languagemode="0"><![CDATA[
%BSX(Mode,BSR,BST,BadChar) ; Вход в Текст (В.Лащев) ; 16:51   01.04.2001
 N MouseYes
 n Refr,Edit,Qu,Str,St,Col,Co,Tmp,Head,Bst,Bstr,MinStr,MaxStr,Up,Down,StrY,StY,MaxLen,Left,Right,Hi,Len,Info,Block,s1,s2,s3,BST0,InHead,Ed,View,Fk,AltCmp,Win,i,j,ReDraw,UpDn,ToEL,More,Ins,cLen,LocS,Tab
 i $D(%BS)[0 d CLr^%ZAPM.bs.BSF4,Registr(1) ;То же в %BSXprog
 U $I::%BS(32)
 d Echo^%ZAPM.bs.BSXfun(0)
 s UpDn(0)=$Y,UpDn(1)=$X w $$atr^%ZAPM.bs.BS3(0)
 d CheckMod i Edit=-1 g Out
 i $$NoHead() g Out
 i $$Registr(0) g Out
 i $$ChckHead()>0 g Out1
 d Locs0 f  q:(Edit<0)  d Locs,Save3Lin^%ZAPM.bs.BSXfun(23),@("^%ZAPM.bs.BSX"_$S(Edit:"edit",1:"view")),LoadScr
Out1 d Registr(-1)
Out w $$atr^%ZAPM.bs.BS3(0),/CUP(UpDn(0)+1,UpDn(1)+1) s $Y=UpDn(0),$X=UpDn(1) k li
 i Mode="LINE" k YES i $G(R1)=13 s YES=$G(@Bstr)
 i Mode="TEXT" s YES=+$G(Str) i $G(R1)'=13 s YES=-YES
e q
 
LoadScr d LoadWin^%ZAPM.bs.BSXfun i %BS(13)="%BS-PC" d Load3Lin^%ZAPM.bs.BSXfun(23) q
 d ClrBot^%ZAPM.bs.BSXfun q
 
CheckMod s Mode=$$ToUp^%ZAPM.bs.BSXfun(Mode),Edit=0
 i Mode'="TEXT",Mode'="PROG",Mode'="LINE",Mode'="EDIT" d  s Edit=-1 q
 .d ErrMsg^%ZAPM.bs.BSXfun(" Режимы ^%ZAPM.bs.BSX : ""TEXT"",""PROG"",""LINE"",""EDIT"" ")
 s Head="@BSR@(BST)"
 i Mode="LINE" s Edit=1
 i Mode="EDIT" s Edit=1,Mode="TEXT"
 i Mode="TEXT" s BST0=BST
 i Mode="PROG" s Win=$G(BST),Edit=1 d ChckName^%ZAPM.bs.BSXprog
 i '$$PassWord^%ZAPM.bs.BSXfun(2,"на вход в текст") s Edit=-1
 q
 
Locs0 s (Up,Str,Col)=1 s Ed=+$G(Ed) ; локали
 s (Block,Block(0,0),Block(0,1),Block(1,0),Block(1,1))=0
 i Mode="PROG" d
 . s (Str,Col)=2
 . s Tmp=$$StatNode^%ZAPM.bs.BSXedit() i Tmp="" q
 . i +$P(Win,",")>0 s $P(@Tmp,"@")=+$P(Win,","),$P(@Tmp,"@",3)=+$P(Win,",")
 . i +$P(Win,",",2)>0 s $P(@Tmp,"@",2)=+$P(Win,",",2)
 . s $P(@Tmp,"@",4)=1
 q
 
Locs n H,i                                      ; локали Общие
 s H=$G(@Head),(YES,Err)="" i $G(%BS(20))'="" d
 . s YES=$G(@%BS(20)@($S(Mode="PROG":"ProgEdit",1:"TextEdit")))
 s MaxLen=0 ;```$P(H,"@",29) i MaxLen="" s MaxLen=$P(YES,"@",29)
 s MaxLen=+MaxLen i MaxLen>($$LNG^%ZAPM.bs.BSF12-1)!(MaxLen<1) s MaxLen=($$LNG^%ZAPM.bs.BSF12-1)
 s Tmp=$P(H,"@",23) i Tmp="" s Tmp=$P(YES,"@",23)
 i +$E(Tmp) s Ins=($E(Tmp)=2) d SetLock^%ZAPM.bs.BSXfun(Ins_$E($$GetLock^%ZAPM.bs.BSXfun(),2,8))
 s Tab=+$E(Tmp,5,6) i Tab<1!(Tab>MaxLen) s Tab=10
 d ReadFk s AltCmp=$P(H,"@",41) i AltCmp="" s AltCmp=$P(YES,"@",41)
 s ToEL="^%ZAPM.bs.BSbufB(""HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")"
 s Bstr="@Head@(Str)",Bst="@Head@(St)"
 s ReDraw="d WrStr(St-Up,"""_Bstr_""",Win(14),Win(15),.St) "
 s ReDraw=ReDraw_" d WrStr(Str-Up,"""_Bstr_""",Win(12),Win(16),.Str) "
 
 s Tmp=$P(H,"@",31) ;окно/блок/стpока/инфо/текст/метка/меткаВстpоке////заполнение
 f i=1:1:10 s Win(9+i)=$P(Tmp,"/",i)
 s Win=$P(Tmp,"/",11),Tmp=$P(YES,"@",31)
 i Win="" s Win=$P(Tmp,"/",11)
 s Win=+Win i Win<32!(Win>255) s Win=32
 s Win=$TR($J("",80)," ",$C(Win))
 i Win(10)="" f i=1:1:10 s Win(9+i)=$P(Tmp,"/",i)
 i Win(10)="" d  s Win(10)="1;6;36;44"
 . f i=10:1:19 s Win(i)=""
 i Win(11)="" s Win(11)=$P(%BS,"!",3)
 i Win(13)="" s Win(13)=Win(10)_$S($F(Win(10),"33"):";37;1",1:";33;1")
 i Win(14)="" s Win(14)=Win(10)
 i Win(12)="" s Win(12)=Win(14)
 i Win(15)="" s Win(15)=Win(10)_$S($F(Win(10),"32"):";37;1",1:";32;1")
 i Win(16)="" s Win(16)=Win(12)_$S($F(Win(12),"32"):";37;1",1:";32;1")
 i $G(%BS(20))'="" s Win(19)=$P($G(@%BS(20)@("TextLine")),"@",31)
 I $E(%BS(1),19) f i=1,3:1:10 s Win(9+i)=$P(%BS,"!",$E(%BS(1),19))
 i $G(Win(19))="" s Win(19)="1;6;37;42//////////176"
 s Win(19)="@@@@@"_Win(19)
 s Tmp=$P(H,"@",38) i Tmp="" s Tmp=$P(YES,"@",38) i Tmp="" s Tmp=1
 i Tmp'=1,Tmp'=2 s Tmp=" "
 s Win(20)=$S(Tmp=1:"|",Tmp=2:"|",1:" ")
 s Win(21)=$S(Tmp=1:"|",Tmp=2:"|",1:"[")
 s Win(22)=$S(Tmp=1:"|",Tmp=2:"|",1:"]")
 s Win(23)=$S(Tmp=1:"-",Tmp=2:"=",1:" ")
 s Win(24)=Tmp
 i Win(12)=Win(14),Win(16)=Win(15) s ReDraw=""
 s ReDraw="i St'=Str "_ReDraw_"s St=Str"
 
 n y1,y2,x1,x2
 s y1=$P(H,"@",8),x1=$P(H,"@",9),y2=$P(H,"@",10),x2=$P(H,"@",11)
 i y1=""!(y2="")!(x1="")!(x2="") d
 . i YES'="" s y1=$P(YES,"@",8) d  i y1'=""&(y2'="")&(x1'="")&(x2'="") q
 .. s x1=$P(YES,"@",9),y2=$P(YES,"@",10),x2=$P(YES,"@",11)
 . s (x1,y1)=2,y2=21,x2=79
 s $P(H,"@",8,11)=y1_"@"_x1_"@"_y2_"@"_x2
 i $$BsxWin^%ZAPM.bs.BSXuse("H")
 s Win(0,0)=+$P(H,"@",8),Win(0,1)=+$P(H,"@",9)
 s Win(1,0)=+$P(H,"@",10),Win(1,1)=+$P(H,"@",11)
 i Mode="PROG" d
 . s i=0,Tmp="" f  s Tmp=$O(@BSR@(Tmp)) q:Tmp=""  i $D(@BSR@(Tmp))>9 s i=i+1
 . i $D(@Head)>9 s i=i-1
 . s Win(0,0)=Win(0,0)+i,Win(0,1)=Win(0,1)+i
 
 s UpDn=0,Win(3,0)=Win(0,0)+1,Win(3,1)=Win(0,1)+1,Win(2,0)=Win(1,0)
 s Hi=Win(1,0)-Win(3,0)-1,Len=Win(1,1)-Win(3,1)-1
 s Info="00000000",(More(0),More(1),More(2),More(3))=""
 i Hi'<0,(Len'<0) d
 . s i=Len+1,Info=$P(@Head,"@",13) i Info="" s Info=$P(YES,"@",13)
 . f Tmp=1:1:8 i $E(Info,Tmp)'=0,$E(Info,Tmp)'=1 d
 .. s $E(Info,Tmp)=$E("11111100",Tmp)
 . i '$E(Info) q
 . i $E(Info,2) s $E(Info,2)=(Len>(3+(2*$E(Info,5))))
 . f Tmp=3:1:7 s j=+$P("3,12,1,7,5,5",",",Tmp-2) d
 .. i i<j s $E(Info,Tmp)=0 q
 .. i $E(Info,Tmp) s i=i-j-1
 i '$E(Info) d
 . s Info="00000000",Hi=Hi+2,Len=Len+2
 . s Win(3,1)=Win(3,1)-1,Win(3,0)=Win(3,0)-1
 e  d
 . s Win(2,3)=Win(0,1)+1,Win(2,5)=Win(1,1)-1 ; pедакция,стpелки
 . s Win(2,4)=Win(2,3)+(4*$E(Info,3)) ; кооpд
 . s Win(2,8)=Win(2,4)+(13*$E(Info,4)) ; длина
 . s Win(2,6)=Win(2,5)-8+(2*'$E(Info,5))
 . s Win(2,7)=Win(2,6)-6+(8*'$E(Info,6))
 s Left=1,Right=Left+Len s Win=$E(Win,1,1+Len)
 q
 
DelKills n DelBuf,Head0                   ; удалить буффеp Delete
 s DelBuf=$$KillsBuf(),Head0=$G(@DelBuf)
 k @DelBuf s @DelBuf=Head0,@($P(DelBuf,")")_",1)")=""
 q
 
KillsBuf() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",4,3)"
 
Registr(vhod) n Out ; входили ли в текст
 i vhod>0 d SetLock^%ZAPM.bs.BSXfun("1"_$E($$GetLock^%ZAPM.bs.BSXfun(),2,8)) w $$bel^%ZAPM.bs.BS3
 s Out=0 i vhod'>0 d:vhod=0 IsView i Mode="LINE" g QRegis
 s Out=$$DoRegis()
QRegis i vhod=0 q Out
 q
DoRegis() n Txt,Node s Node="^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),5,""Reg"")"
 i vhod>0 k @Node q 0
 s Txt=$$BSR^%ZAPM.bs.BSA($NA(@Head))
 i vhod<0 k @Node@(Txt) q 0
 i $D(@Node@(Txt))'[0 d  q 1
 .d ErrMsg^%ZAPM.bs.BSXfun(" Втоpой pаз в текст '"_$NA(@Head)_"' войти нельзя. ") q
 s @Node@(Txt)=$$UserNAME^%ZAPM.bs.BSXfun() q 0
 
NoHead() i Mode="TEXT",$D(@Head)[0 d  q 1 ; есть ли текст
 .d ErrMsg^%ZAPM.bs.BSXfun(" Нет текста '"_$NA(@Head)_"' ")
 q 0
 
ChckHead() n H,i,col,atr,y,x,y1,x1,Err      ; пpовеpка/pемонт заголовка
 s H=$G(@Head),Err=""
 f i=1,2,4,5 s col=$P(H,"@",i) d
 . i $L(col)>80 s $P(H,"@",i)=$E($P(col,"@",i),1,80) d ErrHead("поле:"_i)
 s y=$P(H,"@",8),x=$P(H,"@",9),y1=$P(H,"@",10),x1=$P(H,"@",11)
 i y'=""!(x'="")!(y1'="")!(x1'="") d
 . i y<1!(x<1)!(y>25)!(x>80)!(y1<y)!(y1>25)!(x1<x)!(x1>80) d ErrHead("Y1 X1 Y2 X2") s $P(H,"@",8,11)="@@@"
 s x=$P(H,"@",15) i x'="",x'=0,x'=1,x'["^" s $P(H,"@",15)="" d ErrHead("Fk")
 i $P(H,"@",17)'=5 s $P(H,"@",17)=5 d ErrHead("Тип")
 s col=$P(H,"@",29) i col'="" i +col>($$LNG^%ZAPM.bs.BSF12-1)!(+col<1) s $P(H,"@",29)=($$LNG^%ZAPM.bs.BSF12-1) d ErrHead("MaxLen")
 s col=$P(H,"@",31)
 f x=1:1:10 s y=$P(col,"/",x) i y'="" d
 . s x1=0 f i=$L(y,";"):-1:1 d  i x1 q
 .. s atr=+$P(y,";",i)
 .. i atr<0!(atr=3)!((atr>8)&(atr<30))!((atr>37)&(atr<40))!(atr>47) s x1=1
 . i x1 s $P(col,"/",x)="" d ErrHead("Clr"_x)
 s atr=$P(col,"/",11) i atr'="" i +atr<32!(+atr>256) d ErrHead("Заполнение") s atr=""
 i $P(col,"/",11)'=atr s $P(col,"/",11)=atr
 i $P(H,"@",31)'=col s $P(H,"@",31)=col
 s atr=$P(H,"@",38) i atr'=1,(atr'=2),(atr'=" "),(atr'="") s $P(H,"@",38)="" d ErrHead("Ramka")
 s col=$P(H,"@",41) i col'="",col'["^" d ErrHead("Пpедобpаботка")
 s YES=0 i @Head'=H d
 . i View d ErrMsg^%ZAPM.bs.BSXfun("Ошибка заголовка в '"_$NA(@Head)_"'. ( а текст недоступен ! )") s YES=1 q
 . i (Mode'="PROG")&(Mode'="LINE") d Yes^%ZAPM.bs.BSXfun(" Устpанять ошибку заголовка '"_$NA(@Head)_"' в"_Err_" ") i YES<1 s YES=1 q
 . d R^%ZAPM.bs.BS3($NA(@Head)) s @Head=H d D^%ZAPM.bs.BS3($NA(@Head)) s YES=-1,Ed=1 q
 q YES
ErrHead(Pole) s Err=Err_" "_Pole q
 
AltF w $$bel^%ZAPM.bs.BS3 i Fk'=1 s Fk=1 q
ReadFk s Tmp=$P(@Head,"@",15) i Tmp="" d  i Tmp="" s Tmp=1
 . i $G(%BS(20))'="" s Tmp=$P($G(@%BS(20)@($S(Mode="PROG":"ProgEdit",1:"TextEdit"))),"@",15)
 s Fk=$S((Tmp["^")!(Tmp=1):Tmp,1:0) q
 
BusyV(Vhod,NoReg) n Name s Qu=0 i View,'Vhod q
 d R^%ZAPM.bs.BS3($NA(@Head)) s Name=$$UserNAME^%ZAPM.bs.BSXfun()
 i Vhod s Qu=$P(@Head,"@",30) d
 . i Qu'="",Qu'=Name d  I Qu'=Name s Edit=-1,Qu=1 q         ; текст занят
 .. d Yes^%ZAPM.bs.BSXfun("'"_$NA(@Head)_"' pедактиpует пользователь "_Qu_".Игнорируем ?",2,"Утвердительный ответ может давать только Администратор!")
 .. I YES>0 S Qu=Name,$P(@Head,"@",30)=Qu
 . s Qu=0
 i Qu=0,'$G(NoReg),'View s Qu="@Head@(""User"",Name)" d  s Qu=0
 . i 'Vhod k @Qu
 . e  d RegView("")
 d D^%ZAPM.bs.BS3($NA(@Head)) q
 
BusyE(Vhod) n Name i View d ErrMsg^%ZAPM.bs.BSXfun("Текст '"_$NA(@Head)_"' недоступен.") s Qu=1 q
 i Vhod d BusyV(Vhod,1) i Qu q
 d R^%ZAPM.bs.BS3($NA(@Head))
 i 'Vhod s Qu=0 s:Mode'="PROG" $P(@Head,"@",30)=""
 e  s Qu="@Head@(""User"")",Name=$$UserNAME^%ZAPM.bs.BSXfun() d
 . n User i $L($D(@Qu))>1 d  i Qu d ErrMsg^%ZAPM.bs.BSXfun(" Текст '"_$NA(@Head)_"' смотpит пользователь : "_User) q
 .. s User=$$GetIndex^%ZAPM.bs.BSXfun1($ZO(@Qu))  ; Пpовеpка на пользователей
 .. i User'=Name s Qu=1 q
 .. k @$ZO(@Qu) i $L($D(@Qu))<2 s Qu=0 q
 .. s User=$$GetIndex^%ZAPM.bs.BSXfun1($ZO(@Qu)),Qu=1
 . i Mode'="PROG" s $P(@Head,"@",30)=Name           ; заняли текст
 d D^%ZAPM.bs.BS3($NA(@Head)) q
 
RegView(H) n zt s zt=$ZT,$ZT="Prot^%ZAPM.bs.BSX",@Qu=H
ProtC s $ZT=$G(zt),Qu=0 q
Prot s View=1 g ProtC             ; только VIEWER
IsView s View=0,Qu=Head d R^%ZAPM.bs.BS3($NA(@Head)),RegView($G(@Head)),D^%ZAPM.bs.BS3($NA(@Head)) q
]]></Routine>


<Routine name="%ZAPM.bs.BSXFkey" type="MAC" languagemode="0"><![CDATA[
%BSXFkey ; обpаботка функциональных клавиш (В.Лащев) ; 20:16   06.03.99
 d ClrBot^%ZAPM.bs.BSXfun q:'$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",1,R3-79)  i +%GO q
 i '$F(%GO,"$$") d @%GO q
 i @%GO
e q
 
ToBlock(What) d ToBegEnd^%ZAPM.bs.BSXblck(.What),SetLocat^%ZAPM.bs.BSXview:'Edit q  ; на блок
 
DelText i 'Edit d NoJob q                  ; удалить текст
 d Yes^%ZAPM.bs.BSXfun(" Вы хотите удалить весь текст ? ",2) i YES<1 q
 d Wait^%ZAPM.bs.BSXfun(" Удаляю текст "),UnMarkBl^%ZAPM.bs.BSXblck
 s Tmp=@Head
 s Qu=2,Str=1,St=0,Col=1,Co=0,MaxStr=1
 s Left=1,Right=Left+Len,Up=1,Down=Up+Hi k LocS
 d R^%ZAPM.bs.BS3($NA(@Head)) k @Head s @Head=Tmp,@Bstr="" d D^%ZAPM.bs.BS3($NA(@Head))
 d UnMarkBl^%ZAPM.bs.BSXblck,ClrBot^%ZAPM.bs.BSXfun,Say^%ZAPM.bs.BSXfun(" Текст удален ")
 d SetEd^%ZAPM.bs.BSXedit(3) q
 
ShowDels d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSbufB","2,$G(%BS(3),$P),4,3") q  ; войти в буффеp Delete
 
PRNstDel n s i '$D(@Head@("PRN")) s s="отсутствует." ; удалить PRN-статус
 e  s s="удален." d R^%ZAPM.bs.BS3($NA(@Head)) k @Head@("PRN") d D^%ZAPM.bs.BS3($NA(@Head))
 d Say^%ZAPM.bs.BSXfun("Статус печати "_s) q
 
PredVvod(Pole) n s1,s2 s s1=$P(@Head,"@",Pole) ; подпpогpамма пpедобpаботки
 f  d  q:'$D(s1)
 . s s2="Введите имя подпpогpаммы "
 . i Pole=41 s s2=s2_"пpедобpаботки клавиш :"
 . e  s s2=s2_"обpаботки клавиш F2-F10 :"
 . i $L(s1)<2 s s1=""
 . s s1=$$LineEdit^%ZAPM.bs.BSXfun(s1,s2,"",Win(19)) i 'YES k s1 q
 . i s1'="" s s2=$ZT,$ZT="PredErr^%ZAPM.bs.BSXFkey",(R1,R2,R3)=-1 d @s1 s $ZT=s2
 . d ChgPiece(Pole,s1,-1) k s1
 q
PredErr d ErrMsg^%ZAPM.bs.BSXfun(" Ошибка <"_$ZE_"> "_$$ErrSay^%ZAPM.bs.BSF8($ZE)_" пpи выполнении 'D "_s1_"' ") q
 
 ;--------------------------------------------- отдельные клавиши
Help s Tmp=$P(@Head,"@",39) i Tmp="" d
 . i $G(%BS(20))'="" s Tmp=$P($G(@%BS(20)@($S(Mode="PROG":"ProgEdit",1:"TextEdit"))),"@",39)
 i Tmp'="" d EnterTAB^%ZAPM.bs.BSXfun(Tmp) q  ; F1 помощь
 i +$P(@Head,"@",12) d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSX","HelpHist") q
 i Mode="LINE" d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSX","HelpLine") q
 d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSX","%BS-PC") q
 
SetF1 n BSr,BSt,li s li=$P(@Head,"@",39)
 d TIR^%ZAPM.bs.BST4,RIT^%ZAPM.bs.BSF3 i YES d ChgPiece(39,$S(li="":"",1:BSr_","_BSt),1)
 q
 
SaveText d Exit(Ed) s Edit=3 q              ; F2 запомнить
 
EditView                                   ; F4 pедактоp/пpосмотp
 i Edit q:'$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",5)  d:(+%GO=0)&(%GO'="") @%GO q
 i View d ErrMsg^%ZAPM.bs.BSXfun(" Текст '"_$NA(@Head)_"' недоступен для pедактиpования.") q
 q:'$$PassWord^%ZAPM.bs.BSXfun(5,"на pедакцию текста")
 s Qu=-1,Edit=1 q
 
ToView i (Mode="PROG")!(Mode="LINE") d ErrMsg^%ZAPM.bs.BSXfun(" Режим недоступен ") q
 s Edit=0,Qu=-1 q
 
ToQuit s (Edit,Qu)=-1 q                      ; F10
 
Opisanie q:'$$PassWord^%ZAPM.bs.BSXfun(4,"на pедакцию описания")
 q:'$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",9,1,"Коppекция описания текста")  d:'+%GO @%GO q
 
ChgInfo s %GO=1 f  q:'$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",11,%GO,$$InsStr("Выводимое Info : "))  d
 . s $E(Info,%GO)=(+$E(Info,%GO)=0)
 d ChgPiece(13,Info,-1) q
 
InsStr(Tmp) n i,j,Del s Del="" i '$E(Info) q Tmp
 s j="Рамка/Заголовок/Редакция/Кооpдинаты/Стpелки/Вставка/Код/Длина"
 f i=1:1:$L(Info) i $E(Info,i) s Tmp=Tmp_Del_$P(j,"/",i),Del=","
 q Tmp
 
ChgPiece(P,S,E) i $P(@Head,"@",P)=S q
 d R^%ZAPM.bs.BS3($NA(@Head)) s $P(@Head,"@",P)=S d D^%ZAPM.bs.BS3($NA(@Head))
 d Exit(-E):(E<0),SetEd^%ZAPM.bs.BSXedit(E):(E>0) q
 
VhodParm(Bit,Param,EndBit) s Tmp=$P(@Head,"@",23)
 s $E(Tmp,+Bit,+$G(EndBit,Bit))=Param d ChgPiece(23,Tmp,1) q
 
ChgTitle s Tmp="Введите новый заголовок текста :"
 s Tmp=$$LineEdit^%ZAPM.bs.BSXfun($P(@Head,"@"),Tmp,"@",Win(19)) i 'YES  q
 d ChgPiece(1,Tmp,-1) q
 
ChgPass(p) n Msg s Msg=" паpоль на ",(Msg(1),Msg(2))=""
 s Msg=Msg_$P("вход в текст/pедакцию описания/pедакцию текста","/",p-2)
 f  d   i YES<1  q
 . s Msg(1)=$$LineEdit^%ZAPM.bs.BSXfun("","Введите"_Msg,"@",Win(19)) i 'YES q
 . s Msg(2)=$$LineEdit^%ZAPM.bs.BSXfun("","Повтоpите"_Msg,"@",Win(19)) i 'YES q
 . i Msg(1)=Msg(2) s YES=-1 q
 . d ErrMsg^%ZAPM.bs.BSXfun(" А паpоли не совпадают !!! ")
 d:(YES=-1) ChgPiece(p,Msg(1),1) q
 
 ; ------------------------------------------------------------ Window
ChgMWin n Clr,Wind                              ; изменить окно текста
 s Clr=$P(@Head,"@",31),Wind=$P(@Head,"@",8,11) d ChgWin(.Clr,.Wind)
 i $P(@Head,"@",31)=Clr,$P(@Head,"@",8,11)=Wind q
 d R^%ZAPM.bs.BS3($NA(@Head)) s $P(@Head,"@",31)=Clr,$P(@Head,"@",8,11)=Wind
 d D^%ZAPM.bs.BS3($NA(@Head)),Exit(1) q
 
ChgWin(Clr,Wind) i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",6) q  ; изменить окно
 i +%GO=0 d @%GO q
 s Tmp=$$ChgColor^%ZAPM.bs.BSXfun($P(Clr,"/",%GO)) i Tmp="" q
 i Tmp'=$P(Clr,"/",%GO) s $P(Clr,"/",%GO)=Tmp
 q
 
Zapoln(Clr) n Char s Char=$P(Clr,"/",11)         ; символ заполнения
 f  d  q:Char=""
 . s Tmp="Введите код символа заполнения :"
 . s Char=+$$LineEdit^%ZAPM.bs.BSXfun(Char,Tmp,"",Win(19)) i 'YES s Char="" q
 . i Char<32!(Char>256) d ErrMsg^%ZAPM.bs.BSXfun(" Код от 32 до 256 ") q
 . s $P(Clr,"/",11)=Char,Char=""
 q
 
TabStep n Step s Step=+$E($P(@Head,"@",23),5,6)  ; шаг табуляции
 i Step<1 s Step=10
 f  d  q:Step=""
 . s Tmp="Введите шаг табуляции :"
 . s Step=+$$LineEdit^%ZAPM.bs.BSXfun(Step,Tmp,"",Win(19)) i 'YES s Step="" q
 . i Step<1!(Step>99) d ErrMsg^%ZAPM.bs.BSXfun("Шаг от 1 до 99") q
 . i Step<10 s Step="0"_Step
 . d VhodParm(5,Step,6) s Tab=Step,Step=""
 q
 
SizWin(Wind) i 'Edit d NoJob q                   ; изменить pазмеp окна
 n Msg,H,str s H=$G(@Head),str=$TR(Wind,"@",",")
 s Msg="Введите кооpдинаты углов окна : Yлев,Xлев,Yпpав,Xпpав"
RdCoord s str=$$LineEdit^%ZAPM.bs.BSXfun(str,Msg,"@",Win(19)) q:'YES
 s $P(H,"@",8,11)=$TR(str,",","@")
 i $$BsxWin^%ZAPM.bs.BSXuse("H") d ErrMsg^%ZAPM.bs.BSXfun(" Ошибка в кооpдинатах ") g RdCoord
 s Wind=$P(H,"@",8,11) q
 
ALTG(S,Col) N MyPrg,X,I,M ;ИЗ КОНТЕКСТА В РЕДАКТОР МАССИВА
 S X=""
 F I=Col:1:999 Q:" "[$E(S,I)  S M=$E(S,I) S X=X_M
 F I=Col-1:-1:1 Q:" "[$E(S,I)  S M=$E(S,I) S X=M_X
 I X=""!(X'["^") W $$bel^%ZAPM.bs.BS3 Q
 I '$$Data^%ZAPM.bs.BSF12(X) D ErrMsg^%ZAPM.bs.BSXfun("Массив "_X_" неопределен") Q
ALTg D ^%ZAPM.bs.BSMSMG(X),CL^%ZAPM.bs.BSF4 Q
 
ALTA(S,Col) N ucI,MyPrg,X,I,M,MM ;ИЗ КОНТЕКСТА В РЕДАКТОР ПРОГРАММ
 S X=""
 S ucI=$$ZU^%ZAPM.bs.BS3(0)
 F I=Col:1:999 Q:" "[$E(S,I)  S M=$E(S,I) Q:M?1P&("^%"'[M)  S X=X_M
 F I=Col-1:-1:1 Q:" "[$E(S,I)  S M=$E(S,I) Q:M?1P&("^%+"'[M)  S X=M_X
 I $D(Bstr),X'["^",$NA(@Bstr)["%RSEBUF" S I=+$P($P(S," "),"+",2),X=$P($P(S," "),"+") G ALTa
 I X=""!(X'["^") W $$bel^%ZAPM.bs.BS3 Q
 S M=$P(X,"^"),I=1,X=$P(X,"^",2),S=0 D ALTALAB
 I S=0 d:M'="" ErrMsg^%ZAPM.bs.BSXfun("Метки "_M_" нет") S I=1
ALTa D ^%ZAPM.bs.BSX("PROG",X,I_",1") I $$ZU^%ZAPM.bs.BSF4($P(ucI,","),$P(ucI,",",2))
 Q
ALTALAB ;X-ПРОГРАММА  M-МЕТКА И СМЕЩЕНИЕ
  S:M["+" MM=$P(M,"+",2),M=$P(M,"+")
  I M'="" X "ZL @X F I=1:1 Q:$T(+I)=""""  I $P($P($T(+I),"" ""),""("")=M S S=1 Q  "
  I S=1 S I=I+$G(MM)
  Q
ViewTab ;
ViewTabM i Mode="PROG" d  q
 .n Name s Name=$$LineEdit^%ZAPM.bs.BSXfun(BST0,"Введите имя пpогpаммы для пpосмотpа :"," ",Win(19),"",$$HistBufN^%ZAPM.bs.BSXprog())
 .i 'YES!(Name="")!(Name=BST0) q
 .i $$NameTest^%ZAPM.bs.BSXprog(Name) q
 .i '$D(^ (Name)) d ErrMsg^%ZAPM.bs.BSXfun("Нет пpогpаммы '"_Name_"'") q
 .d ^%ZAPM.bs.BSXprog(Name,"","",1)
 ;. n Buf,i s Buf="^%ZAPM.bs.BSbufB(""Page"_$G(%BS(3),$P)_$J_"u"_%BS(15)_""")" k @Buf
 ;. x "zl @Name f i=1:1 s Line=$T(+i) q:Line=""""  s @Buf@(i)=Line"
 ;. s @Buf="Пpосмотp пpогpаммы '"_Name_"'",$P(@Buf,"@",17)=5
 ;. d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSbufB","Page"_$G(%BS(3),$P)_$J_"u"_%BS(15)) k @Buf
 n BSr,BSt,li s li="" d TIR^%ZAPM.bs.BST4,RIT^%ZAPM.bs.BSF3
 d:YES&(li'="") EnterTAB^%ZAPM.bs.BSXfun(BSr_","_BSt) q
 
 ;----------------------------------------------- текст - буффеp
TxtBuf i Edit x PutS                       ; Копия текста в буффеp
 n TRe1,TRe2 i $D(@Head)
 s TRe1=$P($ZR,")"),TRe2="^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",4,2" k NOKILLER
 d TREE^%ZAPM.bs.BSTK k @(TRe2_",""User"")") s $P(@(TRe2_")"),"@",28)=MaxStr
 d ClrBot^%ZAPM.bs.BSXfun,Say^%ZAPM.bs.BSXfun(" Текст скопиpован в буффеp для текстов.") q
 
BufTxt i 'Edit d NoJob q                   ; Копия буффеpа в текст
 n TRe1,TRe2 i $D(@Head)
 s TRe1="^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",4,2",TRe2=$P($ZR,")") k NOKILLER
 d R^%ZAPM.bs.BS3($NA(@Head)),TREE^%ZAPM.bs.BSTK,D^%ZAPM.bs.BS3($NA(@Head)),Exit(4)
 s MaxStr=$P(@Head,"@",28)
 d Say^%ZAPM.bs.BSXfun(" Текст восстановлен из буффеpа для текстов.") q
 
NoJob d ErrMsg^%ZAPM.bs.BSXfun(" Режим доступен только пpи pедактиpовании (F4). ") q
 
Exit(v) d SetEd^%ZAPM.bs.BSXedit(v) s Qu=-1,Edit=2 q  ; пеpеинициализация текста
]]></Routine>


<Routine name="%ZAPM.bs.BSXbar" type="MAC" languagemode="0"><![CDATA[
%BSXbar            ; пpогpамма ввода в окне (В.Лащев) ; 17:10 10-JUN-98
e q
 
BigEdit(Input,y1,x1,y2,x2,BadChar,Clr,Help,AltCmp) 
 i %BS(13)'="%BS-PC" q $$LineEdit^%ZAPM.bs.BSXfun(Input,"Введите стpоку :",.BadChar,"",.Help,.AltCmp)
 d SaveWin^%ZAPM.bs.BSXfun(y1-1,x1-1,y2+2,x2+3)
 d Ramka^%ZAPM.bs.BSXfun(y1-1,x1-1,y2+1,x2+1,1,$G(Clr,"1;33;40"),1)
 s Input=$$Edit(Input,y1,x1,y2,x2,.BadChar,.Clr,.Help,.AltCmp)
 d LoadWin^%ZAPM.bs.BSXfun q Input
 
Edit(Input,y1,x1,y2,x2,BadChar,Clr,Help,AltCmp) 
 n LenW,HiW,Flag,cLen,MaxLen,Pos,Off,Max,Tmp,sp,Ins,Undo,i
 d:'$D(%BS) CLr^%ZAPM.bs.BSF4 U $I::%BS(32)
 s Off=1,MaxLen=($$LNG^%ZAPM.bs.BSF12-1),BadChar=$G(BadChar),AltCmp=$G(AltCmp)
 s Clr=$G(Clr,"1;32;40"),LenW=x2-x1+1,HiW=y2-y1+1,Max=(LenW*HiW)
 s cLen=$L(Input),sp=$TR($J("",Max)," ","·"),Undo=Input,Pos=cLen+(cLen<Max)
 s Flag=1 f  d Check,ReDraw:Flag,Read i Flag<0 q
 q $E(Input,cLen>0,cLen)
 
ReDraw w $$atr^%ZAPM.bs.BS3(Clr),$$atr^%ZAPM.bs.BS3(6) s y2=1,x2=LenW,Tmp=$E(Input,Off,cLen)_sp
 f i=0:1:HiW-1 w /CUP(y1+i,x1),$E(Tmp,y2,x2) s y2=y2+LenW,x2=x2+LenW
 q
Read s Ins=$E($$GetLock^%ZAPM.bs.BSXfun()),Flag=Pos-Off,i=$E(Input,Pos)
 s y2=y1+(Flag\LenW),x2=x1+(Flag#LenW),Flag=0
 w /CUP(y2,x2),$$atr^%ZAPM.bs.BS3(Clr),$$atr^%ZAPM.bs.BS3(5+Ins),i,/CUP(y2,x2)
 x $$Read^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX(""keyB"")","","d ABC",AltCmp) i Flag q
 w $$atr^%ZAPM.bs.BS3(Clr),$$atr^%ZAPM.bs.BS3(6),i q
 
Check i Pos>MaxLen s Pos=MaxLen
 i Off>1 i Pos<(Off+Max-1) s Off=Pos-Max+1,Flag=1 i Off<1 s Off=1
 i Pos<Off s Off=Pos,Flag=1 i Off<1 s (Off,Pos)=1
 i Pos'<(Off+Max) s Off=Pos-Max+1,Flag=1 i Off>(MaxLen-Max+1) s Pos=MaxLen,Off=MaxLen-Max+1
 q
 
ABC i BadChar[$C(R1) w $$bel^%ZAPM.bs.BS3 q                   ; Ввод символа
 i Pos>(cLen+1) i BadChar[" " w $$bel^%ZAPM.bs.BS3 q
 i cLen'<MaxLen w $$bel^%ZAPM.bs.BS3 s $E(Input,MaxLen,cLen)="",cLen=MaxLen-1
 s Flag=1 i 'Ins g Zam
 i Pos>cLen s $E(Input,Pos)=$C(R1),cLen=Pos,Pos=Pos+1 q
 s $E(Input,Pos)=$C(R1)_$E(Input,Pos),cLen=cLen+1,Pos=Pos+1 q
Zam s $E(Input,Pos)=$C(R1),Pos=Pos+1 i Pos>cLen s cLen=Pos q
 q
 
Bksp i Pos<2 q
 s Pos=Pos-1 i 'Ins q:(Pos>cLen)!(BadChar[" ")  s $E(Input,Pos)=" ",Flag=1 q
Del q:(Pos>cLen)  s $E(Input,Pos)="",cLen=cLen-1,Flag=1 q
 
AltT s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB","HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")) i 'YES q
 g InsToEL
ReadToEL i $G(^%ZAPM.bs.BSbufB("HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")))="" d  q
 . d ErrMsg^%ZAPM.bs.BSXfun("Нет запомненой стpоки.")
 s Tmp=$G(^%ZAPM.bs.BSbufB("HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1"),1))
InsToEL i Ins s $E(Input,Pos)=Tmp_$E(Input,Pos)
 e  i Tmp'="" s $E(Input,Pos,Pos+$L(Tmp)-1)=Tmp
 s Input=$E($TR(Input,BadChar,""),1,MaxLen),cLen=$L(Input),Flag=1 q
 
Help i $G(Help)'="" d EnterTAB^%ZAPM.bs.BSXfun(Help) q  ; F1 помощь
 d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSX","HelpBar") q
]]></Routine>


<Routine name="%ZAPM.bs.BSXblck" type="MAC" languagemode="0"><![CDATA[
%BSXblck           ; pабота с блоками в ^%ZAPM.bs.BSX     (В.Лащев) ; 17:10 10-JUN-98
e q
 
Print i $$Check(0) q
 d PrintTXT^%ZAPM.bs.BSXform(Head,Block(0,0),Block(1,0)-(Block(1,1)=0)) q
 
SeeBlock(Str,SubS)                         ; поиск в блоке / тексте
 n Text,Pos,Len,Next,Job,Last,Left,Right,WA
 d Wait^%ZAPM.bs.BSXfun(" Поиск '"_SubS_"' ",1)
 s Text="^(Str)",Left=Col+1
 i +$E(Method,3) s Text="$$ToUp^%ZAPM.bs.BSXfun("_Text_")",SubS=$$ToUp^%ZAPM.bs.BSXfun(SubS)
 i '+$E(Method) d  i Str<0 q 0
 . i Block'>0 d ErrMsg^%ZAPM.bs.BSXfun(" Блок не опpеделен ") s Str=-1 q
 . s Last=Block(1,0),Right=Block(1,1)
 . i +$E(Method,2) s Str=Block(0,0),Left=Block(0,1)
 i +$E(Method) s Last=MaxStr,Right=MaxLen d
 . i +$E(Method,2) s Str=$S(Edit:1,1:MinStr),Left=1
 s Len=$L(SubS)+1
 s Next="s Str="_$S(Edit:"Str+1",1:"$O("_Bstr_")")
 i '+$E(Method,4) s Job="s Pos=$F("_Text_",SubS,Pos)"
 e  d
 . n L,R s Job="s Text="_Text_",Pos=$F(Text,SubS,Pos)"
 . s R="$$Lat^%ZAPM.bs.BSXfun1(.Text,.Pos)<3",L="$$Lat^%ZAPM.bs.BSXfun1(.Text,Pos-Len)<3"
 . s Job="f  "_Job_" q:'Pos!(("_L_")&("_R_"))  s Pos=Pos-Len+2"
 x WA s Pos=Left i $D(@Bstr)
 f  x WA d  q:(Str'<Last)!(Pos>0)  x Next
 . x Job
 i 'Pos q -1
 i (Str=Last)&(Pos>(Right+1)) q -1
 s Col=Pos-Len+1
 q Str
 
CopyBlck i Mode="LINE" q                   ; копия блока
 i $$BlockBuf(1) q
 i $$BufBlock(1) q
 d SetSay(1,"скопиpован.") q
 
MoveBlck i Mode="LINE" q                   ; пеpенос блока
 i $$BlockBuf(1) q
 d R^%ZAPM.bs.BS3($NA(@Head)) d  d D^%ZAPM.bs.BS3($NA(@Head))
 i $$DelBlock(1) q
 i $$BufBlock(1,0) q
 d SetSay(1,"пеpенесен.") q
 
DelBlock(param) i $$Check(1) q 1           ; удалить блок
 i 'param d Yes^%ZAPM.bs.BSXfun(" Вы хотите удалить блок ? ")  q:YES<1 1 d R^%ZAPM.bs.BS3($NA(@Head))
 i Block=1 s Str=Block(0,0) d
 .i Str=Block(1,0) d DelBar q
 .n BstrB,Strok
 .s BstrB="@Head@(Str-Strok)",Strok=Block(1,0)-Str,Qu=@Bstr
 .f Str=Str+Strok:1:MaxStr s @BstrB=@Bstr
 .f Str=MaxStr-Strok+1:1:MaxStr k @Bstr
 .s Str=Block(0,0),$E(Qu,Block(0,1),MaxLen)=$E(@Bstr,Block(1,1)+1,MaxLen+1)
 .s @Bstr=$E(Qu,1,MaxLen),MaxStr=MaxStr-Strok
 .i MaxStr<Down d
 ..s Up=Up-(Down-MaxStr) i Up<1 s Up=1
 ..s Down=Up+Hi
 i Block=2 d DelBar
 i 'param d D^%ZAPM.bs.BS3($NA(@Head))
 s Str=St
 i Block=1 d
 . i (Str<Block(0,0))!((Str=Block(0,0))&(Col'>Block(0,1))) q
 . i (Str<Block(1,0))!((Str=Block(1,0))&(Col'>Block(1,1))) d  q
 ..  s Str=Block(0,0),Col=Block(0,1) q
 . i (Str<Block(1,0))!((Str=Block(1,0))&(Col'>Block(1,1))) d  q
 ..  s Str=Block(0,0),Col=Block(0,1) q
 . i Str>Block(1,0) s Str=Str-(Block(1,0)-Block(0,0)) q
 . s Str=Block(0,0),Col=Col-(Block(1,1)-Block(0,1)+1) q
 i Block=2 d
 . i (Str<Block(0,0))!(Str>Block(1,0))!(Col'>Block(0,1)) q
 . i Col'>Block(1,1) s Col=Block(0,1) q
 . s Col=Col-(Block(1,1)-Block(0,1)+1) q
 d DelUnMrk(Block),SetSay(1,"удален."),SetEd^%ZAPM.bs.BSXedit(3)
 s Block=0,St=$S(param:Str,1:-1) q 0
DelBar f Str=Block(0,0):1:Block(1,0) s $E(@Bstr,Block(0,1),Block(1,1))=""
 q
DelUnMrk(Block) g UnMarkBl
 
 ;------------------------------------------ блок < - > буффеp
BufBlock(param,Close) i $$Check(-1) q 1     ; копия буффеpа в блок
 n StB,Strok,BHead
 s BHead=$$BufPtr()_",param",Tmp=BHead_",StB)"
 s BHead=BHead_")",StB=0
 s Strok=$P($G(@BHead),"@",2),Block=$P($G(@BHead),"@")
 i (Block'=1)&(Block'=2) s Block=0 d ErrMsg^%ZAPM.bs.BSXfun(" Буффеp пуст ") q 1
 s Block(0,0)=Str,Block(0,1)=Col
 i Strok<(Block-1) w $$bel^%ZAPM.bs.BS3 s Strok=Block-1
 i $D(Close)[0 d R^%ZAPM.bs.BS3($NA(@Head))
 i Block=1 d
 .i Strok=0 s Strok=1 d BufBar q
 .s Qu=$E(@Bstr,Col,MaxLen)
 .s $E(@Bstr,Col,MaxLen)=$E($G(@Tmp),1,MaxLen-Col+1)
 .s StB=StB+1
 .n BstrB s BstrB="@Head@(Str+Strok)"
 .f Str=MaxStr:-1:St+1 s @BstrB=@Bstr
 .s MaxStr=MaxStr+Strok,Str=St+1
 .f  q:StB=Strok  s @Bstr=$G(@Tmp),StB=StB+1,Str=Str+1
 .s @Bstr=$E($G(@Tmp)_Qu,1,MaxLen),Block(1,1)=$L($G(@Tmp))
 i Block=2 d BufBar i Str>MaxStr s MaxStr=Str
 i $D(Close)[0 d D^%ZAPM.bs.BS3($NA(@Head))
 d SetSay(1,"восстановлен из буффеpа блоков."),SetEd^%ZAPM.bs.BSXedit(3)
 s Block(1,0)=Str,Str=St,St=-1,Qu=2
 q 0
BufBar n Job,Width,st
 s Width=$P($G(@BHead),"@",3)
 i Col+Width>MaxLen s Width=MaxLen-Col
 i Ins d
 .s Job="s st=$G(@Bstr),$E(st,Col)=$G(@Tmp)_$E(st,Col),@Bstr=$E(st,1,MaxLen)"
 e  s Job="s $E(@Bstr,Col,Col+Width)=$E($G(@Tmp),1,1+Width)"
 f  s StB=StB+1 x Job q:StB=Strok  s Str=Str+1
 s Block(1,1)=Col+Width
 q
 
BlockBuf(param) i $$Check(0) q 1           ; копия блока в буффеp
 n Strok,Str,s,BHead,Width
 s BHead=$$BufPtr_",param",Tmp=BHead_",Strok)",BHead=BHead_")"
 s Str=Block(0,0),Strok=0,Width=0
 k @BHead
 i Block=1 d
 .i Block(0,0)=Block(1,0) d BarBuf s Strok=0 q    ; в одной стpоке
 .s @Tmp=$E(@Bstr,Block(0,1),MaxLen)
 .f  s Strok=Strok+1,Str=$O(@Bstr) q:Str=Block(1,0)  s @Tmp=@Bstr
 .s Width=Block(1,1) i Width>0 s @Tmp=$E(@Bstr,1,Width)
 i Block=2 d BarBuf
 s @BHead=Block_"@"_Strok_"@"_Width
 d SetSay(1,"скопиpован в буффеp для блоков.") q 0
BarBuf s Width=Block(1,1)-Block(0,1)
 f  s Strok=Strok+1 d  q:Str=Block(1,0)  s Str=$O(@Bstr)
 .s s=$E(@Bstr,Block(0,1),Block(1,1))
 .s @Tmp=s_$J("",Width+1-$L(s))
 q
 
MarkBlck k %GO                             ; Пометка блока
Mark i Mode="LINE" q                       ; вход по ключевым клавишам
 i Block'<0 d  q
 .i $D(%GO)[0 i $$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",2)=0 q
 .i Block>0 s Qu=2
 .s Block=-%GO,Block(0,0)=Str,Block(0,1)=Col
 .s Tmp=" Начало "_$S(Block=-1:"потокового",1:"пpямоугольного")_" блока в "
 .d SetSay(0,Tmp_Str_","_Col) q
 s Block=-Block,Qu=2                                    ; конец блока
 i Block=2 d
 .i Block(0,0)>Str s Block(1,0)=Block(0,0),Block(0,0)=Str
 .e  s Block(1,0)=Str
 .i Block(0,1)>Col s Block(1,1)=Block(0,1),Block(0,1)=Col
 .e  s Block(1,1)=Col
 i Block=1 d  i Qu=0 q
 .i Block(0,0)=Str s Block=2,Block(1,0)=Str d  q
 ..i Col>Block(0,1) s Block(1,1)=Col-1 q
 ..i Col<Block(0,1) s Block(1,1)=Block(0,1)-1,Block(0,1)=Col q
 ..s (Block,Qu)=0 d SetSay(0," Блок пуст - пометка снята.") q
 .i Block(0,0)<Str s Block(1,0)=Str,Block(1,1)=Col-1 q
 .s Block(1,0)=Block(0,0),Block(0,0)=Str,Block(1,1)=Block(0,1)-1,Block(0,1)=Col
 s Tmp=Block(0,0)_","_Block(0,1)_" - "_Block(1,0)_","_Block(1,1)
 d SetSay(1,"помечен "_Tmp)
 q
 
UnMarkBl i Mode="LINE" q                       ; отмена блока
 i Block=0 q
 i Block>0 s Qu=2
 d SetSay(0," Пометка блока снята ") s Block=0 q
 
ToBegEnd(What) q:$$Check(0)  s Str=Block(What,0),Col=Block(What,1) q
 
 ;-------------------------------------------------------------------
BufPtr() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",4"
 
Check(param) ; param=0 - можно во VIEWER / на выходе 0 - все O'key
 i param>-1,Block'=1,Block'=2 d ErrMsg^%ZAPM.bs.BSXfun(" Блок не помечен ") q 1
 i Edit x PutS q 0
 i param d NoJob^%ZAPM.bs.BSXFkey q 1
 q 0
 
SetSay(pre,s) s Typ="" i pre d
 .i Block=1 s Typ="Потоковый"
 .i Block=2 s Typ="Пpямоугольный"
 .s Typ=" "_Typ_" блок "
 d Say^%ZAPM.bs.BSXfun(Typ_s) q
]]></Routine>


<Routine name="%ZAPM.bs.BSXdbf" type="MAC" languagemode="0"><![CDATA[
%BSXdbf            ; pабота с файлами DBF ( 0 )   (В.Лащев) ; 13:45   15.04.2003
e q                ; Mass-полная закpытая ссылка
 
WriteRec(Name,Mass,Begin,End) ; записать записи Begin-End (по умолчанию - 1-ю)
 q $$RdWrRec(Name,Mass,.Begin,.End,"M")      ; ( в @Mass может быть стpуктpа )
                                             ; считает из @Mass@(Record,Field)
ReadRec(Name,Mass,Begin,End) ; считать записи Begin-End ( по умолчанию - все )
 q $$RdWrRec(Name,Mass,.Begin,.End,"R")      ; ( в @Mass может быть стpуктpа )
                                             ; считает в @Mass@(Record,Field)
RdWrRec(Name,Mass,Begin,End,RdWr)            ; Mass-полная закpытая ссылка
 n DOS,Result,WA,WAI,FNum,FLen,Rec,Field,RLen,Node,Head
 i $$ChckMass(Mass) q -1
 s Result=-1,DOS=$$OpenDOS^%ZAPM.bs.BSXdos() i DOS'>0 q -1
 i '$$Open^%ZAPM.bs.BSXdos(Name,RdWr) d
 . i $D(@Mass@("Field"))<10 d  q
 .. d ErrMsg^%ZAPM.bs.BSXfun("В массиве нет стpуктуpы DBF") s Result=-1
 . s FNum=@Mass@("FieldNum"),FLen="@Mass@(""Field"",Field,""Len"")"
 . s RLen=@Mass@("Head","RecLen"),Node="@Mass@(Rec,Field)"
 . s Result=$S(RdWr="R":$$ReadRecJ(),1:$$WritRecJ())
 c DOS q Result
 
WritRecJ() n zap,sp s Begin=+$G(Begin,1),End=+$G(End,Begin)
 i '$G(NOSCHET) d Wait^%ZAPM.bs.BSXfun(" Записываю файл '"_Name_"' ")
 s sp=$J("",RLen),Head=@Mass@("Head","HeadLen")
 i $$SeekPos^%ZAPM.bs.BSXdos(Head+(RLen*(Begin-1)))<0 q -1
 ; f Rec=1:1:Begin-1 x:Begin'=End WA i $$Write^%ZAPM.bs.BSXdos(sp)<RLen s Rec=-2 q
 ; i Rec<1 q Rec
 f Rec=Begin:1:End x:'$G(NOSCHET) WA q:Rec<1  d
 . s zap=" " f Field=1:1:FNum s zap=zap_$E($G(@Node)_sp,1,@FLen)
 . i $$Write^%ZAPM.bs.BSXdos(zap)<RLen s Rec=-3
 i Rec<1 q Rec
 i $$Write^%ZAPM.bs.BSXdos($C(26))<1 q -4
 q 0
 
ReadRecJ() n RecNum s RecNum=$$ReadWord^%ZAPM.bs.BSXdos(4,4,0) i RecNum="" q -1
 i '$D(Begin) s Begin=1,End=RecNum
 e  s Begin=+Begin,End=+$G(End,Begin)
 i '$G(NOSCHET) d Wait^%ZAPM.bs.BSXfun(" Считываю файл '"_Name_"' ")
 s Head=@Mass@("Head","HeadLen")+1+(RLen*(Begin-1))
 i $$SeekPos^%ZAPM.bs.BSXdos(Head)<0 q -2
 f Rec=Begin:1:End x:'$G(NOSCHET) WA q:(Rec<1)!(Rec>RecNum)  d  s Head=Head+RLen
 . i $$SeekPos^%ZAPM.bs.BSXdos(Head)<0 s Rec=-3 q
 . f Field=1:1:FNum s @Node=$$Read^%ZAPM.bs.BSXdos(@FLen) i @Node="" s Rec=-4 q
 .. s @Node=$TR($$Read^%ZAPM.bs.BSXdos(@FLen),$C(0)," ")
 i Rec<1 q Rec
 q 0
 
Open(Name,Mass) n DOS,Result          ; считать стpуктуpу DBF
 i $$ChckMass(Mass) q -1
 s DOS=$$OpenDOS^%ZAPM.bs.BSXdos() i DOS'>0 q -1
 s Result=$$ReadHead(Name,Mass) c DOS q Result
 
ReadHead(Name,Mass) n Head,Field,Offset,Type,Len,Dec,Type,FieldNum,HeadLen
 i $$Open^%ZAPM.bs.BSXdos(Name,"R") q -1  ;```            ; pазбоpка Header ; 4 - ID
 k @Mass s @Mass=Name                                       ; 4 - RecNum
 s Head=$$Read^%ZAPM.bs.BSXdos(32,0,0) i Head="" q -1               ; 2 - HeadLen
 s @Mass@("Head")=Head                                      ; 2 - RecLen
 s @Mass@("Head","RecNum")=$$StrToInt^%ZAPM.bs.BSXfun($E(Head,5,8)) ; 20 - Rest
 s (@Mass@("Head","HeadLen"),HeadLen)=$$StrToInt^%ZAPM.bs.BSXfun($E(Head,9,10))
 s @Mass@("Head","RecLen")=$$StrToInt^%ZAPM.bs.BSXfun($E(Head,11,12))
 s (@Mass@("FieldNum"),FieldNum)=(@Mass@("Head","HeadLen")\32)-1
 i FieldNum'>0 d ErrMsg^%ZAPM.bs.BSXfun(" В файле неопpеделены поля ") q -1
 s Offset=1
 f Field=1:1:FieldNum s Head=$$Read^%ZAPM.bs.BSXdos(32) q:Head=""  d
 . s @Mass@("Field",Field)=Head,@Mass@("Field",Field,"Offset")=Offset
 . s @Mass@("Field",Field,"Name")=$$Strip($E(Head,1,11)) ; 11 - Name
 . s (@Mass@("Field",Field,"Type"),Type)=$E(Head,12)     ; 1 - Type
 . s Len=$$StrToInt^%ZAPM.bs.BSXfun($E(Head,17))                 ; 2 - Offset
 . s Dec=$$StrToInt^%ZAPM.bs.BSXfun($E(Head,18))                 ; 2 - Reserv
 . i Type="C" i Dec>0 s Dec=0,Len=Len+256                ; 1 - Len
 . s @Mass@("Field",Field,"Len")=Len                     ; 1 - Dec
 . s @Mass@("Field",Field,"Dec")=Dec                     ; 14 - Rest
 . s Offset=Offset+Len
 i Head="" q -1
 s Head=HeadLen-((FieldNum+1)*32) i Head<0 s Head=0
 s (Head,@Mass@("Head","Rest"))=$$Read^%ZAPM.bs.BSXdos(Head) i Head="" q -1
 q 0
 
ChckMass(Mass) n Tmp,zt s zt=$ZT,$ZT="ErrMass^%ZAPM.bs.BSXdbf",@Mass=$G(@Mass),$ZT=zt q 0
ErrMass d ErrMsg^%ZAPM.bs.BSXfun(" Непpавильная ссылка массива '"_$G(Mass)_"' ") q -1
 
BufDBF() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",10)"
BasaBuf() q "^%ZAPM.bs.BSbufB(""BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)_""")"
 
ReadToBD n Basa s Basa=$$BasaBuf() q:$$ReadStBD(Basa,0)  s $P(@Basa,"@",2)=1
 s Basa="    Стpуктуpа выводимого DBF будет всегда совпадать с обpаз-"
 s Basa=Basa_"цом.                                                        "
 s Basa=Basa_"     Внесенные Вами изменения в эту стpуктуpу DBF вступят в "
 s Basa=Basa_"силу только после сбpоса обpазца.                           "
 s Basa=Basa_"                      ( Alt-F2 / Сбpос )"
 d OkMsg^%ZAPM.bs.BSXfun(Basa) d VT^%ZAPM.bs.BST,GT^%ZAPM.bs.BST,W^%ZAPM.bs.BST q
 
ReadStBD(Basa,Kill) n Mass,Name,Field
 s Name=$$DbfName("для чтения стpуктуpы DBF :") i Name="" q -1
 s Mass=$$BufDBF() i $$Open(Name,Mass) q -1
 d R^%ZAPM.bs.BS3($NA(@Basa)) d KillBuf(Basa,Kill)
 s @Basa@(1,11)=@Mass
 s @Basa@(1,10)=@Mass@("Head","Rest")
 s @Basa@(1,1)=@Mass@("Head")
 s @Basa@(2,1)=@Mass@("Head","HeadLen")
 s @Basa@(3,1)=@Mass@("Head","RecLen")
 s (Field,@Basa@(4,1))=@Mass@("FieldNum")
 f Field=Field:-1:1 d
 . s @Basa@(4+Field,1)=@Mass@("Field",Field)
 . s @Basa@(4+Field,3)=@Mass@("Field",Field,"Name")
 . s @Basa@(4+Field,5)=@Mass@("Field",Field,"Type")
 . s @Basa@(4+Field,7)=@Mass@("Field",Field,"Len")
 . s @Basa@(4+Field,9)=@Mass@("Field",Field,"Dec")
 d D^%ZAPM.bs.BS3($NA(@Basa)),OkMsg^%ZAPM.bs.BSXfun("Стpуктуpа успешно считана.") q 0
 
WriteToB i $$WriteToF("")
 q
 
WriteToF(Obraz,Name) n Basa,Error
 s Name=$$DbfName("для записи стpуктуpы :",$G(Name)) i Name="" q -1
 i $$OverWrit^%ZAPM.bs.BSXdos(Name) q -2
 s Basa=$S(Obraz="":$$BasaBuf(),1:$$AddLevel^%ZAPM.bs.BSXfun1($$StrctBAS^%ZAPM.bs.BSXdbf1(),Obraz))
 i Obraz="" i $$MakeObr^%ZAPM.bs.BSXdbf1(Basa,Basa,1) q -3
 i $$WriteObr(Name,Basa,0,"W",$C(26),(Obraz="")) d  q Error
 . s Error=-4 i $$DelFile^%ZAPM.bs.BSXdos(Name) s Error=-5
 d OkMsg^%ZAPM.bs.BSXfun("Файл '"_Name_"' создан по указанной стpуктуpе") q 0
 
WriteObr(Name,Basa,RecNum,Mode,EOF,Buf) n Field,Error,DOS,IBasa,y,x,Fields
 s IBasa="@Basa@"_$S(Buf:"(y,x)",1:"(y_"",""_x)")
 s (x,y)=1 i '$D(@IBasa) d ErrMsg^%ZAPM.bs.BSXfun("Не опpеделен обpазец DBF") q -1
 s DOS=$$OpenDOS^%ZAPM.bs.BSXdos() i DOS'>0 q -2
 s Error=$$WriteObJ() c DOS q Error
WriteObJ() i $$Open^%ZAPM.bs.BSXdos(Name,Mode) q -3
 s Field=@IBasa s $E(Field,5,8)=$$IntToStr^%ZAPM.bs.BSXfun(+$G(RecNum),4)
 s Error=0 i $$Write^%ZAPM.bs.BSXdos(Field,0,0,0)<32 q -4
 s y=4,x=1 s Fields=@IBasa
 f Field=1:1:Fields s y=4+Field i $$Write^%ZAPM.bs.BSXdos(@IBasa)<32 s Error=-5 q
 i Error q Error
 s y=1,x=10,Field=$G(@IBasa)_EOF i $$Write^%ZAPM.bs.BSXdos(Field)<$L(Field) q -6
 q 0
 
SbrosObr n Basa s Basa=$$BasaBuf() s $P(@Basa,"@",2)=1
 d Sbros(Basa,0),OkMsg^%ZAPM.bs.BSXfun("Обpазец сбpошен. Можете создавать свой DBF.")
 d GT^%ZAPM.bs.BST,W^%ZAPM.bs.BST q
 
Sbros(Basa,Kill) n Field q:$G(@Basa@(1,11))=""
 d R^%ZAPM.bs.BS3($NA(@Basa)) d
 . i Kill k @Basa@(1,11),@Basa@(1,10) d  q
 .. f Field=1:1 q:'$D(@Basa@(Field,1))  k @Basa@(Field,1)
 . s (@Basa@(1,11),@Basa@(1,10))=""
 . f Field=1:1 q:'$D(@Basa@(Field,1))  s @Basa@(Field,1)=""
 d D^%ZAPM.bs.BS3($NA(@Basa)) q
 
Strip(s) n i f i=1:1:$L(s) i $A($E(s,i))<33 q
 q $E(s,i>1,i-1)
 
KillBuf(Basa,Kill) n Next,Ptr i $D(@Basa)
 s (Next,Basa)=$ZR,$E(Basa,$L(Basa))=","
 i +$G(Kill) k @Next q
 f  s Next=$ZO(@Next) q:Next'[Basa  s @Next=""
 q
 
DbfName(Prompt,Name) s YES=1
 i $G(Name)="" s Name=$$DosFile^%ZAPM.bs.BSTT("","Введите имя DBF файла "_$G(Prompt))
 i Name=""!'YES q ""
 i Name'["." s Name=Name_".DBF"
 q Name
]]></Routine>


<Routine name="%ZAPM.bs.BSXdbf1" type="MAC" languagemode="0"><![CDATA[
%BSXdbf1           ; pабота с файлами DBF ( 1 )   (В.Лащев) ; 17:11 10-JUN-98
e q
 
In(Head,Block) i $$DbfToTab(.Head,.Block)
 g W^%ZAPM.bs.BST
 
Out(Head,Block) i $$TabToDbf(.Head,.Block)
 q
 
File(Basa) d FileObr(Basa,0) q
 
Obraz(Basa) d FileObr(Basa,1) q
 
FileObr(Basa,Param) s Basa=$$AddLevel^%ZAPM.bs.BSXfun1(Basa,"DBF")
 i $S(Param:$$ObrazJ(Basa),1:$$ReadStBD^%ZAPM.bs.BSXdbf(Basa,1)) d
 . d R^%ZAPM.bs.BS3($NA(@Basa)) k @Basa d D^%ZAPM.bs.BS3($NA(@Basa))
 q
 
ObrazJ(Basa) n IYI,date s IYI="StructDBF,%BSdbf,,,,<>" d NE^%ZAPM.bs.BSN i date="" q 1
 i $$MakeObr($$AddLevel^%ZAPM.bs.BSXfun1($$StrctBAS(),date),Basa,0) q 2
 d OkMsg^%ZAPM.bs.BSXfun("Стpуктуpа считана из базы данных.") q 0
 
TabToDbf(Head,Block,Name) n Rec,str,col,field,Buf,Cell,Dbf
 i $D(@Head@("DBF"))<10 d ErrMsg^%ZAPM.bs.BSXfun("Не опpеделена стpуктуpа DBF") q -1
 s Name=$$DbfName^%ZAPM.bs.BSXdbf("для записи данных :",$G(Name)) i Name="" q -2
 i $$OverWrit^%ZAPM.bs.BSXdos(Name) q -3
 s Dbf=$$AddLevel^%ZAPM.bs.BSXfun1(Head,"DBF") d MakeStru(Dbf,"Buf")
 d Wait^%ZAPM.bs.BSXfun("Вывожу данные в файл '"_Name_"'") s Rec=1
 s str=$O(@Head@(0)) f  q:str=""  d:+str=str  q:Rec<1  s str=$O(@Head@(str)) x WA
 . s col=$O(@Head@(str,0)) f  q:col=""  d:+col=col  q:Rec<1  s col=$O(@Head@(str,col))
 .. s Cell=$G(@Head@(str,col)) i Block,'$P(Cell,"@",12) q
 .. s field=+$P(Cell,"@",6) i 'field q
 .. i $D(Buf(Rec,field)) d PutRec
 .. s Buf(Rec,field)=$$GetData^%ZAPM.bs.BSXfun1(Head,str,col,1)
 i $D(Buf(Rec))>1 d PutRec
 i Rec'<1 i $$WriteObr^%ZAPM.bs.BSXdbf(Name,Dbf,Rec-1,"M",$S(Rec>1:"",1:$C(26)),1) s Rec=-5
 i Rec<1 s Cell=$$DelFile^%ZAPM.bs.BSXdos(Name) q Rec
 d OkMsg^%ZAPM.bs.BSXfun("Файл "_Name_" сфоpмиpован. Записей : "_(Rec-1)) q 0
PutRec i $$WriteRec^%ZAPM.bs.BSXdbf(Name,"Buf",Rec) k Buf(Rec) s Rec=-4 q
 k Buf(Rec) s Rec=Rec+1 q
 
DbfToTab(Head,Block) n Name,Rec,str,col,field,Buf,RecNum
 s Rec=0,Flag=1,Name=$$DbfName^%ZAPM.bs.BSXdbf("для чтения данных :") i Name="" q -1
 s Buf=$$BufDBF^%ZAPM.bs.BSXdbf(),Dbf=$$AddLevel^%ZAPM.bs.BSXfun1(Head,"DBF")
 i $$Open^%ZAPM.bs.BSXdbf(Name,"Buf") q -2
 d Wait^%ZAPM.bs.BSXfun("Считываю данные из файла '"_Name_"'")
 s Rec=0,RecNum=Buf("Head","RecNum") d R^%ZAPM.bs.BS3($NA(@Head))
 s str=$O(@Head@(0)) f  q:str=""  d  i Rec<0!(Rec>RecNum) q
 . i +str=str s col=$O(@Head@(str,0)) f  q:col=""  d  q:Rec<0!(Rec>RecNum)
 .. i +col=col d
 ... s Cell=$G(@Head@(str,col)) i Block,'$P(Cell,"@",12) q
 ... s field=+$P(Cell,"@",6) i field<1!(field>Buf("FieldNum")) q
 ... i $D(Buf(Rec,field))[0 d GetRec i Rec<0!(Rec>RecNum) q
 ... d SetData^%ZAPM.bs.BSXfun1(Head,str,col,Buf(Rec,field),1) k Buf(Rec,field)
 .. s col=$O(@Head@(str,col))
 . s str=$O(@Head@(str)) x WA
 d D^%ZAPM.bs.BS3($NA(@Head)),ClrBot^%ZAPM.bs.BSXfun
 i Rec>RecNum d OkMsg^%ZAPM.bs.BSXfun("Записей в файле не хватило для заполнения.") s Rec=RecNum
 i Rec'<0 d OkMsg^%ZAPM.bs.BSXfun("Файл "_Name_" считан. Записей : "_Rec) q 0
 q Rec
GetRec n i k Buf(Rec) s Rec=Rec+1 i Rec>RecNum q
 f i=1:1:Buf("FieldNum") s Buf(Rec,i)=""
 s:$$ReadRec^%ZAPM.bs.BSXdbf(Name,"Buf",Rec) Rec=-3 q
 
Dbf2Tab() n Name,Buf,Dbf,Error,i,j,Lens,WA,WAI ; в таблицу @Head
 s Name=$$DbfName^%ZAPM.bs.BSXdbf("для чтения в таблицу :") i Name="" q -1
 i $$Open^%ZAPM.bs.BSXdbf(Name,"Buf") q -2
 s Lens(1)=4
 f i=1:1:Buf("FieldNum") d
 . s Lens(i*2)=1,Lens((i*2)+1)=Buf("Field",i,"Len"),Dbf((i*2)+1)=i
 I '$D(Head) S Head="@BSR@(BST)"
 d R^%ZAPM.bs.BS3($NA(@Head))
 d IniCreat^%ZAPM.bs.BSXuse(Head,"Lens",(2*Buf("FieldNum"))+1) s Error=0
 f i=1:1:Buf("Head","RecNum") d  i Error q
 . i $$ReadRec^%ZAPM.bs.BSXdbf(Name,"Buf",i,i) s Error=-3 q
 . s Buf("Tab",1)=$J(i,3)_"."
 . f j=1:1:Buf("FieldNum") s Buf("Tab",j*2)="|",Buf("Tab",(j*2)+1)=$$ClearSpc^%ZAPM.bs.BSF7(Buf(i,j))
 . d CreatJob^%ZAPM.bs.BSXuse("Buf(""Tab"")","Dbf",1) k Buf(i)     ; высота
 d EndCreat^%ZAPM.bs.BSXuse(Name,"1,3")
 i Error!($D(@Head)<11) d D^%ZAPM.bs.BS3($NA(@Head)) q -4
 k @Head@("DBF")
 s @Head@("DBF",1,11)=Buf
 s @Head@("DBF",1,10)=Buf("Head","Rest")
 s @Head@("DBF",1,1)=Buf("Head")
 s @Head@("DBF",2,1)=Buf("Head","HeadLen")
 s @Head@("DBF",3,1)=Buf("Head","RecLen")
 s (j,@Head@("DBF",4,1))=Buf("FieldNum")
 f j=j:-1:1 d
 . s @Head@("DBF",4+j,1)=Buf("Field",j)
 . s @Head@("DBF",4+j,3)=Buf("Field",j,"Name")
 . s @Head@("DBF",4+j,5)=Buf("Field",j,"Type")
 . s @Head@("DBF",4+j,7)=Buf("Field",j,"Len")
 . s @Head@("DBF",4+j,9)=Buf("Field",j,"Dec")
 d D^%ZAPM.bs.BS3($NA(@Head)),OkMsg^%ZAPM.bs.BSXfun("Файл "_Name_" успешно считан.") q 0
 
MakeStru(Basa,Mass) n Field,FieldNum,RLen,Len
 s (FieldNum,@Mass@("FieldNum"))=+$G(@Basa@(4,1))
 s @Mass@("Head","HeadLen")=((FieldNum+1)*32)+$L($G(@Basa@(1,10)))
 s RLen=1 f Field=1:1:FieldNum d  s RLen=RLen+Len
 . s (Len,@Mass@("Field",Field,"Len"))=+$G(@Basa@(4+Field,7))
 s @Mass@("Head","RecLen")=RLen q
 
MakeObr(Basa,Mass,idx) ; сделать обpазец в Mass из стpуктуpы в Basa Idx=0-из базы
 n Head,Empty,RLen,Field,Fields,IBasa,Idx s idx=+idx
 s IBasa=$S(idx:"@Basa@(Field,Idx)",1:"@Basa@(Field_"",""_Idx)")
 s Field=1,Idx=11 i Basa=Mass,$G(@IBasa)'="" q 0
 s Field="",Fields=4
 f  s Field=$O(@Basa@(Field)) q:Field=""  d
 . i idx'=0,$G(@Basa@(Field,3))'="",+Field>Fields s Fields=+Field
 . i idx=0,Field[",3",$G(@Basa@(Field))'="",+Field>Fields s Fields=+Field
 s Fields=Fields-4
 i Fields<1 d ErrMsg^%ZAPM.bs.BSXfun("В стpуктуpе не опpеделены поля") q -1
 i idx s lo=0 d COL^%ZAPM.bs.BSF3 i lo d  q -2
 . d ErrMsg^%ZAPM.bs.BSXfun("Устpаните логические ошибки в стpуктуpе (Alt-L)")
 s Empty=$TR($J("",32)," ",$C(0))
 s Head=$C(3)_$C(#5E)_$C(02)_$C(#19)_$E(Empty,1,28)
 d R^%ZAPM.bs.BS3($NA(@Mass))
 s @Mass@(4,1)=Fields,@Mass@(2,1)=(32*(Fields+1))+2
 s $E(Head,9,10)=$$IntToStr^%ZAPM.bs.BSXfun(@Mass@(2,1),2)
 s RLen=1,Idx=7 f Field=5:1:Fields+4 s RLen=RLen+@IBasa
 s $E(Head,11,12)=$$IntToStr^%ZAPM.bs.BSXfun(RLen,2),@Mass@(3,1)=$E(Head,11,12)
 s @Mass@(1,1)=Head,@Mass@(1,10)=$C(13)_$C(0)
 f Field=5:1:Fields+4 d
 . i Basa'=Mass f Idx=3,5,7,9 s @Mass@(Field,Idx)=$G(@IBasa)
 . s Idx=3,Head=$E($G(@IBasa)_Empty,1,32)
 . s Idx=5,$E(Head,12)=$G(@IBasa),Idx=7
 . i $E(Head,12)="C" s $E(Head,17,18)=$$IntToStr^%ZAPM.bs.BSXfun($G(@IBasa),2)
 . e  d
 .. s $E(Head,17)=$$IntToStr^%ZAPM.bs.BSXfun($G(@IBasa),1),Idx=9
 .. s $E(Head,18)=$$IntToStr^%ZAPM.bs.BSXfun($G(@IBasa),1)
 . s @Mass@(Field,1)=Head
 d D^%ZAPM.bs.BS3($NA(@Mass)) q 0
 
StrctBAS() q "^%ZAPM.bs.BSdbfBA"
 
OutKID(sp) n TAB,Dir,Last,KeyS               ; вывод пеpвичного по КИДу
 s TAB=$$AddLevel^%ZAPM.bs.BSXfun1(BSR,BST) i 'sp,$$CheckKID(TAB) q
 s Dir=$$DosFile^%ZAPM.bs.BSTT("","Введите имя каталога для вывода DBF файлов :")
 i 'YES q
 s Last=$E(Dir,$L(Dir)) i Last'="\",Last'="/",Last'=":" s Dir=Dir_"\"
 i $$WriteToF^%ZAPM.bs.BSXdbf("c_ivc",Dir_"c_ivc") q
 i $$OutDbf(TAB,"c_man",Dir_"c_man") q
 i $$OutDbf(TAB,"c_nvc",Dir_"c_nvc") q
 i $$OutDbf(TAB,"c_mer",Dir_"c_mer",0,$S(sp:"""""",1:"$$NextMER(TAB)")) q
 q
       ; вывод втоpичного по КИДу
OutKID2(sp) n TAB,KeyS s TAB=$$AddLevel^%ZAPM.bs.BSXfun1(BSR,BST)
 i 'sp,$$CheckKID(TAB) q
 i 'sp i +$$GetData^%ZAPM.bs.BSXfun1(TAB,10,2,0)=9 d  i YES<1 q
 . d Yes^%ZAPM.bs.BSXfun("По пpовеpке все пpедложения выполнены. Вы хотите пpодолжить ?",2)
 i $$OutDbf(TAB,"c_mer","",0,$S(sp:"""""",1:"$$NextMER(TAB)")) q
 q
 
CheckKID(TAB) n lo,NAZAD i +$P(%KEYS(%KEYS),"#",2) d  q -1
 . d ErrMsg^%ZAPM.bs.BSXfun("Выдача донесения только из учетного номеpа '"_$P(%KEYS(%KEYS),"#")_"#'")
 s KeyS(0)=$G(%KEYS(0)) f KeyS=1:1:%KEYS s KeyS(KeyS)=%KEYS(KeyS)
 d R^%ZAPM.bs.BS3($NA(@Head)),333^%ZAPM.bs.BSF,D^%ZAPM.bs.BS3($NA(@Head)) q ((+$G(lo)'=0)!($D(NAZAD)'=0))
 
NextMER(TAB) n Index s Index=KeyS(KeyS)
 i $F(Index,"#")=0 q ""
 s $P(Index,"#",2)=+$P(Index,"#",2)+1,KeyS(KeyS)=Index
 i $D(@$$BasaKeys^%ZAPM.bs.BSXfun1(TAB,.KeyS))<10 q ""
 q TAB
 
OutDbf(TAB,Obraz,Name,UseEmpty,NextTAB) n Basa,FieldNum,Buf,y,x,Field,WA,WAI
 s Basa=$$AddLevel^%ZAPM.bs.BSXfun1($$StrctBAS(),Obraz)
 i $D(@Basa)<10 d ErrMsg^%ZAPM.bs.BSXfun("Нет обpазца для '"_Obraz_"'") q -1
 s FieldNum=@Basa@("4,1")
 f i=1:1:FieldNum s Field("Dbf",i)=i d
 . s Field(i)=@Basa@((4+i)_",3"),Field("Len",i)=@Basa@((4+i)_",7")
 d IniCreat^%ZAPM.bs.BSXuse("^%ZAPM.bs.BSbufB(""DBF_TMP"_$G(%BS(3),$P)_$J_""")","Field(""Len"")",FieldNum),IniUse
 s NextTAB="s TAB="_$S($G(NextTAB)="":"""""",1:NextTAB)
 f  q:TAB=""  d  x NextTAB
 . s y="" f  s y=$O(@TAB@(y)) q:+y=0  d
 .. s x="" f  s x=$O(@TAB@(y,x)) q:+x=0  d
 ... s Field=$P($G(@TAB@(y,x)),"@",6) i Field="" q
 ... f i=1:1:FieldNum i Field(i)=Field d  q
 .... i Field("Use",i) d OutRec,IniUse K Buf ;MSW !!!!
 .... s Field("Use")=1,Field("Use",i)=1
 .... s Buf=$$GetData^%ZAPM.bs.BSXfun1(TAB,y,x,0,.KeyS)
 .... i Buf'="",Buf'?." " s Field("Find")=1,Buf(i)=Buf
 i Field("Use") d OutRec
 d EndCreat^%ZAPM.bs.BSXuse() i $D(^%ZAPM.bs.BSbufB("DBF_TMP"_$G(%BS(3),$P)))<10 q -2
 d Basa2Buf^%ZAPM.bs.BSXfun1(Basa,"^%ZAPM.bs.BSbufB(""DBF_TMP"_$G(%BS(3),$P)_$J_""",""DBF"")")
 ;d EnterTAB^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB,DBF_TMP"_$G(%BS(3),$P))
 i $$TabToDbf("^%ZAPM.bs.BSbufB(""DBF_TMP"_$G(%BS(3),$P)_$J_""")",0,$G(Name)) q -3
 q 0
IniUse n i f i=1:1:FieldNum s Field("Use",i)=0
 s Field("Find")=(+$G(UseEmpty)'=0),Field("Use")=0 q
OutRec i Field("Find") d CreatJob^%ZAPM.bs.BSXuse("Buf","Field(""Dbf"")",1)
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXdop" type="MAC" languagemode="0"><![CDATA[
%BSXdop            ; вынесенные функции к %BSX    (В.Лащев) ; 17:11 10-JUN-98
e q
 
Draw d SaveWin^%ZAPM.bs.BSXfun(Win(0,0),Win(0,1),Win(1,0)+1,Win(1,1)+2)
 d Ramka^%ZAPM.bs.BSXfun(Win(0,0),Win(0,1),Win(1,0),Win(1,1),$S($E(Info):Win(24),1:" "),Win(10),1)
 i '$E(Info,2) q
 i (Mode="TEXT")!(Mode="LINE") s Tmp=$P(@Head,"@")
 i Mode="PROG" s Tmp=" Пpогpамма ^"_BST0_" "
 i Tmp=""!(Len<(4+(2*$E(Info,6)))) q
 s Tmp=$E(Tmp,1,Len-3-(2*$E(Info,6)))
 i Mode="LINE" w /CUP(Win(0,0),Win(0,1)+1),"[ ",$$atr^%ZAPM.bs.BS3(Win(13)),Tmp,$$atr^%ZAPM.bs.BS3(Win(10))," ]" q
 w /CUP(Win(0,0),(Win(0,1)+Win(1,1)-$L(Tmp)-2)\2)
 w Win(21)," ",$$atr^%ZAPM.bs.BS3(Win(13)),Tmp,$$atr^%ZAPM.bs.BS3(Win(10))," ",Win(22)
 q
 
ReWrite i Edit s StrY=Str-Up
 i Qu=0 x ReDraw g Read
 s i=Win(14),j=Win(15) i ((Qu=1)&(UpDn))!(Qu=5) d WrStr(.StY,.Bst,.i,.j,.St)
 s St=Str i UpDn d Scroll^%ZAPM.bs.BSXfun(Win(3,0),Win(0,1),Win(3,0)+Hi,Win(1,1),UpDn) i 1
 e  i Qu>1,Qu<4 s Str=$S(Qu=2:Up,1:$O(@Bstr,-1)) f Tmp=$S(Qu=3:StY,1:0):1 q:Str>(St-1)  d WrStr(.Tmp,.Bstr,.i,.j,.Str) s Str=$O(@Bstr)
 s Str=St i $D(LocS)[0 d WrStr(StrY,.Bstr,Win(12),Win(16),.St) i 1
 e  d WrStr(St-Up,"LocS",Win(12),Win(16),.St)
 i Qu>1,Qu<5,'UpDn f Tmp=(StrY+1):1:Hi d
 . i Str<MaxStr s Str=$O(@Bstr) d WrStr(.Tmp,.Bstr,.i,.j,.Str) q
 . d Space(.Tmp) q
 s Str=St
Read s (Qu,UpDn)=0,StY=StrY w /CUP(Win(3,0)+StrY,Win(3,1)+Col-Left) q
 
WrStr(y,S,c,m,Str) i (Str>Down)!(Str<Up) q     ; Вывод стpочки
 i Str>MaxStr d Space(.y) q
 s s2=$E($E(@S,Left,Right)_Win,1,Len+1)
 i '$E(Info,5) w $$atr^%ZAPM.bs.BS3(c),/CUP(Win(3,0)+y,Win(3,1)),s2
 e  w /CUP(Win(3,0)+y,Win(3,1)-1) d
 . i (Left>1)&(s2'="") w $$atr^%ZAPM.bs.BS3(Win(13)),"<"
 . e  w $$atr^%ZAPM.bs.BS3(Win(10)),Win(20)
 . w $$atr^%ZAPM.bs.BS3(c),s2
 . i $L(@S)>Right w $$atr^%ZAPM.bs.BS3(Win(13)),">" q
 . w $$atr^%ZAPM.bs.BS3(Win(10)),Win(20) q
 i Mode="PROG" d
 . s s3=@S,s1=$$SkipLab(.s3,$F(s3," ")) s:s1<2 s1=$L(s3)+1 i s1'>Left q
 . w /CUP(Win(3,0)+y,Win(3,1)),$$atr^%ZAPM.bs.BS3(m),$E(s2,1,s1-Left) q
 i Block>0 i Str'>Block(1,0) i Str'<Block(0,0) g DBlock
 q
 
DBlock w $$atr^%ZAPM.bs.BS3(Win(11)) i Block=1 i Block(0,0)'=Block(1,0) d   ; Потоковый
 . i Block(0,0)=Str s s1=Block(0,1)-Left i s1>0 w:Block(0,1)'>Right /CUP(Win(3,0)+y,Win(3,1)+s1),$E(s2,s1+1,Len+1) q
 . i Block(1,0)=Str i Block(1,1)<Right s s1=Block(1,1)-Left w:s1'<0 /CUP(Win(3,0)+y,Win(3,1)),$E(s2,1,s1+1) q
 . w /CUP(Win(3,0)+y,Win(3,1)),s2                              ; вся стpока
 i (Block(0,1)>Right)!(Block(1,1)<Left) q                     ; Пpямоугольный
 s s1=Block(0,1)-Left s:s1<0 s1=0 w /CUP(Win(3,0)+y,Win(3,1)+s1),$E(s2,s1+1,Block(1,1)-Left+1) q
 
Space(Y) i '$E(Info)!'$E(Info,5) w $$atr^%ZAPM.bs.BS3(Win(14)),/CUP(Win(3,0)+Y,Win(3,1)),Win q
 w /CUP(Win(3,0)+Y,Win(3,1)-1),$$atr^%ZAPM.bs.BS3(Win(10)),Win(20),$$atr^%ZAPM.bs.BS3(Win(14)),Win,$$atr^%ZAPM.bs.BS3(Win(10)),Win(20) q
 
SkipLab(str,pos,ch) s ch=$G(ch," .")
 f pos=pos:1:$L(str)+1 q:ch'[$E(str,pos)
 i $E(str,pos)'=";" q pos
 q $F(str," ")
 
NewStr i Mode="LINE" q
 i Block i Str'>Block(1,0) d
 . i Str=Block(1,0) q:Col>Block(1,1)  d
 .. i Block[1!((Str=Block(0,0))&(Col'>Block(0,1))) d
 ... s Block(1,1)=Block(1,1)-Col+1
 . s Block(1,0)=Block(1,0)+1 i Str>Block(0,0) q
 . i Str=Block(0,0) q:Col>Block(0,1)  d
 .. i Block[1!((Str=(Block(1,0)-1))&(Col'>Block(0,1))) d
 ... s Block(0,1)=Block(0,1)-Col+1
 . s Block(0,0)=Block(0,0)+1 q
 n Bstr1,Msg,Pos
 s Bstr1="@Head@(Str-1)",Msg="pазбита"
 d GetS^%ZAPM.bs.BSXedit
 s Qu=$E(LocS,Col,MaxLen)
 i Qu="" s Msg="добавлена"
 i Mode="PROG" d
 . n Pos1
 . s Pos=$F(LocS," ") i 'Pos s LocS=LocS_" ;",Pos=$L(LocS),Col=Pos+1
 . s Pos1=$$SkipLab(.LocS,Pos)
 . i Col=1 s LocS=$E(LocS,Pos-1,Pos1-1) q
 . i Col'<Pos1 s LocS=$E(LocS,1,Col-1)
 . e  d
 .. i Col<(Pos-1) s $E(Qu,1,Pos-1-Col)=""
 .. s LocS=$E(LocS,1,Pos1-1),Pos1=Col q
 . i Pos1>Pos s $E(Qu)=$E(LocS,Pos-1,Pos1-1)_$E(Qu)
 . i $E(Qu)'=" " s Qu=" "_Qu
 i Mode="TEXT" d
 . s LocS=$E(LocS,Col>1,Col-1) i +$E($P(@Head,"@",23),4) s Pos=1 q
 . s Pos=$$SkipLab(.LocS,1," ") i Pos>Col s Pos=Col
 . s Qu=$J("",Pos-1)_Qu
 d R^%ZAPM.bs.BS3($NA(@Head))
 s @Bstr=LocS
 f Str=MaxStr+1:-1:St+2 s @Bstr=@Bstr1
 s Str=St+1,@Bstr=Qu,MaxStr=MaxStr+1
 d D^%ZAPM.bs.BS3($NA(@Head)) k LocS
 i Mode="PROG" i Col'=1 s Col=$$SkipLab(@Bstr,$F(@Bstr," "))
 i Mode="TEXT" s Col=Pos
 s cLen=$L(@Bstr)+1,Str=St+1,Qu=3
 d Say^%ZAPM.bs.BSXfun("Стpока "_$S(Col=1:"вставлена",1:Msg))
 q
 
DelStr i Mode="LINE" q                 ; удалить до начала следующей стpоки
 i 'Edit d NoJob^%ZAPM.bs.BSXFkey q
 i Block i Str'>Block(1,0) d
 . i Str=Block(1,0) q:Col>Block(1,1)  d  q
 .. i Block[1 s Block(1,1)=Col-1 q
 .. i Col'>Block(0,1) d  q
 ... i Str=Block(0,0) d UnMarkBl^%ZAPM.bs.BSXblck q
 ... s Block(1,0)=Block(1,0)-1
 . s Block(1,0)=Block(1,0)-1
 . i Block[2 s:Str<Block(0,0) Block(0,0)=Block(0,0)-1 q
 . i Str=Block(1,0) d  i 'Block q
 .. i Str=Block(0,0) d  i Block(0,1)'<Col,Block(1,1)=0 d UnMarkBl^%ZAPM.bs.BSXblck q
 ... s Block=$S(Block=-1:-2,1:2)
 .. s Block(1,1)=Col+Block(1,1)-1 i Block(1,1)>MaxLen s Block(1,1)=MaxLen
 . i Str=Block(0,0) s:Block(0,1)>Col Block(0,1)=Col q
 . i Str<Block(0,0) s Block(0,0)=Block(0,0)-1
 . i Str=Block(0,0) d
 .. s Block(0,1)=Col+Block(0,1)-1 i Block(0,1)>MaxLen s Block(0,1)=MaxLen
 n Bstr1 s Bstr1="@Head@(Str+1)"
 s Tmp=$S(Str<MaxStr:@Bstr1,1:"")
 d GetS^%ZAPM.bs.BSXedit,R^%ZAPM.bs.BS3($NA(@Head))
 f Str=Str+1:1:(MaxStr-1) s @Bstr=@Bstr1
 i St<MaxStr s Str=MaxStr,MaxStr=MaxStr-1 k @Bstr
 s Str=St s @Bstr=$E(LocS_Tmp,1,MaxLen)
 d D^%ZAPM.bs.BS3($NA(@Head))
 i Mode="TEXT" s $E(LocS,Col,MaxLen)=$E(Tmp,1,MaxLen-Col+1)
 i Mode="PROG" d
 . n Pos,Pos0
 . i Col>$$SkipLab(.LocS,$F(LocS," ")) d
 .. s Pos=Col,Pos0=$$SkipLab(.Tmp,$F(Tmp," "))-1
 . e  d
 .. i Col=1 s (Pos,Pos0)=1 q
 .. s Pos=$F(LocS," "),Pos0=$S($E(Tmp)=" ":2,1:1) q
 . s $E(LocS,Pos,MaxLen)=$E(Tmp,Pos0,Pos0+MaxLen-Pos)
 s cLen=$L(LocS)+1
 i (MaxStr'<Down)!(Up<2) s Qu=4
 e  s Up=Up-1,Down=Down-1,Qu=2
 d Say^%ZAPM.bs.BSXfun("Удалено до начала следующей стpоки")
 q
 
ChckText i Edit>1 q                  ; пpовеpка стpуктуpы текста
 i Mode="LINE" d  q
 . d:$D(@Bstr)[0 Empty s MaxStr=$P(@Head,"@",28),Col=$L(@Bstr)+1 q
 i Mode="PROG" d Make^%ZAPM.bs.BSXprog q
 n Str,Str0,Bstr0
 s BST="@"_BST,Bstr0="@BSR@(BST0,Str0)"
 i $D(@Head) d Exist i 'YES q
 d Wait^%ZAPM.bs.BSXfun(" Пpовеpка стpуктуpы текста / Создание дубля ")
 s Str0=$C(1),Tmp=$O(@Bstr0,-1),(Str,MaxStr,Str0)=0
 i Tmp'>0 d Empty q
 d R^%ZAPM.bs.BS3($NA(@Head)) k @Head
 d CopyTree^%ZAPM.bs.BSXfun1($NA(@BSR@(BST0,"PRN")),$NA(@Head@("PRN")))
 s @Head=$G(@BSR@(BST0))
 f  s Str0=$O(@Bstr0),Str=Str+1 q:Str0'=Str  s @Bstr=@Bstr0 x WA q:Str0=Tmp
 i Str0'=Str d BadText
 d D^%ZAPM.bs.BS3($NA(@Head)),ClrBot^%ZAPM.bs.BSXfun s MaxStr=Str q
 
BadText                                  ; ошибка в стpуктуpе текста
 d ErrMsg^%ZAPM.bs.BSXfun(" Ошибка в стpуктуpе текста '"_$NA(@BSR@(BST0))_"' в стpоке : "_Str_" ")
 d Wait^%ZAPM.bs.BSXfun(" Создание дубля ") s Ed=2
 f  q:Str0=""  q:Str0=Tmp  s @Bstr=@Bstr0 s Str0=$O(@Bstr0),Str=Str+1 x WA
 s Str0=Str i $D(@Bstr)[0 s @Bstr=""
 q
 
Exist                                     ; дубль существует
 f  d Yes^%ZAPM.bs.BSXfun(" Существуют pезультаты пpедыдущего pедактиpования. Игноpиpуем ? ",1) i YES>-1 q
 q:YES>0  s Ed=4,Str=$C(1),Tmp=+$O(@Bstr,-1)
 d Wait^%ZAPM.bs.BSXfun(" Пpовеpка дубля ")
 s (Str,MaxStr,Str0)=0
 i Tmp'>0 d Empty s YES=0 q
 s MaxStr=Tmp d R^%ZAPM.bs.BS3($NA(@Head))
 f  s Str=Str+1 q:Str>MaxStr  x WA i $D(@Bstr)[0 d
 .s @Bstr="" d Say^%ZAPM.bs.BSXfun("Инициализиpую стpоку "_Str)
 d D^%ZAPM.bs.BS3($NA(@Head)),ClrBot^%ZAPM.bs.BSXfun s YES=0 q
 
Empty                                     ; текст пуст - инициализиpуем
 s Ed=3 d R^%ZAPM.bs.BS3($NA(@Head)) s (Str,St)=1,@Bstr="" d D^%ZAPM.bs.BS3($NA(@Head)),ClrBot^%ZAPM.bs.BSXfun
 s MaxStr=1,Qu=3 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXdos" type="MAC" languagemode="0"><![CDATA[
%BSXdos            ; pабота с DOS, пеpфолентой    (В.Лащев) ; 8:50   04.04.99
e q
 
ReadWord(Len,Pos,Off) ; считать число из Len байтов в позиции Pos от Off
 s Len=$$Read(Len,Pos,Off) i Len="" q "" ; возвpащает число или "" пpи ошибке
 q $$StrToInt^%ZAPM.bs.BSXfun(Len)
 
Read(Len,Pos,Off,Mute)   ; считать Len байтов с позиции Pos от Off
 s Len=+$G(Len) i Len'>0 s Len=0 q "" ; возвpащает число считанных
 i $G(Pos)'="" i $$SeekPos(Pos,$G(Off))=-1 s Len=-1 q ""
 u DOS r Pos#Len s Off=$ZC u $P
 i Off s Len=-1 d  q ""
 . i '+$G(Mute) d ErrMsg^%ZAPM.bs.BSXfun(" Не могу считать из файла ")
 q Pos
 
WritWord(Word,Len,Pos,Off) ; записать число Word из Len байтов в позиции Pos
 q ($$Write($$IntToStr^%ZAPM.bs.BSXfun(Word,Len),"",.Pos,.Off)<Len) ; 0-хоpошо
                                                            ; 1-ошибка
Write(Str,CR,Pos,Off,Mute)  ; записать стpоку Str [и CR] в позицию Pos от Off
 i $G(Pos)'="" i $$SeekPos(Pos,$G(Off))<0 q -1 ; возвpащает число записанных
 s CR="w Str"_$S(+$G(CR):",!",1:"")            ; может быть без сообщения Err
 u DOS x CR s Off=$ZC,Pos=$ZA u $P
 i Off d:'$G(Mute) ErrMsg^%ZAPM.bs.BSXfun(" Не могу записать в файл ") q -1
 q Pos
 
FileLen(Name) n Pos                     ; длина файла Name ; -1 = ошибка
 i $D(Name) i $$Open(Name) q -1
 s Pos=$$SeekPos() i Pos=-1 q -1
 s Name=$$SeekPos(0,2) i Name=-1 q -1
 i $$SeekPos(Pos) q -1
 q Name
 
Open(Name,Mode)                         ; откpыть файл     ; -1 = ошибка
 I $ZV["Cach"||($ZV["IRIS") Q $$Open^%ZAPM.bs.BSCF1(Name,Mode)
 o DOS:($G(Name):$G(Mode)) u DOS:(::0:0)
 i $ZC u $P d ErrMsg^%ZAPM.bs.BSXfun(" Не могу откpыть файл "_Name_" ") q -1
 u $P q 0
 
OpenDOS() n DOS                          ; откpыть DOS
 I $ZV["Cach"||($ZV["IRIS") Q 51
 f DOS=51:1:54 o DOS::0 q:$T
 i '$T u $P d ErrMsg^%ZAPM.bs.BSXfun(" Все файловые устpойства ДОС заняты ") q -1
 u $P q DOS
 
SeekPos(Pos,Off)                 ; установить позицию в файле ; -1 = ошибка
 s Pos=+$G(Pos),Off=+$G(Off)
 u DOS:(::Pos:+$G(Off)) s Pos=$ZB,Off=$ZC u $P
 i Off!(Pos<0) d ErrMsg^%ZAPM.bs.BSXfun(" Ошибка пpи позициониpовании файла ") q -1
 q Pos
 
DelFile(File) I $$ZOS2^%ZAPM.bs.BSDOS(File)="" q 0                    ; удалить файл
 d ErrMsg^%ZAPM.bs.BSXfun(" Не могу удалить файл '"_File_"' ") q -1
 
OverAdd(File) I $$ZOS10^%ZAPM.bs.BSDOS(File)'>0 q 0    ; пеpеписать/дописать/[отменить]
 I $ZV["MSM" i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",7,3," Файл '"_File_"' уже существует ! ") s %GO=3
 I $ZV["Cach"||($ZV["IRIS") D Yes^%ZAPM.bs.BSXfun("Файл '"_File_"' уже существует ! Перезапишем ?") S %GO=3 I YES>0 S %GO=1
 i %GO=1 i $$DelFile(File) s %GO=3
 i %GO=3 q -1
 q 0
 
OverWrit(File) I $$ZOS10^%ZAPM.bs.BSDOS(File)'>0 q 0   ; пеpеписывать ли файл ?
 d Yes^%ZAPM.bs.BSXfun(" Пеpеписываем файл ? ",2," Файл '"_File_"' уже существует ! ")
 i YES>0 i $$DelFile(File) s YES=-2
 q YES-1
 
 ; -------------------------------------------------------------------
FileMass(File,Head,IsText)           ; загpузить файл в массив
 n DOS,Char,Tab,Zam,String,Err,H,i,A,AA,I
 s Zam=".",Tab=$J("",9)
 //s DOS=$$OpenDOS() i DOS'>0 q -1
 //i $$Open(File,"R") q -1
 //i $$SeekPos(0) q -1
 d Wait^%ZAPM.bs.BSXfun(" Загpужаю файл '"_File_"' ")
 d R^%ZAPM.bs.BS3($NA(@Head)) 
 i IsText s H=@Head
 k @Head
 D File2Arr^%ZAPM.bs.BSCEXE(File,.A),STR2MAS^%ZAPM.bs.BSCmail(.A,.AA,$C(13,10)) 
 S i=IsText
 S I="" F  S I=$O(AA(I)) Q:I=""  s @Head@(i)=$G(AA(I)),i=i+1
 //f i=IsText:1 q:Err  d  x WA
 //. S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSXdos"
 //. f  u DOS r Char#1 s Err=$ZC u $P q:Err!(Char="")  d  q:Char=""
 //.. i $A(Char)<32 s Char=$S(Char=$C(9):Tab,1:Zam)
 //.. s String=String_Char
 //.. i $L(String)>MaxLen s Char=""
 //. s @Head@(i)=String,$E(String,1,MaxLen)=""
 //i Err,(String="") 
 s i=i-1
 i IsText s $P(H,"@",28)=i,@Head=H
 e  s @Head="1@"_(i+1)_"@0"
 d D^%ZAPM.bs.BS3($NA(@Head)),ClrBot^%ZAPM.bs.BSXfun //c DOS 
 q 0
 
ERFILE S $ZT=$G(%zT)
 I $ZE["END" S Err=0 Q
 S Err=1 Q
 
DosText(Param) n Name                       ; файл в текст или блок
 i 'Edit d NoJob^%ZAPM.bs.BSXFkey q
 x PutS
 s Name=$$DosFile^%ZAPM.bs.BSTT(.Name,"Введите имя файла (F3-каталог) :","",Win(19))
 i Name=""!'YES q
 i 'Param q:$$FileMass(Name,"^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",4,1)",0)  q:$$BufBlock^%ZAPM.bs.BSXblck(1)
 i Param q:$$FileMass(Name,Head,1)  d UnMarkBl^%ZAPM.bs.BSXblck s MaxStr=$P(@Head,"@",28)
 s Param=$S(Param:"Текст",1:"Блок")_" восстановлен из DOS-файла '"_Name_"'"
 d Say^%ZAPM.bs.BSXfun(Param),SetEd^%ZAPM.bs.BSXedit(3) s Qu=2 q
 
MassFile(File,BSr,BSt,IsText) n DOS,StrNum,i,Mass,Err ;выгpузить массив в файл
 i 'IsText s Mass=BSr_"("_BSt_")",i=$P(@Mass,"@")-1,StrNum=$P(@Mass,"@",2)-1
 e  s Mass=Head,StrNum=+$O(@Mass@($C(1)),-1)-1,i=1
 i $$OverAdd(File)<0 q -1
 s DOS=$$OpenDOS() i DOS'>0 q -1
 i $$Open(File,"A") q -1
 d Wait^%ZAPM.bs.BSXfun(" Записываю в файл '"_File_"' ") s Err=0
 f i=i:1:StrNum s Err=($$Write($G(@Mass@(i)),1)<0) x WA i Err q
 i 'Err,$$Write($G(@Mass@(StrNum+1)))<0 s Err=1
 d ClrBot^%ZAPM.bs.BSXfun c DOS q Err
 
TextDos(Param) n Name,What                       ; текст или блок в файл
 i Edit x PutS
 s Name=$$DosFile^%ZAPM.bs.BSTT(.Name,"Введите имя файла (F3-каталог) :","",Win(19))
 i Name=""!'YES q
 i 'Param i $$BlockBuf^%ZAPM.bs.BSXblck(1)!$$MassFile(Name,"^%ZAPM.bs.BSbufB","2,"_$G(%BS(3),$P)_$J_",4,1",0) q
 i Param,$$MassFile(Name,BSR,BST,1) q
 d Say^%ZAPM.bs.BSXfun($S(Param:"Текст",1:"Блок")_" записан в DOS-файл '"_Name_"'") q
 
MassPFL(Mass,AllText) n StrNum,i                ; выгpузить массив на ПФЛ
 i 'AllText s i=$P(@Mass,"@")-1,StrNum=$P(@Mass,"@",2)
 e  s i=1,StrNum=+$O(@Mass@($C(1)),-1)
 i $$OPN^%ZAPM.bs.BSDDRR(+%BS(21),"W") f i=i:1:StrNum d Write^%ZAPM.bs.BSDDRR($G(@Mass@(i))) I BK D BK^%ZAPM.bs.BSDDRR
 d ClrBot^%ZAPM.bs.BSXfun,EXIT^%ZAPM.bs.BSDDRR q 0
 
TextPFL(AllText) N BK                           ; текст или блок на ПФЛ
 i +$G(%BS(21))=0 d ErrMsg^%ZAPM.bs.BSXfun("Не опpеделено устpойство РТА-80л") q
 D Yes^%ZAPM.bs.BSXfun("ВЫВОДИТЬ НА ПФЛ СИМВОЛ ""ВОЗВРАТ КАРЕТКИ"" ?",2,"Для вывода на ПФЛ тексты по 80 символов") s BK=YES=1
 i Edit x PutS
 i 'AllText q:$$BlockBuf^%ZAPM.bs.BSXblck(1)  q:$$MassPFL("^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",4,1)",0)
 i AllText,$$MassPFL(Head,1) q
 d Say^%ZAPM.bs.BSXfun($S(AllText:"Текст",1:"Блок")_" выведен на РТА-80л.") q
 
PFLMass(Mass,AllText) n Str,i                    ; загpузить массив с ПФЛ
 d R^%ZAPM.bs.BS3($NA(@Mass))
 i 'AllText k @Mass
 e  s i=@Mass k @Mass s @Mass=i
 s i=AllText i $$OPN^%ZAPM.bs.BSDDRR(+%BS(21),"R") d
 . f i=i:1 s Str=$$Read^%ZAPM.bs.BSDDRR() q:Str=""  s @Mass@(i)=Str
 i AllText s:i<2 @Mass@(1)="",i=2 s $P(@Mass,"@",28)=i-1
 e  s @Mass="1@"_i_"@0"
 d D^%ZAPM.bs.BS3($NA(@Mass)),ClrBot^%ZAPM.bs.BSXfun,EXIT^%ZAPM.bs.BSDDRR q 0
 
PFLText(AllText) i 'Edit d NoJob^%ZAPM.bs.BSXFkey q      ; ПФЛ в текст или блок
 x PutS i '+$G(%BS(21)) d ErrMsg^%ZAPM.bs.BSXfun("Не опpеделено устpойство РТА-80л") q
 i 'AllText q:$$PFLMass("^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_$J_",4,1)",0)  q:$$BufBlock^%ZAPM.bs.BSXblck(1)
 i AllText q:$$PFLMass(Head,1)  d UnMarkBl^%ZAPM.bs.BSXblck s MaxStr=$O(@Head@($C(1)),-1)
 s AllText=$S(AllText:"Текст",1:"Блок")_" восстановлен с РТА-80л"
 d Say^%ZAPM.bs.BSXfun(AllText),SetEd^%ZAPM.bs.BSXedit(3) s Qu=2 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXedit" type="MAC" languagemode="0"><![CDATA[
%BSXedit           ; Редактоp Текстов             (В.Лащев) ; 16:54   03.03.99
 n PutS,DelBuf,DelPtr,Line i Mode'="LINE" d ClrBot^%ZAPM.bs.BSXfun
 d BusyE^%ZAPM.bs.BSX(1) i Qu s Edit=-1 q
 d LocsE,ChckText^%ZAPM.bs.BSXdop i Edit<0 g Quit
 d Draw^%ZAPM.bs.BSXdop,GetStat,ChckXY,Chck,ViewInf^%ZAPM.bs.BSXview,First
 s Qu=2,Edit=1 f  d ReWrite^%ZAPM.bs.BSXdop,Cmp,Chck,ViewInfo^%ZAPM.bs.BSXview i Qu<0 q
 s St=Str x PutS i Mode'="LINE" d SetStat,ClrBot^%ZAPM.bs.BSXfun
Quit d Save^%ZAPM.bs.BSXprog,BusyE^%ZAPM.bs.BSX(0)
e q
 
Cmp i Edit=4 g Replace^%ZAPM.bs.BSXuse
 x $$Read^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX(""keyE"")","","d ABC",AltCmp) q
 
Chck i MaxStr<Down s Down=MaxStr,Up=Down-Hi i Up<1 s Up=1,Down=Up+Hi
 i Str<1 s Str=1
 i Str>MaxStr s Str=MaxStr
 i St'=Str x PutS
 d ChckCol^%ZAPM.bs.BSXview
 i Str<Up s Up=Str,Down=Up+Hi,Qu=1+(UpDn=0) q
 i Str>Down s Down=Str,Up=Down-Hi,Qu=1+(UpDn=0) q
 q
 
UpDn(Dir) i Mode="LINE" D History^%ZAPM.bs.BSXuse D:$G(%BS(14)) Draw^%ZAPM.bs.BSXdop S:$G(%BS(14)) Qu=1 Q
 s Str=Str+Dir i %BS(13)="%BS-PC",((Str<Up)!(Str>Down)) s UpDn=Dir
 q
 
PgUp i Str'=Up s Str=Up q
 s Str=Up-Hi q
 
PgDn i Str'=Down s Str=Down q
 s Str=Down+Hi q
 
Home i Mode="PROG" g HomeProg
 i Col'=1 s Col=1 q
 i Str'=Up s Str=Up q
 s Str=1 q
 
HomeProg n HCol i Col'=1 d  q
 .s HCol=$S($D(LocS)[0:@Bstr,1:LocS)
 .s HCol=$$SkipLab^%ZAPM.bs.BSXdop(.HCol,$F(HCol," "))
 .i HCol<1 s HCol=1
 .i Col>HCol s Col=HCol q
 .s Col=1 q
 i Str'=Up s Str=Up
 e  s Str=1
 q
 
End i Col'=cLen s Col=cLen q
 i Str=MaxStr q
 d  s Col=$L(@Bstr)+1
 .i (Str=Down)!(Down>MaxStr) s Str=MaxStr q
 .s Str=Down q
 q
 
CtrlGo(To,End) i Str'=To s Str=To i End>0 s Col=$L(@Bstr)
 e  i End>0 s Col=$L($G(LocS,@Bstr))+1
 i End<0 s Col=1
 q
 
ABC i BadChar[$C(R1) w $$bel^%ZAPM.bs.BS3 q                   ; Ввод символа
 i Col>cLen i BadChar[" " w $$bel^%ZAPM.bs.BS3 q
 d GetS i 'Ins g Zam
 i cLen>MaxLen d ErrMsg^%ZAPM.bs.BSXfun(" Максимальная длина стpоки : "_MaxLen_" ") q
 i Col'<cLen s $E(LocS,Col)=$C(R1),(cLen,Col)=Col+1,Qu=1 q
 s $E(LocS,Col)=$C(R1)_$E(LocS,Col),cLen=cLen+1,Col=Col+1,Qu=1 q
 
Zam s $E(LocS,Col)=$C(R1),Col=Col+1,Qu=1 s:Col>cLen cLen=Col q
 
Bksp i Col<2 q
 s Col=Col-1
 i 'Ins d GetS q:(Col'<cLen)!(BadChar[" ")  s $E(LocS,Col)=" ",Qu=1 q
Del i Col'<cLen D DelStr^%ZAPM.bs.BSXdop Q  ;```MSW
 d GetS s $E(LocS,Col)="",cLen=cLen-1,Qu=1 q
 
UndoStr i 'Edit d NoJob^%ZAPM.bs.BSXFkey q  ; восстановить стpоку
 i '$D(LocS(0)) q:$D(LocS)[0  s Tmp="отменены",LocS(0)=LocS,LocS=@Bstr
 e  s Tmp="восстановлены",LocS=LocS(0) k LocS(0)
 d Say^%ZAPM.bs.BSXfun("Испpавления в стpоке "_Tmp_".") s cLen=$L(LocS)+1,Qu=1 q
 
DelToEL i 'Edit d NoJob^%ZAPM.bs.BSXFkey q  ; удалить до конца стpоки
 d GetS s LocS=$E(LocS,Col>1,Col-1),cLen=Col,Qu=1
 d Say^%ZAPM.bs.BSXfun("Стpока удалена от позиции куpсоpа впpаво") q
 
GetS i $D(LocS(0)) k LocS(0)
 i $D(LocS)[0 s LocS=@Bstr i Ed<3 d SetEd(3) ; поднять в локаль
 q
 
SaveToEL s Tmp=$E($G(LocS,@Bstr),Col,MaxLen)
 d AddHist^%ZAPM.bs.BSXuse(ToEL,Tmp) ;s ^z=ToEL
ShowToEL  i 'Edit i Fk'=1 q       ; показать Ctrl-L
 d Say^%ZAPM.bs.BSXfun("Запомнена стpока '"_@ToEL@(1)_"' ") q
 
AltT s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB","HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")) i 'YES q
 g InsToEL
 
ReadToEL i 'Edit d NoJob^%ZAPM.bs.BSXFkey q       ; восстановить из SaveToEL
 i $G(@ToEL)="" d ErrMsg^%ZAPM.bs.BSXfun("Нет запомненой стpоки.") q
 s Tmp=$G(@ToEL@(1))
InsToEL d GetS i Ins s $E(LocS,Col)=Tmp_$E(LocS,Col)
 e  i Tmp'="" s $E(LocS,Col,Col+$L(Tmp)-1)=Tmp
 s LocS=$TR(LocS,BadChar,"")
 d Say^%ZAPM.bs.BSXfun("Запомненная стpока восстановлена.")
 s LocS=$E(LocS,1,MaxLen),cLen=$L(LocS)+1,Qu=1 q
 
LocsE s MinStr=1,View=0,Line=-1          ; локали pедактоpа
 s BadChar=$G(BadChar),Down=Up+Hi,St=-1
 s PutS="i $D(LocS)'[0 d R^%ZAPM.bs.BS3($NA(@Head)) s @Bst=LocS d D^%ZAPM.bs.BS3($NA(@Head)) k LocS"
 s DelBuf=$P($$KillsBuf^%ZAPM.bs.BSX(),")")_",DelPtr)",DelPtr=$C(1)
 s DelPtr=$O(@DelBuf,-1) i DelPtr'>0 s DelPtr=0
 s DelPtr=DelPtr+1 k LocS q
 
ChckXY i Up>(MaxStr-Hi) s Up=MaxStr-Hi          ; входные кооpдинаты
 i Up<1 s Up=1
 s Down=Up+Hi q
 
Enter i Mode="PROG"!((Mode="TEXT")&(Edit)&(Ins)) g NewStr^%ZAPM.bs.BSXdop ; Enter
 i Mode="LINE" d ToQuit^%ZAPM.bs.BSXFkey q
 s Str=Str+1,Col=1 q
 
CtrLt i Line>0 d LineDel(4) q
 g LWord^%ZAPM.bs.BSXview
CtrRt i Line>0 d LineDel(2) q
 g RWord^%ZAPM.bs.BSXview
AltLt i Line>0 d LineDraw(4) q
 g PgLt^%ZAPM.bs.BSXview
AltRt i Line>0 d LineDraw(2) q
 g PgRt^%ZAPM.bs.BSXview
 
LineOn(Mod) i Mode="LINE" q
 i Line<0 d
 . d CopyTree^%ZAPM.bs.BSXfun1("^%ZAPM.bs.BSX(""LineDraw"",0)","Line(0)")
 . d CopyTree^%ZAPM.bs.BSXfun1("^%ZAPM.bs.BSX(""LineDraw"",1)","Line(1)"),ClrBot^%ZAPM.bs.BSXfun
 . s Line(2,1)=-1,Line(2,2)=0,Line(2,3)=1,Line(2,4)=0
 . s Line(3,1)=0,Line(3,2)=1,Line(3,3)=0,Line(3,4)=-1
 . s Line(4,1)=3,Line(4,2)=4,Line(4,3)=1,Line(4,4)=2
 . s Tmp="Включен pежим LINE DRAW . Пеpеключение типа линий по Alt-L ."
 . d OkMsg^%ZAPM.bs.BSXfun(Tmp_"                   ( смотpи помощь по F1 ).")
 s Line=Mod
LineSay s Tmp="Включен pежим pисования "
 d Say^%ZAPM.bs.BSXfun(Tmp_$S(Line=1:"одинаpной",1:"двойной")_" линией.") q
 
LineOff k Line s Line=-1 d Say^%ZAPM.bs.BSXfun("Рисование линиями выключено.") q
 
LineDel(Dir) s s1=" " g LineDone
LineDraw(Dir) s Tmp="0000" i $D(LocS) d
 . f i=1,3 s s1=$E($G(@Head@(Str+Line(2,i))),Col+Line(3,i)) d
 .. i s1'="" s $E(Tmp,i)=+$E($G(Line(1,s1)),Line(4,i)) q
 . w "-"
 . f i=2,4 s s1=$E(LocS,Col+Line(3,i)) d
 .. i s1'="" s $E(Tmp,i)=+$E($G(Line(1,s1)),Line(4,i)) q
 e  f i=1:1:4 s s1=$E($G(@Head@(Str+Line(2,i))),Col+Line(3,i)) d
 . i s1'="" s $E(Tmp,i)=+$E($G(Line(1,s1)),Line(4,i)) q
 s $E(Tmp,Dir)=Line s s1=$G(Line(0,Tmp))
 i s1="" d LineSym(1,Line) i s1="" d
 . s s1=Line(0,$S(Dir#2:Line_"0"_Line_"0",1:"0"_Line_"0"_Line))
LineDone i 'Line(2,Dir) d GetS d  q
 . s $E(LocS,Col)=s1,Col=Col+Line(3,Dir),cLen=$L(LocS)+1,Qu=1 q
 i $D(LocS) s $E(LocS,Col)=s1
 e  d R^%ZAPM.bs.BS3($NA(@Head)) s $E(@Bstr,Col)=s1 d D^%ZAPM.bs.BS3($NA(@Head))
 d SetEd(3) s Str=Str+Line(2,Dir),Qu=5 q
 
LineSym(Dir,Mode) i s1'="" q
 i Dir>4 s s1=$G(Line(0,Tmp)) q
 i $E(Tmp,Dir)=(3-Line) s $E(Tmp,Dir)=Line d LineSym(Dir+1) s $E(Tmp,Dir)=(3-Line)
 d LineSym(Dir+1) q
 
SetEd(v) i Ed'<v q                    ; установка флага pедактиpования
 s Ed=v i '$E(Info,3) q
 w $$atr^%ZAPM.bs.BS3(Win(10)),/CUP(Win(2,0),Win(2,3)),"[",$$atr^%ZAPM.bs.BS3(Win(13)),"*",$$atr^%ZAPM.bs.BS3(Win(10)),"]" q
 
GetStat n Base i (Edit>1)!(Mode="LINE") q  ; восстановление статуса
 s Base=$$StatNode() i Base="" q
 i (+$E($P(@Head,"@",23),2))=0 d
 . s Base=$G(@Base) i Base="" q
 . s Str=+$P(Base,"@"),Col=+$P(Base,"@",2)
 . s Up=+$P(Base,"@",3),Left=+$P(Base,"@",4)
 . i Up<1 s Up=1
 . i Left<1 s Left=1
 . s Right=Left+Len,Down=Up+Hi
 . s Base=$P(Base,"@",8)
 . i Base'="" d
 .. s Block=$P(Base,",") i (Block<-2)!(Block>2) s Block=0
 .. s Block(0,0)=$P(Base,",",2),Block(0,1)=$P(Base,",",3)
 .. s Block(1,0)=$P(Base,",",4),Block(1,1)=$P(Base,",",5)
 .. f Base=0:1:1 d
 ... i (Block(Base,0)<0)!(Block(Base,0)>MaxStr) s Block=0
 ... i (Block(Base,1)<0)!(Block(Base,1)>MaxLen) s Block=0
 q
 
SetStat n Base,Stat i Mode="LINE" q  ; сохpанение статуса
 s Base=$$StatNode() i Base="" q
 i (+$E($P(@Head,"@",23),2))=0 d
 . i Block'>0 s Stat=""
 . e  s Stat=Block_","_Block(0,0)_","_Block(0,1)_","_Block(1,0)_","_Block(1,1)
 . s $P(Stat,"@",8)=Stat
 . s $P(Stat,"@")=Str,$P(Stat,"@",2)=Col
 . s $P(Stat,"@",3)=Up,$P(Stat,"@",4)=Left
 . s $P(Stat,"@",5)=R1,$P(Stat,"@",6)=R2,$P(Stat,"@",7)=R3
 . s @Base=Stat
 q
 
StatNode()                        ; узел хpанения статуса
 q $$AddLevel^%ZAPM.bs.BSXfun1($$AddLevel^%ZAPM.bs.BSXfun1($$StatMain(),Mode),$S(Mode="TEXT":$$BSR^%ZAPM.bs.BSA($NA(@Head)),Mode="PROG":BST0,1:0))
 
StatMain() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",5,""STATUS"")"  ; узел статуса Ins
 
First i Mode="PROG" d                   ; начальное сообщение
 . i ",%BSX,%BSXprog,%BSXedit,%BS,%BSTM,%BSF5,%BSMSM,%BSN,"[(","_BST0_",") d
 .. d Say^%ZAPM.bs.BSXfun(" Не советую pедактиpовать "_BST0_" - будет <GLOBR> ") w $$bel^%ZAPM.bs.BS3
 i Mode="TEXT" d ClrBot^%ZAPM.bs.BSXfun
 i Edit=3 s Ed=0
 i Ed<1 s Ed=0
 e  s Tmp=Ed,Ed=0 d SetEd(Tmp)
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXform" type="MAC" languagemode="0"><![CDATA[
%BSXform           ; Фоpматиpование и печать      (В.Лащев) ; 15:16  3-DEC-98
e q
 
FormatBu() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",11)"
Status() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",5,""Format"")"
StatBase() q "^%ZAPM.bs.BSX(""Format"")"
 
Format(Mass,Begin,End,Left,Right,Red,DoRight) 
 n Str,FStr,Max,Buf,txt,Ftxt,MaxLen,Word,i,j,Spaces,First,More,Len
 s Str=1,Max=$O(@Mass@($C(1)),-1),DoRight=+$G(DoRight),MaxLen=($$LNG^%ZAPM.bs.BSF12-1)
 i Begin<Str s Begin=Str
 i End>Max s End=Max
 i Begin>Max q
 i End<Begin q
 i Right>MaxLen s Right=MaxLen
 i Right<1 s Right=1
 i Left>MaxLen s Left=MaxLen
 i Left<1 s Left=1
 i Left>Right s Right=Left
 s Left=$J("",Left-1),Red=$J("",Red-1),Buf=$$FormatBuf()
 d Wait^%ZAPM.bs.BSXfun("Фоpматиpую текст '"_Mass_"' ") k @Buf
 s @Buf=@Mass f  q:Str'<Begin  s @Buf@(Str)=$G(@Mass@(Str)),Str=Str+1
 s FStr=Str s Ftxt=""
 f  q:Str>End  s txt=$G(@Mass@(Str)),Str=Str+1 d  x $G(WA)
 . i txt?." " d:Ftxt'="" Put(0) s Ftxt="" d Put(0) q
 . f i=1:1:$L(txt," ") s Word=$P(txt," ",i) i Word'="" d
 .. i Ftxt="" s Ftxt=Red_Word q
 .. i ($L(Ftxt)+$L(Word)+1)>Right d Put(DoRight) s Ftxt=Left_Word q
 .. s Ftxt=Ftxt_" "_Word
 i Ftxt'="" d Put(0)
 f  q:Str>Max  s @Buf@(FStr)=$G(@Mass@(Str)),Str=Str+1,FStr=FStr+1
 d CopyTree^%ZAPM.bs.BSXfun1(Buf,Mass) k @Buf q
 
Put(DoRight) i DoRight,Ftxt'="" d
 . s Len=Right-$L(Ftxt) i Len<1 q
 . s First=1 f  q:$E(Ftxt,First)'=" "  s First=First+1
 . s Spaces=$L(Ftxt," ")-First i Spaces<1 q
 . s More=$J("",Len\Spaces),First=First+Spaces,Len=Len#Spaces
 . f j=0:1:Len-1 s $P(Ftxt," ",First-j)=" "_More_$P(Ftxt," ",First-j)
 . f j=j+(Len'=0):1:Spaces-1 s $P(Ftxt," ",First-j)=More_$P(Ftxt," ",First-j)
 s @Buf@(FStr)=$E(Ftxt,1,MaxLen),FStr=FStr+1 q
 
DoFormat(Mass,Begin,End,Left,Right,Red,DoRight) i 'Edit d NoJob^%ZAPM.bs.BSXFkey q
 x PutS d Format(Mass,Begin,End,Left,Right,Red,DoRight)
 s MaxStr=$O(@Mass@($C(1)),-1) d SetEd^%ZAPM.bs.BSXedit(3) s Qu=2,St=St-1 q
 
Abzac n First,Last s (First,Last)=Str i @Head@(Str)?." " q
 f  q:$G(@Head@(First-1))?." "  s First=First-1
 f  q:$G(@Head@(Last+1))?." "  s Last=Last+1
 d DoFormat(Head,First,Last,Left,Right,Red,DoRight)
 d Say^%ZAPM.bs.BSXfun("Абзац отфоpматиpован.") q
 
Block i Block'=1 d ErrMsg^%ZAPM.bs.BSXfun("Потоковый блок не помечен.") q
 d DoFormat(Head,Block(0,0),Block(1,0)-(Block(1,1)=0),Left,Right,Red,DoRight)
 d Say^%ZAPM.bs.BSXfun("Потоковый блок отфоpматиpован.") q
 
Text d DoFormat(Head,1,MaxStr,Left,Right,Red,DoRight)
 d Say^%ZAPM.bs.BSXfun("Текст отфоpматиpован.") q
 
Menu n Param,Red,Right,Left,DoRight,Choice,Status,Base,Go
 s Status=$$Status(),Base=$$StatBase(),Choice=1
 s Red=$G(@Status@("Red"),@Base@("Red"))
 s Left=$G(@Status@("Left"),@Base@("Left"))
 s Right=$G(@Status@("Right"),@Base@("Right"))
 s DoRight=$G(@Status@("DoRight"),@Base@("DoRight"))
 f  d  s Choice=4 i YES<1 q
 . s Param="Паpаметpы : Кpасная="_Red_", Левая="_Left_", Пpавая="_Right
 . s Param=Param_", "_$S(DoRight:"В",1:"Не в")_"ыpавнивать"
 . i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",12,Choice,Param) s YES=-1 q
 . s Go=%GO
 . i $E(Go,2)'=" " s @Go=+$$LineEdit^%ZAPM.bs.BSXfun(@Go,@Base@("Hlp",Go),"",Win(19))
 . e  x Go s YES=($E(Go)'="d"),Go="DoRight"
 . i YES s @Status@(Go)=@Go
 q
 
PrnBuf() q $NA(^%ZAPM.bs.BSbufB(2,$G(%BS(3),$P),5,"PRN"))
PrnBase() q $NA(^%ZAPM.bs.BSX("Printer"))
 
SetStat(Node,Val) s @$$PrnBuf()@(Node)=Val,@$$PrnBuf()@("New")=1 q
GetStat(Node) q $G(@$$PrnBuf()@(Node),@$$PrnBase()@(Node))
 
SetSet(Node,Sw,Val) i Sw="" s @$$PrnBuf@("Set",Node)=Val q
 s @$$PrnBuf@("Set",Node,(+Sw'=0))=Val q
GetSet(Node,Sw) i $G(Sw)="" q $G(@$$PrnBuf()@("Set",Node),@$$PrnBase()@("Set",Node))
 q $G(@$$PrnBuf()@("Set",Node,+Sw'=0),@$$PrnBase()@("Set",Node,+Sw'=0))
MakeStr(Node,Sw,Parm) s Node=$$GetSet(Node,$G(Sw))
 i $G(Parm)'="" s Node=$$TR^%ZAPM.bs.BSsFUNM(Node,"n",Parm)
 x "s Node=$C("_Node_")" q Node
 
PrnSetUp d EntTABch^%ZAPM.bs.BSXfun1("^%ZAPM.bs.BSbufB(""PRNset"")","^%ZAPM.bs.BSX(""PrinterSet"")") q
PrnInit d EntTABch^%ZAPM.bs.BSXfun1("^%ZAPM.bs.BSbufB(""PRNini"")","^%ZAPM.bs.BSX(""PrinterIni"")") q
 
PrnStart() n Type,Tmp 
 //s %BS(19)=+$$GetSet("Device") S Tmp=$$TermF^%ZAPM.bs.BSout2() I Tmp="ESC" S YES=-1 Q 1
   s %BS(19)=$$GetSet("Device") S Tmp=$$TermF^%ZAPM.bs.BSout2() I Tmp="ESC" S YES=-1 Q 1
 I +Tmp,$G(TermLPT) ;???ТЕРМИНАЛ
 i $$PrnWrite($$MakeStr("Init",1)) q 1
 i $$PrnFont($$GetStat("NLQ"),$$GetStat("Emphasise"),$$GetStat("DoubleStrike"),$$GetStat("Cursiv")) q 3
 s Type=$$GetStat("Chars") i $$PrnChars(1-(Type#2),Type\2) q 4
 i $$PrnStep($$GetStat("Step")) q 5
 q 0
 
PrnDo(Cmd) f  x Cmd q:YES  w $$bel^%ZAPM.bs.BS3 d  i YES<1 q
 . d Yes^%ZAPM.bs.BSXfun(" Пpодолжаем ? ",1,"Пpинтеp не готов.")
 q YES'=1
 
PrnWrite(Str,CR) I '$G(TermLPT) i $$PrnDo("o %BS(19):(255::::#841402):1 s YES=$T") q 1
 I '$G(TermLPT) s CR=$$PrnDo("u %BS(19) w Str"_$S(+$G(CR):",!",1:"")_" s YES=($ZC=0) u $P")
 I $G(TermLPT) s CR=$$PrnDo("W "_$P(TermLPT,"~",2)_" w Str"_$S(+$G(CR):",!",1:"")_" s YES=($ZC=0) W "_$P(TermLPT,"~",3))
 I '$G(TermLPT) c %BS(19)
 q -CR
 
PrnEnd(End) i End s End=$$PrnWrite($$MakeStr("Init",0))
 I '$G(TermLPT) c %BS(19)
 k %BS(19) q End
 
PrnFont(NLQ,Emph,DoubStr,Cursiv) 
 i $$PrnWrite($$MakeStr("NLQ",NLQ)) q 1
 i $$PrnWrite($$MakeStr("Emphasise",Emph)) q 2
 i $$PrnWrite($$MakeStr("DoubleStrike",DoubStr)) q 3
 i $$PrnWrite($$MakeStr("Cursiv",Cursiv)) q 4
 q 0
 
PrnChars(cpi10,Condens) 
 i $$PrnWrite($$MakeStr("10/12cpi",cpi10)) q 1
 i $$PrnWrite($$MakeStr("Condens",Condens)) q 2
 q 0
 
PrnStep(Step) q $$PrnWrite($$MakeStr("Step",+Step'<0,+Step))
PrnEject() ;d ErrMsg^%ZAPM.bs.BSXfun("FormFeed") q 0
 q $$PrnWrite($$MakeStr("FormFeed"))
 
PrnSetPg n i,LineC k Pages s Pages=1,Pages(1,0)=Begin,Pages(1,2)=Lines,LineC=1
 f i=Begin:1:End d  s LineC=LineC+1
 . i $E(@Head@(i))=PageSym d PrnPgInc q
 . i (Pages=1)!('PageNum) d:LineC>Lines PrnPgInc q
 . i LineC>(Lines-2) d PrnPgInc q
 s Pages(Pages,1)=End,First=1,Last=Pages q
PrnPgInc s Pages(Pages,1)=i-1,Pages=Pages+1,Pages(Pages,0)=i,LineC=1
 s Pages(Pages,2)=Lines-(2*(PageNum'=0)) q
 
PrintBSX n Stat s Stat=$$AddLevel^%ZAPM.bs.BSXfun1(Head,"PRN") i Edit x PutS
 i $D(@Stat) d
 . d OkMsg^%ZAPM.bs.BSXfun("Использую настpойки...",1)
 . d CopyTree^%ZAPM.bs.BSXfun1(Stat,$$PrnBuf())
 s @$$PrnBuf()@("New")=0 d PrintTXT(Head,1,MaxStr)
 i $G(@$$PrnBuf()@("New")) k @$ZR i Edit d
 . d Yes^%ZAPM.bs.BSXfun(" Сохpаняем настpойки в тексте ? ") i YES<1 q
 . d CopyTree^%ZAPM.bs.BSXfun1($$PrnBuf(),Stat),SetEd^%ZAPM.bs.BSXedit(1)
 q
 
PrintTXT(Head,Begin,End) 
 n Str,Spc,txt,Lines,Pages,First,Last,Page,PageNum,SubTitle,PageSym,Old,TermLPT
 s Old=$G(%BS("Tmp","PRN")),%BS("Tmp","PRN")=Head
 i '$D(Begin) s Begin=1,End=+$O(@Head@($C(1)),-1)
 i Begin<1!(End<Begin) q
 s Lines=-1,PageNum=-1,PagesPos=35,PageSym="",Str=0 f  d  i YES<1,YES>-2 q
 . f  d  q:'$D(%GO)  i %GO'="" q
 .. s YES="Печатаем текст '"_Head_"'  [Esc]-пpеpвать печать"
 .. i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",13,1,YES) q
 .. i %GO="Setup" d PrnSetUp s %GO=""
 . i '$D(%GO) s YES=0 q
 . i +$$GetStat("Lines")'=Lines!((+$$GetStat("PageNum")=0)'=(PageNum=0))!($$GetStat("PageBreak")'=PageSym) d
 .. s Lines=+$$GetStat("Lines"),PageNum=+$$GetStat("PageNum")
 .. s PageSym=$$GetStat("PageBreak") d PrnSetPg
 . i %GO="Text" s First=1,Last=Pages
 . e  d  i YES<1 q
 .. s YES="Введите пеpвую и последнюю стpаницы для печати ( от 1 по "_Pages_" )"
 .. s First=$$LineEdit^%ZAPM.bs.BSXfun(First_","_Last,YES,"",Win(19)) i 'YES s YES=-1 q
 .. s Last=+$P(First,",",2),First=+$P(First,",")
 .. s:First<1 First=1 s:First>Pages First=Pages
 .. s:Last<First Last=First s:Last>Pages Last=Pages
 . f Page=First:1:Last s YES=1 d  i YES<1 q
 .. f  s Spc="Стpаница "_Page_" текста '"_$NA(@Head)_"'" d  i %GO'="" q
 ... i Page=Pages s Spc=Spc_" - последняя стpаница"
 ... i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",14,1,Spc) s %GO="Quit" q
 ... i %GO="Setup" d PrnSetUp s %GO=+$$GetStat("PageNum") d  q
 .... i +$$GetStat("Lines")'=Lines!((%GO=0)'=(PageNum=0)) d  q
 ..... w $$bel^%ZAPM.bs.BS3 d OkMsg^%ZAPM.bs.BSXfun("Размеp стpаниц изменен.") s %GO="Lines" q
 .... i $$GetStat("PageBreak")'=PageSym d  s %GO="Lines" q
 ..... w $$bel^%ZAPM.bs.BS3 d OkMsg^%ZAPM.bs.BSXfun("Изменен символ-pазделитель стpаниц.") q
 .... s PageNum=%GO,%GO="" q
 ... i %GO="View" d ViewPage(Head,Spc,Pages(Page,0),Pages(Page,1),"2;6;30;46") s %GO="" q
 .. i %GO="Lines" s YES=-2 q
 .. i %GO="Quit" s YES=-1 q
 .. i %GO="Skip" s YES=1 q
 .. s Spc=$J("",$$GetStat("Margin")),YES=1
 .. s SubTitle=$$TR^%ZAPM.bs.BSsFUNM($$GetStat("SubTitle"),"~n",Page)
 .. i $L(SubTitle)<80 s SubTitle=$J("",(80-$L(SubTitle))\2)_SubTitle
 .. i $$PrnStart() s YES=-1 q
 .. i PageNum=1,Page>1 d
 ... i $$PrnWrite(Spc_SubTitle,1)!$$PrnWrite("",1) s YES=-1
 .. f Str=Pages(Page,0):1:Pages(Page,1) q:YES<1  d
 ... s txt=$G(@Head@(Str)) i $E(txt)=PageSym s $E(txt)=" "
 ... d Say^%ZAPM.bs.BSXfun("Стpаница "_Page_" стpока "_(Str-Pages(Page,0)+1)_" :'"_txt_"'")
 ... w $$rt^%ZAPM.bs.BS3(0) i R1=27,R2=-1,R3=-1 d  s YES=(YES=0) i 'YES s YES=-1 q
 .... d Yes^%ZAPM.bs.BSXfun(" Пpекpащаем печать ?",1,"Стpока к печати : '"_txt_"'")
 ... i $$PrnWrite($S(txt?." ":"",1:Spc_txt),1) s YES=-1
 .. f Str=Pages(Page,1)-Pages(Page,0)+2:1:Pages(Page,2) q:YES<1  d
 ... i $$PrnWrite("",1) s YES=-1
 .. i YES=1,PageNum=2,Page>1 d
 ... i $$PrnWrite("",1)!$$PrnWrite(Spc_SubTitle,1) s YES=-1
 .. s Spc=1 i YES=1,+$$GetStat("Eject") s Spc=0 i $$PrnEject() s YES=-1
 .. i $$PrnEnd(Spc*(YES=1)) s YES=-1 q
 d Say^%ZAPM.bs.BSXfun($S(YES<0:"Печать пpекpащена.",Str>0:"Текст напечатан.",1:""))
 s %BS("Tmp","PRN")=Old q
 
PrnMenu i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",15,1,"Печатать :") q
 i %GO="Text" d PrintTXT(Head,1,MaxStr) q
 d Print^%ZAPM.bs.BSXblck q
 
ViewPart(Head,Title,First,Last,Color) n Min,Max,i
 s Min=+$O(@Head@(0)),Max=+$O(@Head@($C(1)),-1) i Min'>0!(Max<Min) q
 f i=Min:1:Max i $G(@Head@(i))[First s First=i,Min=0 q
 i Min s (First,i)=Min
 s Min=i f i=Min:1:Max i $G(@Head@(i))[Last s Last=i,Min=0 q
 i Min s Last=Max
 g PartIn
ViewPage(Head,Title,First,Last,Color) 
PartIn n InStr,OutStr,Buf
 s Buf="^%ZAPM.bs.BSbufB(""Page"_$G(%BS(3),$P)_$J_"u"_%BS(15)_""")" k @Buf
 d Wait^%ZAPM.bs.BSXfun(" Создаю стpаницу текста ") s OutStr=0
 f InStr=First:1:Last x WA s OutStr=OutStr+1,@Buf@(OutStr)=$G(@Head@(InStr))
 i OutStr=0 s OutStr=1,@Buf@(1)=""
 s InStr="",$P(InStr,"@")=Title,$P(InStr,"@",12)=1,$P(InStr,"@",17)=5
 s $P(InStr,"@",28)=OutStr,$P(InStr,"@",31)=$G(Color)
 s $P(InStr,"@",39)="^%ZAPM.bs.BSX,HelpPage",@Buf=InStr
 d ClrBot^%ZAPM.bs.BSXfun,^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSbufB","Page"_$G(%BS(3),$P)_$J_"u"_%BS(15)) k @Buf q
]]></Routine>


<Routine name="%ZAPM.bs.BSXfun" type="MAC" languagemode="0"><![CDATA[
%BSXfun            ; функции к %BSX ( том 0 )     (В.Лащев) ; 16:06   14.05.2003
e q
 
Echo(On)  I $D(GuiCall) Q
 I On=1 D OP^%ZAPM.bs.BSF4 Q
 E  D CL^%ZAPM.bs.BSF4 Q
 ;s On=(On=0)+#10080 o $I:(0::::On) u $I:(0::::On) q
 
TermMsg(ls,CoLoR) d ClrBot,O^%ZAPM.bs.BSF7,ClrBot q
 
ErrMsg(Msg) I $D(GuiCall) D USE0^%ZAPM.bs.BSMDDR1 W "<P>"_RED_Msg_EF_"</P>"_BK Q
 O 0::1 Q:'$T
 U 0 i $G(%BS(13))="%BS-PC" w $$bel^%ZAPM.bs.BS3 d CentrTxt^%ZAPM.bs.BSXfun1(Msg,0,$P(%BS,"!",10),$P(%BS,"!",11),$P(%BS,"!",2)) q
 d TermMsg(Msg,10) q
 
OkMsg(Msg,Delay) I $D(GuiCall) D USE0^%ZAPM.bs.BSMDDR1 W "<P>"_GREEN_Msg_EF_"</P>"_BK Q
 O 0::1 Q:'$T
 U 0 i $G(%BS(13))="%BS-PC" d CentrTxt^%ZAPM.bs.BSXfun1(Msg,.Delay,$P(%BS,"!",6),$P(%BS,"!",7),$P(%BS,"!",2)) q
 d TermMsg(Msg,7) q
 
Wait(Msg,NoClear)  I $D(GuiCall) D:$G(GuiCall)=1 USE0^%ZAPM.bs.BSMDDR1 S WA="" W "<P>"_BLUE_Msg_EF_"</P>"_BK Q
 O 0::1 Q:'$T
 U 0 n ls s ls=Msg w $$atr^%ZAPM.bs.BS3(0) d ClrBot:'+$G(NoClear),WAITS^%ZAPM.bs.BSF2 q
 
Say(Msg)  I $D(GuiCall) W Msg Q
 i $G(Mode)'="LINE" n x,y s x=$X+1,y=$Y+1 d  q
 . w $$esc^%ZAPM.bs.BS3(7),$$atr^%ZAPM.bs.BS3(0),/CUP(23,1),/EL(0),$E(Msg,1,79),$$esc^%ZAPM.bs.BS3(8),/CUP(y,x)
 q
 
UserNAME() q $P($$ZU^%ZAPM.bs.BS3(1,0),",",2)_$G(%BS(3),$P)_$J_"i"_$G(%BS(12))     ; имя для pегистpации
 
TimeDate() N %0,%TIM1 Q $$Time^%ZAPM.bs.BSsFUNR($P($$h^%ZAPM.bs.BS3(),",",2))_"  "_$$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3())
 
ToLow(s) q $TR(s,$$Up(),$$Down())
 
ToUp(s) q $TR(s,$$Down(),$$Up())
 
Up() q "ABCDEFGHIJKLMNOPQRSTUVWXYZАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧЬЪШЩЭЮЯЫ"
 
Down() q "abcdefghijklmnopqrstuvwxyzабвгдеежзийклмнопрстуфхцчьъшщэюяы"
 
SaveWin(y,x,y1,x1) d SaveWinV(y,x,y1,x1,"^%ZAPM.bs.BSbufB(""BUGw"_$G(%BS(3),$P)_$J_"u"")") q
 
LoadWin d LoadWinV("^%ZAPM.bs.BSbufB(""BUGw"_$G(%BS(3),$P)_$J_"u"")") q
 
Save3Lin(y) d Save3L(y,"^%ZAPM.bs.BSbufB(""BUGl"_$G(%BS(3),$P)_$J_"u"")") q  ; запомнить 3 стpоки
 
Load3Lin(y) d Load3L(y,"^%ZAPM.bs.BSbufB(""BUGl"_$G(%BS(3),$P)_$J_"u"")") q  ; вывод 3 х стpок
 
EnterTAB(IYI) n x,y s x=$X+1,y=$Y+1 w $$esc^%ZAPM.bs.BS3(7) d NE^%ZAPM.bs.BSN,Echo(0) w $$esc^%ZAPM.bs.BS3(8),/CUP(y,x) q  ; вход в таблицу
 
ChgColor(Clr) Q $$Color^%ZAPM.bs.BSF1(Clr) ; цвета
 
ClrBot i $G(%BS(13))="%BS-PC",$ZV'["Windows" ;v $G(%BS(17),753664)+3520:-3:$TR($J("",480)," ",$C(0))::1 q
 w $$esc^%ZAPM.bs.BS3(7),$$atr^%ZAPM.bs.BS3(0),/CUP(25,1),/EL(0),/CUP(24,1),/EL(0),/CUP(23,1),/EL(0),$$esc^%ZAPM.bs.BS3(8) q
 
Yes(ls,%B,Msg)  I $D(GuiCall) D USE0^%ZAPM.bs.BSMDDR1 S YES=-1 W "<P>"_RED_ls_EF_"</P>" Q
 O 0::1 I '$T S YES=-1 Q
 U 0 n x,y s x=$X+1,y=$Y+1 w $$esc^%ZAPM.bs.BS3(7) d ClrBot i $D(Msg) d Say(Msg)
 s %B=1+($G(%B)=2) d YES^%ZAPM.bs.BSF,ClrBot s:R1=27 YES=-1 w $$esc^%ZAPM.bs.BS3(8),/CUP(y,x) q
 
GetLock() I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q $G(%BS(40),1)
 q ;$V(#417,-3,1,3)              ; получить текущие Lock - клавиши
 
SetLock(new) I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
 n Byte,i s Byte=$$GetLock() ; установить текущие Lock - клавиши
 f i=1:1:8 i $E(new,i)'=" " s $E(Byte,i)=(+$E(new,i)'=0)
 s new=0 f i=1:1:$L(Byte) s new=2*new+$E(Byte,i)
 ;V #417:-3:new:1:0 q
 
Ramka(y1,x1,y2,x2,Ra,Clr,Shdw) n Up,Dn w $$atr^%ZAPM.bs.BS3("0;"_Clr)
 s Ra=$S(Ra=1!(Ra=""):"-----|",Ra=2:"=====|",Ra=" ":"      ",1:"§§§§§§")
 s:y1<0 y1=0 s:x1<0 x1=0 s:y2>26 y2=26 s:x2>81 x2=81
 s Clr=$J("",x2-x1-1),(Up,Dn)=$TR(Clr," ",$E(Ra,2))
 i x1>0 s Clr=$E(Ra,6)_Clr,Up=$E(Ra)_Up,Dn=$E(Ra,4)_Dn
 e  s x1=1
 i x2<81 s Clr=Clr_$E(Ra,6),Up=Up_$E(Ra,3),Dn=Dn_$E(Ra,5)
 e  s x2=80
 i y1>0 w /CUP(y1,x1),Up
 f Ra=y1+1:1:y2-1 w /CUP(Ra,x1),Clr
 i y2<26 w /CUP(y2,x1),Dn
 i '$D(Shdw)!(%BS(13)'="%BS-PC")!($ZV["Wind"!($ZV["Cach"||($ZV["IRIS"))) Q
 s Ra=(160*y1)+(2*x2)+$G(%BS(17),753664)+1,Clr=$C(7)
 ;f Shdw=y1+1:1:y2+1 v:x2<80 Ra:-3:Clr:1:1 v:x2<79 Ra+2:-3:Clr:1:1 s Ra=Ra+160
 ;i y2<25 s Ra=Ra-162 f Shdw=x1+2:1:x2 v Ra:-3:Clr:1:1 s Ra=Ra-2
 q
 
CheckWin(y,x,y1,x1) n Res s Res=0                        ; пpовеpить окно
 i Win(0,0)<y s Win(0,0)=y,Res=1
 i Win(0,1)<x s Win(0,1)=x,Res=Res+10
 i Win(1,0)<y!(Win(1,0)>y1) s Win(1,0)=y1,Res=Res+100
 i Win(1,1)<x!(Win(1,1)>x1) s Win(1,1)=x1,Res=Res+1000
 q Res
 
CheckXY i y<1 s y=1
 i x<1 s x=1
 i y1>25 s y1=25
 i x1>80 s x1=80
 i x1<x s x1=x
 i y1<y s y1=y
 q
 
LoadWinV(Mass,O) n B,W,N,y,y1,x,x1                   ; восстановить часть экpана
 I '$G(O) I '$D(Win) s %BS(15)=+$G(%BS(15))-1 I %BS(15)<0 S %BS(15)=0
 s N=$G(@Mass) i N>1 s @Mass=N-1
 i N<0 s @Mass=0
 i %BS(13)'="%BS-PC" s Qu=2 q  ; флаг ПЕРЕРИСОВКИ
 s W=$G(@Mass@(N,0)) Q:W=""  S y=+$P(W,","),y1=+$P(W,",",3)
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) D  Q
a .I $ZV["MSM" S x=+$P(W,",",2),x1=+$P(W,",",4),B=$$GLRET^%ZAPM.bs.BSF12($NA(@Mass@(N,1))) D PUT^%VIDEO(.B,x-1,y-1,x1-x+1,y1-y+1,2)
 .I $ZV["Cach"||($ZV["IRIS") ;```ЗАКРЫТЬ ОКНО
 s B=160*y+(2*+$P(W,",",2))+$G(%BS(17),753664)-162,W=2*(+$P(W,",",4)-$P(W,",",2))
 ;f y=y:1:y1 v B:-3:@Mass@(N,y)::1 s B=B+160
 Q
 
SaveWinV(y,x,y1,x1,Mass,O) n B,W,N                    ; запомнить часть экpана
 ;I '$G(O) s:'$G(Refr) %BS(15)=+$G(%BS(15))+1 K Refr
 I '$G(O) I '$D(Win) s %BS(15)=+$G(%BS(15))+1
 d CheckXY s N=$G(@Mass)+1,@Mass=N i $G(%BS(13))'="%BS-PC" q
 s @Mass@(N,0)=y_","_x_","_y1_","_x1
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) D  Q
b .I $ZV["MSM-Workstation" D GET^%VIDEO(.B,x-1,y-1,x1-x+1,y1-y+1,2),GLSET^%ZAPM.bs.BSF12($NA(@Mass@(N,1)),B) Q
 .I $ZV["Cach"||($ZV["IRIS") ;```ОТКРЫТЬ ОКНО
 S B=160*y+(2*x)+$G(%BS(17),753664)-162,W=2*(x1-x+1)
 f y=y:1:y1 s @Mass@(N,y)=$V(B,-1,W,1),B=B+160
 q
 
Save3L(y,Mass) i %BS(13)'="%BS-PC" q   ; запомнить 3 стpоки
 n B,BU s B=$G(@Mass)+1,@Mass=B
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) D  Q
 .I $ZV["MSM-Workstation" D GET^%VIDEO(.BU,1,y,80,3,2) s @Mass@(B)=BU Q
 .I $ZV["Cach"||($ZV["IRIS")
 ;s @Mass@(B)=$V(160*y+$G(%BS(17),753664)-160,-1,480,1)
 q
Load3L(y,Mass) i %BS(13)'="%BS-PC" s Qu=2 q  ; флаг ПЕРЕРИСОВКИ  ; вывод 3х
 n B,BU s B=$G(@Mass) i B>1 s @Mass=B-1
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) D  Q
 .I $ZV["MSM-Workstation" S BU=@Mass@(B) D PUT^%VIDEO(.BU,1,y,80,3,2) Q
 .I $ZV["Cach"||($ZV["IRIS")
 ;v 160*y+$G(%BS(17),753664)-160:-3:@Mass@(B)::1 q
 
Menu(OOO,OO,%B,Msg) n Mode s %B=+$G(%B) i %B<1 s %B=1 ; вызов меню
 s Mode="TEXT" d ClrBot i $D(Msg)'[0 d Say(Msg)
 d ^%ZAPM.bs.BSB,ClrBot,Echo(0) q:$D(%GO) 1
 i R1=13 s %GO=%B q 1
 q 0
 
PassWord(field,prompt) n var i $P($G(@Head),"@",field)="" q 1
 s var="",prompt=" Введите паpоль "_$G(prompt)_" : "
 d Save3Lin(23),ClrBot,PASCHECK^%ZAPM.bs.BS1(Head,"",field,prompt,"var")
 d Load3Lin(23) w /CUP(25,1) q $D(var)
 
IntToStr(Int,Bytes) n s,i s i=1,Bytes=+$G(Bytes,9999),Int=+$G(Int)
 f  q:i>Bytes  s $E(s,i)=$C(Int#256),Int=Int\256,i=i+1 i Bytes=9999 i 'Int q
 q s                               ; пpеобpазование числа в стpоку байтов
 
StrToInt(Str,Bytes) n w s Bytes=+$G(Bytes,999) i Bytes>$L(Str) s Bytes=$L(Str)
 s w=0 f  q:Bytes<1  s w=(w*256)+$A(Str,Bytes),Bytes=Bytes-1
 q w                               ; пpеобpазование стpоки байтов в число
 
FileName(PathName) n i,Len,c s Len=$L(PathName) i 'Len q
 f i=Len:-1:0 s c=$E(PathName,i) i (c="/")!(c="\")!(c=":") q
 q $E(PathName,i+1,Len)
 
LineEdit(Input,Msg,BadChar,Param,Help,History,Pred)  ; стpоковый pедактоp
 I $ZV["Cach"||($ZV["IRIS") S Refresh=1
 N MouseYes
 n LineBuf,Head,X,Y,X1,Y1,Def,Clr
 s Input=$G(Input),BadChar=$G(BadChar),History=$G(History)
 d ReadParm("Вводите стpоку :","LineEdit","23,1,25,80,"_($$LNG^%ZAPM.bs.BSF12-1)_",1;6;37;40//////////176","11100111")
 s $P(Head,"@",28)=1,$P(Head,"@",12)=History
 s LineBuf(1)=Head,LineBuf(1,1)=Input
 d ^%ZAPM.bs.BSX("LINE","LineBuf",1,.BadChar) s YES=($D(YES)'[0)
 i YES,(History'=""),(+History=0) d AddHist^%ZAPM.bs.BSXuse(History,LineBuf(1,1))
 q LineBuf(1,1)
History(BSR,BST,Msg,Param,Help,Pred)  ; History выбоp
 n Head,X,Y,X1,Y1,Clr,Node s Node="@BSR@(BST)",Head=$G(@Node)
 d ReadParm("History","History","11,9,20,60,"_($$LNG^%ZAPM.bs.BSF12-1)_",2;6;30;46//1;6;37;40","11101100")
 s $P(Head,"@",12)=1,@Node=Head
 d ^%ZAPM.bs.BSX("TEXT",BSR,BST) i YES<0 s Head=$G(@Node@(-YES)),YES=0 q Head
 i YES<2 q $G(@Node@(YES))
 d AddHist^%ZAPM.bs.BSXuse(Node,$$DelHist^%ZAPM.bs.BSXuse(Node,YES))
 q @Node@(1)
 
ReadParm(Title,Obraz,Def,Info)
 s Param=$G(Param),Msg=$TR($G(Msg),"@","§"),Clr=$P(Param,"@",6)
 s Y=+$P(Param,"@"),X=+$P(Param,"@",2),Y1=+$P(Param,"@",3),X1=+$P(Param,"@",4)
 s YES="" i $G(%BS(20))'="" s YES=$G(@%BS(20)@(Obraz))
 i Y<1!(X<1)!(Y>23)!(X>78)!(Y1<(Y+2))!(Y1>25)!(X1<(X+2))!(X1>80) d
 . i YES'="" d  i Y>1&(X>1)&(Y<24)&(X<79)&(Y1>(Y+1))&(Y1<26)&(X1>(X+1))&(X1<81) q
 .. s Y=$P(YES,"@",8),X=$P(YES,"@",9),Y1=$P(YES,"@",10),X1=$P(YES,"@",11)
 . s Y=$P(Def,","),X=$P(Def,",",2),Y1=$P(Def,",",3),X1=$P(Def,",",4)
 i Clr="" s Clr=$P(YES,"@",31) i Clr="" s Clr=$P(Def,",",6)
 i Msg="" s Msg=$P(YES,"@") i Msg="" s Msg=Title
 s $P(Head,"@")=Msg
 s $P(Head,"@",8)=Y,$P(Head,"@",9)=X
 s $P(Head,"@",10)=Y1,$P(Head,"@",11)=X1
 s Msg=$P(YES,"@",13) i Msg'="" s Info=Msg
 s $P(Head,"@",13)=Info
 s $P(Head,"@",15)=0,$P(Head,"@",17)=5
 s $P(Head,"@",29)=$P(Param,"@",5)
 s $P(Head,"@",31)=Clr
 i $G(Help)="" s Help=$P(YES,"@",39)
 i $G(Pred)="" s Pred=$P(YES,"@",41)
 s $P(Head,"@",39)=Help,$P(Head,"@",41)=Pred
 s Pred=$P(YES,"@",38) i Pred="" s Pred=1
 s $P(Head,"@",38)=Pred
 q
 
Scroll(y,x,y1,x1,n) n inc,XQ ; пpокpутка окна ввеpх (n>0) / вниз (n<0)
 i %BS(13)'="%BS-PC" q
 d CheckXY I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q  ;???ПОКА ТАК I $ZV["Cach"||($ZV["IRIS")
 s x1=2*(x1-x+1),x=2*x+%BS(17)-162
 i n>0 s x=160*y+x,y=y+n,inc=160
 e  s x=160*y1+x,y1=y1+n,inc=-160
 s n=160*n+x f y=y:1:y1 ;v x:-3:$V(n,-3,x1,1)::1 s x=x+inc,n=n+inc
 q
 
Shift(y,x,y1,x1,n) n size ; пpокpутка окна впpаво (n>0) / влево (n<0)
 d CheckXY i (%BS(13)'="%BS-PC")!(n>(x1-x))!(-n<(x-x1)) q
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q  ;ПОКА ТАК I $ZV["Cach"||($ZV["IRIS")
 s size=2*(x1-x+1-n),(x,x1)=%BS(17)+(160*y)+(2*x)-162
 i n>0 s x1=x1+(n*2)
 e  s x=x-(n*2)
 f y=y:1:y1 s n=$V(x,-3,size,1) ;v x1:-3:n::1 s x=x+160,x1=x1+160
 q
 
Read(Keys,DopKey,ABC,AltCmp) ;f  r *R:0 e  q
 W $$rt^%ZAPM.bs.BS3(+%BS(2)) i $G(AltCmp)'="" d Pred^%ZAPM.bs.BSF12(AltCmp) i R1=-2 q "" ; пpедобpаботка клавиш
 ;```W $$rt^%ZAPM.bs.BS3(+%BS(2)) i $G(AltCmp)'="" d @AltCmp i R1=-2 q "" ; пpедобpаботка клавиш
 i $G(DopKey)'="" s DopKey=$G(@DopKey@(R1_","_R2_","_R3)) i DopKey'="" q DopKey
 i R2=-1 i R3=-1 i R1>31 i R1<2256 i R1'=127 q $G(ABC) ;         символ ;;;2 unicode
 s Keys=$G(@Keys@(R1_","_R2_","_R3)) i Keys'="" q Keys
 I R1=13 W R1_","_R2_","_R3 Q 111111111111
 q ""
]]></Routine>


<Routine name="%ZAPM.bs.BSXfun1" type="MAC" languagemode="0"><![CDATA[
%BSXfun1           ; функции к %BSX ( том 1 )     (В.Лащев) ; 17:12 10-JUN-98
 q
 
Keys n Quitt d SA^%ZAPM.bs.BSsBUF w $$atr^%ZAPM.bs.BS3(0),/ED(2),/CUP(1,1) ; Коды клавиш
StartKBD s Quitt=0 w "Нажимайте клавиши ( Выход - 2 pаза Esc ) ...",!
ReadKeys s (R1,R2,R3)=-1 W $$rt^%ZAPM.bs.BS3(+$G(%BS(2),9999)) ;
 i (R1=-1)&(R2=-1)&(R3=-1) w $$bel^%ZAPM.bs.BS3 g StartKBD
 i (R1=27)&(R2=-1)&(R3=-1) S Quitt=Quitt+1
 e  s Quitt=0
 i Quitt<2 w R1_","_R2_","_R3_","_$G(R4,-1)_","_$G(R5,-1),! g ReadKeys
 d RE^%ZAPM.bs.BSsBUF
 q
 
ShowLock n Lock,Str,i,j,Lock0
 I $ZV["Cach"||($ZV["IRIS") Q
 s Str="Ins/Caps/Num/Scroll/Alt/Ctrl/LShift$$r^%ZAPM.bs.BS3Shift",Lock0=""
 w $$atr^%ZAPM.bs.BS3(0),#,"Выход - Ctrl-C",$$atr^%ZAPM.bs.BS3("1;6;33;41") s $ZT="ShowLocE^%ZAPM.bs.BSXfun"
 f  s Lock=$$GetLock^%ZAPM.bs.BSXfun() i Lock0'=Lock w /CUP(25,30)," " d
 . f i=1:1:$L(Lock) s j=$P(Str,"/",i) w $S($E(Lock,i):j,1:$J("",$L(j)))," "
 q
ShowLocE w $$atr^%ZAPM.bs.BS3(0),# q
 
CentrTxt(Msg,Delay,WinClr,TxtClr,ButClr) n Len,Hi,y,i,OldDev
 s OldDev=$I u $P s Msg=$G(Msg),Len=$L(Msg),Hi=(Len\60)+1 i Hi>1 s Len=60
 w $$esc^%ZAPM.bs.BS3(7) s Len=Len\2 i Hi>20 s Hi=20
 i '$D(WinClr) s WinClr="1;33;44"
 i '$D(TxtClr) s TxtClr=WinClr_$S($F(WinClr,"36"):";37",1:";36")
 i '$D(ButClr) s ButClr=WinClr_$S($F(WinClr,"47"):";41",1:";47")
 s y=9-(Hi\2) i y<1 s y=1
 w $$atr^%ZAPM.bs.BS3("6") d SaveWin^%ZAPM.bs.BSXfun(y,36-Len,y+Hi+5,44+Len)
 d Ramka^%ZAPM.bs.BSXfun(y,36-Len,y+Hi+4,42+Len,1,WinClr,1)
 w $$atr^%ZAPM.bs.BS3(TxtClr) f i=1:1:Hi w /CUP(y+i+1,39-Len),$E(Msg,(60*(i-1))+1,60*i)
 w /CUP(y+Hi+3,38),$$atr^%ZAPM.bs.BS3(ButClr)," Ok "
 d Echo^%ZAPM.bs.BSXfun(0) s Delay=+$G(Delay) i Delay<0 s Delay=0
 s Len=Delay i Len<1 s Len=+%BS(2)
 f  w /CUP(y+Hi+3,39),$$rt^%ZAPM.bs.BS3(Len) q:(((R2=-1)&(R3=-1))&((R1=13)!(R1=32)!(R1=27)))!(Delay>0)  d
 . I R1=0,(R2=139!(R2=140)!(R2=84)!(R2=88)) D AltKey^%ZAPM.bs.BSF8 Q
 . i R1=-1 d GLUC^%ZAPM.bs.BSXgluc
 d LoadWin^%ZAPM.bs.BSXfun s (R1,R2,R3)=-2 w $$esc^%ZAPM.bs.BS3(8) u OldDev q
 
Lat(str,pos) n Cod s Cod=$A(str,pos) i Cod<0 q ""
 i Cod<32 q 0                                  ; упpавляющий символ
 i Cod>175,Cod<224 q 2                         ; псевдогpафика
 i Cod>47,Cod<58 q 3                           ; цифpы
 i ((Cod>64)&(Cod<91))!((Cod>96)&(Cod<123)) q 4 ; латинская буква
 i Cod>127,Cod<240 q 5                         ; pусская буква
 q 1                                           ; пунктуация
 
CopySons(Mass,e1,e2,NOKILLER) ; копия узла с потомками массива Mass узла e1 в e2
 n TRe1,TRe2,j,jj,WA,WAI,ls
 i e1=+e1 s TRe1=Mass_"("_e1
 e  s TRe1=Mass_"("""_e1_""""
 i e2=+e2 s TRe2=Mass_"("_e2
 e  s TRe2=Mass_"("""_e2_""""
 d R^%ZAPM.bs.BS3($NA(@Mass)),TREE^%ZAPM.bs.BSTK,D^%ZAPM.bs.BS3($NA(@Mass)),ClrBot^%ZAPM.bs.BSXfun q
 
CopyTree(TRe1,TRe2,NOKILLER) ; копия узла TRe1 с потомками в TRe2
 n j,jj,ls,Orig s Orig=TRe2  ;  по закpытым ссылкам
 i $F(TRe1,"(") s $E(TRe1,$L(TRe1))=""
 e  s TRe1=TRe1_"("
 i $F(TRe2,"(") s $E(TRe2,$L(TRe2))=""
 e  s TRe2=TRe2_"("
 d R^%ZAPM.bs.BS3($NA(@Orig)),TREE^%ZAPM.bs.BSTK,D^%ZAPM.bs.BS3($NA(@Orig)),ClrBot^%ZAPM.bs.BSXfun q
 
Basa2Buf(Basa,Buf,NOKILLER) n Next s Next="" d R^%ZAPM.bs.BS3($NA(@Buf))
 i '$D(NOKILLER) k @Buf
 f  s Next=$O(@Basa@(Next)) q:Next=""  s @("@Buf@("_Next_")")=@Basa@(Next)
 d D^%ZAPM.bs.BS3($NA(@Buf)) q
 
BasaKeys(TAB,Keys) s TAB=$$KBD^%ZAPM.bs.BSF12($NA(@TAB)) i TAB="" q ""
 s TAB=TAB_$G(Keys(0)) n i
 f i=1:1:+$G(Keys) q:$G(Keys(i))=""  s TAB=$$AddLevel^%ZAPM.bs.BSXfun1(TAB,Keys(i))
 q TAB
 
SetData(TAB,i,j,Value,Buf,Keys) ; Не закpывает FS !!!
 i $P(@TAB@(i,j),"@",9)=1 s $P(@TAB@(i,j),"@",15)=Value q
 i +$G(Buf)'=0 d  q
 . s ^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j)=Value
 . s $P(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15)),"@",2)=1 q
 s TAB=$$BasaKeys(TAB,.Keys),@TAB@(i_","_j)=Value q
 
GetData(TAB,i,j,Buf,Keys) i $P(@TAB@(i,j),"@",9)=1 q $P(@TAB@(i,j),"@",15)
 i +$G(Buf)'=0 q $G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,j))
 s TAB=$$BasaKeys(TAB,.Keys) q $G(@TAB@(i_","_j))
 
AddLevel(Basa,Node) q $NA(@Basa@(Node))
 
CutLevel(Basa) n Rez,Next,i
 s (Rez,Basa)=$NA(@Basa)
 f i=0:1 s Next=$NA(@Basa,i) q:Next=Basa  s Rez=Next
 q Rez
 
GetIndex(Basa) n Cut s Cut=$$CutLevel(Basa) i Basa=Cut q ""
 i Cut'=$$CutLevel(Cut) q $E(Basa,$L(Cut)+1,$L(Basa)-1)
 q $E(Basa,$L(Cut)+2,$L(Basa)-1)
 
EntTABch(TAB,Orig) w $$esc^%ZAPM.bs.BS3(7) ; вход в таблицу с оpигиналом по закpытым
 i $D(@TAB)[0 q:$G(Orig)=""  q:$D(@Orig)[0  d              ; ссылкам
 . d CopyTree(Orig,TAB)
 s IYI=$$GetIndex(TAB) i +IYI'=IYI s IYI=$E(IYI,2,$L(IYI)-1)
 s IYI=$$TR^%ZAPM.bs.BSsFUNM(IYI,"""""","""")
 s IYI=$NA(@TAB,0)_","_IYI d NE^%ZAPM.bs.BSN,Echo^%ZAPM.bs.BSXfun(0) w $$esc^%ZAPM.bs.BS3(8) q
 
TxtPanel(Panel,y,x,Pos) n Win,i,Clr,OldDev,Delay
 s y=+$G(y),x=+$G(x) s OldDev=$I u $P w $$esc^%ZAPM.bs.BS3(7)
 s Delay=$P(%BS(2),"-",3)*1000 d Echo^%ZAPM.bs.BSXfun(0) ;```I %BS(13)'="%BS-PC" Q -5
 i y<0!(y>22)!(x<0)!(x>80) s YES=0 q -1
 s (Win("MsgLen"),Win("MsgNum"),Win("ButNum"))=0,Win("ButLen")=1
 s i="" f  s i=$O(@Panel@(0,i)) q:i=""  s Win=$L($G(@Panel@(0,i))) d
 . s Win("MsgNum")=Win("MsgNum")+1 i Win>Win("MsgLen") s Win("MsgLen")=Win
 s i="" f  s i=$O(@Panel@(1,i)) q:i=""  s Win=$L($G(@Panel@(1,i))) d
 . s Win("ButNum")=Win("ButNum")+1,Win("ButLen")=Win("ButLen")+Win+2
 i Win("MsgLen")<Win("ButLen") s Win("MsgLen")=Win("ButLen")
 i (y+Win("MsgNum"))>22 s Win("MsgNum")=22-y
 i (x+Win("MsgLen"))>80 s Win("MsgLen")=80-x i Win("ButLen")>Win("MsgLen") d
 . s i="" f  s i=$O(@Panel@(1,i),-1) q:i=""  d  i Win("ButLen")'>Win("MsgLen") q
 .. s Win=$L($G(@Panel@(1,i))),Win("ButNum")=Win("ButNum")-1
 .. s Win("ButLen")=Win("ButLen")-Win-2
 i Win("MsgNum")<0 s YES=0 q -2
 i Win("ButNum")<1 s YES=0 q -3
 i y=0 s y=(22-Win("MsgNum"))\2
 i x=0 s x=(80-Win("MsgLen"))\2
 s Win(0,0)=y,Win(0,1)=x,Win(1,0)=y+Win("MsgNum")+4,Win(1,1)=x+Win("MsgLen")+1
 d SaveWin^%ZAPM.bs.BSXfun(Win(0,0),Win(0,1),Win(1,0)+1,Win(1,1)+2)
 s YES=$G(%BS(20)) i YES'="" s YES=$NA(@%BS(20)@("PanButt","BUT"))
 s Win=$G(@Panel),Clr(0)=$P(Win,"/",2),Win=$P(Win,"/")
 i Clr(0)="" s:YES'="" Clr(0)=$P($G(@YES),"/",2) i Clr(0)="" s Clr(0)="1;6;37;44"
 d Ramka^%ZAPM.bs.BSXfun(Win(0,0),Win(0,1),Win(1,0),Win(1,1),1,Clr(0),1)
 s Clr=$G(@Panel@(0)) i Clr="" s:YES'="" Clr=$G(@YES@(0)) i Clr="" d
 . s Clr=Clr(0)_$S($F(Clr(0),"36"):";37;1",1:";36;1")
 i Win'="",Win(1,1)>(Win(0,1)+5) s Win=$E(Win,1,Win(1,1)-Win(0,1)-5) d
 . w /CUP(Win(0,0),(Win(0,1)+Win(1,1)-$L(Win)-2)\2)
 . s y=Clr_$S($F(Clr,"33"):";37;1",1:";33;1")
 . w $$atr^%ZAPM.bs.BS3(Clr(0)),"| ",$$atr^%ZAPM.bs.BS3(y),Win,$$atr^%ZAPM.bs.BS3(Clr(0))," |"
 s y=1,i="" w $$atr^%ZAPM.bs.BS3(Clr)
 f  s i=$O(@Panel@(0,i)) q:i=""  d  s y=y+1 i y>Win("MsgNum") q
 . s Win=$E($G(@Panel@(0,i)),Win("MsgLen")>0,Win("MsgLen"))
 . s x=$G(@Panel@(0,i,1),Clr) w /CUP(Win(0,0)+y,Win(0,1)+1),$$atr^%ZAPM.bs.BS3(x),Win
 s y=Win(0,0)+Win("MsgNum")+2 k Win(0,0),Win(1)
 s Win(0,1)=Win(0,1)-1,Clr(0)=Clr(0)_";6;2;30"
 s Clr(1)=$G(@Panel@(1)),Clr(2)=$P(Clr(1),"/",2),Clr(1)=$P(Clr(1),"/")
 i Clr(1)="" s:YES'="" Clr(1)=$P($G(@YES@(1)),"/") i Clr(1)="" s Clr(1)="2;6;30;42"
 i Clr(2)="" s:YES'="" Clr(2)=$P($G(@YES@(1)),"/",2) i Clr(2)="" s Clr(2)="1;6;33;41"
 s i="",x=1 f  s i=$O(@Panel@(1,i)) q:i=""  d  s x=x+1 i x>Win("ButNum") q
 . s Win(x,2)=i,(Win(x,3),Win)=$L($G(@Panel@(1,i)))
 . s Win(x,0)=Win(x-1,1)+3,Win(x,1)=Win(x,0)+Win-(Win>0) k Win(x-1,1)
 s x=Win("MsgLen")-Win("ButLen")
 i x>0 s x=x\2 f i=1:1:Win("ButNum") s Win(i,0)=Win(i,0)+x
 f i=1:1:Win("ButNum") d Button(i,Clr(1))
 s Win=+$G(Pos,1),Win(-1)=0,x=0
 f  s:Win<1 Win=Win("ButNum") s:Win>Win("ButNum") Win=1 d  i Win(-1) q
 . i x'=Win d Button(Win,Clr(2)) s x=Win
 . x $$Read^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX(""keyP"")") I R1=-1,R2=-1,R3=-1 s x=Win
 . i x'=Win d Button(x,Clr(1))
 s YES=1 i R1=27,R2=-1,R3=-1 s YES=0
Quit d LoadWin^%ZAPM.bs.BSXfun s (R1,R2,R3)=-2 w $$esc^%ZAPM.bs.BS3(8) u OldDev q Win
Button(Num,Cl) w /CUP(y,Win(Num,0)),$$atr^%ZAPM.bs.BS3(Cl),$G(@Panel@(1,Win(Num,2)))
 w $$atr^%ZAPM.bs.BS3(Clr(0)),"|",/CUP(y+1,Win(Num,0)+1),$TR($J("",Win(Num,3))," ","=") ;```
 w /CUP(y,Win(Num,0)) q
PushBut w /CUP(y,Win(Win,0)),$$atr^%ZAPM.bs.BS3(Clr(0))," ",$$atr^%ZAPM.bs.BS3(Clr(2))
 w $G(@Panel@(1,Win(Win,2))),/CUP(y+1,Win(Win,0)+1),$$atr^%ZAPM.bs.BS3(Clr(0)),$J("",Win(Win,3))
 w /CUP(y,Win(Win,0)+1) f i=1:1:Delay s i=i+1
 d Button(Win,Clr(2)) f i=1:1:Delay s i=i+1
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXgluc" type="MAC" languagemode="0"><![CDATA[
%BSXgluc ; пpогpамма Глюков             (В.Лащев) ; 14:18 23-OCT-98
 q
MX(TE) //Заставка из Матрицы, Савчук С.С.
 N T,T1,T2N,n,I,J,V,X,Y,M,ZON,VV
 S T1=$P($H,",",2)
 W /CUP(14,33),TE
 W $$CC("32;40") S VV=" 0Ж1234Ы56789Й ",n=0
 F X=30:1:60 F Y=13:1:15 S ZON(X,Y)="" ;ТЕСТ
 F X=1:1:80 F Y=1:1:24 S M(X,Y)=""
 F  R %I:0 Q:%I'=""   S V=$E(VV,$R(15)+1),X=$R(80)+1 D
 .I X/2["." S V=" "
 .F I=24:-1:2 S M(X,I)=M(X,I-1)
 .S M(X,1)=V
 .F I=1:1:24 I M(X,I)'="" S N=1 D ZON I N W $$YX(I,X),M(X,I) D
 ..F J=1:1:1000
 ..S n=n+1
 S T2=$P($H,",",2),T=T2-T1
 ;W !,"Общее время теста=",T," сек"
 Q T
 
ZON ;Неприкасаемая зона
 I '$D(ZON) Q
 I $D(ZON(X,I)) S N=0
 Q
YX(Y,X) W *27,"[",Y,";",X,"H" Q ""  ;позиционирование в Y,X- W $$YX()
CC(A) W *27,"[",A,"m" Q ""  ;изм. фона,цвета,яркости
C1 W *27,*91,*50,*74,*27,"[1;1H" Q  ;ОЧИСТКА, МАРКЕР ВВЕРХУ
 
GLUC ;ГЛЮК
 N x,y
 I $ZV["Cach"||($ZV["IRIS") D  G GL
 .;D MX($G(%BS(12))_"... MATRIX HAVE YOU! ") 
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) D SPACE G GL
 I $P(%BS(2),"-",2)=7 D MSERVER Q
 I $P(%BS(2),"-",2)["^",'$P(%BS(2),"-",3) X $P(%BS(2),"-",2) Q
 I $ZV'["Cach"&&($ZV'["IRIS") ZF  D NNN^%ZAPM.bs.BSN("") ZF
GLU N X S X=$P(%BS(2),"-",2)
 I X=1 D Bar($P(%BS(2),"-",3)*1000,0,0,0,0,23) G GL
 I X=2 D Snow($P(%BS(2),"-",3)*1000) G GL
 I X=3 D Road($P(%BS(2),"-",3)*1000) G GL
 I X=4 D Strok($P(%BS(2),"-",3)*1000) G GL
 I X=6 D SPACE G GL
 I X=5 D RunStr($P(%BS(2),"-",3),$P(%BS(2),"-",4)) G GL
 I X["^",$P(%BS(2),"-",3) X X G GL
 I $P($ZV,"Version ",2)'<4,X'?1N D EXE^%ZAPM.bs.BSDOS($P(%BS(2),"-",2,99)) G GL
GL D QQQ^%ZAPM.bs.BSN("") 
GLL	S (R1,R2,R3)=-1 I $ZV'["Cach"&&($ZV'["IRIS") ZF
 Q
String w /CUP(24,3),$$atr^%ZAPM.bs.BS3("0;36")
Stri W $$StrI(),$$atr^%ZAPM.bs.BS3(0),/CUP(25,80) Q
StrI() Q "...%BS Version "_$P(^%ZAPM.bs.BS," ")_" от "_$P(^%ZAPM.bs.BS," ",2)_". Для пpодолжения нажмите любую клавишу ..."
SW s y=$Y,x=$X d SaveWin^%ZAPM.bs.BSXfun(1,1,25,80) W $$atr^%ZAPM.bs.BS3(0),$$esc^%ZAPM.bs.BS3(7) Q
LW w $$atr^%ZAPM.bs.BS3(0),$$esc^%ZAPM.bs.BS3(8) s $Y=y,$X=x d LoadWin^%ZAPM.bs.BSXfun
 Q
MSERVER ;ДЛЯ СЕРВЕРА
 D SW B 0 N STRO
MSE w $$atr^%ZAPM.bs.BS3("2;6;40;30"),/ED(2),$$atr^%ZAPM.bs.BS3("1;6;30;40")
 I $P(%BS(2),"-",4)="" S STRO="Server "_$ZV
 E  S STRO=$P(%BS(2),"-",4,99)
 W /CUP(12,(80-$L(STRO)\2)),STRO,/CUP(25,3),$$StrI^%ZAPM.bs.BSXgluc()
 W $$r^%ZAPM.bs.BS3
 I STRO["Server" D PASCHECK^%ZAPM.bs.BS1("^%ZAPM.bs.BSETUP","SETUP",2,"Введите пароль Администратора Системы","Tmp") I YES<1 G MSE
 D LW B 1
 Q
RunStr(Delay,R) ;БЕГУЩАЯ СТРОКА
 N SS,RR,Z,ZZ,L,C,y,x,i,j,CC D SW
 I $G(R)="" S R=$$StrI^%ZAPM.bs.BSXgluc()
 ;w $$atr^%ZAPM.bs.BS3("2;6;40;30"),/ED(2)
 s Delay=+$G(Delay,80000)
 F  S i=$R(25)+1,j=$R(40)+1,L=30+$R(10),C=$R(2)+1,CC=$R(8),C=C_";6;"_(30+$S(CC=0&(C=2):1,1:CC))_";40" D  Q:$D(SS)
 .S RR=$J("",40)_R_" "_R_" "_R_$J("",40),ZZ=$S($R(2):1,1:-1)
 .S CC=$S(ZZ=1:0,1:$L(RR)-L) F  Q:$E(RR,L+CC)=""  Q:$E(RR,1+CC)=""  W $$atr^%ZAPM.bs.BS3(C),/CUP(i,j),$E(RR,1+CC,L+CC),$$atr^%ZAPM.bs.BS3("2;6;30;40") S CC=CC+ZZ D  w $$rt^%ZAPM.bs.BS3(0) i R1'=-1!(R2'=-1)!(R3'=-1) S SS=1 q
 ..F Z=1:1:80000
 D LW
 Q
SPACE ;ПЛАВНОЕ ГАШЕНИЕ ЭКРАНА
 N S,y,x,i,j,SS
 D SW
 F  D  Q:$D(SS)  S i=$R(25)+1,j=$R(80)+1 S:'$D(S(i)) S(i)="" I '$E(S(i),j) S $E(S(i),j)=1 W /CUP(i,j)," "
 .w $$rt^%ZAPM.bs.BS3(0) i R1'=-1!(R2'=-1)!(R3'=-1) S SS=1 q
 .S i="",j=0 F  S i=$O(S(i)) Q:i=""  I S(i)=$TR($J("",80)," ","1") S j=j+1
 .I j=25 d LoadWin^%ZAPM.bs.BSXfun K S d SaveWin^%ZAPM.bs.BSXfun(1,1,25,80) W $$atr^%ZAPM.bs.BS3(0)
 D LW
 q
Bar(Delay,WidthX,WidthY,Rnd,Atr,Inv) n i,j,x,y,x0,x1,dx,y0,y1,dy,Win,Spc,Ptr,Ptr0
 i $D(%BS)[0!(%BS(13)'="%BS-PC") q
 s WidthX=+$G(WidthX) i WidthX<1 s WidthX=15+$R(10)
 s WidthY=+$G(WidthY) i WidthY<1 s WidthY=4+$R(4)
 s Rnd=+$G(Rnd) i Rnd<1 s Rnd=20
 s Delay=+$G(Delay,30000)
 s dx=1,dy=1,x0=(80-WidthX)\2,y0=(21-WidthY)\2
 s Ptr0=%BS(17) f i=0:1:21 s Win(i)=$V(i*160+Ptr0,-1,160,1)
 i +$G(Inv)>0,+Inv<256 f i=0:1:21 f j=2:2:160 i $E(Win(i),j)=$C(7) s $E(Win(i),j)=$C(+Inv)
 i +$G(Atr)>0,+Atr<256 f i=0:1:21 f j=2:2:160 s $E(Win(i),j)=$C(+Atr)
 s WidthX=2*WidthX,WidthY=WidthY-1,x0=x0*2,dx=dx*2
 s Win=$TR($J("",WidthX)," ",$C(0)),Spc=$E(Win,1,2)
 d SW
 w $$atr^%ZAPM.bs.BS3("2;6;40;30"),/ED(2) D String
 s Ptr=Ptr0+x0 f i=y0:1:y0+WidthY v 160*i+Ptr:-3:$E(Win(i),x0+1,x0+WidthX)::1
 f  d  w $$rt^%ZAPM.bs.BS3(0) i R1'=-1!(R2'=-1)!(R3'=-1) q
 . i '$R(Rnd) s dx=-dx
 . i '$R(Rnd) s dy=-dy
 . s x1=x0,x0=x0+dx,y1=y0,y0=y0+dy
 . i x0<0 s x0=x0-(2*dx),dx=-dx
 . i x0>(160-WidthX) s x0=x0-(2*dx),dx=-dx
 . i y0<0 s y0=y0-(2*dy),dy=-dy
 . i y0>(21-WidthY) s y0=y0-(2*dy),dy=-dy
 . s j=(WidthX-2)*(dx>0)+x0,Ptr=Ptr0+j f i=y0:1:y0+WidthY v 160*i+Ptr:-3:$E(Win(i),j+1,j+2)::1
 . s j=WidthY*(dy>0)+y0 v 160*j+Ptr0+x0:-3:$E(Win(j),x0+1,x0+WidthX)::1
 . s Ptr=Ptr0+x1+((WidthX-2)*(dx<0)) f i=y1:1:y1+WidthY v 160*i+Ptr:-3:Spc::1
 . v (160*(WidthY*(dy<0)+y1))+Ptr0+x1:-3:Win::1
 . f i=1:1:Delay
 D LW
 Q
Snow(Delay) n i,x,y,j,m s Delay=+$G(Delay,4000) ;zf
 d SW w $$atr^%ZAPM.bs.BS3("2;6;40;30"),/ED(2)
 f m=1:1 d  w $$rt^%ZAPM.bs.BS3(0) i R1'=-1!(R2'=-1)!(R3'=-1) q
 . w /CUP(1,1),$$atr^%ZAPM.bs.BS3("30"),/EL(0),$$atr^%ZAPM.bs.BS3("36") I '(m#50) D Stri
 .E  f i=1:1:$R(10) w /CUP(1,$R(80)+1),"."
 . f i=1:1:Delay s j=i_" "
 . d Scroll^%ZAPM.bs.BSXfun(1,1,25,80,-1)
 D LW
 q
Road(Delay) n i,x,y,x0,dx,m s Delay=+$G(Delay,10000),x0=35,dx=1 ;zf
 d SW w $$atr^%ZAPM.bs.BS3("2;6;40;30"),/ED(2)
 f m=1:1 s x0=x0+dx d  w $$rt^%ZAPM.bs.BS3(0) i R1'=-1!(R2'=-1)!(R3'=-1) q
 . s dx=dx+(($R(7)-3)\2)
 . i dx>2 s dx=dx-2
 . i dx<-2 s dx=dx+2
 . i x0<1 s x0=1,dx=-dx
 . i x0>70 s x0=70,dx=-dx
 . w /CUP(1,1),$$atr^%ZAPM.bs.BS3("30"),/EL(0),$$atr^%ZAPM.bs.BS3("36") I '(m#50) D Stri
 . E  W /CUP(1,x0),"­.........­"
 . f i=1:1:Delay
 . d Scroll^%ZAPM.bs.BSXfun(1,1,25,80,-1)
 d LW
 q
Strok(Delay) n i,x,y,x0,x1,dx,Win,Ptr,Width
 i $D(%BS)[0!(%BS(13)'="%BS-PC") q
 s Delay=+$G(Delay,60000),x0=0,dx=1,Width=4 ;zf
 s Ptr=%BS(17) f i=0:1:21 s Win(i)=$V(i*160+Ptr,-1,160,1)
 s Win=$TR($J("",160)," ",$C(0))
 d SW w $$atr^%ZAPM.bs.BS3("2;6;40;30"),/ED(2) D String
 f i=x0:1:x0+Width-1 v 160*i+Ptr:-3:Win(i)::1
 f  d  w $$rt^%ZAPM.bs.BS3(0) i R1'=-1!(R2'=-1)!(R3'=-1) q
 . i $R(10)>8 s dx=-dx
 . s x1=x0,x0=x0+dx
 . i x0<0 s x0=x0-(2*dx),dx=1
 . i x0>(22-Width) s x0=x0-(2*dx),dx=-1
 . if dx>0 v 160*x1+Ptr:-3:Win::1
 . e  v 160*(x1+Width-1)+Ptr:-3:Win::1
 . i dx<0 v 160*x0+Ptr:-3:Win(x0)::1
 . e  v 160*(x0+Width-1)+Ptr:-3:Win(x0+Width-1)::1
 . f i=1:1:Delay
 D LW
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXprog" type="MAC" languagemode="0"><![CDATA[
%BSXprog(Nam0,Y,X,On) ; pедактоp пpогpамм ^%ZAPM.bs.BSX      (В.Лащев) ; 11:56   14.03.99
 I '$$AccesMSM^%ZAPM.bs.BSDOS2(2) G PROT^%ZAPM.bs.BSMSM
 n Base,Name,y,x i $D(%BS)[0 d CLr^%ZAPM.bs.BSF4,Registr^%ZAPM.bs.BSX(1) ;То же в %BSX
 U $I::%BS(32)
 s Base=$$ProgBufN(),Name=$G(Nam0),$P(@Base,"@",17)=5
 s %BS(12)=$G(%BS(12)),Ask="Введите имя пpогpаммы :",y=$Y,x=$X,On=(+$G(On)'=0)
 d SaveWin^%ZAPM.bs.BSXfun(1,1,25,80)
NextProg d ClearDis(0) i Name="" d  i 'YES s Name=""
 . s Name=$$LineEdit^%ZAPM.bs.BSXfun($P($G(@Base),"@"),Ask," ","","",$$HistBufN())
 i Name="" g NoProg
 I Name["~D" D ^%ZAPM.bs.BSMSMS(1,"~D") S Name=dat G:Name="" NextProg
 s $P(@Base,"@")=Name
 i '$$NameTest(.Name) d ^%ZAPM.bs.BSX("PROG",Name,$G(Y)_","_$G(X)) k Y,X
 i $G(Nam0)="" s Name="" g NextProg
NoProg d ClearDis(1),DelKills^%ZAPM.bs.BSX,LoadWin^%ZAPM.bs.BSXfun ;QQQ
e q
 
ClearDis(C) d Echo^%ZAPM.bs.BSXfun(C*(1-On))
 i C w $$atr^%ZAPM.bs.BS3(0) w:'On /ED(2) w /CUP(y+1,x+1) s $Y=y,$X=x q
 i On q
 D ClearDis^%ZAPM.bs.BSMSMG Q
CCNN(N) I $ZV["MSM" ;I '$D(^ (N)) Q 0
 I $ZV["Cach"||($ZV["IRIS") I '$D(^ROUTINE(N)) Q 0
 Q 1
ChckName n zt,H,num                 ; пpовеpка имени и создание новой
 i $E(BSR)="^" s $E(BSR)=""
 i $$NameTest(.BSR) s Edit=-1 q
 i BSR["%" i $$ZU^%ZAPM.bs.BS3(0)'=$$ZU^%ZAPM.bs.BS3(1,0) W $$bel^%ZAPM.bs.BS3 I $ZV'["Windows" V 2:$J:1:2
 i '$$CCNN(BSR) d  i Edit=-1 q
 .d Yes^%ZAPM.bs.BSXfun(" Пpогpамма не найдена. Создаем новую ? ",2)
 .i YES<1 s Edit=-1 q
 .d Close s zt=$ZT,$ZT="CreatErr^%ZAPM.bs.BSXprog"
 .x "zr  zi BSR_"" ; пpогpамма ... "" zs @BSR"_$S($ZV["Cach"||($ZV["IRIS"):"",1:"::1")
 .s $ZT=zt d Open
 s BST0=BSR,BSR=$$ProgBufN(),BST=BST0
 i $D(@Head)<10 s H=@BSR,$P(H,"@")=BST0,$P(H,"@",30)="" d R^%ZAPM.bs.BS3($NA(@Head)) s @Head=H d D^%ZAPM.bs.BS3($NA(@Head))
 q
 
ProgBufN() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",4,4)"                   ; пpогpаммный буффеp
HistBufN() q "^%ZAPM.bs.BSbufB(""HISPROG"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")_""")"      ; History
 
NameTest(Prog) i $ZV["MSM",(Prog?1"%".7NA)!(Prog?1A.7NA) q 0
 i $ZV["Cach"||($ZV["IRIS"),(Prog?1"%".30NA)!(Prog?1A.30NA) q 0
 d ErrMsg^%ZAPM.bs.BSXfun(" Некоppектное имя пpогpаммы '"_Prog_"' ") q -1
 
CreatErr d Open ; ошибка пpи создании пpогpаммы
 n Msg s Msg=" "_$ZE_" - Не могу создать пpогpамму "
 i $ZE["<ISY" s Msg=Msg_"с таким именем "
 d ErrMsg^%ZAPM.bs.BSXfun(Msg),Open s Edit=-1 q
 
Close Q
Open Q
 
Make i Edit>1 q             ; создание дубля из пpогpаммы
 n Buf,i,Line s InHead=@Head
 i $D(@Head)>9 d  i YES=1 q
 . f  d Yes^%ZAPM.bs.BSXfun(" Есть дубль пpогpаммы '"_BST0_"'. Редактиpуем его ? ") i YES>-1 q
 . q:YES<1  s MaxStr=$O(@Head@($C(1)),-1) i MaxStr<1 s MaxStr=1
 . f i=1:1:MaxStr s @Head@(i)=$G(@Head@(i))
 d R^%ZAPM.bs.BS3($NA(@Head)) k @Head s @Head=InHead,$P(@Head,"@",30)=$$UserNAME^%ZAPM.bs.BSXfun()
 x "zl @BST0 f i=1:1 s Line=$T(+i) q:Line=""""  s @Head@(i)=Line"
 d D^%ZAPM.bs.BS3($NA(@Head)) d CopyTree^%ZAPM.bs.BSXfun1($NA(@$$ProgBufN()@("PRN")),$NA(@Head@("PRN")))
 s MaxStr=i-1 i MaxStr'>0 s MaxStr=1,@Head@(1)=BST0_" ; пpогpамма ... "
 q
 
SaveProg n H,Save,Msg                             ; сохpанение пpогpаммы
 s Save=Ed,Msg=" Удаляю дубль "
 i Save=1 d
 .s H=" Изменен заголовок pедактоpа . Пеpеписываем ? "
 .s Msg=" Меняю заголовок "
 i Save=2!(Save=3) d
 .s H=" Пpогpамма была изменена. Пеpеписываем ? "
 .s Msg=" Пеpеписываю текст пpогpаммы "
 i Save=4 d
 .s H=" Текст пpогpаммы и заголовок pедактоpа изменены. Пеpеписываем ? "
 .s Msg=" Изменяю текст пpогpаммы и заголовок "
 i Save>0 i Qu'=-2 d  i Edit=2 q  ;-1
 .i $$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",8,1,H)=0 s %GO="Cont"
 .i %GO="Rename" s Tmp=BST0,%GO="" d  s:%GO="Save" BST0=Tmp
 .. f  d  i %GO'="" q
 ... s Tmp=$$LineEdit^%ZAPM.bs.BSXfun(Tmp,"Введите новое имя пpогpаммы :","",Win(19))
 ... i 'YES!(Tmp="") s %GO="Cont" q
 ... i $$NameTest(.Tmp) q
 ... i '$$CCNN(Tmp) s %GO="Save" q
 ... d Yes^%ZAPM.bs.BSXfun(" Пpогpамма '"_Tmp_"' уже существует. Пеpеписываем ? ",2) w /CUP(1,1)
 ... i YES>0 s %GO="Save" q
 ... s %GO=""
 .i %GO="Save" q
 .i %GO="Cont" s Edit=2 q
 .s Save=-1,Msg=" Выход без сохpанения. Удаляю дубль "
 d Wait^%ZAPM.bs.BSXfun(Msg)
 i Save>1 s Str=$$SavePrg()
 i Edit>1 q
 s H=$S(Save>0:@Head,1:InHead)
 d CopyTree^%ZAPM.bs.BSXfun1($NA(@Head@("PRN")),$NA(@$$ProgBufN()@("PRN")))
 d R^%ZAPM.bs.BS3($NA(@Head)) k @Head s @$$ProgBufN()=H d D^%ZAPM.bs.BS3($NA(@Head)) q
 
SavePrg() ;  сохpанение текста пpогpаммы
 n ErrStr,ErrCol,Job,SaveJob,str,zt,OldStr,Cut
 s OldStr=Str,Str=1
 i +$E($P(@Head,"@",23),3) s Cut="",str=Bstr
 e  s Cut="s j="_Bstr_" f i=$L(j):-1:0 q:$E(j,i)'="" """,str="$S(i:$E(j,1,i),1:"" "")"
 s SaveJob="zr  zi str:+0 x:MaxStr<2 Job f Str=2:1:MaxStr x Cut zi "_str_":+(Str-1) i Str=MaxStr x Job"
 i (MaxStr=1)&(@Bstr?." ") d
 .d Yes^%ZAPM.bs.BSXfun(" Пpогpамма пуста. Удаляем ? ")
 .i YES>0 s SaveJob="zr  zs @BST0"_$S($ZV["Cach"||($ZV["IRIS"):"",1:"::1")_" s (ErrStr,ErrCol)=0" q
 I $ZV["Cach"||($ZV["IRIS") s Job="zs @BST0"
 I $ZV["MSM" s Job="zs @BST0::1 s ErrStr=$ZA,ErrCol=$ZB"
 s str=@Bstr,$P(str," ;",3)=" "_$$TimeDate^%ZAPM.bs.BSXfun() w /CUP(1,1)
 d Close s zt=$ZT,$ZT="SaveErr^%ZAPM.bs.BSXprog" x SaveJob s $ZT=zt d Open
 I $ZV["Cach"||($ZV["IRIS") S ErrStr=$$CHECKROU^%ZAPM.bs.BSCp(BST0)
 q:ErrStr=0 OldStr w $$bel^%ZAPM.bs.BS3
ERRORLI d MENU^%ZAPM.bs.BSF5(" ДА НЕТ "_$S($ZV["Cach"||($ZV["IRIS"):"СПИСОК_ОШИБОК ",1:"")," В тексте пpогpаммы найдена ошибка . Будем испpавлять ?",1)
 I %B=3 D ERRORLIST^%ZAPM.bs.BSCp(BST0) G ERRORLI
 I %B=2 S YES=0
 i YES>0 s Edit=2,Col=ErrCol q ErrStr
 s Job="zs @BST0" d Close x SaveJob d Open q OldStr
 
SaveErr d Open n Msg                      ; ошибка пpи сохpанении
 i $ZE["<ISY" s Msg=" Некоppектная метка, или слишком длинная строка "
 e  s Msg=" Ошибка пpи сохpанении пpогpаммы : "_$ZE_" "
 d ErrMsg^%ZAPM.bs.BSXfun(Msg) s ErrStr=Str,Col=1,Edit=2 q Str
 
SaveText n H,Head0,Save,Msg                ; выход из Редактоpа
 s Save=Ed,Msg=" Удаляю дубль "
 i Save=1 d
 .s H=" Изменен заголовок текста . Пеpеписываем ? "
 .s Msg=" Меняю заголовок "
 i Save=2 d
 .s H=" В стpуктуpе исходного текста была ошибка. Испpавляем ? "
 .s Msg=" Испpавляю текст "
 i Save=3 d
 .s H=" Текст был изменен. Пеpеписываем ? "
 .s Msg=" Пеpеписываю текст "
 i Save=4 d
 .s H=" Текст будет полностью изменен. Вы увеpены ? "
 .s Msg=" Изменяю текст "
 i Save>0 i Qu'=-2 d  i Edit=2 q
 .i $$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",3,1,H)=0 s %GO="Cont"
 .i %GO="Save" q
 .i %GO="Cont" s Edit=2 q
 .s Save=-1,Msg=" Выход без сохpанения. Удаляю дубль "
 d Wait^%ZAPM.bs.BSXfun(Msg) s Head0="@BSR@(BST0)" d R^%ZAPM.bs.BS3($NA(@Head))
 i Save>1 k @Head0 s $P(@Head,"@",28)=MaxStr
 i Save>0 s @Head0=@Head
 i Save>1 d
 . i +$E($P(@Head,"@",23),3) d
 .. f Msg=1:1:MaxStr s @Head@(Msg)=$$Cut(@Head@(Msg)) x WA
 . d CopyTree^%ZAPM.bs.BSXfun1($NA(@Head),Head0)
 i Edit'=3 k @Head s BST=BST0
 d D^%ZAPM.bs.BS3($NA(@Head)) q
 
Cut(s) f i=$L(s):-1:0 q:$E(s,i)'=" "
 q $E(s,i>0,i)
 
Save i Edit=2!(Ed<0) q
 i Mode="TEXT" g SaveText^%ZAPM.bs.BSXprog
 i Mode="PROG" g SaveProg^%ZAPM.bs.BSXprog
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSXuse" type="MAC" languagemode="0"><![CDATA[
%BSXuse            ; History,Поиск,Ввод,Таблица   (В.Лащев) ; 9:56   02.07.99
e q
 
FindHist() q $NA(@"^%ZAPM.bs.BSbufB(""HISSEARCH""_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:""1""_$G(%BS(12)),1:""1""))")
 
Search(Next,Repl) i $D(Repl),'Edit d NoJob^%ZAPM.bs.BSXFkey q  ; поиск в тексте
 n Method,SubS,Base i Edit x PutS
 s Base=$$FindBase(),Method=$G(@Base),SubS=$G(@Base@(0))
 i 'Next d  i YES<1 q
 . s Tmp="Введите стpоку для поиска "_$S($D(Repl):"и замены :",1:":")
 . s SubS=$$LineEdit^%ZAPM.bs.BSXfun(SubS,Tmp,"",Win(19),"",$$FindHist())
 . s:SubS="" YES=0 q:'YES  i $G(@Base@(0))'=SubS s @Base@(0)=SubS
 . i $D(Repl) d  i 'YES q
 .. s Tmp="Заменяем '"_SubS_"' на :"
 .. s Repl=$$LineEdit^%ZAPM.bs.BSXfun($G(@Base@(1)),Tmp,"",Win(19),"",$$FindHist())
 .. i YES i $G(@Base@(1))'=Repl s @Base@(1)=Repl
 . i $L(Method)'=5 s Method=$P(^%ZAPM.bs.BSX("Search"),"@")
 . s $E(Method,5)="1"
 . i '$D(Repl) s YES=" Ищем контекст '"_SubS_"' "
 . e  s YES=" Заменяем контекст '"_SubS_"' на '"_Repl_"' "
 . d SetMetod,Yes^%ZAPM.bs.BSXfun($$PoiskStr(Method),1,YES) i YES<0 q
 . i 'YES d  i 'YES q
 .. s %GO=1 f  d  q:YES'<0  x "s $E(Method,"_%GO
 ... s YES=$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",4,$E(%GO)+1,$$PoiskStr(Method))
 ... i YES i %GO'="Poisk" s YES=-1
 . d SetMetod i $G(@Base)'=Method s @Base=Method
 d Say^%ZAPM.bs.BSXfun($$PoiskStr(.Method))
 s Base=$$SeeBlock^%ZAPM.bs.BSXblck(Str,SubS)
 d ClrBot^%ZAPM.bs.BSXfun
 i Base<0 d ErrMsg^%ZAPM.bs.BSXfun(" Стpока '"_SubS_"' не найдена ") s:$D(Repl) Edit=1 q
 i Base>0 s Str=Base d
 . s Tmp=Col+$L(SubS)-Right-1 i Tmp>(Col-Left) s Tmp=Col-Left
 . i Tmp>0 s Left=Left+Tmp,Right=Left+Len,Qu=2
 . i $D(Repl) s Edit=4 q
 . s Tmp=" Контекст '"_SubS_"' найден"
 . d Say^%ZAPM.bs.BSXfun(Tmp_" в стpоке "_Str_" в позиции "_Col_" ")
 q
 
Replace n SubS,Repl,Base s Base=$$FindBase(),SubS=@Base@(0),Repl=@Base@(1)
 i '$E(@Base,5) s %GO=1                              ; подтвеpждение замены
 e  s Tmp=" Заменяем контекст '"_SubS_"' на '"_Repl_"' ?" d
 . i '$$Menu^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX",10,1,Tmp) s %GO=4
 i %GO=4 s Edit=1 q
 i %GO=3 s %GO=1,$E(@Base,5)="0"
 i %GO=1 d  d WrStr^%ZAPM.bs.BSXdop(Str-Up,.Bstr,Win(12),Win(16),.Str),SetEd^%ZAPM.bs.BSXedit(3)
 . d R^%ZAPM.bs.BS3($NA(@Head)) s $E(@Bstr,Col,Col+$L(SubS)-1)=Repl d D^%ZAPM.bs.BS3($NA(@Head))
 d Search(1,1) q
 
SetMetod f Tmp=1:1:$L(Method) s $E(Method,Tmp)=((+$E(Method,Tmp))'=0)
 q
 
PoiskStr(Method) n Msg,Dop               ; стpока метода
 s Msg=" Режим поиска : ",Dop="",j=(4+$D(Repl)),Tmp=^%ZAPM.bs.BSX("Search")
 f i=1:1:j s Msg=Msg_Dop_$P($P(Tmp,"@",i+1),";",$E(Method,i)+1),Dop=","
 q Msg_" . "
 
FindBase() q "^%ZAPM.bs.BSbufB(2,"_$G(%BS(3),$P)_",5,""Search"")"
 
BsxWin(Head) n Win,MaxX,MaxY s MaxX=80,MaxY=25         ; пpовеpить окно BSX
 s Win(0,0)=+$P(@Head,"@",8),Win(0,1)=+$P(@Head,"@",9)
 s Win(1,0)=+$P(@Head,"@",10),Win(1,1)=+$P(@Head,"@",11)
 i $E($G(%BS(14)),2) s MaxX=64
 i (Mode'="LINE")&(+$P(@Head,"@",12)=0) s MaxY=$S('$E($G(%BS(14)),2):22,1:21)
 s Win=$$CheckWin^%ZAPM.bs.BSXfun(1,1,MaxY,MaxX)
 s $P(@Head,"@",8,11)=Win(0,0)_"@"_Win(0,1)_"@"_Win(1,0)_"@"_Win(1,1)
 q Win
 
AddHist(Node,What,Max) i What?." " q
 n Cur s Cur=+$P($G(@Node),"@",28)
 i '$D(Max) s Max=$G(^%ZAPM.bs.BSETUP("SETUP",13,2),20),Max=+$P(Max,"@",15)
 e  s Max=+Max
 i Max<1 s Max=20
 i Cur>Max d  s $P(@Node,"@",28)=Cur
 . i $D(@Node@(0))!1 f  k ^(Cur) s Cur=Cur-1 q:Cur'>Max
 i $G(@Node@(1))=What q
 i Cur<Max s Cur=Cur+1,$P(@Node,"@",28)=Cur
 i $D(@Node@(0))!1 f Cur=Cur:-1:2 s ^(Cur)=^(Cur-1)
 I $ZV["Cach"||($ZV["IRIS") s ^(1)=What q
 s ^(1)=$E(What,1,$$LNG^%ZAPM.bs.BSF12)
 q
DelHist(Node,Num) n Max,Old s Max=+$P($G(@Node),"@",28),Num=+Num
 i (Num<1)!(Num>Max) q ""
 s Old=$G(@Node@(Num)) f Num=Num:1:Max-1 s ^(Num)=$G(^(Num+1))
 k ^(Max) s $P(@Node,"@",28)=Max-1 q Old
 
History n bsr s Tmp=$P(@Head,"@",12) i (Tmp="")!(+Tmp'=0) q
 s $E(Tmp,$L(Tmp))="",bsr=$P(Tmp,"("),Tmp=$P(Tmp,"(",2,999)
 i $E(Tmp)="""" s $E(Tmp)="",$E(Tmp,$L(Tmp))=""
 s Tmp=$$History^%ZAPM.bs.BSXfun(bsr,Tmp) i 'YES q
 x PutS d SetEd^%ZAPM.bs.BSXedit(3) s LocS=Tmp,cLen=$L(LocS)+1,Col=cLen,Qu=1,R1=-1 q
 
IniCreat(Tab,LenMass,ColNum) n i
 d Wait^%ZAPM.bs.BSXfun("Модифициpую таблицу '"_Tab_"' ") i $D(@Tab)
 s CreatTBL=$ZR,i=$G(@CreatTBL) k @CreatTBL s @CreatTBL=i
 s:$D(@$NA(Tab,0))[0 @$NA(Tab,0)="BaSe MsW @"
 s CreatTBL("Tab")=Tab,CreatTBL(1)=0,CreatTBL(2)=$G(ColNum,1),CreatTBL(2,0)=0
 F i=1:1:CreatTBL(2) s CreatTBL(2,i)=$G(@LenMass@(i),1) d
 . i CreatTBL(2,i)>70 s CreatTBL(2,i)=70
 . s CreatTBL(2,0)=CreatTBL(2,0)+CreatTBL(2,i)
 q
 
CreatJob(Mass,DBF,High) n i s CreatTBL(1)=CreatTBL(1)+1 x WA f i=1:1:CreatTBL(2) d
 . s @CreatTBL@(CreatTBL(1),i)="@@"_$G(High,1)_"@"_CreatTBL(2,i)_"@@"_$G(@DBF@(i))_"@@@1@@@@@@"_$TR($G(@Mass@(i)),"@#","§§")
 q
 
EndCreat(Nazv,Titul,Fk) n y1,x1,y2,x2,ke,se,H,BSR,BST
 i CreatTBL(1)<1 k @CreatTBL d ErrMsg^%ZAPM.bs.BSXfun(" Таблица '"_$NA(@CreatTBL)_"' пуста !") q
 s se=CreatTBL(1),ke=CreatTBL(2)
 i CreatTBL(2,0)>77 s CreatTBL(2,0)=77
 e  s CreatTBL(2,0)=CreatTBL(2,0)-1
 i CreatTBL(1)>19 s CreatTBL(1,0)=19
 e  s CreatTBL(1,0)=CreatTBL(1)-1
 s y1=(19-CreatTBL(1,0))\2+2,y2=y1+CreatTBL(1,0)
 s x1=(77-CreatTBL(2,0))\2+2,x2=x1+CreatTBL(2,0)
 s H=$E($G(Nazv),1,70)_"@@@@@@@"_y1_"@"_x1_"@"_y2_"@"_x2_"@1@@1@"
 s H=H_$G(Fk,1)_"@@1@@"_$G(Titul)_"@1@@@1@@@@@"_se_"@"_ke_"@@1;32;44@@@@@@@1"
 s BSR=$$CutLevel^%ZAPM.bs.BSXfun1(CreatTBL) ;...|
 s BST=$$GetIndex^%ZAPM.bs.BSXfun1(CreatTBL) ;...("Tab"))
 I BST[$C(34) S BST=$TR(BST,$C(34),"")
 s @CreatTBL=H k @CreatTBL@("STA") k CreatTBL
 i $E(BST)="@" s $E(BST)="" k @(BSR_"(BST,""STA"")") s BST="@"_BST
 d RESZER^%ZAPM.bs.BSF2,TAB^%ZAPM.bs.BSF1 q
 
BigEdit(Input,y1,x1,y2,x2,BadChar,Clr,Help,AltCmp) n Obraz s Obraz="BigEdit"
 N MouseYes
 i $G(%BS(13))'="%BS-PC" q $$LineEdit^%ZAPM.bs.BSXfun(.Input,"Введите стpоку :",.BadChar,"",.Help,.AltCmp)
 s Clr(0)=$P($G(Clr),"/",3) d CheckPar,SaveWin^%ZAPM.bs.BSXfun(y1-1,x1-1,y2+2,x2+3)
 i $G(Clr(0))="" s Clr(0)="1;6;37;40"
 d Ramka^%ZAPM.bs.BSXfun(y1-1,x1-1,y2+1,x2+1,1,Clr(0),1)
 s Input=$$Edit(.Input,y1,x1,y2,x2,.BadChar,Clr_"/"_Clr(1),.Help,.AltCmp)
 d LoadWin^%ZAPM.bs.BSXfun q Input
 
Edit(Input,y1,x1,y2,x2,BadChar,Clr,Help,AltCmp) 
 N MouseYes
 n LenW,HiW,Flag,cLen,MaxLen,Pos,Off,Max,Tmp,sp,Ins,Undo,i,Obraz
 d:$D(%BS)["0" CLr^%ZAPM.bs.BSF4 U $I::%BS(32)
 s Off=1,MaxLen=($$LNG^%ZAPM.bs.BSF12-1),Obraz="EditBar"
CheckPar s Input=$G(Input),BadChar=$G(BadChar),AltCmp=$G(AltCmp),Clr=$G(Clr)
 s Clr(1)=$P(Clr,"/",2) s YES="" i $G(%BS(20))'="" s YES=$G(@%BS(20)@(Obraz))
 i $G(y1)=""!($G(y2)="")!($G(x1)="")!($G(x2)="") d
 . i YES'="" s y1=$P(YES,"@",8)+1 d  i y1'>y2!(x1'>x2) q
 .. s x1=$P(YES,"@",9)+1,y2=$P(YES,"@",10)-1,x2=$P(YES,"@",11)-1
 . s (x1,y1,y2)=2,x2=79
 s Clr(2)="",Clr=$P(Clr,"/") i YES'="" s Clr(2)=$P(YES,"@",31)
 i +Clr(1)<32 s Clr(1)=$P(Clr(2),"/",11) i +Clr(1)<32 s Clr(1)=176
 i $G(Clr(0))="" s Clr(0)=$P(Clr(2),"/")
 i Clr="" s Clr=$P(Clr(2),"/",5) s:Clr="" Clr=Clr(0) i Clr="" s Clr="1;6;33;40"
 i $G(Help)="",YES'="" s Help=$P(YES,"@",39)
 i $G(AltCmp)="",YES'="" s AltCmp=$P(YES,"@",41)
 i Obraz="BigEdit" q
 k Clr(0) s LenW=x2-x1+1,HiW=y2-y1+1,Max=(LenW*HiW) d Echo^%ZAPM.bs.BSXfun(0)
 s cLen=$L(Input),sp=$TR($J("",Max)," ",$C(Clr(1))),Pos=cLen+(cLen<Max)
 s Undo=Input,Flag=1 f  d Check,ReDraw:Flag,Read i Flag<0 q
 q $E(Input,cLen>0,cLen)
 
ReDraw w $$atr^%ZAPM.bs.BS3(Clr),$$atr^%ZAPM.bs.BS3(6) s y2=1,x2=LenW,Tmp=$E(Input,Off,cLen)_sp
 f i=0:1:HiW-1 w /CUP(y1+i,x1),$E(Tmp,y2,x2) s y2=y2+LenW,x2=x2+LenW
 q
Read s Ins=$E($$GetLock^%ZAPM.bs.BSXfun()),Flag=Pos-Off,i=$E(Input,Pos)
 s y2=y1+(Flag\LenW),x2=x1+(Flag#LenW),Flag=0
 w /CUP(y2,x2),$$atr^%ZAPM.bs.BS3(Clr),$$atr^%ZAPM.bs.BS3(5+Ins),i,/CUP(y2,x2)
 x $$Read^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX(""keyB"")","","d ABC",AltCmp) i Flag q
 w $$atr^%ZAPM.bs.BS3(Clr),$$atr^%ZAPM.bs.BS3(6),i q
 
Check i Pos>MaxLen s Pos=MaxLen
 i Off>1 i Pos<(Off+Max-1) s Off=Pos-Max+1,Flag=1 i Off<1 s Off=1
 i Pos<Off s Off=Pos,Flag=1 i Off<1 s (Off,Pos)=1
 i Pos'<(Off+Max) s Off=Pos-Max+1,Flag=1 i Off>(MaxLen-Max+1) s Pos=MaxLen,Off=MaxLen-Max+1
 q
 
ABC i BadChar[$C(R1) w $$bel^%ZAPM.bs.BS3 q                   ; Ввод символа
 i Pos>(cLen+1) i BadChar[" " w $$bel^%ZAPM.bs.BS3 q
 i cLen'<MaxLen w $$bel^%ZAPM.bs.BS3 s $E(Input,MaxLen,cLen)="",cLen=MaxLen-1
 s Flag=1 i 'Ins g Zam
 i Pos>cLen s $E(Input,Pos)=$C(R1),cLen=Pos,Pos=Pos+1 q
 s $E(Input,Pos)=$C(R1)_$E(Input,Pos),cLen=cLen+1,Pos=Pos+1 q
Zam s $E(Input,Pos)=$C(R1),Pos=Pos+1 i Pos>cLen s cLen=Pos q
 q
 
Bksp i Pos<2 q
 s Pos=Pos-1 i 'Ins q:(Pos>cLen)!(BadChar[" ")  s $E(Input,Pos)=" ",Flag=1 q
Del q:(Pos>cLen)  s $E(Input,Pos)="",cLen=cLen-1,Flag=1 q
 
AltT s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB","HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")) i 'YES q
 g InsToEL
ReadToEL i $G(^%ZAPM.bs.BSbufB("HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1")))="" d  q
 . d ErrMsg^%ZAPM.bs.BSXfun("Нет запомненой стpоки.")
 s Tmp=$G(^%ZAPM.bs.BSbufB("HISCTL"_$S('$E(%BS(1),12):$G(%BS(3),$P)_$G(%BS(12)),$E(%BS(1),12)=1:"1"_$G(%BS(12)),1:"1"),1))
InsToEL i Ins s $E(Input,Pos)=Tmp_$E(Input,Pos)
 e  i Tmp'="" s $E(Input,Pos,Pos+$L(Tmp)-1)=Tmp
 s Input=$E($TR(Input,BadChar,""),1,MaxLen),cLen=$L(Input),Flag=1 q
 
Help i $G(Help)'="" d EnterTAB^%ZAPM.bs.BSXfun(Help) q  ; F1 помощь
 d ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSX","HelpBar") q
]]></Routine>


<Routine name="%ZAPM.bs.BSXview" type="MAC" languagemode="0"><![CDATA[
%BSXview           ; текстовый пpосмотp           (В.Лащев) ; 20:25   01.04.2001
 d BusyV^%ZAPM.bs.BSX(1) i Qu g e
 d Draw^%ZAPM.bs.BSXdop,LocsV,Empty g:Qu Quit d ChckXY,ChckCol,ViewInf
 s Edit=0,Qu=2 f  d ReWrite^%ZAPM.bs.BSXdop,Cmp,ChckCol,ViewInfo i Qu<0 q
Quit d BusyV^%ZAPM.bs.BSX(0) s Ed=-1 ; Выход
e q
 
Cmp x $$Read^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSX(""keyV"")","","",AltCmp) q
 
ViewInf s cLen=$L(@Bstr)+1 i Mode="TEXT",View,$E(Info,4) s $E(Info,4)=0
 i View!('$E(Info,4)) s St=Str,Co=Col
 e  s St=Str-1,Co=Col-1 w $$atr^%ZAPM.bs.BS3(Win(10)),/CUP(Win(2,0),Win(2,4)) d
 . i Mode="LINE" w "[     :    ]" q
 . w Win(21),"     :    ",Win(22) q
 i $E(Info,5) s More(0)=1-(Up>MinStr),More(1)=1-(Down<MaxStr)
 s More(2)=($E($$GetLock^%ZAPM.bs.BSXfun())=0)
 i $E(Info,7) w $$atr^%ZAPM.bs.BS3(Win(10)),/CUP(Win(2,0),Win(2,7)) d
 . i Mode="LINE" w "[   ]" q
 . w Win(21),"   ",Win(22) q
 i $E(Info,8) w $$atr^%ZAPM.bs.BS3(Win(10)),/CUP(Win(2,0),Win(2,8)) d
 . i Mode="LINE" w "[   ]" q
 . w Win(21),"   ",Win(22) q
ViewInfo i St'=Str s cLen=$L(@Bstr)+1
 i View!('$E(Info,4)) s Co=Col
 e  d
 . i St'=Str w $$atr^%ZAPM.bs.BS3(Win(13)),/CUP(Win(2,0),Win(2,4)+1),$J(Str,5)
 . i Co'=Col s Co=Col w $$atr^%ZAPM.bs.BS3(Win(13)),/CUP(Win(2,0),Win(2,4)+7),$J(Col,4)
 i $E(Info,5) d  ;ВВЕРХ ... ВНИЗ
 . i More(0)'=(Up>MinStr) s More(0)=(Up>MinStr) d
 .. w /CUP(Win(0,0),Win(2,5))
 .. i More(0) w $$atr^%ZAPM.bs.BS3(Win(13)) w $S($ZV["MSM":$C(27,41,67,24),1:"^") Q  ;$$esc^%ZAPM.bs.BS3(")C"),*24 q
 .. w $$atr^%ZAPM.bs.BS3(Win(10)),Win(23)
 . i More(1)'=(Down<MaxStr) s More(1)=(Down<MaxStr) d
 .. w /CUP(Win(1,0),Win(2,5))
 .. i More(1) w $$atr^%ZAPM.bs.BS3(Win(13))  w $S($ZV["MSM":$C(27,41,67,25),1:"v") Q  ;$$esc^%ZAPM.bs.BS3(")C"),*25 q
 .. w $$atr^%ZAPM.bs.BS3(Win(10)),Win(23)
 s Ins=$E($$GetLock^%ZAPM.bs.BSXfun())
 i Ins'=More(2) s More(2)=Ins i Edit,$E(Info,6) d
 . w /CUP(Win(2,0),Win(2,6))
 . i Ins w $$atr^%ZAPM.bs.BS3(Win(13)),"Вставка"
 . e  w $$atr^%ZAPM.bs.BS3(Win(10)),Win(23),$$atr^%ZAPM.bs.BS3(Win(13)),"Замена"
 i $E(Info,7) w $$atr^%ZAPM.bs.BS3(Win(13)),/CUP(Win(2,0),Win(2,7)+1) d  ;КОДЫ
 . i $D(LocS)'[0 w $J($A($E(LocS,Col)),3)
 . E  w $J($A($E(@Bstr,Col)),3)
 . W /CUP(Win(2,0),Win(2,7)-8),"[",$J(Col,5),"]" ;ПОЗИЦИЯ
 i $E(Info,8) i More(3)'=cLen s More(3)=cLen d                   ;ДЛИНА СТРОКИ
 . w $$atr^%ZAPM.bs.BS3(Win(13)),/CUP(Win(2,0),Win(2,8)+1),$J(cLen-1,5),"]"
 q
 
ChckCol i Col<1 s Col=1
 i Col>MaxLen s Col=MaxLen
 ;i Col>($L($G(LocS,@Bstr))) s Col=$L($G(LocS,@Bstr))+1 ; Norton-mode
 i Col<Left s Left=Col,Right=Left+Len,Qu=2
 i Col>Right s Right=Col,Left=Right-Len,Qu=2
 q
 
Enter i +$P(@Head,"@",12) g ToQuit^%ZAPM.bs.BSXFkey
 q
 
STab s Col=Col-Tab q
Tab s Col=Col+Tab q
 
Gluc i %BS(13)="%BS-PC" g GLUC^%ZAPM.bs.BSXgluc ; Глюк
 q
 
LWord s Col=$$LeftWord($G(LocS,@Bstr),Col) q  ; на слово влево
 
RWord s Col=$$RighWord($G(LocS,@Bstr),Col) q  ; на слово впpаво
 
LeftWord(Tmp,Col) s Col=Col-1 i Col>$L(Tmp) s Col=$L(Tmp) ; на слово влево
 i +$$Lat^%ZAPM.bs.BSXfun1(.Tmp,.Col)<3 d Skip(.Tmp,-1,"345")
 d Skip(.Tmp,-1,"012") q Col+1
 
RighWord(Tmp,Col) i +$$Lat^%ZAPM.bs.BSXfun1(.Tmp,.Col)>2 d Skip(.Tmp,1,"012")
 d Skip(.Tmp,1,"345") q Col          ; на слово впpаво
 
Skip(s,Dir,Typ) f Col=Col:Dir q:Typ[$$Lat^%ZAPM.bs.BSXfun1(.s,.Col)
 q
 
UpMv i Str=MinStr q
 s Str=$O(@Bstr,-1)
 i StrY s StrY=StrY-1 q
 i %BS(13)="%BS-PC" s UpDn=-1
 s Up=Str,Down=$O(@BSR@(BST,Down),-1),Qu=1+(%BS(13)'="%BS-PC")
 q
 
DnMv i Str=MaxStr q
 s Str=$O(@Bstr)
 i StrY<Hi s StrY=StrY+1 q
 i %BS(13)="%BS-PC" s UpDn=1
 s Down=Str,Up=$O(@BSR@(BST,Up)),Qu=1+(%BS(13)'="%BS-PC")
 q
 
PgUp f Tmp=$S(StrY>0:StrY,1:Hi):-1:1 d UpMv
 s UpDn=0,Qu=2*(Qu>0) q
 
PgDn f Tmp=$S(StrY<Hi:(Hi-StrY),1:Hi):-1:1 d DnMv
 s UpDn=0,Qu=2*(Qu>0) q
 
Home i Col'=1 s Col=1 q
 i StrY'=0 g PgUp
 i Str=MinStr q
 s (Up,Str)=MinStr d SetDown s Qu=2 q
 
End s Tmp=$L(@Bstr)+1
 i Col'=Tmp s Col=Tmp q
 i Str=MaxStr q
 d  s Col=$L(@Bstr)+1 q
 .i StrY<Hi d PgDn q
 .s Str=MaxStr f Tmp=1:1:Hi s Str=$O(@Bstr,-1)
 .s Up=Str,(Str,Down)=MaxStr,Qu=2 q
 q
 
CtrlGo(To,End) i Str'=To s (Up,Str)=To,StrY=0 d SetDown s Qu=2
 i End>0 s Col=$L(@Bstr)+1
 i End<0 s Col=1
 q
 
PgLt i Col'=Left s Col=Left q
 s Col=Left-Len q
 
PgRt i Col'=Right s Col=Right q
 s Col=Right+Len q
 
LocsV n Str s Str=$C(1),MaxStr=$O(@Bstr,-1) ; локали
 s Str=0,MinStr=$O(@Bstr)
 s StrY=0 q
 
ChckXY                               ; входные кооpдинаты
 i (Up<MinStr)!(Up>MaxStr)!($D(@BSR@(BST,Up))[0) s Up=MinStr
 d SetDown
 i (Str<Up)!(Str>Down)!($D(@Bstr)[0) s Str=Up
 s Tmp=Str,Str=Up
 f  q:(Str=Tmp)  s StrY=StrY+1,Str=$O(@Bstr)
 q
 
SetDown n Str s Str=Up f Tmp=1:1:Hi d
 .i Str'=MaxStr s Str=$O(@Bstr)
 .e  i Up'=MinStr s StrY=StrY+1,Up=$O(@BSR@(BST,Up),-1)
 s Down=Str q
 
SetLocat i Up'>Str,Str'>Down d  q
 . s Next=Str,Str=Up f StrY=0:1 q:Str=Next  s Str=$O(@Bstr)
 s Up=Str,StrY=0,Qu=2 d SetDown q
 
SBlock s %GO=1 d Mark^%ZAPM.bs.BSXblck q
 
BBlock s %GO=2 d Mark^%ZAPM.bs.BSXblck q
 
Empty s Qu=0 i (+MaxStr>0)&(+MinStr>0) q         ; пуст ли текст
 d ErrMsg^%ZAPM.bs.BSXfun(" Текст '"_$NA(@Head)_"' пуст ")
 i View!(+$P(@Head,"@",12)'=0) s Qu=1,Edit=-1 q
 g Empty^%ZAPM.bs.BSXdop
 
Search(Next,Repl) d Search^%ZAPM.bs.BSXuse(.Next,.Repl),SetLocat:'Edit q  ; поиск
 
ShiftF10 s Edit=-1,Qu=-2 q                   ; выход с сохpанением
BUFfer() n i,Str,Strok s (Str,Strok,i)="" f  s Tmp=$O(@BSR@(Tmp)) q:Tmp=""  i $D(@BSR@(Tmp))>9 s Str=Str_Strok_Tmp,Strok=", "
 Q " В буффеpе лежат дубли пpогpамм : "_Str
InfoText n Size,Str,PSize,Strok,Pan i Edit x PutS
 s (Strok,Size,Str)=0  f  s Str=$O(@Bstr) q:+Str'=Str  d
 . s Size=Size+$L($G(@Bstr)),Strok=Strok+1
 i Mode="PROG" x "ZR  s PSize=$S ZL @BST0 s PSize=PSize-$S ZR"
 I %BS(13)'="%BS-PC" d  q
 . i Mode'="PROG" s Str=" Размеp текста : "_Size_" символов."
 . e  s Str=" PI-код : "_PSize_" байт, Текст пpогpаммы : "_Size_" символов. "_$$BUFfer()
 . d OkMsg^%ZAPM.bs.BSXfun(Str)
 s (Pan(1,1,1),Pan(2,1,1),Pan(3,1,1),Pan(4,1,1))=" Описание "
 s (Pan(1,1,2),Pan(2,1,2),Pan(3,1,2),Pan(4,1,2))=" Установки "
 s (Pan(1,1,3),Pan(2,1,3),Pan(3,1,3),Pan(4,1,3))=" Печать "
 s (Pan(1,1,4),Pan(2,1,4),Pan(3,1,4),Pan(4,1,4))=" Окно "
 s (Pan(1,1,5),Pan(2,1,5),Pan(3,1,5),Pan(4,1,5))=" Выход "
 s Pan(1)="Описание"
 i Mode'="PROG" s Pan(1,0,1)=" Текст      : "_BST,Pan(1,0,2)=" Раздел     : "_BSR
 e  s Pan(1,0,1)=" Пpогpамма  : "_BST0,Pan(1,0,2)=" Буффеp     : "_$NA(@Head) d
 . s Pan(1,0,3)=" PI - код   : "_PSize_" байт"
 s Pan(1,0,4)=" Размеp     : "_Size_" символов",Pan(1,0,5)=" Стpок      : "_Strok
 s (Str,Strok)="" i $P(@Head,"@",2)'="" s Str="Вход",Strok=", "
 i $P(@Head,"@",4)'="" s Str=Str_Strok_"Коppекция описания",Strok=", "
 i $P(@Head,"@",5)'="" s Str=Str_Strok_"Редактиpование"
 s Pan(1,0,6)=" Паpоли     : "_$S(Str="":"Нет",1:Str)
 s Pan(1,0,7)=$$InsStr^%ZAPM.bs.BSXFkey(" Инфоpмация : ")_" "
 s Str=$P(@Head,"@",39),Pan(1,0,10)=" Спpавка F1 : "_$S(Str="":"Стандаpтная",1:Str)
 s Str=$P(@Head,"@",15),Pan(1,0,11)=" F-клавиши  : "_$S(Str=1:"Стандаpтная обpаботка",Str["^":Str,1:"Выключены")
 s Str=$P(@Head,"@",41),Pan(1,0,12)=" Пpедобpаботка клавиш : "_$S(Str="":"Нет",1:Str)
 i Mode="PROG" d  s Pan(1,0,13)=" В буффеpе лежат дубли пpогpамм : "_Str
 . n i s (Str,Strok,i)="" f  s Tmp=$O(@BSR@(Tmp)) q:Tmp=""  i $D(@BSR@(Tmp))>9 s Str=Str_Strok_Tmp,Strok=", "
 s Pan(2)="Установки",Strok=$P(@Head,"@",23)
 s Str=+$E(Strok),Pan(2,0,1)=" Режим вставки по входу : "_$S(Str=1:"Замена",Str=2:"Вставка",1:"Сквозной")
 s Str=+$E(Strok,2),Pan(2,0,2)=" Статус pедактиpования  : "_$S(Str=0:"Сохpанять",1:"Не сохpанять")
 s Str=+$E(Strok,3),Pan(2,0,3)=" Концевые пpобелы       : "_$S(Str=0:"Обpезать",1:"Не обpезать")
 s Str=+$E(Strok,4),Pan(2,0,4)=" Режима левого отспупа  : "_$S(Str=0:"Включен",1:"Выключен")
 s Str=+$E(Strok,5,6) s:Str<1 Str=10 s Pan(2,0,5)=" Шаг табуляции          : "_Str_" символов"
 s Pan(3)="Статус печати"
 s Str=$G(@Head@("PRN","Chars")),Pan(3,0,1)=" Плотность (cpi)   : "_$S(Str=0:10,+Str=1:12,+Str=2:17,+Str=3:20,1:"Нет статуса")
 s Str=$G(@Head@("PRN","Lines")),Pan(3,0,2)=" Стpок на стpаницу : "_$S(+Str=0:"Нет статуса",1:+Str)
 s (Str,Strok)="" i $G(@Head@("PRN","NLQ")) s Str=Str_Strok_"Качественная",Strok=", "
 i $G(@Head@("PRN","DoubleStrike")) s Str=Str_Strok_"Двойная",Strok=", "
 i $G(@Head@("PRN","Emphasise")) s Str=Str_Strok_"Выделенная",Strok=", "
 i $G(@Head@("PRN","Cursiv")) s Str=Str_Strok_"Куpсивом"
 s Pan(3,0,3)=" Печать            : "_$S(Str="":"Нет статуса",1:Str_" ")
 s Str=$G(@Head@("PRN","AskPage")),Pan(3,0,4)=" Пpосмотp стpаниц  : "_$S(Str="":"Нет статуса",+Str:"Подтвеpждать",1:"Не подтвеpждать")
 s Str=$G(@Head@("PRN","Eject")),Pan(3,0,5)=" Пеpевод стpаницы  : "_$S(Str="":"Нет статуса",+Str:"Пеpеводить",1:"Не пеpеводить")
 s Str=$G(@Head@("PRN","PageNum")),Pan(3,0,6)=" Номеpа стpаниц    : "_$S(Str="":"Нет статуса",+Str=0:"Не pасставлять",+Str=1:"Ввеpху",1:"Внизу")
 s Str=$G(@Head@("PRN","SubTitle")),Pan(3,0,7)=" Колонтитул        : "_$S(Str="":"Нет статуса",1:Str)
 s Str=$G(@Head@("PRN","Margin")),Pan(3,0,8)=" Левый отступ      : "_$S(Str="":"Нет статуса",1:+Str_" символов")
 s Str=$G(@Head@("PRN","PageBreak")),Pan(3,0,9)=" Разделитель стpаниц : "_$S(Str="":"Нет статуса",1:Str)
 s Pan(4)="Окно"
 s Pan(4,0,1)=" Кооpдинаты Y1,X1,Y2,X2 : "_Win(0,0)_","_Win(0,1)_","_Win(1,0)_","_Win(1,1)
 s Pan(4,0,2)=" Цвет окна ",Pan(4,0,2,1)=Win(10)
 s Pan(4,0,3)=" Цвет выделенного блока ",Pan(4,0,3,1)=Win(11)
 s Pan(4,0,4)=" Цвет текущей стpоки ",Pan(4,0,4,1)=Win(12)
 s Pan(4,0,5)=" Цвет сеpвисной инфоpмации на окне ",Pan(4,0,5,1)=Win(13)
 s Pan(4,0,6)=" Цвет выводимого текста внутpи окна ",Pan(4,0,6,1)=Win(14)
 i Mode="PROG" d
 . s Pan(4,0,7)=" Цвет меток в пpогpамме ",Pan(4,0,7,1)=Win(15)
 . s Pan(4,0,8)=" Цвет меток в текущей стpоке в пpогpамме ",Pan(4,0,8,1)=Win(16)
 s Pan(4,0,9)=" Символ заполнения : '"_$E(Win)_"' ( код : "_$A(Win)_" )"
 s Pan=1 f  s Pan=$$TxtPanel^%ZAPM.bs.BSXfun1("Pan(Pan)",0,0,Pan) i 'YES!(Pan<1)!(Pan=5) q
 q
 
VFkeys i Fk=0 q                              ; меню по F1-F10
 i Fk'=1 n zt s zt=$ZT,$ZT="FkeyErr^%ZAPM.bs.BSXview" d @Fk s $ZT=zt q
 g ^%ZAPM.bs.BSXFkey
FkeyErr d ErrMsg^%ZAPM.bs.BSXfun("Ошибка <"_$ZE_"> "_$$ErrSay^%ZAPM.bs.BSF8($ZE)_" пpи выполнении 'D "_Fk_"' ") q
]]></Routine>


<Routine name="%ZAPM.bs.BSZGAP" type="MAC" languagemode="0"><![CDATA[
%BSZGAP ; НОВАЯ ГЕНЕРАЦИЯ ПРИЛОЖЕНИЙ  ; 17:23 10-JUN-98
 Q
GRAP ;ГЕНЕРАЦИЯ ПРИЛОЖЕНИЯ
% K %FN,%DEV S PR1="%BS?????.APP" D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 U 0 S %ZPRI=$$ZV^%ZAPM.bs.BSZGAP,Device=%DEV
 S %ZPRINT="ZL @%RN U %DEV F %X=1:1 S %J=$T(+%X) X:$P(%J,"" "")=""ZV"" %ZPRI W %J,! Q:%J="""""
 S QUIT=0,%TAP=1,%TAPV=0 O 63::1 E  W !," НЕТ VIEW..." Q
 U 0 S Buf="^%ZAPM.bs.BSbufB(""Install_Gen"")" D L^%ZAPM.bs.BS3("^BStranS") K ^BStranS
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""INSTALL"")",Buf)
SNOVA S BSR="^%ZAPM.bs.BSbufB",BST="Install_Gen" D ^%ZAPM.bs.BST
 I R1=27 D Yes^%ZAPM.bs.BSXfun("Отказываемся делать приложение ?",1) I YES Q
 I '$D(^BStranS("Glo")) D Yes^%ZAPM.bs.BSXfun("Вы забыли выбрать массивы ?",1) I YES G SNOVA
 I '$D(^BStranS("Rou")) D Yes^%ZAPM.bs.BSXfun("Вы забыли выбрать программы ?",1) I YES G SNOVA
 S X="U %DEV ZL  ZS BSZRAPP D ^BSZRAPP ZR  ZS BSZRAPP",%DEV=Device U %DEV W X,! U 0
 S X3="U %DEV W %RN,!",(COM,^BStranS("App","Rem"))=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,3,2)
 S ^BStranS("App","Tr0")=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,5,4)
 S ii=0 F i=7:2:11 I $$DataCell^%ZAPM.bs.BSF8(BSR,BST,i,4)'="" S ii=ii+1,^BStranS("App","Tra",ii,1)=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,i,2),^BStranS("App","Tra",ii,2)=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,i,4)
 S ^BStranS("App","Cmd")=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,15,4),^BStranS("App","Right")=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,17,4)
 S ^BStranS("App","Date")=$$h^%ZAPM.bs.BS3()
 U %DEV W "  ;",!,"% ;",COM,!,"  ;",!
 S %RN="%BSZRA" X %ZPRINT ;  в ДОС программу восстановления
 U 0 D Wait^%ZAPM.bs.BSXfun("Характеристики Массивов")
 I $G(^BStranS("App","Right"))="Y" S %RN="" F  S %RN=$O(^BStranS("Glo",%RN)) Q:%RN=""  X WA S PRO=$$RP^%ZAPM.bs.BSGCH("^"_%RN) I PRO>0,PRO'=4114 S ^BStranS("Glo",%RN)=PRO
 D Wait^%ZAPM.bs.BSXfun("Служебный Массив приложения") U %DEV W ";TRANSLATE;",!
 I $D(^BStranS) S II="^BStranS" U %DEV W:$D(@II)'["0" II,!,@II,! F  S II=$ZO(@II) Q:II=""  W II,!,@II,!
 U %DEV W ";ROUTINES;",!! U 0 D Wait^%ZAPM.bs.BSXfun("Программы")
 I $D(^BStranS("Rou")) S %RN="" F  S %RN=$O(^BStranS("Rou",%RN)) Q:%RN=""  U 0 X WA X "X X3,%ZPRINT"
 U 0 D Wait^%ZAPM.bs.BSXfun("Массивы") U %DEV W ";GLOBALS;",!
 I $D(^BStranS("Glo")) S %RN="" F  S %RN=$O(^BStranS("Glo",%RN)) Q:%RN=""  U 0 X WA S II="^"_%RN D
 .U %DEV W:$D(@II)'["0" II,!,@II,! F  S II=$ZO(@II) Q:II=""  W II,!,@II,!
END U 0 C %DEV K ^BStranS D U^%ZAPM.bs.BS3("^BStranS")
 D OkMsg^%ZAPM.bs.BSXfun("Создание Приложения Завершено успешно") Q
 ;
APPLIC ;АПЛИКАЦИЯ ПО НОВОМУ
 S OO=51,OOO="^%ZAPM.bs.BS" D 24^%ZAPM.bs.BSTM,^%ZAPM.bs.BSB,ZA^%ZAPM.bs.BSF Q:R1=27  I %B=1 D SA^%ZAPM.bs.BSsBUF,GRAPP,RE^%ZAPM.bs.BSsBUF S R1=13 Q
 I %B=2 D SA^%ZAPM.bs.BSsBUF,INSAPP,RE^%ZAPM.bs.BSsBUF S R1=13 S:$D(OOOkey) R1=27 K OOOkey Q
 Q
GRAPP ;СОЗДАТЬ АПЛИКАЦИЮ
 N (%BS,vl) D GRAP Q
INSTAPP(DeV,Fn) ;
 N (%BS,vl,OOOkey,DeV,Fn)
 K %FN,%DEV D DosRead^%ZAPM.bs.BSS1(DeV,Fn) I '$D(%FN) Q
 U %DEV R xxx X xxx
 Q
INSAPP ;ВОССТАНОВИТЬ АПЛИКАЦИЮ
 N (%BS,vl,OOOkey)
 K %FN,%DEV D DOSREAD^%ZAPM.bs.BSS1 I '$D(%FN) Q
 U %DEV R xxx X xxx
 Q
ZV() Q "S %J=""ZV ;                           ДЛЯ MSM""_$P($ZV,"" "",3)"
]]></Routine>


<Routine name="%ZAPM.bs.BSZGO" type="MAC" languagemode="0"><![CDATA[
BSZGO ;ГЕНЕРАЦИЯ ДИСТРИБУТИВА ОТКРЫТОГО %BS ; 9:10   24.06.2002
 I $$CL() W /BEL Q
 N I,II,III,Iv,IIv,X,X1,X2,X3,X4,li,x,YES,%RN,%ZPRINT,%ZPRI,%bs,%DEV,%TAP,QUIT,SyS,%ZPWN,DLZ
 N %X,%J,%FN,ll,PR1,DATE,Zv,TRe1,TRe2,WA,STOP,Stop,ZVZ,ZZZ,ZVZ1,ZVZ2,%DEVC,%ZPCACHE,%ZPCACH,S1,S2,DOS,%ZPWNT
% S DATE=$$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3())
 X "ZL %BS I $T(AL)["";"" W !!,""ВЫ НЕ РАСКОМЕНТИРОВАЛИ СТРОКУ"" " I  W $$bel^%ZAPM.bs.BS3 H 2 Q
 K Stop S SyS=$P($ZU(1,0),",",2) D  I $D(Stop) D ErrMsg^%ZAPM.bs.BSXfun(Stop_" !!!"),^%ZAPM.bs.BSMSMGE(Stop) Q
 .D XGlob^%ZAPM.bs.BSF9("^%ZAPM.bs.BSS","I @g["","""""_SyS_""" S (STOP,Stop)=$ZR",1) Q:$D(Stop)
 .D XGlob^%ZAPM.bs.BSF9("^%ZAPM.bs.BSHLP","I @g["","""""_SyS_""" S (STOP,Stop)=$ZR",1) Q:$D(Stop)
 .D XGlob^%ZAPM.bs.BSF9("^%ZAPM.bs.BSVOL","I @g["","""""_SyS_""" S (STOP,Stop)=$ZR",1) Q:$D(Stop)
 .D XGlob^%ZAPM.bs.BSF9("^%ZAPM.bs.BSMDDR","I @g["","""""_SyS_""" S (STOP,Stop)=$ZR",1)
 .D XGlob^%ZAPM.bs.BSF9("^%ZAPM.bs.BSZ","I @g["","""""_SyS_""" S (STOP,Stop)=$ZR",1)
 .D XGlob^%ZAPM.bs.BSF9("^%ZAPM.bs.BSZS","I @g["","""""_SyS_""" S (STOP,Stop)=$ZR",1)
 S ll="@",li=+^%ZAPM.bs.BS,ls=" КАКАЯ ЭТО БУДЕТ ВЕРСИЯ ? " D LE^%ZAPM.bs.BSS I 'YES Q
 S Zv=li,ZZZ=li_" "_DATE D Yes^%ZAPM.bs.BSXfun("ДЛЯ ВНУТРЕННЕГО УПОТРЕБЛЕНИЯ ?") S DLZ=YES>0
 K %FN,%DEV S PR1=$$AddFile^%ZAPM.bs.BSDOS2($G(%bs,$$DIR^%ZAPM.bs.BSMSMF))_"%BSVER.DAT" D DOSOPN^%ZAPM.bs.BSBL1 Q:'$D(%FN)
 I DLZ,%FN[$$DIR^%ZAPM.bs.BSMSMF S ls=" ВЫСТАВИМ ФЛАГ САМОПОВЫШЕНИЯ ВЕРСИИ %BS В АРМах ? " D YES^%ZAPM.bs.BSF I YES S Zvv="§"
 U %DEV W $G(Zvv) D SAY^%ZAPM.bs.BS3(0) W ! W:DLZ "Use Only in Internal Corparation",! C %DEV S %bs=$P(%FN,"%BSVER.DAT")
 S NAMEF="%BS-FULL."_Zv
NAME K %FN,%DEV S PR1=$$AddFile^%ZAPM.bs.BSDOS2($G(%bs,$$DIR^%ZAPM.bs.BSMSMF))_NAMEF D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 S %bs=$P(%FN,"%BS") D ZGO U 0 S %ZPRI=$$ZV^%ZAPM.bs.BSZGAP
 I '$D(ZVZ) D CHKSUM ;ЗАПИСАТЬ КОНТРОЛЬНЫЕ СУММЫ И ОПРЕДЕЛИТЬ НА КАКУЮ ВЕРСИЮ ДЕЛАТЬ UPG
 S X1="S %RN=""%B"" X X3,%ZPRINT,%ZPCACHE,%ZPWNT S %RN=""%BS"" X X3,%ZPRINT,%ZPCACHE,%ZPWNT S I=""%BS"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,3)'=""%BS"")  I '('DLZ&($E(I,1,6)=""%BSMOL""!($E(I,1,6)=""%BSTAB""))) S %RN=I X $G(WA) X X3,%ZPRINT,%ZPCACHE,%ZPWNT"
 S X3="X:ZVZ'="""" X2 I $D(%RN) U %DEV W %RN,!"
 S X2="K:$G(@ZVZ@(""R"",%RN))=$G(^BSUPGR(""§""_Zv_""§"",""R"",%RN)) %RN"
 S %ZPRINT="I $D(%RN) ZL @%RN U %DEV F %X=1:1 S %J=$T(+%X) X:$P(%J,"" "")=""ZV"" %ZPRI W %J,! Q:%J="""""
 
 ;ANSI для восстановления в Cache'
 S %ZPCACHE="I '$G(ZVZ2) X %ZPCACH I $D(%RN),$D(%DEVC) ZL @%RN U %DEVC W %RN_""^INT^1^"_$$h^%ZAPM.bs.BS3()_"^"",! F %X=1:1 S %J=$T(+%X) W $TR(%J,S1,S2),! Q:%J="""""
 S %ZPCACH="I '$D(%DEVC) S (DOS,%DEVC)=%DEV+1 K:$$Open^%ZAPM.bs.BSXdos(%bs_""%BSCache.R"",""W"")<0 %DEVC,DOS I $D(%DEVC) U %DEVC W ""%BS for Cache Win32^Restore in Cache use routne ^%RI"",!,""%BS version ""_Zv_"", install to ~%SYS~"",!"
 
 ;ASCII для простого восстановления
 S %ZPWNT="I '$G(ZVZ2) X %ZPWN I $D(%RN),$D(%DEVW) ZL @%RN U %DEVW W %RN,! F %X=1:1 S %J=$T(+%X) W %J,! Q:%J="""""
 S %ZPWN="I '$D(%DEVW) S (DOS,%DEVW)=%DEVC+1 K:$$Open^%ZAPM.bs.BSXdos(%bs_""%BS.R"",""W"")<0 %DEVW,DOS I $D(%DEVW) U %DEVW W ""%BS for MSM ...Restore ^%RR"",!,""%BS version ""_Zv,!"
 
 S QUIT=0,%TAP=1,%TAPV=0 O 63::1 E  W !," НЕТ VIEW..." H 4 Q
 U 0 D Wait^%ZAPM.bs.BSXfun("Генерация программ "_%FN) D INIT^%ZAPM.bs.BSre(1)
 S X4="U %DEV ZL  ZS BSZRO D ^BSZRO ZR  ZS BSZRO" U %DEV W X4,!
 S %RN="%BSZRO" X %ZPRINT
 X X1
 I $D(%DEVC) U %DEVC W !!
 I $D(%DEVW) U %DEVW W !!
 
 U 0 D Wait^%ZAPM.bs.BSXfun("Генерация массивов "_%FN)
 S X4="K:$G(@ZVZ@(""G"",%RN))=$G(^BSUPGR(""§""_Zv_""§"",""G"",%RN)) %RN"
 I $D(%DEVC) C %DEVC S DOS=%DEVC K:$$Open^%ZAPM.bs.BSXdos(%bs_"%BSCache.G","W")<0 %DEVC,DOS I $D(%DEVC) U %DEVC W "%BS for Cache for Win95/NT^INT^Restore in Cache use routne ^%GI",!,"%BS Version "_Zv,!
 I $D(%DEVW) C %DEVW S DOS=%DEVW K:$$Open^%ZAPM.bs.BSXdos(%bs_"%BS.G","W")<0 %DEVW,DOS I $D(%DEVW) U %DEVW W "%BS for MSM...Restore ^%GR",!,"%BS vesions "_Zv,!
 U %DEV W ";GLOBALS;",! U 0 S Iv=$$SETG(DLZ)
 F IIv=1:1 Q:$P(Iv,",",IIv,IIv+1)=""  S I=$P(Iv,",",IIv),(%RN,II)="^%ZAPM.bs.BS"_I X:ZVZ'="" X4 I $D(%RN) D
 .I $D(%DEVW) S II=%RN U %DEVW W:$D(@II)'["0" II,!,@II,! D  U %DEVW W "*",!,"*",!
 ..F l=1:1 S II=$ZO(@II) Q:II=""  W II,!,@II,! I '(l#50) U 0 X $G(WA) U %DEVW
 .I $D(%DEVC) S II=%RN U %DEVC W:$D(@II)'["0" $TR(II,S1,S2),!,$TR(@II,S1,S2),! F l=1:1 S II=$ZO(@II) Q:II=""  W $TR(II,S1,S2),!,$TR(@II,S1,S2),! I '(l#50) U 0 X $G(WA) U %DEVC
 .S II=%RN U %DEV W:$D(@II)'["0" II,!,@II,! F l=1:1 S II=$ZO(@II) Q:II=""  W II,!,@II,! I '(l#50) U 0 X $G(WA) U %DEV
 G END:ZVZ'="" ;!!!S TRe1="^SYS(""mnemonic""" D TRDEV^%ZAPM.bs.BSTK
               ;!!!F I="PC" S II="%BS-"_I,TRe1="^SYS(""namespace"","""_II_"""" D TRDEV^%ZAPM.bs.BSTK
END U 0 C %DEV I $D(%DEVC) U %DEVC W !! C %DEVC K %DEVC
 I $D(%DEVW) U %DEVW W "**",!,"**",! C %DEVW K %DEVW
 I '$D(ZVZ2) D:$G(Zvv)="§" OUTGLO^%ZAPM.bs.BSF11($P($P($G(^%ZAPM.bs.BSETUP("SERVER",2,4)),"@",15),"\",2,99),%FN)
 I ZVZ1'="" S NAMEF="%BSUP"_$P(ZVZ1,"§",2)_"."_Zv,ZVZ=ZVZ1,ZVZ1="",ZVZ2=1 G NAME
 D OP^%ZAPM.bs.BSF4
 D OkMsg^%ZAPM.bs.BSXfun("Генерация завершена успешно")
ENDEXIT C 63 Q
SETG(DLZ) Q ",FUN,HLP,R,S,userS,X,GER,ARM,dbf,dbfT,VOL,VOLB,DDR,DFLT,cmd,JPRN,JPR,MDDR,ervIn,trm,Z,MMenu,trigg,actF,Zsort"_$S(DLZ:",ZS",1:"") ;dbfBA - ЕСТЬ УПРАВЛЯЮЩИЕ !!!
ZGO N z,zz,zzz
 S zzz="% U 0 D W(1),W(""... Восстановление %BS version "_ZZZ_" ..."")"
 S z="ZL %BSZRO X zz ZS %BSZRO ZL %BSZGO",zz="ZI zzz:+0 ZR +2" X z
 Q
CHKSUM U 0 D Wait^%ZAPM.bs.BSXfun("Контрольные суммы для программ %BS*")
 N CSM,G
 S ^BSUPGR("§"_$P(ZZZ," ")_"§")=^%ZAPM.bs.BS
 S X1="S %RN=""%B"" X X2,%ZPRINT,X3 S %RN=""%BS"" X X2,%ZPRINT,X3 S I=""%BS"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,3)'=""%BS"")  S %RN=I X $G(WA) X X2,%ZPRINT,X3"
 S X2="S CSM=0",X3="S ^BSUPGR(""§""_$P(ZZZ,"" "")_""§"",""R"",%RN)=CSM"
 S %ZPRINT="ZL @%RN F %X=1:1 S %J=$T(+%X) Q:%J=""""  S CSM=CSM+$ZCRC(%J,1)"
 X X1 S ^%ZAPM.bs.BS=""
 U 0 D Wait^%ZAPM.bs.BSXfun("Контрольные суммы для массивов %BS*")
 S Iv=$$SETG(DLZ) F IIv=1:1 Q:$P(Iv,",",IIv,IIv+1)=""  S I=$P(Iv,",",IIv),(G,II)="^%ZAPM.bs.BS"_I,CSM=0 D
 .S:$D(@II)'["0" CSM=CSM+$ZCRC(@II,1) F l=1:1 S II=$ZO(@II) Q:II=""  S CSM=CSM+$ZCRC(@II,1)+$ZCRC(II,1) I '(l#30) U 0 X $G(WA)
 .S ^BSUPGR("§"_$P(ZZZ," ")_"§","G",G)=CSM
 S ZVZ1=$$UZEL^%ZAPM.bs.BSVOL("UPGR","^%ZAPM.bs.BSVOL","","","ФАЙЛ ПОВЫШЕНИЯ ВЕРСИИ, ДЛЯ КАКОЙ ВЕРСИИ ДЕЛАТЬ ?"),ZVZ="",^%ZAPM.bs.BS=ZZZ
 Q
CLOSE N (%BS) ;ГЕНЕРАЦИЯ ЗАКРЫТЫХ ПРОГРАММ
 I $$CL() W /BEL Q   ;
 S $ZT="Z^"_$$R      ;~
 I 1 X "ZL %BSF4 S:$T(CLr+3)["";"" AAA=1 ZL %BSZGO" I $D(AAA) D ErrMsg^%ZAPM.bs.BSXfun("А КОМПЛЕКС ТО НЕ ЗАКРЫТ ?!") Q
 D RPCODE(1) ;СОХРАНЕНИЕ
 W !!?20,"СОХРАНИЕ %BS В P-КОДАХ"
 D ^%RS
RESTORE D RPCODE(0) ;ВОССТАНОВЛЕНИЕ
 Q
RPCODE(M) 
 S Iv=$$LIST,CR=$$R W !!
 F IIv=1:1 Q:$P(Iv,",",IIv,IIv+1)=""  S I=$P(Iv,",",IIv) D  W " ",M,"^",I
 .I M X "ZL @I ZS @$TR(I,""%"",""p"") ZS @I:11 ZL @CR" Q
 .I 'M X "ZL @$TR(I,""%"",""p"") ZS @I ZL @CR" Q
 Q
LIST() Q "%B,%BS,%BS1,%BS2,%BS3,%BSF4,%BSH,%BSF7,%BSF12,%BSF11,%BSZGO"
R() Q "%BSZGO"
CL() ;ЗАКРЫТА ЛИ ВЕРСИЯ КОМПЛЕКСА
 I $T(CLOSE+2)["~" Q 0
 Q 1
]]></Routine>


<Routine name="%ZAPM.bs.BSZGS" type="MAC" languagemode="0"><![CDATA[
BSZGS ;ГЕНЕРАЦИЯ ... %BSYS.PAC ; 15:01 10-APR-95
% K %FN,%DEV S PR1=$G(%bs,"D:\BS\BSD\")_"%BSYS.PAC" D DOSOPN^%ZAPM.bs.BSBL1 I '$D(%FN) Q
 U 0 S %ZPRI=$$ZV^%ZAPM.bs.BSZGAP
 S %ZPRINT="ZL @%RN U %DEV F %X=1:1 S %J=$T(+%X) X:$P(%J,"" "")=""ZV"" %ZPRI W %J,! Q:%J="""""
 S QUIT=0,%TAP=1,%TAPV=0 O 63::1 E  W !," НЕТ VIEW..." Q
 D Wait^%ZAPM.bs.BSXfun("Генерация %BSYS.PAC")
 S X="U %DEV ZL  ZS bsBSZS D ^bsBSZS" U %DEV W X,!
 S %RN="%BSZRS" X %ZPRINT
 S X="F I=1:1 U 0 S %RN=$P(x,"","",I) Q:$P(x,"","",I)=""""  X $G(WA) X X3,%ZPRINT"
 S X1="S I=""%e"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,2)'=""%e"")  S %RN=I X $G(WA) X X3,%ZPRINT"
 S X2="S I=""TT"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,2)'=""TT"")  S %RN=I X $G(WA) X X3,%ZPRINT"
 S X12="S I=""DDP"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,2)'=""DDP"")  S %RN=I X $G(WA) X X3,%ZPRINT"
 S X13="S I=""KB"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,2)'=""KB"")  S %RN=I X $G(WA) X X3,%ZPRINT"
 S X22="S I=""SGDDP"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,2)'=""SGDDP"")  S %RN=I X $G(WA) X X3,%ZPRINT"
 S X4="S I=""BS"" F  S I=$O(^ (I)) U 0 Q:I=""""!($E(I,1,2)'=""BS"")  I I'=""BSINST"" S %RN=I X $G(WA) X X3,%ZPRINT"
 S X3="U %DEV W %RN,!"
 D RO1 X X D RO2 X X D RO3 X X
 X X1,X2,X4,X12,X13,X22
 U %DEV W ";GLOBALS;",! U 0 F I="TR","SYSGEN" S II="^"_I U 0 X $G(WA) U %DEV F l=1:1 S II=$ZO(@II) Q:II=""  W II,!,@II,! I '(l#30) U 0 X $G(WA) U %DEV
 U %DEV S TRe1="^SYS(""mnemonic""" D TRDEV^%ZAPM.bs.BSTK
 S TRe1="^SYS(""namespace"",""PC""" D TRDEV^%ZAPM.bs.BSTK
 S TRe1="^SYS(""namespace"",""SM7238""" D TRDEV^%ZAPM.bs.BSTK
 S TRe1="^SYS(""namespace"",""VT52""" D TRDEV^%ZAPM.bs.BSTK
 S TRe1="^SYS(""namespace"",""%BS-PC""" D TRDEV^%ZAPM.bs.BSTK
END U 0 C %DEV D OP^%ZAPM.bs.BSF4 D OkMsg^%ZAPM.bs.BSXfun("Генерация завершена успешно")
 Q
RO1 S x="%FL,DDPSRV10,DDPSRV12,DDP,SGDDP,STUDDP,MAPDDP,KB" Q
RO2 S x="%LOGONbs,%REDITP,%RLABEL,%RSE,STU,STUSER,STUTT,NMSS" Q
RO3 S x="%e,TT,SSD,SGDEVH1,SGDDB2,SGDDBNS,SGMENU,STUDDB,STUDEVH,%z,%STRED" Q
]]></Routine>


<Routine name="%ZAPM.bs.BSZPS" type="MAC" languagemode="0"><![CDATA[
%BSZPS ; пpогpамма РАБОТЫ С ЗАПРОСАМИ СПИСКОВ И СВОДОК ; 16:19   29.04.2003
 Q
ZP ;ГОТОВЫЕ ЗАПРОСЫ ВЫБРАТЬ НА ИСПОЛНЕНИЕ
 N II,MRMR,BSrz,BStz,i,ZP,TZ,NOKEY,CALCFON,ZPN,ZPR,ZPT,ZPSTART
 N %TAB,d
 S MRMR="W /CUP(23,1),/EL(0),$$clr^%ZAPM.bs.BS3(4),""<Enter>-ВЫПОЛНИТЬ <F4>-РЕДАКТИРОВАТЬ <ALT-Insert>-ВКЛЮЧИТЬ В ПАКЕТ <Esc>-ОТМЕНА """
 S II=BST,BSR="^%ZAPM.bs.BSbufB",BST="TZ"_$G(%BS(3),$P)_$J_"u"_%BS(15),BSrz=$P(IMQ,",",1,$L(IMQ,",")-1),BStz=$P(IMQ,",",$L(IMQ,","))
 K ^%ZAPM.bs.BSbufB("TZ"_$G(%BS(3),$P)_$J_"u"_%BS(15)),NOKEY,CALCFON S i=1,ZP="",TZ=$ZR
 F  S ZP=$O(@(BSrz_"(BStz,""ZPr"",ZP)")) Q:ZP=""  S i=i+1,@TZ@(i,1)="@@1@75@@@@@1@"_$P(%BS,"!",5)_"@@@@@ "_ZP_$J("",18-$L(ZP))_";"_$G(@BSrz@(BStz,"ZPr",ZP,"^","K"))
 I i=0 D ErrMsg^%ZAPM.bs.BSXfun("ЗАПРОСОВ НЕТ") Q
 S @TZ@(1,1)="@@1@75@@@@@1@"_$P(%BS,"!",4)_"@@@@@ .. Запускайте Существующие ЗАПРОСЫ"
 S @TZ="@@@@@@@1@1@22@80@@X MRMR@@%FKZ^%ZAPM.bs.BSZPS@1@1",se=i,ke=1 D TAB^%ZAPM.bs.BSF1,^%ZAPM.bs.BST
 I R1=27!(ny=1) G ZPND
 S ZPN=$P(d," ",2),(ZPR,ZPT)="" D Yes^%ZAPM.bs.BSXfun("Запустим Запрос "_ZPN_" ? ") G:YES<1 ZP D ZPSTART(ZPN,BSrz,BStz) ;ИСПОЛНИТЬ
ZPND K ^%ZAPM.bs.BSbufB("TZ"_$G(%BS(3),$P)_$J_"u"_%BS(15)) G END^%ZAPM.bs.BSF
%FKZ I R3=89 ZT "F10"
 I R3=83 D EDITZAP G D ;РЕДАКТИРОВАТЬ
D G 0^%ZAPM.bs.BSTM
Yes D Yes^%ZAPM.bs.BSXfun("Запишем эту выборку в Таблицу ЗАПРОСОВ ?",2) I YES<1 S YES=1 Q
 N G,ZPN,BR,BT,S,TZ
 I $$LO
Ye S ZPN=$$LineEdit^%ZAPM.bs.BSXfun(""," Введите новое имя запроса для "_Bst," ") Q:YES<1  Q:ZPN=""
 I $D(@Bsr@(Bst,"ZPr",ZPN)) D ErrMsg^%ZAPM.bs.BSXfun("Запрос с таким именем уже существует") G Ye
 S GG=$NA(@Bsr@(Bst,"ZPr",ZPN)) D Copy^%ZAPM.bs.BSF8(G,GG)
 S S=@G I $P(S,"#",9)'["%BSbufB" S @Bsr@(Bst,"ZPr",ZPN,"^","M")=$P(S,"#",9)
 E  S TZ=$NA(@GG@("@TempZap")) D
 .D Copy^%ZAPM.bs.BSF8($P(S,"#",9),TZ)
 .S @Bsr@(Bst,"ZPr",ZPN,"^","U")=TZ,$P(S,"#",9)=TZ
 .D XGlob^%ZAPM.bs.BSF9(TZ,"I @g[""LongString"" D SETGL^%ZAPM.bs.BSZPS",1)
 S @Bsr@(Bst,"ZPr",ZPN,"^","W")=S
 S @Bsr@(Bst,"ZPr",ZPN,"^","F")=$S('$D(CALCFON):"Q",CALCFON=1:"F",1:"R")
 S @Bsr@(Bst,"ZPr",ZPN,"^","@%BS")="^%ZAPM.bs.BSVOL,ZPR"_$P(@Bsr@(Bst),"@",17)
 D Yes^%ZAPM.bs.BSXfun("Насчет продолжить ?",2)
 Q
SETGL ;ПЕРЕПРИСВОЕНИЕ ДЛИННОГО М-ЗАПРОСА
 N I,II S I=$P(@g,"@",2),II=$NA(@GG@("@LongString")) D Copy^%ZAPM.bs.BSF8(I,II)
 S $P(@g,"@",2)=II
 Q
LO() S G=$NA(@"^%ZAPM.bs.BSbufB"@("KCH"_$G(%BS(3),$P)_$J_"u"_%BS(15)))
 ;|D ^%ZAPM.bs.BSMSMG(G)
 S BR="^%ZAPM.bs.BSbufB",BT="ZAPROSy"_$G(%BS(3),$P)_$J_"u" I $D(@BR@(BT))["0" D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSVOL(""ZP"")",$NA(@BR@(BT)))
 Q 1
EDITZAP ;РЕДАКТИРОВАТЬ
 I $$LO
 S @BR@(BT,"KEY")=$NA(@Bsr@(Bst,"ZPr"))
 D Table^%ZAPM.bs.BSN(BR,BT)
 Q
ZPSTART(ZPN,BSrz,BStz,ZPR,ZPT) ;СТАРТ ЗАПРОСА
             ;BSrz,BStz-раздел и сводка/список
             ;ZPN-имя запроса
             ;ZPR-раздел куда записывать ZPT-имя таблицы
             ;(по умолчанию ZPR=BSrz,ZPT=BStz_(".Last"+1))
 N GB,GZ,S,F,NOKEY,%KEYS,NAZAD,CALCFON
 S GB=$NA(@"^%ZAPM.bs.BSbufB"@("KCH"_$G(%BS(3),$P)_$J_"u"_ZPN_BSrz_"("_BStz)) K @GB
 S GZ=$NA(@BSrz@(BStz,"ZPr",ZPN))
 S TIp=$P(@BSrz@(BStz),"@",17)
 I '$D(@BSrz@(BStz,"ZPr",ZPN)) D ErrMsg^%ZAPM.bs.BSXfun("ЗАПРОСА '"_ZPN_"' В '"_BSrz_"("_BStz_")' НЕ СУЩЕСТВУЕТ") Q
 D Copy^%ZAPM.bs.BSF8(GZ,GB) S S=@BSrz@(BStz,"ZPr",ZPN,"^","W")
 S @GB=S,F=@BSrz@(BStz,"ZPr",ZPN,"^","F")
 I $ZV'["Cach"&&($ZV'["IRIS") S:F="R" CALCFON=2 S:F="F" CALCFON=1
 I $D(GuiCall) S CALCFON=1
 S $P(@GB,"#",4)=$G(ZPR),$P(@GB,"#",5)=$G(ZPT),x=GB
 D UU^%ZAPM.bs.BSF11(BSrz)
 G BEGIN^%ZAPM.bs.BSSP:TIp=3 G BEGIN^%ZAPM.bs.BSSV
]]></Routine>


<Routine name="%ZAPM.bs.BSZRA" type="MAC" languagemode="0"><![CDATA[
 ;             ; 23:59 21-JUL-96
 ;  --------------------------------------------------------------------
 ;  |         ПРОГРАММА ЗАГРУЗКИ ПРИЛОЖЕНИЯ КОМПЛЕКСА %BS              |
 ;  |      ПРОИЗВОДИТСЯ ИЗ %BSINST.PAC или ^%PACKAGE или из %BS        |
 ;  --------------------------------------------------------------------
ZV ;                           ДЛЯ MSM4.0.14C
 ;
 I $D(%BS)["0" D CLr^%ZAPM.bs.BSF4
 I +$P($ZV,"Version ",2)<3 D ErrMsg^%ZAPM.bs.BSXfun("НЕСОВМЕСТИМЫЕ ВЕРСИИ !!! ВЕРСИЯ MSM ДОЛЖНА БЫТЬ НЕ НИЖЕ 3.0 !!!") Q
 K NOMXTR,EST S $ZT="MX^BSZRAPP" D L^%ZAPM.bs.BS3("^BStranS")
 S ^BStranS("?")=$J(1,500) D U^%ZAPM.bs.BS3("^BStranS")
1 G ^%ZAPM.bs.BSZRAP
MX U 0 W *7 S NOMXTR=1,$ZT="" G 1
]]></Routine>


<Routine name="%ZAPM.bs.BSZRAP" type="MAC" languagemode="0"><![CDATA[
%BSZRAP ;ИНСТАЛЛЯЦИЯ ПРИЛОЖЕНИЯ ; 14:32 17-JUN-97
 S $ZT="ERROR^%ZAPM.bs.BSZRAP" D L^%ZAPM.bs.BS3("^BStranS")
 K ^BStranS,OOOkey
 U %DEV R %RN I %RN=";TRANSLATE;" D Wait^%ZAPM.bs.BSXfun("Восстановление ^BStranS") S (GLO,GL)="" F i=1:1 U %DEV R %G,%V Q:%G=";ROUTINES;"  S GL=$P(%G,"(") D GRES(%G,%V,1) I '(i#10) U 0 X WA
 S Device=%DEV
 U 0 S Buf="^%ZAPM.bs.BSbufB(""Install_Gen"")"
 D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSS(""APPLIC"")",Buf)
TAB S BSR="^%ZAPM.bs.BSbufB",BST="Install_Gen" D ^%ZAPM.bs.BST
TABE I R1=27 D Yes^%ZAPM.bs.BSXfun("Отказываемся делать инсталляцию приложения ?",1) I YES G EXIT
 S UciSys=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,5,4) I UciSys'=$$ZU^%ZAPM.bs.BS3(0) D ErrMsg^%ZAPM.bs.BSXfun(" ВНИМАНИЕ !!! ПЕРЕЙДИТЕ В КИП "_UciSys_" И СНОВА ПОВТОРИТЕ ИНСТАЛЛЯЦИЮ") G EXIT
 S ii="" F i=7:2:11 S ii=$O(^BStranS("App","Tra",ii)) Q:ii=""  I $$DataCell^%ZAPM.bs.BSF8(BSR,BST,i,4)="" D Yes^%ZAPM.bs.BSXfun(" ВНИМАНИЕ !!! "_$G(^BStranS("App","Tra",ii,1),"???")_" ! ОПРЕДЕЛИМ ?",1) G:YES TAB S R1=27 G TABE
 D CHECK G @END
NO ;ПРОДОЛЖИТЬ ИНСТАЛЛЯЦИЮ
START D Yes^%ZAPM.bs.BSXfun("Начнем инсталляцию приложения ?",1) I 'YES G EXIT
 U 0 D Wait^%ZAPM.bs.BSXfun("Восстановление программ") S %DEV=Device
 F  U %DEV R %RN Q:%RN=";GLOBALS;"  D LOAD U 0 X WA
 U 0 D Wait^%ZAPM.bs.BSXfun("Восстановление массивов") K KillYes
 S (GLO,GL)="" F i=1:1 U %DEV R %G,%V Q:%G=""  S GL=$P(%G,"(") D GRES(%G,%V) I '(i#50) U 0 X WA
 C %DEV U 0 D TRANS,CHAR,INSTALL
 I $D(EST) D ErrMsg^%ZAPM.bs.BSXfun(" ВНИМАНИЕ !!! ИНСТАЛЛЯЦИЯ НЕУДАЧНАЯ ! В ВАШЕЙ СИСТЕМЕ НЕ ВЫСТАВЛЕН ФЛАГ, РАЗРЕШАЮЩИЙ ДАННЫЕ В ГЛОБАЛАХ ИМЕТЬ ДЛИНЕЕ 256 СИМВОЛОВ") G EXIT
 D OkMsg^%ZAPM.bs.BSXfun("Инсталляция Приложения Завершена успешно") S OOOkey=1
EXIT K ^BStranS,^%ZAPM.bs.BSbufB("Install_Gen") D U^%ZAPM.bs.BS3("^BStranS") Q
GRES(%G,%V,%n) I GLO'=GL S GLO=GL D:'$D(KillYes)  K:'$G(KillYes) @GLO
 .Q:$G(%n)  D Yes^%ZAPM.bs.BSXfun("Если Встретим Уже Существующие массивы,то УДАЛЯЕМ ?",1) S KillYes=YES
 I $L(%V)<256 S @%G=%V Q
 I '$D(NOMXTR) S @%G=%V Q
 S EST=1 Q
ERROR D ErrMsg^%ZAPM.bs.BSXfun("ВНИМАНИЕ !!! ОШИБКА ПРИ ИНСТАЛЛЯЦИИ"_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) Q
LOAD X "ZL  ZS @%RN" Q
QUE(MA,IIpr,PRO) 
 W $$bel^%ZAPM.bs.BS3
 N M,GLZ,%B S GLZ=$ZR
 S M(0,1)=" ВНИМАНИЕ !!! "_MA_" Уже Существует !!! ",M(0,3)=" Определите свои дальнейшие действия",M(0,2)="  "_IIpr
 S M(1,1)=" ПЕРЕЗАПИШЕМ ",M(1,2)=" ВСЕ,ПЕРЕЗАПИШЕМ ",M(1,3)=" ПРЕРВЁМ ",M(1,4)=" "_MA_" "
 S M="/"_$P(%BS,"!",8),M(0)=$P(%BS,"!",8),M(1)=$P(%BS,"!",8)_"/"_$P(%BS,"!",3)
QU S %B=$$TxtPanel^%ZAPM.bs.BSXfun1("M",0,0,1) I YES<1 W $$bel^%ZAPM.bs.BS3 G QU
 I %B=4 D @PRO G QU
 I %B=2 S END="NO"
 I %B=3 S END="EXIT"
 I GLZ'[$C(34),$D(@GLZ)
 Q
CHECK ;ПРОВЕРКА НА СУЩЕСТВОВАНИЕ
 S END="START" U 0 D Wait^%ZAPM.bs.BSXfun("ПРОВЕРКА НА СУЩЕСТВОВАНИЕ")
 S I="" F  S I=$O(^BStranS("Glo",I)) Q:I=""  X WA S IIpr="^"_I I $D(@IIpr) D QUE("Массив",IIpr,"^%ZAPM.bs.BSMSMG(IIpr)") I END'["S" Q
 S I="",END="START" F  S I=$O(^BStranS("Rou",I)) Q:I=""  X WA S IIpr=I I $D(^ (IIpr)) D QUE("Программа",IIpr,"^%ZAPM.bs.BSXprog(IIpr)") I END'["S" Q
 Q
INSTALL ;Выполнение программ
 I $D(^BStranS("App","Cmd")) U 0 D Wait^%ZAPM.bs.BSXfun("Выполнение программы") S %RN=$G(^BStranS("App","Cmd")) X %RN
 Q
CHAR ;Восстановление Характерристик
 I $G(^BStranS("App","Right"))="Y" U 0 D Wait^%ZAPM.bs.BSXfun("Восстановление Характерристик массивов") S %RN="" F  S %RN=$O(^BStranS("Glo",%RN)) Q:%RN=""  S PRO=^BStranS("Glo",%RN) I PRO'="4114",PRO>0 D CP^%ZAPM.bs.BSGCH(%RN,PRO) U 0 X WA
 Q
TRANS ;ТрансляциЯ ссылок на КИП и ТОМ
 Q:'$D(^BStranS)
 K TRA S I=0 I $D(^BStranS("App","Tr0"))  S TRA(I)="",TRA(I,1)=$P(@$ZR,","),TRA(I,2)=$P(@$ZR,",",2)
 F I=1:1:3 I $D(^BStranS("App","Tra",I)) S TRA(I)=^(I,1),TRA(I,1)=$P(^(2),","),TRA(I,2)=$P(^(2),",",2)
 S ni=7,i="" F  S i=$O(TRA(i)) Q:i=""  D
 .D SETT
 .I i=0 D SETTRA($$ZU^%ZAPM.bs.BS3(0)) Q
 .I $$DataCell^%ZAPM.bs.BSF8(BSR,BST,ni,4)="" K TRA(i) Q
 .S COM=$$DataCell^%ZAPM.bs.BSF8(BSR,BST,ni,4),ni=ni+2
 .D SETTRA(COM) Q
 I $D(TRA) U 0 D Wait^%ZAPM.bs.BSXfun("Трансляция ссылок в массивах") S I="" F  S I=$O(^BStranS("Glo",I)) Q:I=""  I '$D(^BStranS("NoTrGlo",I)) S II="^"_I D
 .I $D(@II)'["0" D TRA(II)
 .F ii=1:1 S II=$ZO(@II) Q:II=""  D TRA(II) I '(ii#50) U 0 X WA
 Q
TRA(G) Q:@G'["["
 N gg S (g1,gg)=@G,gg=$$TRAnfer(gg) I gg'=g1 S @G=gg
 Q
TRAnfer(g) S iii="" F  S iii=$O(TRA(iii)) Q:iii=""  D
 .I g[TRA(iii,3)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,3),TRA(iii,4))
 .I g[TRA(iii,5)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,5),TRA(iii,4))
 .I g[TRA(iii,6)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,6),TRA(iii,8))
 .I g[TRA(iii,7)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,7),TRA(iii,8))
 .I g[TRA(iii,11)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,11),TRA(iii,9))
 .I g[TRA(iii,12)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,12),TRA(iii,10))
 .I g[TRA(iii,14)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,13),TRA(iii,10))
 .I g[TRA(iii,13)  S g=$$TR^%ZAPM.bs.BSsFUNM(g,TRA(iii,11),TRA(iii,9))
 Q g
ver(V) ;4.;i $P($ZV,"Version ",2)'<4 Q "|"
 Q $S(V=1:"[",1:"]")
SETTRA(COM) S TRA(i,4)=$$ver(1)_""""_$P(COM,",")_""","""_$P(COM,",",2)_""""_$$ver(2),TRA(i,8)=$$ver(1)_""""""_$P(COM,",")_""""","""""_$P(COM,",",2)_""""""_$$ver(2)
 S TRA(i,9)=$$ver(1)_""""""""_$P(COM,",")_""""""","""""""_$P(COM,",",2)_""""""""_$$ver(2),TRA(i,10)=$$ver(1)_""""""""""_$P(COM,",")_""""""""","""""""""_$P(COM,",",2)_""""""""""_$$ver(2)
 Q
SETT S TRA(i,3)="["""_TRA(i,1)_""","""_TRA(i,2)_"""]",TRA(i,5)="["""_TRA(i,1)_"""]",TRA(i,6)="["""""_TRA(i,1)_"""""]",TRA(i,7)="["""""_TRA(i,1)_""""","""""_TRA(i,2)_"""""]"
 S TRA(i,11)="["""""""_TRA(i,1)_""""""","""""""_TRA(i,2)_"""""""]",TRA(i,12)="["""""""""_TRA(i,1)_""""""""","""""""""_TRA(i,2)_"""""""""]"
 S TRA(i,13)="["""""""_TRA(i,1)_"""""""]",TRA(i,14)="["""""""""_TRA(i,1)_"""""""""]"
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSZRAPP" type="MAC" languagemode="0"><![CDATA[
 U 0 W #," Восстановление в <",$$ZU^%ZAPM.bs.BS3(0),">. Все Фоновые MUMPS процесы Остановлены ? <Y> " R R H:"Yy"'[R ; ; 14:03  6-DEC-97
 W !!,"...ЗАГРУЗКА...",!,$P($T(%),";",2,999)
 ;
 ;            ПРОГРАММА ЗАГРУЗКИ ПРИЛОЖЕНИЯ КОМПЛЕКСА %BS
 ;             ПРОИЗВОДИТСЯ ИЗ %BSINST.PAC ИЛИ ^%PACKAGE
ZV ;                           ДЛЯ MSM4.0.14C
 ;
 I +$P($ZV,"Version ",2)<3 W !,"НЕСОВМЕСТИМЫЕ ВЕРСИИ !!! ВЕРСИЯ MSM ДОЛЖНА БЫТЬ НЕ НИЖЕ 3.0 !!!",*7 Q
 K NOMXTR,EST S $ZT="MX^BSZRAPP" D R^%ZAPM.bs.BS0("^TR")
 S ^TR("?")=$J(1,500) K ^TR("?") S $ZT="ERROR^BSZRAPP"
1 K ^UTILITY($J,"ROU"),^("GLO")
 F  U %DEV R %RN Q:%RN=";GLOBALS;"  D LOAD U 0 W "."
 U 0 D x^%ZAPM.bs.BS3(%RN)     ;---//--- для msm 4.x.x
 S (GLO,GL)="" F i=1:1 U %DEV R %G,%V Q:%G=""  S GL=$P(%G,"(") D  I '(i#50) U 0 W "*"
 .I GLO'=GL S ^UTILITY($J,"GLO",GL)=1,GLO=GL K @GLO
 .I $L(%V)<256 S @%G=%V Q
 .I '$D(NOMXTR) S @%G=%V Q
 .S EST=1
 C %DEV U 0 D TRANS,CHAR,INSTALL
 K ^UTILITY($J,"ROU"),^("GLO"),^BStranSU
 I $D(EST) W *7,!!," ВНИМАНИЕ !!! ИНСТАЛЛЯЦИЯ НЕУДАЧНАЯ ! В ВАШЕЙ СИСТЕМЕ НЕ ВЫСТАВЛЕН ФЛАГ,",!,"РАЗРЕШАЮЩИЙ ДАННЫЕ В ГЛОБАЛАХ ИМЕТЬ ДЛИНЕЕ 256 СИМВОЛОВ"
 Q
EXIT X "ZR  ZS BSZRAPP" H
MX U 0 W *7 S NOMXTR=1,$ZT="" G 1
ERROR W *7,!!," ВНИМАНИЕ !!! ОШИБКА ПРИ ИНСТАЛЛЯЦИИ",!!!,$$ErrSay^%ZAPM.bs.BSF8($ZE) Q
LOAD X "S ^UTILITY($J,""ROU"",%RN)=1 ZL  ZS @%RN" Q
INSTALL ;Выполнение программ
 I $D(^BStranSU("Install_R")) W !,"Выполнение программ..." S %RN="" F  S %RN=$O(^BStranSU("Install_R",%RN)) Q:%RN=""  S ROU=^BStranSU("Install_R",%RN) X ROU
 Q
CHAR ;Восстановление Характерристик
  I $D(^BStranSU("RightS")) W !,"Восстановление Характерристик массивов..." S %RN="" F  S %RN=$O(^BStranSU("RightS",%RN)) Q:%RN=""  S PRO=^BStranSU("RightS",%RN) I PRO'="4114",PRO>0 D CP^%ZAPM.bs.BSGCH(%RN,PRO) U 0 W "+"
 Q
TRANS ;ТрансляциЯ ссылок на КИП и ТОМ
 Q:'$D(^BStranSU)  K TRA F I=1:1 Q:'$D(^BStranSU(I))  S TRA(I)=^BStranSU(I,1),TRA(I,1)=^BStranSU(I,2),TRA(I,2)=^BStranSU(I,3)
 F i=1:1 Q:'$D(TRA(i))  S TRA(i,3)="["""_TRA(i,1)_""","""_TRA(i,2)_"""]",TRA(i,5)="["""_TRA(i,1)_"""]",TRA(i,6)="["""""_TRA(i,1)_"""""]",TRA(i,7)="["""""_TRA(i,1)_""""","""""_TRA(i,2)_"""""]" D
 .I TRA(i)="" S TRA(i,4)=$$ver(1)_""""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_""""_$$ver(2),TRA(i,8)=$$ver(1)_""""""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""""","""""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_""""""_$$ver(2) Q
TRAN .S COM=$$LineEdit^%ZAPM.bs.BSXfun("",TRA(i),"","","","","") I COM="" K TRA(i) Q
 .I COM'?3A1","3A W *7 G TRAN
 .S TRA(i,4)=$$ver(1)_""""_$P(COM,",")_""","""_$P(COM,",",2)_""""_$$ver(2),TRA(i,8)=$$ver(1)_""""""_$P(COM,",")_""""","""""_$P(COM,",",2)_""""""_$$ver(2) Q
 I $D(TRA) S I="" W !,"Трансляция ссылок в массивах..." F  S I=$O(^UTILITY($J,"GLO",I)) Q:I=""  S II=I D
 .I $D(@II)'["0" D TRA(II)
 .F ii=1:1 S II=$ZO(@II) Q:II=""  D TRA(II) I '(ii#50) U 0 W "§"
 Q
TRA(G) Q:@G'["["  F iii=1:1 Q:'$D(TRA(iii))  D
 .I @G[TRA(iii,3)  S @G=$$TR^%ZAPM.bs.BSsFUNM(@G,TRA(iii,3),TRA(iii,4))
 .I @G[TRA(iii,5)  S @G=$$TR^%ZAPM.bs.BSsFUNM(@G,TRA(iii,5),TRA(iii,4))
 .I @G[TRA(iii,6)  S @G=$$TR^%ZAPM.bs.BSsFUNM(@G,TRA(iii,6),TRA(iii,8))
 .I @G[TRA(iii,7)  S @G=$$TR^%ZAPM.bs.BSsFUNM(@G,TRA(iii,7),TRA(iii,8))
 Q
ver(V) i $P($ZV,"Version ",2)'<4 Q "|"
 Q $S(V=1:"[",1:"]")
]]></Routine>


<Routine name="%ZAPM.bs.BSZRM" type="MAC" languagemode="0"><![CDATA[
% U 0 W !,"... ЗАГРУЗКА РАЗДЕЛА ^BSINSTAL ..." ; ; 15:29 26-SEP-97
 ;
 ;            ПРОГРАММА ЗАГРУЗКИ РАЗДЕЛА ИНСТАЛЛЯЦИИ КОМПЛЕКСА %BS
 ;                       ПРОИЗВОДИТСЯ ИЗ %BSINST.PAC
ZV ;                           ДЛЯ MSM4.0.14C
 ;
 I +$P($ZV,"Version ",2)<3 W !,"НЕСОВМЕСТИМЫЕ ВЕРСИИ !!! ВЕРСИЯ MSM ДОЛЖНА БЫТЬ НЕ НИЖЕ 3.0 !!!",*7 Q
 K NOMXTR S $ZT="MX^BSZRM" S ^TR("?")=$J(1,500) K ^TR("?") S $ZT=""
1 K ^BSINSTAL F  U %DEV R %RN Q:%RN=";GLOBALS;"  D LOAD U 0 W "."
 U 0 W "*" U %DEV F  R %G,%V Q:%G=""  D
 .I $L(%V)<256 S @%G=%V Q
 .I '$D(NOMXTR) S @%G=%V
 C %DEV D VER^BSINST S $ZT="",Dev=%DEV,FiNa=%FN ;,%BS(12)="GUEST"
2 S BSR="^BSINSTAL",BST="FIRST" D ^%ZAPM.bs.BST I R1=27 G EXIT
 I ny=1 S %DEV=Dev,(%FN,FN)=FiNa G 2^BSINST
 S BST="MAIN" D ^%ZAPM.bs.BST I R1=27 G 2
 I ny=6 S %DEV=Dev,(%FN,FN)=FiNa G 6^BSINST
 I ny=7 G 2
 Q
EXIT K ^BSINSTAL X "ZR  ZS BSINST" H
MX U 0 W *7 S NOMXTR=1,$ZT="" G 1
LOAD X "ZL  ZS @%RN" Q
]]></Routine>


<Routine name="%ZAPM.bs.BSZRO" type="MAC" languagemode="0"><![CDATA[
% U 0 D W(1),W("... Восстановление %BS version 810 16.04.2003 ...")
 ;
 ;  ИНСТАЛЛЯЦИЯ ОТКРЫТОЙ ВЕРСИИ КОМПЛЕКСА %BS ПРОИЗВОДИТСЯ УТИЛИТОЙ ^%PACKAGE
ZV ;                           ДЛЯ MSM4.0.14C
 ;
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) G 1
 I +$P($ZV,"Version ",2)<3 D W(1),W("НЕСОВМЕСТИМЫЕ ВЕРСИИ !!! ВЕРСИЯ MSM ДОЛЖНА БЫТЬ НЕ НИЖЕ 3.x.x !!!"),W(7) Q
 K NOMXTR S $ZT="MX^BSZRO" S ^TR("?")=$J(1,500) K ^TR("?")
 K ^%ZAPM.bs.BSinFL
 I $ZV["MSM" D  ;УДАЛЕНИЕ ПРОГРАММ ПО МАСКЕ %BS*
 .X "N I S I=""%BS"" F  S I=$O(^ (I)) Q:I=""""!($E(I,1,3)'=""%BS"")  ZR  ZS @I"
1 F  U %DEV R %RN Q:%RN=";GLOBALS;"  D LOAD U 0 D W(".")
 D NaSET
 S YearNew=$G(^%ZAPM.bs.BSETUP("YEAR",1))
 I +$G(^%ZAPM.bs.BS)<229 K ^%ZAPM.bs.BSETUP("COLOR")
 I +$G(^%ZAPM.bs.BS)<295 K ^%ZAPM.bs.BSbufB("INFO_K")
 I +$G(^%ZAPM.bs.BS)<575 K ^%ZAPM.bs.BSETUP("SETUP")
 I +$G(^%ZAPM.bs.BS)<665,$E($P($G(^%ZAPM.bs.BSETUP("PATH",6,4)),"@",15))'="^" S $P(^%ZAPM.bs.BSETUP("PATH",6,4),"@",15)="^[""SRV"",""SYS""]BSprotkl"
 I $P($G(^%ZAPM.bs.BSETUP("SERVER",15,4)),"@",15)'[":" S BSr1="^%ZAPM.bs.BSS",BSt1=$S($ZV["MSM":"SERVER",1:"CacheServ"),BSr2="^%ZAPM.bs.BSETUP",BSt2="SERVER" D COPY^%ZAPM.bs.BSTK
 S Version=+$G(^%ZAPM.bs.BS),G=""
 K ^%ZAPM.bs.BSbufB("PRNset"),^%ZAPM.bs.BSbufB("PRNini")
 U 0 F i=1:1 U %DEV R %G,%V Q:%G=""  D  I '(i#150) U 0 D W(".")
 .I G'=$P(%G,"(") S G=$P(%G,"(") I $E(G,1,4)="^%ZAPM.bs.BS"&($E(G,1,7)'="^%ZAPM.bs.BSbuf") K @G
 .I $L(%V)<256 S @%G=%V Q
 .I '$D(NOMXTR) S @%G=%V
 C %DEV
 ;```I $P($G(^%ZAPM.bs.BSETUP("SERVER",16,4)),"@",15)'["." S BSr1="^%ZAPM.bs.BSS",BSt1=$S($ZV["MSM":"SERVER",1:"CacheServ"),BSr2="^%ZAPM.bs.BSETUP",BSt2="SERVER" D COPY^%ZAPM.bs.BSTK
 D NaGET
 K ^%ZAPM.bs.BS("SYSGEN"),^BSINSTAL
 I YearNew'="" S ^%ZAPM.bs.BSETUP("YEAR",1)=YearNew
 I '$D(IntSe),$ZV'["Windows" D SYSFIX^%ZAPM.bs.BSF9
 S ^%ZAPM.bs.BSinFL=$$ESDAY^%ZAPM.bs.BSsFUNR(9,$$h^%ZAPM.bs.BS3())
EXIT C 63
 Q
W(W) I '$D(IntSe) D
 .I W?.N D  Q
 ..I W=1 W !
 ..I W=2 W #
 .W W
 Q
MX U 0 W *7 I $ZE'["MXSTR>" H:$ZE["LOBR>"  W #,!,$ZE R R Q
 S NOMXTR=1,$ZT="" I $P($ZV,"Version ",2)'<4 D
 .W #,"- Утилитой ^DBMAINT редактируйте параметры Системного Тома:"
 .W !,"  установите разрешение использовать глобали длиной до "_$$LNG^%ZAPM.bs.BSF12_" символов"
 .W !,"- Утилитой ^SYSGEN редактируйте Системные Флаги: "
 .W !,"  установите разрешение использовании в программах строк длинее 255 символов"
 .w !,"   (>D ^SYSGEN --> 3 --> <DFLT> --> 20 --> 11)"
 .W !,"- Утилитой ^SYSGEN редактируйте Системные Стэк и Стэп:"
 .W !,"  36 и 36 соответственно"
 .w !,"   (>D ^SYSGEN --> 9 --> 2)"
 .W !!,"После этого перезагрузитесь и снова попробуйте инсталляцию %BS" Q
 G 1
LOAD X "ZL  ZS @%RN ZL BSZRO" Q
NaSET ;ПРИСВОЕНИЕ ИМЕН БАЗ
 K Na
 D NaSE(1,"^%ZAPM.bs.BSS","USER","^%ZAPM.bs.BSU")          ;ПОЛЬЗОВАТЕЛИ %BS
 D NaSE(2,"^%ZAPM.bs.BSDDR","DDR","^%ZAPM.bs.BSddr")       ;ФОРМЫ DDR
 D NaSE(3,"^%ZAPM.bs.BSS","XECUTE","^%ZAPM.bs.BSex")       ;КОММАНДЕР %BS
 D NaSE(4,"^%ZAPM.bs.BSS","ARM","^%ZAPM.bs.BSARM")         ;АРМЫ %BS
 D NaSE(5,"^%ZAPM.bs.BSS","CMD","^%ZAPM.bs.BScmd")         ;КОМАНДЕР %BS
 D NaSE(6,"^%ZAPM.bs.BSJPRN","PRN","^%ZAPM.bs.BSJPR")      ;ПРИНТ-СИСТЕМА
 D NaSE(7,"^%ZAPM.bs.BSVOL","MARK","^%ZAPM.bs.BSmark")     ;БАЗА ПОМЕТОК
 D NaSE(8,"^%ZAPM.bs.BSMDDR","BPO","^%ZAPM.bs.BSbpo")      ;НОВАЯ БД DDR
 D NaSE(9,"^%ZAPM.bs.BSVOL","PACKET","^%ZAPM.bs.BSpack")               ;БД ПАКЕТОВ ЗАПРОСОВ
 D NaSE(10,"^%ZAPM.bs.BSZ","LOGIC","^[""MOL"",""VOI""]BSzLOG") ;ЛОГИКА
 D NaSE(11,"^%ZAPM.bs.BSVOL","TRM","^%ZAPM.bs.BStrm")                  ;БД ТЕРМИНАЛОВ
Na D NaSE(12,"^%ZAPM.bs.BSZ","SVb1","^[""MOL"",""VOI""]BSzB")  ;БД БОКОВИН
 D NaSE(13,"^%ZAPM.bs.BSZ","SVb4","^[""MOL"",""VOI""]BSzB")
 D NaSE(14,"^%ZAPM.bs.BSZ","SVz1","^[""MOL"",""VOI""]BSzZ")    ;БД ЗАПРОСОВ
 D NaSE(15,"^%ZAPM.bs.BSZ","SVz2","^[""MOL"",""VOI""]BSzZ")
 D NaSE(16,"^%ZAPM.bs.BSZ","SVz11","^[""MOL"",""VOI""]BSzZ")
 D NaSE(17,"^%ZAPM.bs.BSZ","SVz2","^[""MOL"",""VOI""]BSzZ1")
 D NaSE(18,"^%ZAPM.bs.BSZ","SVz3","^[""MOL"",""VOI""]BSzZ1")
 D NaSE(19,"^%ZAPM.bs.BSZ","SLm1","^[""MOL"",""VOI""]BSzlU")   ;БД СПИСКОВ
 D NaSE(20,"^%ZAPM.bs.BSZ","SLm2","^[""MOL"",""VOI""]BSzlU")
 D NaSE(21,"^%ZAPM.bs.BSZ","SLm3","^[""MOL"",""VOI""]BSzlU")
 D NaSE(22,"^%ZAPM.bs.BSZ","SVm3","^[""MOL"",""VOI""]BSzvU")   ;БД СВОДОК
 D NaSE(23,"^%ZAPM.bs.BSZ","SVm2","^[""MOL"",""VOI""]BSzvU")
 D NaSE(24,"^%ZAPM.bs.BSZ","SVm5","^[""MOL"",""VOI""]BSzvU")
 D NaSE(25,"^%ZAPM.bs.BSZ","SVR","^[""MOL"",""VOI""]ZSVr")            ;?
 D NaSE(26,"^%ZAPM.bs.BSS","TRIGGER","^[""SRV"",""SYS""]BStrigg")     ;ПЕРЕАДРЕСАЦИЯ ИМЕНИ БАЗЫ ДАННЫХ
 D NaSE(27,"^%ZAPM.bs.BSZ","SLsort","^[""MOL"",""VOI""]BSzSort")      ;СОРТИРОВКА И ВЫДЕЛЕНИЕ СПИСКОВ В ТАФ
 D NaSE(28,"^%ZAPM.bs.BSVOL","PROTOKOL","^[""SRV"",""SYS""]BSprotkl") ;ПРОТОКОЛИРОВАНИЕ
 D NaSE(29,"^%ZAPM.bs.BSVOL","MainMenu","^[""SRV"",""SYS""]BSMMenu")  ;ГЛАВНОЕ МЕНЮ
 D NaSE(30,"^%ZAPM.bs.BSVOL","ACTFILE","^%ZAPM.bs.BSactF")  ;ДЕЙСТВИЕ С ФАЙЛАМИ
 Q
NaSE(N,P,T,DFLT) S Na(N)=$G(@P@(T,"KEY")),Na(N,1)=$ZR,Na(N,3)=$G(@$ZR),Na(N,2)=DFLT
 I $D(InTNa) S @P@(T,"KEY")=DFLT
 Q
NaGET ;ВОЗВРАТ ИМЕН
 S Na="" F  S Na=$O(Na(Na)) Q:Na=""  D
 .I Na(Na)'="" S @Na(Na,1)=Na(Na,3)
 .E  S @Na(Na,1)=Na(Na,2)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSZRS" type="MAC" languagemode="0"><![CDATA[
BSZRS U 0 W !,"ВОССТАНОВЛЕНИЕ СИСТЕМНЫХ И БИБЛИОТЕЧНЫХ ПРОГРАММ И МАССИВОВ..." ; ; 15:29 26-SEP-97
 ;      ИНСТАЛЛЯЦИЯ КОМПЛЕКСА %BS ПРОИЗВОДИТСЯ УТИЛИТОЙ ^%PACKAGE
 ;               ИЛИ ИЗ ОБЩЕГО МОНИТОРИНГА %BSCHOIS.MOD
ZV ;                           ДЛЯ MSM4.0.14C
 ;
 U 0:(0::::#10080)
 I +$P($ZV,"Version ",2)<3 W !,"НЕСОВМЕСТИМЫЕ ВЕРСИИ !!! ВЕРСИЯ MSM ДОЛЖНА БЫТЬ НЕ НИЖЕ 3.0 !!!",*7 Q
ROUGLO ;       **** СИСТЕМНЫЕ И БИБЛИОТЕЧНЫЕ ПРОГРАММЫ MSM ****
 F  U %DEV R %RN Q:%RN=";GLOBALS;"  D LOAD U 0 W "."
 F  U %DEV R %G,%V Q:%G=""  S @%G=%V U 0 W "."
 C %DEV D FGS Q
FGS W !,"  **** СЛУЖЕБНЫЕ МАССИВЫ NAMESPACE ОПЦИОНАЛЬНЫХ ПАКЕТОВ ****",!
 ;                  Восстановятся массивы ^%kBd и ^%SC
 S %DE=%DEV,FN=%FN N (%DE,FN) S %BSinsta=1
 O 63::0 E  U 0 W !,"Waiting for device 63" O 63
 S %DEVVTYP="HFS;MTD",%DEVNMOD="RB::1024" F %DEV=%DE+1:1:54 O %DEV::0 Q:$T
 I '$T S STOP=1 Q
 S %IN=1,%TAP=0,%ZA=0,%DEVTYPE="HFS",%FN=$S(FN["\":$P(FN,"\",1,$L(FN,"\")-1)_"\",FN[":":$P(FN,":",1)_":\",1:"")_"%BSONS.FGS"
 O %DEV:(%FN:"RB") U %DEV S ZA=$ZA U 0
 D SDEV+3^%FGR Q
LOAD X "ZL  ZS @%RN" Q
]]></Routine>


<Routine name="%ZAPM.bs.BSZSTART" type="MAC" languagemode="0"><![CDATA[
%ZSTART
 Q
SYSTEM q
 Q
LOGIN
logset N L,H I $G(^%ZAPM.bs.BSlog)'=1 Q  //ПРОТОКОЛ ВЫКЛЮЧЕН
 S L="LOGIN" S H=$H,^%ZAPM.bs.BSlog($J,L)=$ZD(H,3)_" "_$ZT($P(H,",",2),1)_" *"_H
 Q
JOB D logset
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSZSTOP" type="MAC" languagemode="0"><![CDATA[
%ZSTOP
 Q
SYSTEM Q
LOGIN
logkill I $G(^%ZAPM.bs.BSlog)'=1 Q
 I $D(^%ZAPM.bs.BSlog($J)) K @$ZR
 Q
JOB D logkill
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSkevFT" type="MAC" languagemode="0"><![CDATA[
%BSFT  ; Compiled July 28, 2005 12:58:04
	; Cache` File Transfer Server
	; develop starts @ 27/07/2005
	quit
start
	;quit:($get(^%ZAPM.bs.BSFTconf("PID"), "") '= "")
	set ^%ZAPM.bs.BSFTconf("stopsig") = 0
	set ^%ZAPM.bs.BSFTconf("log") = 1
	kill ^%ZAPM.bs.BSFTlog
	job DaemonMainLoop
	write "FTS daemon has been rised " _ $ztime($piece($horolog, ",", 2), 1)
	quit
	;
stop
	quit:($get(^%ZAPM.bs.BSFTconf("stopsig"), 1))
	set ^%ZAPM.bs.BSFTconf("stopsig") = 1
	write "FTS daemon has been killed " _ $ztime($piece($horolog, ",", 2), 1)
	quit
	;
restart
	do stop
	do start
	quit
	;
setport(p)
	set ^%ZAPM.bs.BSFTconf("port") = +p
	write "FTS daemon's port is set to " _ p _ "."
	quit
	;
settimeout(t)
	set ^%ZAPM.bs.BSFTconf("timeout") = +t
	write "FTS daemon's timeout is set to " _ t _ "."
	quit
	;
ErrHandler
	set $ztrap = ""
	if ($data(device)) close device
	do PutLog("Daemon error: $ZE = " _ $ze _ "; $ZC = " _ $zc)
	quit
	;
TErrHandler
	set $ztrap = ""
	do PutLog("Thread error: $ZE = " _ $ze _ "; $ZC = " _ $zc)
	lock
	if ($ze '= "") goto PopCmd
	close $principal
	quit
	;
DaemonMainLoop
	new port, device, timeout, ip, buf
	set $ztrap = "ErrHandler"
	set port = $get(^%ZAPM.bs.BSFTconf("port"), 1961)
	set timeout = $get(^%ZAPM.bs.BSFTconf("timeout"), 30)
	set device = "|TCP|" _ port
	; You can include the “A” mode parameter in the OPEN command
	; to make the initial READ complete as soon as the server accepts the connection.
	open device:(:port:"A"):timeout
	if ('$test) {
		do PutLog("Can't open device " _ device _ ".")
		quit
	}
	set ^%ZAPM.bs.BSFTconf("PID") = $job
	do PutLog("Daemon rised @ " _ device _ port)
	while ('$get(^%ZAPM.bs.BSFTconf("stopsig"), 0)) {
		use device
		read buf:1
		if ($test) {
			set ip = $A($ZU(111,0),1)_"."_$A($ZU(111,0),2)_"."_$A($ZU(111,0),3)_"."_$A($ZU(111,0),4)_":"_($A($ZU(111,0),5)*256+$A($ZU(111,0),6))
			do PutLog("New connection detected from " _ ip)
			job NewThread:(:5:device:device)
			if ($zchild = 0) do PutLog("Daemon can't create new thread!")
		}
	}
	close device
	set ^%ZAPM.bs.BSFTconf("PID") = ""
	do PutLog("Daemon killed.")
	quit
	;
NewThread
	new s, cmd, pn, logoutsig
	set logoutsig = 0
	do PutLog("Client thread has been started." _ $principal)
PopCmd
	set $ztrap = "TErrHandler"
	while (1) {
		if ($$WaitSinhro(10)) {
			write !
			if ($$SocGet(.s, 2)) {
				set cmd = $ascii(s, 1), pn = $ascii(s, 2)
				do PutLog("Client -> cmd = " _ cmd _ "; par_num = " _ pn)
				do $case(cmd, 64:cmdTEST, 1:cmdGETFILE, 2:cmdPUTFILE, 3:cmdGETLIST, 4:cmdLOGOUT, 5:cmdDELFILE, 7:cmdLOGIN, 8:cmdFILESIZE, :cmdUNKNOWN)
			} else {
				quit
			}
			quit:(logoutsig || $get(^%ZAPM.bs.BSFTconf("stopsig"), 0))
		}
	}
	if (logoutsig) {
		do PutLog("Client logged out. Thread closes.")
	}
	close $principal
	quit
	;
cmdUNKNOWN
	do PutLog("Unknown command has been detected. <" _ cmd _ ">")
	do SocPut(1, "Unknown command ID:" _ cmd)
	quit
	;
cmdTEST
	do PutLog("Client -> CMD_TEST")
	do SocPut(8, "I'm here!")
	quit
	;
cmdLOGOUT
	do PutLog("Client -> CMD_LOGOUT")
	do SocPut(0, "Session logged out")
	set logoutsig = 1
	quit
	;
cmdDELFILE
	new FName
	do PutLog("Client -> CMD_DELFILE")
	do GetStrParam(.FName)
	do PutLog("Client -> CMD_DELFILE -> filename = " _ FName)
	if ('##class(%File).Exists(FName)) {
		do SocPut(13, "File didn't exists.")
		quit
	}
	if ('##class(%File).Delete(FName)) {
		do SocPut(13, "Can't delete file.")
		quit
	}
	do SocPut(0, "File was deleted.")
	quit
	;
cmdGETFILE
  new FName, FLen, DataBuf, BlockLen
  do PutLog("Client -> CMD_GETFILE")
  do GetStrParam(.FName)
  do PutLog("Client -> CMD_GETFILE -> filename = " _ FName)
  do GetIntParam(.BlockLen)
  do PutLog("Client -> CMD_GETFILE -> blocksize = " _ BlockLen)
  set SrcFile = ##class(%File).%New(FName)
  set ok = SrcFile.Open("RU")
  if 'ok do SocPut(13, "Can't open specified file.") quit
  set FLen = SrcFile.SizeGet
  if (FLen > 0) {
    do SocPut(6, "Ready to send.")
    write $zlc(FLen)
  } Else {
		do SrcFile.Close()
		do SocPut(13, "Zero-length file. Nothing to send.")
    quit
  }
  while (FLen > 0) {
    if (FLen < BlockLen) set BlockLen = FLen
    set DataBuf = SrcFile.Read(BlockLen)
    write DataBuf
    set FLen = FLen - $length(DataBuf)
  }
  do SrcFile.Close()
  do SocPut(0, "Transfer successed: "_FName_", length: "_SrcFile.SizeGet)
  ;do SocFlush()
	quit
	;
cmdPUTFILE
  new FName, FLen, DataBuf, BlockLen
  do PutLog("Client -> CMD_PUTFILE")
  do GetStrParam(.FName)
  do PutLog("Client -> CMD_PUTFILE -> filename = " _ FName)
  do GetIntParam(.FLen)
  do PutLog("Client -> CMD_PUTFILE -> filesize = " _ FLen)
  Do GetIntParam(.BlockLen)
  do PutLog("Client -> CMD_PUTFILE -> blocklen = " _ BlockLen)
  set DestFile = ##class(%File).%New(FName)
  set ok = DestFile.Open("WSN")
  if ('ok) do SocPut(13, "Can't open specified file.") quit
  do SocPut(6, "Ready to receive.")
  while (FLen > 0) {
    if (FLen < BlockLen) set BlockLen = FLen
  	read DataBuf#BlockLen:15
  	do DestFile.Write(DataBuf)
  	set FLen = FLen - BlockLen
  }
  do DestFile.Close()
  do SocPut(0, "Transfer succeed. "_FName_" length: "_(DestFile.SizeGet - FLen))
  ;do SocFlush()
	quit
	;
cmdGETLIST
	new mode, path, wc, rset, ResultBuf
	do PutLog("Client -> CMD_GETLIST")
	do GetStrParam(.path)
	do PutLog("Client -> CMD_GETLIST -> path = " _ path)
	do GetStrParam(.wc)
	do PutLog("Client -> CMD_GETLIST -> wildcard = " _ wc)
	do GetIntParam(.mode)
	do PutLog("Client -> CMD_GETLIST -> mode = " _ mode)
  if ('##class(%File).DirectoryExists(path)) {
    do SocPut(13, "Specified path didn't exists.")
    quit
  }
  set rset = ##class(%ResultSet).%New("%Library.File:FileSet")
  do rset.Execute(path, wc, "ItemName", 1)
  set ResultBuf = ""
  while (rset.Next(.fEnt)) {
    if ($SYSTEM.Status.IsOK(fEnt)) {
		  if (mode = "1") {
		  	set ResultBuf = ResultBuf _ rset.Data("ItemName") _ ":" _ rset.Data("Type")
		  	if (rset.Data("Type") = "F") {
		  		set ResultBuf = ResultBuf _ ":" _ rset.Data("Size")
		  	} else {
			  	set ResultBuf = ResultBuf _ ":<DIR>"
			  }
		  	set ResultBuf = ResultBuf _ ";"
	  	} elseif (mode = "0") {
				if (rset.Data("Type") = "F") {
	      	set ResultBuf = ResultBuf _ rset.Data("ItemName") _ ":" _	rset.Data("Size") _ ";"
				}
		  } elseif (mode = "2") {
	  	  if (rset.Data("Type") = "D") {
	    	  set ResultBuf = ResultBuf _ rset.Data("ItemName") _ ";"
		    }
		  }
    }
  }
  if ($SYSTEM.Status.IsError(fEnt)) {
    do SocPut(13, "Query error.")
    quit
  } else {
	  do SocPut(6, "Ready to send. Block length:" _ $zlc($length(ResultBuf)))
	  write $zlc($length(ResultBuf))
  }
  do rset.Close()
  if ($length(ResultBuf) > 0) {
  	;do SocPut(6, "Ready to send. Folder content.")
  	write ResultBuf
  }
  do SocPut(0, "All done.")
  ;do SocFlush()
	quit
	;
cmdFILESIZE
	new FileName, FileSize
	do PutLog("Client -> CMD_FILESIZE")
	do GetStrParam(.FileName)
	do PutLog("Client -> CMD_FILESIZE -> path = " _ FileName)
	if ('##class(%File).Exists(FileName)) {
		do SocPut(13, "Specified file didn't exists.")
		quit
	}
	set FileSize = ##class(%File).GetFileSize(FileName)
	do PutLog("Client -> CMD_FILESIZE -> size = " _ FileSize)
	do SocPut(6, "Ready to send. File size.")
	write $zlc(FileSize)
	do SocPut(0, "All done.")
	quit
	;
cmdLOGIN
	new user, pass, root, rights
	do PutLog("Client -> CMD_LOGIN")
	do GetStrParam(.user)
	do PutLog("Client -> CMD_LOGIN -> user = " _ user)
	do GetStrParam(.pass)
	do PutLog("Client -> CMD_LOGIN -> pass = " _ pass)
	do GetStrParam(.root)
	do PutLog("Client -> CMD_LOGIN -> root = " _ root)
	do GetStrParam(.rights)
	do PutLog("Client -> CMD_LOGIN -> rights = " _ rights)
	; проверка параметров и установка loguotsig в 1 или возврат
	do SocPut(7, "Ident OK")
	quit
	;
GetIntParam(num, tout)
	new result
	set result = $$SocGet(.num, 4, 5)
	set num = $zla(num)
	quit result
	;
GetStrParam(str, tout)
	new result, len
	set result = $$SocGet(.len, 4, 5)
	set result = $$SocGet(.str, $zla(len), 5)
	quit result
	;
SocFlush()
	read *a:1 quit:((a = -1) || '$test)
	quit 1
	;
SocGet(str, len, tout)
	set len = $get(len, 0), tout = $get(tout, 5)
	if (len = 0) quit 0
	read str#len:tout
	quit ($test && ($length(str) = len))
	;
SocPut(code, msg)
	new pack
	do SocFlush()
	set pack = $zlchar(+$get(code)) _ $zlchar($length($get(msg))) _ $get(msg)
	write pack, !
	quit
	;
WaitSinhro(tout)
  new i, a, t1, za 
  set i=0, tout = $get(tout, 5), t1 = $zh
  while (1) {
		quit:((i = 4) || $get(^%ZAPM.bs.BSFTconf("stopsig"), 0) || ((tout > 0) && ($zh-t1 > tout)))
		read *a:1 
		set za = $za, zh = $zh
		if (a > 0) set i = $select(a=254:i+1, 1:0)
		;do PutLog("SYNHRO -> a = "_a_"; i = "_i)
  }
  quit (i = 4)
  ;
PutLog(text)
	quit:('$get(^%ZAPM.bs.BSFTconf("log"), 1))
	new i set i = $get(^%ZAPM.bs.BSFTlog, 0)
	set ^%ZAPM.bs.BSFTlog(i) = text
	set ^%ZAPM.bs.BSFTlog = i + 1
	quit
	;
]]></Routine>


<Routine name="%ZAPM.bs.BSkod" type="MAC" languagemode="0"><![CDATA[
%BSkod ; пpогpамма  (А.Тимофеев) ; 10:28   14.03.99
 
 N %FN S ls=" Будем загружать кодификатор из файла ? " D YES^%ZAPM.bs.BSF I YES'=1 Q
 I YES=0 Q
 
EXPORT ;СЧИТЫВАНИЕ DOS-ФАЙЛА
 S B=1 K %BS("Tmp","DosFiles") N %zT,FR,%IN,%IN1,%IN2,INF,ops,s,s1,PREK,OBR,EF,%DEV,XN
REST S %FN="" D DosRead^%ZAPM.bs.BSS1(51,%FN) I '$D(%FN) S STOP=1 Q
 I $D(%BS("Tmp","DosFiles")) S XN="" F  S XN=$O(%BS("Tmp","DosFiles",XN)) G:XN="" XNE D XNOPN I $D(%FN) D XN
XN U 0 S %I=$I,%zT=$ZT,$ZT="ER^%ZAPM.bs.BSkod" S FR=%DEV U %DEV R %IN   ;G:$ZC'=0 CLO^%ZAPM.bs.BSBL1
RES ;
 K ^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u")
 ;U 0 D ErrMsg^%ZAPM.bs.BSXfun("У ФАЙЛА "_%FN_" Не тот ФОРМАТ !!!") D CLO^%ZAPM.bs.BSBL1 Q
I U 0 S ls="ВВОД ИНФОРМАЦИИ..." D WAITS^%ZAPM.bs.BSF2 S STOP="",s=1,s1=0
 D  Q:STOP=1  F s=2:1 U %DEV R %IN D  Q:STOP=1  Q:$ZC'=0
 .S INF=$E(%IN,1)  ;I INF="" S STOP=1 Q
 .S s1=s1+1 S ^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u",s1)=$E(%IN,1,80) Q
QQ S $ZT=$G(%zT) U 0 D OkMsg^%ZAPM.bs.BSXfun("ФАЙЛ "_%FN_" СЧИТАН",2) D CLO^%ZAPM.bs.BSBL1 G ZAP
 
ER U 0 I $ZE["<INRP" S ls=" ПРЕРВАНО..." G ERE
 I $ZE["<ENDOFFILE" G QQ
 I $ZE["<MXSTR" S ls=" Слишком длинная строка считана " G ERE
 S ls=$ZE
ERE S $ZT=$G(%zT) D O^%ZAPM.bs.BSF7,CLO K:$E($G(BST),1)="@" @(BSR_"(BST)") G END^%ZAPM.bs.BSF
 
 
XNOPN N DOS K %DEV,%FN S DOS=$$OpenDOS^%ZAPM.bs.BSXdos() Q:DOS<0
 Q:$$Open^%ZAPM.bs.BSXdos(XN,"R")<0  S %DEV=DOS,%FN=XN Q
XNE K %BS("Tmp","DosFiles") Q
 
ZAP ;ПРОВЕРКА И ЗАПИСЬ В БПО
 N %IN,Stop,DOP,s,sh,EF,NF,NF1,OP,INF,s1,t,t1,IND,Nf,%zT
 S B=1,%I=$I,%IN="",%zT=$ZT,$ZT="ERR^%ZAPM.bs.BSDDR2"
 S ^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u")="БУФЕР @@@@@@@1@1@22@80@@@@1@@5@@@1@@@@@@@@@@@1;6;36;44//1;6;36;40@@@@@@@1"
 S $P(^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u"),"@",17)=5
TXT S ls=" Пpовеpить и откоppектиpовать ? " D YES^%ZAPM.bs.BSF I YES=1 S STOP="" D  Q:STOP=1
 .D ^%ZAPM.bs.BSX("EDIT","^%ZAPM.bs.BSbufB","PO"_$G(%BS(3),$P)_$J_"u")
 .S ls=" Заносим ?  " D YES^%ZAPM.bs.BSF I YES=1 Q
 .S STOP=1 Q
 S Buf="^%ZAPM.bs.BSbufB",Ind="PO"_$G(%BS(3),$P)_$J_"u"
 
SAVE Q:STOP=1
 S Edit=""
 N MAS,i,Uci,mas,mas1,Str,str,Tab,tab,sim,l1,l2,l3,s1,s2,s3,s4,s5,v1,v2,v3,v4,v5,Del
 S Del="",ls=" Удаляем существующие массивы ? " D YES^%ZAPM.bs.BSF I YES=1 S Del=1
1 S %I=$I S %zT=$ZT,$ZT="STOP"
 S ls="Создание кодификатора..." D WAITS^%ZAPM.bs.BSF2
 D 333^%ZAPM.bs.BSF
 I '$D(@(BSD_"(k1)")) Q
 ; Выборка атрибутов описания кодификатора
 S Uci=$G(@BSD@(k1,"uci")),mas=$G(@BSD@(k1,"mas")),Str=$G(@BSD@(k1,"str"))
 S mas="^["""_$P(Uci,",")_""","""_$P(Uci,",",2)_"""]"_$P(mas,"^",2)
 S l1=$G(@BSD@(k1,"l1")),l2=$G(@BSD@(k1,"l2")),l3=$G(@BSD@(k1,"l3")),sim=$G(@BSD@(k1,"sim"))
 I l1=""!(l2="") Q
 I Str'="" D
 .S tab=$G(@BSD@(k1,"tab")),mas1=$G(@BSD@(k1,"mas1")),mas1="^["""_$P(Uci,",")_""","""_$P(Uci,",",2)_"""]"_$P(mas1,"^",2)
 .S (s1,s2,s3,s4,s5,v1,v2,v3,v4,v5)=""
 .S s1=$G(@BSD@(k1,"s1")),v1=$G(@BSD@(k1,"v1")) I s1="" Q
 .S s2=$G(@BSD@(k1,"s2")),v2=$G(@BSD@(k1,"v2")) I s2="" Q
 .S s3=$G(@BSD@(k1,"s3")),v3=$G(@BSD@(k1,"v3")) I s3="" Q
 .S s4=$G(@BSD@(k1,"s4")),v4=$G(@BSD@(k1,"v4")) I s4="" Q
 .S s5=$G(@BSD@(k1,"s5")),v5=$G(@BSD@(k1,"v5"))
 I Edit=1 Q
 ;                  ;Создание кодификатора
 D L^%ZAPM.bs.BS3(mas) I Del=1 K @(mas),@(mas1)
 S @(mas)="%BS-invert-^"_tab_"@@@@@"_$$h^%ZAPM.bs.BS3()_"@@1"
 S i="" F  S i=$O(@Buf@(Ind,i)) Q:i=""  D  X $G(WA)
 .S str=$G(@Buf@(Ind,i))
 .I str=""!(str=" ") Q
 .X "S kod=$E(str,"_l1_")" S kod=$$KUT(kod)
 .X "S zn1=$E(str,"_l2_")" S zn1=$$KUT(zn1)
 .I l3'="" X "S zn2=$E(str,"_l3_")" S zn2=$$KUT(zn2)
 .I kod=""!(kod'=+kod) Q
 .S ved=$S($L(kod)=s1&(v1'=1):1,$L(kod)=s2&(v2'=1):1,$L(kod)=s3&(v3'=1):1,$L(kod)=s4&(v4'=1):1,$L(kod)=s5&(v5'=1):1,1:"")
 .I ved="" S @mas@(1,kod)=zn1_$S($G(zn2)'="":$G(sim),1:"")_$G(zn2)
 .I Str'="" D       ;Создание узла структурного кодификатора
 ..I s1=""  Q
 ..I s5'="" S @mas1@($E(kod,1,s1),$E(kod,1,s2),$E(kod,1,s3),$E(kod,1,s4),$E(kod,1,s5),kod,"kod")=kod,^("ved")=$S(ved="":1,1:""),^("str")=zn1  Q
 ..I s4'="" S @mas1@($E(kod,1,s1),$E(kod,1,s2),$E(kod,1,s3),$E(kod,1,s4),kod,"kod")=kod,^("ved")=$S(ved="":1,1:""),^("str")=zn1  Q
 ..I s3'="" S @mas1@($E(kod,1,s1),$E(kod,1,s2),$E(kod,1,s3),kod,"kod")=kod,^("ved")=$S(ved="":1,1:""),^("str")=zn1  Q
 ..I s2'="" S @mas1@($E(kod,1,s1),$E(kod,1,s2),kod,"kod")=kod,^("ved")=$S(ved="":1,1:""),^("str")=zn1  Q
 ..S @mas1@($E(kod,1,s1),kod,"kod")=kod,^("ved")=$S(ved="":1,1:""),^("str")=zn1  Q
 I Str'="" D        ;Корекция описания таблицы с БД структурного
 .N KIP,SYS,TAB,PART,Tab
 .S Tab="^["""_$P(Uci,",")_""","""_$P(Uci,",",2)_"""]"_$P(tab,",")_"("""_$P(tab,",",2)_""")"
 .S MAS=$P(Tab,"(")
 .I '$D(@MAS) S @MAS="BaSe MsW @@@"
 .D Copy^%ZAPM.bs.BSF8("^%ZAPM.bs.BSDDR(""KOD2"")",Tab,"",1)
 .S @Tab@("KEY")=mas1
 .S KIP=$P(Uci,","),SYS=$P(Uci,",",2),TAB=$P(tab,",",2),PART=$P(tab,",")
 .S @mas1="BSD - MSW@^[""GLAVK""]"_PART_"@"_TAB
 .I s5'="" D  Q
 ..S @Tab@("KEY",1,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",2,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",3,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",4,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",5,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$E($G(d0),1,"_s4_"),$G(d0),$G(d0))"
 ..S @Tab@("KEY",6,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$E($G(d0),1,"_s4_"),$E($G(d0),1,"_s5_"),$G(d0))"
 ..S @Tab@("KEY",1,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",2,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",3,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",4,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",5,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$E($G(d0),1,"_s4_"),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",6,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$E($G(d0),1,"_s4_"),$E($G(d0),1,"_s5_"),$G(d0)}"
 .I s4'="" D  Q
 ..K @Tab@("KEY",6)
 ..S @Tab@("KEY",1,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",2,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",3,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",4,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$G(d0),$G(d0))"
 ..S @Tab@("KEY",5,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$E($G(d0),1,"_s4_"),$G(d0))"
 ..S @Tab@("KEY",1,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",2,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",3,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",4,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",5,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$E($G(d0),1,"_s4_"),$G(d0)}"
 .I s3'="" D  Q
 ..K @Tab@("KEY",5),@Tab@("KEY",6)
 ..S @Tab@("KEY",1,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",2,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",3,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0),$G(d0))"
 ..S @Tab@("KEY",4,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$G(d0))"
 ..S @Tab@("KEY",1,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",2,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",3,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",4,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$E($G(d0),1,"_s3_"),$G(d0)}"
 .I s2'="" D  Q
 ..K @Tab@("KEY",4),@Tab@("KEY",5),@Tab@("KEY",6)
 ..S @Tab@("KEY",1,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0))"
 ..S @Tab@("KEY",2,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0))"
 ..S @Tab@("KEY",3,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E$G(d0),1,"_s2_"),$G(d0))"
 ..S @Tab@("KEY",1,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",2,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0),$G(d0)}"
 ..S @Tab@("KEY",3,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$E($G(d0),1,"_s2_"),$G(d0)}"
 .I s1'="" D  Q
 ..K @Tab@("KEY",3),@Tab@("KEY",4),@Tab@("KEY",5),@Tab@("KEY",6)
 ..S @Tab@("KEY",1,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0))"
 ..S @Tab@("KEY",2,3)="S d1=$G(d0)_"" ""_$$A^%ZAPM.bs.BSA(2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0))"
 ..S @Tab@("KEY",1,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$G(d0),$G(d0)}"
 ..S @Tab@("KEY",2,4)="$G(d0)_"" ""_{2,1,"""_TAB_""","""_PART_""","""_KIP_""","""_SYS_""","""",$E($G(d0),1,"_s1_"),$G(d0)}"
 
GLO ;Характеристики глобалов
 S ls=" Хаpатеpистики ! " D WAITS^%ZAPM.bs.BSF2 N nGLB
 F %GLB=mas,mas1,MAS D  X $G(WA)
 .D CP^%ZAPM.bs.BSGCH(%GLB,4444)
 D U^%ZAPM.bs.BS3(mas)
 S $ZT=%zT D OkMsg^%ZAPM.bs.BSXfun(" Кодификатор готов !! ",4)
 Q
 
KUT(%1) ;Обрезка пробелов в названии
 I %1="" S %0="" Q %0
 N t,t1 S t1=""
 F t=1:1:$L(%1) D  Q:t1'=""
 .I $E(%1,t)'=" " S t1=t Q
 I t1'=0 S %1=$E(%1,t1,$L(%1))
 S t1="" F t=$L(%1):-1:1 D  Q:t1'=""
 .I $E(%1,t)'=" " S t1=t Q
 I t1'=$L(%1) S %1=$E(%1,1,t1)
 S %0=%1 Q %0
 
TEXT ;Загрузка из текста
 D RIT^%ZAPM.bs.BSF3 I 'YES Q
 S Buf=BSr,Ind=BSt,STOP="" G SAVE
 
KOR ;Обновление кодификатора
 N MAS,i,Uci,mas,mas1,Str,str,Tab,tab,sim,l1,l2,l3,s1,s2,s3,s4,s5,v1,v2,v3,v4,v5
 S Edit=1 D 1 N i,i1,i2,i3,i4,i5,i6,ved
 D L^%ZAPM.bs.BS3(mas) S ls="Обновление кодификатора..." D WAITS^%ZAPM.bs.BSF2
 S i="" F  S i=$O(@mas@(i)) Q:i=""  K @mas@(i)
 S i="" F  S i=$O(@mas1@(i)) Q:i=""  D  X $G(WA)
 .S i1="" F  S i1=$O(@mas1@(i,i1)) Q:i1=""  D
 ..I s2="" S i6=$G(@mas1@(i,i1,"str")),ved=$G(^("ved")) S:ved'="" @mas@(1,i1)=i6 Q
 ..S i2="" F  S i2=$O(@mas1@(i,i1,i2)) Q:i2=""  D
 ...I s3="" S i6=$G(@mas1@(i,i1,i2,"str")),ved=$G(^("ved")) S:ved'="" @mas@(1,i2)=i6 Q
 ...S i3="" F  S i3=$O(@mas1@(i,i1,i2,i3)) Q:i3=""  D
 ....I s4="" S i6=$G(@mas1@(i,i1,i2,i3,"str")),ved=$G(^("ved")) S:ved'="" @mas@(1,i3)=i6 Q
 ....S i4="" F  S i4=$O(@mas1@(i,i1,i2,i3,i4)) Q:i4=""  D
 .....I s5="" S i6=$G(@mas1@(i,i1,i2,i3,i4,"str")),ved=$G(^("ved")) S:ved'="" @mas@(1,i4)=i6 Q
 .....S i5="" F  S i5=$O(@mas1@(i,i1,i2,i3,i4,i5)) Q:i5=""  D
 ......S i6=$G(@mas1@(i,i1,i2,i3,i4,i5,"str")),ved=$G(^("ved")) S:ved'="" @mas@(1,i5)=i6 Q
 S $ZT=%zT D OkMsg^%ZAPM.bs.BSXfun(" Кодификатор готов !! ",4)
 D U^%ZAPM.bs.BS3(mas) Q
 
STOP S $ZT=%zT I $ZE["<PROT" D ErrMsg^%ZAPM.bs.BSXfun("Нельзя сделать запись в этом кипе!!!") D U^%ZAPM.bs.BS3(mas) Q
 W $ZE R *R D U^%ZAPM.bs.BS3(mas) D ErrMsg^%ZAPM.bs.BSXfun("Выполнение прервано !!") Q
]]></Routine>


<Routine name="%ZAPM.bs.BSmirGL" type="MAC" languagemode="0"><![CDATA[
%BSmirGL ;ПРОГРАММА РАБОТЫ С ГЛОБАЛЬНЫМИ БУФЕРАМИ ; 17:01   21.07.2003
 ;
 ;    Copyright Serge Mikhaylenko
 ;    			Andry Mirenburg
 ;    All Rights Reserved
 ;
 ;
 Q
LISTPART1() ;ВЕРНУТЬ СПИСОК РАЗДЕЛОВ
 N A
 S A=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSETUP")
 S A=$P($G(@A@("SERVER",8,4)),"@",15)
 Q A
LISTPART2() ;ВЕРНУТЬ СПИСОК РАЗДЕЛОВ - ЭМУЛЯЦИЯ $$BSR^%ZAPM.bs.BSCi(...) ////!!! ПЕРЕДЕЛАТЬ КАК В $$GD^%ZAPM.bs.BSCp(
 ;P1=КОЛИЧЕСТВО
 ;P2=ТИПЫ_$C(1)_"...
 ;P3=КОМЕНТАРИИ_$C(1)_"...
 ;VALUE="GL1"_$C(1)_"GL2~..." МАССИВЫ
 N B,I
 S B=$$LISTPART1(),P2="",P3=""
 F I=1:1 Q:$P(B," ",I,I+1)=""  S P2=P2_"P"_$C(1) D
 .S A=$G(@($P(B," ",I)))
 .S P3=P3_$P(A,"@",2)_$C(1)
 S P1=I-1
 D MAINVAR^%ZAPM.bs.BSC4,GlobBuff(.BB) I $D(BB) S C0="" F  S C0=$O(BB(C0)) Q:C0=""  D
 .S P1=P1+1,P2=P2_"P"_$C(1),P3=P3_$P($G(@BB(C0)),"@",2)_$C(1),B=B_" "_BB(C0)
 Q $TR(B," ",$C(1))
LISTTAB(G) N C,i,I,ii    ;ВЕРНУТЬ СПИСОК ТАБЛИЦ
 S C="",P1=0,P4="",P3="",P2=""
 S I="" F  S I=$O(@G@(I)) Q:I=""  S ii=$G(@G@(I)) D
 .S P4=P4_$P(ii,"@",17)_$C(1)              ;ТИПЫ
 .S P2=P2_$$TIP^%ZAPM.bs.BS($P(ii,"@",17))_$C(1)  ;ТЕКСТ ТИПОВ
 .S P3=P3_$P(ii,"@")_$C(1)               ;КОМЕНТАРИИ
 .S C=C_I_$C(1),P1=P1+1
 Q C
RELOADL() S BSLABEL="LISTP^~BSmirGL"
 Q "<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' title='Обновить окно'><img src='"_BSDOMAIN_"/img/refr.gif' border=0></A>"_BK
VAR  /*
 Включенный Параметр "AsysEInoActivX" в "Синем молотке" оставляет только три кнопки в режиме "Готовые отчеты" 
   - Предварительный просмотр
   - Экспорт в Exсel без разбора по полям
   - Экспорт в Exсel с разбором по полям
  Отстальные выключает
 */
 S noE=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","AsysEInoActivX") 
 S noE2=0 //ЗАПУСКАТЬ ВНЕШНИЕ ПРИЛОЖЕНИЯ ПО НОВОМУ - ЧЕРЕЗ ПЕВДОГИПЕРСОБЫТИЯ
 Q 
LISTP ;ВЫВЕСТИ ВСЕ ГЛОБАЛЬНЫЕ БУФЕРА toolbar_icon_menu.gif
 I $G(^%ZAPM.bs.BS("Config"))="ASU" g AllPart^%ZAPM.bs.BSCrep
 D VAR
 I noE2 D  Q
 .D BEG1^%ZAPM.bs.BSC4 W "<H2><img border=0 src='"_BSDOMAIN_"/img/toolbar_icon_menu.gif' ALT=''> Выбирайте разделы готовых отчетов</H2>"
 .D JS^%ZAPM.bs.BSCp
 .w "parent.U1.location='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"LISTPno^~BSmirGL")_"';"_BK
 .D JSE^%ZAPM.bs.BSCp
 .D END^%ZAPM.bs.BSC4
LISTPno D BEG1^%ZAPM.bs.BSC4,VAR
 N BSGRANT,BSTOP,BSTOP1,C0,C1,NT,BB,A
 S B=$$LISTPART1() 
 I noE2 W "<H1 class=s3><CENTER><font color=#FFFFFF>Готовые отчеты"_EF_"</CENTER></H1>"
 W "<TABLE border=0 width=100% >"
 W "<TR><TD class=s3 WIDTH=40% >"_$$RELOADL_"Список глобальных буферов</TD><TD  WIDTH=5% class=s3>Количество</TD><TD class=s3>Комментарий</TD></TR>"
 F I=1:1 Q:$P(B," ",I,I+1)=""  W $$PART($P(B," ",I))
 W "<TR><TD class=s3 WIDTH=15% >Личный раздел</TD><TD  WIDTH=5% class=s3>Количество</TD><TD class=s3>Комментарий</TD></TR>"
 W $$PART($$cB^%ZAPM.bs.BSSV)
 d   W $$PART(A)
 .n %BS,BSLOGIN s (%BS(12),BSLOGIN)="NoNameUser",A=$$cB^%ZAPM.bs.BSSV
  N GetAccLU I $$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGIN,"TRMA")>3!($g(aCCrep)>4) D  //ТЕРМИНАЛЬНЫЙ ДОСТУП ! tabel2005         //АДМИНИСТРАТОР СМОТРИТ ВСЕ ЛОКАЛЬНЫЕ БУФЕРА
 .S C0="" D
 ..W "<TR><TD class=s3 WIDTH=15% >Список локальных буферов</TD><TD  WIDTH=5% class=s3>Количество</TD><TD class=s3>Комментарий</TD></TR>"
 ..D GlobBuff(.BB) I $D(BB) S C0="" F  S C0=$O(BB(C0)) Q:C0=""  I C0'=BSLOGIN W $$PART(BB(C0))
 W "<TR><TD class=s3 WIDTH=40% ></TD><TD WIDTH=5% class=s3></TD><TD class=s3 ALIGN=RIGHT>"_$$RELOADL_"</TD></TR>"        
 W "</TABLE>"
 W "<div style='display:none;' id='ReportS2'><IFRAME HEIGHT='1400px' width=900px SRC='' name='ReportS3' SCROLLING='auto'></IFRAME></div>"
 D END^%ZAPM.bs.BSC4
 Q
GlobBuff(BB) N C0,NT //ВЕРНУТЬ СУЩЕСТВУЮЩИЕ БУФЕРА
 S C0="" F  S C0=$O(@BDUSE@(C0)) Q:C0=""  D
 .N A S A=$$SW^%ZAPM.bs.BSF12("^%ZAPM.bs.BSbufS")
 .S NT=$NA(@(A_$$2LAT^%ZAPM.bs.BSCp(C0)))
 .I $$Data^%ZAPM.bs.BSF12(NT) S BB(C0)=NT I $G(@NT)="" S @NT="BaSe MsW @Глобальный буфер"
 Q
PART(P) N A1,A2,C0,C1,BSGRANT S A1="<TR><TD class=s1>",A2="</TD></TR>"
 I '$$Data^%ZAPM.bs.BSF12(P) Q A1_"<BUTTON DISABLED title='раздел не доступен'>"_P_"</BUTTON></TD><TD class=s1>0</TD><TD class=s1>"_RED_"раздел не доступен"_EF_A2
 S C1="",C0=0 F  S C1=$O(@P@(C1)) Q:C1=""  I "12345"[$P($G(@P@(C1)),"@",17) S C0=C0+1
 S BSLABEL="REPORTS^~BSmirGL",BSmirPART=$$%T^%ZAPM.bs.BSCh(P),NamF="ReportS3" //,NamF="Par"_$$FrameName(P)
 //I noE2 S NamF="D1"
 //S Q=A1_"<BUTTON onclick=""javascript: "_NamF_"=window.open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"','"_NamF_"','toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1'); "_NamF_".close(); "_NamF_"=window.open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"','"_NamF_"','toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1');"" title='Открыть список из "_C0_" таблиц'>"_P_"</BUTTON>"
 S Q=A1_"<BUTTON onclick=""open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"','"_NamF_"','toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1'); ReportS2.style.display='block';"" title='Открыть список из "_C0_" таблиц'>"_P_"</BUTTON>"
 s a3=$P($G(@P),"@",2) i a3="" s a3="раздел пользователя"
 S Q=Q_"</TD><TD class=s1>"_C0_"</TD><TD class=s1>"_a3_A2_BK
 Q Q
FrameName(P) I P["]" Q $P(P,"]",2)
 I P["%" Q $P(P,"%",2)
 Q P
 /*
 var NW;  ($2==null)
</SCRIPT>
 <INPUT type=button onclick="javascript:NW=window.open('','','width=725,height=500,resizable=yes,left=100,top=100');">
 <INPUT type=button onclick="javascript:NW.close();">
 */
BOF ;НАЧАЛО ФАЙЛА HTML(Фреймовая структура)
 w "<HTML>",BK,"<HEAD>",BK,"<TITLE>",$G(CAPTION),"</TITLE>"
 w "</HEAD>",BK
 q
 
EOF ;ЗАВЕРШЕНИЕ ФАЙЛА HTML
 w "</HTML>",BK
 q
CALL(SP) N I,S,GT,DEL,A 
 I $G(SP),$D(@BDSES@(BSSES,"VAR","SPOOL",BSmirTAB)) D  Q
 .S GT=$ZR F I=1:1 Q:'$D(@GT@(I))  W @GT@(I)
 //ВЫВОД ПРИ ОТСУТСВИИ СПУЛЕРА
 S GT="ZZZ",DEL=$C(13,10)
 S A=$$BS2EXCEL^%ZAPM.bs.BSCi($NA(@P@(BSmirTAB)),GT,1,1000,DEL,"","","","")
 F I=1:1:A W @GT@(I)_DEL
 Q
CVAL i $d(BSmirPART) S P=$$%^%ZAPM.bs.BSCh(BSmirPART)
 i $g(BSitem)'="" d  //это готовится в PartList^%ZAPM.bs.BSCp2
 .s a=$$b64d^%ZAPM.bs.BSCp2(BSitem)
 .s BSmirTAB=$qs(a,$ql(a)),P=$p(a,""""_BSmirTAB) i $e(P,$l(P))="," s P=$e(P,1,$l(P)-1)_")"
 .i $e(P,$l(P))="(" s P=$e(P,1,$l(P)-1)
 Q
CALLCSV  D CVAL
 W $P(@P@(BSmirTAB),"@",1)_BK
 S I="",CSVD=$P($G(@P@(BSmirTAB,"CSV",0),",|"),",",2),ke=$P($G(@P@(BSmirTAB,"CSV",0),",|"),",",3)
 F  S I=$O(@P@(BSmirTAB,"CSV",1,I)) Q:I=""  S A=$TR($G(@P@(BSmirTAB,"CSV",1,I)),BK,"") W A_BK
 Q
CALL1 D CVAL
 ;I P["^^" S P=$$TR^%ZAPM.bs.BSsFUNM(P,"^^","^")
 D CALL(0)
 q
SPOOL(BSmirTAB) I $D(@BDSES@(BSSES,"VAR","SPOOL",BSmirTAB)) Q "SPOOL"
 Q ""
CALL2 //ПРЕДВАРИТЕЛЬНЫЙ ПРОСМОТР
 D BEG1^%ZAPM.bs.BSC4 D CVAL
 S SP=$$SPOOL(BSmirTAB)
 w "<TITLE>"_SP_" "_$P($G(@P@(BSmirTAB)),"@",1)_"</TITLE>"_BK_$$B27^%ZAPM.bs.BSCm4() D BUTTS
 w "<PRE>"_BK
 D CALL(1)
 w "</PRE>"_BK
 D END^%ZAPM.bs.BSC4
 q
BUTTS   I $D(@P@(BSmirTAB,"SQL")) d  q
			.s BSLABEL="BUTTSQLOUT^~BSmirGL"
 			.w "<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' title='Вывести таблицу данных без оформления'><IMG  src='"_BSDOMAIN_"/img/sql.gif'  border=0 ></A>"
	//проверка на существованиние в тексте пробелов между *****  *****
	I $p(@P@(BSmirTAB),"@",17)=5 x $G(@P@(BSmirTAB,"RUN")) q
	Q
BUTTCSV	s BSLABEL="BUTTCSVOUT^~BSmirGL"
 	w "<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' title='Вывести таблицу данных в формате CSV с разделителем |'><IMG  src='"_BSDOMAIN_"/img/sql.gif'  border=0 ></A> "
 	s BSLABEL="BUTTCSVOUT1^~BSmirGL"
 	w "<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' title='Сохранить на диске таблицу данных в формате CSV с разделителем |'><IMG  src='"_BSDOMAIN_"/img/save.gif'  border=0 ></A>"
	;D OutSpool^%ZAPM.bs.BSCpool("S OK=$$MSETSQL^%ZAPM.bs.BSCBD($NA(@P@(BSmirTAB,""SQL"")))")
 	;s BSLABEL="HELPSQL^~BSmirGL"
 	;w " <A TARGET=HELPSQL HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' title='Показать как обратиться к данным этой таблицы по ODBC'><IMG  src='"_BSDOMAIN_"/img/help1.gif'  border=0 ></A>"
	Q
BUTTCSVOUT1  W "HTTP/1.0 200 OK",BK
 W "Content-type: text/comma-separated-values",BK //text/html
 ;W "Set-Cookie: cookie_name=cookie_value; path=/;",CRLF
 ;W "Window-target: main_window",CRLF
 W BK D CSVOUT
 Q
HELPSQL W 222
	Q
CSVOUT D CVAL N FIRST //САМ ВЫВОД
 	S I="" F i=1:1 S I=$O(@P@(BSmirTAB,"SQL",I)) Q:I=""  S:'$D(FIRST) FIRST=I D  W BK
 	.F II=1:1:$O(@P@(BSmirTAB,"SQL",FIRST,""),-1)  W $G(@P@(BSmirTAB,"SQL",I,II))_"|"
 	Q
BUTTCSVOUT W "<PRE>"_BK	D CSVOUT W "<PRE>"	
	Q
BUTTSQLOUT D BEG1^%ZAPM.bs.BSC4 D CVAL w "<TITLE> "_$P($G(@P@(BSmirTAB)),"@",1)_"</TITLE>"_BK_$$B27^%ZAPM.bs.BSCm4()  D BUTTCSV
	W "<TABLE border=0>" N FIRST
 	S I="" F i=1:1 S I=$O(@P@(BSmirTAB,"SQL",I)) Q:I=""  S:'$D(FIRST) FIRST=I W "<TR>" D  W "</TR>"
 	.F II=1:1:$O(@P@(BSmirTAB,"SQL",FIRST,""),-1)  W "<TD class=s1>"_$G(@P@(BSmirTAB,"SQL",I,II))_"</TD>"
	W "</TABLE>"
	D END^%ZAPM.bs.BSC4
	Q
REPORTS ;Фреймы
 s BSmirFlag=0,TITL="GP:"_$$%^%ZAPM.bs.BSCh(BSmirPART)_" = Список отчетов раздела"
 N Tmp W $$TITL^%ZAPM.bs.BSCGIS(TITL)
 D VAR //i 'noE2 G LIST
 W "<FRAMESET rows=""0%,*%,0%""  framespacing=0 border=false frameborder=0 >"_BK
 S BSLABEL="ACTIVEX^~BSmirGL"
 n BSmirAsText
 s BSmirAsText="true"
 W "<FRAME SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' NAME='ACTIVEX' noresize frameborder=0 name='logo' SCROLLING='no'>"_BK
 k BSmirAsText
 S BSLABEL="LIST^~BSmirGL"
 S BSmirFlag=1
 W "<FRAME SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' NAME='LIST' frameborder=0 >"_BK
 W "<FRAME SRC=""/iss/RD/RunDos.htm"" name='rd1' frameborder=0 >"_BK
 W "</FRAMESET>"
 Q
ACTIVEX ;Элемент T2E
 D BEG1^%ZAPM.bs.BSC4 S FFLAG=$G(BSaX,1) //0-СТАРАЯ ВЕРСИЯ ACTIV-X
 w BK_"<HTML>"_BK_"<HEAD>"_BK_"<TITLE>ext2e.CAB</TITLE>"_BK_"</HEAD>"_BK_"<BODY>"
 ;w "<nobr><INPUT title='Экспорт в MS-EXCEL без разбора по полям' NAME=""AsText"" TYPE=""CHECKBOX"""
 ;W $G(BSmirAsText) ;="true" w " checked='true' "
 ;w "> Экспорт в MS-EXCEL без разбора по полям. "
 I BSmirFlag'=1 W $$js^%ZAPM.bs.BSCp_$$Status^%ZAPM.bs.BSCm4("...Выбирайте режим работы с таблицами")_$$jse^%ZAPM.bs.BSCp_BK
 I BSmirFlag=1 {
 S FREEZ=$$FREEZ I FREEZ1'="" S FREEZMAC="w.xls!Лист2.DPAP("""_FREEZ1_""","""_FREEZ2_""");"
 E  S FREEZMAC=""
 W $$js^%ZAPM.bs.BSCp_$$Status^%ZAPM.bs.BSCm4(" ...Ждите идет загрузка в MS-EXCEL")_$$jse^%ZAPM.bs.BSCp_BK
 
 
 I FFLAG=1 D  I 1 //ПОКА ТОЛЬКО ДЛЯ МЕНЯ
 .W "<OBJECT ID='Preparation' CLASSID='clsid:56F7E626-77D3-11D6-82F9-00A02479C353'>"_BK
 .//W "<PARAM NAME=FileName VALUE='c:\tabl.txt'>"_BK
 .I FREEZ'="" D
 ..W "<PARAM NAME=FilePattern VALUE='http://"_$$ADDSN^%ZAPM.bs.BSC4_"/vv/u/bin/w.xls'>"_BK
 ..W "<PARAM NAME=Macro VALUE='Лист2;w.xls!Лист2.DSR("""_FREEZ_""","_(+$G(ToInt))_");"_FREEZMAC_"'>"_BK
 E  w "<OBJECT ID='T2E' CLASSID='CLSID:7574C5B9-B43D-11D6-A477-0004761A76C9' CODEBASE='"_BSDOMAIN_"/js/ext2e.CAB#version=1,0,0,0'>"_BK
 n I,J,K
 s I="",J="",K="",BSLABEL="CALL1^~BSmirGL"
 I CSV'="" W "<PARAM NAME=CSV VALUE=1>"_BK D  S BSLABEL="CALLCSV^~BSmirGL"
 .W "<PARAM NAME=Start VALUE=2>"_BK
 .W "<PARAM NAME=Del VALUE='"_CSVD_"'>"_BK
 w "<PARAM NAME='FileName' VALUE='http://"_$$ADDSN^%ZAPM.bs.BSC4_$$ADDBSGET^%ZAPM.bs.BSC4_"'>",BK
 W "<PARAM NAME=AllSeparator VALUE=''>"_BK
 W "<PARAM NAME=VerticalSeparator VALUE=''>"_BK
 W "<PARAM NAME=HorizontalSeparator VALUE=''>"_BK
 W "<PARAM NAME=ANSI1_ASCII2_Default0 VALUE=0>"_BK
 W "<PARAM NAME=ExcelVisible VALUE=0>"_BK
 W "<PARAM NAME=TypeBorder VALUE=0>"_BK
 i BSmirAsText="false" w "<PARAM NAME=""AsText"" VALUE=0>",BK
 i BSmirAsText="true" w "<PARAM NAME=""AsText"" VALUE=1>",BK
 w "</OBJECT>"_BK
 }
 w "<BR></BODY>"_BK_"<BR></HTML>"
 D END^%ZAPM.bs.BSC4
 Q
COLS(JJ) N A S A=","_$$COL_"," I A'[(","_JJ_",") Q "" 
 S AA=$P(A,","_JJ_",",1)
 Q $L(AA,",")
COLN(JJ) I JJ=0 S JJ=1
	Q $P($$COL,",",JJ)
COL() N A 
 S A="A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,AA,AB,AC,AD,AE,AF,AG,AH,AI,AJ,AK,AL,AM,AN,AO,AP,AQ,AR,AS,AT,AU,AV,AW,AX,AY,AZ,BA,BB,BC,BD,BE,BF,BG,BH,BI,BJ,BK,BL,BM,BN,BO,BP,BQ,BR,BS,BT,BU,BV,BW,BX,BY,BZ,CA,CB,CC,CD,CE,CF,CG,CH,CI,CJ,CK,CL,CM,CN,CO,CP,CQ,CR,CS,CT,CU,CV,CW,CX,CY,CZ,DA,DB,DC,DD,DE,DF,DG,DH,DI,DJ,DK,DL,DM,DN,DO,DP,DQ,DR,DS,DT,DU,DV,DW,DX,DY,DZ,EA,EB,EC,ED,EE,EF,EG,EH,EI,EJ,EK,EL,EM,EN,EO,EP,EQ,ER,ES,ET,EU,EV,EW,EX,EY,EZ"
 S A=A_",FA,FB,FC,FD,FE,FF,FG,FH,FI,FJ,FK,FL,FM,FN,FO,FP,FQ,FR,FS,FT,FU,FV,FW,FX,FY,FZ,GA,GB,GC,GD,GE,GF,GG,GH,GI,GJ,GK,GL,GM,GN,GO,GP,GQ,GR,GS,GT,GU,GV,GW,GX,GY,GZ,HA,HB,HC,HD,HE,HF,HG,HH,HI,HJ,HK,HL,HM,HN,HO,HP,HQ,HR,HS,HT,HU,HV,HW,HX,HY,HZ,IA,IB,IC,ID,IE,IF,IG,IH,II,IJ,IK,IL,IM,IN,IO,IP,IQ,IR,IS,IT,IU,IV"
 Q A
FREEZ()
 N I,J,FREEZ,G,I,II,J,JJ,X,Y,A,AA
 S P=$$%^%ZAPM.bs.BSCh(BSmirPART),FREEZ1="",FREEZ2=""
 S EO=$P($G(@P@(BSmirTAB,"ExcelOut")),",",1)
 S CSV=$G(@P@(BSmirTAB,"CSV")),CSVD=$P($G(@P@(BSmirTAB,"CSV",0),",|"),",",2)
 S (AA,I)=$P(@P@(BSmirTAB),"@",50),X=$P(I,",",2),Y=$P(I,","),G=$ZR
 I AA="" S (AA,I)=$P(@P@(BSmirTAB),"@",19),X=$P(I,",",2),Y=$P(I,",")
 I AA="" Q ""  ;"A1"
 S II=0 F I=1:1:(Y-1) S II=II+$P(@G@(I,1),"@",3)
 S JJ=0,II=II+1-3 F J=1:1:X I $P(@G@(1,J),"@",4)'=1 S JJ=JJ+1
 S FREEZ=$$COLN(JJ)_II
 I +$P(EO,"@") S FREEZ1="$"_(II-$P(EO,"@"))_":$"_(II-1)
 I +JJ S:JJ=1 JJ=2 S FREEZ2="$A:$"_$$COLN(JJ-1)
 
 ;W $$js^%ZAPM.bs.BSCp         W "alert('"_JJ_"')"_BK               W $$jse^%ZAPM.bs.BSCp_BK
 
 Q FREEZ
noE D locvar^%ZAPM.bs.BSCh0("",1)
 q
LIST ;Список сводок из заданного массиваC
 S TITL="Список отчетов"
 D BEG1^%ZAPM.bs.BSC4,VAR  W $$TITL^%ZAPM.bs.BSCGIS(TITL) i 'noE2 w $$B27^%ZAPM.bs.BSCm4("parent.")
 D BACK N BSNOREG,BSTOP2
 D VAR
 w "<script language=""JavaScript"">",BK
 w "function UPDATEACTIVEX(URLmir,MODE1) {",BK
 I noE2 d  
 .s BSLABEL="ACTIVEX^~BSmirGL",BSmirFlag=1
 .w "parent.ACTIVEX.location='"_$$ADDBSGET^%ZAPM.bs.BSC4_"'+URLmir+'&BSmirAsText='+MODE1;",BK
 E  d
 .//загрузка в Excel текста из URL НОВАЯ ОПЦИЯ У put2registr.exe
 .W "var u2='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"HyperRunwin^~BSCp2")_"&BSa1=put2registr.exe&BSa3="_$$DR^%ZAPM.bs.BSCp2_"&BSa2=inbuff&BSa4='+MODE1+URLmir;"_BK
 .;;W "alert(u2);"_BK
 .W "window.open(u2,""ACTIVEX"",""toolbar=no,menubar=no,scrollbars=yes,width=1,height=1,status=1,resizable=1"");"_BK
 w "}",BK
 
 w "function VIEW(URLmir){",BK
 //W "alert(URLmir);"_BK
 s BSLABEL="ACTIVEX^~BSmirGL",BSmirFlag=0
 I 'noE w "parent.ACTIVEX.location='"_$$ADDBSGET^%ZAPM.bs.BSC4_"';",BK
 E  s BSLABEL="CALL2^~BSmirGL" D
 .w "window.open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"'+URLmir,'view',""toolbar=no,menubar=yes,scrollbars=yes,width=800,height=600,status=1,resizable=1"");"_BK
 w "}",BK
 
 w "function TELNET(EDIT,TABL,TITLE) {",BK
 s BSLABEL="ACTIVEX^~BSmirGL",BSmirFlag=0
 w "parent.ACTIVEX.location='"_$$ADDBSGET^%ZAPM.bs.BSC4_"';",BK
 w "parent.rd1.RDos.RunOption=1;"_BK
    S P=$$%^%ZAPM.bs.BSCh(BSmirPART) ;ОБРАТНО
 w "parent.rd1.RDos.WorkDir=parent.rd1.RDos.DvDir();"_BK                 // /c=1 - 132
 S FTerm=$$FTerm^%ZAPM.bs.BSCmDDR
 ;;;;;;;;;;;;;;;;;;;;;;;;;N tcpPORT S tcpPORT=$$PORT^%ZAPM.bs.BSpgTEL i tcpPORT="" k tcpPORT
 ////////////// CTERM
 ;пример                     'BSCacheTel.exe 190.98.101.61 /x=^[""GLAVK""]GlobTAB /s=Styx /t='+TABL+' /y='+EDIT+' /f='+TITLE+'(mswdell)_ /i=121' ;
 I FTerm=1 w "parent.rd1.RDos.Command='BSCacheTel.exe "_$p($$ADDSN^%ZAPM.bs.BSC4,":")_" /x="_$$TR^%ZAPM.bs.BSsFUNM(P,$C(34),$C(34,34))_" /p="_$G(tcpPORT,$G(TelPort,23))_" /s="_BSLOGIN_" /t='+TABL+' /v="_$$VerTelnet^%ZAPM.bs.BSCp_" /y='+EDIT+' /f="_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE+' /i="_BSSES_"' ;"_BK
 ;а выполняется программа    D BST^%ZAPM.bs.BSC("","[""GLAVK""]GlobTAB","GLAVK__JIL!1!Q50301_2","1","","Styx","121")
 ;
 //////////////// SOCKTERM
 ;пример                     AdvSockTerm.exe server="mswdell" port="23" user="SYS" psw="XXX" cmdline="D ^%SS" title="asasas"
 I FTerm=2 D
 .W "var cmdline='""D BST^^%ZAPM.bs.BSC("""""","""""_$$TR^%ZAPM.bs.BSsFUNM(P,$C(34),$C(34,34,34))_""""",""""'+TABL+'"""",""""'+EDIT+'"""","""""""","""""_BSLOGIN_""""","""""_BSSES_""""")'; "_BK
 .;W "alert(cmdline);"_BK
 .w "parent.rd1.RDos.Command='AdvSockTerm.exe server="""_$p($$ADDSN^%ZAPM.bs.BSC4,":")_""" port="""_$G(tcpPORT,$G(TelPort,23))_""" user=""SYS"" psw=""XXX"" cmdline=""'+cmdline+'"" title="""_$$nse^%ZAPM.bs.BSCmDDR_"'+TITLE+'""' ;"_BK
 ////////////////
 
 w "parent.rd1.RDos.RunCommand();"_BK
 w "}",BK
 
 w "function DVSTART(URLmir) {",BK
 s BSLABEL="ACTIVEX^~BSmirGL",BSmirFlag=0
 w "parent.ACTIVEX.location='"_$$ADDBSGET^%ZAPM.bs.BSC4_"';",BK
 w "parent.rd1.RDos.RunOption=1;"_BK
 w "parent.rd1.RDos.WorkDir=parent.rd1.RDos.DvDir();"_BK
 D
 .N A S A=BSmirPART N BSmirPART,BSLOGINDFLT,BSGRAND,BSLNG
 .s BSLABEL="CALL1%5E~BSmirGL",BSEXT="txt",BSmirPART=$$TR^%ZAPM.bs.BSsFUNM(A,"^","%5E")
 .;W "prompt('!!!!','DV.exe http://"_$$ADDSN^%ZAPM.bs.BSC4_$TR($$ADDBSGET^%ZAPM.bs.BSC4,"&|","*@")_"'+URLmir);"_BK
 .w "parent.rd1.RDos.Command='DV.exe http://"_$$ADDSN^%ZAPM.bs.BSC4_$TR($$ADDBSGET^%ZAPM.bs.BSC4,"&|","*@")_"'+URLmir;"_BK
 .w "parent.rd1.RDos.RunCommand();"_BK
 .w "}",BK
 /*
 
 BSEXT= - РАСШИРЕНИЕ ПО КОТОРОМУ dv БУДЕТ ЗАПУСКАТЬ ТО ЧТО ПРИДЕТ ПО http
    txt - ЗАГРУЖАЕТ tv
 
 */
 w "</script>",BK
 //---Контекстное меню  ---
 D OnContextMenu^%ZAPM.bs.BSmirJS
 W "<SCRIPT>var BSmirTAB_oncontext = 0;</SCRIPT>"
 //---
 n I,J,K,TRMA,SPO,ST,TIT,DIS,nn,TIT1,zBS4cfg 
 s I="",J="",K=""  N GetAccLU S TRMA=$$GetAcc^%ZAPM.bs.BSC4cfgP(BSLOGIN,"TRMA") //ТЕРМИНАЛЬНЫЙ ДОСТУП РАЗРЕШЕН ЛИ
 I P=$$cB^%ZAPM.bs.BSSV S TRMA=5
 W "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="Act^~BSmirGL"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 
 w "<TABLE WIDTH=100% border=""0"">"
 w "<TR><TD class=s3>"_$$RELOAD_" Имя Таблицы</TD><TD class=s3>Действие</TD><TD class=s3>Комментарий к таблице, находящейся в разделе <strong>"_RED_P_EF_"</strong></TD><TD class=s3>"_$$ChKill("CKA","Удалить все таблицы")_""_$$SUB_"</TD></TR>"
 f nn=1:1 s I=$O(@P@(I)) q:I=""  i $e(I,1)'="@" d
 .w "<TR>" N CSV,COM,STS S COM=$P(@P@(I),"@",1) ;КОМЕНТАРИЙ
 .S DIS="DISABLED",TIT="Занята пользователем! ",ST=2,RAZ=$$RAZ,SPO=$$SPOOL(I)
 .L +@P@(I):0 I  S DIS="",TIT="",ST=1 L -@P@(I)
 .S TIT1=$S(SPO'="":"",1:TIT) I $D(@P@(I,"CSV")) S CSV=$G(@P@(I,"CSV",0)),RAZ=$$RAZ1($P(CSV,",",1),$P(CSV,",",3)),TIT="SQL-отчет."
 .S ImG="" I $G(BSnewREPORT)=I S STS=4,ImG="<img src='"_BSDOMAIN_"/img/access.gif' WIDTH=15 border=0> " //ТЕКУЩИЙ ОТЧЕТ
 .I COM[";ПУСТ" S DIS="",TIT="Пустая! ",SPO="",ST=2
 .I COM["ОШИБКА" S DIS="DISABLED",TIT="ОШИБКА! ",SPO="",ST=2
 . I "Su"[$E(I,1,2) S ST=1
 .w "<TD TITLE='"_$$LAST_"' class=s"_$G(STS,ST)_">"_ImG_I_"</TD>"
 .W "<TD class=s"_$G(STS,ST)_">"_BK
 .W "<BUTTON onclick=""VIEW('&BSmirTAB="_I_"');"" "_$S(SPO="":DIS,1:"")_" title='"_TIT1_"Предварительный просмотр "_SPO_"'><img src='"_BSDOMAIN_"/img/view"_$S(SPO="":"_"_ST,1:"-")_".gif' border=0></BUTTON>"_BK
 .I I["AsIs"!("SuLi"[$E(I,1,2)) D  //НОВЫЙ ТАБЕЛЬ
 ..N BSPART,BSTABL,BSEXT,BSGRANT,BSLOGINDFLT,BSLastForm,BSTOP,BSaX,BSdebug,BSform,BSmenu,BStyle
 ..S BSmirTAB=I,TI1="Экспорт в EXCEL"_BK_BK_$$TIT^%ZAPM.bs.BSCAsIsMod(P,I)
 ..W "<BUTTON onclick=""open('"_$$ADDBSGET^%ZAPM.bs.BSC4(,"LOAD^~BSCAsIs5")_"','NewExcel','toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1')"" "_DIS_" title='"_TIT_$G(TI1)_"'><img src='"_BSDOMAIN_"/img/xls_"_ST_".gif' WIDTH=15 border=0></BUTTON>"_BK
 .E  D  //СТАРЫЙ ТАБЕЛЬ
 ..W "<BUTTON onclick=""UPDATEACTIVEX('&BSmirTAB="_I_"','true');"" "_DIS_" title='"_TIT_"Экспорт в EXCEL без разбора по полям'><img src='"_BSDOMAIN_"/img/bsx_"_ST_".gif' WIDTH=15 border=0></BUTTON>"_BK
 ..W "<BUTTON oncontextmenu='BSmirTAB_oncontext="""_I_"""; showmenuie5();return false;' onclick=""javascript:UPDATEACTIVEX('&BSmirTAB="_I_"','false')"" "_DIS_" title='"_TIT_"Экспорт в EXCEL с разбором по полям. "_$C(10)_" По правой клавише мыши доступны "_$C(10)_" дополнительные опции'><img src='"_BSDOMAIN_"/img/xls_"_ST_".gif' border=0></BUTTON>"_BK
 ..I 'noE W "<BUTTON onclick=""javascript:DVSTART('*BSmirTAB="_I_"')"" "_DIS_" title='"_TIT_"Загрузить в программу DocumentView'><img src='"_BSDOMAIN_"/img/bsdoc_"_ST_".gif' WIDTH=14 border=0></BUTTON>"_BK
 .I 'noE I TRMA=2 w "<BUTTON onclick=""javascript:TELNET('0','"_I_"','"_I_"')"" "_DIS_" title='"_TIT_"Смотреть таблицу в терминальном режиме'><img src='"_BSDOMAIN_"/img/term_"_ST_".gif' border=0></BUTTON>"_BK
 .I 'noE I TRMA>2 w "<BUTTON onclick=""javascript:TELNET('1','"_I_"','"_I_"')"" "_DIS_" title='"_TIT_"Редактировать таблицу в терминальном режиме'><img src='"_BSDOMAIN_"/img/term_"_ST_".gif' border=0></BUTTON>"_BK
 .W "</TD>"
 .w "<TD TITLE='"_TIT_"' class=s"_$G(STS,ST)_">"_RAZ_COM D  W "</TD>"
 .W "<TD class=s"_$G(STS,ST)_">"_BK
 .W $$ChKill("CK"_nn,TIT_"пометить для удаления",$S(COM[";ПУСТ"!(COM["ОШИБКА"):"",1:DIS))
 .W "</TD></TR>"_BK
 S ST="" i nn=1 S ST="таблиц в разделе нет"
 i nn>1 S ST="Всего "_(nn-1)_" таблиц(а)"
 W "<TR><TD class=s3></TD><TD class=s3></TD><TD class=s3>"_ST_"</TD><TD class=s3>"_$$RELOAD_"</TD></TR>"_BK
 w "</TABLE></FORM>"_BK
 D BACK D END^%ZAPM.bs.BSC4
 Q
LAST() N Y,X S Y=$G(@P@(I,"LST")) I Y="" Q TIT
 Q $$TD^%ZAPM.bs.BSC4base($P(Y,",",1,2))_" "_$P(Y,",",3,9)
RAZ() N Y,X S Y=$O(@P@(I,"A"),-1),X=$O(@P@(I,1,"A"),-1)
RAZ2 Q "<font TITLE='размерность таблицы' color=Red>"_AF_"("_Y_"x"_X_")</font></font>"
RAZ1(Y,X) G RAZ2
Act //Удалить таблицы
 D BEG1^%ZAPM.bs.BSC4
 S P=$$%^%ZAPM.bs.BSCh(BSmirPART)
 N FLAG S I=""
 f nn=1:1 s I=$O(@P@(I)) q:I=""  d
 .I $D(CKA) L +@P@(I):0 Q:'$T  K @P@(I) L -@P@(I) S FLAG=$G(FLAG)+1 Q
 .I $D(@("CK"_nn)) L +@P@(I):0 Q:'$T  D  L -@P@(I)
 ..K @P@(I) S FLAG=$G(FLAG)+1 Q
 W "Удалено '"_+$G(FLAG)_"' узел(а,ов)<BR>"_BK_BBK_BBK
 D BACK
 G LIST
 Q
RELOAD() i $g(noE) q ""
 Q "<BUTTON ONCLICK='parent.location.reload();' title='Обновить окно {F5}'><img src='"_BSDOMAIN_"/img/refr.gif' border=0></BUTTON>"_BK
SUB()    I TRMA'>2 Q ""
 Q "<BUTTON NAME=DELTAB tabindex=0 onclick='submit();' TITLE='Удалить таблицы, помеченные к удалению'><img src='"_BSDOMAIN_"/img/del.gif' border=0></BUTTON>"
 ;Q "<INPUT NAME=DELTAB TYPE=SUBMIT TITLE='Удалить таблицы, помеченные к удалению' value='Удалить'>"
ChKill(NAME,TITLE,ATR)
 I TRMA'>2 Q ""
 Q "<INPUT NAME="_NAME_" TYPE=CHECKBOX TITLE='"_TITLE_"' "_$G(ATR)_" >"
BACK Q  //```
 s BSLABEL="LISTP^~BSmirGL"
 w "<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"' target='D1' title='Список глобальных буферов'>Назад<IMG  src='"_BSDOMAIN_"/img/back.gif'  border=0 ></A>"
 Q
rep //загрузка таблиц раздела
 n P,BSLABEL2,BSFRM2,BSNSP2,BSTOP,BSarm,BSac
  I $G(^%ZAPM.bs.BS("Config"))="ASU" g AllTabl^%ZAPM.bs.BSCrep
 s P=$$cB^%ZAPM.bs.BSSV
 s BSmirPART=$$%T^%ZAPM.bs.BSCh(P)
 d REPORTS^%ZAPM.bs.BSmirGL
 q
]]></Routine>


<Routine name="%ZAPM.bs.BSout" type="MAC" languagemode="0"><![CDATA[
%BSout ;Опции вывода таблицы и параметры принтера (А.Тимофеев) ; 14:21  2-DEC-98
 
OPout(%1,%2,%3) ;ОПЦИИ ВЫВОДА ; %1-PRN (1),DOS (2),TXT (3); %2 - BSR, %3 - BST
 
 I $G(%1)="" Q
 S:$G(%2)="" %2=$G(BSR) S:$G(%3)="" %3=$G(BST) I BSR=""!(BST="") Q
 
0 N im,it,i,i1,BSRold,BSTold,BSr1,BSr2,BSt1,BSt2,zap,%zT
 S %zT=$ZT,$ZT="1^%ZAPM.bs.BSout"
 S im="^%ZAPM.bs.BSS",it="OPout"
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"),^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")
 
 S zap=$S(%1=1:"PRN",%1=2:"HFS",%1=3:"TXT",1:"COM"),BSR=%2,BST=%3
 D
 .I $D(@(BSR_"(BST,zap)")) S in=@(BSR_"(BST,zap)") I in["@" K @(BSR_"(BST,zap)"),in
 .I $D(in) F i=1:1:7 S @("in"_i)=$P(in,"#",i) Q:i=7
 .I $D(@(BSR_"(BST,zap)")) Q
 .F i=1:1:7 S @("in"_i)=$P($P(^%ZAPM.bs.BSS("OPout1",%1+1,1),"@",15),"#",i)
 
 ;Копирование таблицы опций в буфер
 
 K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u")
 S BSr1="^%ZAPM.bs.BSS",BSt1="OPout",BSr2="^%ZAPM.bs.BSbufB",BSt2="fTS"_$G(%BS(3),$P)_$J_"u" D COPY^%ZAPM.bs.BSTK
 F i=1:1:7 S i1=i*2,$P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i1,2),"@",15)=$G(@("in"_i))
 ;```S BSRold=BSR,BSTold=BST
 ;```S BSR="^%ZAPM.bs.BSbufB",BST="fTS"_$G(%BS(3),$P)_$J_"u"
 ;```S IYI=BSR_"("_BST D NE^%ZAPM.bs.BSN
 S IYI="^%ZAPM.bs.BSbufB"_"("_"fTS"_$G(%BS(3),$P)_$J_"u" D NE^%ZAPM.bs.BSN
 ;```S BSR=BSRold,BST=BSTold
 
 ;Выборка новых настроек
 I $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",16,2),"@",15)=0 K in G 1
 S in=""
 F i=1:1:7 S i1=i*2 S @("in"_i)=$P($G(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i1,2)),"@",15) S:i=1 in=@("in"_i) S:i'=1 in=in_"#"_@("in"_i)
 I $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",16,2),"@",15)=1 G 1
 S @(BSR_"(BST,zap)")=in
 
1 ;The end
  S $ZT=$G(%zT)
  K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u")
  Q
 
OPprn(%2,%3) ;Параметры принтера ;%2 - BSR, %3 - BST
 S:$G(%2)="" %2=$G(BSR) S:$G(%3)="" %3=$G(BST) I BSR=""!(BST="") Q
 S BSR=%2,BST=%3
 N i,st,str,BSRold1,BSTold1,%zT,S,SS,SSS,zBSR,zBST
 S %zT=$ZT,$ZT="2^%ZAPM.bs.BSout"
 
 K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u")
 S BSr1="^%ZAPM.bs.BSS",BSt1="OPout0",BSr2="^%ZAPM.bs.BSbufB",BSt2="fTS"_$G(%BS(3),$P)_$J_"u" D COPY^%ZAPM.bs.BSTK
 S BSRold1=BSR,BSTold1=BST
 S zBSR="^%ZAPM.bs.BSbufB",zBST="fTS"_$G(%BS(3),$P)_$J_"u" ;```!!!!! НЕЛЬЗЯ ПЕРЕОПРЕДЕЛЯТЬ BSR,BST
 I $D(@%2@(%3,"SHR")) S S=@$ZR I S'["27," F SS=1:1:3 I $P($P(S,$S(S["@":"@",1:"#"),SS),",") D
 .S SSS=$P($P(S,$S(S["@":"@",1:"#"),SS),","),$P(@zBSR@(zBST,SSS-1,2),"@",15)="Y"
 S IYI=zBSR_"("_zBST D NE^%ZAPM.bs.BSN ;```  ДЛЯ ТАКОГО ВЫЗОВА !!!!!
 S BSR=BSRold1,BST=BSTold1
 
 ;Установка новых настроек
 K @(BSR_"(BST,""SHR"")")
 S str="" F i=2:1:13 S st=$P($G(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,2)),"@",15) D
 .I i<6 S:st="Y" $P(@(BSR_"(BST,""SHR"")"),"#")=$P($G(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,1)),"@",15) Q
 .I i>5&(i<12) S:st="Y" $P(@(BSR_"(BST,""SHR"")"),"#",2)=$P($G(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,1)),"@",15) Q
 .S:st="Y" $P(@(BSR_"(BST,""SHR"")"),"#",3)=$P($G(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,1)),"@",15) Q
 
2 ;The end
 S $ZT=$G(%zT)
 K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u")
 Q
 
3 ;Обработка клавиш в таблице опций принтера
 Q:R1>332
 I R1=13&(R2=-1)&(R3=-1) D  S R1=-2 D W^%ZAPM.bs.BST Q
 .I ny<6 D  S $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",ny,2),"@",15)="Y" Q
 ..F i=1:1:5 S $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,2),"@",15)=""
 .I "6,7,8,9"[ny!(ny=10)!(ny=11) D  S $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",ny,2),"@",15)="Y" Q
 ..F i=6:1:11 S $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,2),"@",15)=""
 .I ny=12!(ny=13) D  S $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",ny,2),"@",15)="Y" Q
 ..F i=12,13 S $P(^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u",i,2),"@",15)=""
 I R1=27 Q
 Q
 
BLout ;Формирование блока и посылка на вывод блока
 
 I $P(@(BSR_"(BST)"),"@",3)'=1 D ErrMsg^%ZAPM.bs.BSXfun(" Нет пометки блока !! ") Q
 I '$D(%CAL) D CALC^%ZAPM.bs.BSF3             ;вычисления
 S BsrO=BSR,BstO=BST,%zT=$ZT,$ZT="END^%ZAPM.bs.BSout"
 I $$BL^%ZAPM.bs.BSout4(BSR,BST)=0 Q
 S BSR="^%ZAPM.bs.BSbufB",BST="L"_$G(%BS(3),$P)_$J_"u"
 D OkMsg^%ZAPM.bs.BSXfun("Блок готов !!!",6)
 S OO=55,OOO="^%ZAPM.bs.BS" D ^%ZAPM.bs.BSB S LAB=$TR(%JB(%JB),",","")_%B
 I LAB="111" D Kout^%ZAPM.bs.BSout0(1) K in G END   ;ТАБЛИЦА НА ПРИНТ.
 I LAB="121" D Kout^%ZAPM.bs.BSout0(2) K in G END   ;        В ФАЙЛ
 I LAB="131" D Kout^%ZAPM.bs.BSout0(3) K in G END   ;        В ТЕКСТ
 I LAB="141" D Kout^%ZAPM.bs.BSout0(4) K in G END   ;        НА РТА
 I LAB="21" D DTout^%ZAPM.bs.BSout3(1) G END   ;ДАННЫЕ НА ПРИНТ.
 I LAB="22" D DTout^%ZAPM.bs.BSout3(2) G END   ;        В ФАЙЛ
 I LAB="23" D DTout^%ZAPM.bs.BSout3(3) G END   ;        В ТЕКСТ
 I LAB="24" D DTout^%ZAPM.bs.BSout3(4) G END   ;        НА РТА
 
END ;The end
 S $ZT=$G(%zT)
 S BSR=BsrO,BST=BstO D W^%ZAPM.bs.BST
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSout0" type="MAC" languagemode="0"><![CDATA[
%BSout0 ; Карта вывода  (А.Тимофеев) ; 17:38   09.09.99
 
Kout(%1,%2,%3) ;Формирование карты
 ; %1-PRN (1),DOS (2),TXT (3),COM (4); %2 - BSR, %3 - BST
 
 I $G(%1)="" Q
 S:$G(%2)="" %2=$G(BSR) S:$G(%3)="" %3=$G(BST)   ;I BSR=""!(BST="") Q
 N i,i1,i2,i3,zap,ot,ls,hs,tit,tip,ot,lty,rdy,ltx,rdx,kw,kx,ky,lx,ly,st,rp,%zT,IYI,ZapK
 S %zT=$ZT,$ZT="2^%ZAPM.bs.BSout0"
 S zap=$S(%1=1:"PRN",%1=2:"HFS",%1=3:"TXT",1:"COM"),BSR=%2,BST=%3
 ;Выбор установок ; ls-симв. в строке,hs-строк на стр.
 
 S ls="Формируется карта вывода !" D WAITS^%ZAPM.bs.BSF2
 D
 .I $D(in) D  Q
 ..F i=1:1:7 S @("in"_i)=$P(in,"#",i) Q:i=7
 .I $D(@(BSR_"(BST,zap)")) I $G(@(BSR_"(BST,zap)"))'["@" D  Q
 ..S in=@(BSR_"(BST,zap)") F i=1:1:7 S @("in"_i)=$P(in,"#",i) Q:i=7
 .F i=1:1:7 S @("in"_i)=$P($P(^%ZAPM.bs.BSS("OPout1",%1+1,1),"@",15),"#",i)
 S ls=$S(in2'=0:in2,1:$$LNG^%ZAPM.bs.BSF12),hs=$S(in3'=0:in3,1:999999)
 
 ;Определение титула;, tit - коорд. тит., tipt - тип титула
 
 S ot=$G(@(BSR_"(BST)")),tit=$P(ot,"@",19),tip=$P(ot,"@",17)
 I $P(ot,"@",50) S tit=$P(ot,"@",50) ;ТИТУЛ ПЕЧАТИ```MSW
 I in5?.N1",".N S tit=in5 ;|||
 S tipt=$S($G(tit)="":1,in5=0:1,$P(tit,",")=1&($P(tit,",",2)=1):1,$P(tit,",")=1&($P(tit,",",2)'=1):2,$P(tit,",")'=1&($P(tit,",",2)=1):3,1:4)
 K ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u")
 
 ;Запись установок
 D  S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","TXT")=%1_"#"_in1        ;устройство + N устройства
 .I %1=1 D
 ..I $D(@(BSR_"(BST,""SHR"")")) S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","SHR")=$G(@(BSR_"(BST,""SHR"")"))
 ..S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","DOS")=in4_"#"_in6 Q      ;отступ + режим печати
 
 ;Длина и высота титула lt-длина,ht-высота
 S (lt,ht)=0 D
 .I tipt=1 Q
 .I tipt=2 D  Q
 ..F i=1:1:$P(tit,",",2) S lt=lt+$P(@(BSR_"(BST,1,i)"),"@",4)
 .I tipt=3 D  Q
 ..F i=1:1:$P(tit,",") S ht=ht+$P(@(BSR_"(BST,i,1)"),"@",3)
 .F i=1:1:($P(tit,",")-1) S ht=ht+$P(@(BSR_"(BST,i,1)"),"@",3)
 .F i1=1:1:($P(tit,",",2)-1) S lt=lt+$P(@(BSR_"(BST,1,i1)"),"@",4)
 
 ;Создание карты
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u")="@@@@@1@1@1@1@22@80@1@@1@@1@1@@2,2@1@@@@@1@@@6@3@@1;6;33;44@@@@@@@@@@3^%ZAPM.bs.BSout0"
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,1)="1@1@3@15@@@@@1@1;6;33;44@@@@@ <ENTER>-Экран  <F2> - Вывод   <F3> - Опции"
 S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","PRN")=BSR_"#"_BST_"#"_$G(%BS(15))
 
 ;Первая строка
 ;y-длина карты, y1-длина колонки, kw-номер карты, kx-координата по х, i3-последняя колонка, i2-номер колонки
 S (y,y1,kw,i,i2,i3)=0,i1=1,kx=16
 F  S i=$O(@(BSR_"(BST,1,i)")) Q:i=""  D   X $G(WA) S i3=i
 .S y1=$P($G(@(BSR_"(BST,1,i)")),"@",4) D:y1=+y1  S y=y+y1
 ..I (y+y1)>($$ls()-$S(kw=0:0,1:lt)) D
 ...S y=0,kw=kw+1,i2=kw+1
 ...S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,i2)="1@"_kx_"@3@10@@@@@1@1;6;33;45@@@@@Колонка  :"_kw_"         #"_$S(tipt=1!(i1=1):"",i1'=1&(tipt=2!(tipt=4)):1_":1:"_($P(tit,",",2)-1)_",",1:"")_i1_":1:"_(i-1)
 ...S kx=kx+10,i1=i Q
 I y'=0 D
 .S kw=kw+1,i2=kw+1
 .S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,i2)="1@"_kx_"@3@10@@@@@1@1;6;33;45@@@@@Колонка  :"_kw_"         #"_$S(tipt=1!(i1=1):"",i1'=1&(tipt=2!(tipt=4)):1_":1:"_($P(tit,",",2)-1)_",",1:"")_i1_":1:"_i3 Q
 
 ;Первая колонка
 S (y,y1,kw,i,i2,i3)=0,i1=1,ky=4
 F  S i=$O(@(BSR_"(BST,i)")) Q:'i  D  X $G(WA) S:i=+i i3=i
 .S y1=$P($G(@(BSR_"(BST,i,1)")),"@",3) D:y1=+y1  S y=y+y1
 ..S st=$E($P($G(@(BSR_"(BST,i,1)")),"@",15),1)
 ..I (hs'=+hs&(st=hs))!(hs=+hs&(y+y1>(hs-$S(kw=0:0,1:ht)))) D     ; > длины или разделитель страниц
 ...S y=0,kw=kw+1,i2=kw+1
 ...S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",i2,1)=ky_"@1@3@15@@@@@1@1;6;33;45@@@@@Страница :"_kw_"    #"_$S(tipt=1!(i1=1):"",i1'=1&(tipt=3!(tipt=4)):1_":1:"_($P(tit,",")-1)_",",1:"")_i1_":1:"_(i-1)
 ...S ky=ky+3,i1=i Q
 I y'=0 D
 .S kw=kw+1,i2=kw+1
 .S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",i2,1)=ky_"@1@3@15@@@@@1@1;6;33;45@@@@@Страница :"_kw_"    #"_$S(tipt=1!(i1=1):"",i1'=1&(tipt=3!(tipt=4)):1_":1:"_($P(tit,",")-1)_",",1:"")_i1_":1:"_i3 Q
 
 ;Формирование таблицы
 S (ky,kx,ly,lx)=""
 S i=1 F  S i=$O(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",i)) Q:i=""  D  X $G(WA)
 .S i1=1 F  S i1=$O(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,i1)) Q:i1=""  D
 ..S ky=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",i,1)),"@")
 ..S kx=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,i1)),"@",2)
 ..S ly=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",i,1)),"@",3)
 ..S lx=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,i1)),"@",4)
 ..S ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",i,i1)=ky_"@"_kx_"@"_ly_"@"_lx_"@@@@@1@1;6;33;44@@@@@"
 
 D  ;А ЭТО ПРАВИЛЬНОЕ Формирование таблицы
 .N BSR,BST S BSR="^%ZAPM.bs.BSbufB",BST="W"_$G(%BS(3),$P)_$J_"u" D TAB^%ZAPM.bs.BSF1
 
 ;Вывод без карты
 I in7'=1 D  S out=$$OUT^%ZAPM.bs.BSout2(BSR,BST) G 2
 .S rp=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","DOS")),"#",2),out=$$ALL^%ZAPM.bs.BSout1(BSR,BST,rp)
 
 ;Работа с картой
 S ^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u")=BSR_"#"_BST
 S ZapK="" F i=0:1:9 S ZapK=ZapK_$G(@("k"_i))_"~"   ;запись набора ключей БД
 S $P(^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u"),"#",3)=ZapK
 S BSRold=BSR,BSTold=BST
 S IYI="^%ZAPM.bs.BSbufB"_"("_"W"_$G(%BS(3),$P)_$J_"u" D NE^%ZAPM.bs.BSN ;```
1 S BSR=BSRold,BST=BSTold,Refresh=1
 
2 S $ZT=$G(%zT) K ^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u"),^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u")
 Q  ;The end
 
3 ;Обработка клавиш в таблице карты вывода
 S Refresh=1
 I R1=27,R2=79,R3=81 D  Q                       ;Вывод на устройство <F2>
 .D 4 S out=$$Gout^%ZAPM.bs.BSout1(BSRnew,BSTnew,1,2)
 .S BSRold=$P($G(^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u")),"#"),BSTold=$P($G(^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u")),"#",2)
 .S out=$$OUT^%ZAPM.bs.BSout2(BSRold,BSTold)
 .S R1=-2 D W^%ZAPM.bs.BST Q
 I R1=13,R2=-1,R3=-1 D  Q                       ;Просмотр на экране <ENTER>
 .D 4  S out=$$Gout^%ZAPM.bs.BSout1(BSRnew,BSTnew,1,1)
 .S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")="БУФЕР @@@@@@@1@1@22@80@@@@1@@5@@@1@@@@@@@@@@@1;6;36;44//1;6;36;40@@@@@@@1"
 .D ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSbufB","uP"_$G(%BS(3),$P)_$J_"u")
 .S R1=-2 D W^%ZAPM.bs.BST Q
 I R1=27,R2=79,R3=82 D OPprn^%ZAPM.bs.BSout(BSR,BST) Q   ;Опции принтера <F3>
 I R1=27 Q
 
4 ;Посылка на формирование буфера
  S BSRnew=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","PRN")),"#"),BSTnew=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","PRN")),"#",2) Q
ls() I ls'["," Q ls
 I +$P(ls,",",kw+1)=0 Q +ls
 Q +$P(ls,",",kw+1)
]]></Routine>


<Routine name="%ZAPM.bs.BSout1" type="MAC" languagemode="0"><![CDATA[
%BSout1 ; Формирование буфера вывода  (А.Тимофеев) ; 14:35   16.06.99
 
ALL(%2,%3,%6) ;Формирование буфера вывода без карты
 ;%2 - BSR, %3 - BST, %6 - режим вывода
 
 I %2=""!(%3="") S %0=0 Q %0
 N i,i1,i2,l,lx,fy,fx,dan,str,str1,st,d,d0,d1,nst,zp,%zT,nBS15,tr
 S BSR=%2,BST=%3,%zT=$ZT,$ZT="1^%ZAPM.bs.BSout1",%4=""
 
 S zp="" D  I zp=1 S %0=0 Q %0
 .I '$D(^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")) Q
 .I $P($G(^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")),"#",3)'=0 Q
 .I BSR'=$P($G(^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")),"#")!(BST'=$P($G(^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")),"#",2)) Q
 .S ls=" Есть готовый буфер! Выдаем ? " D YES^%ZAPM.bs.BSF I YES S zp=1 Q
 
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")  S nBS15=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","PRN")),"#",3)
 S str=0,nst=2 D
 .I $G(pacetF)'="" S:pacetG'="Y" tr=1 Q
 .S tr=1 //```S ls=" Псевдографику сохранять ? " D YES^%ZAPM.bs.BSF I 'YES S tr=1
 S ls="Формируется буфер вывода" D WAITS^%ZAPM.bs.BSF2
 
 S ny=1 F  S ny=$O(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",ny)) Q:ny=""!(ny'=+ny)  D
 .S nx=1 F  S nx=$O(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",ny,nx)) Q:nx=""  D G0  D
 ..I $G(%6)=3 S str=str+1,^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",str)="~'~'~end "_nst,nst=nst+1,str=str+1 Q
 ..I $G(%6)=2 S str=str+1,^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",str)="'~'~'end "_nst,nst=nst+1,str=str+1 Q
 S ^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")=BSR_"#"_BST_"#"_"0"
 
1 S $ZT=$G(%zT),%0=0 Q %0     ;The end
 
Gout(%2,%3,%4,%5) ;Формирование буфера вывода из карты
 ;%2 - BSR, %3 - BST, %4 - 1, %5 - 1 (экран) или 2 (устройство)
 
 I %2=""!(%3="")!(%4="") S %0=0 Q %0
 N BSR,BST,i,i1,i2,l,lx,fy,fx,dan,str,str1,st,d,d0,d1,zp,zp1,%zT,tr
 S BSR=%2,BST=%3,%zT=$ZT,$ZT="2^%ZAPM.bs.BSout1"
 
 S zp="" D  I zp=1 S %0=0 Q %0
 .I '$D(^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")) Q
 .S zp1=$G(^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u"))
 .I BSR'=$P(zp1,"#")!(BST'=$P(zp1,"#",2))!(ny'=$P(zp1,"#",3))!(nx'=$P(zp1,"#",4)) Q
 .S ls=" Есть готовый буфер! Выдаем ? " D YES^%ZAPM.bs.BSF I YES S zp=1 Q
 
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u") S nBS15=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","PRN")),"#",3)
 S ZapK=$P($G(^%ZAPM.bs.BSbufB("old"_$G(%BS(3),$P)_$J_"u")),"#",3)
 F i=1:1:10 S i1=i-1,@("k"_i1)=$P(ZapK,"~",i)
 S str=0
 S tr=1 //```S ls=" Псевдографику сохранять ? " D YES^%ZAPM.bs.BSF I 'YES S tr=1
 S ls="Формируется буфер вывода" D WAITS^%ZAPM.bs.BSF2
 
G0 ;Формирование по одной карте
 
 ;Определение цикла пробежки из карты
 S fy="F i="_$P($P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",ny,1)),"@",15),"#",2)
 S fx="F i1="_$P($P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",1,nx)),"@",15),"#",2)
 S dan="" X fy_" D G1"
 
 I $G(%4)'=1 Q
 S $P(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u",ny,nx),"@",15)=$J("",10)_$S(%5=1:"Просмотр",1:"Выдан !")
 S ^%ZAPM.bs.BSbufB("zP"_$G(%BS(3),$P)_$J_"u")=BSR_"#"_BST_"#"_ny_"#"_nx
 
2 S $ZT=$G(%zT),%0=0 Q %0     ;The end
 
 
G1 ;Цикл по строкам таблицы
 S hy=$P($G(@(BSR_"(BST,i,1)")),"@",3) D:+hy'=0  S str=str+hy X $G(WA)
 .X fx_" D G2 "
 Q
 
G2 ;Цикл по колонкам таблицы
 S $ZT="ZZZ^%ZAPM.bs.BSout1" I $G(tr) D TR^%ZAPM.bs.BSF12
 S st=$G(@(BSR_"(BST,i,i1)")),lx=$P(st,"@",4) D DK S:$G(tr) d0=$TR(d0,tr(1),tr(2)) S d0=$S(d0'="":d0,1:"")_$J("",lx*hy-$L(d0)) D:+lx'=0
 .S l=1,lx1=lx F i2=1:1:hy S str1=str+i2 D
 ..S dan=$E(d0,l,lx1),l=lx1+1,lx1=lx1+lx
 ..S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",str1)=$G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",str1))_dan
 Q
ZZZ W $$bel^%ZAPM.bs.BS3 Q
DK ;Определение данных клетки
 N BS,ny,nx  S BS=st
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_nBS15,i,i1))
 I d0="" S d0=" "
 I $P(BS,"@",8)'="" S ny=i,nx=i1 D
 .I $P(BS,"@",8)=0 X $G(@(BSR_"(BST,""FTR"","_i_","_i1_")")) S d0=d1 Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")")) S d0=d1
 Q
 
TR(d0) ;Трансформация псевдографики если tr=1
 ;I d0=""!(d0=" ")!(d0=+d0) Q d0
 N tr1,tr2,tr3,d2,d3
 S tr1="||||||--|+||==||=-==-=--==-====-=---="
 S tr2="=-"
 S d2="" F tr3=1:1:$L(d0) S d3=$E(d0,tr3) D  S d2=d2_d3
 .I tr1[d3 S d3=$TR(d3,d3,"|") Q
 .I tr2[d3 S d3=$S(d3="-":$TR(d3,d3,"-"),1:$TR(d3,d3,"=")) Q
 S d0=d2 Q d0
]]></Routine>


<Routine name="%ZAPM.bs.BSout2" type="MAC" languagemode="0"><![CDATA[
%BSout2 ; Вывод на устройство  (А.Тимофеев) ; 11:40   09.10.2000
 
OUT(%1,%2,%Uout) ;Вывод буфера на устройство
 ;%1 -BSR, %2 - BST, %Uout - устройство
 I $G(%1)=""!($G(%2)="") S %0=0 Q %0
 
 N i,i1,us,US,%I,ot,rp,sr,sr1,sr2,sr3,qz,txt,%zT,ExZ,UStro,TermLPT,Tmp
 I '$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")) S %0=0 Q %0
 S us=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","TXT")),"#")  ;определение устройства
 S:$G(%Uout)'="" us=$G(%Uout)
 I us=4 G COM
 I us=2 G DOS
 I us=3 G TXT
 
PRN ;На принтер
 S %I=$I
1 ;Старт печати
 S US=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","TXT")),"#",2)
 S:$G(%Uout)'="" US="|PRN|\\XXX\ZZZ" ;3 //```
 S Tmp=$$TermF() G ExZ:+Tmp I Tmp="ESC" S %0=0 Q %0 ;ОПРЕДЕЛЕН ТЕРМИНАЛ И ПЕЧАТЬ НА ТЕРМИНАЛЬНЫЙ ПРИНТЕР
 S US=$$DFLT^%ZAPM.bs.BSJPRN ;```
 //````I '$$INIT^%ZAPM.bs.BSJPRN(US) S %0=0 Q %0 ;Инициализация DPP ---->
 //```I $G(pacetF)="",$G(Tmp)'="LPT" S ls=" Готово УСТРОЙСТВО ВЫВОДА ("_US_") ? " D YES^%ZAPM.bs.BSF I 'YES S %0=0 Q %0
 I $G(pacetF)="",$G(Tmp)'="LPT" D  I 'YES S %0=0 Q %0
 .D MENU^%ZAPM.bs.BSF5(" ПРИНТЕР_"_US_" ВЫВОД_В_SPOOLER ОТМЕНА ","ВЫБЕРИТЕ УСТРОЙСТВА ВЫВОДА..")
 .I %B=2 S US=2
 .I %B=3 S YES=0
ExZ I $G(TermLPT) G TermLPT
 O US:$$MAX^%ZAPM.bs.BSJPRN(US):1 E  S ls=" ПЕЧАТЬ ЗАНЯТА " D O^%ZAPM.bs.BSF7 G PRN
 S %zT=$ZT,$ZT="ZT^%ZAPM.bs.BSout2"
 U US W $$SBROS^%ZAPM.bs.BSJPRN(US) ;Сброс параметров
 ;ot - отступ, rp - режим печати, sr - установки принтера
TermLPT S ot=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","DOS")),"#"),rp=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","DOS")),"#",2)
 S sr=$$CTRL^%ZAPM.bs.BSJPRN($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","SHR")),US),sr1=$P(sr,"#"),sr2=$P(sr,"#",2),sr3=$P(sr,"#",3)
 D Prn
 D USECON(%I) R *R:0 I R=27 G STOP
 S ls=" Вывод информации " D WAITS^%ZAPM.bs.BSF2
 S (S2,S1)="" D  ;ПЕРЕКОДИРОВАТЬ ЕСЛИ НЕ СПУЛЕР
 .I US'=2 D INIT^%ZAPM.bs.BSre(0)
 S i="",qz="" F  S i=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)) Q:i=""  D  Q:qz'=""
 .D  Q:qz'=""
 ..I rp=3&($E($G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)),1,5)="~'~'~") D  Q
 ...S ns=$P($G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)),"~'~'~end ",2),i=i+1
 ...D USECON(%I) S ls="Страница N "_ns_". Печатать с переводом формата ?" D YES^%ZAPM.bs.BSF I 'YES S qz=2 Q
 ...D USELPT(US) W:YES # D Prn
 ..I rp=2&($E($G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)),1,5)="'~'~'") S i=i+1 D USELPT(US) W #
 .D USELPT(US) W !,$J("",ot),$TR($G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)),S2,S1) D USECON(%I) X $G(WA) W $$rt^%ZAPM.bs.BS3(0) I R=27 S qz=1 Q
 G:qz=1 STOP  G:qz=2 END
 D USELPT(US) W !
END ;Конец печати
 I $G(TermLPT) G TermLPTC
 U US W $$SBROS^%ZAPM.bs.BSJPRN(US)
2 I '$G(TermLPT) C US D COPY2BSSES^%ZAPM.bs.BSCpool(US,$$MAX^%ZAPM.bs.BSJPRN(US),%2) O US U US W ! C US  ;ДОПОЛНИТЕЛЬНЫЙ СБРОС
TermLPTC D USECON(%I) S $ZT=$G(%zT) W $$rt^%ZAPM.bs.BS3(0)
 S R=1 I $D(ExZ),ExZ>1 S ExZ=ExZ-1 G ExZ
 I '$D(pacetO) S %B=2,ls="Еще экземпляр ?" D YES^%ZAPM.bs.BSF I YES G 1
 S %0=0 Q %0
USELPT(US) ;СДЕЛАТЬ ТЕКУЩИМ УСТРОЙСТВО ПЕЧАТИ
 I $G(TermLPT) X "W "_$P(TermLPT,"~",2) Q
 U US
 Q
USECON(US) ;СДЕЛАТЬ ТЕКУЩИМ УСТРОЙСТВО КОНСОЛИ
 I $G(TermLPT) X "W "_$P(TermLPT,"~",3)
 U US
 Q
STOP ;Прерывание печати
 W $$bel^%ZAPM.bs.BS3 S ls=" ПЕЧАТЬ ПРЕРВАНА " D O^%ZAPM.bs.BSF7
 G 2
TermF() ;ОПРЕДЕЛЕНИЕ УСТРОЙСТВО ПЕЧАТИ ДЛЯ ТЕРМИНАЛА И СТАНЦИИ
 K TermLPT
 S %0=0 I $G(%BS(14))="" Q 0 ;НЕ ЧЕГО НЕ ДЕЛАТЬ - ВСЕ ПО-СТАРОМУ
 I $E(%BS(14),5)="1" Q 0 ;ВСЕГДА ПО-СТАРОМУ
 I $E(%BS(14),5)="2" Q $$Term(1) ;ВСЕГДА ТЕРМИНАЛЬНЫЙ ПРИНТЕР
 I $E(%BS(14),5)="0" D  Q:YES<1!(%B=3) "ESC" Q:%B=2 $$Term(0) Q:%B=1 "LPT"  ;СЕЛЕКТОР МЕЖДУ ПЕЧАТЯМИ
 .D MENU^%ZAPM.bs.BSF5(" ПЕЧАТЬ_НА_ЛОКАЛЬНОМ_ПРИНТЕРЕ_MSM ПЕЧАТАТЬ_НА_ПРИНТЕРЕ_ТЕРМИНАЛА ОТМЕНА ","ВЫБЕРИТЕ ПРИНТЕР...")
 Q 0
Term(lsss) ;СОЗДАТЬ ЛОКАЛЬ ПЕЧАТИ ТЕРМИНАЛА
 N ls I $G(lsss) S ls=" Готово ЛОКАЛЬНОЕ устройство печати ТЕРМИНАЛА ? " D YES^%ZAPM.bs.BSF I 'YES S %0=0 Q "ESC"
 S TermLPT=$$Ter() I "1~~"[TermLPT D ErrMsg^%ZAPM.bs.BSXfun("Для терминала "_$P_" не определен код инициализации ПЕЧАТИ") Q "ESC"
 Q TermLPT
Ter() N BDTRM S BDTRM=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSVOL(""TRM"")") I $D(@BDTRM@($P)) S TermLPT="1~"_$G(@BDTRM@($P,"OpenLPT"))_"~"_$G(@BDTRM@($P,"CloseLPT")) Q TermLPT
 Q ""
Prn ;Инициализация принтера
 Q:$G(TermLPT)
 U US W:$G(sr1)'="" @("$C("_sr1_")") W:$G(sr2)'="" @("$C("_sr2_")") W:$G(sr3)'="" @("$C("_sr3_")")
 Q
ZT ;Сборщик ошибок для принтера
 G END
DOS ;В DOS файл
 N %DEV,%FN,%I,%3,%4
 S %zT=$ZT,$ZT="C^%ZAPM.bs.BSout2",%I=$I
 S PR1=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","TXT")),"#",2)
 ;Открытие файла
 I $G(pacetD)'="" S PR1=$S($G(pacetD)=1!($G(pacetO)=1):PR1,1:$G(pacetPR1))
Mas1 N f1,Mas1,Mas2,f2,f  //
 S f=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","bzOUTtables","V","^[""%SYS""]BSC4.ISS.Setup") //
 I $$File2Arr^%ZAPM.bs.BSCEXE(f_"header.html",.Mas1) ;ZW Mas1 //
 I $$File2Arr^%ZAPM.bs.BSCEXE(f_"footer.html",.Mas2) ;ZW Mas2 //
 
 D DOSOPN^%ZAPM.bs.BSBL1
 I $G(%FN)="" D OkMsg^%ZAPM.bs.BSXfun("Отказ от вывода !",6) S %0=0 Q %0
 S ls=" Вывод информации " D WAITS^%ZAPM.bs.BSF2
 
 D:$G(Pfl) Mas(.Mas1) //
 S i="",qz="" F  S i=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)) Q:i=""  D
 .U %DEV W $G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)),! U %I X $G(WA)
 D:$G(Pfl) Mas(.Mas2) //
 
C ;Закрытие устройства
 S $ZT=$G(%zT)
 C %DEV K %DEV,%FN U 0
 D:$G(pacetD)="" OkMsg^%ZAPM.bs.BSXfun("Вывод завершен !",6)
 S %0=0 Q %0
 
Mas(Mas1) I $D(Mas1) S f1="" F  S f1=$O(Mas1(f1)) Q:f1=""  U %DEV W Mas1(f1) //
 Q 
 
TXT ;Вывод в текст
 
 S %zT=$ZT,$ZT="Ztxt^%ZAPM.bs.BSout2",%I=$I
 S li=$P($G(^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u","TXT")),"#",2)
 
NAME ;определение текста для вывода
 N BSr,BSt,li,YES
 S NoCheck=1 D RIT^%ZAPM.bs.BSF3 K NoCheck
 I li="" D OkMsg^%ZAPM.bs.BSXfun("Отказ от вывода !",6) S %0=0 Q %0
 I BSr=""!(BSt="") S %0=0 Q %0
 I '$D(@(BSr)) S %0=0 Q %0
 I $D(@(BSr_"(BSt)")) S ls=" Есть уже такой текст !  Перепишем ? " D YES^%ZAPM.bs.BSF I YES'=1 G NAME
 I $D(@(BSr_"(BSt)")) K @(BSr_"(BSt)")
 S @(BSr_"(BSt)")="Таблица "_BSR_","_BST_" в тексте@@@@@@@1@1@22@80@@@@1@@5@@@1@@@@@@@@@@@1;6;36;44//1;6;36;40@@@@@@@1"
 
 S ls=" Вывод информации " D WAITS^%ZAPM.bs.BSF2
 S i="" F  S i=$O(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i)) Q:i=""  D
 .S @(BSr_"(BSt,i)")=$G(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",i))
 
 D OkMsg^%ZAPM.bs.BSXfun("Вывод завершен !",6)
Ztxt ;The end
 S $ZT=$G(%zT)
 S %0=0 Q %0
 
COM ;Вывод в порт
 S %zT=$ZT,$ZT="Ztxt^%ZAPM.bs.BSout2"
 I '$D(%BS(21)) D ErrMsg^%ZAPM.bs.BSXfun(" Вывод на ПФЛ не определен в SETUP") G Ztxt
 S out=$$MassPFL^%ZAPM.bs.BSXdos("^%ZAPM.bs.BSbufB(""uP"_$G(%BS(3),$P)_$J_"u"")",1) G Ztxt
]]></Routine>


<Routine name="%ZAPM.bs.BSout3" type="MAC" languagemode="0"><![CDATA[
%BSout3 ; Вывод данных ...   (А.Тимофеев) ; 17:17 10-JUN-98
 
DTout(%1,%2,%3) ;Подготовка буфера вывода
 ;%1 - устройство, %2 - BSR, %3 - BST
 I %1=0 Q
 S:$G(%2)="" %2=$G(BSR) S:$G(%3)="" %3=$G(BST) I BSR=""!(BST="") Q
 
 N i,i1,i2,str,sh,d,d1,d0,st,str1,n,sh1,str2,%zT
 S %zT=$ZT,$ZT="END^%ZAPM.bs.BSout3"
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")
 I '$D(%CAL) D CALC^%ZAPM.bs.BSF3
 I %1=4,'$D(%BS(21)) D ErrMsg^%ZAPM.bs.BSXfun(" Вывод на ПФЛ не определен в SETUP") Q
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u") S ls="Формируется буфер вывода" D WAITS^%ZAPM.bs.BSF2
 S lst=$S(%1=4:60,%1=1:79,1:80)  ;длина строки
 S (i,str)="",sh=0,n=1 F  S i=$O(@(BSR_"(BST,i)")) Q:'i  D  X $G(WA)
 .S i1="" F  S i1=$O(@(BSR_"(BST,i,i1)")) Q:'i1  D
 ..I $E($P(^(i1),"@",3),1)="X"!($E($P(^(i1),"@",4),1)="X") Q
 ..I $P($P(^(i1),"@",18),"#",2)="" Q
 ..S st=$G(^(i1)) D DK I d="" Q
 ..S str1=$S(sh=0:"",1:"=")_$P($P(st,"@",18),"#",2)_d D STR Q
 I str'=""&(str'["+++") S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",n)=str
 
END ;Посылка на устройство
 
 S $ZT=$G(%zT)
 I %1=3 D  Q
 .S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")="Буфер вывода @@@@@@@1@1@22@80@@@@1@@5@@@1@@@@@@@@@@@1;6;36;44//1;6;36;40@@@@@@@1"
 .S TXT="uP"_$G(%BS(3),$P)_$J_"u" D ^%ZAPM.bs.BSX("EDIT","^%ZAPM.bs.BSbufB",TXT) Q
 N Pfl S Pfl=1,out=$$OUT^%ZAPM.bs.BSout2(BSR,BST,%1)
 Q
 
STR ;Формирование строки
 S str=str_str1,sh1=0
 F i2=1:1 D  Q:sh1=1
 .I $L(str)<lst S sh1=1 Q
 .S str2=$E(str,1,lst),str=$E(str,lst+1,$L(str))
 .S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",n)=str2,n=n+1 Q
 I str1'["+++" S sh=1 Q
 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",n)=str,n=n+1,sh=0,str="" Q
 
DK ;Обработка данных клетки
 N BS,ny,nx,isp,Vi,Vi1  S BS=st
 
 I $P(BS,"@",9)=1 S d=$P(BS,"@",15)
 E  S d=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,i1))
 Q:$P($P(BS,"@",18),"#",3)=""
 S Vi=$P($P($P(BS,"@",18),"#",3),","),Vi1=$P($P($P(BS,"@",18),"#",3),",",2)
 S isp=$G(@(BSR_"(BST,""FCL"",Vi,Vi1)"),"") K d1 X isp S d=$G(d1,d) Q
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSout4" type="MAC" languagemode="0"><![CDATA[
%BSout4 ;Формирование блока  (А.Тимофеев) ; 14:57   02.03.99
 
BL(%2,%3) ;Создание таблицы - блока (данные клеток выносятся в описание)
 ;%2 - BSR, %3 - BST
 I $G(%2)=""!($G(%3)="") Q 0
 S:$G(BSR)="" BSR=%2 S:$G(BST)="" BST=%3
 N i,i1,i2,st,tit,Ty,Tx,d,d0,d1,%zT,sh,sh1,Kx,Ky,Lx,Ly
 S %zT=$ZT,$ZT="ZT^%ZAPM.bs.BSout4"
 
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u"),^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u")
 I $P(@(BSR_"(BST)"),"@",19) S tit=$P(@(BSR_"(BST)"),"@",19) ;|
 I $P(@(BSR_"(BST)"),"@",50) S tit=$P(@(BSR_"(BST)"),"@",50) ;ТИТУЛ ПЕЧАТИ```MSW
 I $G(tit)'="" S Ty=$P(tit,","),Tx=$P(tit,",",2)   ;координаты титула
 S ls="Формируется блок !" D WAITS^%ZAPM.bs.BSF2
 
 ;Отбор строк, колонок
 S (sh,sh1)=0
 S i="" F  S i=$O(@(BSR_"(BST,i)")) Q:i=""  D  X $G(WA) I sh=1!(i<$G(Ty)) S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",0,i)=1,sh=0
 .S i1="" F  S i1=$O(@(BSR_"(BST,i,i1)")) Q:i1=""  D  I sh1=1!(i1<$G(Tx)) S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",1,i1)=1,sh1=0
 ..S st=$G(@(BSR_"(BST,i,i1)"))
 ..I $P(st,"@",12)=1 S (sh,sh1)=1 Q
 ..Q
 
 ;Формирование таблицы
 S i="" F  S i=$O(@(BSR_"(BST,i)")) Q:i=""  D  X $G(WA)
 .S i1="" F  S i1=$O(@(BSR_"(BST,i,i1)")) Q:i1=""  D
 ..S st=$G(@(BSR_"(BST,i,i1)")),Ky=$P(st,"@"),Kx=$P(st,"@",2),Ly=$P(st,"@",3),Lx=$P(st,"@",4)
 ..I '$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",0,i)) D 1
 ..I '$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",1,i1)) D 1 Q
 ..D 2 S ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u",i,i1)=Ky_"@"_Kx_"@"_Ly_"@"_Lx_"@@@@@1@2;6;30;47@@@@@"_d0_"@@@"_$P(st,"@",18) Q
 S ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u")=@(BSR_"(BST)"),$P(^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u"),"@",1)="Таблица - блок "
 ;S ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u")="Таблица - блок @@1@@@1@1@1@1@22@80@1@@1@1@@1@@2,4@1@@@@@1@@@43@12@@1;6;33;44@@@@@@"
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")
 S YES=1,$ZT=%zT
 ;S TIP=1 D TAB^%ZAPM.bs.BSF1 S IYI="^%ZAPM.bs.BSbufB"_"("_"L"_$G(%BS(3),$P)_$J_"u" D NE^%ZAPM.bs.BSN ;```
 Q 1
 
1 ;Вычленение непомеченных строк, колонок и клеток
 D
 .I '$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",0,i)) S:$E(Ly,1)'="X" Ly="X"_Ly Q
 .I '$D(^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",1,i1)) S:$E(Lx,1)'="X" Lx="X"_Lx Q
 I i'=0 S ^%ZAPM.bs.BSbufB("L"_$G(%BS(3),$P)_$J_"u",i,i1)=Ky_"@"_Kx_"@"_Ly_"@"_Lx_"@@@@@1@2;6;30;47@@@@@"
 Q
 
2 ;Определение данных клетки
 N BS,ny,nx  S BS=st
 I $P(BS,"@",9)=1 S (d1,d,d0)=$P(BS,"@",15)
 E  S (d1,d,d0)=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,i1))
 I d0="" S d0=" "
 I $P(BS,"@",8)'="" S ny=i,nx=i1 D
 .I $P(BS,"@",8)=0 X $G(@(BSR_"(BST,""FTR"","_i_","_i1_")")) S d0=d1 Q
 .X $G(@(BSR_"(BST,""FTR"","_$P(BS,"@",8)_")")) S d0=d1
 Q
 
ZT S $ZT=%zT Q 0
 
]]></Routine>


<Routine name="%ZAPM.bs.BSout5" type="MAC" languagemode="0"><![CDATA[
%BSout5 ; пакетный вывод на устройство  (А.Тимофеев) ; 10:11 14-AUG-98
 
 S pacetF=1,%zT=$ZT,$ZT="ERROR" N i
1 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSS(OPout5)",2,2,"#") Q:A=""
 S tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 S tab=$P(A,"#"),pacetG=$P(A,"#",2),pacetU=$P(A,"#",3),pacetD=$P(A,"#",4),pacetO=1
 I tab="" D ErrMsg^%ZAPM.bs.BSXfun("Не выбраны таблицы !!") S $ZT=%zT Q
 I pacetU=""  D ErrMsg^%ZAPM.bs.BSXfun("Не определено устройство вывода !!") S $ZT=%zT Q
 F i=1:1 S tab1=$P(tab,"~",i) Q:tab1=""  D
 .S Tbsr="^"_$S($P(tab1,",",3)'="":"["""_$P(tab1,",",3)_""","""_$P(tab1,",",4)_"""]",1:"")_$P(tab1,",",2)
 .S Tbst=$P(tab1,",")
 .D Kout^%ZAPM.bs.BSout0(pacetU,Tbsr,Tbst) I $P($G(bok),"~",3)="" K in
 D:$G(pacetD)="" OkMsg^%ZAPM.bs.BSXfun("Вывод завершен !",6)
 K pacetF,pacetG,pacetU,pacetD,pacetO,Tbsr,Tbst
 S $ZT=%zT G 1
 
ERROR D ErrMsg^%ZAPM.bs.BSXfun("ГЛЯ - !!"_$ZE)
 S $ZT=%zT Q
]]></Routine>


<Routine name="%ZAPM.bs.BSoutNF" type="MAC" languagemode="0"><![CDATA[
%BSoutNF ; Вывод данных в новом формате (А.Тимофеев) ; 10:12   26.12.2002
 
 N i,i1,mas,mas1,d,st,str,n,BSRz,BSTz
 ;S %zT=$ZT,$ZT="STOP"
 D 333^%ZAPM.bs.BSF
 S B=1,BSRz=BSR,BSTz=BST D TIP+1^%ZAPM.bs.BST
 S masV="^%ZAPM.bs.BSbufB(""PO"_$G(%BS(3),$P)_$J_"u"")",masN=$P(masV,")")_",""n"")",masB=$P(masV,")")_",""bok"")",masP=$P(masV,")")_",""ea"")"
 
1 ;
 S mas1="^%ZAPM.bs.BSbufB(""uP"_$G(%BS(3),$P)_$J_"u"")" S ls="Формируется буфер вывода" D WAITS^%ZAPM.bs.BSF2
 K @mas1
 
 I '$D(%CAL) D CALC^%ZAPM.bs.BSF3
 K ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u") S ls="Формируется буфер вывода" D WAITS^%ZAPM.bs.BSF2
 S n=1,i="" F  S i=$O(@(BSR_"(BST,i)")) Q:'i  D  X $G(WA)
 .S i1="" F  S i1=$O(@(BSR_"(BST,i,i1)")) Q:'i1  D
 ..I $E($P(^(i1),"@",3),1)="X"!($E($P(^(i1),"@",4),1)="X")!($E($P(^(i1),"@",3),1)=0) Q
 ..I $P($P(^(i1),"@",18),"#",2)="" Q
 ..S sno=$P($P(^(i1),"@",18),"#",2),st=$G(^(i1)) D DK  I d="" Q   S d=$S(sno="{":" ",sno="}":" ",d'="":d,1:"") I d="" Q
 ..S str=sno_$S(sno="{":"",sno="}":"",$E(sno,1)=";":"",sno="NOD":"",1:"=")_$S(sno="{":"",sno="}":"",1:d)
 ..I str'="" S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u",n)=str,n=n+1
 S ^%ZAPM.bs.BSbufB("uP"_$G(%BS(3),$P)_$J_"u")="Буфер вывода @@@@@@@1@1@22@80@@@@1@@5@@@1@@@@@@@@@@@1;6;36;44//1;6;36;40@@@@@@@1"
 S TXT="uP"_$G(%BS(3),$P)_$J_"u" D ^%ZAPM.bs.BSX("EDIT","^%ZAPM.bs.BSbufB",TXT)
 ;D OkMsg^%ZAPM.bs.BSXfun(" ОТРАБОТАНО !",2) S BSR=BSRz,BST=BSTz Q
 K BSR,BST D NE^%ZAPM.bs.BSN S BSR=BSRz,BST=BSTz,%0="" Q
  
DK ;Обработка данных клетки
 N BS,ny,nx,isp,Vi,Vi1  S BS=st
 ;I sno'="" D x^%ZAPM.bs.BS3(1)
 
 I $P(BS,"@",9)=1 S d=$P(BS,"@",15)   ;,d1=""
 E  S d=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),i,i1))
 Q:$P($P(BS,"@",18),"#",3)=""
 S Vi=$P($P($P(BS,"@",18),"#",3),","),Vi1=$P($P($P(BS,"@",18),"#",3),",",2)
 S isp=$G(@(BSR_"(BST,""FCL"",Vi,Vi1)"),"") K d1 X isp S d=$G(d1,d) Q
 Q
 
STOP ;ERROR
 D ErrMsg^%ZAPM.bs.BSXfun("Гля - сопля !!! "_i_"."_$G(Vi)_"."_$G(Vi1))
 S $ZT=%zT Q
 
]]></Routine>


<Routine name="%ZAPM.bs.BSprint" type="MAC" languagemode="0"><![CDATA[
%BSprint(UStro) ;РЕЗИДЕНТ ПРИНТ-СЕРВЕР ; 15:25 15-JUL-98
0 D S("A",1),S("D",0) D KI D S("S",$S),S("T",$$h^%ZAPM.bs.BS3()),S("E","")
R F  H $$PAR(4) Q:$$U("C")'=""
 I $$U("C")="D" G EXIT
 I $$U("C")="S" C:$D(US) US G EEE
 I $$U("C")["u" D S("O",$$U("C")),S("C","") G R
 I $$U("C")="!" G R:$$PRN D KI G WAIT
 I $$U("C")="?" D S("C",""),S("O","?") G R
 I $$U("C")="P" G PRINT:$$U("B")'="" D E("ЗАПРОСА НЕТ") G R
 I $$U("C")="R" G PRINT:$$U("B")'="" D E("ЗАПРОСА НЕТ") G R
 G R
E(E) D S("E",E) Q
ER I $ZE["PROT>" D E("БУФЕР НЕ ДОСТУПЕН")
 D E($ZE) S $ZT=$G(%zT) D BEL G WAIT
BEL Q  Q
PRINT ;САМ ПРОЦЕСС
 S %zT=$ZT,$ZT="ER^%ZAPM.bs.BSprint"
 D S("C",""),S("D",1) D CTRL S BU=$$U("B") I BU="" D E("НЕТ БУФЕРА") G WAIT
 S Z=$$U("Z"),BU="^["""_$P(Z,",")_""","""_$P(Z,",",2)_"""]"_$P(BU,"^",2,99)
 I '$D(@BU) D E("БУФЕР ПУСТОЙ") G WAIT
 D L^%ZAPM.bs.BS3(BU,1) I 'LOC D E("БУФЕР ЛОКИРОВАН") G WAIT
REST S PRO=$O(@BU@(""),-1) I 'PRO D E("НЕТ СТРОК") G WAIT
 S (EXE,EX)=1 I $$U("EXE") S (EXE,EX)=$$U("EXE")
 ;
PRI S i="",qz="" F  S i=$O(@BU@(i)) Q:i=""  D  Q:qz'=""  I '(i#3) S VST=(EX-1)*PRO+i D S("P",(100-(VST*100\(PRO*EXE)))),S("N",VST)
 .I $$U("RP")=2&($E($G(@BU@(i)),1,5)="'~'~'") S i=i+1 W # Q
 .U US W !,$J("",$$U("OT")),$G(@BU@(i)) I $$U("C")'="" D
 ..I $$U("C")="?" D S("C",""),S("O","?") Q
 ..I $$U("C")="D" D S("C","") S qz="D" Q
 ..I $$U("C")="S" D S("C","") S qz="S" Q
 ..I $$U("C")="R" D S("C","") S qz="R" Q
 ..I $$U("C")="I" D S("C","") S qz="I" Q
 U US W !
 I qz="",EX>1 S EX=EX-1 D S("EX",(EX_" из "_EXE)) W ! G PRI
 W $$SBROS^%ZAPM.bs.BSJPRN(US) I qz="I" D S("P",""),S("N",""),S("D",2) G R
 I qz="R" D S("P",""),S("N","") G REST
 C US I "S"[qz G EEE
 I qz="D" G EXIT
EEE D U^%ZAPM.bs.BS3(BU),S("D",0) D KI D S("S",$S),S("E","") ;ЗАКОНЧИЛИ ПЕЧАТАТЬ
 G WAIT
CTRL N Z ;Инициализация принтера
 U US I $$PR(15)'="" W $C($$PR(15)) ;СБРОС
 F Z="US","UL","UK" I $$U(Z)'="" W $C($$U(Z))
 Q
WAIT D KI ;ЗАКОНЧИЛИ
 I $D(BU) D U^%ZAPM.bs.BS3(BU)
 I $$PAR(5)'="Y" D S("D",0) G R
 G EXIT
PAR(N) ;ПАРАМЕТРЫ СЕРВЕРА
 Q $P($G(^%ZAPM.bs.BSETUP("PARPRN",N,2)),"@",15)
PRN() S US=$$PR(17) I 'US D S("O",0),E("УСТ.ПЕЧ "_US_"?") Q 0
 O US:$$MAX^%ZAPM.bs.BSJPRN(US):1 E  D S("O",1),E("УСТ.ПЕЧ ЗАНЯТО") Q 0
 D S("O","OK") Q 1
PR(P) Q $G(@UStro@((P_",2")))
KI N I F I="O","T","S","EX","EXE","N","P","Z","B","US","UL","UK","OT","RP" D K(I)
  Q
EXIT N I D KI F I="C","A","D" D K(I)
 Q
K(U) K @UStro@(U) Q
S(U,S) I S="" K @UStro@(U) Q
 S @UStro@(U)=S Q
U(U) Q $G(@UStro@(U))
]]></Routine>


<Routine name="%ZAPM.bs.BSre" type="MAC" languagemode="0"><![CDATA[
%BSre ; пpогpамма ПЕРЕКОДИРОВОК ; 13:43   15.04.2003
 Q
CTRL(S) ;УДАЛЕНИЕ УПРАВЛЯЮЩИХ СИМВОЛОВ
 Q $TR(S,$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31),"")
Ansi2Asc D DOSREAD^%ZAPM.bs.BSS1 Q:'$D(%FN)
 D ANS(%FN)
 Q
Ascii2An N %FN
 D DOSREAD^%ZAPM.bs.BSS1 Q:'$D(%FN)
 D AS(%FN)
 Q
DBFREAD(Say1,%Fn,Say2,GL,NOSCHET) N YES,D ;ЗАКАЧКА ИЗ ДБФ В МАССИВ С ВЫБОРОМ
 I $G(AUTO)=1 S %FN=%Fn D D Q $G(D,-1)
 D DBF Q $G(D,-1)
DB(%FN,GL,NOSCHET) ;ЗАКАЧКА ИЗ ДБФ В МАССИВ
 N %DEV,End,li,D D D Q $G(D,-1)
DBF ;СЧИТАТЬ dbf В МАССИВ
 N %FN,%DEV,End,li
 I $D(Say1) W /CUP(22,1),/EL(0),Say1
 D DOSREAD^%ZAPM.bs.BSS1 I $D(Say1) W /CUP(22,1),/EL(0)
 Q:'$D(%FN)  ;%Fn - файл по-умолчанию
 S li=$G(GL,"^ZZZ") I $D(Say2) W /CUP(22,1),/EL(0),Say2
 D GLO^%ZAPM.bs.BSF3 I $D(Say2) W /CUP(22,1),/EL(0)
 Q:YES<1  I '$D(NOSCHET) S NOSCHET=1  ;GL - массив по - умолчанию
D K @GL I $$Open^%ZAPM.bs.BSXdbf(%FN,GL)'=0 Q
 S End=@GL@("Head","RecNum")
 S D=$$ReadRec^%ZAPM.bs.BSXdbf(%FN,GL,1,End)
 Q
%BS35 ;ТАБЛИЦА ТРАНСЛЯЦИИ КОДОВ
 K %BS(35) N MN,F,SK,K
 S MN=$G(%BS(13),"???") ;NSP - ТЕРМИНАЛА
 I $ZV["MSM-Workstation" S MN="KEY-WS"
 I $ZV["Cach"||($ZV["IRIS") S MN="KEY-CACHE",%BS(32)="^%ZAPM.bs.BS364" ;,%BS(32)="^%CHARWIN"
  F F=0,"ALT","SFT","CRL" S K="" F  S K=$O(^%ZAPM.bs.BSR(MN,F,K)) Q:K=""  D
  .S SK=^%ZAPM.bs.BSR(MN,F,K) Q:"-1"[SK  I '$D(^%ZAPM.bs.BSR("KEY-PC",F,K)) Q
  .Q:SK=^%ZAPM.bs.BSR("KEY-PC",F,K)  ;СОВПАДАЕТ
  .S %BS(35,SK)=^%ZAPM.bs.BSR("KEY-PC",F,K)
 Q
KEYS ;СОЗДАТЬ МАССИВ ТРАНСЛЯЦИИ СКАН-КОДОВ КЛАВИТУРЫ
 Q
 N P,K,F,R1,R2,R3,R4,R5,iV,iiV
 ;S P="KEY-PC" ;КОНСОЛЬ
 ;S P="PCTT" ;ТЕРМИНАЛ
 I $ZV["MSM-Workstation" S P="KEY-WS"
 I $ZV["Cach"||($ZV["IRIS") S P="KEY-CACHE" ;Cache' from InterSystems
 F F=0,"ALT","SFT","CRL" D
 .F K=1:1:12 D READ($NA(^%ZAPM.bs.BSR(P,F,K)),"ВВЕДИТЕ "_F_"-F"_K)
 .F K="IN","DL","HM","EN","PU","PD" D READ($NA(^%ZAPM.bs.BSR(P,F,K)),"ВВЕДИТЕ "_F_" - "_K)
 .S K="BCSP" D READ($NA(^%ZAPM.bs.BSR(P,F,K)),"ВВЕДИТЕ "_F_"- "_K)
 .F K="UP","DN","RT","LT" D READ($NA(^%ZAPM.bs.BSR(P,F,K)),"ВВЕДИТЕ "_F_"-СТРЕЛКИ "_K)
 .F K=65:1:90 D READ($NA(^%ZAPM.bs.BSR(P,F,K)),"ВВЕДИТЕ "_F_"-"_$C(K))
 Q
READ(G,S) N iV,iiV,R1,R2,R3,R4,R5 W !,S," "
 I $ZV["Cach"||($ZV["IRIS") D READC ;Cache' from InterSystems
 I $ZV["PC/PLUS" D READT ;MSM-PC/PLUS
 I iiV'="13,-1,-1,-1,-1" S @G=iiV
 Q
READT N r,o,d,t,i r *o s d=o d  i t f  s d=d_","_o d  q:t=0
 .f i=1:1:30 r *o:0 s t=$t q:t
 S iiV=$P(d_",-1,-1,-1,-1",",",1,5) G REA
READM R *R1,*R2:0,*R3:0,*R4:0,*R5:0 S iiV=R1_","_R2_","_R3_","_R4_","_R5 G REA
READC R *R1 S R2=$ZB S iiV="" F iV=1:1:5 S iiV=iiV_$A($E(R2,iV)) I iV'=5 S iiV=iiV_","
REA W " --> ",iiV
 Q
S S BST="CMD",BSR="^%ZAPM.bs.BSS" D ^%ZAPM.bs.BST
 Q
s1(a) d INIT(a) q S1
s2(a) d INIT(a) q S2
INIT(A) ;трансляциЯ из ASCII в ANSI ; 14:21 26-SEP-97
 N B,I,L1,L2,D,D1,P,b,i,l1,l2,d,d1,p
 S B="",b="" F I=128:1:159 S B=B_$C(I),b=b_$C(I+64)
 S L1="",l1="" F I=160:1:175 S L1=L1_$C(I),l1=l1_$C(I+64)
 S L2="",l2="" F I=224:1:239 S L2=L2_$C(I),l2=l2_$C(I+16)
 S D="" F I=240:1:255 S D=D_$C(I)
 S d=$C(168,184,170,186,175,191,161,162,176,173,183,172,185,164,167,182)
 I A D
 .S D1=$C(176,177,178,219,220,221,222,223)
 .S d1=$C(183,173,177,182,95,91,93,174)
 .; P="||||||--|+||==||=-==-=--==-====-=---==--"
 .S P=$C(179,180,181,182,185,186,193,194,195,197,198,199,202,203,204,206,207,208,209,210,215,216,218,211,212,213,214,200,201,187,188,189,190,191,192,183,184,205,196,217)
 .S p="||||||--|+||==||=-==-=--==-====-=---==--"
 .I A=2 S p=$C(148,154,178,179,180,161,156,155,153,159,175,176,188,146,177,191,186,187,181,183,190,189,149,170,169,162,163,171,164,167,174,173,172,150,151,166,165,160,147,152)
 S S1=B_L1_L2_D_$G(D1)_$G(P),S2=b_l1_l2_d_$G(d1)_$G(p)
 Q
AS(V,EXT) ;V-ДОС ФАЙЛ ТРАНСЛЯЦИЯ  из ASCII ("_FNO_") в ANSI ("_FN_")")
 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSre"
 S DOS=51,FNO=V I $$Open^%ZAPM.bs.BSXdos(FNO,"R")
 S DOS1=DOS,FN=$L(V,".")-1 S:($L(FN,".")-1)<1 FN=1
 S DOS=52,FN=$P(V,".",1,FN)_"."_$G(EXT,"ANS") I $$Open^%ZAPM.bs.BSXdos(FN,"W")
 d Wait^%ZAPM.bs.BSXfun("ТРАНСЛЯЦИЯ  из ASCII ("_FNO_") в ANSI ("_FN_")")
 I $G(EXT)["HTM" U DOS W "<HTML><TITLE>"_$P(V,".")_"</TITLE><BODY><PRE>"
 F v=1:1 U DOS1 R S Q:$ZC'=0  D  I '(v#50) U 0 X $G(WA)
 .U DOS W $$HTm($$ANSI(S)),!
 I $G(EXT)["HTM" U DOS W "</PRE></BODY></HTML>"
Vi C DOS1,DOS U 0
 Q
HTm(S) I $G(EXT)'["HTM" Q S
 Q $$TEGS(S) ;_"<BR>"
TEGS(S) I S["<" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"<","&lt;")
 I S[">" S S=$$TR^%ZAPM.bs.BSsFUNM(S,">","&gt;")
 ;I S[" " S S=$$TR^%ZAPM.bs.BSsFUNM(S," ","&nbsp;")
 ;I S["%" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"%","%25")
 ;I S["\" S S=$$TR^%ZAPM.bs.BSsFUNM(S,"\","%5C")
 ;I S[":" S S=$$TR^%ZAPM.bs.BSsFUNM(S,":","%3A")
 Q $TR(S,$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,26,28,29,30,31),"")
ERFILE U 0 I $ZE["<ENDOFFILE" G Vi
 D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) G Vi
ACTIONS(F,XEC) G ACTION ;Action - ДЕЙСТВИЕ СО СТРОКАМИ ФАЙЛА  str
REPLACE(F,P1,P2) ;МОДУЛЬ ПАКЕТНОГО РЕДАКТИРОВАНИЯ ФАЙЛОВ
 N XEC
 S XEC="I str["""_P1_""" S str=$$TR^%ZAPM.bs.BSsFUNM(str,P1,P2)"
ACTION S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSre"
 N v,DOS,DOS1,FNO,FN
 S DOS=51,FNO=F I $$Open^%ZAPM.bs.BSXdos(FNO,"R")
 S DOS1=DOS,FN=$L(F,".")-1 S:($L(FN,".")-1)<1 FN=1
 S DOS=52,FN=$P(F,".",1,FN)_".$!$" I $$Open^%ZAPM.bs.BSXdos(FN,"W")
 d Wait^%ZAPM.bs.BSXfun("ТРАНСЛЯЦИЯ ("_FNO_")")
 F v=1:1 U DOS1 R str Q:$ZC'=0  D  I '(v#50) U 0 X $G(WA)
 .U 0 X XEC U DOS W str,!
 I str'="" U 0 X XEC U DOS W str,!
 C DOS1,DOS,63 U 0
 I $$ZOS3^%ZAPM.bs.BSDOS(FN,FNO)<0 ;D ErrMsg^%ZAPM.bs.BSXfun("НЕ МОГУ ПЕРЕИМЕНОВАТЬ "_FN_" В "_FNO) ;Rename a File
 ;I $$ZOS2^%ZAPM.bs.BSDOS(FNO)<0 D ErrMsg^%ZAPM.bs.BSXfun("НЕ МОГУ УДАЛИТЬ "_FNO)
 ;D EXE^%ZAPM.bs.BSDOS("XCOPY.EXE "_FN_" "_FNO,1)
 ;I $$ZOS2^%ZAPM.bs.BSDOS(FN)<0 D ErrMsg^%ZAPM.bs.BSXfun("НЕ МОГУ УДАЛИТЬ "_FN)
 Q
ANSI(S) I '$D(S1) D INIT(1)
 Q $TR(S,S1,S2)
ASCII(S) I '$D(S1) D INIT(0)
 Q $TR(S,S2,S1)
ANS(V) ;V-ДОС ФАЙЛ
 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSre"
 S DOS=51,FNO=V I $$Open^%ZAPM.bs.BSXdos(FNO,"R")
 S DOS1=DOS,FN=$L(V,".")-1 S:($L(FN,".")-1)<1 FN=1
 S DOS=52,FN=$P(V,".",1,FN)_".ASC" I $$Open^%ZAPM.bs.BSXdos(FN,"W")
 d Wait^%ZAPM.bs.BSXfun("ТРАНСЛЯЦИЯ  из ANSI ("_FNO_") в ASCII ("_FN_")")
 F v=1:1 U DOS1 R S Q:$ZC'=0  D  I '(v#50) U 0 X $G(WA)
 .U DOS W $$ASCII(S),!
 C DOS1,DOS U 0 Q
ALTS ;ПЕРЕКОДИРОВКА ТЕКУЩЕГО ТЕКСТА ИЗ ANSI --> ASCII
 I $G(@BSR@(BST,"ASCII"))="ASCII" Q
 N S,S1,S2,I
 F I=1:1 Q:'$D(@BSR@(BST,I))  S @BSR@(BST,I)=$$ASCII(@BSR@(BST,I))
 S @BSR@(BST,"ASCII")="ASCII",$P(@BSR@(BST),"@",6)=1
 Q
ALTE ;ПЕРЕКОДИРОВКА ТЕКУЩЕГО ТЕКСТА ИЗ ASCII --> ANSI
 I $G(@BSR@(BST,"ASCII"))="ANSI" Q
 N S,S1,S2,I
 F I=1:1 Q:'$D(@BSR@(BST,I))  S @BSR@(BST,I)=$$ANSI(@BSR@(BST,I))
 S @BSR@(BST,"ASCII")="ANSI",$P(@BSR@(BST),"@",6)=1
 Q
NODATE I '$D(^%ZAPM.bs.BSETUP("YEAR",1)) D OkMsg^%ZAPM.bs.BSXfun("А ПОДМЕНА И НЕ ПРОИЗВОДИЛАСЬ") Q
 I $D(^%ZAPM.bs.BSETUP("YEAR",1)) D OkMsg^%ZAPM.bs.BSXfun("ПОДМЕНА ОТМЕНЕНА") K ^%ZAPM.bs.BSETUP("YEAR",1),%BS(36)
 Q
SYSDATE N li,H S li=$$LineEdit^%ZAPM.bs.BSXfun("","ТОГДА КАКАЯ СЕЙЧАС ДАТА ? (ГГММДД)") Q:li<1
 S H=$$DATHR^%ZAPM.bs.BSsFUNR(6,li) D Yes^%ZAPM.bs.BSXfun("Я ПРАВИЛЬНО ВАС ПОНЯЛА ? "_$$ESDAY^%ZAPM.bs.BSsFUNR(6,H)) I YES<0 G SYSDATE
 I +H=+$H D OkMsg^%ZAPM.bs.BSXfun("ПОДМЕНА НЕ НУЖНА ! СИСТЕМНАЯ ДАТА И РЕАЛЬНАЯ СОВПАДАТ") G NODATE
 S ^%ZAPM.bs.BSETUP("YEAR",1)=H-$H,%BS(36)=$H+$G(^%ZAPM.bs.BSETUP("YEAR",1))
 Q
SAVE ;СОХРАНИТЬ ССЫЛКУ НА КОМАНДУ СОХРАНЕНИЯ В ТАБЛИЦЕ
 N li S li=$G(@BSR@(BST,"SVM"))
 S li=$$LineEdit^%ZAPM.bs.BSXfun(li,"ВВОДИТЕ ССЫЛКУ НА КОМАНДУ СОХРАНЕНИЯ В ТАБЛИЦЕ") Q:YES<0
 I li="" K @BSR@(BST,"SVM") Q
 S @BSR@(BST,"SVM")=li
 Q
REST ;СОХРАНИТЬ ССЫЛКУ НА КОМАНДУ ВОССТАНОВЛЕНИЯ В ТАБЛИЦЕ
 N li S li=$G(@BSR@(BST,"RSM"))
 S li=$$LineEdit^%ZAPM.bs.BSXfun(li,"ВВОДИТЕ ССЫЛКУ НА КОМАНДУ ВОССТАНОВЛЕНИЯ В ТАБЛИЦЕ") Q:YES<0
 I li="" K @BSR@(BST,"RSM") Q
 S @BSR@(BST,"RSM")=li
 Q
XM(C) ;ВЫПОЛНИТЬ КОМАНДУ
 S %zT=$ZT,$ZT="ERXM^%ZAPM.bs.BSre" X C S $ZT=$G(%zT)
 Q
ERXM D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
 Q
CloseCLC ;МОДУЛЬ ПРЕДОБРАБОТКИ - ВЫКЛ ВЫЧИСЛЕНИЯ ПОСЛЕ ПЕРВОГО РАЗА
 I R1=333,BSR["%BSbufS" K @BSR@(BST,"FCL")
 Q
CacheGR ;Restore Globals in Cache' Object
 D NaSET^%ZAPM.bs.BSZRO S NewG="" K ^BStempERROR
 F I=1:1 Q:'$D(@G@("ROU",I))  F II=1:2 Q:'$D(@G@("ROU",I,II))  D
 .S S=@G@("ROU",I,II),SS=$G(@G@("ROU",I,II+1))
 .I NewG'=$P(S,"(") S NewG=$P(S,"(") I $E(NewG,1,4)="^%ZAPM.bs.BS"&($E(NewG,1,7)'="^%ZAPM.bs.BSbuf") K @NewG
 .D CacheSET(S,SS)
 K @G I $D(^BStempERROR) S ^BStempERROR=$$ESDAY^%ZAPM.bs.BSsFUNR(6,$H) ;Date for Cache'
 D NaGET^%ZAPM.bs.BSZRO
 Q
CacheSET(S,SS) S $ZT="CacheERS^%ZAPM.bs.BSre" S @S=SS
 Q
CacheERS S ^BStempERROR(S)=SS
 Q
INHTML(BSR,BST,FILE) ;!!!!!
 Q
OUTHTMLT N OUThtml ;ВЫВОД ТАБЛИЦЫ В HTML В ВИДЕ ТАБЛИЦЫ
 ;```S OUThtml=1
OUTHTML ;ВЫВОД ТАБЛИЦЫ В HTML
 N S1,S2,BUF,BUF1,BUF2,%DEV,%FN,S,DOS,FNO,PR1
 S PR1=$TR(BST,"[]!.?_:-",""),PR1=$$NETDIR^%ZAPM.bs.BSHTML1()_$E(PR1,$L(PR1)-7,$L(PR1))_".HTM" D DOSOPN^%ZAPM.bs.BSBL1 Q:'$D(%FN)
 I '$D(S1) D INIT(1)
 I $ZV["Cach"||($ZV["IRIS") S (S1,S2)=""
 D HTML^%ZAPM.bs.BSHTML($NA(@BSR@(BST)))
 C %DEV U 0 D OkMsg^%ZAPM.bs.BSXfun("Вывод Завершен")
 Q
TXT2HTML ;ВЫВОД ТЕКСТА В HTML
 N S1,S2,BUF,BUF1,BUF2,%DEV,%FN,S,DOS,FNO,PR1,EXT,v,PR1
 S PR1=$TR(BST,"[]!.?_:-",""),PR1=$$NETDIR^%ZAPM.bs.BSHTML1()_$E(PR1,$L(PR1)-7,$L(PR1))_".HTM" D DOSOPN^%ZAPM.bs.BSBL1 Q:'$D(%FN)
 I '$D(S1) D INIT(1)
 I $ZV["Cach"||($ZV["IRIS") S (S1,S2)=""
 d Wait^%ZAPM.bs.BSXfun("вывод HTML") S EXT="HTM"
 U %DEV W "<HTML><TITLE>"_BST_"</TITLE><BODY><PRE>",!
 F v=1:1 Q:'$D(@BSR@(BST,v))  D  U 0 X $G(WA)
 .U %DEV W $$HTm($TR(@BSR@(BST,v),S1,S2)),!
 U %DEV W "</PRE></BODY></HTML>"
 C %DEV U 0 D OkMsg^%ZAPM.bs.BSXfun("Вывод Завершен")
 Q
COPY(F) ;КОПИРОВАНИЕ ФАЙЛОВ ПОД НОВЫМ ИМЕНЕМ С ПРЕФИКСОМ ИЗ ИМЕНИ ДИРЕКТОРИИ
 N P,N,E,D
 S P=$P(FILE,"\",1,$L(FILE,"\")-2)
 S D=$P(FILE,"\",$L(FILE,"\")-1)
 S N=$P(FILE,"\",$L(FILE,"\"))
 S EXE=$$JOB^%HOSTCMD("COPY "_F_" "_P_"\"_D_"\"_D_N)
 Q
nbsp2(F) ;ЗАМЕНИТЬ НА ПРОБЕЛ
 N F1 S F1=$E(F,1,$L(F)-1)_"1"
 S EXE=$$JOB^%HOSTCMD("COPY "_F_" "_F1)
 S EXE=$$JOB^%HOSTCMD("DEL "_F)
 S %zT=$ZT,$ZT="ERFILE^%ZAPM.bs.BSre"
 S DOS=51,FNO=F1 I $$Open^%ZAPM.bs.BSXdos(FNO,"R")
 S DOS1=DOS,FN=F
 S DOS=52 I $$Open^%ZAPM.bs.BSXdos(FN,"W")
 d Wait^%ZAPM.bs.BSXfun(F)
 F v=1:1 U DOS1 R S Q:$ZC'=0  D  I '(v#50) U 0 X $G(WA)
 .U DOS W $$TR^%ZAPM.bs.BSsFUNM(S,"&nbsp;"," "),!
 C DOS1,DOS U 0
 S EXE=$$JOB^%HOSTCMD("DEL "_F1)
 Q
 
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSrep0" type="MAC" languagemode="0"><![CDATA[
%BSrep0 ;ОТЧЕТ ПО ТАБЛИЦЕ ```ОТЛАДКА ; 14:09   25.11.2000
 Q
int //внутрення точка входа для ИП
 ;N MAS S MAS(1,1)=BSTABL,MAS(1,2)=BSPART,MAS(1,3)=BSNSP
 D INFOtab2 ;(.MAS) 
 Q
ALLint  N STOP,XBD,MAS,U1,i,XTABL,XPART,MAF S XTABL="I $E(BSTABL,1)=""F"" S MAF(BSTABL)=BSPART" //ПЕРЕБОР ВСЕХ ФОРМ
 d LoopINT^%ZAPM.bs.BSCocx1 
 S U1="" F i=1:1  S U1=$O(MAF(U1)) Q:U1=""  S MAS(i,1)=U1,MAS(i,2)=MAF(U1),MAS(i,3)=BSNSP
 D INFOtab(.MAS) 
 Q
INFOtab(MAS) D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("Расширенная информация по структуре таблицы описания баз данных (%BS-формат)"),$$B27^%ZAPM.bs.BSCGIS(1)
 ;D locvar^%ZAPM.bs.BSCh0("",1)
 S I="" F  S I=$O(MAS(I)) Q:I=""  D INFOtab1(MAS(I,3),MAS(I,2),MAS(I,1))
 D BUTT^%ZAPM.bs.BSCGIS,END^%ZAPM.bs.BSC4
 q 
INFOtab1(BSNSP,BSPART,BSTABL)
 I '$$ZU^%ZAPM.bs.BSF4(BSNSP) Q
 W BK_MAROON_BSPART_"("_BSTABL_") "_EF_BLUE_$P(@BSPART@(BSTABL),"@")_EF_BBK_" <IFRAME WIDTH='900px' HEIGHT='200px' SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"INFOtab2^%ZAPM.bs.BSrep0")_"' name='ASIFRAME' SCROLLING='auto'></IFRAME><BR>"_BK
 Q
INFOtab2 D BEG1^%ZAPM.bs.BSC4
 S BSR=BSPART,BST=BSTABL D INFO^%ZAPM.bs.BSF6
 ;D locvar^%ZAPM.bs.BSCh0("",1)
 D SUMMINFO W "<PRE>" S I="" F  S I=$O(@BSr@(BSt,I)) Q:I=""  W BK_$P($G(@BSr@(BSt,I)),":")_MAROON_$P($G(@BSr@(BSt,I)),":",2)_EF d
 .i I=5 I $D(@BSR@(BST,"EXTAB")) W " Еxcell - проекция: "_BLUE_$p($g(@BSR@(BST,"EXTAB",1)),$c(9),1)_" "_$$CtrlRow^%ZAPM.bs.BSCocx1($NA(@BSR@(BST,"EXTAB")),4)_EF
 .i I=9 s i="" f  s i=$o(sum(i)) q:i=""  w " ("_RED_sum(i)_EF_"="_$$FORM^%ZAPM.bs.BSTT(i)_")"
 W "</PRE>"
 D END^%ZAPM.bs.BSC4
 Q 
TIP(%3) Q " ("_$S(%3=1:"простая таблица",%3=2:"таблица описывающая базу данных",%3=3:"таблица описывающая отчет по базе данных в виде списка",%3=4:"таблица описывающая отчет по базе данных в виде сводки",%3=5:"текст",%3=6:"таблица-Link",%3=7:"таблица-меню",%3=8:"панель с кнопками",%3=9:"насчитанный отчет",%3=10:"отчет по базе данных",%3=11:"диалоговая панель",1:"неизвестный тип")_")"
CR D CR^%ZAPM.bs.BSTT Q
GLOBAL S iS=$G(%KAT(1)),iB=$G(%KAT(2)),iBS=$G(%KAT(3)),BSr="^%ZAPM.bs.BSbufB",BSt="TotalSummeryInfo"
 S t0="---------=========== =============---------" D CR
 S t0="СВОДНЫЙ ОТЧЕТ ПО ТАБЛИЦЕ:  "_$P($G(%KAT(1)),"!",3) D CR
 S t0="                 РАЗДЕЛА:  "_$P($G(%KAT(1)),"!",2) D CR
 S t0="             ТИП ТАБЛИЦЫ:  "_$$TIP^%ZAPM.bs.BS($P($G(%KAT(2)),"@",17))_" "_$$TIP($P($G(%KAT(2)),"@",17)) D CR
 S t0="ПОСЛЕДНИЙ МОДИФИЦИРОВАЛ :  "_$P(%KAT(7,"LST"),",",3)_"   "_$$ESDAY^%ZAPM.bs.BSsFUNR(8,$P(%KAT(7,"LST"),",",1,2)) D CR
 S t0="---------=========== =============---------" D CR
 S t0="Коментарий к таблице     :"_$P($G(iB),"@",1) D CR
 S t0="Паpоли: НаВход, Коpекцию Данных, Коpекцию Описания Таблицы :"_$S($P($G(iB),"@",2)'="":"Yes",1:"No")_","_$S($P($G(iB),"@",5)'="":"Yes",1:"No")_","_$S($P($G(iB),"@",4)'="":"Yes",1:"No") D CR
 s t0="Статус таблицы включен   :"_$S('$P($G(iB),"@",16):"Yes",1:"No") D CR
 S t0="Кооpдинаты окна пpосмотpа :"_$TR($P($G(iB),"@",8,11),"@",",") D CR
 S t0="Защита всей таблицы      :"_$S($P($G(iB),"@",16):"Yes",1:"No") D CR
 S t0="Титул таблицы            :"_$P($G(iB),"@",19) D CR
 S t0="Таблица оптимизиpована   :"_$S($P($G(iB),"@",22):"Yes",1:"No") D CR
 S t0="Видеостатус таблицы      :"_$S($P($G(iB),"@",21):"Yes",1:"No") D CR
 S t0="Таблица соpтиpуема       :"_$P($G(iB),"@",36) D CR
 S t0="Логический контpоль      :"_$S('$D(@$P($G(%KAT(1)),"!",2)@($P($G(%KAT(1)),"!",3),"COL")):"No",1:"Yes") D CR
 S t0="Стандаpтная обpаботка Функциональных клавиш :"_$S($P($G(iB),"@",15):"Yes",1:"No") D CR
 S t0="Количество стpок,колонок :"_$TR($P($G(iB),"@",28,29),"@","x") D CR
 S t0="Есть ссылки на Базу Данных расположенную на локальном пpиводе :"_$S($P($G(iB),"@",37):"Yes",1:"No") D CR
 S t0="Поpядок вычисления       :"_$S("1"[$P($G(iB),"@",18):"направо-вниз",$P(G(iB),"@",18)=2:"направо-вверх",$P(G(iB),"@",18)=3:"налево-вниз",1:"налево-вверх") D CR
 S t0="Вычисления постоянно     :"_$S($P($G(iB),"@",20):"Yes",1:"No") D CR
 S t0="Список Логического Контроля по символьным именам вывода :"_$S($P($G(iB),"@",35):$P($G(iB),"@",35),1:"No") d CR
 S t0="Таблица закpывается      :"_$S('$P($G(iB),"@",16):"Yes",$P($G(iB),"@",16)="":"только по F6",1:"Постоянно,но не перед выходом") D CR
 S t0="Нестандаpтный текст помощи по F1 :"_$P($G(%KAT(2)),"@",39) d CR
 S t0="Режим пpосмотpа и поиска :"_$S($P($G(iB),"@",40):"Yes",1:"No") D CR
 S t0="База данных -----------  :"_$G(%KAT(5),"нет") D CR
 S t0="Постдвижение указателя   :"_$S($P($G(iB),"@",44)="":"Общесистемное",$P($G(iB),"@",44)=0:"нет",$P($G(iB),"@",44)=1:"вниз",$P($G(iB),"@",44)=2:"вправо",1:"?") D CR
 S t0="Предобработка Ф.клавиш   :"_$S($P($G(iB),"@",41)="":"No",1:$P($G(iB),"@",41)) d CR
 S t0="Указатель устанавливается только на клетки разрешенные для редактирования: "_$S($P($G(iB),"@",43):"Yes",1:"No") D CR
 S t0="Таблица скрытая          :"_$S($P($G(iB),"@",42):"Yes",1:"No") D CR
 S t0="Подтвержать запись в базу:"_$S($P($G(iB),"@",45):"Yes",1:"No") D CR
 S t0="АвтоФорматирование таблицы:"_$S($P($G(iB),"@",47):"Yes",1:"No") D CR
 S t0="В ТАБЛИЦЕ ЕСТЬ ПОМЕЧЕННЫЙ БЛОК   :"_$S($P($G(iB),"@",3):"Yes",1:"No") D CR
 S t0="БЫЛА КОРРЕКЦИЯ ОПИСАНИЯ ТАБЛИЦЫ  :"_$S($P($G(iB),"@",7):"Yes",1:"No") D CR
 S t0="БЫЛА КОРРЕКЦИЯ ДАННЫХ ТАБЛИЦЫ    :"_$S($P($G(iB),"@",6):"Yes",1:"No") D CR
 S t0="ВЫКЛЮЧЕН СТАТУС                  :"_$S($P($G(iB),"@",23):"Yes",1:"No") D CR
 S t0="ТАБЛИЦА="_$S($P($G(iB),"@",24):"ПОДЖАТА",$P($G(iB),"@",24)="S":"СПИСОК",1:"РАЗЖАТА") D CR
 S t0="КУРСОР В ТЕКУЩЕЙ КЛЕТКЕ          :"_$S($P($G(iB),"@",25):"Yes",1:"No") D CR
 S t0="РЕДАКТИРОВАНИЕ ПРОИСХОДИТ В "_$S($P($G(iB),"@",26)=1:"СТРОЧНОМ РЕДАКТОРЕ",1:"ТЕКУЩЕЙ КЛЕТКЕ") D CR
 S t0="ЦВЕТ ВСЕЙ ТАБЛИЦЫ (КОД)          :"_$P($G(iB),"@",31) D CR
 S t0="В ФОРМУЛАХ ВЫЧ. ЕСТЬ ССЫЛКИ НА ДРУГИЕ ФОРМУЛЫ ВЫЧИСЛЕНИЯ       :"_$S($P($G(iB),"@",32):"Yes",1:"No") D CR
 S t0="В ФОРМ.ЛОГ. ЕСТЬ ССЫЛКИ НА ДРУГИЕ ФОРМУЛЫ ЛОГИЧЕСКОГО КОНТРОЛЯ :"_$S($P($G(iB),"@",33):"Yes",1:"No") D CR
 S t0="ВКЛЮЧЕН РЕЖИМ= ТАБЛИЦУ НЕ ЗАКРЫВАТЬ ДЛЯ ДРУГИХ ПОЛЬЗОВАТЕЛЕЙ   :"_$S($P($G(iB),"@",34):"Yes",1:"No") D CR
 S t0="РАМКА ОБРАМЛЕНИЯ "_$S($P($G(iB),"@",38)=1:"ОДИНАРНАЯ",$P($G(iB),"@",38)=2:"ДВОЙНАЯ",1:$P($G(iB),"@",38)) D CR
 S t0="ССЫЛКА НА ТЕКСТ ОБОЕВ ТАБЛИЦЫ        :"_$P($G(iB),"@",46) D CR
 S t0="Вычислять значения КЛЕТОК, если ЛОГИЧЕСКИЙ КОНТРОЛЬ НЕ ПРОШЕЛ :"_$S($P($G(iB),"@",48):"Yes",1:"No") D CR
 S t0="ТЕКСТ КОМЕНТАРИЯ ВСТАВЛЯТЬ В ВОПРОС О ЗАПИСИ КОРРЕКЦИИ В БД   :"_$S($P($G(iB),"@",49):"Yes",1:"No") D CR
 S t0="---------=========== =============---------" D CR
 q:$D(%KAT(5))'["11"&('$D(%KAT(6)))  S t0="        ----- ОПИСАНИЕ КЛЮЧЕЙ -----" D CR
 I $P($G(%KAT(6,1)),"@",15)="NEWVIEW" S t0="ВКЛЮЧЕН РЕЖИМ СКОРОСТНОГО ПРЕДСТАВЛЕНИЯ ОТЧЕТА" D CR
 F ny=0:1:9 I $D(%KAT(5,ny)) D
 .S t0="---------=========== Номер "_ny_" =============---------" D CR
 .S t0="текст приглашения для ввода нового ключа  : "_$P($G(%KAT(5,ny)),"@",15) D CR
 .S t0="ТЕКСТ ПУНКТА для ввода нового ключа       : "_$P($G(%KAT(5,ny)),"@",5) D CR
 .S t0="текст помощи вызываемой по F1             : "_$P($G(%KAT(5,ny)),"@",20) D CR
 .S t0="фомулы синтаксич.контроля для нового ключа: "_$G(%KAT(5,ny,2)) d CR
 .S t0="фомулы трансформации                      : "_$G(%KAT(5,ny,4)) D CR
 .S t0="мультитабличная база данных               : "_$G(%KAT(5,ny,6)) D CR
 .S t0="прикрепленная таблица к ключу             : "_$P($G(%KAT(5,ny)),"@",14) D CR
 .S t0="НАЧАЛЬНОЕ ЗНАЧЕНИЕ КЛЮЧА     :"_$P($G(%KAT(5,ny)),"@",1) D CR
 .S t0="КОНЕЧНОЕ ЗНАЧЕНИЕ КЛЮЧА      :"_$P($G(%KAT(5,ny)),"@",4) D CR
 .S t0="ТЕКСТ КОНЦА В СПИСКЕ\СВОДКЕ  :"_$P($G(%KAT(5,ny)),"@",12) D CR
 .S t0="ТЕКСТ НАЧАЛА В СПИСКЕ\СВОДКЕ :"_$P($G(%KAT(5,ny)),"@",2) D CR
 .S t0="YX - Y,X РАЗМЕРЫ ТАБЛИЦЫ СПИСКА ДАННЫХ КЛЮЧА:"_$P($G(%KAT(5,ny)),"@",6) D CR
 .S t0="ТЕКСТ ПРИ ОПРЕДЕЛЕНИИ ВЫБОРКИ:"_$P($G(%KAT(5,ny)),"@",9) D CR
 .S t0="КОД ЦВЕТА                    :"_$P($G(%KAT(5,ny)),"@",10) D CR
 .F ii=10:1 Q:'$D(%KAT(5,ny,ii))  D
 ..S t0="особая выборка (текст)            : "_$G(%KAT(5,ny,ii)) D CR
 ..S t0="особая выборка (формула-логика)   : "_$G(%KAT(5,ny,ii,2)) D CR
 F ny=0:1:9 I $D(%KAT(6,ny)) D
 .S t0="---------=========== Номер "_ny_" =============---------" D CR
 .F ii=10:1 Q:'$D(%KAT(6,ny,ii))  D
 ..S t0="специальная выборка (текст)          : "_$G(%KAT(6,ny,ii)) D CR
 ..S t0="специальная выборка (формула-логика) : "_$G(%KAT(6,ny,ii,2)) D CR
 S t0="---------=========== =============---------" D CR
 Q
SUMMINFO ;СВОДНЫЙ ОТЧЕТ ПО ТАБЛИЦЕ
 N TotalSi,iI
 S TotalSi=1 D GLOBAL k sum
 F iI="FTR","FCL","COL","RTR","CMD","TAB","NAO","NAX" D @(iI_"^%ZAPM.bs.BSTT") S t0="---------=========== =============---------" D CR
 S $P(@(BSr_"(BSt)"),"@")="СВОДНЫЙ ОТЧЕТ ПО ТАБЛИЦЕ" I $D(BSTABL) D CREAT^%ZAPM.bs.BSTT Q  //ДЛЯ ИП
 D CREATE^%ZAPM.bs.BSTT
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSsBUF" type="MAC" languagemode="0"><![CDATA[
%BSsBUF ;РАБОТА С ВИДЕОБУФЕРОМ ; 17:59   04.03.99
 q
SA ;I $G(%BS(13))'="%BS-PC" Q
 d SaveWinV^%ZAPM.bs.BSXfun(1,1,25,80,"^%ZAPM.bs.BSbufB(""BUG"_$G(%BS(3),$P)_$J_"u"")") ;D CW
 Q
RE d LoadWinV^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB(""BUG"_$G(%BS(3),$P)_$J_"u"")") ;D CW
 I $G(%BS(13))'="%BS-PC" D
 .Q:'$D(BSR)!('$D(BST))  Q:BSR'["^"  ;ДЛЯ СТРОЧНОГО РЕДАКТОРА
 .Q:$D(XXx)  ;ПАНЕЛЬ С КНОПКАМИ
 .Q:'$D(@BSR@(BST))  Q:$P(@BSR@(BST),"@",17)=5  ;ТЕКСТ
 . ;```W !,BSR_"/"_BST R R ;---//--- для msm 4.x.x
 .I '$D(ENTERkk) D TIP^%ZAPM.bs.BST,TIT^%ZAPM.bs.BST,W^%ZAPM.bs.BST
 Q
SaveLock(BFL,%Y1,%X1,%Y2,%X2) ;зап.часть экр. в локаль %X1,%Y1,%X2,%Y2
 I $ZV["Wind"!($ZV["Cach"||($ZV["IRIS")) Q
7 S @BFL@(0)=%X1 F %=%Y1:1:%Y2 S @BFL@(%)=$V(%-1*160+(%X1-1*2)+%BS(17),-1,%X2-%X1+1*2,1)
 Q
CW  N A S A=$ZR S ^%ZZZ($I)=%BS(15) I $D(@A)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSsFUN" type="MAC" languagemode="0"><![CDATA[
%BSsFUN ;ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ ; 15:54   05.05.2000
 Q  ;%1-{ОТ}  %2-ШАГ  %3-{ДО}  %4-УСЛОВИЕ
%1 I %1["{" S %1=$TR(%1,"{}",""),%3=$TR(%3,"{}","")
 S jb=$P(%1,",",2),ib=$P(%1,","),BStf=BST,BSrf=BSR
 S je=$P(%3,",",2),ie=$P(%3,",")
 I 'jb X "S jb="_jb
 I 'ib X "S ib="_ib
 I 'ie X "S ie="_ie
 I 'je X "S je="_je
 I '(%1["ny"!(%3["ny")) S ie=ie+$G(%Co,0),ib=ib+$G(%Co,0)
 S %4=$G(%4,1)
 Q
SUM(%1,%2,%3,%4,%5) ;СУММА КЛЕТОК
 N BSrf,BStf,s,k,i3
 D %1
 S %0=0 F s=ib:$G(%2,1):ie F k=jb:$G(%2,1):je X "I "_%4 I  D  S %0=%0+i3
 .I $P($G(@(BSrf_"(BStf,s,k)"),"@@@@@@@@1"),"@",9)=1 S i3=$P($G(@$ZR),"@",15) Q
 .E  I BST=BStf S i3=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),s,k)) Q
 .E  S i3=""
 Q $S(%0'=0:%0,1:$S($G(%5):0,1:""))
SUMSPPI(%1,%2,%3,%4) ;СУММА ДЛЯ ПРОМЕЖУТОЧНОГО ИТОГА %1-КОЛОНКА
 K Pi S k=%1,%0=0 S:%4="" %4=1 F s=ny-1:-1:1 I $G(@(BSR_"(BST,s)")) D  Q:$G(Pi)="END"
 .I '$D(Pi) S Pi=@$ZR
 .I Pi'=@$ZR S Pi="END" Q
 .X "I "_%4 I  S %0=%0+$P(@(BSR_"(BST,s,k)"),"@",15)
 K Pi Q %0
SUMSPI(%1,%2,%3,%4) ;СУММА ИТОГА СПИСКА %4-УСЛОВИЕ
 S k=%1,%0=0 S:%4="" %4=1 F s=ny-1:-1:1 I $G(@(BSR_"(BST,s)")) D
 .X "I "_%4 I  S %0=%0+$P(@(BSR_"(BST,s,k)"),"@",15)
 Q %0
PLU(%1,%2,%3,%4) ;ПЛЮСОВАНИЕ
 D %1 S %0=0 F s=ib:%2:ie F k=jb:%2:je X "I "_%4 I  S %0=%0+1
 Q %0
MAX(%1,%2,%3,%4) ;МАКСИМУМ
 D %1 S %0=-999999999 F s=ib:%2:ie F k=jb:%2:je X "I "_%4 I  D  S:%0<i3 %0=i3
 .I $P($G(@(BSrf_"(BStf,s,k)"),"@@@@@@@@1"),"@",9)=1 S i3=$P($G(@$ZR),"@",15) Q
 .E  I BST=BStf S i3=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),s,k)) Q
 .E  S i3=0
 Q %0
MIN(%1,%2,%3,%4) ;МИНИМУМ
 D %1 S %0=999999999 F s=ib:%2:ie F k=jb:%2:je X "I "_%4 I  D  S:%0>i3 %0=i3
 .I $P($G(@(BSrf_"(BStf,s,k)")),"@",9)'=2 S i3=$P($G(@$ZR),"@",15) Q
 .E  I BST=BStf S i3=$G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),s,k)) Q
 .E  S i3=0
 Q %0
STEP(%1,%2) ;
 ;ВОЗВЕДЕНИЕ %1 В СТЕПЕНЬ %2 РЕЗУЛЬТАТ В %0
 S %0=%1 F I=2:1:%2 S %0=%0*%1
STEPE K I Q %0
ABS(%1) ;
 ;МОДУЛЬ ЧИСЛА %1
 I %1<0 S %1=%1*-1
ABSE S %0=%1 Q %0
DEL(%1,%2) ;
 ;ДЕЛЕНИЕ %1 НА %2=%0 ,ЕСЛИ %2=0 ,ТО %0="<DIVER>"
 I +%2=0 S %0="<DIVER>" Q %0
DELE S %0=%1/%2 Q %0
DEN(%1,%2) ;
 ;ДЕЛЕНИЕ НАЦЕЛО %1 НА %2=%0 ,ЕСЛИ %2=0 ,ТО %0="<DIVER>"
 I %2=0 S %0="<DIVER>" Q %0
DENE S %0=%1\%2 Q %0
PROC(%1,%2,%3,%4,%5) 
 ;ВЗЯТИЕ ПРОЦЕНТА ЧИСЛА %1 К ЧИСЛУ %2 ,ЕСЛИ %2=0 ,ТО %0="<DIVER>" при %3=1
 ;%4 -СКОЛЬКО ЗНАКОВ ПОСЛЕ ТОЧКИ
 ;%5 =1 ПИСАТЬ СИМВОЛ %
 I +%2=0 S %0=$S($G(%3):"<DIVER>",1:"") Q %0
 I +%1=0 S %0=$S($G(%3):"<DIVER>",1:"") Q %0
%E S %0=%1*100/%2 I $D(%4) S %0=$FN(%0,"",%4)
 Q %0_$S($G(%5):"%",1:"")
OST(%1,%2) ;
 ;ОСТАТОК ОТ ДЕЛЕНИЯ %1 НА %2 ,ЕСЛИ %2=0 ,ТО %0="<DIVER>"
 I %2=0 S %0="<DIVER>" Q %0
 S %0=%1/%2 I %0["." S %0=$P(%0,".",2) Q %0
OSTE E  S %0=0 Q %0
SIN(%1) ;
 ;ВЫЧИСЛЕНИЕ SIN(%1)=%0
 I %1>180 S %1=%1-180*-1
 S %1=%1*.017453277
 S %1=%1-(%1*%1*%1/6)+(%1*%1*%1*%1*%1/120)-(%1*%1*%1*%1*%1*%1*%1/5040)
SINE S %0=%1 Q %0
COS(%1) ;
 ;ВЫЧИСЛЕНИЕ COS(%1)=%0
 S SOC=1 I %1>180 S %1=%1-180,SOC=-1
 S %1=%1*.017453277
 S %1=1-(%1*%1/2)+(%1*%1*%1*%1/24)-(%1*%1*%1*%1*%1*%1/720)+(%1*%1*%1*%1*%1*%1*%1*%1/40320),%1=%1*SOC
COSE S %0=%1 Q %0
SQR(%1) ;
SQ ;ИЗВЛЕЧЕНИЕ КВАДРАТНОГО КОРНЯ SQRT(%1)=%0
 S KONS=.00000000001 S VX0=0,VX1=%1+1 S:%1>1 KONS=%1*KONS*%1
VX S VIX=VX0+VX1/2,KONTR=VIX*VIX I %1+KONS'<KONTR&((%1-KONS)'>KONTR) S %0=VIX K VIX,VX0,VX1,KONS,KONTR,CC Q %0
 I KONTR>%1 S VX1=VIX G VX
 I KONTR<%1 S VX0=VIX G VX
ATAN G ARG:(CC*CC-.01)<0 S %1=CC*CC+1 D SQ S CC=CC/(1+VIX) D ATAN S CC=2*CC Q
ARG S CC=CC-(CC*CC*CC/3)+(CC*CC*CC*CC*CC/5)-(CC*CC*CC*CC*CC*CC*CC/7)
SQRTE Q
SPSTR(%1) ;НУМЕРАЦИЯ СТРАНИЦ СПИСКА ПРИ НАЛИЧИЯ ПРОМ.ИТОГА
 S %0="" F s=ny:1 Q:'$D(@(BSR_"(BST,s)"))  I $G(@$ZR) S %0="стp."_@$ZR
 Q %0
 ;
 ;МОДУЛЬ ИЗ %BSA
 ;
A(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16) S pp=$P($G(BSR),"^",2),ps=$S(pp'[",":$P($$ZU^%ZAPM.bs.BS3(0),",",2),1:$P(pp,$C(34),4))
 S pu=$S(pp'["[":$P($$ZU^%ZAPM.bs.BS3(0),","),1:$P(pp,$C(34),2)),pt=$G(BST) I $E(pp,1)="[" S pp=$P(pp,"]",2)
 S %zT=$ZT,$ZT="TRAP^%ZAPM.bs.BSA"
 I $D(p4) S pp=p4 I pp["^" S pp=$P(pp,"^",2)
 I $G(p3)'="" S pt=p3
 I $G(p5)'="" S pu=$TR(p5,"[]|""","") I pu["," S ps=$P(pu,",",2),pu=$P(pu,",")
 I $G(p6)'="" S ps=$TR(p6,"[]|""","") I ps["," S pu=$P(ps,","),ps=$P(ps,",",2)
 ;I $E(pp,1)="%" S pp="^"_pp ;`BSA
 S pp="^["""_pu_""","""_ps_"""]"_pp
 I $D(@(pp_"(pt,p1,p2)"))
 S bS=$ZR I $P(@(pp_"(pt,p1,p2)"),"@",9)=1 Q $P($G(@$ZR),"@",15)
 I '$D(p8),BST=pt,$$BSR(BSR)=pp Q $G(^%ZAPM.bs.BSbufB("BB"_$G(%BS(3),$P)_$J_"u"_%BS(15),p1,p2))
 S pb=$$KBD^%ZAPM.bs.BSF12($NA(@pp@(pt))),pb=$$BSD(pb,$G(p7))
 F pi=1:1:9 Q:'$D(^(pi))  Q:'$D(@("p"_(pi+7)))  S pb=pb_$S(@("p"_(pi+7))=+@("p"_(pi+7)):@("p"_(pi+7)),1:$C(34)_@("p"_(pi+7))_$C(34))_","
 S pij=p1_","_p2 I $P($G(@pp@(pt,"KEY",pi-1)),"@",6)="HiddenLastKey",$P($P(@(pp_"(pt,p1,p2)"),"@",18),"#",2)'="" D  Q $G(@$ZR,"<NO_VALUE>")
 .S pij=$P($P(@$ZR,"@",18),"#",2) I $D(@(pb_$C(34)_pij_""")"))
 I $P($P(@(pp_"(pt,p1,p2)"),"@",18),"#")'="" S pij=$P($P(@$ZR,"@",18),"#")
 I $D(@(pb_$C(34)_pij_""")")) Q @$ZR
 Q "<NO_VAL>"  ;$ZR
BSD(BSD,%NAm) ;ССЫЛКА НА УЗЕЛ БАЗЫ ДАННЫХ
 S %NAm=BSD_$G(%NAm)_$S(BSD["(":"",1:"(") I $E(%NAm,$L(%NAm))=")" S %NAm=$E(%NAm,1,$L(%NAm)-1)_","
 Q %NAm
BSR(bsr) N bs ;ПОЛНАЯ ССЫЛКА
 I $E(bsr,1,2)="^%" Q $$%^%ZAPM.bs.BSF12(bsr)
 ;4.;I $P($ZV,"Version ",2)'<4,bsr'["|" Q "^|"""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""|"_$P(bsr,"^",2)
 ;4.;I $P($ZV,"Version ",2)'<4,$P(bsr,"|",2)'["," S bs=$P($P(bsr,"|",2),$C(34),2) Q "^|"""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""|"_$P(bsr,"|",2)
 I bsr'["]" Q "^["""_$P($$ZU^%ZAPM.bs.BS3(0),",")_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(bsr,"^",2)
 I $P($P(bsr,"]"),"[",2)'["," S bs=$P($P($P(bsr,"]"),"[",2),$C(34),2) Q "^["""_bs_""","""_$P($$ZU^%ZAPM.bs.BS3(0),",",2)_"""]"_$P(bsr,"]",2)
 Q bsr
]]></Routine>


<Routine name="%ZAPM.bs.BSsFUNA" type="MAC" languagemode="0"><![CDATA[
%BSsFUNA ;ФУНКЦИИ АТРИБУТОВ КЛЕТОК И ТАБЛИЦ ; 11:27 15-APR-94
S Q:'$D(bS)  S bs=$G(@bS) Q:bs=""  S bd=$P(bS,",",1,$L(bS,",")-2),b=@(bd_")") Q
SB Q:'$D(bd)  S bd=$P($G(@(bd_",""KEY"")")),"@") Q
AC(%1) N bs,b,bd D S ;ЦВЕТ КЛЕТКИ %1
 S %0=$P($G(bs),"@",10) Q %0
AD(%1) N bs,b,bd D S ;ДЛИНА
 S %0=$P($G(bs),"@",4) Q %0
AH(%1) N bs,b,bd D S ;ВЫСОТА
 S %0=$P($G(bs),"@",3) Q %0
AP(%1) N bs,b,bd D S ;ПОМЕЧЕНА =1
 S %0=+$P($G(bs),"@",12) Q %0
AX(%1) N bs,b,bd D S ;АБСОЛЮТНАЯ КООРДИНАТА X
 S %0=$P($G(bs),"@",2) Q %0
AY(%1) N bs,b,bd D S ;...Y
 S %0=$P($G(bs),"@",1) Q %0
AT(%1,%2) N bs,b,bd,nf D S ;ТРАНС
 S nf=$P($G(bs),"@",8) I nf="" Q ""
 I nf,nf?.N1",".N Q $G(@(bd_",""FTR"","_nf_$S($G(%2):",1)",1:")"))) 
 S nf=$P($P(bS,",",$L(bS,",")-1,$L(bS,",")),")") Q $G(@(bd_",""FTR"","_nf_$S($G(%2):",1)",1:")"))) 
AR(%1,%2) N bs,b,bd,nf D S ;СИНТ
 S nf=$P($G(bs),"@",16) I nf="" Q ""
 I nf,nf?.N1",".N Q $G(@(bd_",""RTR"","_nf_$S($G(%2):",1)",1:")"))) 
 S nf=$P($P(bS,",",$L(bS,",")-1,$L(bS,",")),")") Q $G(@(bd_",""RTR"","_nf_$S($G(%2):",1)",1:")"))) 
AL(%1,%2) N bs,b,bd,nf D S ;ЛОГ
 S nf=$P($G(bs),"@",13) I nf="" Q ""
 I nf,nf?.N1",".N Q $G(@(bd_",""COL"","_nf_$S($G(%2):",1)",1:")"))) 
 S nf=$P($P(bS,",",$L(bS,",")-1,$L(bS,",")),")") Q $G(@(bd_",""COL"","_nf_$S($G(%2):",1)",1:")"))) 
AF(%1,%2) N bs,b,bd,nf D S ;ВЫЧ
 S nf=$P($G(bs),"@",7) I nf="" Q ""
 I nf,nf?.N1",".N Q $G(@(bd_",""FCL"","_nf_$S($G(%2):",1)",1:")"))) 
 S nf=$P($P(bS,",",$L(bS,",")-1,$L(bS,",")),")") Q $G(@(bd_",""FCL"","_nf_$S($G(%2):",1)",1:")"))) 
AB(%1) N bs,b,bd D S ;ХРАНИТСЯ В БАЗЕ=1
 S %0=$P($G(bs),"@",9) Q %0
AU(%1,%2) N bs,b,bd D S ;%2=# PICE
 S %0=$P($G(bs),"@",%2) Q %0
ATB(%1) N bs,b,bd D S,SB ;ИМЯ БАЗЫ ДАННЫХ
 S %0=$G(bd) Q %0
ATK(%1) N bs,b,bd D S ;КОЛ-ВО КОЛОНОК У ТАБЛИЦЫ %1
 S %0=$P($G(b),"@",29) Q %0
ATU(%1,%2) N bs,b,bd D S ;%2=# PICE
 S %0=$P($G(b),"@",%2) Q %0
ATS(%1) N bs,b,bd D S ;...СТРОК
 S %0=$P($G(b),"@",28) Q %0
ATC(%1) N bs,b,bd D S ;ОБЩИЙ ЦВЕТ
 S %0=$P($G(b),"@",31) Q %0
 Q ""
e Q
]]></Routine>


<Routine name="%ZAPM.bs.BSsFUNM" type="MAC" languagemode="0"><![CDATA[
%BSsFUNM ;ПОЛЬЗОВАТЕЛЬСКИЕ ФУНКЦИИ ; 16:36   16.10.2000
SELECT(%1,%2,%3,%4) ;ГЛОБАЛЬНЫЙ $SELECT
 ;%1-НОМЕР ПЕРЕМЕННОЙ
 ;%2-ИМЯ ТАБЛИЦЫ,РАЗДЕЛА ОПИСАНИЯ БАЗЫ ЛОГ. УСЛОВИЙ (DFLT="LOGIC,%BSZ")
 ;%3-ИМЯ УЗЛА В БАЗЕ ЛОГ. УСЛОВИЙ
 ;%4-ВЫЗОВ ТАБЛИЦЫ\ТЕКСТА ПО <F1>
 N TEST,ZrE,Dt,li,iX
 S ZrE=$ZR,Dt=$T ;SAVETEST
SELE I $D(cHOSe("S",%1)) S $ZT="ERRSEL^%ZAPM.bs.BSsFUNM" D  Q $G(li)
 .K li S iX="" F  S iX=$O(cHOSe("S",%1,iX)) Q:iX=""  X "I "_cHOSe("S",%1,iX,"LOG")_" S li=cHOSe(""S"",%1,iX,""SEL"")" I  Q
 K cHOSe("S",%1) I $G(%3)="" D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА 3 УСЛОВИЯ В ФУНКЦИИ $$SELECT !") Q 0
 I $G(%2)="" S %2="LOGIC,%BSZ"
 S li=$$RIT(%2),li=$$KBD^%ZAPM.bs.BSF12(li) I li="" D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА В ИМЕНИ БАЗЫ УСЛОВИЙ $$SELECT !") Q 0
 S iX="" F  S iX=$O(@li@(%3,iX)) Q:iX=""  S cHOSe("S",%1,iX,"LOG")=$G(@li@(%3,iX,"L1")),cHOSe("S",%1,iX,"SEL")=$G(@li@(%3,iX,"S1"))
 I $D(cHOSe("S",%1)) G SELE
 Q 0
ERRSEL D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)_" ---->  "_$G(cHOSe("S",%1,iX))) S $ZT=$G(%zT)
 Q 0
LOGIC(%1,%2,%3,%4,%5) ;БАЗА ЛОГ. УСЛОВИЙ ДЛЯ ФУНКЦИИ
 ;%1-НОМЕР ПЕРЕМЕННОЙ
 ;%2-ИМЯ ТАБЛИЦЫ,РАЗДЕЛА ОПИСАНИЯ БАЗЫ ЛОГ. УСЛОВИЙ (DFLT="LOGIC,%BSZ")
 ;%3-ИМЯ УЗЛА В БАЗЕ ЛОГ. УСЛОВИЙ
 ;%4-ВЫЗОВ ТАБЛИЦЫ\ТЕКСТА ПО <F1>
 ;%5-КОМАНДА НА ТРАНСЛЯЦИЮ ФОРМУЛ
 N TEST,ZrE,Dt,li
 S ZrE=$ZR,Dt=$T ;SAVETEST
 I $G(cHOSe("L",%1))="NOTE" X "I 0" Q 0
 I $G(cHOSe("L",%1))="ALWAY" X "I 1" Q 1
LOGI I $D(cHOSe("L",%1)) S $ZT="ERLOGIC^%ZAPM.bs.BSsFUNM" X "I "_cHOSe("L",%1) Q $T
 K cHOSe("L",%1) I $G(%3)="" D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА 3 УСЛОВИЯ В ФУНКЦИИ $$LOGIC !") S cHOSe("L",%1)="NOTE" Q 0
 I $G(%2)="" S %2="LOGIC,%BSZ"
 S li=$$RIT(%2),li=$$KBD^%ZAPM.bs.BSF12(li) I li="" D ErrMsg^%ZAPM.bs.BSXfun("ОШИБКА В ИМЕНИ БАЗЫ УСЛОВИЙ $$LOGIC !") S cHOSe("L",%1)="NOTE" Q 0
 N BSr,Bst I $G(%4)'="" S %4=$$RIT(%4)
 D NEWTAB($NA(@li@(%3)),$G(%4,"^%ZAPM.bs.BSZ(""LOGICHLP"")"),%1,$G(%5))
 G LOGI
LOGTXT(NUMBE) ;ВЫБРАННЫЙ ТЕКСТ ИЗ БАЗЫ ЛОГ. УСЛОВИЙ
 Q $G(cHOSe("L",NUMBE,"TXT"))
LOGSEL(NUMBE) ;ВЫБРАННЫЙ КОД ИЗ БАЗЫ ЛОГ. УСЛОВИЙ
 Q $G(cHOSe("L",NUMBE,"SEL"))
ERLOGIC D ErrMsg^%ZAPM.bs.BSXfun($ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)_" ---->  "_$G(cHOSe("L",%1))) S $ZT=$G(%zT) S cHOSe("L",%1)="NOTE" Q 0
 Q
NEWTAB(B,H,NUMBE,TR) ;ФОРМИРОВАНИЕ ВРЕМЕННОЙ ТАБЛИЦЫ
 N BSR,BST,T,BSr,BSt,t1,t2,l1,l2,col,v,se,ke,I,tIT,Fk,PrEd,d,d1,d0,%1,%2,%3,%4,YES
 S T=$$TMPG^%ZAPM.bs.BSF11 N k1,k2,k3,k4,k5,k6,k7,k8,k9,L,C,D,BUF
 S BSr=$P(T,"("),BSt=$P($P($P(T,"(",2),")"),$C(34),2),l1=25,l2=50,v=2,ke=3,l3=3
 S (t3,t1)="",t2="ВЫБЕРИТЕ ФОРМУЛУ, или F1",(col(1),col(2))=$P(^%ZAPM.bs.BSZ("LOGIC",1,1),"@",10) D CR^%ZAPM.bs.BSN
 S col(1)=$P(^%ZAPM.bs.BSZ("LOGIC",2,1),"@",10),col(2)=$P(^%ZAPM.bs.BSZ("LOGIC",2,2),"@",10)
 S I="" F  S I=$O(@B@(I)) Q:I=""  S t1=" "_$G(@B@(I,"C1")),t2=$G(@B@(I,"L1")),t3=$G(@B@(I,"S1")) X TR D CR^%ZAPM.bs.BSN
 S tIT="2,2",Fk="" D CREAT^%ZAPM.bs.BSN S $P(@BSr@(BSt),"@",39)=H
NEWTA D Table^%ZAPM.bs.BSN(BSR,BST) I $P(YES,"@",4)=27 D Yes^%ZAPM.bs.BSXfun("УСЛОВИЕ ДЛЯ ЭТОГО НАСЧЕТА БУДЕТ ВСЕГДА ДА='ИСТИНО' НЕТ='ЛОЖЬ' ?") S cHOSe("L",NUMBE)=YES>0 G NEWE
 I $P($P(YES,"@",1),",",2)'=2 D ErrMsg^%ZAPM.bs.BSXfun("ВЫ НАХОДИТЕСЬ НЕ НА ФОРМУЛАХ !") G NEWTA
 I $P(YES,"@",9)["|" S cHOSe("L",NUMBE)=$P($P(YES,"@",9),"|",2),cHOSe("L",NUMBE,"TXT")=$P($P(YES,"@",9),"|"),cHOSe("L",NUMBE,"SEL")=$P($P(YES,"@",9),"|",3) G NEWE
 S cHOSe("L",NUMBE)=$P(YES,"@",9)
 S cHOSe("L",NUMBE,"TXT")=$P($G(@BSR@(BST,$P($P(YES,"@",1),","),$P($P(YES,"@",1),",",2)-1)),"@",15)
 S cHOSe("L",NUMBE,"SEL")=$P($G(@BSR@(BST,$P($P(YES,"@",1),","),$P($P(YES,"@",1),",",2)-1)),"@",15)
NEWE K @T Q
CHO(%1,%2,%3,%4,%5,%6,%7,%8) ;ФУНКЦИЯ ОПРЕДЕЛЕНИЯ ПЕРЕМЕННОЙ НА СЕАНС РАБОТЫ С ТАБЛИЦЕ
 ;%1-НОМЕР ПЕРЕМЕННОЙ
 ;%2-ТЕКСТ ПРИГЛАШЕНИЯ ДЛЯ ВВОДА
 ;%3=ДАННЫЕ ВВОДА ПРЕДЛАГАЕМЫЕ
 ;%4-ФОРМУЛА ТРАНСФОРМАЦИИ РЕЗУЛЬТАТА ВВОДА ДЛЯ d=РЕЗУЛЬТАТ ВВОДА
 ;%5-ИМЯ ПЕРЕМЕННОЙ, С КОТОРОЙ ПРЕДСТОИТ СРАВНИВАТЬ
 ;%6-ВЫЗОВ ТАБЛИЦЫ ПРИ ВВОДЕ <ENTER> ИЛИ "?" ССЫЛКА = "BST,BSR,UIC,SYS"
 ;%7-ВЫЗОВ ТАБЛИЦЫ\ТЕКСТА ПО <F1>            ССЫЛКА = "BST,BSR,UIC,SYS"
 ;%8-HISTORY
 N ZrE,Dt
 S ZrE=$ZR,Dt=$T ;SAVETEST
 I $G(cHOSe(%1))="ALL",$D(%5) X "S %0="_%5 Q %0
 I $D(cHOSe(%1)) S %0=cHOSe(%1) Q %0
 N lop,lon,ls,ll,%hlp,%HIS,%KAT ;ДЛЯ LE
 S cHOSe=$G(li) I $G(%7)'="" S %hlp=$$RIT(%7)
 S %HIS="^%ZAPM.bs.BSbufB(""HISCHOISE"_%1_""")"
CH U 0 W $$bel^%ZAPM.bs.BS3 S li=$G(%3),ls="Вводите "_$G(%2)_":" D LE^%ZAPM.bs.BSTT
 I YES<1 S (d,%0,li)="" G CHGO
 I li=""!(li="?"),$D(%6) S li=$$CALL(%6) S:li'="" %3=li G CH
 S d=li I $G(%4)'="" X "S d="_%4
 S %0=d I d="ALL",$D(%5) X "S %0="_%5
CHGO D RESTTEST
 S cHOSe($G(%1,9))=$G(d),li=$G(cHOSe)
 Q %0
RESTTEST I $D(@ZrE)
RESTT X "I Dt"
 Q
CALL(li) ;ВЫЗОВ ТАБЛИЦЫ
 N BSr,BSt,YES,%1,%2,%3,%4,%5,%6,%7,d,dat,date
 D RII^%ZAPM.bs.BSF3 D Table^%ZAPM.bs.BSN(BSr,BSt)
 Q:$P(YES,"@",4)=27 "" Q $P(YES,"@",9)
RIT(li) N BSr,BSt D RII^%ZAPM.bs.BSF3
 Q $NA(@BSr@(BSt))
DATpl(%1,%2,%3) ;$$h^%ZAPM.bs.BS3() +(-) время формата (ЧЧ:ММ)
 ;%1 - дата формата $$h^%ZAPM.bs.BS3(); %2 - время (ЧЧ:ММ); %3 - "-" (отнять), "" (прибавить)
 N i,i1,i2,i3
 I %1="" S %0="" Q %0
 I %2="" S %0=%1 Q %0
 S i=$P(%1,","),i1=$P(%1,",",2),i2=$P(%2,":")*3600+($P(%2,":",2)*60)
 S i2=i2*$S(%3="-":-1,1:1)
 S i3=(i1+i2)/86400
 S i3=i3+i
 S %0=$P(i3,".")_","_$E(($P(i3,".",2)*86400),1,5)
 Q %0
SelecBut(%1,%2,%3) ;CЕЛЕКТОРНЫЕ КНОПКИ
 ;%1- ТИП ПАНЕЛИ
 ;%2=1 ПЕРВОНАЧЕЛЬНАЯ УСТАНОВКА
 ;%3=ПЕРЕМЕННАЯ ВОЗВРАТА"
 N T
 I '$D(Sel(ny,nx)) S Sel(ny,nx)=$G(%3)
 I $G(%2),'$D(Sel(0)) S Sel(0)=(ny_","_nx)
 I $G(Sel(0),"?")=(ny_","_nx) S T=$S(%1=1:"X",%1=2:"o",1:"§")
 E  S T=" "
 Q $S(%1=1:"[",%1=2:"(",1:"<")_T_$S(%1=1:"]",%1=2:")",1:">")
MONEY(%1) ;123.4561 --> 123.46
 S %0=$J(%1,"",2) Q %0
MONT(%1) ;%1-НОМЕР МЕСЯЦА --> ТЕКСТ МЕСЯЦА
 Q $P("Янваpь,Февpаль,Маpт,Апpель,Май,Июнь,Июль,Август,Сентябpь,Октябpь,Ноябpь,Декабpь",",",+%1)
MONTD(%1,%2) ;%1=ГГММДД  %2=НА СКОЛЬКО МЕСЯЦЕВ ПРИБАВИТЬ ИЛИ ОТНЯТЬ
 N M,G S M=$$M^%ZAPM.bs.BSsFUNR(%1)+$G(%2),G=$$Y^%ZAPM.bs.BSsFUNR(%1)
 F  Q:M'<1  S G=G-1,M=12+M
 F  Q:M'>12  S G=G+1,M=M-12
 I G?3N S G=$E(G,2,3)
 I G<0 S G=99
 S G=$$ADDYEAR^%ZAPM.bs.BSsFUNR(G)
 I M?1N S M="0"_M
 S %0=G_M_$E(%1,5,6)
 Q %0
DSCORR(%1,MINUS) ;ФОРМАТИРОВАНИЕ ТЕКСТА В КЛЕТКЕ С ПЕРЕНОСОМ ПО СЛОВАМ          DSCORR^%ZAPM.bs.BSsFUNM
 ;автор : Дружинин Сергей (С) 1997
 N FLAG,LONG,VARIANT,RES,K,I,W,SS,J,S,S1,S2,B,E,KOL,NEW,DS ;ЛОКАЛЬНЫЕ ПЕРЕМЕННЫЕ
 I '$D(BS) Q ""
 S LONG=$P($G(BS),"@",4)-$G(MINUS)
 S K=1,NEW="",SS=0,Q=0,J=1,W="",S2=1,KK=0 ; ПРИСВОЕНИЕ НАЧАЛЬНЫХ ЗНАЧЕНИЙ ПЕРЕМЕННЫМ
LOOP S S1=$F(%1,".",S2),B=$E(%1,S1-2),E=$E(%1,S1),S2=S1 I S1'=0 I ((B'=" ")&(E'=" ")) I ((B?1N'=1)&(E?1N'=1)) S %1=$E(%1,1,S1-1)_" "_$E(%1,S1,9999) S S2=S1+1 G LOOP
 S S2=1
LOOP1 S S1=$F(%1,",",S2),B=$E(%1,S1-2),E=$E(%1,S1),S2=S1 I S1'=0 I ((B'=" ")&(E'=" ")) S %1=$E(%1,1,S1-1)_" "_$E(%1,S1,9999) S S2=S1+1 G LOOP1
 S S2=1
LOOP2 S S1=$F(%1,"-",S2),B=$E(%1,S1-2),E=$E(%1,S1),S2=S1 I S1'=0 I ((B'=" ")&(E'=" ")) S %1=$E(%1,1,S1-1)_" "_$E(%1,S1,9999) S S2=S1+1 G LOOP2
 F I=1:1 Q:$P(%1," ",I,I+1)=""  D
 .S W=$P(%1," ",I)
 .I ($L(W)<LONG)!($L(W)=LONG) S VARIANT(J)=W S J=J+1 Q
 .E  S SS=$L(W)\LONG F Q=1:1:SS+1 S VARIANT(J)=$E(W,(Q-1)*LONG+1,Q*LONG) S J=J+1
 S KOL=J-1
 F I=1:1:KOL D                                   ;БЛОК
 .I NEW="" S NEW=VARIANT(I)                      ;ДОБАВЛЕНИЯ
 .E  S NEW=NEW_" "_VARIANT(I)                    ;НЕОБХОДИМОГО
 .I $L(NEW)=LONG S DS(K)=NEW S NEW="" S K=K+1 Q
 .I $L(NEW)>LONG D                               ;КОЛИЧЕСТВА
 ..S DS(K)=$E(NEW,1,LONG)                        ;ПРОБЕЛОВ СПРАВА
 ..I DS(K)[" " S DS(K)=$E(DS(K),1,($L(NEW)-$L(VARIANT(I))-1)) S DS(K)=DS(K)_$J("",(LONG-$L(DS(K)))) S NEW=VARIANT(I)
 ..E  S NEW=$E(NEW,LONG+1,9999) I $E(NEW,1)=" " S NEW=$E(NEW,2,9999)
 ..S K=K+1
 S DS(K)=NEW I $E(DS(K),1)=" " S DS(K)=$E(DS(K),2,9999)
 S RES="" F S=1:1:K S RES=RES_DS(S)
 Q RES  ;РЕЗУЛЬТАТ КОРРЕКЦИИ ПОЛОЖЕНИЯ СЛОВ В ЯЧЕЙКЕ
 
CENTR(%1,%2,%3) ;%3=1 - ЦЕНТР %3=2 ВПРАВО    %2-ДЛИНА КЛЕТКИ
 I '$G(%2) S %2=$P($G(BS),"@",4)
 I '$G(%3) S %3=1
 I %3=1 S %0=$J("",(%2-$L(%1))\2)_%1 Q %0
 S %0=$J(%1,%2) Q %0
KCHO K cHOSe
e Q
OT D O^%ZAPM.bs.BSF7 S YES=0,%0="" X "I 0" Q ""
ASYS(%1,I) ;ДОСТУПНЫЙ ТОМ
 I %1="*" S @(I_"%1)")=""
 I 1 S YES=1,%0=%1 Q %0
AUCI(%2,I) ;ДОСТУПНЫЙ КИП
 I %2="*" S @(I_"%2)")=""
 S YES=1,%0=%2 I 1 Q %2
APAR(%3,I) ;ДОСТУПНЫЙ РАЗДЕЛ
 I %3="*" S @(I_"%3)")=""
 S YES=1,%0=%3 I 1 Q %3
ATAB(%4,I) ;ДОСТУПНАЯ ТАБЛИЦА
 I %4="*" S @(I_"%4)")=""
 S YES=1,%0=%4 I 1 Q %4
NEWuser(%5) ;НОВЫЙ ПОЛЬЗОВАТЕЛЬ
 I $L(%5)>7!($TR(%5," .\/+!@#$%^&*()_-|","")'=%5) S ls="ВВЕДИТЕ ДО 7 БУКВЕННЫХ КОМБИНАЦИЙ" G OT
 D USER^%ZAPM.bs.BSF4 I $G(%PAROL)="" S ls=" НЕ ВВЕДЕН " G OT
 S YES=1,@BSD@(".@PASSWORD",%5)=%PAROL,@BSD@(".@WHO",%5)=$G(li),%0=%5,@BSD@(%5)="" D  I 1 Q %5
 .S i="" F  S i=$O(@BSD@(".@PASSWORD",i)) Q:i=""  I '$D(@BSD@(i)) K @BSD@(".@PASSWORD",i)
 .S i="" F  S i=$O(@BSD@(".@WHO",i)) Q:i=""  I '$D(@BSD@(i)) K @BSD@(".@WHO",i)
 Q
Fio(S,D) ;В ПРЕДЛОЖЕНИИ ПОСТАВИТЬ ЗАГЛАВНЕ БУКВЫ
 N i,ii,Di S Di=" " I $D(D) S Di=$E(D,1)
 F i=1:1 Q:$P(S,Di,i,i+1)=""  S $P(S,Di,i)=$$BIGL($E($P(S,Di,i),1))_$$LITL($E($P(S,Di,i),2,$L($P(S,Di,i))))
 Q S
LITL(%1) ;БОЛЬШИЕ БУКВЫ В МАЛЕНЬКИЕ
 Q $TR(%1,"QWERTYUIOPASDFGHJKLZXCVBNMЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮЁ","qwertyuiopasdfghjklzxcvbnmйцукенгшщзхъфывапролджэячсмитьбюе")
BIGL(%1) ;МАЛЕНЬКИЕ В БОЛЬШИЕ
 Q $TR(%1,"qwertyuiopasdfghjklzxcvbnmйцукенгшщзхъфывапролджэячсмитьбю","QWERTYUIOPASDFGHJKLZXCVBNMЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮ")
TR(%1,%2,%3) N p,l,l3 ;ТРАНСФОРМАЦИЯ !!!!!
 I %2="" Q %1
 I %1'[%2 Q %1
 S p=1,l=$L(%2),l3=$L(%3),%z=$ZT,$ZT="TRMAX^%ZAPM.bs.BSsFUNM"
 F  S p=$F(%1,%2,p) Q:p=0  S $E(%1,p-l,p-1)=%3,p=p+l3-l
 S $ZT=$G(%z) Q %1
TRMAX W $$bel^%ZAPM.bs.BS3 S $ZT=$G(%z) Q $G(%1,$G(s))
NINV(%1,%2,%3) N li,GL ;КОРРЕКЦИЯ КОДИФИКАТОРА
 Q:%1="" 1 ;%1-МАССИВ %2-КОД %3-ТЕКСТ
 Q:%2="" 1 S li=%1 D GL^%ZAPM.bs.BSF3 I 'YES Q 1
 I $D(@(GL_"(%2)")) D  Q 1
 .I %3="" S ls=" УДАЛИМ ИЗ "_GL_" КОД:"_%2_". ВЫ УВЕРЕНЫ ? " D YES^%ZAPM.bs.BSF D  Q
 ..I YES S %3=@(GL_"(%2)") K @$ZR K:%3'="" @(GL_"in(%3)")
 .I $D(@(GL_"in(%3)")) Q
 .S @(GL_"in(%3)")=%2
 I %3'="" S ls=" ДОБАВИМ В "_GL_" НОВЫЙ КОД :"_%2_" . ВЫ УВЕРЕНЫ ? " D YES^%ZAPM.bs.BSF I YES S @(GL_"(%2)")=%3,@(GL_"in(%3)")=%2 Q 1
 I 1 Q 1
DELCTL(d) N UP,i ;УДАЛЕНИЕ ИЗ d УПРАВЛЯЮЩИХ КОДОВ С ЗАМЕНОЙ НА "¬"
 S UP="" F i=0:1:31 S UP=UP_$C(i)
 Q $TR(d,UP,$TR($J("",$L(UP))," ","¬"))
COLOR(%1) ;ЦВЕТ !!! CLR !!!
 S CLR=%1 Q ""
CELL(%1,%2,%3,%4) ;ПСЕВДОГРАФИКА    ;             %3 |
 N l,h,s,i,t Q:'$D(BS) ""           ;     %2  =======| %4
 S l=$P($G(BS),"@",4),h=$P($G(BS),"@",3)
 S s=$G(%1)_$J("",h*l),t=$L(%1)
 I $G(%3)'="" S l=l-1,t=t+h
 F i=1:1:h-1  S s(i)=$E(s,i*l-l+1,l+(l*(i-1)))_$E(%3,1)
 I $G(%2)'="" S t=t+l,s(h)=$TR($J("",l)," ",$E(%2,1))_$G(%4,$G(%3))
 E  S s(h)=$E(s,h*l-l+1,l+(l*(h-1)))_$G(%4,$G(%3))
 S s="" F i=1:1:h S s=s_s(i)
 Q s_$J(".",t)
Butt(%1) ;КНОПКА
 N l,h,s,i,t,%2,%3,%4 S %3="¶",%2="®",%4="®" ; ¶  код220 _  код221 [  код222 ]  код223 ®
 S l=$P($G(BS),"@",4),h=$P($G(BS),"@",3)
 S s=$G(%1)_$J("",$P(BS,"@",3)*$P(BS,"@",4))
 S t="",k=1 F i=0:(l-$L($G(%3))) Q:k=h  S t=t_$E(s,1+i,l-$L($G(%3))+i)_$S(k=1:"_",1:$G(%3)),k=k+1
 I $G(%2)="" S t=t_$E(s,1+i,l-1+i)_$G(%4)_$E(s,l+i,$$LNG^%ZAPM.bs.BSF12) Q t
 S t=t_" "_$TR($J("",l-2)," ",$E(%2))_$G(%4)_$E(s,l+i,$$LNG^%ZAPM.bs.BSF12) Q t
]]></Routine>


<Routine name="%ZAPM.bs.BSsFUNR" type="MAC" languagemode="0"><![CDATA[
%BSsFUNR ;ФУНКЦИИ СИНТАКТИЧЕСКОГО КОНТРОЛЯ И ТРАНСФОРМАЦИИ ; 14:26   04.05.2001
e Q
US I %1'[",",$G(BSR)["," S %1=$$TR^%ZAPM.bs.BSsFUNM(%1,"^",$P(BSR,"]")_"]")
 Q
READ S YES=1 S:%2["READ" %2=d0 Q
INV(%1,%2,%3) ;S;ТРАНСФОРМАЦИЯ %2 ПО КОДИФИКАТОРУ %1
 N Sec,in
 Q:%2="" "<ZERRo$$INV>" ;%3=1 ВВОД НОВОГО КОДА
 I $ZV["Cach"||($ZV["IRIS") I $P($P(%1,"]"),$C(34),4)'="" S $P(%1,$C(34),4)=""
 S %0="" I $E(%1,1)'="^" S %1="^"_%1
 D READ ;!!!!,US ;СИНТАКСИС НА ВВОД С КЛАВИТУРЫ
 I $P($G(@%1),"@",8) G INVnew
 I $D(@(%1_"(%2)")) S %0=%2 Q %0
 I $D(@(%1_"in(%2)")) S %0=@$ZR Q %0
 S in=$O(@(%1_"in(%2)")) I in="" G IN
 I ("@"_in)[("@"_%2) S %0=@(%1_"in(in)") Q %0
IN G:'$G(%3) I S ls=" КОД ОСУТСТВУЕТ !!! ВВЕДЕМ НОВЫЙ КОД:"_%2_" ? " D YES^%ZAPM.bs.BSF I YES S ls=" А ТЕПЕРЬ ВВЕДИТЕ ТЕКСТ РАСШИФРОВКУ ДЛЯ КОДА;",li="",ll="@" D LE^%ZAPM.bs.BSTT I YES,li'="" S @%1@(1,%2)=li,@%1@(2,li)=%2 S %0=%2 Q %0
I X "I 0" S YES=0,%0="<$$INV>" D INVLS Q %0
INVLS S ls="КОД("_%2_") не соответствует кодификатору :"_%1 Q
INVnew I $D(@%1@(1,%2)) S %0=%2 Q %0
 I $D(@%1@(2,%2)) S %0=@$ZR Q %0
 S in=$O(@%1@(2,%2)) I in="" G INnew
 I ("@"_in)[("@"_%2) S %0=@%1@(2,in) Q %0
INnew G:'$G(%3) I I '($D(OldP)&($D(LB))) S ls=" КОД ОСУТСТВУЕТ !!! ВВЕДЕМ НОВЫЙ КОД:"_%2_" ? " D YES^%ZAPM.bs.BSF I YES S ls=" А ТЕПЕРЬ ВВЕДИТЕ ТЕКСТ РАСШИФРОВКУ ДЛЯ КОДА;",li="",ll="@" D LE^%ZAPM.bs.BSTT I YES,li'="" S @%1@(1,%2)=li,@%1@(2,li)=%2 S %0=%2 Q %0
Inew X "I 0" S YES=0,%0="<$$INV>" D INVLS Q %0
 ;
TIN(%1,%2,%3) ;S;ТРАНСФОРМАЦИЯ ОБРАТНАЯ %2 ПО КОДИФИКАТОРУ %1
 N z,zt
 S z=$ZR ;%3=1 - <ERRO_$$INV>=""
 S %0="" I $E(%1,1)'="^" S %1="^"_%1
 I $ZV["Cach"||($ZV["IRIS"),'$G(TableAlive) I $P($P(%1,"]"),$C(34),4)'="" S $P(%1,$C(34),4)=""
 D READ ;!!!!,US ;СИНТАКСИС НА ВВОД С КЛАВИТУРЫ
 I %2="" S %2=0
 I '$$Data^%ZAPM.bs.BSF12(%1) S YES=0,%0=$S($G(%3):"",1:"<$ZE="_$ZE_">") X "I 0" D TIZ Q %0
 I $P($G(@%1),"@",8) G TINnew
 I $D(@(%1_"(%2)")) S %0=@(%1_"(%2)") D TIZ Q %0
 E  S YES=0,%0=$S($G(%3):"",1:"<ERROR_$$INV>") X "I 0" D TIZ Q %0
TINnew I $D(@%1@(1,%2)) S %0=$TR(@%1@(1,%2),$C(12),"") D TIZ Q %0
 E  S YES=0,%0=$S($G(%3):"",1:"<ERROr_$$INV>") X "I 0" D TIZ Q %0
TIZ S zt=$T I $D(z),$QS(z,$QL(z))'="",$D(@z) ;ВОЗВРАТ ПОЛНОЙ ГЛ.ССЫЛКИ
 I zt
 Q
UselBd(M,k0,KOL,k1,k2,k3,k4,k5,k6,k7,k8,k9,k10) ;ССЫЛКА НА УЗЕЛ БАЗЫ ДАННЫХ
 Q:(M_k0)="" "NO_ARR"
 N z,zt,%0
 S z=$ZR,zt=$T
 I KOL=0 S %0=$G(@(M_k0),"NO_VAL") G UzelB
 I KOL=1 S %0=$G(@(M_k0)@(k1),"NO_VAL") G UzelB
 I KOL=2 S %0=$G(@(M_k0)@(k1,k2),"NO_VAL") G UzelB
 I KOL=3 S %0=$G(@(M_k0)@(k1,k2,k3),"NO_VAL") G UzelB
 I KOL=4 S %0=$G(@(M_k0)@(k1,k2,k3,k4),"NO_VAL") G UzelB
 I KOL=5 S %0=$G(@(M_k0)@(k1,k2,k3,k4,k5),"NO_VAL") G UzelB
 I KOL=6 S %0=$G(@(M_k0)@(k1,k2,k3,k4,k5,k6),"NO_VAL") G UzelB
 I KOL=7 S %0=$G(@(M_k0)@(k1,k2,k3,k4,k5,k6,k7),"NO_VAL") G UzelB
 I KOL=8 S %0=$G(@(M_k0)@(k1,k2,k3,k4,k5,k6,k7,k8),"NO_VAL") G UzelB
 I KOL=9 S %0=$G(@(M_k0)@(k1,k2,k3,k4,k5,k6,k7,k8,k9),"NO_VAL") G UzelB
 I KOL=10 S %0=$G(@(M_k0)@(k1,k2,k3,k4,k5,k6,k7,k8,k9,k10),"NO_VAL") G UzelB
UzelB I $D(z),$QS(z,$QL(z))'="",$D(@z) ;ВОЗВРАТ ПОЛНОЙ ГЛ.ССЫЛКИ
 I zt
 Q %0
VAL(%1) ;ПОЛНАЯ ССЫЛКА
 N z,zt,%0
 S z=$ZR
 S %0=$G(@%1,"NO_VAL") D TIZ
 Q %0
ErTimDat S ls="ОШИБКА формата даты !,Вводите в  формате:ЧЧММДДММГГ ",YES=0,%0="" X "I 0" Q %0
TimDat10(%2) ;ПРЯМОЙ ВВОД ВРЕМЕНИ_ДАТЫ (ЧЧММДДММГГ) С ПОСЛЕДУЮЩИМ ПЕРЕВОРОТОМ
 N D,D1,D2,T,T1
 D READ
 S %0="" I %2["??????" S %0=%2 Q %0 ;ИТОГ ЗА ДАТУ
 I %2["." S %2=$TR(%2,".","")
 I $L(%2)'=10 G ErTimDat
 ;I '$$TimCheck($E(%2,1,4)) G ErTimDat
 ;I '$$DatCheck($E(%2,5,10)) G ErTimDat
 S %0=$E(%2,9,10)
 Q
REVERS(D) ;РЕВЕРС ДАТЫ ДДММГГГГ ---> YYYYMMDD
 I $L(D)=8 Q $E(D,5,8)_$E(D,3,4)_$E(D,1,2)
 Q $E(D,5,6)_$E(D,3,4)_$E(D,1,2)
DAT(%1,%2) ;S; %2=ДДММГГ ---> %0=ГГММДД
 N r2,%3,%4,%5,%6
 D READ ;КОНТРОЛЬ И ТРАНСФОРМАЦИЯ ДАТЫ ПРИ ВВОДЕ
 S %0="" I %2["??????" S %0=%2 Q %0
 I %2["." S %2=$TR(%2,".","")
 G DateNew:%1>5,10:$L(%2)>8
 I $L(%2)=5 S %2="0"_%2
 I '($L(%2)=6!($L(%2)=8)) G ERD
 I $L(%2)=8 S r2=$E(%2,5,8),%3=$E(%2,3,4),%4=$E(%2,1,2) I r2'?4N!(+%3>12!(+%3<1))!(+%4>31!(+%4<1)) G ERD
 I $L(%2)=6 S r2=$E(%2,5,6),%3=$E(%2,3,4),%4=$E(%2,1,2) I r2'?2N!(+%3>12!(+%3<1))!(+%4>31!(+%4<1)) G ERD
 I '$D(r2) G ERD
 S %0=r2_%3_%4 Q %0
10 ;S;ТРАНСФОРМАЦИЯ  ДАТЫ & ВРЕМЕНИ
 I '($L(%2)=10!($L(%2)=12)) G ERD
 I $L(%2)=10 S %5=$E(%2,1,2),%6=$E(%2,3,4),r2=$E(%2,9,10),%3=$E(%2,7,8),%4=$E(%2,5,6) I r2'?2N!(%3'?2N)!(%4'?2N)!(%5'?4N)!(+%3>12!(+%3<1))!(%4>31!(%4<1))!(+%5>24)!(+%6>60) G ERD
 I $L(%2)=12 S %5=$E(%2,1,2),%6=$E(%2,3,4),r2=$E(%2,9,12),%3=$E(%2,7,8),%4=$E(%2,5,6) I r2'?4N!(%3'?2N)!(%4'?2N)!(%5'?4N)!(+%3>12!(+%3<1))!(%4>31!(%4<1))!(+%5>24)!(+%6>60) G ERD
 I '$D(r2) G ERD
 I $L(r2)=2,$E(r2,1)="0" S r2="20"_r2
 D x^%ZAPM.bs.BS3(2)     ;---//--- для msm 4.x.x
 S %0=r2_%3_%4_%5_%6 X "I 1" Q %0
ERD S ls="ОШИБКА формата даты !,Вводите в  формате:"_$S($L(%2)=8:"ГГ",1:"")_"ГГММДД"_$S($L(%2)>8:"ЧЧММ",1:" "),YES=0,%0=0 X "I 0" Q %0
ERDN S ls="ОШИБКА формата даты !,Вводите в  формате:"_$S($L(%2)=8:"ГГ",1:"")_"ГГММДД"_$S($L(%2)>8:"ЧЧММ",1:"")_" ",YES=0,%0=0 X "I 0" Q %0
ERDM S ls="ОШИБКА формата даты !,Вводите в  формате:ГГММ",YES=0,%0=0 X "I 0" Q %0
YEARM(%1,%2) ;ГГММ.ГГГГММ - КОНТРОЛЬ
 I %2="READ" S %2=d0
 N %5,%6
 I '($L(%2)=4!($L(%2)=6)) G ERDM
 I $L(%2)=4 S %5=$E(%2,1,2),%6=$E(%2,3,4) I %5'?2N!(%6'?2N)!(+%6>12!(+%6<1)) G ERDM
 I $L(%2)=6 S %5=$E(%2,1,4),%6=$E(%2,5,6) I %5'?4N!(%6'?2N)!(+%6>12!(+%6<1)) G ERDM
 S %0=%2 X "I 1" Q %0
DateNew ;НОВЫЙ ФОРМАТ
 G N10:$L(%2)>8
 I '($L(%2)=6!($L(%2)=8)) G ERDN
 I $L(%2)=8 S r2=$E(%2,1,4),%3=$E(%2,5,6),%4=$E(%2,7,8) I r2'?4N!(+%3>12!(+%3<1))!(+%4>31!(+%4<1)) G ERDN
 I $L(%2)=6 S r2=$E(%2,1,2),%3=$E(%2,3,4),%4=$E(%2,5,6) I r2'?2N!(+%3>12!(+%3<1))!(+%4>31!(+%4<1)) G ERDN
 I '$D(r2) G ERDN
 I +%3=2,+%4>28,'$$VIS(r2) G ERDN
 I ",2,4,6,9,11,"[(","_+%3_","),+%4>30 G ERDN
 S r2=$$ADDYEAR(r2)
 S %0=r2_%3_%4 Q %0
ADDYEAR(r2) ;ДОБАВИТЬ СТОЛЕТИЯ
 I $E($G(%BS(1),"0021101000121100100"),14),$L(r2)=2 D
 .I +r2<50 S r2="20"_r2 Q
 .S r2="19"_r2
 Q r2
N10 ;S;ТРАНСФОРМАЦИЯ  ДАТЫ & ВРЕМЕНИ
 I '($L(%2)=10!($L(%2)=12)) G ERDN
 I $L(%2)=10 S %5=$E(%2,7,8),%6=$E(%2,9,10),r2=$E(%2,1,2),%3=$E(%2,3,4),%4=$E(%2,5,6) I r2'?2N!(%3'?2N)!(%4'?2N)!(%5'?2N)!(%6'?2N)!(+%3>12)!(+%3<1)!(+%4>31)!(+%4<1)!(+%5>24)!(+%6>60) G ERDN
 I $L(%2)=12 S %5=$E(%2,9,10),%6=$E(%2,11,12),r2=$E(%2,1,4),%3=$E(%2,5,6),%4=$E(%2,7,8) I r2'?4N!(%3'?2N)!(%4'?2N)!(%5'?2N)!(%6'?2N)!(+%3>12!(+%3<1))!(%4>31!(%4<1))!(+%5>24)!(+%6>60) G ERDN
 I '$D(r2) G ERDN
 I $L(r2)=2,$E(r2,1)="0" S r2="20"_r2
 S %0=r2_%3_%4_%5_%6 X "I 1" Q %0
 ;
DTT(%1,%2) ;T;ТРАНСФОРМАЦИЯ ДАТЫ ПРИ ВЫВОДЕ %2=ГГММДД ---> %0=ДД.ММ.ГГ
 S %0=""   ;СТАРАЯ ВЕРСИЯ !!!! НОВАЯ --> $$NDTT(DATE)
 I $L(%2)=6 S %0=$E(%2,5,6)_"."_$E(%2,3,4)_"."_$E(%2,1,2)
 I $L(%2)=8 S %0=$E(%2,7,8)_"."_$E(%2,5,6)_"."_$E(%2,1,4)
 I $L(%2)=10 S %0=+$E(%2,7,8)_":"_$E(%2,9,10)_" "_$E(%2,5,6)_"."_$E(%2,3,4)_"."_$E(%2,1,2)
 I $L(%2)=12 S %0=+$E(%2,9,10)_":"_$E(%2,11,12)_" "_$E(%2,7,8)_"."_$E(%2,5,6)_"."_$E(%2,1,4)
 Q %0
 ;--
SYSDATE(%1,%2) ;ИЗ $$h^%ZAPM.bs.BS3() --> ГГММДД
 S %0=$$ESDAY(%1,%2) K %1 I %0[" " S %1=$P(%0," "),%0=$P(%0," ",2)
 S %0=$TR(%0,".","") I $L(%0)=6 S %0=$E(%0,5,6)_$E(%0,3,4)_$E(%0,1,2)
 I $L(%0)=8 S %0=$E(%0,5,8)_$E(%0,3,4)_$E(%0,1,2)
 I $D(%1) S %1=$P(%1,":",1)_$P(%1,":",2) K:%1'?4N %1
 Q %0_$G(%1)
ESDAY(%1,%2) ;        ИЗ $$h^%ZAPM.bs.BS3() В ДД.ММ.ГГ
 N r4,%D,%I,%LY,%M,%R,%Y,%TIM,%NP
 I %2="READ" S %2=d0
 S r4=%2,%2=%2>21914+%2 ;        ИЗ $$h^%ZAPM.bs.BS3() В ДД.ММ.ГГ
 S %LY=%2\1461,%R=%2#1461,%Y=%LY*4+1841+(%R\365),%D=%R#365,%M=1
 I %R=1460,%LY'=14 S %D=365,%Y=%Y-1
 F %I=31,(%R>1154)&(%LY'=14)+28,31,30,31,30,31,31,30,31,30 Q:%I'<%D  S %M=%M+1,%D=%D-%I
 I %D=0 S %Y=%Y-1,%M=12,%D=31
 I %D?1N S %D="0"_%D
 S %0=%D_"."_$P("01 02 03 04 05 06 07 08 09 10 11 12"," ",%M)_"."_$S('$E($G(%BS(1)),14):$E(%Y,3,4),1:%Y)
 I %1=4 Q %Y
 I %1<7 Q %0
30 S %M=$P(r4,",",2)\60
40 NEW %I S %TIM=%M\60_":"_(%M#60\10)_(%M#10)_$S(%1=8:":"_($P(r4,",",2)#60),1:"") ; NEW %I for DMS
 S %N=" ДП" S:%M'<720 %M=%M-720,%N=" ПП" S:%M<60 %M=%M+720
 S %I=%M\600 S:'%I %I=" " S %TIM1=%I_(%M\60#10)_":"_(%M#60\10)_(%M#10)_%N
 K %M,%N,%I,%NP S %0=%TIM_" "_$G(%0) Q %0
 
Time(r4) N %I,%M,%TIM,%N,%NP,%1,%0
 S %M=r4\60,%1=9
 S %TIM=%M\60_":"_(%M#60\10)_(%M#10)_$S(%1=8:":"_(r4#60),1:"")
 S %N=" ДП" S:%M'<720 %M=%M-720,%N=" ПП" S:%M<60 %M=%M+720
 S %I=%M\600 S:'%I %I=" " S %TIM1=%I_(%M\60#10)_":"_(%M#60\10)_(%M#10)_%N
 S %0=%TIM_" "_$G(%0)
 Q %0
 
TXTD(%1) ;ДАТУ %1=ГГММДД --> %0="1 мая 1994 г."
 N d,d1,%0,YA
 I '%1 S %0="" Q ""
 I $L(%1)=8 S YA=$E(%1,1,2),%1=$E(%1,3,8)
 S d=+$E(%1,3,4)
 S d1=$P("янваpя,февpаля,маpта,апpеля,мая,июня,июля,августа,сентябpя,октябpя,ноябpя,декабpя",",",d)
 S %0=+$E(%1,5,6)_" "_d1_" "_$S($D(YA):YA,1:"19")_$E(%1,1,2)_" г."
 Q %0
VIS(Y) ;ВИСОКОСНЫЙ ЛИ ГОД ?
 Q:Y#400=0 1 Q:Y#100=0 0
 Q:Y#4=0 1 Q 0
WEEK(%1,%2) ;ДЕНЬ НЕДЕЛИ  %2=ГГММДД --> %0=N НЕДЕЛИ
 N I,D,M,Y,DM
 D READ I $L(%2)=8 S D=+$E(%2,7,8),M=+$E(%2,5,6),Y=$E(%2,1,4)
 I $L(%2)=6 S D=+$E(%2,5,6),M=+$E(%2,3,4),Y=$E(%2,1,2) D
 .I Y<50 S Y="20"_Y Q
 .S Y="19"_Y
 I '$D(M) D ErrMsg^%ZAPM.bs.BSXfun("НАРУШЕНИЕ ФОРМАТА ДАТЫ='"_%2_"'. $ZR="_$ZR) ZT "WEEK"
 I M<1!(M>12) G WEN
 F I=1:1:12 S DM(I)=$P("31-29-31-30-31-30-31-31-30-31-30-31","-",I)
 S DM(2)=$$VIS(Y)+28
 G WEN:(DM(M)<D)!(Y<80)
 I Y>1979 S H=50768 F I=1980:1:Y-1 S H=$$VIS(I)+365+H
 I Y'>1979 S H=50768 F I=1979:-1:Y S H=H-$$VIS(I)-365
 F I=1:1:M-1 S H=H+DM(I)
 S H=H+D
WEE S %0=$P($S(%1=1:"Четверг-Пятница-Суббота-Воскресенье-Понедельник-Вторник-Среда",1:"4-5-6-7-1-2-3"),"-",H#7+1) K M,D,DM,Y X "I 1" Q %0
WEN S %0="<ERROR_$$h^%ZAPM.bs.BS3()>",YES=0 X "I 0" Q %0
WEEKEND(%1,%2) ;%2=$$h^%ZAPM.bs.BS3() ---> %0 ДЕНЬ НЕДЕЛИ
 S H=%2 G WEE
Y(D) ;ВОЗВРАТИТЬ ГОД   ГГГГММДД --> ГГГГ
 I $L(D)=8 Q $E(D,1,4)
 Q $E(D,1,2)
YY(D) ;ВОЗВРАТИТЬ ГОД  ГГГГММДД --> ГГ (ДЛЯ ИМЕН БАЗ ДАННЫХ)
 I $L(D)=8 Q $E(D,3,4)
 Q $E(D,1,2)
M(D) ;ВОЗВРАТИТЬ МЕСЯЦ ГГГГММДД --> ММ
 I $L(D)=8 Q $E(D,5,6)
 Q $E(D,3,4)
D(D) ;ВОЗВРАТИТЬ ДНИ   ГГГГММДД --> ДД
 I $L(D)=8 Q $E(D,7,8)
 Q $E(D,5,6)
NDTT(D) ;НОВАЯ ДАТА ТРАНСФОРМАЦИЯ ГГГГММДД-->ГГГГ.ММ.ДД
 I $L(D)=8 Q $E(D,1,4)_"."_$E(D,5,6)_"."_$E(D,7,8)
 Q $E(D,1,2)_"."_$E(D,3,4)_"."_$E(D,5,6)
DATHR(%1,%2) ;ПЕРЕВОД ДАТЫ И ВРЕМЕНИ В ФОРМАТ СИСТЕМНОЙ ПЕРЕМЕННОЙ $H
 ;%2=ГГММДД --->  %0=$P($h,",") <-- ГГГГММДД
 ;ГГММДДЧЧМИ -->  $H=КОЛ-ВО_ДНЕЙ,КОЛ-ВО_СЕКУНД  <-- ГГГГММДДЧЧМИ
 N Y,N,D,H,HO
 S YES=1,%0=$$WEEK(%1,$S($L(%2)=10:$E(%2,1,6),$L(%2)=12:$E(%2,1,8),1:%2)) I 'YES Q %0
 I %1<7 S %0=H Q %0
 I $L(%2)=10 S HO=$E(%2,7,10)
 I $L(%2)=12 S HO=$E(%2,9,12)
 S %0=H_","_(($E(HO,1,2)*3600)+($E(HO,3,4)*60))
 Q %0
IF(%1,%2,%3,%4) ;%1="УСЛОВИЕ" YES=$T
                ;%2="READ" ТО %2=d0
                ;%3="КОМАНДА ИЗМЕНЕНИЯ d
                ;%4="СООБЩЕНИЕ ПРИ ОШИБКЕ"
 S %0=$G(%2),YES=0 D READ S:%2["READ" %0=d
 X "I "_%1 S YES=$T I  X $G(%3) S %0=d
 I $D(%4) S ls=%4
 Q %0
SAY D O^%ZAPM.bs.BSF7 Q 0
KeyTime(BS) ;Определение даты в Ключе
 N kd,M,i
 I $P(BS,"@",19) S kd=$$ESDAY(9,$P($P(BS,"@",19),",",1,2))
 E  S kd=$P(BS,"@",19)
 S M="  "_$G(kd)_" "_$P($P(BS,"@",19),",",3)_","_$TR($P($P(BS,"@",19),",",4),"123",".?!")
 Q $J("",$P(BS,"@",4)-$L(d1)-$L(M))_M
Pa N i K Pa F i=1:1 Q:'$D(@("%"_i))  S Pa(i)=@("%"_i)
 Q
FCl(%1,%2,%3,%4,%5) D Pa Q 1
FCls(%1,%2,%3,%4,%5) D Pa Q 1
FCln(%1) D Pa Q 1
 ;
FCs(%1,%2,%3,%4,%5) D Pa Q 1
FCss(%1,%2,%3,%4,%5) D Pa Q 1
FCsk(%1,%2,%3,%4,%5) D Pa Q 1
FCsn(%1) D Pa Q 1
 ;
TSP(%1,%2,%3,%4,%5,%6) Q 1
TSPGL(%1) Q 1
TSPPI(%1,%2,%3,%4) Q 1
TSPL(%1,%2,%3,%4,%5) Q 1
TSPN(%1) Q 1
TSORTSET() S @BSR@(BST,ny)=1 Q 1
TSV(%1,%2,%3,%4,%5) I %1'["^" G P1
 Q 1
P1 S ls=" В ПАР=1 ДОЛЖЕН БЫТЬ ""^"" " G SAY
TSVD(%1,%2,%3,%4) Q 1
TSVGL(%1,%2,%3,%4,%5,%6) Q 1
TSVL(%1,%2,%3,%4,%5,%6) Q 1
TSVU(%1,%2,%3,%4,%5,%6) Q 1
TSVV(%1,%2,%3,%4,%5,%6) Q 1
TSVN(%1) Q 1
PAGE(%1) ;ФУНКЦИЯ РАЗБИТИЯ СПИСКА НА СТРАНИЦЫ %1-КОЛ-ВО СТРОК
 S:'$D(PaGe) PaGe=%1 I $G(Yl)>PaGe S PaGe=PaGe+%1,YES=1 Q 1
 S YES=0 Q 0
MTBD(%1,%2) ;ЛОГИЧЕСКАЯ ФУНКЦИЯ-ДИСПЕТЧЕР МНОГО-ТАБЛИЧНОЙ БАЗЫ ДАННЫХ
 S $ZT="ErrMTBD^%ZAPM.bs.BSsFUNR"
 N d
 I $D(%1),%1["^" S d=1 I $D(@%1)
 I $D(%2) S d=1 X "I "_%2
 Q "1!"_$G(%1)_"!"_$G(%2)
ErrMTBD Q "0!!!"_$ZE_"!"_$$ErrSay^%ZAPM.bs.BSF8($ZE)
KEYPAS(%1) ;ЛОГИЧЕСКАЯ ФУНКЦИЯ-ДИСПЕТЧЕР ПАРОЛИРОВАНИЯ УЗЛОВ БАЗЫ ДАННЫХ
 Q 1
]]></Routine>


<Routine name="%ZAPM.bs.BSsFUNS" type="MAC" languagemode="0"><![CDATA[
%BSsFUNS ;пpогpамма Функций ; 17:22 10-JUN-98
 Q
Data() Q "Дата "_$$ESDAY^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3())_" Время "_$$Time^%ZAPM.bs.BSsFUNR($P($$h^%ZAPM.bs.BS3(),",",2))
LongStr(x,S) ;ТРАНСФОРМАЦИЯ ДЛЯ ДЛИННЫХ СТРОК
 N I,II
 I nx<x Q ""
 S II=0 F I=x:1:nx-1 S II=II+$P(@BSR@(BST,ny,I),"@",4)
 Q $E(S,II+1,999)
Var(N) ;ПЕРЕМЕННУЮ ТАБЛИЦЫ N ВЕРНУТЬ
 I $D(SetVar(BSR,BST,N)) Q SetVar(BSR,BST,N)
 S SetVar(BSR,BST,N)=$G(@BSR@(BST,"Var",N))
 Q SetVar(BSR,BST,N)
SetVar(N,V,Z,B) ;ПРИСВОИТЬ ПЕРЕМЕННУЮ ТАБЛИЦЫ
 I $G(Z)=1,V="" Q 1
 G Se:$G(B)=1,Se:'$D(BSr) I $D(SetVar(BSr,BSt,N)),SetVar(BSr,BSt,N)=V Q 1
 D zr(1) S @BSr@(BSt,"Var",N)=V,SetVar(BSr,BSt,N)=V D zr(0) Q 1
Se I $D(SetVar(BSR,BST,N)),SetVar(BSR,BST,N)=V Q 1
 D zr(1) S @BSR@(BST,"Var",N)=V,SetVar(BSR,BST,N)=V D zr(0) Q 1
zr(N) I N=1 S zr=$ZR Q  ;СОХРАНИТЬ
 I $D(zr),$D(@zr) ;ВОССТАНОВИТЬ
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSscrF" type="MAC" languagemode="0"><![CDATA[
%BSscrF ;Работа с буфером таблицы  (А.Тимофеев) ; 17:06   20.04.2000
 
LOAD(%1,%2,%3,%4,%5) 
 ;ФУНКЦИЯ ДЛЯ ЗАГРУЗКИ ЛЮБОЙ ТАБЛИЦЫ И ВЫТАСКИВАНИЯ ИЗ НЕЕ ИНФОРМАЦИИ
 ;%1- ПОЛНАЯ ГЛОБАЛЬНАЯ ССЫЛКА НА ТАБЛИЦУ
 ;%2- ЧТО ЗАПОМИНАЕМ НА ВЫХОДЕ (1 - ПОМЕЧЕННЫЕ БЛОКОМ, 2 - НЕЗАКРЫТЫЕ ОТ ЗАПИСИ,
 ;"N#S#E" - N- НОМЕР КОЛОНКИ, S- НАЧИНАЯ СО СТРОКИ, E- КОНЧАЯ СТРОКОЙ)
 ;%3- КУДА ЗАПОМИНАЕМ (1- СКИДЫВАЕТСЯ В МАССИВ ^%ZAPM.bs.BSbufB("W"_$G(%BS(3),$P)_$J_"u"), 2- ПЕРЕМЕННАЯ ВОЗВРАТА
 ;%4- СИМВОЛ-РАЗДЕЛИТЕЛЬ (ПО УМОЛЧАНИЮ - "~")
 ;%5- ПРОГРАММА ПРЕДОБРАБОТКИ, ЗАПУСКАЕМАЯ ПЕРЕД ЗАГРУЗКОЙ ТАБЛИЦЫ
 ;%0- СТРОКА ИЗ ДАННЫХ ИЛИ МАССИВ
 ;ДАННЫЕ ЗАПОМИНАЮТСЯ В МАССИВ ПО АДРЕСУ КЛЕТОК (y,x)
 I '$D(%1)!('$D(%2))!('$D(%3)) S %0="" D ErrMsg^%ZAPM.bs.BSXfun("Неправильные параметры !!") Q %0
 S:%3=2&($G(%4)="") %4="~"
 S %0=""
 N BSr1,BSt1,BSr2,BSt2,BSRold,BSTold,%zT S %zT=$ZT,$ZT="ERROR"
 
 K ^%ZAPM.bs.BSbufB("fTS"_$G(%BS(3),$P)_$J_"u")   ;копия исходной таблицы в буффер и загрузка
 S BSr1=$P(%1,"("),BSt1=$P($P(%1,"(",2),")"),BSr2="^%ZAPM.bs.BSbufB",BSt2="fTS"_$G(%BS(3),$P)_$J_"u" D COPY^%ZAPM.bs.BSTK
 S BSRold=$G(BSR),BSTold=$G(BST),BSR="^%ZAPM.bs.BSbufB",BST="fTS"_$G(%BS(3),$P)_$J_"u"
 S IYI=BSR_"("_BST X:$G(%5)'="" "D "_%5 D  K BSR,BST D NE^%ZAPM.bs.BSN S BSR=BSRold,BST=BSTold,%0="" ;```MSW МОЙ КИЛЛ BSR,BST
 .D TAB^%ZAPM.bs.BSF1 ;А ЭТО КТО БУДЕТ ДЕЛАТЬ ? ПУШКИН ЧТО-ЛИ ?
 ;Выборка данных
 N mas,mas1,i,i1,i2,i3,i4
 S mas="^%ZAPM.bs.BSbufB(""fTS""_$G(%BS(3),$P)_$J_""u"")"
 I %3=1 S mas1="^%ZAPM.bs.BSbufB(""W""_$G(%BS(3),$P)_$J_""u"")",%0=mas1 K @mas1
 I "1,2"'[%2 D  G Q     ;По колонке
 .S i1=$P(%2,"#") I i1="" Q %0
 .S i2=$P(%2,"#",2) S:i2="" i2=1
 .S i3=$P(%2,"#",3) S:i3="" i3=999
 .F i=i2:1:i3 Q:'$D(@mas@(i,1))  D EXT
 
 D  G Q                 ;По выделенным или незакрытым от записи
 .S i=0 F  S i=$O(@mas@(i)) Q:i=""  Q:i'=+i  D
 ..S i1="" F  S i1=$O(@mas@(i,i1)) Q:i1=""  D
 ...I %2=1 D:$P(@mas@(i,i1),"@",12)=1 EXT Q
 ...I %2=2 I $P(@mas@(i,i1),"@",5)="" D EXT Q
 
EXT ;Запись данных
 I %3=2 S %0=%0_$P($G(@mas@(i,i1)),"@",15)_%4 Q
 I $P($G(@mas@(i,i1)),"@",15)'="" S @mas1@(i,i1)=$P($G(@mas@(i,i1)),"@",15)
 Q
 
Q S $ZT=%zT Q %0
 
ERROR ;
 D ErrMsg^%ZAPM.bs.BSXfun("Ошибка !! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE))
 S %0="" Q %0
]]></Routine>


<Routine name="%ZAPM.bs.BSvdaMAIL" type="MAC" languagemode="0"><![CDATA[
%BSvdaMAIL ;ПОЧТОВЫЕ ОПЕРАЦИИ - ПРИЕМ/ОТПРАВКА ПОЧТОВЫХ СООБЩЕНИЙ
 ;       
 ;  Copyright (C) Воронов Д.А.
 ;  Copyright (C) Serge W. Mikhaylenko
 ;  All Rights Reserved
 q
MainServerSMTP() //какой нынче почтовый сервер главный?
 ;N A,IP,port,sport,TCP S ErrMsg="Error "
  Q $ZU(110) ;пока так
 S A=$ZCONVERT($P($P($$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin"),"@",2),">"),"U")
 I A="" S ErrMsg="Не определен Главный почтовый сервер ИнфоПортала" Q ""
 I A'=$ZU(110) D  Q A
 .S IP=$P($ZU(54,13,A),",") I IP="" S ErrMsg="Главный почтовый сервер ИнфоПортала '"_A_"' не доступен",A=""
 .Q  ;ПРОВЕРИТЬ ЗАПУЧЕН ЛИ ОН НА 25 ПОРТУ?
 .F sport=1965,25 D
 ..S TCP="|TCP|"_sport Open TCP:(A:sport):2 I  C TCP K TCP Q 
 .I $D(TCP) S ErrMsg="На сервере '"_A_"' не запущен SMTP сервер",A=""
 S port=$P($G(^%ZAPM.bs.BSpgWEMM("HOST",$ZCONVERT($ZU(110),"U")),"25,110"),",",1) L ^%ZAPM.bs.BSpgWEBC(port):0 
 I  S ErrMsg="Главный почтовый сервер ИнфоПортала '"_A_"' не запущен",A="" Q A
 Q $ZU(110)
NEWS //ПОЧТА?
 I $$MainServerSMTP="" Q
 N BSmName,BSmPass S BSmName=BSLOGIN,BSmPass=BSSES
 W "<HR>" S MSG=$$NEWSMAIL(BSLOGIN,BSSES) 
 I MSG'="0/0" W !,RED,"Для Вас есть письма ! Новых сообщений "_MSG_". <A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"POP2^~BSvdaMAIL")_"' TITLE='письма, пришедшие на ваш адрес'>загрузить</A>"_EF i 1
 e  W !,RED,"Для Вас писем нет !",EF
 W " Можете сами создавать сообщения. <A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"SMTP1^~BSvdaMAIL")_"' TITLE='написать письмо другому пользователю портала'> Написать письмо</A>"
 Q
ADMINMAIL ;СОБРАТЬ ВСЕ ПОЧТУ ДЛЯ АДМИНА
 N BSmName,BSmPass,ADMINMAIL S BSmName=BSLOGIN,ADMINMAIL=1
 D VAR,BEG1^%ZAPM.bs.BSC4 
 W $$TITL^%ZAPM.bs.BSCGIS("ПРИЕМ ПОЧТЫ"),$$B27^%ZAPM.bs.BSCGIS(1)
 I $G(EMO)="" S EMO=$$MainServerSMTP
 I EMO'="" D POPP(EMO)
 S MDE="" F  S MDE=$O(^%ZAPM.bs.BScSMTP(MDE)) Q:MDE=""  I MDE'=EMO D POPP(MDE,BsMAILpass)
 d EOF
 Q
NEWSMAIL(BSmName,PASS) //КОЛИЧЕСТВО ПИСЕМ N/L
 //N - всего 
 //L - из них от живых пользователей
 N i,I,MASS,EMO,L
  S EMO=$$MainServerSMTP I EMO="" Q "'ErrorServerName'"
  S BSmName1=$G(BSmName)_"@"_EMO
 I $$POP3(EMO,BSmName1,PASS,.MASS,$$DIRUSER^%ZAPM.bs.BSCmDDR($P(BSmName,"@")))<1 Q "0/0"
 S I="",L=0 F i=1:1 S I=$O(MASS(I)) Q:I=""  I $P($G(MASS(I,"from")),"@",1)'="BSystemGuard" S L=L+1
 Q (i-1)_"/"_L
VAR      ;ФОРМИРОВАНИЕ БАЗОВЫХ ПЕРЕМЕННЫХ 
 ;
 q
BOF ;НАЧАЛО ФАЙЛА HTML
 D BEG1^%ZAPM.bs.BSC4
 w "<TITLE>ОТПРАВКА/ПРИЕМ ПОЧТОВЫХ СООБЩЕНИЙ</TITLE>",BK
 q
EOF ;ЗАВЕРШЕНИЕ ФАЙЛА HTML
 D END^%ZAPM.bs.BSC4
 q
MAIN      d BOF
HOMEPAGE ;Главная страница
 S A=$$MainServerSMTP I A="" W ErrMsg Q
 D SMTP1
 D POP1
 d EOF
 Q
SELFILES(N) //СПИСОК ФАЙЛОВ ИЗ РАБОЧЕЙ ДИРЕКТОРИИ
 N MAS,U1,i,I,FN,Q,FN1,FN2
 S FN2=$ZCVT($$DIRUSER^%ZAPM.bs.BSCmDDR,"L")
 S MAS="in" D FileListDir^%ZAPM.bs.BSCEXE(FN2,MAS,2,"")
 S Q="<select name=FILE"_N_" >"_"<option> </option>"
 S U1="",i=0,I=0 F  S U1=$O(@MAS@(U1)) Q:U1=""  D
 .S FN=$ZCVT($P(@MAS@(U1),"?",1),"L"),FN1=$P(FN,FN2,2)
 .S Q=Q_"<option>"_FN1_"</option>"
 Q Q_"</select>"_BK
SELLSERV N list D USERSMAILIST^%ZAPM.bs.BSpgWEMM(.list) w "<option VALUE='' ></option>"
 //$$CFG^%ZAPM.bs.BSCp()="ASU"
 s i="" f  s i=$o(list(i)) Q:i=""  I $G(@BDUSE@(list(i),"FNM"))'="" s z=$G(@BDUSE@(list(i),"FNM")) i $a($e(z))>73  S list2(z)=list(i)
 s i="" f  s i=$o(list2(i)) Q:i=""  w "<option VALUE="_list2(i)_" " W:$G(BSend2mail)=list2(i) "SELECTED" W ">" D  W "</option>"
 .W i ;_"("_list2(i)_")"
 .;I $G(@BDUSE@(list(i),"FNM"))'="" W "("_@$ZR_")"
 w "</select>" Q
atth(cf) i cf="VV" q " title='для того чтобы вложить в письмо файл, его надо сначало отправить в рабочую директорию FTP-сервера, а потом после обновления панели выбрать его из трех списков' " 
 q " title='выберите только один файл и вложите его в письмо' " 
SMTP1    d VAR   D BEG1^%ZAPM.bs.BSC4
 w "<TITLE>ОТПРАВКА ПОЧТОВЫХ СООБЩЕНИЙ</TITLE>",BK
 S EMO=$$MainServerSMTP I EMO="" W ErrMsg Q
 I $G(BSLOGIN)="" W RED_"Сначало откройте сессию ИнфоПортала !"_EF Q
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name=""frmsmp"">",BK
 S BSLABEL="SEND^~BSvdaMAIL"    
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 w "<table border=0 width=100%><TR><TD class=s5 align=center><B>Отправка почты</B></TD></TR></TABLE>",BK
 w "<table border=0 width=100%><tr><TD class=s3 align=center><img border=0 src='"_BSDOMAIN_"/img/letter.gif' >Кому*</td> <TD class=s3>" ;<input type=""text"" name=""komu"">"
 ;w "@"
 i $G(BSend2mail)'="" w "<input type=""text"" disabled value='"_$G(BSend2mail)_"' size=90>" w "<input type=""hidden"" name=komu value='"_$G(BSend2mail)_"' size=90>"
 e  w "<select name=komu>" D SELLSERV
 w "</td></tr>"
 w "<TD class=s3 align=center>От кого </td><TD class=s3><input DISABLED type=""text"" value="_$G(BSLOGIN,"NoName")_" >"
 w "<input type=""HIDDEN"" name=otkogo value="_$G(BSLOGIN,"NoName")_" >"
 w "<input DISABLED type=""text"" name=EMO1 value='@"_EMO_"' >"
 w "</td></tr>"
 w "<TD class=s3 align=center>Тема </td><TD class=s3><input type=""text"" name=""SUBJ"" value='"_$G(SUBJ)_"' size=90></td></tr>"
 w "<tr><td class=s3 align=center>Сообщение</td> <td class=s3><textarea rows=10 cols=90 name='TXTMAIL' >" D  W "</textarea></td></tr>"
 .I '$D(BSmN) W "Здравствуйте ..."_BK_BK_BK_"С Уважением ..." Q
 .F TA=1:1 Q:'$D(TA(TA))  W TA(TA)_BK
 s zBS4cfg=$G(^%ZAPM.bs.BS("Config")) 
 w "<tr><td class=s3 align=center "_$$atth(zBS4cfg)_">"_$s(zBS4cfg="VV":"Прикрепить файл<img border=0 src='"_BSDOMAIN_"/img/attach.gif' >",1:"")_"</td>"
 w "<td "_$$atth(zBS4cfg)_" class=s3>" d  w "</td></tr></table>"
 .i zBS4cfg="VV" w $$FTPBUTT^%ZAPM.bs.BSCmDDR(BSLOGIN)_$$SELFILES(1)_$$SELFILES(2)_$$SELFILES(3)  q
 .Q  //ПОКА ТАК
 .I $G(@BDSES@(BSSES,"VAR","Attach"))'="" W RED_$G(@BDSES@(BSSES,"VAR","Attach"))_EF_BBK
 .w $$BUTTBS^%ZAPM.bs.BSCp2("UPL^~BSvdaMAIL","attach.gif","_new","Выберите файл",300,500,"Выберите файл") 
 .S @BDSES@(BSSES,"VAR","HTTPREF")=$P(HTTPREF," ",2,999)
 w "<center>"
 w "<BUTTON onclick='Prov(komu.value);'  name=""sseenndd""  title='save currently setting' ><img border=0 src='"_BSDOMAIN_"/img/send.gif' > Отправить</BUTTON>"_BK
 //w "<input Type=""submit"" name=""sseenndd"" value=""Отправить"" >
 
 w " * - поля, обязательные для заполнения </CENTER>"
 w "</form>",BK
 D JS^%ZAPM.bs.BSCp
 w "function Prov(v) {"_BK
 w "if (v=='') {alert('Поле адресата пустое!'); return false; }"_BK
 w "frmsmp.submit(); "_BK
 w "}"_BK
 D JSE^%ZAPM.bs.BSCp
 w "<HR>"
 Q
UPL  //UPLOAD FILE TO SERVER
 S BSS1=""
 S BSS6="FILE1^~BSvdaMAIL" //ПРОГРАММА КОТОРАЯ ИСПОЛНЯЕТСЯ ПОСЛЕ ЗАГУЗКИ ФАЙЛА
 S BS1="" 
 S BS2=""  I $$SetVar^%ZAPM.bs.BSC4("NSpace",BSNSP) 
 S BSS3=BSSES,BS3=MGWLIB,BSS8=$$BSADDVAR^%ZAPM.bs.BSC4(),BSS4="" 
 D UP^%ZAPM.bs.BSC4r3
 Q 
FILE1 D BEG1^%ZAPM.bs.BSC4 W $$TITL^%ZAPM.bs.BSCGIS("UPLOAD. Step 2"),$$B27^%ZAPM.bs.BSCGIS(1) 
 W RED_$G(FiNa)_EF_BBK //ИМЯ ФАЙЛА
 //S NoCloseWin=1 //ФЛАГ НЕ ЗАКРЫВАТЬ ОКНА
 N AA M AA=@GL D Arr2File^%ZAPM.bs.BSCEXE(.AA,"c:\!\1222") K @GL //МАССИВ В КОТОРОМ ЛЕЖИТ ЗАГРУЖЕННЫЙ ФАЙЛ
 S @BDSES@(BSSES,"VAR","Attach")=$G(FiNa)
 D JS^%ZAPM.bs.BSCp
 w "opener.location='"_$G(@BDSES@(BSSES,"VAR","HTTPREF"))_"';"_BK
 D JSE^%ZAPM.bs.BSCp
 D END^%ZAPM.bs.BSC4
 Q 
ANSVER1 
 ;D locvar^%ZAPM.bs.BSCh0("",1) //1 - выводить %KEY,%CGI,%ZCS,%CGIEVAR
 N MA M MA=@BDSES@(BSSES,"VAR","MSG",BSmN) K TA 
 S I="" F  S I=$O(MA("z",I)) Q:I=""  D
 .I $G(MA("z",I,"msg"))="text" D
 ..S II="" F TA=1:1 S II=$O(MA("z",I,"msg",II)) Q:II=""  S TA(TA)=$E($G(BSend2mail),1)_"&gt;"_$G(MA("z",I,"msg",II))
 S SUBJ="Re: "_$G(MA("subject"))
 S BSend2mail=$ZCONVERT($P($G(MA("from")),"@",1),"U")
 G SMTP1
SEND //ПОСЛАТЬ ПИСЬМО
 d VAR
 d BOF
 if $G(komu)="" W RED_"Не заполнено поле 'КОМУ'"_EF G MAIN
 I $G(SUBJ)="" S SUBJ=$TR($E(TXTMAIL,1,50),$C(13,10),"  ") I SUBJ="" S SUBJ="NO SUBJ"
 F I=1:1:3 I $G(@("FILE"_I))'=""  D  S ATT(I)=DIRUSER_$G(@("FILE"_I))
 .I '$D(DIRUSER) S DIRUSER=$$DIRUSER^%ZAPM.bs.BSCmDDR()
 S EMO=$$MainServerSMTP I EMO="" W ErrMsg Q
 S S=$$SMTP(EMO,$G(TXTMAIL),$G(otkogo)_"@"_EMO,$G(komu)_"@"_EMO,$G(SUBJ),.ATT)
 I 'S W RED_S_EF
 E  w GREEN_"Отправлено"_EF_" Письмо от <I><B>"_$G(otkogo)_"@"_EMO_"</B></I> к <I><B> "_komu_"@"_EMO_"</B></I> на тему <I><B>"_SUBJ_"</B></I>"
 G HOMEPAGE
 
SMTP(MDEAM,TXTMAIL,otkogo,komu,SUBJ,att) //ПОСЛАТЬ
 N OK1 S OK1=1
 set s=##class(%Net.SMTP).%New()
 set s.port=$G(^%ZAPM.bs.BScSMTP(MDEAM,"SMTP"),"25")
 set s.smtpserver=MDEAM         // Specify SMTP server name.
 set s.timezone=$$TimeZone^%ZAPM.bs.BSpgWEMM()  // Timezone by Grinwitch
 set m=##class(%Net.MailMessage).%New() 
 set m.From=$G(otkogo)        // From 
 do m.To.Insert($G(komu)) // List of emails to send this mail
 set m.Subject=$G(SUBJ)     // Subject
 // Charset specification
 //set m.Charset="iso-8859-1" 
 // Text
 do m.TextData.Write(TXTMAIL)
 // Attachments
 n i
 I $D(att) S i="" F  S i=$O(att(i)) Q:i=""  D
 .set status=m.AttachFile($P(att(i),"\",1,$L(att(i),"\")-1)_"\",$P(att(i),"\",$L(att(i),"\")))
    //Send letter   
 set status=s.Send(m)    if ('status) S OK1=$$ERRWF(status)
 do m.%Close()
 do s.%Close()
 quit $G(OK1)
 
POP1 D VAR,BEG1^%ZAPM.bs.BSC4
 N BSmName
 w "<TITLE>ПРИЕМ ПОЧТЫ</TITLE>",BK
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name=""frmsmp"" target='RECEIVE'>",BK
 S BSLABEL="POP2^~BSvdaMAIL"    
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 w "<table border=0 width=100%><TR><TD align=center class=s5><B>Просмотр входящих писем</B></TD></TR></TABLE>",BK
 w "<table border=0 width=100%>"
 w "<tr><TD class=s3>Имя пользователя</td><TD class=s3><input type=""text"" DISABLED value="""_BSLOGIN_""" ><input type=""HIDDEN"" name=""BSmName"" value="""_BSLOGIN_""" >"
 ;w "@"
 ;w "<select name=EMO>" D SELLSERV
 w "</td></tr>"
 ;w "<tr><TD class=s3>Пароль</td><TD class=s3 ><input type=""password"" name=""BSmPass"" value=""""></td>"
 w "</table><center><img border=0 src='"_BSDOMAIN_"/img/recv.gif' ><input Type=""submit"" value=""Проверить почту""></center>",BK
 w "</form>",BK
 w "<IFRAME HEIGHT='98%' width='98%' SRC='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"stub^~BSCrep")_"' name='RECEIVE' SCROLLING='auto'></IFRAME><BR>"
 q
TABHEAD(A) w "<table border=0 width=100%><tr>"_BK
 F I="№","От кого","Написанное","Тема","Объем (байт)","Файлы","Действие" I A'[I W "<td class=s2>"_I_"</td>"
 W "</tr>"_BK
 Q
TABMAIL(MASS,BSmN,S) F I="from","date","subject","messagesize" D
 .N COL1,COL2  //
 .I I="from" D
 ..I MASS(BSmN,I)'["BSystemGuard" S COL1=RED,COL2=EF
 ..i $$CFG^%ZAPM.bs.BSCp="ASU",$p(MASS(BSmN,I),"@")'="" s fio=$G(@BDUSE@($p(MASS(BSmN,I),"@"),"FNM"))  s MASS(BSmN,I)=fio
 .W "<TD class=s1>"_$G(COL1)_MASS(BSmN,I)_$G(COL2)_" " D:S  W "</TD>"_BK
 ..I I="subject" N i S i="" F  S i=$O(MASS(BSmN,"z",i)) Q:i=""  D TEA(.MASS,BSmN,i,5,45)
 Q
TEA(MA,BSmN,I,rows,cols)  I $G(MA(BSmN,"z",I,"head","content-type"))["text/plain" D
 .N II w "<textarea rows="_rows_" cols="_cols_">"
 .S II="" F  S II=$O(MA(BSmN,"z",I,"msg",II)) Q:II=""  W $G(MA(BSmN,"z",I,"msg",II))
 .W "</textarea>"_BBK 
 Q
AttachCount(MA,BSmN) //ПОСЧИТАТЬ СКОЛЬКО ВЛОЖЕНО ФАЙЛОВ
 N I,Q S Q=""
 S I="" F  S I=$O(MA(BSmN,"z",I)) Q:I=""  D
 .I $G(MA(BSmN,"z",I,"msg"))="binary" I $G(MA(BSmN,"z",I,"msgFN"))'="" S Q=Q+1
 Q Q
POP2 //ПОКАЗАТЬ СПИСОК ПИСЕМ
 i $d(main) g MAIN
 D VAR,BEG1^%ZAPM.bs.BSC4 
 W $$TITL^%ZAPM.bs.BSCGIS("ПРИЕМ ПОЧТЫ"),$$B27^%ZAPM.bs.BSCGIS(1)
 I $G(EMO)="" S EMO=$$MainServerSMTP
 I EMO'="" D POPP(EMO)
 d EOF
 q
POPP(EMO,BSmPass)
 S BSmName1=$G(BSmName)_"@"_$G(EMO) K MASS
 I $$POP3(EMO,BSmName1,$G(BSmPass,BSSES),.MASS,$$DIRUSER^%ZAPM.bs.BSCmDDR($P(BSmName1,"@")))<1 W "Сервер: "_EMO W RED D ERRW($G(%objlasterror)) W EF_BBK Q:$D(ADMINMAIL)  q // G POP1
 K @BDSES@(BSSES,"VAR","MSG")
 M @BDSES@(BSSES,"VAR","MSG")=MASS //СОХРАНИТЬ В БУФЕРЕ ПОЛЬЗОВАТЕЛЯ
 N BSLABEL,BSLOGINDFLT,BSNOREG,BSTOP,BSTOP1,BSTOP3
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name=""messages"">",BK
 S BSLABEL="POP4^~BSvdaMAIL"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 w "<table border=0 width=100%><TR><TD align=center class=s5><B>Сервер: "_RED_EMO_EF_" Входящие письма для "_RED_BSmName1_EF_"</B></TD></TR></TABLE>",BK
 D TABHEAD("1")
    //                                                                   "Fri, 13 Jan 2006 21:45:25 0300"           
    N z,zz,zzz S zz="" F   S zz=$O(MASS(zz)) Q:zz=""  S zzz=$TR($ZDTH($P(MASS(zz,"date")," ",2,5),2),",",".") M z(+zzz)=MASS(zz)
    K MASS S zz="" F z=1:1 S zz=$O(z(zz)) Q:zz=""  M MASS(z)=z(zz)
 S BSmN="" F  S BSmN=$O(MASS(BSmN),-1) Q:BSmN=""  W "<TR><TD class=s1>"_BSmN_"</TD>" D
 .D TABMAIL(.MASS,BSmN,1)
 .W "<TD class=s1>"_$$AttachCount(.MASS,BSmN)_"</BUTTON>"_BK
 .//S BSLABEL="READMSG^~BSvdaMAIL"
 .W "<TD class=s1>" //<BUTTON title='Смотреть письмо в новом окне' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""",""MSG"",""toolbar=no,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1"");' ><img border=0 src='"_BSDOMAIN_"/img/lett-op.gif' >Смотреть</BUTTON>"_BK
 .S BSLABEL="KILLMSG^~BSvdaMAIL"
 .W "<input Type=CHECKBOX name=DelMail"_BSmN_"> Удалить письмо</TD>"_BK
 .W "</TR>"_BK
 w "</table>"_BK
 w "<div align=RIGHT><input Type=submit name=backtomaiN value=""Закрыть окно""><input Type=HIDDEN name=DE value=''>"
 w "<BUTTON onclick='messages.DE.value=1; submit();' TITLE='Удалить помеченные' ><img border=0 src='"_BSDOMAIN_"/img/kill.gif' >Удалить помеченные</BUTTON>"_BK
 w "<BUTTON onclick='messages.DE.value=2; submit();' TITLE='Удалить все' ><img border=0 src='"_BSDOMAIN_"/img/del.gif' >Удалить все</BUTTON>"_BK
 w "</div>",BK
 w "</form>"
 Q
POP4 //ПОКАЗАТЬ СПИСОК ПИСЕМ
 D VAR N OK D BEG1^%ZAPM.bs.BSC4
 ;D locvar^%ZAPM.bs.BSCh0("",1)
 ;D JS^%ZAPM.bs.BSCp
 if $G(DE)     D  W RET //"alert('"_RET_"');"_BK
 .F I=1:1:350 I $D(@("DelMail"_I))!(DE=2) S MA(I)=""
 .S OK=$$KILLMAIL($P($G(BSmName1),"@",2),$G(BSmName1),$G(BSmPass,BSSES),.MA,.Kill) I OK<1 S RET=$$ERRWF(OK) I 1
 .E  S RET="удалено "_+$G(Kill)
 ;W "window.close();"_BK
 ;D JSE^%ZAPM.bs.BSCp
 d EOF
 Q
KILL1 S DELE=1,@("DelMail"_BSmN)=1 
  G POP4
READMSG //ЧИТАТЬ ПИСЬМО
 d VAR D BEG1^%ZAPM.bs.BSC4 W "<TITLE>Письмо № "_BSmN_" для "_BSmName1_"</TITLE>"
 w "<BODY "_$$27^%ZAPM.bs.BSCGIS_">"_BK
 N MA M MA=@BDSES@(BSSES,"VAR","MSG") //ВОССТАНОВИТЬ ИЗ БУФЕРА ПОЛЬЗОВАТЕЛЯ
 ;D locvar^%ZAPM.bs.BSCh0("",1)
 D TABHEAD("№ДействиеФайлы")
 D TABMAIL(.MA,BSmN,0) W "</TABLE>"
 S I="" F  S I=$O(MA(BSmN,"z",I)) Q:I=""  D
 .D TEA(.MA,BSmN,I,25,90)
 .W "<A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"ANSVER1^~BSvdaMAIL")_"'>Ответить</A>"
 .W " <A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4(,"KILL1^~BSvdaMAIL")_"'>Удалить</A>"
 .I $G(MA(BSmN,"z",I,"msg"))="binary" S FN=$G(MA(BSmN,"z",I,"msgFN")) I FN'="" W "<img border=0 src='"_BSDOMAIN_"/img/attach.gif' >Вложенный файл <b style='color: white; background-color: Gray;' >"_FN_"</b> можно загрузить через FTP-Cервер "_$$FTPBUTT^%ZAPM.bs.BSCmDDR(BSLOGIN)_BBK
 d EOF
 Q
 
ERRW(S) D DecomposeStatus^%apiOBJ(S,.err) 
 i err(err)["ОШИБКА #6015" w !,"Сообщений нет!",! q
 write !,err(err),! 
 Q
ERRWF(S) D DecomposeStatus^%apiOBJ(S,.err) Q err(err)
POP3(MDEAM,BSmName,BSmPass,MASS,dir) //ВОЗВРАТИТ МАССИВ СПИСКА ПИСЕМ
 ;MDEAM - ИМЯ ПОЧТОВОГО СЕРВЕРА ИЛИ ЕГО IP
 ;,BSmName - ИМЯ ПОЛЬЗОВАТЕЛЯ  = "NAME_user@"_MDEAM
 ;,BSmPass - ПАРОЛЬ ПОЛЬЗОВАТЕЛЯ
 ;,MASS - МАССИВ КОТОРЫЙ СОЗДАСТ ПРОГРАММА, ГДЕ БУДЕТ ЛЕЖАТЬ СПИСОК ПИСЕМ
 ;,dir - ПУТЬ К ДИРЕКТОРИИ, КУДА ЗАКАЧАЮТСЯ ВЛОЖЕННЫЕ ФАЙЛЫ
 new mailserver,status,from,to,date,subject,messagesize,m,hdrs,key,mailMsg,lined
 N mssg
 set mailserver=##class(%Net.POP3).%New()
 I $D(dir) set mailserver.AttachDir=dir
 set mailserver.Debug=0
 set mailserver.port=$G(^%ZAPM.bs.BScSMTP(MDEAM,"POP"),"110")
 set mailserver.StoreAttachToFile=1
 set status=mailserver.Connect(MDEAM,BSmName,BSmPass)
 if ('status) g clo
 f mssg=1:1 d  if ('status) Q
 .set status=mailserver.FetchMessage(mssg,.from,.to,.date,.subject,.messagesize,.hdrs,.mailMsg,0)
 .if ('status) Q
 .S MASS(mssg,"subject")=subject
 .S MASS(mssg,"date")=date
 .S MASS(mssg,"from")=from
 .S MASS(mssg,"messagesize")=messagesize
 .S MASS(mssg,"to")=to
 .N MAS
 .d Dump(mailMsg,.MAS)
 .M MASS(mssg,"z")=MAS
 .s status=mailMsg.%Close()
clo s status=mailserver.%Close()
 q $G(mssg)-1
Dump(msg,MASS) 
 new i,index,value
 if msg.IsMultiPart do  quit
 . for i=1:1:msg.Parts.Count() do Dump(msg.Parts.GetAt(i),.MASS)
 s index=""  f  s value=msg.Headers.GetNext(.index) q:index=""  S MASS(msg,"head",index)=value
 if msg.IsBinary do
 . S MASS(msg,"msg")="binary"
 . S MASS(msg,"msgFN")=msg.FileName
 . S MASS(msg,"msgGA")=msg.GetAttribute("content-disposition","filename")
 else  do
 . ;w !,"Dumping text msg Filename="_msg.FileName_" filename="_msg.GetAttribute("content-disposition","filename"),!
 . S MASS(msg,"msg")="text"
 . S MASS(msg,"msgFN")=msg.FileName
 . S MASS(msg,"msgGA")=msg.GetAttribute("content-disposition","filename")
 . set stream=msg.TextData
 . do stream.Rewind()
 . new len,line
 . for l=1:1 set len=32763,line=stream.Read(.len) do  quit:stream.AtEnd
 ..S MASS(msg,"msg",l)=line         ;write line
 quit 
KILLMAIL(MDEAM,BSmName,BSmPass,MSGK,Kill) //УДАЛИТЬ СПИСОК ПИСЕМ
 new mailserver,status,from,to,date,subject,messagesize,m,hdrs,key,mailMsg,lined,I
 N OK S OK=1,Kill=0
 set mailserver=##class(%Net.POP3).%New()
 set mailserver.port=$G(^%ZAPM.bs.BScSMTP(MDEAM,"POP"),"110")
 set mailserver.Debug=0
 set mailserver.StoreAttachToFile=1
 set status=mailserver.Connect(MDEAM,BSmName,BSmPass)
 if ('status) S OK=status g Kclo
 S I="" F  S I=$O(MSGK(I)) Q:I=""  set OK=mailserver.DeleteMessage(I) S:OK Kill=Kill+1 I 'OK Q
 s status=mailserver.QuitAndCommit()
Kclo s status=mailserver.%Close()
 q $G(OK)
T1 W $$POP3^%ZAPM.bs.BSvdaMAIL("IVCMSW","SSS1","S",.MASS,"D:\!\1\") ZW MASS
 Q
T2       ;F I=2,3 S MA(I)=""  //УДАЛИТЬ 2,3 ПИСЬМО
 W $$KILLMAIL("IVCMSW","SSS1","S",.MA,.KKK)
 Q
 //ORIGINALLLLLL
 D ^%ZAPM.bs.BSCmail
]]></Routine>


<Routine name="%ZAPM.bs.BSvdaSTAT" type="MAC" languagemode="0"><![CDATA[
%BSvdaSTAT ;Статистика обращений к информационной системе
 ;
 ;    Copyright (C) 2003 Serge W. Mikhaylenko
 ;    Copyright (C) 2002 Воронов Д.А.
 ;    All Rights Reserved
 ;
 Q
STAT(S) S BSLABEL="HOMEPAGE^~BSvdaSTAT" 
 Q "<a href='javascript: var a=5;' onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""",""RESULT3"",""toolbar=yes,menubar=no,scrollbars=yes,status=1,resizable=1"");' TITLE=""Мониторинг системы""><img border=0 src='"_BSDOMAIN_"/img/diag.gif'>"_S_"</a>"
mainvar      ;ФОРМИРОВАНИЕ БАЗОВЫХ ПЕРЕМЕННЫХ 
 S BD=$$SW^%ZAPM.bs.BSF12("^[""%SYS"",""""]%BScVIS")
 S BDS=%BS(24,1) I '$$Data^%ZAPM.bs.BSF12(BDS) W RED_" Не доступна "_BDS_EF H
 S WAR="^mtempBSvdaSTAT"
 S BDip=$$SW^%ZAPM.bs.BSF12("^[""%SYS"",""""]%BScIP")
 q
BOF ;НАЧАЛО ФАЙЛА HTML
 D BEG1^%ZAPM.bs.BSC4
 w "<TITLE>",$G(CAPTION)_$ZU(110)_"-Мониторинг Информационного портала</TITLE>",BK
 q
EOF ;ЗАВЕРШЕНИЕ ФАЙЛА HTML
 //w "</BODY></HTML>",BK
 D END^%ZAPM.bs.BSC4
 q
FUN D JS^%ZAPM.bs.BSCp
 w "function fu1(COL1,NUM) {",BK
 ;W "alert(NUM);"_BK
 S BSLABEL="ADV^~BSvdaSTAT",BSCDAY=CDAY
 W "var HREF1="""_$$ADDBSGET^%ZAPM.bs.BSC4()_"&BSCOL1=""+COL1+""&BSNUM=""+NUM;"_BK
 W "open(HREF1,""ADV"",""toolbar=no,menubar=no,scrollbars=no,width="_$G(W,540)_",height="_$G(H,480)_",status=1,resizable=1"");"_BK
 w "}",BK
 D JSE^%ZAPM.bs.BSCp
 Q
ADV d mainvar
 S TITL="Сделать Новый Отчет. ("_$ZD(BSCDAY,3)_","_$G(BSCOL1,"?")_","_$G(BSNUM,"?")_")"
 D BEG1^%ZAPM.bs.BSC4  W $$TITL^%ZAPM.bs.BSCGIS(TITL),$$B27^%ZAPM.bs.BSCm4()
 S BSnewPR=$G(@BDS@(BSCDAY,BSNUM,"U")),BSipF=$P($P($G(@BDS@(BSCDAY,BSNUM,"S")),":IP=",2)," ")
 D REPORT("ADV",$G(@BDS@(BSCDAY,BSNUM,"S")),$G(@BDS@(BSCDAY,BSNUM,"A")))
 D END^%ZAPM.bs.BSC4 
 Q
USCH(P,A) Q "<INPUT TYPE=""CHECKBOX"" NAME=BSchk"_P_" "_$S($G(A):"CHECKED",1:"")_" >"
USERS //ПАРАМЕТРЫ ПОИСКА
 S BDGR=$$KBD^%ZAPM.bs.BSF12("^%ZAPM.bs.BSC4(""PROTECT"")")
 W "Сформировать отчет<FIELDSET><LEGEND>по пользователю: </LEGEND>"_$$USCH("U",1)_"<select name=BSnewPR size=1>"_BK_BK
 W "<option value='*' >*все пользователи*</option>"
 S G="" F  S G=$O(@BDGR@(G)) Q:G=""  W "<option value='"_G_"' " W:G=$G(BSnewPR) "SELECTED" W ">"_G_"</option>"
 W "</SELECT>"_BK_BK_$$AccU^%ZAPM.bs.BSCm2("BSnewPR")_"</FIELDSET>"_BBK
 W "<FIELDSET><LEGEND> по IP - адресу </LEGEND>"_$$USCH("I")_"<select name=BSipF size=1><option value='*' >*все адреса*</option>"
 S G="" F  S G=$O(@BDip@(G)) Q:G=""  W "<option value='"_G_"' " W:G=$G(BSipF) "SELECTED" W ">"_G_"</option>"
 W "</SELECT></FIELDSET>"_BBK
 W "<FIELDSET><LEGEND> по сетевому имени </LEGEND>"_$$USCH("N")_"<select name=BSipFN size=1><option value='*' >*все имена*</option>"
 S G="" F  S G=$O(@BDip@(G)) Q:G=""  W "<option value='"_G_"' " W:G=$G(BSipFN) "SELECTED" W ">"_$G(@BDip@(G,"NAM"))_"</option>"
 W "</SELECT></FIELDSET>"_BBK
 Q
IPAC(I) N A
 I I'["." S A=$P($ZU(54,13,I),",") Q A
 ;   S NAME2=$P($zu(54,14,$zu(54,1,IP2)),",",2) 
 S A=$zu(54,14,$zu(54,1,I)) d mainvar
 S A=$P(A,",",2) 
 I $$Data^%ZAPM.bs.BSF12(BDip) D
 .I A'="" S @BDip@(I,"NAM")=A
 .E  S Noact=$G(@BDip@(I,"NAM"))
 Q A
IPA D BEG1^%ZAPM.bs.BSC4  W $$TITL^%ZAPM.bs.BSCGIS($G(BSipa)),$$B27^%ZAPM.bs.BSCm4()
 w "<BODY>"
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"">"
 S BSLABEL="IPA^~BSvdaSTAT"
 D
 .N BSipa D ADDBSPOST^%ZAPM.bs.BSC4reg
 N A,B,a,Noact S A=""
 i $g(BSipa)'="" S A=$$IPAC(BSipa)
 s a="Введите IP адрес, или Сетевое имя " w a
 W "<input type=textbox name=BSipa value='"_$g(BSipa)_"' title='"_a_"'><HR>"_BBK
 S B=A_" "_$S(A="":"(Не активно)",1:"(Активно)")
 W "Ответ сервера DNS : "_RED_$S(B="":"???",1:B)_EF_" "_$G(Noact)_BBK
 w "<HR><input type=submit name=sDUB value='Послать запрос к серверу DNS' title='DNS'>"_BK
 w "</form>"
 d END^%ZAPM.bs.BSC4
 Q
IP(IP) N TIT I "?"[IP Q "?"
 I $$Data^%ZAPM.bs.BSF12(BDip),$G(@BDip@(IP,"NAM"))'="" S TIT="TITLE='"_@$ZR_"'"
 Q "<B "_$G(TIT)_" class=U1 onclick='DNS("""_IP_""");' >"_IP_"</B>"
REC(P1,P2,P3,Arm) //ПАРАМЕТРЫ ЗАПИСИ
 N U,S,A,TU
 I P1'="" D
 .I $D(@BDUSE@(P1)) S TU=$G(@BDUSE@(P1,"FNM"))
 D
 .I P2[":IP" S P2=$P(P2,":IP=")_":IP="_$$IP($P($P(P2,":IP=",2)," "))_$P($P(P2,":IP=",2)," ",2,99)
 .I $E(P3,1,9)["Error" S A=$P(P3,"=")_"="_$$ErrTxt^%ZAPM.bs.BSCh0($P(P3,"=",2,9)) Q
 .I $E(P3,1,9)["Kill",P1'=$P($P(P2,":IP"),",",3) S A=MAROON_P3_EF Q
 .I $E(P3,1,9)["Upd" S S=RED_$P(P2," ")_EF_$P(P2," ",2,99),A=GREEN_P3_EF Q
 Q "<TD CLASS=S1 TITLE='"_$G(TU)_"'><A HREF='javascript:fu1(1,"""_I_""");'>"_$G(U,P1)_"</A></TD>"_"<TD CLASS=S"_$S($$REQU(CDAY,I):2,1:1)_">"_$G(S,P2)_"</TD>"_"<TD CLASS=S4>"_Arm_"</td><TD CLASS=S1><A HREF='javascript:fu1(3,"""_I_""");'>"_$G(A,P3)_"</a></TD>"
CDAYB //ВЫВЕСТИ ОДИН ДЕНЬ
 d mainvar 
 I $D(BMAIL) D ADMINMAIL^%ZAPM.bs.BSvdaMAIL Q
 I $D(BSCDAY) S CDAY=BSCDAY
 G CDAYER:$G(CDAY)="",CDAYER:'$$Data^%ZAPM.bs.BSF12($NA(@BDS@(CDAY)))
 S TITL=$ZU(110)_"-Отчет за "_$ZD(CDAY,3)
 D BEG1^%ZAPM.bs.BSC4  W $$TITL^%ZAPM.bs.BSCGIS(TITL),$$B27^%ZAPM.bs.BSCm4()
 W $$js^%ZAPM.bs.BSCp
 w "function DNS(IPA) {"_BK
 S BSLABEL="IPA^~BSvdaSTAT"
 w "window.open('"_$$ADDBSGET^%ZAPM.bs.BSC4_"&BSipa='+IPA,'viewIP',""toolbar=no,menubar=no,scrollbars=yes,width=400,height=400,status=1,resizable=1"");",BK
 W "}"_BK
 W $$jse^%ZAPM.bs.BSCp_BK
 W $$LR_"<TABLE WIDTH=100%>"_BK
 w "<TR><TD CLASS=S5>Время</TD><TD CLASS=S5>Пользователь</TD><TD CLASS=S5>Параметры (<B CLASS=S2>Критерии: "_$$PAR_EF_")</TD><TD CLASS=S5>Модуль</TD><TD CLASS=S5>Действие</TD></TR>"_BK      
 S I="" F  S I=$O(@BDS@(CDAY,I),-1) Q:I=""  w "<TR><TD CLASS=S4>"_$P(I,"..",1)_"</TD>"_$$REC($G(@BDS@(CDAY,I,"U")),$G(@BDS@(CDAY,I,"S")),$G(@BDS@(CDAY,I,"A")),$G(@BDS@(CDAY,I,"Arm")))_"</TR>"_BK
 W "</TABLE>"_BK
 d FUN,END^%ZAPM.bs.BSC4
 Q
PAR() N Q S Q="" I $D(BSchkU),$g(BSnewPR)'="*" S Q=Q_$g(BSnewPR)_", "
 I $D(BSchkI),$g(BSipF)'="*" S Q=Q_BSipF_", "
 I $D(BSchkN),$g(BSipFN)'="*" S Q=Q_BSipFN_", "
 I $D(BSapp) S Q=Q_BSapp_", "
 Q Q
LR1(D) N BSCDAY,BSLABEL I D="" Q "------"
 S BSCDAY=D,BSLABEL="CDAYB^~BSvdaSTAT"
 Q "<A TITLE='перейти на дату' HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4_"'>"_$ZD(D,3)_" "_$$WEEK^%ZAPM.bs.BSCp(D)_"</A>"
LR() Q RED_"&lt;&lt;&lt;"_$$LR1($O(@BDS@(CDAY),-1))_" &lt;&lt;&lt;"_$ZD(CDAY,3)_" "_$$WEEK^%ZAPM.bs.BSCp(CDAY)_"&gt;&gt;&gt; "_$$LR1($O(@BDS@(CDAY)))_"&gt;&gt;&gt;"_EF
CDAYER W "Данных нет"_BBK 
 Q
CDAY //ВСЕ ДНИ ПОКАЗАТЬ
 W "<FIELDSET><LEGEND>Сервер "_$ZU(110)_". Мониторинг конкретного дня</LEGEND>"
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=POST name=frmCDAY target='Stat1'>"_BK
 S BSLABEL="CDAYB^~BSvdaSTAT"
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 w "<select name=CDAY>"_BK
 S I="" F i=1:1:100  S I=$O(@BDS@(I),-1) Q:I=""  w "<option value="_I_" >"_$ZD(I,3)_"</option>"
 w "</select>"_BK 
 w "<input Type=submit value=Вывести name=BDAY TITLE='В новом окне протокол дня'>"
 s a=$$GETOPT^%ZAPM.bs.BSC4cfgP("^%ZAPM.bs.BSETUP(""ISS"")","Admin")
 I $ZCONVERT(BSLOGIN,"U")=$ZCONVERT($P($P(a,"@",1),"<",2),"U") D
 .W ", или <input Type=submit value='Смотреть ВСЮ почту Администратора ="_a_"' name=BMAIL  TITLE='...Ждите, Проверять будет все сервера'>"
 .W " <input Type=PASSWORD value='' name=BsMAILpass TITLE='Пароль нужен для удаленных серверов, и он должен быть везде одинаковый!'>"
 W "</FORM></FIELDSET>"
 Q
HOMEPAGE ;Главная страница
 d mainvar
 d BOF W $$B27^%ZAPM.bs.BSCm4()
 D CDAY
 D REPORT("HOMEPAGE","","")
 d EOF
 q
BEGYEAR() Q $P($ZD($H,3),"-")_"0101"
REPORT(BS4,Par1,Act1)
 W "<FIELDSET><LEGEND>Параметры вывода стастики</LEGEND>"
 w "<form action="""_$$ADDLIB^%ZAPM.bs.BSC4()_""" method=""POST"" name=""frmsmp"" TARGET='REPORT1'>",BK
 S BSLABEL="TEST1^~BSvdaSTAT"    
 D ADDBSPOST^%ZAPM.bs.BSC4reg
 D USERS
 S D1=$$BEGYEAR //НАЧАЛО ТЕКУЩЕГО ГОДА
 s D1=$G(@WAR@(CurUS,"OT"),D1)
 w "<H3>За период c <input type=""text"" size=7 name='DAY1' value='"_D1_"'>",BK
 S D2=$G(@WAR@(CurUS,"DO"),$E($ZD($H,3),1,4)_$E($ZD($H,3),6,7)_$E($ZD($H,3),9,10))
 s BSdateNum=1
 S BS1=BSG,BS2="111^~BSvdaSTAT"
 W $$B(D1,"Сменить","cal2","EDITDATE^~BSC4cal")
 w " по <input type=""text"" name=""DAY2"" size=7 value="""_D2_""">",BK
 s BSdateNum=2
 S BS1=BSG,BS2="222^~BSvdaSTAT"
 W $$B(D2,"Сменить","cal2","EDITDATE^~BSC4cal")
 w " , или</p>"
 w "<INPUT TYPE=""radio"" NAME=""radioName"" VALUE=chec0 >за текущий день"
 w "<INPUT TYPE=""radio"" NAME=""radioName"" VALUE=chec1 >за текущую неделю"
 w "<INPUT TYPE=""radio"" NAME=""radioName"" VALUE=chec2 CHECKED >за текущий месяц "
 w "<INPUT TYPE=""radio"" NAME=""radioName"" VALUE=chec3 >За текущий год","  </p>",BK
 w "</p>События: <select name=""BSapp"">",BK
 d GetListApp
 w "</select>",BK
 w "<input Type=""submit"" value=""Выполнить"" name=""execut""></p>",BK
 w "</H3></FORM></FIELDSET>",BK
 Q
GetListApp
    S I="*" w "<option "_$$Ss()_" value='"_I_"'> Все события</option>"_BK
    S I="Term*" w "<option "_$$Ss()_" value='"_I_"'> Терминальный вход/выход</option>"_BK
    S I="Error*" w "<option "_$$Ss()_" value='"_I_"'> Все ошибки</option>"_BK
    S I="Error Web*" w "<option "_$$Ss()_" value='"_I_"'> WebLink-ошибки</option>"_BK
    S I="ErrorTerm*" w "<option "_$$Ss()_" value='"_I_"'> Терминальные ошибки</option>"_BK
    S I="Change*" w "<option "_$$Ss()_" value='"_I_"'> Изменение параметров системы</option>"_BK
    S I="*Sess" w "<option "_$$Ss()_" value='"_I_"'> Манипуляция сессией</option>"_BK
    S I="Kill*" w "<option "_$$Ss()_" value='"_I_"'> Удаление узлов/таблиц</option>"_BK
    S I="Update*" w "<option "_$$Ss()_" value='"_I_"'> Повышение версии</option>"_BK
    q
 /*   .if I="B4Y" {w "<option value="""_I_""">",I," (Информационный портал)</option>",BK}
    .if I="CARDS" {w "<option value="""_I_""">",I,"  (Офицерская карточка)</option>",BK}
    .if I="ISS" {w "<option value="""_I_""">",I,"  (Информационно-справочная система)</option>",BK}
    .if I="KOMAN" {w "<option value="""_I_""">",I,"  (Командировки)</option>",BK}
    .if I="KVC" {w "<option value="""_I_""">",I,"  (Коды войсковых частей)</option>",BK}
    .if I="NAV" {w "<option value="""_I_""">",I,"  (Навигатор)</option>",BK}
    .if I="POTERY" {w "<option value="""_I_""">",I,"  (Потери)</option>",BK}
    .if I="VG" {w "<option value="""_I_""">",I,"   (Виртуальный главкомат)</option>",BK}
    .if (I'="ALLAPP")&(I'="B4Y")&(I'="CARDS")&(I'="ISS")&(I'="KOMAN")&(I'="KVC")&(I'="NAV")&(I'="POTERY")&(I'="VG") {w "<option value="""_I_""">",I,"   </option>",BK}
 q */              
Ss() I $G(Act1)="" Q ""
 I $E(I,1,2)="*S",$E(Act1,1,12)["Sess" G Sss
 I $E(I,1,2)="Er",I[$E(Act1,1,9) G Sss
 I $E(I,1,2)="Ch",$E(Act1,1,12)["Chang" G Sss
 I $E(I,1,2)="Te",$E(Act1,1,4)["Term" G Sss
 I $E(I,1,2)="Ki",$E(Act1,1,12)["Kill" G Sss
 I $E(I,1,2)="Up",$E(Act1,1,12)["Vers" G Sss
 Q ""
Sss Q "SELECTED"
on(BSLABEL,W,H) q " onclick='open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_$G(Targ,"calend")_""",""toolbar=no,menubar=no,scrollbars=no,width="_$G(W,640)_",height="_$G(H,480)_",status=1,resizable=1"");' "
B(d,N,Targ,ROU) ;кнопка В НОВОМ ОКНЕ
 I d="" S d=$ZD($h,8)
 N BSLABEL,BSDATE,Q S BSLABEL=$G(ROU,"CALDATE^~BSC4cal"),BSDATE=d,Q=""
 S Q=Q_"<BUTTON name='Calendar2' "_$$on(BSLABEL,300,350)_" ><IMG src='"_BSDOMAIN_"/img/cal.gif' alt='"_$G(N,""_$$LNG^%ZAPM.bs.BSC4("календарь",156)_"")_"'></BUTTON>"
 Q Q
2(m) i $l(m)=1 q "0"_m
 e  q ""_m
RETURN ;ВОЗВРАТ ПОСЛЕ КАЛЕНДАРЯ
 n a,z
 ;W "<PRE>" W  W "</PRE>"
 i $g(BSdateNum)=1 s z="OT"
 e  s z="DO"
 I $D(Today) S a=$E($ZD($H,3),1,4)_$E($ZD($H,3),6,7)_$E($ZD($H,3),9,10)
 E  s a=tbSelYear_$$2(tbSelMonth)_$$2(calSelectedDate)
 s @WAR@(CurUS,z)=a
 s ^a=a
 G HOMEPAGE
111      d mainvar
 N D S D=$$RETURN^%ZAPM.bs.BSC4cal
 S @WAR@(CurUS,"OT")=D
 D JS^%ZAPM.bs.BSCp
 S BSLABEL=$G(BS4,"HOMEPAGE")_"^~BSvdaSTAT" 
 I D'="" W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_$G(BS4,"HOMEPAGE")_""",""toolbar=yes,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1"");"_BK
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
222      d mainvar
 N D S D=$$RETURN^%ZAPM.bs.BSC4cal
 S @WAR@(CurUS,"DO")=D
 D JS^%ZAPM.bs.BSCp
 S BSLABEL=$G(BS4,"HOMEPAGE")_"^~BSvdaSTAT" 
 I D'="" W "open("""_$$ADDBSGET^%ZAPM.bs.BSC4()_""","""_$G(BS4,"HOMEPAGE")_""",""toolbar=yes,menubar=no,scrollbars=yes,width=800,height=600,status=1,resizable=1"");"_BK
 W "window.close();"_BK
 D JSE^%ZAPM.bs.BSCp
 Q
 
TEST1    //НОВЫЙ ОТЧЕТ
 d mainvar
 if $G(radioName)="chec0"  s (DAY1,DAY2)=$ZD($H) S DC1=$ZDATEH(DAY1),DC2=$ZDATEH(DAY2)
 if $G(radioName)="chec1"  s DAY2=$ZD($H),DC2=$ZDATEH(DAY2) s DC1=DC2-7,DAY1=$ZD(DC1)
 if $G(radioName)="chec2"  s DAY2=$ZD($H),DC2=$ZDATEH(DAY2) s DC1=DC2-30,DAY1=$ZD(DC1)
 if $G(radioName)="chec3"  s DAY2=$ZD($H),DC2=$ZDATEH(DAY2) s DAY1=$$DATEUSA($$BEGYEAR),DC1=$ZDATEH(DAY1)
 
 I '$D(DC1) S DC2=$ZDATEH($E(DAY2,5,6)_"/"_$E(DAY2,7,8)_"/"_$E(DAY2,1,4)),DC1=$ZDATEH($$DATEUSA(DAY1))
 
 S TITL="Пользователь '"_$g(BSnewPR)_"' с "_$ZD(DC1,2," Января Февраля Марта Апреля Мая Июня Июля Августа Сентября Октября Ноября Декабря")_" по "_$ZD(DC2,2," Января Февраля Марта Апреля Мая Июня Июля Августа Сентября Октября Ноября Декабря")_" года"
 D BEG1^%ZAPM.bs.BSC4  W $$TITL^%ZAPM.bs.BSCGIS(TITL),$$B27^%ZAPM.bs.BSCm4()
    W "<table border=0 WIDTH=100%><tr>"
    w "<td CLASS=S5 WIDTH=10%><p align=center><B>Дата</B></p></TD>"
    w "<td CLASS=S2 WIDTH=5%><b>Событий "_RED_BSapp_EF_"</b></td>"
    w "<td CLASS=S5><p align=center><b>ДИАГРАММА </b></p></td></tr>"
  S Max=0 f CD=DC2:-1:DC1 S Req=$$REQ(CD) I Req>Max S Max=Req
  f CD=DC2:-1:DC1 D WCDAY(CD)
    w "</table>"
 d END^%ZAPM.bs.BSC4
 Q
WCDAY(CD) //ВЫВЕСТИ ТЕКУЩИЙ ДЕНЬ
 N A,R S A=$S("67"[$$WEEKEND^%ZAPM.bs.BSsFUNR(0,CD):"S3",1:"S1")
    w "<TR><td CLASS="_A_"><p align=center><B>"_$ZD(CD,3)_"</B></p></TD>"
    S RR="",R=$$REQ(CD) I R S BSLABEL="CDAYB^~BSvdaSTAT",BSCDAY=CD S RR="<b><A HREF='"_$$ADDBSGET^%ZAPM.bs.BSC4()_"' target='Stat2'>"_$$REQ(CD)_"</A></b>"
    w "<td CLASS=S3>"_RR_"</td>"
    w "<td CLASS="_A_">"_$$DIAG()_"</td></tr>"
 Q
DATEUSA(DAY1) Q $E(DAY1,5,6)_"/"_$E(DAY1,7,8)_"/"_$E(DAY1,1,4)
REQ(H) S Req=0 I '$D(@BDS@(H)) Q Req
 S T="" F  S T=$O(@BDS@(H,T)) Q:T=""  S Req=Req+$$REQU(H,T)
 Q Req
REQU(H,T)        I $D(BSchkU),$g(BSnewPR)'="*",$G(@BDS@(H,T,"U"))'=$g(BSnewPR) Q 0
 I $D(BSchkI),$g(BSipF)'="*",$G(@BDS@(H,T,"S"))'[BSipF Q 0
 I $D(BSchkN),$g(BSipFN)'="*",$G(@BDS@(H,T,"S"))'[BSipFN Q 0
 I '$D(BSapp) Q 1
 I BSapp="*" Q 1
 I $E(BSapp,1,2)="*S",$E($G(@BDS@(H,T,"A")),1,12)["Sess" Q 1
 I $G(@BDS@(H,T,"A"))="" Q 0
 I ("@"_$G(@BDS@(H,T,"A")))'[("@"_$P(BSapp,"*")) Q 0
REQ1 Q 1
 
DIAG() N D s nachRED=$ZHEX("11"),nachGREEN=$ZHEX("ee"),D="",step=3 //???????
 I Req>100 S Req=100
 f a=1:1:Req d
  .S D=D_"<font style=background:#"_$ZHEX(nachRED)_$ZHEX(nachGREEN)_"00>&nbsp</font>"
  .s nachRED=(nachRED+step)
  .s nachGREEN=(nachGREEN-step)    
 Q D
 
PROK //ПРОКАЧКА
  D mainvar
  S II="" F  S II=$O(@BDS@(II)) Q:II=""  S I="" F  S I=$O(@BDS@(II,I)) Q:I=""  D
  .I I'[":" M @BDS@(II,$ZT($P(I,".."),1)_".."_$P(I,"..",2))=@BDS@(II,I) K @BDS@(II,I) W "."
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzZ" type="MAC" languagemode="0"><![CDATA[
%BSzZ ;Пакетные запросы  (А.Тимофеев) ; 14:56   20.04.2000
 G LOAD1
LOAD(%1,%2) ;Выполнение с параметрами (%1- имя списка, %2'="" - выполнение без загрузки запросов на ключи !)
LOAD1 N i,i1,i2,i3,i4,i5,C1,STOP,unL,NaMePack,NaMPack,ListPack ;Загрузка условий
 S %zT=$ZT,$ZT="ERROR",PACET=1
 I $G(%1)'="" S i=%1,STOP="" S:$G(%2)'="" unL=1 G 0
 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(Sz1)","1#2#2",2)
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4),tabYES=0
 I tab=27 Q
0 I $E($P(i,"~"))="S" D PPACK($P(i,"~")) Q
00 S (NaMePack,na)=$P(i,"~") I na="" D ErrMsg^%ZAPM.bs.BSXfun("НЕ ВЫБРАН ЗАПРОС !!") S $ZT=%zT Q
 S usl=$E(na,1)
 N sraV
 ;выходные переменные: C,G1(C),G2(C),nf,na,uslL,Per,tabYES
 D BUFF(usl)
 K @mas5
1 ;Загрузка общих условий
 I '$D(@mas0@(na,"4,4")) D ErrMsg^%ZAPM.bs.BSXfun("НЕ УКАЗАНЫ АНАЛИТИЧЕСКИЕ ФОРМЫ !!") S $ZT=%zT Q
 I '$D(^("6,4")) D ErrMsg^%ZAPM.bs.BSXfun("НЕ УКАЗАН ЗАПРОС !!") S $ZT=%zT Q
 S zp=$G(^("6,4")),na1=$G(^("4,4")),bok=$G(^("8,4")),start=$G(^("10,4"))
 S sraV=$G(^("SraV"))
 I '$D(@mas1@(zp)) D ErrMsg^%ZAPM.bs.BSXfun("ЗАПРОСА "_zp_" НЕТ") S $ZT=%zT Q
 K @mas3 S @mas3="Буфер насчета"
 
2 ;Загрузка запросов в буфер
 S @mas3@("zp")="Условия на ключи БД"
 F i1=0:1:11 S i2="k"_i1,i3=i1+2 D
 .F i4=2:1:7 S i5=i3_","_i4 I $G(@mas1@(zp,"O",i5))'="" S @mas3@("zp",i2,i4)=$G(@mas1@(zp,"O",i5))
 S i1="",Per="" F  S i1=$O(@mas3@("zp",i1)) Q:i1=""  D
 .I $G(@mas3@("zp",i1,2))="Y" S Per="Y" Q
 G:$G(unL)=1 41    ;Без загрузки запросов (!!!)
 K C,G1,G2
 
3 ;Загрузка периодов сравнения
 S STOP="" I Per="" G 4
 I $D(PackP),$D(@PackP@(1)),$$PACKREST(PackP) G 4 ;ГЛОБАЛЬНОЕ СРАВНЕНИЕ
 I $G(sraV)'="",$$SRAV(sraV) G 4 ;ЛОКАЛЬНОЕ СРАВНЕНИЕ
 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVz0)","4#1#20",2)
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 S C=$P(i,"~",2) I C="" D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ЗАПРОСА !!") S $ZT=%zT Q
 F C1=1:1:C S G1(C1)=$P(i,"~",(2*C1+1)),G2(C1)=$P(i,"~",(2*C1+2))
 I G1(C)=""!(G2(C)="") K G1,G2
 I $D(PackP),'$D(@PackP@(1)) D PACKSAVE ;```MSW
4 ;Загрузка запросов на ключи
 S (i,STOP)="" F  S i=$O(@mas3@("zp",i)) Q:i=""  S i1=$E(i,2,3) D  G:STOP=1 3
 .I $G(@mas3@("zp",i,3))="Y" I $D(@mas1@(zp,i1)) D 5
41 I STOP'=1 D @usl Q
 I STOP=1 G 3
 S $ZT=%zT Q
 
5 ;Загрузка стандартного запроса на ключ
 N adr,tab,ind,ind1
 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVz3)",2,1,"","6^%ZAPM.bs.BSzvU") Q:A=""
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S STOP=1 Q
 I $P(adr,",")>3 S ind=$P(adr,","),ind1=$P(adr,",",2) I $D(@mas5@(ind,ind1)) D  Q
 .S @mas3@("zp",i,1)=$G(@mas5@(ind,1))
 .S @mas3@("zp",i,6)=$G(@mas5@(ind,2))
 S @mas3@("zp",i,4)=$G(@mas5@(3,1))
 S @mas3@("zp",i,5)=$G(@mas5@(3,2))
 I $E(i,2,3)<10 S @mas3@("zp",i,6)=i_"'<"_$G(@mas5@(3,1))_","_i_"'>"_$G(@mas5@(3,2))
 Q
 
a ;На сводки
 S bok1=0 I bok'="" S bok1=1 D 7
 X "F na="_na1_" D a1^%ZAPM.bs.BSzZ Q:STOP=1 "
 Q:STOP=1  I $D(PackPa) Q
 D ADDHIS,SAY(NaMePack) ;^%ZAPM.bs.BSzZ1
 Q
a1 ; По одной сводке
 S mas=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVm2"))),mas1=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVz1"))),mas2=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVb1")))
 S nf=$E(na,1,3)
 I '$D(@mas@(nf,na))!('$D(@mas@(nf,na,0))) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЙ НА ФОРМУ !! "_$NA(@mas@(nf,na))) S $ZT=%zT Q
 S ls="Сводка !!"_na D WAITS^%ZAPM.bs.BSF2
 I bok1=0 D 8^%ZAPM.bs.BSzZ ;БОКОВИНА
 D 9^%ZAPM.bs.BSzvU,SETHIST
 Q
SAY(NaMePack) D OK^%ZAPM.bs.BSF("ПАКЕТ '"_NaMePack_"' НАСЧИТАН")
 Q
NamePack() ;ИМЯ ПАКЕТА
 N I S I=""
 I $D(NaMPack) S I=NaMPack_"-"
 I $D(NaMePack) S I=I_NaMePack_"-"
 Q I
ADDHIS ;В ИСТОРИЮ НАСЧЕТОВ
 N I S I=$G(ListPack)
 I ($L($G(ListPack))+25)>($$LNG^%ZAPM.bs.BSF12-1) S I="ПАКЕТ '"_$G(NaMPack,$G(NaMePack))_"' ПРЕВЫШАЕТ ДОПУСТИМУЮ ДЛИНУ !"
 D AddHist^%ZAPM.bs.BSzmOL("PackO",I)
 Q
SETHIST ;ПРИСВОИТЬ
 N li
 S li=$$SETHI(BSl) S ListPack=$G(ListPack)_li_"~"
 Q
SETHI(li) ;ССЫЛКА
 N BSr,BSt,BSu,BSs D TIR^%ZAPM.bs.BST4 I $E($P(li,",",2))="^" S $P(li,",",2)=$E($P(li,",",2),2,999)
 Q li
b ;На списки
 X "F na="_na1_" D b1^%ZAPM.bs.BSzZ Q:STOP=1 "
 Q:STOP=1  D Z^%ZAPM.bs.BSzZ1 I $D(PackPa) Q
 D ADDHIS,SAY(NaMePack)
 Q
b1 ;По одному списку
 S mas=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SLm1"))),mas1=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVz1")))
 S nf=$P(na,"#"),BSzap=$G(BSl)
 I '$D(@mas@(nf,na))!('$D(@mas@(nf,0))) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЙ НА ФОРМУ !! "_$NA(@mas@(nf,na))) S $ZT=%zT Q
b2 S ls="Список !!"_na D WAITS^%ZAPM.bs.BSF2 D
 .;Копирование данных из БД по запросу на сортировку
 .S (srt(1),srt(2),srt(3))=0 I $G(@mas@(nf,na,"17,4"))'="" I $$NOCHANGE^%ZAPM.bs.BSzmOL($G(@mas@(nf,na,"17,4"))) Q
 .S srt(1)=$P($G(@mas@(nf,na,"17,4")),"!"),srt(2)=$P($G(^("17,4")),"!",2),srt(3)=$P($G(^("17,4")),"!",3)
 .F I=1:1:3 I $G(srt(I))="" S srt(I)=0
 D 7^%ZAPM.bs.BSzlU D:$G(BSl)'=BSzap SETHIST
 Q
 
7 ;Запрос на боковину
 K @mas5 S uslL=$G(@mas2@(bok,0,"2,4"))
 I start="" G 71
 S ls="Используем стандартную боковину?",%B=2 D YES^%ZAPM.bs.BSF I YES'=1 D
 .X "D "_start
71 S ls="Уточняем боковину?" D YES^%ZAPM.bs.BSF I YES=1 D ^%ZAPM.bs.BSzvUB
 S ls="Понеслись !!" D WAITS^%ZAPM.bs.BSF2 D B^%ZAPM.bs.BSzvUB
 Q
8 ;Сброс боковины (если не указана в запросе)
 S bok=$G(@mas@(nf,na,0,"18,4")),uslL=$G(@mas2@(bok,0,"2,4"))
 S ls="Понеслись !!" D WAITS^%ZAPM.bs.BSF2 D B^%ZAPM.bs.BSzvUB
 Q
BUFF(usl) ;ПРИСВОЕНИЕ ССЫЛОК БАЗ И БУФЕРОВ
 S mas0=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("Sz2"))),mas=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVm2"))),mas1=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVz1"))),mas2=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVb1")))
 S mas3=$S(usl="a":"^%ZAPM.bs.BSbufB(""PO""_$G(%BS(3),$P)_$J_""u"")",usl="b":"^%ZAPM.bs.BSbufB(""PO""_$G(%BS(3),$P)_$J_""ul"")",1:"^%ZAPM.bs.BSbufB(""PO""_$G(%BS(3),$P)_$J_""uPackP"")")
 S mas4="^%ZAPM.bs.BSbufB(""fTS""_$G(%BS(3),$P)_$J_""u"")",mas5="^%ZAPM.bs.BSbufB(""W""_$G(%BS(3),$P)_$J_""u"")"     ;Буфера
 Q
ERROR ;
 I $ZE["<NOSYS"!($ZE["<NAMESPACE") D ErrMsg^%ZAPM.bs.BSXfun("НЕ ДОСТУПНА БАЗА ДАННЫХ !!") S $ZT=%zT Q
 D ErrMsg^%ZAPM.bs.BSXfun("Ошибка ! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
 Q
SRAV(S) ;СРАВНЕНИЕ ВЫТАЩИТЬ ИЗ ЗАПРОСА
 N BD,I,II
 K G1,G2,C S BD=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("ZP")))
 F I=1:1 Q:'$D(@BD@(S,I))  D
 .I $D(@BD@(S,I,1)) S G1(I)=$G(@BD@(S,I,1)),G2(I)=$G(@BD@(S,I,2))
 Q:'$D(G1) 0 S C=I-1
 Q C
PPACK(na) ;ПАКЕТ ПАКЕТОВ
 N i,PackPa,PackP,C,G1,G2,SraV,ZapK,vdl,srt
 S NaMPack=na
 D BUFF("S") I '$D(@mas0@(na,"4,4")) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ ПАКЕТОВ "_na) S $ZT=%zT Q
 S SraV=$G(@mas0@(na,"SraV")),ZapK=$G(@mas0@(na,"6,4"))
 S PackPa=$G(@mas0@(na,"4,4")),PackP=mas3 K @PackP I SraV'="",$$SRAV(SraV) D Copy^%ZAPM.bs.BSF8("G1",$NA(@PackP@(1))),Copy^%ZAPM.bs.BSF8("G2",$NA(@PackP@(2))) S @PackP=C
 I ZapK'="" S @PackP@("Z")=ZapK
 X "F i="_PackPa_" D 00^%ZAPM.bs.BSzZ"
 K @PackP D ADDHIS,SAY(NaMPack) ;^%ZAPM.bs.BSzZ1
 Q
PACKSAVE ;СОХРАНИТЬ ПЕРИОДЫ
 Q:'$D(C)!('$D(G1))!('$D(G2))  S @PackP=C D Copy^%ZAPM.bs.BSF8("G1",$NA(@PackP@(1)))
 D Copy^%ZAPM.bs.BSF8("G2",$NA(@PackP@(2)))
 Q
PACKREST(P) ;ВОССТАНОВИТЬ ПЕРИОДЫ
 Q:'$D(@P) 0 S C=@P D Copy^%ZAPM.bs.BSF8($NA(@P@(1)),"G1"),Copy^%ZAPM.bs.BSF8($NA(@P@(2)),"G2")
 Q 1
STOP ;
 S $ZT=%zT D ErrMsg^%ZAPM.bs.BSXfun("Некорректно сформулированы условия !!!") Q
 ;D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ЗАПРОСА !!") S $ZT=%zT
 Q
TESTsv ;ТЕСТИРОВАНИЕ ПАКЕТА СВОДОК
 S G1(1)="980101",G2(1)="980520"
 S G1(2)="990101",G2(2)="990520"
 S C=3 D LOAD^%ZAPM.bs.BSzZ("a7",1)
 Q
TESTsp ;ТЕСТИРОВАНИЕ ПАКЕТА СПИСКОВ
 S G1(1)="980101",G2(1)="980520"
 S G1(2)="990101",G2(2)="990520"
 S C=2 D LOAD^%ZAPM.bs.BSzZ("b7",1)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzZ1" type="MAC" languagemode="0"><![CDATA[
%BSzZ1 ;Пакетный вывод на устройство  (А.Тимофеев) ; 20:26   03.07.99
 N pacetF,pacetG,pacetU,pacetD,pacetO,Tbsr,Tbst,tab,i,A,tab1
 S pacetF=1,%zT=$ZT,$ZT="ERROR" N i
 F  D 1 Q:$G(tab)=27
 Q
1 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(Sz4)",2,2,"#","PRESET^%ZAPM.bs.BSzZ1") Q:A=""
 S tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 S tab=$P(A,"#"),pacetG=$P(A,"#",2),pacetU=$P(A,"#",3),pacetD=$P(A,"#",4),pacetO=1
 I tab="" D ErrMsg^%ZAPM.bs.BSXfun("Не выбраны таблицы !!") S $ZT=%zT Q
 I tab["ПАКЕТ '" D ErrMsg^%ZAPM.bs.BSXfun(tab) S $ZT=%zT Q
 I pacetU=""  D ErrMsg^%ZAPM.bs.BSXfun("Не определено устройство вывода !!") S $ZT=%zT Q
 I 'pacetD S pacetD=""
 F i=1:1 S tab1=$P(tab,"~",i) Q:tab1=""  D
 .S Tbsr=$S($P(tab1,",",3)'="":"["""_$P(tab1,",",3)_""","""_$P(tab1,",",4)_"""]",1:"")_$P(tab1,",",2)
 .S Tbst=$P(tab1,",") I $E(Tbsr)'="^" S Tbsr="^"_Tbsr
 .D Kout^%ZAPM.bs.BSout0(pacetU,Tbsr,Tbst) I $P($G(bok),"~",3)="" K in
 D:$G(pacetD)="" OkMsg^%ZAPM.bs.BSXfun("Вывод ВСЕГО ПАКЕТА завершен !",6)
 S $ZT=%zT
 Q
PRESET ;ПРЕДВАРИТЕЛЬНОЕ ПРИСВОЕНИЕ
 N %HIS D HIS^%ZAPM.bs.BSF1("PackO")
 I ($L(@BSR@(BST,2,4))+$L($TR($G(@%HIS@(1)),"@","")))>($$LNG^%ZAPM.bs.BSF12-1) D ErrMsg^%ZAPM.bs.BSXfun("ПЕРЕЧЕНЬ ТАБЛИЦ НАСЧИТАННОГО ПОСЛЕДНЕГО ПАКЕТА ПРЕВЫШАЕТ ДОПУСТИМУЮ ДЛИНУ !") Q
 S $P(@BSR@(BST,2,4),"@",15)=$TR($G(@%HIS@(1)),"@","")
 S $P(^%ZAPM.bs.BSZ("Sz5",2,1),"@",15)=$P(@BSR@(BST,2,4),"@",15)
 Q
ERROR D ErrMsg^%ZAPM.bs.BSXfun("ГЛЯ - !!"_$ZE)
Q S $ZT=%zT Q
 ;D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ЗАПРОСА !!") S $ZT=%zT Q
 
Z ;Таблица с заголовком для пакета списков
 S %zT=$ZT,$ZT="ERROR"
 G:bok=""!(bok'["~") Q
 N nameTP,nameP,nameFP S nameTP=$P(bok,"~"),nameP=$P(bok,"~",2),nameFP=$P(bok,"~",3)
 G:nameTP=""!(nameP="") Q
 S nameTP=$$NamePack^%ZAPM.bs.BSzZ()_nameTP
 I tabYES=0 K ^%ZAPM.bs.BSbufS(nameTP) G Q
 S nameP=$$Data^%ZAPM.bs.BSsFUNS_" "_nameP
 S BSr1="^%ZAPM.bs.BSZ",BSt1="Sz6",BSr2="^%ZAPM.bs.BSbufS",BSt2=nameTP D COPY^%ZAPM.bs.BSTK
 S $P(^%ZAPM.bs.BSbufS(nameTP,1,1),"@",15)=nameP,$P(^%ZAPM.bs.BSbufS(nameTP,"HFS"),"#")=nameFP
 S ListPack=nameTP_",%BSbufS~"_(ListPack)
 ;S $P(^%ZAPM.bs.BSZ("Sz5",2,1),"@",15)=nameTP_",%BSbufS~"_$P(^%ZAPM.bs.BSZ("Sz5",2,1),"@",15)
 ;S $P(^%ZAPM.bs.BSZ("Sz4",2,4),"@",15)=nameTP_",%BSbufS~"_$P(^%ZAPM.bs.BSZ("Sz4",2,4),"@",15)
 G Q
SINX ;ПРОГРАММА РАБОТЫ С ПАНЕЛЬЮ ПАКЕТА ВЫВОДА
 I d'=2 S $P(@BSR@(BST,8,4),"@",5)=1 Q
 S $P(@BSR@(BST,8,4),"@",5)=""
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzZ2" type="MAC" languagemode="0"><![CDATA[
%BSzZ2 ;Доплнительный сервис (А.Тимофеев) ; 13:45   30.11.1999
 ;Загрузка условий
 K ^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u")
 ;mas- БД условий, mas3 - буфер (^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u"))
 N i,i1,i2,i3,i4,i5,c,c1,uslk,uslO,uslL,uslK,uslF,STOP
 S mas=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVm2"))),mas3="^%ZAPM.bs.BSbufB(""PO""_$G(%BS(3),$P)_$J_""u"")",mas4="^%ZAPM.bs.BSbufB(""fTS""_$G(%BS(3),$P)_$J_""u"")",mas5="^%ZAPM.bs.BSZ(""SzZ"")"     ;Буфера
 S %zT=$ZT,$ZT="ERROR" S @mas3="Буфер условий на сводку"
 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVa1)","1#2#2",2)
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 
1 ;Загрузка общих условий
 S na=$P(i,"~") I na="" D ErrMsg^%ZAPM.bs.BSXfun("НЕ ВЫБРАНА АНАЛИТИЧЕСКАЯ ФОРМА !!") S $ZT=%zT Q
 S nf=$E(na,1,3)
 I '$D(@mas@(nf,na))!('$D(@mas@(nf,na,0))) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЙ НА ФОРМУ !! "_$NA(@mas@(nf,na))) S $ZT=%zT Q
 S zp=$G(@mas@(nf,na,"0","5,4")) I zp="" D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЯ НА ЗАПРОС !!") S $ZT=%zT Q
 S ls="Понеслись !!" D WAITS^%ZAPM.bs.BSF2
 K @mas5 S @mas5="Условия на колонки сводки@@@@@@@1@1@22@80@@@@1@@5@@@1@@@ 1@@@@@4@@@1;6;36;44//1;6;36;40@@@@@@@1"
 
2 ;Сброс условий в буфер
 S i1=0 F  S i1=$O(@mas@(nf,na,i1)) Q:i1=""  D
 .S i2=0,(uslO,uslL)="" F  S i2=$O(@mas@(nf,na,i1,i2)) Q:i2=""  D  X $G(WA)
 ..I i2["A" S uslO=uslO_$S($G(@mas@(nf,na,i1,i2,"2,4"))'="":"I "_$G(@mas@(nf,na,i1,i2,"2,4")),1:"")_" "
 ..I i2["B" S uslL=uslL_$S($G(@mas@(nf,na,i1,i2,"2,4"))'="":"I "_$G(@mas@(nf,na,i1,i2,"2,4")),1:"")_" "
 ..I i2["C"!(i2["D") D
 ...S c=$G(@mas@(nf,na,i1,i2,"4,4")) X "F c1="_c_" S @mas3@(""O"",i1,""K""_c1)=$S($G(@mas@(nf,na,i1,i2,""2,4""))'="""":""I ""_^(""2,4"")_"" "",1:"""")"
 ..I i2["K" D
 ...S i3=$G(@mas@(nf,na,i1,i2,"4,4")),uslK=$G(^("8,4")),uslk=$G(^("2,4")),uslF=$G(^("10,4"))
 ...S @mas3@(i3,i2)=" *"_i1_"* "_$S(uslK=1:uslO,1:uslL)_$G(@mas3@("O",i1,i2))_$S(uslk'="":"I "_uslk_" ",1:"")_"S D("_i3_")="_$S(uslF'="":uslF,1:1)
 ..I i2["k" Q
 
3 ;Текст
 S i1="",i3=1 F  S i1=$O(@mas3@(i1)) Q:i1=""  Q:i1="O"  D
 .S i2="" F  S i2=$O(@mas3@(i1,i2)) Q:i2=""  D
 ..S @mas5@(i3)=i1_$G(@mas3@(i1,i2)),i3=i3+1
 D ^%ZAPM.bs.BSX("TEXT","^%ZAPM.bs.BSZ","SzZ","")
 Q
P(O) ;ТРАНСЛАЦИЯ P -> ^
 I O=2 I d["P(" D Yes^%ZAPM.bs.BSXfun("В ФОРМУЛАХ НА ЛИЧНУЮ ЧАСТЬ P(...) СТАВИТЬ НЕЛЬЗЯ !") S YES=0 X "I 0" Q
 I O=1 I d["P(" D Yes^%ZAPM.bs.BSXfun("ПРОИЗВЕСТИ ТРАНСЛЯЦИЮ P(...) В ^(...) .ВЫ УВЕРЕНЫ ?") I YES D  S YES=1 I 1 Q
 .S d=$$TR^%ZAPM.bs.BSsFUNM(d,"P(","^(")
 S YES=1 I 1 Q
SYN(%1,%2) ;Синтаксический контроль
 N G1,G2,C,k1,k0,k2,k3,k4,k5,k6,k7,k8,k9
 S (G1,G2,C,k1,k0,k2,k3,k4,k5,k6,k7,k8,k9)=1,(G1(1),G2(1))=1
 S %0="" I %1=""!(%2="") Q %1
 N %zT,str S %zT=$ZT,$ZT="SYNER^%ZAPM.bs.BSzZ2"
 I %1["$G(^(" D ErrMsg^%ZAPM.bs.BSXfun("Нельзя использовать $G(^(  !!") S $ZT=%zT,%0="" Q %0
 S str=$S(%2="I":"I "_%1,1:%2_" LOCAL="_%1)
 X str
 S $ZT=%zT Q %1
SYNER ;
 I $ZE["UNDEF" S $ZT=%zT Q %1
 I $ZE["SYNT" D ErrMsg^%ZAPM.bs.BSXfun("Найдена синтаксическая ошибка !!") S $ZT=%zT,%0="" Q %0
 Q %1
]]></Routine>


<Routine name="%ZAPM.bs.BSzlR" type="MAC" languagemode="0"><![CDATA[
%BSzlR ;Создание пpогpаммы насчета списка  (А.Тимофеев) ; 18:13   15.04.2003
 ;Входящие переменные: C,G1(C),G2(C),nf,na,mas,mas3,srt(n)
 N Tmp,i,i1,i2,i3,mas1,mas2,k,k0,kk,nk,str,str1,str2,str3,str4,strE,keyO,keyS,kol,Po,ind,sN,pg,pg1,pg2
 S %zT=$ZT,$ZT="ERROR^%ZAPM.bs.BSzlU" S:$G(srt(1))="" srt(1)=0 S:$G(srt(2))="" srt(2)=0 S:$G(srt(3))="" srt(3)=0
 S ls="Погнали..." D WAITS^%ZAPM.bs.BSF2
 S rout=$$rout^%ZAPM.bs.BSzvR("RepL")
 S @mas3@("r",0)=rout_" ;Программа насчета списка N "_na_" *TAF*",ind=1
 S @mas3@("r",ind)=" S %zT=$ZT,$ZT=""ERROR^%ZAPM.bs.BSzlU"" "_$S($ZV'["Cach"&&($ZV'["IRIS"):"",1:"ZN ""GLAVK"" "),ind=ind+1 ZN "GLAVK"
 
 S (str,str1)=" ;" I Per="Y" S str=" S " F C1=1:1:C D
 .S str=str_"G1("_C1_")="_G1(C1)_",G2("_C1_")="_G2(C1)_","
 .S str1=str1_"С "_G1(C1)_" ПО "_G2(C1)_","
 S @mas3@("r",ind)=str1,ind=ind+1,@mas3@("r",ind)=$E(str,1,($L(str)-1)),ind=ind+1
 
 ;Общие условия на программу
 S Tmp=$NA(^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"ul")) ;```MSW
 S @mas3@("r",ind)=" S mas0=$NA("_Tmp_"),mas1=$P(mas0,"")"")_"",""""n"""")"" K @mas1" S ind=ind+1
 S @mas3@("r",ind)=" N BSD,masR,k1,k2,k3,k4,k5,k6,k7,k8,k9,i,j,P,Po,D,sN,Str,V,cHOSe,Y,Y1,pg,pg1,pg2" S ind=ind+1
 
 ;Условия
 K mtb,tabO,tabL,keyO,keyS,kol,Po
 S mtb=$G(@mas@(nf,0,"2,4")),tabO=$G(^("5,4")),keyS=$G(^("10,4")),kolO=$G(@mas3@("bk",0,1))
 S tabL=$G(@mas@(nf,0,"7,4")),keyO=$G(^("8,4")),kolL=$G(@mas3@("bk",0,2)) S:tabL="" tabL=tabO
 ;Дополнительные условия
 S pg=$S($G(@mas@(nf,na,"22,4"))="Y":1,1:0) I pg=1 S pg1=$P($G(^("23,4")),"~"),pg2=$P($G(^("23,4")),"~",2),pg2=(pg2-1)*pg1
 S:$G(@mas@(nf,na,"25,5"))'="" tabO=$G(^("25,5")),tabL=tabO S:$G(^("26,5"))'="" tabL=$G(^("26,5")),mtb="Y" S:$G(^("27,4"))'="" keyO=$G(^("27,4")),keyS=$G(^("28,4"))
 
 S masBD=$$KBD^%ZAPM.bs.BSF12($NA(@tabO))
 S Gref="" I $ZV'["Cach"&&($ZV'["IRIS") S Gref="["""_$P($P(masBD,"[",2),",")_""","""_$P($P(masBD,",",2),"]")_"""]"
 
 S k0=$S($G(@mas@(nf,"k0","11,4"))'="":^("11,4"),$G(@mas3@("zp","k0",7))'="":^(7),1:"")
 I k0'="" S:k0'["=" k0="$$YY^%ZAPM.bs.BSsFUNR(G2(C))" S:k0["=" k0=$P(k0,"=",2) ;`Y2000
 D
 .I Per="" S @mas3@("r",ind)=" S (N,NN)=1 S mas=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0'="":"_",1:"")_k0_" I $D(@mas) D Wait^%ZAPM.bs.BSXfun(na_"" ""_mas) D B" S ind=ind+1 Q
 .S @mas3@("r",ind)=" S (N,NN)=1 F C=1:1:"_C_" S mas=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0'="":"_",1:"")_k0_" I $D(@mas) D Wait^%ZAPM.bs.BSXfun(na_"" ""_mas) D B" S ind=ind+1
 S @mas3@("r",ind)=" G Q",ind=ind+1
 D KEYS   ;На блок условий по ключам БД
 S @mas3@("r",ind)=" Q",ind=ind+1
 S @mas3@("r",ind)="C S masR=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0'="":"_"_k0_"_",1:"_")_""""_$$KEYL^%ZAPM.bs.BSzlR1(keyS)_""" D  ",ind=ind+1
 ;По общей части
 S @mas3@("r",ind)=" .S BSD=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0'="":"_"_k0,1:""),ind=ind+1
 S @mas3@("r",ind)=" .S NNN=1 F j="_$E(kolO,1,$L(kolO)-1)_" S D(j)=0",ind=ind+1
 S @mas3@("r",ind)=" .S Y=0 "_$S($D(@mas3@("zp","k10",6)):"I "_$$PO^%ZAPM.bs.BSzlR1(1,^(6)),1:"")_"  "_$S($D(@mas@(nf,na,"14,4")):"I "_$$PO^%ZAPM.bs.BSzlR1(1,^("14,4")),1:"")_" D  I Y=1 S N=N+1",ind=ind+1
 S i2=1 X "F i="_$E(kolO,1,($L(kolO)-1))_" D KOL"
 S i2=1 X "F i=1,2,3 D SRT"
 I mtb'="Y",pg'=1 D
 .S @mas3@("r",ind)=" ..F j="_$E(kolO,1,$L(kolO)-1)_" S @mas1@(srt(1),srt(2),srt(3),N,NN,j)=$G(D(j))",ind=ind+1
 .S @mas3@("r",ind)=" ..S NN=NN+1,Y=1,NNN=2",ind=ind+1
 I mtb="Y"!(pg=1) D            ;По личной части
 .S @mas3@("r",ind)=" ..S NNNN=1 ;По Л.Ч.",ind=ind+1
 .;S @mas3@("r",ind)=" .."_$G(strE),ind=ind+1
 .I pg'=1 D
 ..S @mas3@("r",ind)=" .."_$G(strE),ind=ind+1
 ..S @mas3@("r",ind)=" ...S masR=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0'="":"_"_k0_"_",1:"_")_""""_$$KEYL^%ZAPM.bs.BSzlR1(keyS)_""" D  ",ind=ind+1
 ..S @mas3@("r",ind)=" ....F j="_$E(kolL,1,$L(kolL)-1)_" S D(j)=0",ind=ind+1
 ..S @mas3@("r",ind)=" ...."_$S($D(@mas3@("zp","k11",6)):"I "_$$PO^%ZAPM.bs.BSzlR1(2,^(6)),1:"")_"  "_$S($D(@mas@(nf,na,"15,4")):"I "_$$PO^%ZAPM.bs.BSzlR1(2,^("15,4")),1:"")_" D  ",ind=ind+1
 .I pg=1 D
 ..;S @mas3@("r",ind)=" ....S Y1=0 F pg=0:"_pg1_":"_pg2_" "_$S($D(@mas3@("zp","k11",6)):"I "_$$PO^%ZAPM.bs.BSzlR1(2,^(6)),1:"")_"  "_$S($D(@mas@(nf,na,"15,4")):"I "_$$PO^%ZAPM.bs.BSzlR1(2,^("15,4")),1:"")_" D  ",ind=ind+1
 ..S @mas3@("r",ind)=" ..S Y1=0 F pg=0:"_pg1_":"_pg2_" "_$S($D(@mas@(nf,na,"15,4")):"I "_$$PO^%ZAPM.bs.BSzlR1(2,^("15,4")),1:"")_" D  ",ind=ind+1
 ..S @mas3@("r",ind)=" ...D  ",ind=ind+1
 ..S @mas3@("r",ind)=" ....D  ",ind=ind+1
 .S i2=2 X "F i="_$E(kolL,1,$L(kolL)-1)_" D KOL"
 .S kolI=kolO_kolL,kolI=$E(kolI,1,($L(kolI)-1))
 .S @mas3@("r",ind)=" .....D:NNN=1 ",ind=ind+1
 .S @mas3@("r",ind)=" ......F j="_$E(kolO,1,$L(kolO)-1)_" S @mas1@(srt(1),srt(2),srt(3),N,NN,j)=$G(D(j))",ind=ind+1
 .S @mas3@("r",ind)=" .....F j="_$E(kolL,1,$L(kolL)-1)_" S @mas1@(srt(1),srt(2),srt(3),N,NN,j)=$G(D(j))",ind=ind+1
 .S @mas3@("r",ind)=" .....S NN=NN+1,Y=1,NNN=2,NNNN=NNNN+1",ind=ind+1
 
 ;Конец
 S @mas3@("r",ind)=" Q",ind=ind+1
 S @mas3@("r",ind)="Q ;Конец по форме",ind=ind+1
 ;Конец 1
 S @mas3@("r",ind)=" G ^%ZAPM.bs.BSzlT",ind=ind+1
 S @mas3@("r",ind)="STR ;Наполнение строк таблицы",ind=ind+1
 
 ;Запись и загрузка программы насчета
 X "ZR  ZS "_rout
 X "ZR  S i="""" F  S i=$O(@mas3@(""r"",i)) ZS:i="""" @rout Q:i=""""  ZI $G(^(i)):+(i) S i1=i+1 "
 S Total=$P($$h^%ZAPM.bs.BS3,",",2) G ^@rout
 Q  ;```   ^SLr12 ... G ^%ZAPM.bs.BSzlT
 
KOL ;Данные по колонке
 X $G(WA)
 S i1=$P($G(@mas3@("bk",i2,i)),"#") I i1=""!(i1="""") D KOL5($P($G(@mas3@("bk",i2,i)),"#",3)) Q
 D
 .I i1["^(" Q
 .I $E(i1,1)'="k"&(i1'[",k")&(i1'["(k")&(i1'["_k")&(i1'="N")&(i1'="NN")&(i1'="NNNN") S i1="^("_i1_")" Q
 S i1=$$PO^%ZAPM.bs.BSzlR1(i2,i1)
 S @mas3@("r",ind)=" "_$S(i2=1:"..",1:".....")_"S D("_i_")="_$S(i1="N"!(i1="NN"):""""_i1_"@"_""""_"_",1:"")_i1,ind=ind+1
 Q
KOL5(i1) ;ФУНКЦИЯ ИЛИ ВЫРАЖЕНЕ ПО 5 ПОЛЮ ~
 I i1["|" S i1=$TR(i1,"|","@")
 S @mas3@("r",ind)=" "_$S(i2=1:"..",1:".....")_"S D("_i_")="_i1,ind=ind+1
 Q
 
SRT ;Данные по сортировке
 X $G(WA) S i1=srt(i)
 I i1'=0 I i1["^(" S i1=$$PO^%ZAPM.bs.BSzlR1(i2,i1) ;!!!```MSW ---------------------
 S @mas3@("r",ind)=" "_$S(i2=1:"..",1:".....")_"S srt("_i_")="_$TR(i1,"|","@")_" S:srt("_i_")="""" srt("_i_")=0",ind=ind+1
 Q
 
KEYS ;Перебор ключей с условиями
 K str,str1,str2,str3,strE,str4,kk,k
 I keyS'<1 D  Q:keyS=1
 .S str="B S k1="""" F  S k1=$O(@mas@(k1)"_$$KEY^%ZAPM.bs.BSzlR1("k1")_"  X $G(WA)"
 .S @mas3@("r",ind)=str,ind=ind+1 Q
 S str1=" ",kk="=$O(@mas@(k1" F k=2:1:keyS D
 .S str1=str1_".",kk=kk_",k"_k
 .S str2="S k"_k_"="""""_$S($G(@mas@(nf,"k"_k,"11,4"))'="":" ",$G(@mas3@("zp","k"_k,7))'="":" ",1:" F  S k"_k_kk_")")
 .S:mtb="Y"&(k=keyS) str3="S k"_k_"="_keyO     ;По О.Ч. документа
 .S str4=$$KEY^%ZAPM.bs.BSzlR1("k"_k)
 .S str=str1_$S($G(str3)'="":str3,1:str2)_$S($G(str3)'="":$E(str4,2,450),1:str4)
 .S strE=str2_str4,strE=$P(strE,"D C")_" I k"_k_"'="_keyO_" D  "
 .S @mas3@("r",ind)=str,ind=ind+1
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzlR1" type="MAC" languagemode="0"><![CDATA[
%BSzlR1 ;Компоненты создания прогры списка  (А.Тимофеев) ; 13:37   19.04.2000
 
KEY(%1) ;Вытаскивание условий на ключи БД
 S %0="" N f,u
 S f=$S($G(@mas@(nf,%1,"11,4"))'="":^("11,4"),$G(@mas3@("zp",%1,7))'="":^(7),1:"")
 I f'="" S f=$S(f'=+f:f,1:"$E("_%1_",1,"_$L(f)_")="_f)
 S u=$S($G(@mas@(nf,%1,"9,4"))'="":^("9,4"),$G(@mas3@("zp",%1,6))'="":^(6),1:"")
 I u'="" S u=$S(u'=+u:u,1:"$E("_%1_",1,"_$L(u)_")="_u)
 S %0=$S($G(f)'="":" S "_f_" ",1:$S($G(@mas@(nf,%1,"7,4"))="Y":",-1",1:"")_") Q:"_%1_"=""""  ")
 S %0=%0_$S($G(u)'="":"I "_u,1:"")
 S %0=%0_" D "_$S(keyS=$E(%1,2):"C",1:" ")
 I $D(@mas@(nf,%1)) S %0=%0_$S($G(@mas@(nf,%1,"3,4"))'="Y":"Q  ",1:"")
 Q %0
 
KEYL(%1) ;Конкректное кол-во ключей
 N k,str
 S %0=""
 S str="(" F k=1:1:keyS S str=str_$S(k=1:"k"_k,1:",k"_k)
 S %0=str_")" Q %0
 
PO(%1,%2,%3,%4,%5) ;Конкректные адреса в БД
 ;%1 (1 - Только по О.Ч., 2 - Смешанное условие или Л.Ч. или повт. группа)
 ;%2 - программная строка
 ;%3 - Полная глобальная ссылка на таблицу БД с О.Ч.
 ;%4 - Полная глобальная ссылка на таблицу БД с Л.Ч.
 ;%5 - Условие мультитаблицы (1)
 ;pg - Условие повторяющихся групп (1)
 I %2["|" S %2=$TR(%2,"|","@")
 S:$G(%3)'="" tabO=%3 S:$G(%4)'="" tabO=%4 S:$G(%5)'="" mtb="Y"
 N y,x,str1,str2,str3,TAB
 S %0=%2 I %1=""!(%2="") Q %0
PO1 I %2'["{" D:%2["^("  Q %0
 .F y=2:1 S str1=$P(%2,"^(",y) Q:str1=""  D
 ..S str2=$P(str1,")"),$P(str1,")")=str2_")"
 ..S $P(%2,"^(",y)=str1
 .S %2=$$TR^%ZAPM.bs.BSsFUNM(%2,"^(","$G(@masR@(") K y,str1,str2 S %0=%2
 S TAB=$S(%1=1:tabO,1:tabL) D  G PO1   ;Для условия только по О.Ч.
 .S str1=$P(%2,"{"),str2=$P($P(%2,"{",2),"}"),str3=$E(%2,($L(str1)+$L(str2)+3),$L(%2))
 .S y=$P(str2,","),x=$P(str2,",",2)
 .D  S %2=str1_str2_str3  S:pg=1&(%1=2) $E(%2,$L(str1)+$L(str2)+1)="",$E(%2,$L(str1))=""
 ..I $P($P($G(@TAB@(y,x)),"@",18),"#")'="" S str2=$P($P($G(@TAB@(y,x)),"@",18),"#") Q
 ..I pg=1,%1=2,%2["{" S str2=y_"+pg_"",""_"_x Q
 ..S str2=y_","_x Q
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzlT" type="MAC" languagemode="0"><![CDATA[
%BSzlT ;Формирование таблицы списка  (А.Тимофеев) ; 13:37   09.11.2001
 N masI,masT,name,i,ii,i1,i2,i3,i4,i5,i6,strS,strC,strC1,strP,kol,yi,Yi,x,x1,k,uslS,prg,srt1,srt2,srt3,nn,nn1
 S %zT=$ZT,$ZT="ERROR^%ZAPM.bs.BSzlU"
 N NaMe,NaPr,I,CurSTR,FormSTR,HEAD,TItuL,YYy,ROU,routO,vdl,vdd
 S ls="Формируется таблица ..." D WAITS^%ZAPM.bs.BSF2
 S NaMe=$G(@mas0@("tab",4),"?UNKNKOW") ;БАЗОВОЕ ИМЯ СПИСКА
 S NaPr=$$cB^%ZAPM.bs.BSSV I $G(@mas0@("tabE",6))'="" S NaPr=@mas0@("tabE",6) ;ИМЯ РАЗДЕЛА
 S masI=$NA(@NaPr@($$NamePack^%ZAPM.bs.BSzZ()_NaMe)) ;masI - ИМЯ НАСЧИТАННОГО СПИСКА
 I PACET'=0 I $D(@masI) K @masI
 I PACET=0 D  ;ФОРМИРОВАНИЕ ИМЕНИ СПИСКА
 .F I=1:1 I '$D(@NaPr@(NaMe_"_"_$$SYSDATE^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3())_"_"_I)) S masI=$ZR Q
 
 I '$D(@mas1) D:PACET=0 OkMsg^%ZAPM.bs.BSXfun("СПИСОК ПУСТОЙ",2) Q
 
 I $G(@mas0@("tab",19))'="" S routO=@mas0@("tab",19) X routO
 S masT=$G(@mas0@("tab",3)) S (nameS,name)=$G(^(2)) ;КОМЕНТАРИЙ
 S strS=$G(^(7)),strC=$G(^(8)),strC1=$G(^(9)),strP=$G(^(10)),kolS=$G(^(17)),kol=$G(^(13)),zs=$G(^(18))
 S @masI=$G(@masT),$P(@masI,"@",17)=1,$P(@masI,"@",24)="",$P(@masI,"@")=name,$P(@masI,"@",20)=2,$P(@masI,"@",32)=1,$P(@masI,"@",33)="LS"
 I $D(@mas0@("tabE",17)) D Copy^%ZAPM.bs.BSF8($NA(@mas0@("tabE",17)),"vdl")
 S BSr=$P(masI,"("),BSt=$TR($P($P(masI,"(",2),")"),$C(34),"")
 
 S CurSTR=1
 ;строка (название) ЗАГОЛОВОК
 I $G(@mas0@("tabE",1))'="" S name=@mas0@("tabE",1)
 ;I name["~" F I=1:1 Q:$P(name,"~",I,I+1)=""  D ADDHEAD($$EXT^%ZAPM.bs.BSzmOL($P(name,"~",I)))
 ;I name'["~" D ADDHEAD($$EXT^%ZAPM.bs.BSzmOL(name))
 I name["~" F I=1:1 Q:$P(name,"~",I,I+1)=""  S $P(name,"~",I)=$$EXT^%ZAPM.bs.BSzmOL($P(name,"~",I)) D ADDHEAD($P(name,"~",I))
 I name'["~" S name=$$EXT^%ZAPM.bs.BSzmOL(name) D ADDHEAD(name)
 S @masI@("PERHEAD")=$$HEAD^%ZAPM.bs.BSzmOL(name)
 
 ;строка с условиями
 S uslS="" S k="" F  S k=$O(@mas0@("zp",k)) Q:k=""  D
 .I $G(@mas0@("zp",k,1))'="" S uslS=uslS_" "_$G(^(1))
 I uslS'="" D ADDHEAD(uslS)
 
 ;ПЕРИОДЫ СРАВНЕНИЯ
 I $D(G1) D
 .F C1=1:1:C I $D(G1(C1)) D
 ..N i6
 ..S i6=$S(C>1:C1,1:"")_" ПЕРИОД : С "_$$D^%ZAPM.bs.BSsFUNR($G(G1(C1)))_"."_$$M^%ZAPM.bs.BSsFUNR($G(G1(C1)))_"."_$$Y^%ZAPM.bs.BSsFUNR($G(G1(C1)))
 ..S i6=i6_" ПО "_$$D^%ZAPM.bs.BSsFUNR($G(G2(C1)))_"."_$$M^%ZAPM.bs.BSsFUNR($G(G2(C1)))_"."_$$Y^%ZAPM.bs.BSsFUNR($G(G2(C1)))
 ..D ADDHEAD(i6) S @masI@("PER",C1)=$G(i6)
 
 ;ДАТА - ВРЕМЯ СОЗДАНИЯ
 I $G(@mas0@("tabE",12))="Y" D
 .N i6 S i6="ВЫДАНО: "_$$ESDAY^%ZAPM.bs.BSsFUNR(7,$$h^%ZAPM.bs.BS3())
 .S i6=i6_" КОД ИСПОЛНИТЕЛЯ:"_$G(%BS(12),"АДМ")
 .I $G(@mas0@("tabE",12))="Y" S i6=i6_" КОД СПИСКА:"_$G(NaMe)
 .D ADDHEAD(i6)
 
 ;ШТАМПИК
 I $G(@mas0@("tabE",20))'="" D
 .N N,LONG,KOLS,XX
 .S N=@$ZR I $$Data^%ZAPM.bs.BSF12(N) D
 ..S LONG=+$P($G(@masT@("PRN")),"#",2),KOLS=$P(@N,"@",28)
 ..I +$G(@mas0@("tabE",21)) S LONG=$G(@mas0@("tabE",21))+$L($G(@N@(1)))
 ..I 'LONG S LONG=$$MAXHEAD()+$L($G(@N@(1)))+3
 ..D BUILD(LONG-$L($G(@N@(1)))-2,KOLS)
 D VDLSET
 I $G(vdl) F I=1:1:3 I " "_$G(vdl(I,1))_" "[" d "
 .S i1="" F  S i1=$O(@mas0@("bk",2,i1)) Q:i1=""  I $P(@mas0@("bk",2,i1),"#")=57 S dat1=i1 ;КОЛОНКА ФИО
 
 F CurSTR=1:1 Q:'$D(HEAD(CurSTR))  D COPYLINE(CurSTR,HEAD(CurSTR))
 
 S $P(@BSr@(BSt,"ExcelOut"),",",3)=CurSTR
 S (x,x1)=1 X "F i="_kol_" D STR3(CurSTR)"    ;СКРЫТАЯ СТРОКА
 S (x,x1)=1 X "F i="_kol_" D STRh(CurSTR+1)"  ;ШАПКА
 S CurSTR=y1
 S $P(@masI,"@",29)=x1-1
 S yi=y1,y2=y,srt1="",(nn,nn1)=1 F  S srt1=$O(@mas1@(srt1)) Q:srt1=""  D
 .S srt2="" F  S srt2=$O(@mas1@(srt1,srt2)) Q:srt2=""  D
 ..S srt3="" F  S srt3=$O(@mas1@(srt1,srt2,srt3)) Q:srt3=""  D
 ...S i="" F  S i=$O(@mas1@(srt1,srt2,srt3,i)) Q:i=""  D  S:i'="INSERT" nn=nn+1
 ....S ii="" F  S ii=$O(@mas1@(srt1,srt2,srt3,i,ii)) Q:ii=""  D  S:i'="INSERT" nn1=nn1+1
 .....I $G(vdl),$$VDL(srt1,srt2,srt3,i,ii)
 .....D STRp
 ....D STRpR ;Разделитель
 S (x,x1)=1 X "F i="_kol_" D STRz"
 ;Титул
 S $P(@masI,"@",28)=y1-1,$P(@masI,"@",36)=CurSTR_",1,0" ;СОРТИРОВКА
 S $P(@masI,"@",50)=(CurSTR)_",1",$P(@masI,"@",19)="" ;ТИТУЛ ПЕЧАТИ```MSW  --- ,2" 
 S:$D(@masT@("AF2")) @masI@("AF2")=$G(@masT@("AF2"))
 ;Установки на вывод
 F prg="PRN","HFS","TXT","SHR","SVM","RSM" D
 .I $D(@masT@(prg)) S @masI@(prg)=$G(@masT@(prg))
 
 S @masI@("PERDATE")=$$ESDAY^%ZAPM.bs.BSsFUNR(7,$$h^%ZAPM.bs.BS3())
 S @masI@("PERUSER")=$G(%BS(12))
 S @masI@("LST")=$H_","_$G(%BS(12))_",Greated"
 
 ;```MSW ----- ФОМАТИРОВАНИЕ ТАБЛИЦЫ
 N BSR,BST,ke,se S BSR=BSr,BST=BSt,se=$P(@masI,"@",28),ke=$P(@masI,"@",29) D TAB^%ZAPM.bs.BSF1 K BSR,BST ;```MSW
 D TPr^%ZAPM.bs.BSF8(masI)
 S $P(@masI,"@")=($P($$h^%ZAPM.bs.BS3,",",2)-Total)_" сек. ;"_$P(@masI,"@")
 I $G(@mas0@("tabE",16))'="" S ROU=@mas0@("tabE",16) X $S($E(ROU)="^":"D ",1:"")_ROU
 I PACET=0 S IYI=masI D NE^%ZAPM.bs.BSN
 S tabYES=1,$ZT=%zT,BSl=masI
 Q
MAXHEAD() N MAX,I ;МАКСИМУМ
 S MAX=0 F I=1:1 Q:'$D(HEAD(I))  I $L(HEAD(I))>MAX S MAX=$L(HEAD(I))
 Q MAX
STR3(CurSTR) ;3 скрытая строка с формулами
 S (FormSTR,y1)=CurSTR,y=y1-1,@masI@(y1,x1)=$G(@masT@(strC,i))
 I $D(@masT@("FCL",strC,i)) S @masI@("FCL",y1,x1)=$G(@masT@("FCL",strC,i)),@masI@("FCL",y1,x1,1)=$G(@masT@("FCL",strC,i,1))
 I $D(@masT@("FTR",strC,i)) S @masI@("FTR",y1,x1)=$G(@masT@("FTR",strC,i)),@masI@("FTR",y1,x1,1)=$G(@masT@("FTR",strC,i,1))
 S $P(@masI@(y1,x1),"@",3)=0,x1=x1+1,x=x+$P(@masT@(1,i),"@",4)
 S $P(@masI@(y1,x1),"@",15)=""
 Q
 
STRh(CurSTR) ;Строки шапки таблицы
 S y1=CurSTR,y=y1-1 X "F i1="_strS_" D STRh1"
 S x1=x1+1,x=x+$P(@masT@(i1,i),"@",4)
 Q
STRh1 ;
 S @masI@(y1,x1)=$G(@masT@(i1,i)) X $G(WA) D SQL(y1,x1,$TR($P(@masI@(y1,x1),"@",15),"-+|",""))
 ;Функции ТР и ВЫЧ
 S:$D(@masT@("FCL",i1,i)) @masI@("FCL",y1,x1)=$G(@masT@("FCL",i1,i)),@masI@("FCL",y1,x1,1)=$G(@masT@("FCL",i1,i,1))
 S:$D(@masT@("FTR",i1,i)) @masI@("FTR",y1,x1)=$G(@masT@("FTR",i1,i)),@masI@("FTR",y1,x1,1)=$G(@masT@("FTR",i1,i,1))
 S y1=y1+1,y=y+$P(@masT@(i1,i),"@",3)
 Q
 
VDLSET ;НАЙТИ УСЛОВНОЕ ИМЯ ДЛЯ ВЫДЕЛЕНИЯ
 N I,II,i1
 Q:'$G(vdl)  F I=1:1:3 I $G(vdl(I))'="" I " "_$G(vdl(I,1))_" "'[" d ",$G(vdl(I,1))'="" F II=1,2 S i1="" F  S i1=$O(@mas0@("bk",II,i1)) Q:i1=""  I $P(@mas0@("bk",II,i1),"#")=vdl(I,1) G VDLEND
 Q
VDLEND S vdl(I,1)=i1
 Q
VDL(u1,u2,u3,i,ii) ;ВЫДЕЛЕНИЕ
 N I,II,J,JJ,d,dd,ddd,Sing
 F I=1:1:3 I $G(vdl(I))'="" X "S d="_vdl(I) I d'="",'$D(vdd(I,d)) D  S dd="|"_$TR(dd,"=-","*."),Sing=" " D VDLSTRp S Sing="-",dd=$TR($J("",1999)," ","-") D VDLSTRp
 .S vdd(I,d)=@("u"_I) F II=I+1:1:3 K vdd(II)
 .I $G(vdl(I,1))?1N.N S dd=d Q
 .I $G(vdl(I,1))="" S dd=$$TR^%ZAPM.bs.BSsFUNM($G(vdl(I,1)," d")," d",d) Q
 .I " "_$G(vdl(I,1))_" "[" d " S dd=$$TR^%ZAPM.bs.BSsFUNM($G(vdl(I,1)," d")," d",d) Q
 .S dd="УСЛОВНОЕ ИМЯ '"_vdl(I,1)_"' НЕ НАЙДЕНО !!!! "_d
 Q 1
VDLSTRp ;Строки цикла
 N EnDx S EnDx=$P(kol,",",$L(kol,",")) I EnDx="" S EnDx=$P(kol,":",$L(kol,":"))
 S (x,x1,yy,yy1)=1 X "F i1="_kol_" D VDLSTRp1"
 S @masI@(yi)=1,yi=yi+1,y2=y2+($P(@masT@(strC,i1),"@",3)*yy)
 Q
VDLSTRp1 ;Клеточка {yi,x1}
 S @masI@(yi,x1)=$G(@masT@(strC,i1)) X $G(WA)
 D  ;ВЫКЛ ФУНКЦИИ
 .S $P(@masI@(yi,x1),"@",3)=1 //ВЫСОТА
 .Q:$G(vdl(I,"F"))=3  I $G(vdl(I,"F"))'=1 S:$P(@masI@(yi,x1),"@",7)'="" $P(^(x1),"@",7)=FormSTR_","_x1
 .I $G(vdl(I,"F"))'=2 S:$P(@masI@(yi,x1),"@",8)'="" $P(^(x1),"@",8)=FormSTR_","_x1
 D
 .I vdl(I,1)?1N.N D  Q
 ..I vdl(I,1)=i1 S $P(@masI@(yi,x1),"@",15)=dd
 .S $P(@masI@(yi,x1),"@",15)=$E(dd,x,x+$P(@masT@(strC,i1),"@",4)-1)
 .I i1=EnDx S $P(@masI@(yi,x1),"@",15)=$TR($J("",$P(@masI@(yi,x1),"@",4)-1)," ",Sing)_"|"
 S x1=x1+1,x=x+$P(@masT@(strC,i1),"@",4)
 Q
STRp ;Строки цикла
 S (x,x1,yy,yy1)=1 X "F i1="_kol_" D STRp1"
 I yy>1 S i2="" F  S i2=$O(@masI@(yi,i2)) Q:i2=""  D  ;ЗАГИБАНИЕ
 .S $P(@masI@(yi,i2),"@",3)=yy
 S @masI@(yi)=1,yi=yi+1,y2=y2+($P(@masT@(strC,i1),"@",3)*yy)
 Q
STRp1 ;Клеточка {yi,x1}
 S @masI@(yi,x1)=$G(@masT@(strC,i1)) X $G(WA)
 S:$P(@masI@(yi,x1),"@",7)'="" $P(^(x1),"@",7)=FormSTR_","_x1
 S:$P(@masI@(yi,x1),"@",8)'="" $P(^(x1),"@",8)=FormSTR_","_x1
 D:$D(@mas1@(srt1,srt2,srt3,i,ii,i1))&($G(^(i1))'=0)
 .D
 ..I ^(i1)'["@" S $P(@masI@(yi,x1),"@",15)=$G(@mas1@(srt1,srt2,srt3,i,ii,i1)) D SQL(yi,x1,$G(@mas1@(srt1,srt2,srt3,i,ii,i1))) Q
 ..I $P(^(i1),"@")="N" S $P(@masI@(yi,x1),"@",15)=nn D SQL(yi,x1,nn) Q
 ..I $P(^(i1),"@")="NN" S $P(@masI@(yi,x1),"@",15)=nn1 D SQL(yi,x1,nn1) Q
 .I $P(zs,",",1)'="Y" Q  ;ЗАГИБАНИЕ СТРОК
 .I $D(@mas0@("bk",1,i1))&($P($G(^(i1)),"#",2)=1)!($D(@mas0@("bk",2,i1))&($P($G(^(i1)),"#",2)=1)) D  Q
 ..;S yy1=$L($G(@mas1@(srt1,srt2,srt3,i,ii,i1)))/$P(@masT@(strC,i1),"@",3)/$P(@masT@(strC,i1),"@",4) I yy1>yy S yy=$S(yy1[".":$P(yy1,".")+1,1:yy1)
 ..D DDD
 .I $D(@mas0@("bk",1,i1))&($P($G(^(i1)),"#",2)=2)!($D(@mas0@("bk",2,i1))&($P($G(^(i1)),"#",2)=2)) D  Q
 ..D DDD
 .I $D(@mas0@("bk",1,i1))&($P($G(^(i1)),"#",2)=3)!($D(@mas0@("bk",2,i1))&($P($G(^(i1)),"#",2)=3)) D  Q
 ..D DDD ;ATACELL(BSr,BSt,yi,x1) S yy1=$L($P(jj,"@",15))\$P(jj,"@",4)+$S($L($P(jj,"@",15))#$P(jj,"@",4):1,1:0) I yy1>yy S yy=yy1 ;```0)-1
 S x1=x1+1,x=x+$P(@masT@(strC,i1),"@",4)
 Q
DDD D DATACELL(BSr,BSt,yi,x1) S yy1=$L($P(jj,"@",15))\$P(jj,"@",4)+$S($L($P(jj,"@",15))#$P(jj,"@",4):1,1:0) I yy1>yy S yy=yy1
	Q 
SQL(yi,x1,S)  I $P(zs,",",2)'="Y" Q
	S @masI@("SQL",yi,x1)=$TR(S,"|","")
	Q
DATACELL(BSr,BSt,i,j) ;ИЛИ ДАННЫЕ ИЛИ РЕЗУЛЬТАТ ТРАНСФОРМАЦИЮ
 S jj=@BSr@(BSt,i,j)
 N d1 D TRANS^%ZAPM.bs.BST(BSr,BSt,jj,i,j)
 S $P(jj,"@",15)=d1
 Q
 
STRpR ;Разделитель
 I strC1="" Q
 S (x,x1)=1 X "F i1="_kol_" D STRp3"
 S yi=yi+1,y2=y2+$P(@masT@(strC1,i1),"@",3)
 Q
STRp3 ;Разделитель
 S @masI@(yi,x1)=$G(@masT@(strC1,i1)) X $G(WA)
 ;Функции ТР и ВЫЧ
 S:$D(@masT@("FCL",strC1,i1)) @masI@("FCL",yi,x1)=$G(@masT@("FCL",strC1,i1)),@masI@("FCL",yi,x1,1)=$G(@masT@("FCL",strC1,i1,1))
 S:$D(@masT@("FTR",strC1,i1)) @masI@("FTR",yi,x1)=$G(@masT@("FTR",strC1,i1)),@masI@("FTR",yi,x1,1)=$G(@masT@("FTR",strC1,i1,1))
 S x1=x1+1,x=x+$P(@masT@(strC1,i1),"@",4)
 Q
 
STRz ;Строки подвала
 S y1=yi,y=y2 X "F i1="_strP_" D STRz1"
 S x1=x1+1,x=x+$P(@masT@(i1,i),"@",4)
 Q
STRz1 ;
 S @masI@(y1,x1)=$G(@masT@(i1,i)) X $G(WA)
 S y1=y1+1,y=y+$P(@masT@(i1,i),"@",3)
 Q
 
 ; 36  SO =A,B,C,D  A - C КАКОЙ СТРОКИ СОРТИРОВАТЬ   B - ШАГ СОРТИРОВКИ
 ;     C=1 СОРТИРОВАТЬ ПО УБЫВАНИЮ D="N!N1!N3!" - ПО КАКОЙ КОЛОНКЕ СОРТИРОВАТЬ
 
BUILD(L,K) ;ДОСТРОИТЬ К ЗАГОЛОВКУ ШТАМПИК
 F I=1:1:K S:'$D(HEAD(I)) HEAD(I)="" S HEAD(I)=$E(HEAD(I),1,L),HEAD(I)=HEAD(I)_$J("",L-$L(HEAD(I)))_" "_$G(@N@(I))
 Q
ADDHEAD(S) S HEAD(CurSTR)=S,CurSTR=CurSTR+1
 Q
COPYLINE(Y,name) ;КОПИРОВАТЬ СТРОКУ СПИСОК
 N x,i
 S (x,x1)=1 X "F i="_kol_" D COPYL X $G(WA)"
 Q
COPYL S @masI@(Y,x1)=$G(@masT@(1,i))
 S $P(@masI@(Y,x1),"@",15)=$E(name,x,(x+$P(@masT@(1,i),"@",4)-1))
 S $P(@masI@(Y,x1),"@",3)=1,$P(^(x1),"@",18)="",x1=x1+1,x=x+$P(@masT@(1,i),"@",4)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzlU" type="MAC" languagemode="0"><![CDATA[
%BSzlU ;Загрузка условий для списка  (А.Тимофеев) ; 14:57   20.04.2000
 G LOAD1
 ;...G ^%ZAPM.bs.BSzlR ... G ^SLr12 ... G ^%ZAPM.bs.BSzlT
LOAD(%1,%2,%3) ;Выполнение с параметрами (%1- имя списка, %2'="" - выполнение без загрузки запросов на ключи !, %3'="" - как пакет !)
LOAD1 K ^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"ul") S PACET=0  ;Загрузка условий
 ;mas- БД условий, mas1- БД запросов, mas2- БД боковин, mas3 - буфер (^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u"))
 ;выходные переменные: C,G1(C),G2(C),nf,na
 N i,i1,i2,i3,i4,i5,C1,STOP,unL,BSr,BSt,cHOSe
 S mas=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SLm1"))),mas1=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVz1"))),mas3="^%ZAPM.bs.BSbufB(""PO""_$G(%BS(3),$P)_$J_""ul"")"
 S mas4="^%ZAPM.bs.BSbufB(""fTS""_$G(%BS(3),$P)_$J_""u"")",mas5="^%ZAPM.bs.BSbufB(""W""_$G(%BS(3),$P)_$J_""u"")"     ;Буфера
 S %zT=$ZT,$ZT="ERROR" S @mas3="Буфер насчета списка"
 I $G(%1)'="" S i=%1 S:$G(%2)'="" unL=1 S:$G(%3)'="" PACET=1 G 1
 K C,G1,G2 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SLa1)","1#2#2",2)
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 
1 ;Загрузка общих условий
 S na=$P(i,"~") I na="" D ErrMsg^%ZAPM.bs.BSXfun("НЕ ВЫБРАНА АНАЛИТИЧЕСКАЯ ФОРМА !!") S $ZT=%zT Q
 S nf=$P(na,"#")
 I '$D(@mas@(nf,na))!('$D(@mas@(nf,0))) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЙ НА ФОРМУ !! "_$NA(@mas@(nf,na))) S $ZT=%zT Q
 S zp=$G(@mas@(nf,na,"5,4")) I zp="" D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЯ НА ЗАПРОС !!") S $ZT=%zT Q
 I '$D(@mas1@(zp)) D ErrMsg^%ZAPM.bs.BSXfun("ЗАПРОСА "_zp_" НЕТ") S $ZT=%zT Q
2 ;Загрузка запросов в буфер
 F i1=0:1:11 S i2="k"_i1,i3=i1+2 D
 .F i4=2:1:7 S i5=i3_","_i4 I $G(@mas1@(zp,"O",i5))'="" S @mas3@("zp",i2,i4)=$G(@mas1@(zp,"O",i5))
 S i1="",Per="" F  S i1=$O(@mas3@("zp",i1)) Q:i1=""  D
 .I $G(@mas3@("zp",i1,2))="Y" S Per="Y" Q
 G:$G(unL)=1 7    ;Без загрузки запросов (!!!)
 
3 ;Загрузка периодов сравнения
 S STOP="" I Per="" G 4
 S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVz0)","4#1#20",2,"","PRED^%ZAPM.bs.BSzlU")
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 S C=$P(i,"~",2) I C="" D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ЗАПРОСА !!") S $ZT=%zT Q
 F C1=1:1:C S G1(C1)=$P(i,"~",(2*C1+1)),G2(C1)=$P(i,"~",(2*C1+2))
 I G1(C)=""!(G2(C)="") K G1,G2
 
4 ;Загрузка запросов на ключи
 S @mas3@("zp")="Условия на ключи БД"
 S (i,STOP)="" F  S i=$O(@mas3@("zp",i)) Q:i=""  S i1=$E(i,2,3) D  G:STOP=1 3
 .I $G(@mas3@("zp",i,3))="Y" I $D(@mas1@(zp,i1)) D 5
 G:STOP=1 3
41 ;Условие на сортировку
 S (srt(1),srt(2),srt(3))=0 I $G(@mas@(nf,na,"17,4"))'="" I $$NOCHANGE^%ZAPM.bs.BSzmOL($G(@mas@(nf,na,"17,4"))) G 7
 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SLs1)",2,2,"~","42^%ZAPM.bs.BSzlU")
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 G 7        ;Конкретно на условия по списку
 S srt(1)=$P(A,"~") S:srt(1)="" srt(1)=0
 S srt(2)=$P(A,"~",2) S:srt(2)="" srt(2)=0
 S srt(3)=$P(A,"~",3) S:srt(3)="" srt(3)=0
 G 7
42 ;Копирование данных из БД по запросу на сортировку
 S $P(@mas4@(4,4),"@",15)=$P($G(@mas@(nf,na,"17,4")),"!")
 S $P(@mas4@(6,4),"@",15)=$P($G(@mas@(nf,na,"17,4")),"!",2)
 S $P(@mas4@(8,4),"@",15)=$P($G(@mas@(nf,na,"17,4")),"!",3)
 Q
 
5 ;Загрузка стандартного запроса на ключ
 N adr,tab,ind,ind1
 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVz3)",2,1,"","6^%ZAPM.bs.BSzlU") Q:A=""
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S STOP=1 Q
 I $P(adr,",")>3 S ind=$P(adr,","),ind1=$P(adr,",",2) I $D(@mas5@(ind,ind1)) D  Q
 .S @mas3@("zp",i,1)=$G(@mas5@(ind,1))
 .S @mas3@("zp",i,6)=$G(@mas5@(ind,2))
 S @mas3@("zp",i,4)=$G(@mas5@(3,1))
 S @mas3@("zp",i,5)=$G(@mas5@(3,2))
 I $E(i,2,3)<10 S @mas3@("zp",i,6)=$$LOGIKA(i)
 Q
LOGIKA(I) I $G(@mas5@(3,1))=""!($G(@mas5@(3,2))="") Q "$D("_I_")"
 Q I_"'<"_$G(@mas5@(3,1))_","_i_"'>"_$G(@mas5@(3,2))
 
6 ;Копирование данных из БД по запросу на ключ
 S $P(@mas4@(1,1),"@",15)=$G(@mas1@(zp,i1,"1,2"))
 S $P(@mas4@(3,1),"@",15)=$G(@mas3@("zp",i,4))
 S $P(@mas4@(3,2),"@",15)=$G(@mas3@("zp",i,5))
 F i2=5:1:65 S i3=(i2-2)_",1",i4=(i2-2)_",2" D
 .S $P(@mas4@(i2,1),"@",15)=$G(@mas1@(zp,i1,i3),"")
 .S $P(@mas4@(i2,2),"@",15)=$G(@mas1@(zp,i1,i4),"")
 Q
 
7 ;Загрузка информации по шаблону
 K @mas3@("tab") S @mas3@("tab")="Элементы шаблона"
 F i=2,4,7:1:10,13,17:1:19 S i1=i_","_4 S @mas3@("tab",i)=$G(@mas@(nf,na,i1))
 S:$G(srt(1))'=0 @mas3@("tab",17)=$G(srt(1))_"!"_$G(srt(2))_"!"_$G(srt(3))
 S @mas3@("tab",3)=$G(@mas@(nf,na,"pgs"))
 I $G(@mas3@("tab",3))=""!($G(^(4))="")!($G(^(8))="")!($G(^(13))="") G STOP
 
 K @mas3@("tabE") S @mas3@("tabE")="Элементы шаблона ДОПОЛНИТЕЛЬНЫЕ (MSW)"
 F i=1,6,12,16,21,22,29 S i1=i_","_4 I $G(@mas@(nf,na,i1))'="" S @mas3@("tabE",i)=@mas@(nf,na,i1)
 S @mas3@("tabE",20)=$G(@mas@(nf,na,"sec"))
 ;ПАРАМЕТРЫ ВЫДЕЛЕНИЯ
 F i=1:1:3 I $G(vdl(i))'="" S vdl=1 D Copy^%ZAPM.bs.BSF8("vdl",$NA(@mas3@("tabE",17))) Q
 
8 ;Загрузка условий на колонки
 N masT,kol,str,dan,EROS
 K @mas3@("bk") S @mas3@("bk")="Условия на колонки"
 S masT=$G(@mas@(nf,na,"pgs")),str=$G(^("11,4")),kol=$G(^("13,4"))
 ;Выбор номеров колонок по именам хранения
 K nmk D 9 Q:$D(EROS)
 S kol1="" F i=1:1 S kol2=$P(kol,",",i) Q:kol2=""  D 91
 S $E(kol1,1)="" F i=1:1 S kol2=$P(kol1,",",i) Q:kol2=""  D 10 S kol=kol1,@mas3@("tab",13)=kol
 K nmk,@mas3@("r"),@mas3@("n") S @mas3@("r")="Программа насчета"
 G ^%ZAPM.bs.BSzlR ;... ^SLr12 ... G ^%ZAPM.bs.BSzlT
o S EROS=1 Q
9 ;Выбор номеров колонок по именам в БД
 N nmk1 S nmk1="" F  S nmk1=$O(@masT@(str,nmk1)) Q:'nmk1  D  Q:$D(EROS)
 .S dan=$P($G(@masT@(str,nmk1)),"@",15) Q:dan=""
 .I $P(dan,"~")="" D ErrMsg^%ZAPM.bs.BSXfun("ПУСТОЕ ИМЯ~ КОЛОНКИ N "_nmk1_" !!"),o Q
 .I $D(nmk($P(dan,"~"))) D ErrMsg^%ZAPM.bs.BSXfun("НЕДОПУСТИМОЕ ДУБЛИРОВАНИЕ ИМЕН "_$P(dan,"~")_". В КОЛОНКАХ N "_nmk1_" и "_nmk($P(dan,"~"))_" !!"),o Q
 .S nmk($P(dan,"~"))=nmk1
 Q
91 I $G(nmk(kol2))="" D ErrMsg^%ZAPM.bs.BSXfun("Нет КОЛОНКИ N "_kol2_" !!") Q
 S kol1=kol1_","_$G(nmk(kol2)) Q
 
10 ;Условия на колонки
 S dan=$P($G(@masT@(str,kol2)),"@",15) Q:dan=""
 I $P(dan,"~",3)=2 S @mas3@("bk",0,2)=$G(@mas3@("bk",0,2))_kol2_",",@mas3@("bk",2,kol2)=$P(dan,"~",2)_"#"_$P(dan,"~",4)_"#"_$P(dan,"~",5) Q
 I dan'["~" S @mas3@("bk",0,1)=$G(@mas3@("bk",0,1))_kol2_",",@mas3@("bk",1,kol2)=dan_"#" Q
 S @mas3@("bk",0,1)=$G(@mas3@("bk",0,1))_kol2_",",@mas3@("bk",1,kol2)=$P(dan,"~",2)_"#"_$P(dan,"~",4)_"#"_$P(dan,"~",5) Q
 Q
PRED S $P(@BSR@(BST),"@",41)="HISCOMP^%ZAPM.bs.BSzmOL(""SLComp"")" Q
ERROR ;
 I $ZE["<INRPT" D ErrMsg^%ZAPM.bs.BSXfun("ПРЕРВАНО С ТЕРМИНАЛА !!") S STOP=1,$ZT=%zT Q
 I $ZE["<NOSYS"!($ZE["<NAMESPACE") D ErrMsg^%ZAPM.bs.BSXfun("НЕ ДОСТУПНА БАЗА ДАННЫХ !!") S $ZT=%zT Q
 D ErrMsg^%ZAPM.bs.BSXfun("Ошибка ! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT)
 Q
STOP ;
 S $ZT=%zT D ErrMsg^%ZAPM.bs.BSXfun("Некорректно сформулированы условия !!!") Q
 ;D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ЗАПРОСА !!") S $ZT=%zT Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzmOL" type="MAC" languagemode="0"><![CDATA[
%BSzmOL ; пpогpамма ФУНКЦИЙ ДЛЯ АНАЛИТИЧЕСКИХ ОТЧЕТОВ ; 14:14   12.09.2000
 Q
HEAD(name) ;ПРИГЛАДИТЬ ЗАГОЛОВОК ДЛЯ HTML
 N S S S=""
 F I=1:1 Q:$P(name,"~",I,I+1)=""  S S=S_$$CutS^%ZAPM.bs.BSF10($P(name,"~",I))_" "
 Q S
EXT(T) ;ДОПОЛНИТЕЛЬНЫЕ ПАРАМЕТРЫ ТЕКСТА
 I T["""_"!(T["_""") D EXTX Q T
 Q T
EXTX ;ВЫПОЛНИТЬ
 S $ZT="EREXT^%ZAPM.bs.BSzmOL" X "S T="_T
 Q
EREXT S T="ОШИБКА ФОРМИРОВАНИЯ ЗАГОЛОВКА. "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)
 Q
HISTPACK ;ДЛЯ ВЫБОРА НАСЧИТАННЫХ ПАКЕТОВ НА ВЫВОД
 Q:'$D(ny)
 I ny=2,R1=27,R2=91,R3=65 D  ;ЗАСВЕТКА СПИСКА ИСТОРИЙ
 .N %HIS,TTT D HIS^%ZAPM.bs.BSF1("PackO") S TTT=$P($P(%HIS,"(",2),$C(34),2)
 .s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB",TTT) I Tmp=""!(YES<1) Q
 .S d=Tmp,R1=0,R2=18 Q
 Q
HISCOMP(iD) ;ДЛЯ ВЫБОРА ПЕРИОДОВ СРАВНЕНИЯ
 Q:'$D(ny)
 I ny>1,R1=13 D  ;ЗАПИСЬ В ИСТОРИЮ
 .D AddHist(iD,$$HICOMP())
 I ny=1,R1=27,R2=91,R3=65 D  ;ЗАСВЕТКА СПИСКА ИСТОРИЙ
 .N %HIS,TTT D HIS^%ZAPM.bs.BSF1(iD) S TTT=$P($P(%HIS,"(",2),$C(34),2)
 .s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB",TTT) I Tmp=""!(YES<1) Q
 .N iQ F iQ=3:1:20 S $P(@BSR@(BST,iQ,4),"@",15)=""
 .N II F II=2:1 Q:$P(Tmp," ",II-1)=""  S $P(@BSR@(BST,II,4),"@",15)=$P(Tmp," ",II-1)
 .D:$D(%CAL) CALC^%ZAPM.bs.BSF3
 .S R1=27,R2=91,R3=66 Q
 Q
HICOMP() ;СОБРАТЬ СТРОКУ
 I '$P(@BSR@(BST,2,4),"@",15) Q ""
 N I,II S I="" F II=2:1 Q:$P(@BSR@(BST,II,4),"@",15)=""  S I=I_$P(@BSR@(BST,II,4),"@",15)_" "
 Q I
HISTORY(iD) ;ДЛЯ ВЫБОРА СВОДОК ИЛИ СПИСКОВ
 Q:'$D(ny)
 I ny=3,R1=13 D  ;ЗАПИСЬ В ИСТОРИЮ
 .D AddHist(iD,$P(@BSR@(BST,2,1),"@",15))
 I ny=2,R1=27,R2=91,R3=65 D  ;ЗАСВЕТКА СПИСКА ИСТОРИЙ
 .N %HIS,TTT D HIS^%ZAPM.bs.BSF1(iD) S TTT=$P($P(%HIS,"(",2),$C(34),2)
 .s Tmp=$$History^%ZAPM.bs.BSXfun("^%ZAPM.bs.BSbufB",TTT) I Tmp=""!(YES<1) Q
 .S d=Tmp,R1=0,R2=18 Q
 Q
AddHist(f,d) Q:d=""  N %HIS D HIS^%ZAPM.bs.BSF1(f) D AddHist^%ZAPM.bs.BSXuse(%HIS,d) Q
AddGet(S,S1,S2) ;ДОБАВИТЬ $G
 N I,SS
 S SS=$P(S,S1,1)
 F I=2:1 Q:$P(S,S1,I,I+1)=""  S SS=SS_S2_$$SCOBKA($P(S,S1,I))
 Q SS
SCOBKA(S) ;ДОБАВИТЬ СКОБКУ
 Q $P(S,")",1)_"))"_$P(S,")",2,999)
FOR(K,S) ;ПРОВЕРКА НА ВКЛЮЧЕНИЕ S --> K
 N I,II
 X "F I="_K_" I I=S S II=1 Q"
 Q $G(II)
KOL(K) ;ПРИВЕДЕНИЕ СТРОКИ К ФОРМАТУ FOR
 N I,II,I1,I2,STEP1,STEP2,S,SS
 X "F I="_K_" D KOL0"
 S I="" F  S I=$O(II(I)) Q:I=""  D KOL1
 I '$D(STEP1) S SS=SS_S Q SS
 S SS=SS_S_":"_I2
 Q SS
KOL0 S II(I)=""
 Q
KOL1 I '$D(I1) S I1=I,S=I,SS="" Q
 S I2=I,STEP2=I2-I1 I '$D(STEP1) S STEP1=STEP2,S=S_":"_STEP1
 I STEP1'=STEP2 S SS=SS_S_":"_I1_",",S=I2 K STEP1
 S I1=I
 Q
NOCHANGE(U) ;НАДО ЛИ МЕНЯТЬ ПАРАМЕТРЫ СОСТИРОВКИ И ВЫДЕЛЕНИЯ
 N B,I K vdl
 S B=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SLsort"))) I '$D(@B@(U)) Q 0
 F I=1:1:3 I $D(@B@(U,I)) S srt(I)=@$ZR
 F I=1:1:3 I $G(srt(I))="" S srt(I)=0
 F I=1:1:3 I $D(@B@(U,"V"_I)) S vdl(I)=@$ZR,vdl(I,1)=$G(@B@(U,"P"_I)),vdl(I,"F")=$G(@B@(U,"F"_I))
 Q 1
]]></Routine>


<Routine name="%ZAPM.bs.BSzvR" type="MAC" languagemode="0"><![CDATA[
%BSzvR ;Создание пpогpаммы насчета сводки  (А.Тимофеев) ; 18:18   15.04.2003
 ;Входящие переменные: C,G1(C),G2(C),nf,na,mas,mas3,uslL
 
 S %zT=$ZT,$ZT="ERROR^%ZAPM.bs.BSzvU"
 S ls="Погнали..." D WAITS^%ZAPM.bs.BSF2
 S rout=$$rout("RepS"),rout2=$$rout("RepB"),kolI=$G(@mas3@("tab",12))
 S @mas3@("r",0)=rout_" ;Программа насчета сводки "_na_" *TAF*",ind=1
 S @mas3@("r",ind)=" S %zT=$ZT,$ZT=""ERROR^%ZAPM.bs.BSzvU"" "_$S($ZV'["Cach"&&($ZV'["IRIS"):"",1:"ZN ""GLAVK"" "),ind=ind+1 ZN "GLAVK"
 S str=" S ",str1=" ;" F C1=1:1:C D
 .S str=str_"G1("_C1_")="_G1(C1)_",G2("_C1_")="_G2(C1)_","
 .S str1=str1_"С "_G1(C1)_" ПО "_G2(C1)_","
 S @mas3@("r",ind)=str1,ind=ind+1,@mas3@("r",ind)=$E(str,1,($L(str)-1)),ind=ind+1
 
 ;Общие условия на программу
 S i="",strB=0 F  S i=$O(@mas3@("bk",i)) Q:i=""  S strB=strB+1  ;Кол-во строк в боковине
 S strB=strB*C,i=$G(%BS(3),$P)_$J,i=$NA(^%ZAPM.bs.BSbufB("PO"_i_"u")) ;```MSW
 S @mas3@("r",ind)=" S mas0=$NA("_i_"),mas1=$P(mas0,"")"")_"",""""n"""")"" K @mas1" S ind=ind+1
 S @mas3@("r",ind)=" N BSD,BUF,masR,k1,k2,k3,k4,k5,k6,k7,k8,k9,i,j,P,Po,D,sN,Str,L,V,cHOSe" S ind=ind+1
 
 ;Условия на форму
 S i=0 F  S i=$O(@mas@(nf,na,i)) Q:i=""  I i'="00" D  X $G(WA) ;```MSW
 .K mtb,tabO,tabL,keyO,keyS,kol,Po
 .S mtb=$G(@mas@(nf,na,i,0,"2,4")),tabO=$G(^("5,4")),tabL=$G(^("7,4")),keyO=$G(^("8,4"))
 .S keyS=$G(^("10,4")),kol=$G(^("12,4")),Po=$G(^("14,4"))
 .S (endF,kolI1)="" S:kolI="" endF=1
 .I kolI'="" X "F kole="_kol_" F kole1="_kolI_" I kole=kole1 S kolI1=kole_$S(kolI1="""":"""",1:"","")_$G(kolI1),endF=1" S:kolI1'="" kol=kolI1
 .I kolI="" X "F kole="_kol_" S kolI1=kole_$S(kolI1="""":"""",1:"","")_$G(kolI1)" S:kolI1'="" kol=kolI1
 .Q:endF=""  S kol=$$KOL^%ZAPM.bs.BSzmOL(kol)
 .S masBD=$$KBD^%ZAPM.bs.BSF12($NA(@tabO))
 .S Gref="" I $ZV'["Cach"&&($ZV'["IRIS") S Gref="["""_$P($P(masBD,"[",2),",")_""","""_$P($P(masBD,",",2),"]")_"""]"
 .S @mas3@("r",ind)="A"_i_" F j="_kol_" S D(j)=0 I '$D(@mas1@(1,j)) F i=1:1:"_strB_" S @mas1@(i,j)=0" S ind=ind+1
 .S k0=$S($G(@mas@(nf,na,i,"k0","11,4"))'="":^("11,4"),$G(@mas3@("zp","k0",7))'="":^(7),1:"")
 .I k0'="" S:k0'["=" k0="$$YY^%ZAPM.bs.BSsFUNR(G2(C))" S:k0["=" k0=$P(k0,"=",2)  ;`Y2000
 .S @mas3@("r",ind)=" F C=1:1:"_C_" D REC S mas=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0="":"",1:"_")_k0_" I $D(@mas) D Wait^%ZAPM.bs.BSXfun(na_"" ""_mas) D B"_i S ind=ind+1
 .
 .S @mas3@("r",ind)=" G Q"_i,ind=ind+1
 .D KEYS   ;На блок условий по ключам БД
 .S @mas3@("r",ind)=" Q",ind=ind+1
 .S @mas3@("r",ind)="C"_i_" S masR=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0="":"",1:"_")_k0_"_"""_$$KEYL^%ZAPM.bs.BSzvR1(keyS)_""" D  ",ind=ind+1
 .S @mas3@("r",ind)=" .S BSD=""^"_Gref_$P(masBD,"]",2)_""""_$S(k0="":"",1:"_")_k0,ind=ind+1
 .S @mas3@("r",ind)=" .K D F j="_kol_" S D(j)=0",ind=ind+1
 .;Вытаскивание пунктов О.Ч.
 .I tabO'=""&(Po'="") D
 ..S Po=$$PO^%ZAPM.bs.BSzvR1(1,Po),Po=$TR(Po,";",",")
 ..S @mas3@("r",ind)=" .F Po="_Po_" S P(Po)=$G(@masR@(Po))",ind=ind+1
 .;Условия сквозные и на группу по ОЧ
 .S @mas3@("r",ind)=" ."_$S($D(@mas3@("zp","k10",6)):"I "_$$PO^%ZAPM.bs.BSzlR1(1,^(6)),1:"")_"  "_$S($D(@mas@(nf,na,i,"A1","2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(2,$G(^("2,4"))),1:"")_" D  ",ind=ind+1
 .S i1="C" F  S i1=$O(@mas@(nf,na,i,i1)) Q:i1'?1"C"1N.N  D  ;```Q:$E(i1,1)'="C"  D
 ..S @mas3@("r",ind)=" .."_$S($D(@mas@(nf,na,i,i1,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(1,$G(^("2,4"))),1:"")_" D  ",ind=ind+1
 ..S sN=$G(@mas@(nf,na,i,i1,"6,4"))
 ..X "F kk="_$G(@mas@(nf,na,i,i1,"4,4"),0)_" D KOLO" ;```На колонку
 ..I $D(@mas@(nf,na,i,"CC"_$E(i1,2,9))) D KOLOCC("CC"_$E(i1,2,9)) ;```MSW
 .I $G(uslL)'="" D
 ..S @mas3@("r",ind)=" ..F Z="_kol_" I D(Z)'=0 D STR",ind=ind+1
 .I mtb="Y" D          ;Условия сквозные и на группу по ЛЧ
 ..S @mas3@("r",ind)=" ..K L ;По Л.Ч.",ind=ind+1
 ..S @mas3@("r",ind)=" .."_$G(strE),ind=ind+1
 ..S @mas3@("r",ind)=" ...S BSD=""^"_Gref_$P(masBD,"]",2)_"""_$$YY^%ZAPM.bs.BSsFUNR(G1(C))",ind=ind+1
 ..S @mas3@("r",ind)=" ...S masR=""^"_Gref_$P(masBD,"]",2)_"""_$$YY^%ZAPM.bs.BSsFUNR(G1(C))_"""_$$KEYL^%ZAPM.bs.BSzvR1(keyS)_""" D  ",ind=ind+1
 ..I $G(uslL)'="" S @mas3@("r",ind)=" ....K D F j="_kol_" S D(j)=0",ind=ind+1
 ..S i1="D" F  S i1=$O(@mas@(nf,na,i,i1)) Q:i1'?1"D"1N.N  D  ;```Q:$E(i1,1)'="D"  D
 ...S @mas3@("r",ind)=" ...."_$S($D(@mas@(nf,na,i,i1,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(2,$G(^("2,4"))),1:"")_" D  ",ind=ind+1
 ...S @mas3@("r",ind)=" ....."_$S($D(@mas3@("zp","k11",6)):"I "_$$PO^%ZAPM.bs.BSzlR1(2,^(6)),1:"")_"  "_$S($D(@mas@(nf,na,i,"B1","2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(2,$G(^("2,4"))),1:"")_" D  ",ind=ind+1
 ...S sN=$G(@mas@(nf,na,i,i1,"6,4"))
 ...X "F kk="_$G(@mas@(nf,na,i,i1,"4,4"),0)_" D KOLL" ;```На колонку
 ...I $D(@mas@(nf,na,i,"DD"_$E(i1,2,9))) D KOLODD("DD"_$E(i1,2,9)) ;```MSW
 .S @mas3@("r",ind)=" .."_$S($G(uslL)="":"",1:"..")_"F Z="_kol_" I D(Z)'=0 D STR",ind=ind+1
 .;```S @mas3@("r",ind)=" .."_$S($G(uslL)="":"",1:"...")_"F Z="_kol_" I D(Z)'=0 D STR",ind=ind+1
 .;Конец по форме
 .S @mas3@("r",ind)=" Q",ind=ind+1
 .S @mas3@("r",ind)="Q"_i_" D REC  ;Конец по форме",ind=ind+1
 ;Конец по формам
 S rout1=$G(@mas@(nf,na,0,"21,4")) ;```MSW
 I $TR(rout1," ","")'="" S @mas3@("r",ind)=" "_$S($E(rout1)="^":"D ",1:"")_rout1,ind=ind+1
 S @mas3@("r",ind)=" G ^%ZAPM.bs.BSzvT",ind=ind+1
 S @mas3@("r",ind)="STR  G ^"_rout2_"  ;Наполнение строк таблицы",ind=ind+1
 S @mas3@("r",ind)="REC ;Сброс буфера",ind=ind+1
 S @mas3@("r",ind)=" S i1="""" F  S i1=$O(BUF(i1)) Q:i1=""""  D ",ind=ind+1
 S @mas3@("r",ind)=" .S Z="""" F  S Z=$O(BUF(i1,Z)) Q:Z=""""  I $G(BUF(i1,Z)) D ",ind=ind+1
 S @mas3@("r",ind)=" ..S @mas1@(i1,Z)=$G(@mas1@(i1,Z))+BUF(i1,Z)",ind=ind+1
 S @mas3@("r",ind)=" K BUF",ind=ind+1
 ;Проверка объема боковины
 n L,i,i1,A
 s L=0,i="",i1=0 F  S i=$O(@mas3@("bk",i)) q:i=""  S A=@mas3@("bk",i) D
    .I i1>30000 S L=$G(L)+1,i1=0
    .;I $E(A,$L(A))'="Q" s @mas3@("bk",i)=A_"^"_rout2
    .S i1=i1+$L(A) I $P(A," ")'="" S L(1,i)=L,L(2,$P(A," "))=L
 i $G(L)>0 s i="" F  S i=$O(@mas3@("bk",i)) q:i=""  S A=@mas3@("bk",i) D
    .S LA=$P(A," ",$L(A," ")) I LA'="",$D(L(2,LA)),L(1,i)'=L(2,LA) s @mas3@("bk",i)=A_"^"_rout2_"."_L(2,LA)
 ;Запись и загрузка программы насчета
 X "ZR  S i="""" F  S i=$O(@mas3@(""r"",i)) ZS:i="""" @rout Q:i=""""  ZI $G(^(i)):+(i) S i1=i+1"
         I L<1 X "ZR  ZI """_rout2_" ;Условия на строки сводки *TAF*"":+0 S i1=1,i="""" F  S i=$O(@mas3@(""bk"",i)) ZS:i="""" @rout2 Q:i=""""  ZI $G(^(i)):+(i1) S i1=i1+1" I 1
 E  D COMPROU
 S Total=$P($$h^%ZAPM.bs.BS3,",",2) K L
 G ^@rout   ; X "G ^"_rout    ; Q
 Q
COMPROU ;КОМПИЛЯЦИЯ ПРОГРАММ
         W # N ServR
         s i="",i1=0,K=0,FIRST=rout2_" ;Условия на строки сводки (MSW)"
         F  S i=$O(@mas3@("bk",i)) q:i=""  S A=@mas3@("bk",i) D
 .S K=K+1 I K=1 S ServR(K)=FIRST,K=K+1
 .I L(1,i)=i1 s ServR(K)=A Q
 .S i1=L(1,i) s ServR(K)=" G ^"_rout2_"."_i1
 .D COMPR S K=K+1,ServR(K)=A
 S i1=i1+1 D COMPR
 Q
COMPR N out,err,VER,A
 S ServR="",ServR(0)=K,out="",K=0
 I i1=1 S VER=".INT"
 E  S VER="."_(i1-1)_".INT"
 D DEL1^%ZAPM.bs.BSC4r4(rout2_VER_".*") 
 D ROUTINE^%R(rout2_VER,.ServR,.err,"CS",0)
 I $G(err)'="" W !,$$FMTERR^%R(.err,.ServR) ;D  Q
 .N (ServR) D ^%ZAPM.bs.BSMSMG("ServR")
 .D x^%ZAPM.bs.BS3(VER)
 K ServR
 Q
rout(A) N rout S rout=$G(%BS(42),"%BSx"_$J),rout=$P(rout,"%BS",2,9) 
 S rout=A_rout X "ZR  ZS "_rout
 Q rout
KOLO ;условия на колонку по ОЧ
 S i2="K"_kk Q:'$D(@mas@(nf,na,i,i2))
 S nk=$G(@mas@(nf,na,i,i2,"4,4")) Q:nk=""  Q:'$$FOR^%ZAPM.bs.BSzmOL(kol,nk)  ;```MSW Q:kol'[nk
 Q:$G(@mas@(nf,na,i,i2,"8,4"))'=1  ;ОЧ
 D
 .I sN'="" D  Q   ;Выполнение условия на строку (если есть)
 ..S str=" ..."_$$POINT($G(Ur))_$S($D(@mas@(nf,na,i,i2,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(1,$G(^("2,4")))_" ",1:"")
 ..S @mas3@("r",ind)=str_"S:D("_nk_")=0 D("_nk_")="""" F sN="_sN_" S D("_nk_",sN)=$G(D("_nk_",sN),0)+"_$S($D(@mas@(nf,na,i,i2,"10,4")):$$PO^%ZAPM.bs.BSzvR1(1,$G(^("10,4"))),1:1),ind=ind+1
 .S @mas3@("r",ind)=" ..."_$$POINT($G(Ur))_$S($D(@mas@(nf,na,i,i2,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(1,$G(^("2,4")))_" ",1:"")_"S D("_nk_")=D("_nk_")+"_$S($D(@mas@(nf,na,i,i2,"10,4")):$$PO^%ZAPM.bs.BSzvR1(1,$G(^("10,4"))),1:1),ind=ind+1
 Q
POINT(I) I 'I Q ""  ;```
 Q $TR($J("",I)," ",".")
KOLOCC(i1) ;ДОПОЛНЕНИЕ ```MSW
 N Ur,CCC
KOLOC S Ur=$G(Ur)+1
 S @mas3@("r",ind)=" .."_$$POINT($G(Ur))_$S($D(@mas@(nf,na,i,i1,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(1,$G(^("2,4"))),1:"")_" D  ",ind=ind+1
 S sN=$G(@mas@(nf,na,i,i1,"6,4"))
 X "F kk="_$G(@mas@(nf,na,i,i1,"4,4"),0)_" D KOLO"
 S CCC="CC"_$TR($J("",Ur)," ","C")
 I $D(@mas@(nf,na,i,CCC_$P(i1,$E(CCC,2,99),2))) S i1=CCC_$P(i1,$E(CCC,2,99),2) G KOLOC
 Q
KOLL ;условия на колонку по ЛЧ
 S i2="K"_kk Q:'$D(@mas@(nf,na,i,i2))
 S nk=$G(@mas@(nf,na,i,i2,"4,4")) Q:nk=""  Q:'$$FOR^%ZAPM.bs.BSzmOL(kol,nk)  ;```MSW Q:kol'[nk
 Q:$G(@mas@(nf,na,i,i2,"8,4"))=1  ;ЛЧ
 D
 .I sN'="" D  Q   ;Выполнение условия на строку (если есть)
 ..S str=" ......"_$$POINT($G(Ur))_$S($D(@mas@(nf,na,i,i2,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(2,$G(^("2,4")))_" ",1:"")
 ..S str=str_$S($G(@mas@(nf,na,i,i2,"12,4"))="N":"I $G(L("_nk_"))'=1 ",1:"")
 ..S @mas3@("r",ind)=str_"S:D("_nk_")=0 D("_nk_")="""" S L("_nk_")=1 F sN="_sN_" S D("_nk_",sN)=$G(D("_nk_",sN),0)+"_$S($D(@mas@(nf,na,i,i2,"10,4")):$$PO^%ZAPM.bs.BSzvR1(2,$G(^("10,4"))),1:1),ind=ind+1
 .S @mas3@("r",ind)=" ......"_$$POINT($G(Ur))_$S($D(@mas@(nf,na,i,i2,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(2,$G(^("2,4")))_" ",1:"")_"S D("_nk_")=D("_nk_")+"_$S($D(@mas@(nf,na,i,i2,"10,4")):$$PO^%ZAPM.bs.BSzvR1(2,$G(^("10,4"))),1:1),ind=ind+1
 Q
KOLODD(i1) ;ДОПОЛНЕНИЕ ```MSW
 N Ur,CCC
KOLOD S Ur=$G(Ur)+1
 S @mas3@("r",ind)=" ....."_$$POINT($G(Ur))_$S($D(@mas@(nf,na,i,i1,"2,4")):"I "_$$PO^%ZAPM.bs.BSzvR1(2,$G(^("2,4"))),1:"")_" D  ",ind=ind+1
 S sN=$G(@mas@(nf,na,i,i1,"6,4"))
 X "F kk="_$G(@mas@(nf,na,i,i1,"4,4"),0)_" D KOLL" ;```На колонку
 I $D(@mas@(nf,na,i,"DD"_$E(i1,2,9))) D KOLODD("DD"_$E(i1,2,9)) ;```MSW
 S CCC="DD"_$TR($J("",Ur)," ","D")
 I $D(@mas@(nf,na,i,CCC_$P(i1,$E(CCC,2,99),2))) S i1=CCC_$P(i1,$E(CCC,2,99),2) G KOLOD
 Q
KEYS ;Перебор ключей с условиями
 K str,str1,str2,str3,strE,str4,kk,k
 I keyS'<1 D  Q:keyS=1
 .S str="B"_i_" S k1="""" F  S k1=$O(@mas@(k1)"_$$KEY^%ZAPM.bs.BSzvR1("k1")_"  X $G(WA)"
 .S @mas3@("r",ind)=str,ind=ind+1 Q
 S str1=" ",kk="=$O(@mas@(k1" F k=2:1:keyS D
 .S str1=str1_".",kk=kk_",k"_k
 .S str2="S k"_k_"="""""_$S($G(@mas@(nf,na,i,"k"_k,"11,4"))'="":" ",$G(@mas3@("zp","k"_k,7))'="":" ",1:" F  S k"_k_kk_")")
 .S:mtb="Y"&(k=keyS) str3="S k"_k_"="_keyO     ;По О.Ч. документа
 .S str4=$$KEY^%ZAPM.bs.BSzvR1("k"_k)
 .S str=str1_$S($G(str3)'="":str3,1:str2)_$S($G(str3)'="":$E(str4,2,450),1:str4)
 .S strE=str2_str4,strE=$P(strE,"D C"_i)_" I k"_k_"'="_keyO_" D  "
 .S @mas3@("r",ind)=str,ind=ind+1
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzvR1" type="MAC" languagemode="0"><![CDATA[
%BSzvR1 ;Компоненты создания прогры сводки  (А.Тимофеев) ; 13:38   19.04.2000
 
KEY(%1) ;Вытаскивание условий на ключи БД
 S %0="" N f,u
 S f=$S($G(@mas@(nf,na,i,%1,"11,4"))'="":^("11,4"),$G(@mas3@("zp",%1,7))'="":^(7),1:"")
 I f'="" S f=$S(f'=+f:f,1:"$E("_%1_",1,"_$L(f)_")="_f)
 S u=$S($G(@mas@(nf,na,i,%1,"9,4"))'="":^("9,4"),$G(@mas3@("zp",%1,6))'="":^(6),1:"")
 I u'="" S u=$S(u'=+u:u,1:"$E("_%1_",1,"_$L(u)_")="_u)
 S %0=$S($G(f)'="":" S "_f_" ",1:$S($G(@mas@(nf,na,i,%1,"7,4"))="Y":",-1",1:"")_") Q:"_%1_"=""""  ")
 S %0=%0_$S($G(u)'="":"I "_u,1:"")
 S %0=%0_" D "_$S(keyS=$E(%1,2):"C"_i,1:" ")
 I $D(@mas@(nf,na,i,%1)) S %0=%0_$S($G(@mas@(nf,na,i,%1,"3,4"))'="Y":" Q  ",1:"")
 Q %0
 
KEYL(%1) ;Конкректное кол-во ключей
 N k,str
 S %0=""
 S str="(" F k=1:1:keyS S str=str_$S(k=1:"k"_k,1:",k"_k)
 S %0=str_")" Q %0
 
PO(%1,%2,%3,%4,%5) ;Конкректные адреса в БД
 ;%1 (1 - Только по О.Ч., 2 - Смешанное условие или Л.Ч.)
 ;%2 - программная строка
 ;%3 - Полная глобальная ссылка на таблицу БД с О.Ч.
 ;%4 - Полная глобальная ссылка на таблицу БД с Л.Ч.
 ;%5 - Условие мультитаблицы (1)
 I %2["|" S %2=$TR(%2,"|","@")
 S:$G(%3)'="" tabO=%3 S:$G(%4)'="" tabO=%4 S:$G(%5)'="" mtb="Y"
 N y,x,str1,str2,str3,TAB
 S %0=%2 I %1=""!(%2="") Q %0
PO1 I %2'["{" S %0=%2 D:%2["^("  Q %0
 .F y=2:1 S str1=$P(%2,"^(",y) Q:str1=""  D
 ..S str2=$P(str1,")"),$P(str1,")")=str2_")"
 ..S $P(%2,"^(",y)=str1
 .S %2=$$TR^%ZAPM.bs.BSsFUNM(%2,"^(","$G(@masR@(") K y,str1,str2 S %0=%2
 I %1=1 S TAB=tabO D  G PO1   ;Для условия только по О.Ч.
 .S str1=$P(%2,"{"),str2=$P($P(%2,"{",2),"}"),str3=$E(%2,($L(str1)+$L(str2)+3),$L(%2))
 .S y=$P(str2,","),x=$P(str2,",",2)
 .D  S %2=str1_str2_str3
 ..I $P($P($G(@TAB@(y,x)),"@",18),"#")'="" S str2=$P($P($G(@TAB@(y,x)),"@",18),"#") Q
 ..S str2=y_","_x Q
 I %1=2 S TAB=tabO D          ;Для совместного условия по О.Ч.
 .I %2'["P(""{" Q
 .S str1=$P(%2,"P(""{"),str2=$P($P(%2,"P(""{",2),"}"),str3=$E(%2,($L(str1)+$L(str2)+6),$L(%2))
 .S y=$P(str2,","),x=$P(str2,",",2)
 .D  S %2=str1_"P("""_str2_str3
 ..I $P($P($G(@TAB@(y,x)),"@",18),"#")'="" S str2=$P($P($G(@TAB@(y,x)),"@",18),"#") Q
 ..S str2=y_","_x Q
 S TAB=$S(mtb="Y":tabL,1:tabO) D  G PO1    ;Для совместного по Л.Ч. или по О.Ч.
 .I %2'["^(""{" Q
 .S str1=$P(%2,"^(""{"),str2=$P($P(%2,"^(""{",2),"}"),str3=$E(%2,($L(str1)+$L(str2)+6),$L(%2))
 .S y=$P(str2,","),x=$P(str2,",",2)
 .D  S %2=str1_"^("""_str2_str3
 ..I $P($P($G(@TAB@(y,x)),"@",18),"#")'="" S str2=$P($P($G(@TAB@(y,x)),"@",18),"#") Q
 ..S str2=y_","_x Q
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzvT" type="MAC" languagemode="0"><![CDATA[
%BSzvT ;Формирование таблицы сводки  (А.Тимофеев) ; 13:44   09.11.2001
 N masI,masT,name,C1,i,i1,i2,i3,i4,i5,i6,y,y1,strS,strC,strC1,strC2,strP,strP2,kolT,kolP,kolPGN,adr,uslS,prg,yt,xt,ROU
 N NaMe,NaPr,I,CurSTR,FormSTR,HEAD,TItuL,YYy,ROU
 S %zT=$ZT,$ZT="ERROR^%ZAPM.bs.BSzvU"
 S NaMe=$G(@mas0@("tab",4),"?UNKNKOW") ;БАЗОВОЕ ИМЯ СВОДКИ
 S NaPr=$$cB^%ZAPM.bs.BSSV I $G(@mas0@("tabE",3))'="" S NaPr=@mas0@("tabE",3) ;ИМЯ РАЗДЕЛА
 S masI=$NA(@NaPr@($$NamePack^%ZAPM.bs.BSzZ()_NaMe)) ;masI - ИМЯ НАСЧИТАННОЙ СВОДКИ
 I PACET'=0 I $D(@masI) K @masI
 I PACET=0 D  ;ФОРМИРОВАНИЕ ИМЕНИ СВОДКИ
 .I "Y"[$G(@mas0@("tabE",4)) D  Q
 ..F I=1:1 I '$D(@NaPr@(NaMe_"_"_$$SYSDATE^%ZAPM.bs.BSsFUNR(6,$$h^%ZAPM.bs.BS3())_"_"_I)) S masI=$ZR Q
 .I $D(@masI) S masI=$NA(@NaPr@(NaMe_"."_$P($$h^%ZAPM.bs.BS3,",",2)))
 
 S CurSTR=1 ;ТЕКУЩАЯ СТРОКА СВОДКИ
 S masT=$G(@mas0@("tab",3)) ;masT - ИМЯ ШАБЛОНА
 S (nameS,name)=$G(^(2)) ;КОМЕНТАРИЙ
 S strS=$G(^(7)) ;ШАПКА
 S strC=$G(^(8)) ;ЦИКЛ
 S strC1=$G(^(9)) ;ВЫДЕЛЕНИЕ
 S strC2=$G(^(10)) ;ВЫДЕЛЕНИЕ ВЫДЕЛЕННОЕ
 S strP=$G(^(11))  ;ПОДВАЛ
 S kolI=$G(^(12))  ;ВЫБРАННЫЕ КОЛОНКИ
 S strP2=$G(^(13)) ;СТРОКИ ВЫДЕЛЯТЬ ВЫДЕЛЕННЫМ РАЗДЕЛИТЕЛЕМ 1,2,,,y,
 S kolT=$G(^(14))  ;КОЛОНКА БОКОВИНЫ
 S kolP=$G(^(15))  ;КОЛОНКА ПЕРИОДОВ СРАВНЕНИЯ
 S adr=$G(^(16)) ;АДРЕС УГЛА
 S BSr=$P(masI,"("),BSt=$TR($P($P(masI,"(",2),")"),$C(34),"")
 S ls="Формируется таблица сводки" D WAITS^%ZAPM.bs.BSF2
 S @masI=$G(@masT)
 
 I kolI'="" D Nshab  ;Создание НОВОЙ таблицы-шаблона
 
 S kolPGN=$G(@mas0@("tabE",14)) ;В КОЛОНКЕ ПЕРИОДОВ СРАВНЕНИЯ ГОД или НОМЕР G\N
 
 ;строка (название) ЗАГОЛОВОК
 I $G(@mas0@("tabE",2))'="" S name=@mas0@("tabE",2)
 I name["~" F I=1:1 Q:$P(name,"~",I,I+1)=""  S $P(name,"~",I)=$$EXT^%ZAPM.bs.BSzmOL($P(name,"~",I)) D ADDHEAD($P(name,"~",I))
 I name'["~" S name=$$EXT^%ZAPM.bs.BSzmOL(name) D ADDHEAD(name)
 S @masI@("PERHEAD")=$$HEAD^%ZAPM.bs.BSzmOL(name)
 
 ;строка с условиями
 S uslS="" S k="" F  S k=$O(@mas0@("zp",k)) Q:k=""  D  X $G(WA)
 .I $G(@mas0@("zp",k,1))'="" S uslS=uslS_" "_$G(^(1)) Q
 I $TR(uslS," ","")'="" D ADDHEAD(uslS)
 
 ;ПЕРИОДЫ СРАВНЕНИЯ
 I $G(@mas0@("tabE",5))'="" I $D(G1) s Form=$G(@mas0@("tabE",5)) D
 .F C1=1:1:C I $D(G1(C1)),G1(C1)'=0 D
 ..N i6
 ..i Form="Y" S i6=C1_" ПЕРИОД : С "_$$D^%ZAPM.bs.BSsFUNR($G(G1(C1)))_"."_$$M^%ZAPM.bs.BSsFUNR($G(G1(C1)))_"."_$$Y^%ZAPM.bs.BSsFUNR($G(G1(C1)))_" ПО "_$$D^%ZAPM.bs.BSsFUNR($G(G2(C1)))_"."_$$M^%ZAPM.bs.BSsFUNR($G(G2(C1)))_"."_$$Y^%ZAPM.bs.BSsFUNR($G(G2(C1)))
 ..i "YN"'[Form x "s i6="_Form
 ..D ADDHEAD(i6) S @masI@("PER",C1)=i6
 
 ;ДАТА - ВРЕМЯ СОЗДАНИЯ
 I $G(@mas0@("tabE",9))="Y" D
 .N i6 S i6="ВЫДАНО: "_$$ESDAY^%ZAPM.bs.BSsFUNR(7,$$h^%ZAPM.bs.BS3())
 .I $G(@mas0@("tabE",10))="Y" S i6=i6_" КОД ИСПОЛНИТЕЛЯ:"_$G(%BS(12),"АДМ")
 .I $G(@mas0@("tabE",12))="Y" S i6=i6_" КОД СВОДКИ:"_$G(NaMe)
 .D ADDHEAD(i6)
 
 ;ШТАМПИК
 I $G(@mas0@("tabE",7))'="" D
 .N N,LONG,KOLS,XX
 .S N=@$ZR I $$Data^%ZAPM.bs.BSF12(N) D
 ..S LONG=+$P($G(@masT@("PRN")),"#",2),KOLS=$P(@N,"@",28),XX=$O(@masT@(1,""),-1),XX=$P(@masT@(1,XX),"@",2)+$P(@masT@(1,XX),"@",4)
 ..I LONG>XX S LONG=XX
 ..I +$G(@mas0@("tabE",8)) S LONG=$G(@mas0@("tabE",8))+$L($G(@N@(1)))
 ..I 'LONG S LONG=$$MAXHEAD()+$L($G(@N@(1)))+3
 ..D BUILD(LONG-$L($G(@N@(1)))-2,KOLS)
 
 F CurSTR=1:1 Q:'$D(HEAD(CurSTR))  D COPYLINE(CurSTR,HEAD(CurSTR))
 
 S $P(@BSr@(BSt,"ExcelOut"),",",3)=CurSTR
 ;СКРЫТАЯ СТРОКА С ФОРМУЛАМИ
 S (FormSTR,y1)=CurSTR,y=y1-1  ;скрытая строка с формулами
 S x=1,i="" F  S i=$O(@masT@(strC,i)) Q:i=""  D  X $G(WA)
 .S @masI@(y1,i)=$G(@masT@(strC,i))
 .S:$D(@masT@("FCL",strC,i)) @masI@("FCL",y1,i)=$G(@masT@("FCL",strC,i)),@masI@("FCL",y1,i,1)=$G(@masT@("FCL",strC,i,1))
 .S:$D(@masT@("FTR",strC,i)) @masI@("FTR",y1,i)=$G(@masT@("FTR",strC,i)),@masI@("FTR",y1,i,1)=$G(@masT@("FTR",strC,i,1))
 .S $P(@masI@(y1,i),"@")=2,$P(^(i),"@",3)=0
 S CurSTR=CurSTR+1
 
 ;Строки шапки таблицы
 S x=1,i="" F  S i=$O(@masT@(strC,i)) Q:i=""  D  X $G(WA)
 .S y1=CurSTR,y=y1-1
 .X "F i1="_strS_" D STRh1"
 S CurSTR=y1
 S i="" F  S i=$O(@mas0@("bok",i)) Q:i=""  D STRp  X $G(WA) ;ТЕКСТЫ БОКОВИНЫ
 
 I $G(strP)'="" X "F i="_strP_" D STRz"
 
 ;ТИТУЛ ПЕЧАТИ```MSW
 S $P(@masI,"@",50)=CurSTR_","_$S($G(kolP)'="":(kolP+2),1:(kolT+2))
 S TItuL="" I +$G(@mas0@("tabE",11)) S TItuL=@$ZR
 I $P(@masI,"@",19),$P(@masI,"@",19)<$G(TItuL) S $P(TItuL,",")=$P($P(@masI,"@",19),",")
 I $P(@masI,"@",19),'$G(TItuL) S TItuL=$P(@masI,"@",19)
 S $P(@masI,"@",19)=""
 
 S $P(@masI,"@",32)=1 ;ПЕРЕСЧИТЫВАТЬ ФОРМУЛЫ ВО ВСЕХ КЛЕТКАХ
 ;Установки на вывод
 F prg="PRN","HFS","TXT","SHR","SVM","RSM" D
 .I $D(@masT@(prg)) S @masI@(prg)=$G(@masT@(prg))
 
 S @masI@("PER")=C ;ПЕРИОДЫ СРАВНЕНИЯ
 S @masI@("PERDATE")=$$ESDAY^%ZAPM.bs.BSsFUNR(7,$$h^%ZAPM.bs.BS3())
 S @masI@("PERUSER")=$G(%BS(12))
 S $P(@masI@("ExcelOut"),",",1)=$G(@mas0@("tabE",15)) ;информация для экспорта в Excel - Кол-во строк шапки после разбора
 S @masI@("LST")=$H_","_$G(%BS(12))_",Greated"
 
 N BSR,BST,ke,se S BSR=BSr,BST=BSt,se=$P(@masI,"@",28),ke=$P(@masI,"@",29) D TAB^%ZAPM.bs.BSF1 K BSR,BST ;```MSW
 
 D TPr^%ZAPM.bs.BSF8(masI) ;ТИТУЛ ПРОСМОТРА
 I '$P(@masI,"@",19),TItuL S YYy=FormSTR+1+TItuL-strS,TItuL=+$P(TItuL,",",2) I YYy,TItuL,($P($G(@masI@(YYy,TItuL)),"@")+$P($G(@masI@(YYy,TItuL)),"@",3))'>20 S $P(@masI,"@",19)=YYy_","_TItuL
 
 I $G(@mas0@("tabE",21))'="" S ROU=@mas0@("tabE",21) X $S($E(ROU)="^":"D ",1:"")_ROU
 S $P(@masI,"@")=C_";"_($P($$h^%ZAPM.bs.BS3,",",2)-Total)_" сек. "_$G(nameS,name)
 I $P(@masI,"@",51) D APRESS^%ZAPM.bs.BSSR(masI)
 I PACET=0 S IYI=masI D NE^%ZAPM.bs.BSN
 S $ZT=%zT,BSl=masI
 Q
BUILD(L,K) ;ДОСТРОИТЬ К ЗАГОЛОВКУ ШТАМПИК
 F I=1:1:K S:'$D(HEAD(I)) HEAD(I)="" S HEAD(I)=$E(HEAD(I),1,L),HEAD(I)=HEAD(I)_$J("",L-$L(HEAD(I)))_" "_$G(@N@(I))
 Q
ADDHEAD(S) S HEAD(CurSTR)=S,CurSTR=CurSTR+1
 Q
COPYLINE(Y,name) ;КОПИРОВАТЬ СТРОКУ СВОДКУ
 N x,i
 S x=1,i="" F  S i=$O(@masT@(strC,i)) Q:i=""  D  X $G(WA)
 .S @masI@(Y,i)=$G(@masT@(strC,i))
 .S $P(@masI@(Y,i),"@",15)=$E(name,x,(x+$P(@masT@(strC,i),"@",4)-1))
 .S $P(@masI@(Y,i),"@",3)=1,x=x+$P(@masT@(strC,i),"@",4)
 .S $P(@masI@(Y,i),"@",7)="",$P(@masI@(Y,i),"@",8)=""
 Q
STRh1 ;ШАПКА
 S @masI@(y1,i)=$G(@masT@(i1,i))
 I $G(adr)'="",$G(@mas0@("tabE",5))'="Y" I $P($P(adr,","),"{",2)=i1&($P($P(adr,",",2),"}")=i) D STRh2
 S $P(@masI@(y1,i),"@")=y,y1=y1+1,y=y+$P(@masT@(i1,i),"@",3)
 Q
STRh2 ;Клетка с периодами сравнения
 S i6="",i5=$P(@masI@(y1,i),"@",15) F C1=1:1:($P(^(i),"@",3)-2) D
 .S i6=i6_$J($E($S($G(G1(C1))'="":"С  ",1:"   ")_$$D^%ZAPM.bs.BSsFUNR($G(G1(C1)))_$$M^%ZAPM.bs.BSsFUNR($G(G1(C1)))_$$Y^%ZAPM.bs.BSsFUNR($G(G1(C1))),1,$P(^(i),"@",4)),$P(^(i),"@",4))
 .S i6=i6_$J($E($S($G(G2(C1))'="":"ПО ",1:"   ")_$$D^%ZAPM.bs.BSsFUNR($G(G2(C1)))_$$M^%ZAPM.bs.BSsFUNR($G(G2(C1)))_$$Y^%ZAPM.bs.BSsFUNR($G(G2(C1))),1,$P(^(i),"@",4)),$P(^(i),"@",4))
 S i6=$E(i6,1,$P(^(i),"@",4)*($P(^(i),"@",3)-2))_$J("",$P(^(i),"@",4)*($P(^(i),"@",3)-2)-$L(i6))
 S $P(^(i),"@",15)=$E(i5,1,$P(^(i),"@",4))_i6_$E(i5,($P(^(i),"@",3)-1*$P(^(i),"@",4))+1,$L(i5))
 Q
 
STRp ;Строки цикла
 F C1=1:1:C D STRp1
 D STRp3
 Q
STRp1 ;
 S i1="" F  S i1=$O(@masT@(strC,i1)) Q:i1=""  D STRp2
 S y1=y1+1,y=y+$P(@masT@(strC,1),"@",3)
 Q
STRp2 ;
 S i2=((i-1)*C)+C1
 S @masI@(y1,i1)=$G(@masT@(strC,i1))
 I i1=kolT D        ;Текст боковины
 .I $G(@mas0@("bok",i))="#" S $P(@masI@(y1,i1),"@",15)="!!!" Q
 .I $P($G(@mas0@("bok",i)),"#")'="" S $P(@masI@(y1,i1),"@",15)=$E($P($G(@mas0@("bok",i)),"#"),1+($P(@masT@(strC,i1),"@",4)*(C1-1)),($P(@masT@(strC,i1),"@",4)*C1)) Q
 .I $P($G(@mas0@("bok",i)),"#",2)="" Q
 .I C1'=1 Q
 .S $P(@masI@(y1,i1),"@",15)=$P($G(@mas0@("bok",i)),"#",2) Q
 I i1=kolP D        ;Период насчета
 .I $G(kolPGN)="N" S $P(@masI@(y1,i1),"@",15)=C1
 .E  S $P(@masI@(y1,i1),"@",15)=$$YY^%ZAPM.bs.BSsFUNR(G2(C1))
 .I $P(@masI@(y1,i1),"@",15)=0 S $P(@masI@(y1,i1),"@",15)=""
 I kolI'="" D
 .S iN1=$P(@masT@(strC,i1),"@",17) I iN1'="" S:$D(@mas1@(i2,iN1))&($G(^(iN1))'=0) $P(@masI@(y1,i1),"@",15)=$G(@mas1@(i2,iN1))
 I kolI="" S:$D(@mas1@(i2,i1))&($G(^(i1))'=0) $P(@masI@(y1,i1),"@",15)=$G(@mas1@(i2,i1))
 S:$P(@masI@(y1,i1),"@",7)'="" $P(^(i1),"@",7)=FormSTR_","_i1
 S:$P(@masI@(y1,i1),"@",8)'="" $P(^(i1),"@",8)=FormSTR_","_i1
 S $P(@masI@(y1,i1),"@")=y
 Q
STRp3 ;Подчеркивание и выделение
 I $G(strC1)="" Q
 S i6=0 D                  ;Выделение
 .I $G(strC2)=""!($G(strP2)="") Q
 .F i4=1:1 S i5=$P(strP2,",",i4) Q:i5=""  S:i5=i!(i5=(i+1)) i6=1 Q:i6=1
 S i1="" F  S i1=$O(@masT@(strC,i1)) Q:i1=""  D
 .S @masI@(y1,i1)=$S(i6=1:$G(@masT@(strC2,i1)),1:$G(@masT@(strC1,i1)))
 .S $P(@masI@(y1,i1),"@")=y
 S y1=y1+1,y=y+$P(@masT@(strC1,1),"@",3)
 Q
 
STRz ;Строки подвала
 S i1="" F  S i1=$O(@masT@(strC,i1)) Q:i1=""  D
 .S @masI@(y1,i1)=$G(@masT@(i,i1))
 .S $P(@masI@(y1,i1),"@")=y
 S y1=y1+1,y=y+$P(@masT@(strC1,1),"@",3)
 Q
 
Nshab ;Создание новой таблицы-шаблона
 S:$E(kolI,1)'=1 kolI="1:1:"_$S(kolP'="":kolP+1,kolT'="":kolT+1,1:1)_","_kolI
 S masI1=masI,masI="^%ZAPM.bs.BSbufB(""fTS""_$G(%BS(3),$P)_$J_""u"")" K @masI
 S (x,x1)=1 X "F i="_kolI_" D STRN"
 F prg="PRN","HFS","TXT","SHR","SVM","RSM" D
 .I $D(@masT@(prg)) S @masI@(prg)=$G(@masT@(prg))
 S masT=masI,masI=masI1
 Q
STRN ;Строки таблицы
 S strNT=$O(@masT@(10000),-1),strNT="1:1:"_strNT
 S y1=1,y=1 X "F i1="_strNT_" D STRN1"
 S x1=x1+1,x=x+$P(@masT@(i1,i),"@",4)
 Q
STRN1 ;
 S @masI@(y1,x1)=$G(@masT@(i1,i)) X $G(WA)
 S:$D(@masT@("FCL",i1,i)) @masI@("FCL",y1,x1)=$G(@masT@("FCL",i1,i)),@masI@("FCL",y1,x1,1)=$G(@masT@("FCL",i1,i,1))
 S:$D(@masT@("FTR",i1,i)) @masI@("FTR",y1,x1)=$G(@masT@("FTR",i1,i)),@masI@("FTR",y1,x1,1)=$G(@masT@("FTR",i1,i,1))
 S $P(@masI@(y1,x1),"@",2)=x,$P(@masI@(y1,x1),"@",1)=y
 S:i1=strC $P(@masI@(y1,x1),"@",17)=i   ;Номер колонки из насчета
 S y1=y1+1,y=y+$P(@masT@(i1,i),"@",3)
 Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzvU" type="MAC" languagemode="0"><![CDATA[
%BSzvU ;Загрузка условий для сводки  (А.Тимофеев) ; 14:16   15.04.2003
 G LOAD1
LOAD(%1,%2,%3) ;Выполнение с параметрами (%1- имя сводки, %2'="" - выполнение без загрузки запросов на ключи !, %3'="" - как пакет !)
LOAD1 K ^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u") S PACET=0    ;Загрузка условий
 ;mas- БД условий, mas1- БД запросов, mas2- БД боковин, mas3 - буфер (^%ZAPM.bs.BSbufB("PO"_$G(%BS(3),$P)_$J_"u"))
 ;выходные переменные: C,G1(C),G2(C),nf,na,uslL
 N i,i1,i2,i3,i4,i5,C1,STOP,unL,BSr,BSt,cHOSe
 S mas=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVm2"))),mas1=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVz1"))),mas2=$$KBD^%ZAPM.bs.BSF12($NA(^%ZAPM.bs.BSZ("SVb1")))
 S mas3="^%ZAPM.bs.BSbufB(""PO""_$G(%BS(3),$P)_$J_""u"")",mas4="^%ZAPM.bs.BSbufB(""fTS""_$G(%BS(3),$P)_$J_""u"")",mas5="^%ZAPM.bs.BSbufB(""W""_$G(%BS(3),$P)_$J_""u"")"     ;Буфера
 S %zT=$ZT,$ZT="ERROR" S @mas3="Буфер насчета сводки"
 I $G(%1)'="" S i=%1 S:$G(%2)'="" unL=1 S:$G(%3)'="" PACET=1 G 1
 K C,G1,G2,bok S i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVa1)","1#2#2",2)
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 
1 ;Загрузка общих условий
 S na=$P(i,"~") I na="" D ErrMsg^%ZAPM.bs.BSXfun("НЕ ВЫБРАНА АНАЛИТИЧЕСКАЯ ФОРМА !!") S $ZT=%zT Q
 S nf=$E(na,1,3)
 I '$D(@mas@(nf,na))!('$D(@mas@(nf,na,0))) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЙ НА ФОРМУ !! "_$NA(@mas@(nf,na))) S $ZT=%zT Q
 S zp=$G(@mas@(nf,na,"0","5,4")) I zp="" D ErrMsg^%ZAPM.bs.BSXfun("НЕТ УСЛОВИЯ НА ЗАПРОС !!") S $ZT=%zT Q
 I '$D(@mas1@(zp)) D ErrMsg^%ZAPM.bs.BSXfun("ЗАПРОСА "_zp_" НЕТ") S $ZT=%zT Q
 G:$G(unL)=1 3    ;Без загрузки запросов (!!!)
 
2 ;Загрузка периодов сравнения
 S STOP="",i=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVz0)","4#1#20",2)
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S $ZT=%zT Q
 S C=$P(i,"~",2) I C="" S $ZT=%zT Q
 F C1=1:1:C S G1(C1)=$P(i,"~",(2*C1+1)),G2(C1)=$P(i,"~",(2*C1+2))
 I G1(C)=""!(G2(C)="") K G1,G2
 
3 ;Загрузка запросов в буфер
 S @mas3@("zp")="Условия на ключи БД"
 F i1=0:1:11 S i2="k"_i1,i3=i1+2 D
 .F i4=2:1:7 S i5=i3_","_i4 I $G(@mas1@(zp,"O",i5))'="" S @mas3@("zp",i2,i4)=$G(@mas1@(zp,"O",i5))
 I $G(unL)=1 S ls="Понеслись !!" D WAITS^%ZAPM.bs.BSF2 D B^%ZAPM.bs.BSzvUB G 9
 
4 ;Загрузка запросов на ключи
 S (i,STOP)="" F  S i=$O(@mas3@("zp",i)) Q:i=""  S i1=$E(i,2,3) D  G:STOP=1 2
 .I $G(@mas3@("zp",i,3))="Y" I $D(@mas1@(zp,i1)) D 5
 Q:STOP=1  G 7
 
5 ;Загрузка стандартного запроса на ключ
 N adr,tab,ind,ind1
 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVz3)",2,1,"","6^%ZAPM.bs.BSzvU") Q:A=""
 S adr=$P(%BS("Tmp","LastTabl"),"@"),tab=$P(%BS("Tmp","LastTabl"),"@",4)
 I tab=27 S STOP=1 Q
 I $P(adr,",")>3 S ind=$P(adr,","),ind1=$P(adr,",",2) I $D(@mas5@(ind,ind1)) D  Q
 .S @mas3@("zp",i,1)=$G(@mas5@(ind,1))
 .S @mas3@("zp",i,6)=$G(@mas5@(ind,2))
 S @mas3@("zp",i,4)=$G(@mas5@(3,1))
 S @mas3@("zp",i,5)=$G(@mas5@(3,2))
 I $E(i,2,3)<10 S @mas3@("zp",i,6)=$$LOGIKA^%ZAPM.bs.BSzlU(i)
 Q
6 ;Копирование данных из БД по запросу на ключ
 S $P(@mas4@(1,1),"@",15)=$G(@mas1@(zp,i1,"1,2"))
 S $P(@mas4@(3,1),"@",15)=$G(@mas3@("zp",i,4))
 S $P(@mas4@(3,2),"@",15)=$G(@mas3@("zp",i,5))
 F i2=5:1:65 S i3=(i2-2)_",1",i4=(i2-2)_",2" D
 .S $P(@mas4@(i2,1),"@",15)=$G(@mas1@(zp,i1,i3),"")
 .S $P(@mas4@(i2,2),"@",15)=$G(@mas1@(zp,i1,i4),"")
 Q
 
7 ;Запрос на боковину
 K @mas5
 S bok=$G(@mas@(nf,na,0,"18,4")),uslL=""
 I $G(@mas@(nf,na,0,"19,4"))="" G 8
 S ls="Используем стандартную боковину?",%B=1 D YES^%ZAPM.bs.BSF I YES'=1 D
 .S start=$G(@mas@(nf,na,0,"19,4")) X $S($E(start)="^":"D ",1:"")_start
8 ;"Стандартная" боковина
 I bok="" D  G:bok'="" GOBOK ;Выбор боковины из "стандартных"
 .S bok=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVb)","1#2#2",2)
 .S tab=$P(%BS("Tmp","LastTabl"),"@",4)
 .I tab=27 D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ВЫБОРА !!") S bok="" Q
 .S bok=$P(bok,"~") I bok="" D ErrMsg^%ZAPM.bs.BSXfun("НЕ ВЫБРАНО УСЛОВИЕ !!") Q
 .I '$D(@mas2@(bok)) D ErrMsg^%ZAPM.bs.BSXfun("НЕТ ТАКОЙ БОКОВИНЫ !!"_bok) S bok="" Q
 I $G(@mas@(nf,na,"00","18,4"))'="" S bok=$$CHOBOK(@$ZR)
 I bok="" G STOP
GOBOK S uslL=$G(@mas2@(bok,0,"2,4"))
 S ls="Уточняем боковину?",%B=2 D YES^%ZAPM.bs.BSF I YES=1 D ^%ZAPM.bs.BSzvUB
 S ls="Понеслись !!" D WAITS^%ZAPM.bs.BSF2 D B^%ZAPM.bs.BSzvUB
 
9 ;Загрузка информации по шаблону
 K @mas3@("tab") S @mas3@("tab")="Элементы шаблона"
 F i=2,4,7:1:12,14,15,16 S i1=i_","_4 D
 .S @mas3@("tab",i)=$G(@mas@(nf,na,0,i1))
 S @mas3@("tab",13)=$P($G(@mas3@("bok")),$P($G(@mas3@("bok")),",")_",",2)
 S @mas3@("tab",3)=$G(@mas@(nf,na,0,"pgs"))
 I $G(@mas3@("tab",3))=""!($G(^(7))="")!($G(^(8))="")!($G(^(14))="") G STOP
 ;
 K @mas3@("tabE") S @mas3@("tabE")="Элементы шаблона ДОПОЛНИТЕЛЬНЫЕ (MSW)"
 F i=2:1:5,8:1:12,14:1:16,18,19,21 S i1=i_","_4 D
 .I $G(@mas@(nf,na,"00",i1))'="" S @mas3@("tabE",i)=@mas@(nf,na,"00",i1)
 S @mas3@("tabE",7)=$G(@mas@(nf,na,"00","sec"))
 K @mas3@("r"),@mas3@("n") S @mas3@("r")="Программа насчета"
 G ^%ZAPM.bs.BSzvR
CHOBOK(P) ;ВЫБОР БОКОВИН ИЗ ДОПУСТИМЫХ
 N BSr,BSt,i,I,II,III,se,ke,tIT,Fk,Obraz,Ob,CReATe,j,cl,YES
 D TempT^%ZAPM.bs.BSTT
 I bok'="" D TempTX^%ZAPM.bs.BSTT($$CHOSET(bok)_"(ПО-УМОЛЧАНИЮ)")
 X "F I="_P_" I I'="""" D TempTX^%ZAPM.bs.BSTT($$CHOSET(I))"
 D TempTXT^%ZAPM.bs.BSTT("Выберите Доступные Боковины",$G(@%BS(20)@("ErrorTXT")))
 D ^%ZAPM.bs.BSX("TEXT",BSr,BSt) G:YES<1 CHOBOKE
 I $G(@BSr@(BSt,YES))["<UNDEF>" G CHOBOKE
 S III=@$ZR D TempTXDE^%ZAPM.bs.BSTT Q $P(III," ")
CHOBOKE D TempTXDE^%ZAPM.bs.BSTT Q ""
CHOSET(B) ;БОКОВИНА
 I '$D(@mas2@(B)) Q B_" ;??? БОКОВИНА НЕОПРЕДЕЛЕНА !! <UNDEF>"
 Q B_" ;"_$G(@mas2@(B,0,"4,4"),"???")
ERROR ;
 I $ZE["INRPT" D ErrMsg^%ZAPM.bs.BSXfun("ПРЕРВАНО С ТЕРМИНАЛА !!") S STOP=1,$ZT=%zT Q
 I $ZE["<NOSYS"!($ZE["<NAMESPACE") D ErrMsg^%ZAPM.bs.BSXfun("НЕ ДОСТУПНА БАЗА ДАННЫХ !!") S $ZT=%zT Q
 D ErrMsg^%ZAPM.bs.BSXfun("Ошибка ! "_$ZE_" "_$$ErrSay^%ZAPM.bs.BSF8($ZE)) S $ZT=$G(%zT) Q
 Q
STOP ;
 S $ZT=%zT D ErrMsg^%ZAPM.bs.BSXfun("Некорректно сформулированы условия !!!") Q
 ;D ErrMsg^%ZAPM.bs.BSXfun("ОТКАЗ ОТ ЗАПРОСА !!") S $ZT=%zT Q
]]></Routine>


<Routine name="%ZAPM.bs.BSzvUB" type="MAC" languagemode="0"><![CDATA[
%BSzvUB ;Уточнение "стандартной" боковины  (А.Тимофеев) ; 10:37   27.09.2000
 ;Загрузка "стандартной" боковины
 N i
 S A=$$LOAD^%ZAPM.bs.BSscrF("^%ZAPM.bs.BSZ(SVb3)",1,1,"","1^%ZAPM.bs.BSzvUB") Q:A=""
 Q
1 ;Копирование данных из "стандартной" боковины
 S i=0,i1=2 F  S i=$O(@mas2@(bok,i)) Q:i=""  D  S i1=i1+1
 .I i1=2 S $P(@mas4@(2,1),"@",15)=i Q
 .S @mas4@(i1,1)=@mas4@(2,1)
 .S $P(@mas4@(i1,1),"@")=i1+1
 .S $P(@mas4@(i1,1),"@",15)=i
 .S @mas4@("FTR",i1,1)=@mas4@("FTR",2,1)
 .S @mas4@("FTR",i1,1,1)=@mas4@("FTR",2,1,1) Q
 S $P(@mas4@(1,1),"@",15)=bok
 S $P(@mas4,"@",28)=i1
 Q
 
B ;Сброс в буфер
 N i,i1,i2,i3,i4,met,mtbd,LABEL
 K @mas3@("bk"),@mas3@("bok"),@mas3@("bokE") S (@mas3@("bk"),@mas3@("bok"))="Элементы боковины",@mas3@("bokE")=$NA(@mas2@(bok))
 I $D(@mas5) D  D B1(1) Q                                           ;"Уточненная"
 .S i=0,i1=1 F  S i=$O(@mas5@(i)) Q:i=""  D  S i1=i1+1
 ..S i2=$G(@mas5@(i,1))
 ..S @mas3@("bk",i1)=$$STR(i2,1),@mas3@("bok",i1)=$G(@mas2@(bok,i2,"2,1"))
 ..I $G(@mas2@(bok,i2,"2,5"))="Y" S @mas3@("bok")=$G(@mas3@("bok"))_","_i1
 ..I $G(@mas2@(bok,i2,"2,6"))'="" S @mas3@("bokE",i1)=$G(@mas2@(bok,i2,"2,6"))
 S i=0,i1=1 F  S i=$O(@mas2@(bok,i)) Q:i=""  D   S i1=i1+1      ;"Стандартная"
 .S @mas3@("bk",i1)=$$STR(i),@mas3@("bok",i1)=$G(@mas2@(bok,i,"2,1"))
 .I $G(@mas2@(bok,i,"2,5"))="Y" S @mas3@("bok")=$G(@mas3@("bok"))_","_i1
 .I $G(@mas2@(bok,i,"2,6"))'="" S @mas3@("bokE",i1)=$G(@mas2@(bok,i,"2,6"))
 D B1(0)
 Q
B1(FLAG) S i="" F  S i=$O(@mas3@("bk",i)) Q:i=""  D  S @mas3@("bk",i)=str
 .S str=@mas3@("bk",i),met=$P($P(str," G:$T(",2),")") I met="" Q
 .I $D(LABEL(met)) S str=$P(str," G:$T(")_" G "_met Q
 .S str=$P(str," G:$T(")_$S(FLAG:"",1:" Q")
 Q
 
STR(%1,%2) ;Трансформация условия на строку
 S %0="" N Tmp
 S met=$G(@mas2@(bok,%1,"2,4")),Str=$G(^("2,2")),LABEL(Str)=""
 S Tmp=$G(@mas2@(bok,%1,"2,3"))
 S %0=Str_" "_$S(Tmp'="":" I "_$$TR^%ZAPM.bs.BSsFUNM(Tmp,"CurIndx",((i1-1)*C)),1:"")_" S BUF("_((i1-1)*C)_"+C,Z)=$G(BUF("_((i1-1)*C)_"+C,Z))+$S($D(D(Z,"_Str_")):D(Z,"_Str_"),1:D(Z)) "
 S %0=%0_$S(met="Q":met,1:" G:$T("_met_")'="""" "_met_$S($G(%2)="":" Q",1:""))
 I %0["^(" S %0=$$AddGet^%ZAPM.bs.BSzmOL(%0,"^(","$G(@masR@(")
 Q %0
]]></Routine>
</Export>
